{"config":{"lang":["en","ja"],"separator":"[\\s\\-\\.]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"\u76ee\u5f55","text":"<ul> <li>\u5168\u4e66\u7ec4\u7ec7</li> </ul>"},{"location":"#part-i-prometheus","title":"Part I - Prometheus\u57fa\u7840","text":"<ul> <li>\u7b2c1\u7ae0 \u5929\u964d\u5947\u5175</li> <li>Prometheus\u7b80\u4ecb</li> <li>\u521d\u8bc6Prometheus<ul> <li>\u5b89\u88c5Prometheus Server</li> <li>\u4f7f\u7528Node Exporter\u91c7\u96c6\u4e3b\u673a\u6570\u636e</li> <li>\u4f7f\u7528PromQL\u67e5\u8be2\u76d1\u63a7\u6570\u636e</li> <li>\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316</li> </ul> </li> <li>\u4efb\u52a1\u548c\u5b9e\u4f8b</li> <li>Prometheus\u6838\u5fc3\u7ec4\u4ef6</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c2\u7ae0 \u63a2\u7d22PromQL</li> <li>\u7406\u89e3\u65f6\u95f4\u5e8f\u5217</li> <li>Metrics\u7c7b\u578b</li> <li>\u521d\u8bc6PromQL</li> <li>PromQL\u64cd\u4f5c\u7b26</li> <li>PromQL\u805a\u5408\u64cd\u4f5c</li> <li>PromQL\u5185\u7f6e\u51fd\u6570</li> <li>\u5728HTTP API\u4e2d\u4f7f\u7528PromQL</li> <li>\u6700\u4f73\u5b9e\u8df5\uff1a4\u4e2a\u9ec4\u91d1\u6307\u6807\u548cUSE\u65b9\u6cd5</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c3\u7ae0 Prometheus\u544a\u8b66\u5904\u7406</li> <li>Prometheus\u544a\u8b66\u7b80\u4ecb</li> <li>\u81ea\u5b9a\u4e49Prometheus\u544a\u8b66\u89c4\u5219</li> <li>\u90e8\u7f72AlertManager</li> <li>Alertmanager\u914d\u7f6e\u6982\u8ff0</li> <li>\u57fa\u4e8e\u6807\u7b7e\u7684\u544a\u8b66\u5904\u7406\u8def\u7531</li> <li>\u4f7f\u7528Receiver\u63a5\u6536\u544a\u8b66\u4fe1\u606f<ul> <li>\u96c6\u6210\u90ae\u4ef6\u7cfb\u7edf</li> <li>\u96c6\u6210Slack</li> <li>\u96c6\u6210\u4f01\u4e1a\u5fae\u4fe1</li> <li>\u96c6\u6210\u9489\u9489\uff1a\u57fa\u4e8eWebhook\u7684\u6269\u5c55</li> </ul> </li> <li>\u544a\u8b66\u6a21\u677f\u8be6\u89e3</li> <li>\u5c4f\u853d\u544a\u8b66\u901a\u77e5</li> <li>\u4f7f\u7528Recoding Rules\u4f18\u5316\u6027\u80fd</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"#part-ii-prometheus","title":"Part II - Prometheus\u8fdb\u9636","text":"<ul> <li>\u7b2c4\u7ae0 Exporter\u8be6\u89e3</li> <li>Exporter\u662f\u4ec0\u4e48</li> <li>\u5e38\u7528Exporter<ul> <li>\u5bb9\u5668\u76d1\u63a7\uff1acAdvisor</li> <li>\u76d1\u63a7MySQL\u8fd0\u884c\u72b6\u6001\uff1aMySQLD Exporter</li> <li>\u7f51\u7edc\u63a2\u6d4b\uff1aBlackbox Exporter</li> </ul> </li> <li>\u4f7f\u7528Java\u81ea\u5b9a\u4e49Exporter<ul> <li>\u4f7f\u7528Client Java\u6784\u5efaExporter\u7a0b\u5e8f</li> <li>\u5728\u5e94\u7528\u4e2d\u5185\u7f6ePrometheus\u652f\u6301</li> </ul> </li> <li>\u5c0f\u7ed3</li> <li>\u7b2c5\u7ae0 \u6570\u636e\u4e0e\u53ef\u89c6\u5316</li> <li>\u4f7f\u7528Console Template</li> <li>Grafana\u7684\u57fa\u672c\u6982\u5ff5</li> <li>Grafana\u4e0e\u6570\u636e\u53ef\u89c6\u5316<ul> <li>\u53d8\u5316\u8d8b\u52bf\uff1aGraph\u9762\u677f</li> <li>\u5206\u5e03\u7edf\u8ba1\uff1aHeatmap\u9762\u677f</li> <li>\u5f53\u524d\u72b6\u6001\uff1aSingleStat\u9762\u677f</li> </ul> </li> <li>\u6a21\u677f\u5316Dashboard</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c6\u7ae0 \u96c6\u7fa4\u4e0e\u9ad8\u53ef\u7528</li> <li>\u672c\u5730\u5b58\u50a8</li> <li>\u8fdc\u7a0b\u5b58\u50a8</li> <li>\u8054\u90a6\u96c6\u7fa4</li> <li>Prometheus\u9ad8\u53ef\u7528</li> <li>Alertmanager\u9ad8\u53ef\u7528</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c7\u7ae0 Prometheus\u670d\u52a1\u53d1\u73b0</li> <li>Prometheus\u4e0e\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8eConsul\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u670d\u52a1\u53d1\u73b0\u4e0eRelabel</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"#part-iii-prometheus","title":"Part III - Prometheus\u5b9e\u6218","text":"<ul> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes</li> <li>\u521d\u8bc6Kubernetes</li> <li>\u90e8\u7f72Prometheus</li> <li>Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u76d1\u63a7Kubernetes\u96c6\u7fa4</li> <li>\u57fa\u4e8ePrometheus\u7684\u5f39\u6027\u4f38\u7f29</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c9\u7ae0 Prometheus Operator</li> <li>\u4ec0\u4e48\u662fPrometheus Operator</li> <li>\u4f7f\u7528Operator\u7ba1\u7406Prometheus</li> <li>\u4f7f\u7528Operator\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e</li> <li>\u5728Prometheus Operator\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e</li> <li>\u5c0f\u7ed3</li> <li>\u53c2\u8003\u8d44\u6599</li> </ul>"},{"location":"AUTHOR/","title":"\u4f5c\u8005\u4ecb\u7ecd","text":"<p>\u90d1\u4e91\u9f99\uff0c\u5168\u6808\u5de5\u7a0b\u5e08\uff0cCNCF\u57fa\u91d1\u4f1aCertified Kubernetes Administrator\u3002\u5728\u654f\u6377\u548cDevOps\u9886\u57df\u6709\u4e30\u5bcc\u7684\u5b9e\u8df5\u7ecf\u9a8c\uff0c\u66fe\u4f5c\u4e3a\u654f\u6377\u548cDevOps\u6280\u672f\u6559\u7ec3\u5411\u591a\u5bb6\u5927\u578b\u4f01\u4e1a\u63d0\u4f9b\u54a8\u8be2\u548c\u57f9\u8bad\u3002\u5f53\u524d\u5728\u4e00\u5bb6\u5bb9\u5668\u521b\u4e1a\u516c\u53f8\u8d1f\u8d23CaaS\u4ea7\u54c1\u7814\u53d1\u548c\u8bbe\u8ba1\u3002</p>"},{"location":"AUTHOR/#prometheus","title":"Prometheus\u64cd\u4f5c\u6307\u5357\uff1a\u4e91\u539f\u751f\u76d1\u63a7\u4e4b\u9053","text":"<p>\u201cYou can't fixed what you can't see\u201d\u3002 Prometheus\u88ab\u8a89\u4e3a\u4e0b\u4e00\u4ee3\u76d1\u63a7\u7cfb\u7edf\u7684\u9996\u9009\uff0c\u662f\u7ee7Kubernetes\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2aCNCF\u57fa\u91d1\u4f1a\u9876\u7ea7\u9879\u76ee\u3002\u672c\u4e66\u662f\u4e00\u672c\u4ecb\u7ecdPrometheus\u4ee5\u53ca\u5468\u8fb9\u76f8\u5173\u6280\u672f\u7684\u5b9e\u8df5\u4e66\u7c4d\u3002\u672c\u4e66\u4e3b\u8981\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\u3002\u7b2c\u4e00\u90e8\u5206\uff0c\u4e3b\u8981\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\u4ecb\u7ecd\u4e86Prometheus\u7684\u662f\u4ec0\u4e48\uff1f\u80fd\u505a\u4ec0\u4e48\uff1f\u4ee5\u53caPrometheus\u7684\u57fa\u7840\u67b6\u6784\uff0c\u8ba9\u8bfb\u8005\u5bf9Prometheus\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\u4ee5\u53ca\u6982\u5ff5\u3002\u7b2c\u4e8c\u90e8\u5206\uff0c\u672c\u4e66\u5219\u91cd\u70b9\u653e\u5728Prometheus\u7684\u9ad8\u7ea7\u5b9e\u8df5\uff0c\u5305\u62ec\u793e\u533a\u63d0\u4f9b\u7684\u5df2\u7ecf\u5b9e\u73b0\u7684Exporter\u7684\u4f7f\u7528\u573a\u666f\u4ee5\u53ca\u65b9\u6cd5\uff0c\u4ee5\u53ca\u6559\u4f1a\u8bfb\u8005\u5982\u679c\u901a\u8fc7Prometheus\u63d0\u4f9b\u7684Client Library\u6839\u636e\u81ea\u8eab\u9700\u6c42\u521b\u5efa\u81ea\u5b9a\u4e49\u7684Exporter\u3002\u57fa\u4e8e\u5982\u4f55\u4f7f\u7528Prometheus\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u63d0\u5347\u5e73\u53f0\u7684\u52a8\u6001\u80fd\u529b\u3002\u5728\u7b2c\u4e8c\u90e8\u5206\u7684\u6700\u540e\u6211\u4eec\u4f1a\u4ecb\u7ecd\u5982\u4f55\u5bf9Prometheus\u8fd0\u7ef4\u7ba1\u7406\uff0c\u6839\u636e\u9700\u6c42\u7684\u4e0d\u540c\u5b9e\u73b0Prometheus\u7684\u6269\u5bb9\u3002\u4ee5\u53ca\u5982\u4f55\u901a\u8fc7\u4e00\u4e9b\u5176\u4ed6\u7684\u5f00\u6e90\u5de5\u5177\u5982Prometheus Operator\u5b9e\u73b0\u5bf9Prometheus\u7684\u7ba1\u7406\u3002\u6700\u540e\uff0c\u5728\u7b2c\u4e09\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u4f1a\u5728Kubernetes\u4e0b\u57fa\u4e8ePrometheus\u6784\u5efa\u6211\u4eec\u7684\u5bb9\u5668\u4e91\u76d1\u63a7\u5e73\u53f0\uff0c\u5e76\u4e14\u57fa\u4e8e\u76d1\u63a7\u6570\u636e\u5b9e\u73b0\u5e94\u7528\u7684Auto Scaling\u3002</p> <p>\u5728\u901a\u8bfb\u8fd9\u4e9b\u5185\u5bb9\u540e\uff0c\u76f8\u4fe1\u8bfb\u8005\u80fd\u591f\u5bf9Prometheus\u6709\u4e00\u4e2a\u5168\u9762\u7684\u8ba4\u8bc6\u3002</p>"},{"location":"CHANGELOGS/","title":"CHANGELOGS","text":""},{"location":"CHANGELOGS/#_1","title":"\u7248\u672c\u66f4\u65b0\u5386\u53f2","text":"<p>4\u6708\u53d8\u66f4\u5185\u5bb9\uff1a</p> <ul> <li>\u4fee\u6539Feedback\u53cd\u9988\u7684\u5185\u5bb9</li> <li>\u5728\u201c\u521d\u59cbPrometheus\u5c0f\u8282\u201d\u4e2d\u6dfb\u52a0Grafana\u53ef\u89c6\u5316\u5185\u5bb9\uff1b</li> <li>\u91cd\u6784\u7b2c1\u7ae0\uff0cPrometheus\u7b80\u4ecb\u5c0f\u8282</li> <li>\u91cd\u6784\u7b2c2\u7ae0\uff0c\u7406\u89e3\u65f6\u95f4\u5e8f\u5217\u5c0f\u8282</li> <li>\u91cd\u6784\u7b2c2\u7ae0\uff0cMetrics\u7c7b\u578b\u5c0f\u8282</li> <li>\u91cd\u6784\u7b2c2\u7ae0\uff0cPromQL\u5185\u7f6e\u51fd\u6570</li> <li>\u7b2c4\u7ae0\uff0c\u6dfb\u52a0\u4f7f\u7528Blackbox\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7</li> <li>\u7b2c7\u7ae0\uff0cPrometheus\u4e0e\u670d\u52a1\u53d1\u73b0</li> <li>\u7b2c7\u7ae0\uff0c\u670d\u52a1\u53d1\u73b0\u4e0eRelabel</li> <li>\u7b2c7\u7ae0 \u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u7b2c7\u7ae0 \u57fa\u4e8eConsul\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u7b2c8\u7ae0\uff0c\u521d\u8bc6Kubernetes</li> <li>\u7b2c8\u7ae0\uff0c\u90e8\u7f72Prometheus</li> <li>\u7b2c8\u7ae0 Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes\u4e2d\u7684\u5bb9\u5668</li> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9</li> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes\u96c6\u7fa4\u72b6\u6001</li> </ul>"},{"location":"CHECKLIST/","title":"\u68c0\u67e5\u6e05\u5355","text":"<ul> <li>\u6807\u70b9\u7b26\u53f7\u662f\u5426\u4f7f\u7528\u6b63\u786e\uff1a\u9017\u53f7\u3001\u987f\u53f7\u3001\u53e5\u53f7\u3002</li> <li>\u8bed\u8a00\u8868\u8fbe\u662f\u5426\u592a\u8fc7\u53e3\u8bed\u5316\u3002</li> <li>\u79d1\u6280\u7c7b\u56fe\u793a\uff0c\u51e1\u4e8b\u7ae0\u8282\u53f7\u5e94\u8be5\u4f7f\u7528\u963f\u62c9\u4f2f\u6570\u5b57\u3002</li> <li>\u662f\u5426\u6709\u660e\u663e\u7684\u9519\u522b\u5b57\u3002</li> <li>\u662f\u5426\u533a\u5206\u4e86\"\u5730\"\u548c\"\u7684\"\u3002</li> <li>\u672f\u8bed\u5728\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u65f6\u5019\uff0c\u5982\u679c\u6807\u6ce8\u4e86\u82f1\u6587\uff0c\u540e\u9762\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e2d\u6587\uff0c\u6216\u8005\u76f4\u63a5\u4f7f\u7528\u82f1\u6587\u3002</li> <li>\u672f\u8bed\u7684\u5199\u6cd5\u8981\u89c4\u8303\uff0cMySQL, CPU\u3002</li> <li>\u6587\u4e2d\u7684\u56fe\uff0c\u5e94\u8be5\u6709\u56fe\u53f7\uff0c\u56fe\u9898\uff0c\u5e76\u4e14\u5728\u6587\u4e2d\u5e94\u8be5\u5bf9\u56fe\u8fdb\u884c\u4e00\u70b9\u8bf4\u660e\u3002</li> <li> <p>\u6587\u4e2d\u7684\u56fe\u4f8b\uff0c\u9700\u8981\u8003\u8651\u5370\u5237\u6548\u679c\u3002</p> </li> <li> <p>\u5173\u4e8e\u672f\u8bed\u7684\u8868\u8ff0\u4e00\u5b9a\u8981\u7edf\u4e00\uff0c\u4e0d\u80fd\u4e00\u4f1a\u513f\u4f7f\u7528\u4e2d\u6587\uff0c\u4e00\u4f1a\u513f\u53c8\u4f7f\u7528\u82f1\u6587\u3002\u5982\u679c\u5bf9\u4e8e\u6807\u7b7e\u8fd9\u4e2a\u8bcd\uff0c\u8981\u4f7f\u7528\u82f1\u6587\u7684\u8bdd\uff0c\u9664\u4e86\u5728\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u65f6\u5019\u7ed9\u51fa\u5bf9\u5e94\u7684\u4e2d\u6587\uff0c\u540e\u9762\u5c31\u5e94\u8be5\u4e00\u76f4\u4f7f\u7528label\u8fd9\u4e2a\u8bcd\uff08\u800c\u4e14\u9996\u5b57\u6bcd\u7684\u5927\u5c0f\u5199\u8981\u4e00\u81f4\uff09</p> </li> </ul> <p>\u5e38\u89c1\u62fc\u5199\u9519\u8bef\uff1a</p> \u6e90 \u9519\u8bef \u53cd\u6620 \u53cd\u5e94 \u79f0\u4e3a \u6210\u4e3a"},{"location":"Introduction/","title":"\u5168\u4e66\u7ec4\u7ec7","text":"<p>\u8fd9\u91cc\u5047\u5b9a\u4f60\u5df2\u7ecf\u5bf9Linux\u7cfb\u7edf\u4ee5\u53caDocker\u6280\u672f\u6709\u4e00\u5b9a\u7684\u57fa\u672c\u8ba4\u8bc6\uff0c\u4e5f\u53ef\u80fd\u4f7f\u7528\u8fc7\u50cfJava\uff0cGolang\u8fd9\u6837\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u5728\u672c\u4e66\u4e2d\u6211\u4eec\u4e0d\u4f1a\u4e8b\u65e0\u5de8\u7ec6\u7684\u8bb2\u8ff0\u6240\u6709\u4e8b\u3002</p> <p>\u7b2c1\u7ae0\uff0c\u662fPrometheus\u57fa\u7840\u7684\u7efc\u8ff0\uff0c\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u6848\u4f8b\uff08\u4f7f\u7528Prometheus\u91c7\u96c6\u4e3b\u673a\u7684\u76d1\u63a7\u6570\u636e\uff09\u6765\u4e86\u89e3Prometheus\u662f\u4ec0\u4e48\uff0c\u80fd\u505a\u4ec0\u4e48\uff0c\u4ee5\u53ca\u5b83\u7684\u67b6\u6784\u7ec4\u6210\u3002\u901a\u8fc7\u9605\u8bfb\u672c\u7ae0\u5e0c\u671b\u8bfb\u8005\u80fd\u5bf9Prometheus\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u7406\u89e3\u548c\u8ba4\u8bc6\u3002</p> <p>\u7b2c2\u7ae0\uff0c\u8bfb\u8005\u5c06\u4f1a\u4e86\u89e3\u5230Prometheus\u7684\u6570\u636e\u6a21\u578b\uff0c\u4ee5\u53ca\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\u3002\u540c\u65f6\u4f1a\u5b66\u4e60\u5230\u5982\u4f55\u5229\u7528Prometheus\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00PrmQL(Prometheus Query Language)\u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u67e5\u8be2\u3001\u805a\u5408\u3001\u8ba1\u7b97\u7b49\u3002</p> <p>\u7b2c3\u7ae0\uff0c\u6211\u4eec\u7684\u91cd\u70b9\u5c06\u653e\u5728\u76d1\u63a7\u544a\u8b66\u90e8\u5206\uff0c\u4f5c\u4e3a\u76d1\u63a7\u7cfb\u7edf\u7684\u91cd\u8981\u80fd\u529b\u4e4b\u4e00\uff0c\u6211\u4eec\u5e0c\u671b\u80fd\u591f\u53ca\u65f6\u7684\u4e86\u89e3\u7cfb\u7edf\u7684\u53d8\u5316\u3002\u8fd9\u4e00\u7ae0\u4e2d\u8bfb\u8005\u5c06\u5b66\u4e60\u5982\u4f55\u5728Prometheus\u4e2d\u81ea\u5b9a\u4e49\u544a\u8b66\u89c4\u5219\uff0c\u540c\u65f6\u4e86\u89e3\u5982\u4f55\u4f7f\u7528AlertManager\u5bf9\u544a\u8b66\u8fdb\u884c\u5904\u7406\u3002</p> <p>\u7b2c4\u7ae0\uff0c\u4ecb\u7ecdPrometheus\u4e2d\u4e00\u4e9b\u5e38\u7528\u7684Exporter\u7684\u4f7f\u7528\u573a\u666f\u4ee5\u53ca\u4f7f\u7528\u65b9\u6cd5\u3002\u4e4b\u540e\u8fd8\u4f1a\u5e26\u9886\u8bfb\u8005\u901a\u8fc7Java\u548cGolang\u5b9e\u73b0\u81ea\u5b9a\u4e49\u7684Exporter\uff0c\u540c\u65f6\u4e86\u89e3\u5982\u4f55\u5728\u73b0\u6709\u5e94\u7528\u7cfb\u7edf\u4e0a\u6dfb\u52a0\u5bf9Prometheus\u652f\u6301\uff0c\u4ece\u800c\u5b9e\u73b0\u5e94\u7528\u5c42\u9762\u7684\u76d1\u63a7\u5bf9\u63a5\u3002</p> <p>\u4ece\u7b2c1\u7ae0\u5230\u7b2c4\u7ae0\u7684\u90e8\u5206\u90fd\u662f\u672c\u4e66\u7684\u57fa\u7840\u6027\u7ae0\u8282\uff0c\u5bf9\u5927\u90e8\u5206\u7684\u7814\u53d1\u6216\u8005\u8fd0\u7ef4\u4eba\u5458\u6765\u8bf4\u53ef\u4ee5\u5feb\u901f\u638c\u63e1\uff0c\u5e76\u4e14\u80fd\u591f\u4f7f\u7528Prometheus\u6765\u5b8c\u6210\u4e00\u4e9b\u57fa\u672c\u7684\u65e5\u5e38\u4efb\u52a1\u3002\u4f59\u4e0b\u7684\u7ae0\u8282\u6211\u4eec\u4f1a\u5173\u6ce8\u5230Prometheus\u7684\u9ad8\u7ea7\b\u7528\u6cd5\u90e8\u5206\u3002</p> <p>\u7b2c5\u7ae0\uff0c\"You can't fix what you can't see\"\u3002\u53ef\u89c6\u5316\u662f\u76d1\u63a7\u7684\u6838\u5fc3\u76ee\u6807\u4e4b\u4e00\uff0c\u8fd9\u90e8\u5206\u5c06\u4f1a\u57fa\u4e8eGrafana\u8fd9\u4e00\u53ef\u89c6\u5316\u5de5\u5177\u5b9e\u73b0\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316\uff0c\u5e76\u4e14\u4e86\u89e3Grafana\u4f5c\u4e3a\u4e00\u4e2a\u901a\u7528\u7684\u53ef\u89c6\u5316\u5de5\u5177\u662f\u5982\u4f55\u4e0ePrometheus\u8fdb\u884c\u914d\u5408\u7684\u3002</p> <p>\u7b2c6\u7ae0\uff0c\u8bfb\u8005\u5c06\u4f1a\u4e86\u89e3\u5230\u5982\u4f55\u901a\u8fc7Prometheus\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u81ea\u52a8\u7684\u53d1\u73b0\u90a3\u4e9b\u9700\u8981\u76d1\u63a7\u7684\u8d44\u6e90\u548c\u670d\u52a1\u3002\u7279\u522b\u662f\u5728\u4e91\u5e73\u53f0\u6216\u8005\u5bb9\u5668\u5e73\u53f0\u4e2d\uff0c\u8d44\u6e90\u7684\u521b\u5efa\u548c\u9500\u6bc1\u6210\u672c\u53d8\u5f97\u66f4\u52a0\u9891\u7e41\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u81ea\u52a8\u5730\u53bb\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\uff0c\u80fd\u591f\u5145\u5206\u7b80\u5316Prometheus\u7684\u8fd0\u7ef4\u548c\u7ba1\u7406\u96be\u5ea6\u3002</p> <p>\u7b2c7\u7ae0\uff0c\u5728\u5355\u4e2a\u8282\u70b9\u7684\u60c5\u51b5\u4e0bPrometheus\u80fd\u591f\u8f7b\u677e\u5b8c\u6210\u5bf9\u6570\u4ee5\u767e\u4e07\u7684\u76d1\u63a7\u6307\u6807\u7684\u5904\u7406\uff0c\u4f46\u662f\u5f53\u76d1\u63a7\u7684\u76ee\u6807\u8d44\u6e90\u4ee5\u53ca\u6570\u636e\u91cf\u53d8\u5f97\u66f4\u5927\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5982\u4f55\u5b9e\u73b0\u5bf9Prometheus\u7684\u6269\u5c55\uff1f\u8fd9\u4e00\u7ae0\u8282\u4e2d\u91cd\u70b9\u8ba8\u8bbaPrometheus\u9ad8\u53ef\u7528\u65b9\u9762\u7684\u80fd\u529b\u3002</p> <p>\u7b2c8\u7ae0\uff0c\u8fd9\u4e00\u7ae0\u8282\u4e2d\u6211\u4eec\u7684\u53e6\u5916\u4e00\u4f4d\u91cd\u8981\u6210\u5458Kubernetes\u5c06\u4f1a\u767b\u573a\uff0c\u8fd9\u91cc\u6211\u4eec\u4f1a\u5e26\u9886\u8bfb\u8005\u5bf9Kubernetes\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\uff0c\u5e76\u4e14\u901a\u8fc7Prometheus\u6784\u5efa\u6211\u4eec\u7684\u5bb9\u5668\u4e91\u76d1\u63a7\u7cfb\u7edf\u3002\u5e76\u4e14\u4ecb\u7ecd\u5982\u4f55\u901a\u8fc7Prometheus\u4e0eKubernetes\u7ed3\u5408\u5b9e\u73b0\u5e94\u7528\u7a0b\u5e8f\u7684\u5f39\u6027\u4f38\u7f29\u3002</p>"},{"location":"PLACE_HOLDER/","title":"PLACE HOLDER","text":"<p>\u5185\u5bb9\u6b63\u5728\u5efa\u8bbe\u4e2d</p>"},{"location":"REFERENCES/","title":"REFERENCES","text":""},{"location":"REFERENCES/#_1","title":"\u53c2\u8003\u8d44\u6599","text":""},{"location":"REFERENCES/#install-configuration","title":"Install &amp; Configuration","text":"<ul> <li>https://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04</li> </ul>"},{"location":"REFERENCES/#storage","title":"Storage","text":"<ul> <li>https://coreos.com/blog/prometheus-2.0-storage-layer-optimization</li> </ul>"},{"location":"REFERENCES/#kubernetes","title":"Kubernetes","text":"<ul> <li>https://docs.bitnami.com/kubernetes/how-to/configure-autoscaling-custom-metrics/</li> <li>https://github.com/kubernetes/kube-state-metrics</li> </ul>"},{"location":"REFERENCES/#others","title":"Others","text":"<ul> <li>https://news.ycombinator.com/item?id=12455045</li> <li>https://github.com/digitalocean/vulcan</li> <li>https://github.com/coreos/prometheus-operator/blob/master/Documentation/high-availability.md</li> <li>https://github.com/katosys/kato/issues/43</li> <li>https://www.robustperception.io/tag/tuning/</li> <li>https://www.robustperception.io/how-much-ram-does-my-prometheus-need-for-ingestion/</li> <li>https://jaxenter.com/prometheus-product-devops-mindset-130860.html</li> <li>https://www.slideshare.net/brianbrazil/so-you-want-to-write-an-exporter</li> </ul>"},{"location":"REFERENCES/#promsql","title":"PromSQL","text":"<ul> <li>https://www.youtube.com/watch?v=lrfTpnzq3Kw</li> </ul>"},{"location":"REFERENCES/#exporters","title":"Exporters:","text":"<ul> <li>https://blog.csdn.net/zhaowenbo168/article/details/53196063</li> </ul>"},{"location":"SUMMARY/","title":"\u76ee\u5f55","text":"<ul> <li>\u5168\u4e66\u7ec4\u7ec7</li> </ul>"},{"location":"SUMMARY/#part-i-prometheus","title":"Part I - Prometheus\u57fa\u7840","text":"<ul> <li>\u7b2c1\u7ae0 \u5929\u964d\u5947\u5175</li> <li>Prometheus\u7b80\u4ecb</li> <li>\u521d\u8bc6Prometheus<ul> <li>\u5b89\u88c5Prometheus Server</li> <li>\u4f7f\u7528Node Exporter\u91c7\u96c6\u4e3b\u673a\u6570\u636e</li> <li>\u4f7f\u7528PromQL\u67e5\u8be2\u76d1\u63a7\u6570\u636e</li> <li>\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316</li> </ul> </li> <li>\u4efb\u52a1\u548c\u5b9e\u4f8b</li> <li>Prometheus\u6838\u5fc3\u7ec4\u4ef6</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c2\u7ae0 \u63a2\u7d22PromQL</li> <li>\u7406\u89e3\u65f6\u95f4\u5e8f\u5217</li> <li>Metrics\u7c7b\u578b</li> <li>\u521d\u8bc6PromQL</li> <li>PromQL\u64cd\u4f5c\u7b26</li> <li>PromQL\u805a\u5408\u64cd\u4f5c</li> <li>PromQL\u5185\u7f6e\u51fd\u6570</li> <li>\u5728HTTP API\u4e2d\u4f7f\u7528PromQL</li> <li>\u6700\u4f73\u5b9e\u8df5\uff1a4\u4e2a\u9ec4\u91d1\u6307\u6807\u548cUSE\u65b9\u6cd5</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c3\u7ae0 Prometheus\u544a\u8b66\u5904\u7406</li> <li>Prometheus\u544a\u8b66\u7b80\u4ecb</li> <li>\u81ea\u5b9a\u4e49Prometheus\u544a\u8b66\u89c4\u5219</li> <li>\u90e8\u7f72AlertManager</li> <li>Alertmanager\u914d\u7f6e\u6982\u8ff0</li> <li>\u57fa\u4e8e\u6807\u7b7e\u7684\u544a\u8b66\u5904\u7406\u8def\u7531</li> <li>\u4f7f\u7528Receiver\u63a5\u6536\u544a\u8b66\u4fe1\u606f<ul> <li>\u96c6\u6210\u90ae\u4ef6\u7cfb\u7edf</li> <li>\u96c6\u6210Slack</li> <li>\u96c6\u6210\u4f01\u4e1a\u5fae\u4fe1</li> <li>\u96c6\u6210\u9489\u9489\uff1a\u57fa\u4e8eWebhook\u7684\u6269\u5c55</li> </ul> </li> <li>\u544a\u8b66\u6a21\u677f\u8be6\u89e3</li> <li>\u5c4f\u853d\u544a\u8b66\u901a\u77e5</li> <li>\u4f7f\u7528Recoding Rules\u4f18\u5316\u6027\u80fd</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"SUMMARY/#part-ii-prometheus","title":"Part II - Prometheus\u8fdb\u9636","text":"<ul> <li>\u7b2c4\u7ae0 Exporter\u8be6\u89e3</li> <li>Exporter\u662f\u4ec0\u4e48</li> <li>\u5e38\u7528Exporter<ul> <li>\u5bb9\u5668\u76d1\u63a7\uff1acAdvisor</li> <li>\u76d1\u63a7MySQL\u8fd0\u884c\u72b6\u6001\uff1aMySQLD Exporter</li> <li>\u7f51\u7edc\u63a2\u6d4b\uff1aBlackbox Exporter</li> </ul> </li> <li>\u4f7f\u7528Java\u81ea\u5b9a\u4e49Exporter<ul> <li>\u4f7f\u7528Client Java\u6784\u5efaExporter\u7a0b\u5e8f</li> <li>\u5728\u5e94\u7528\u4e2d\u5185\u7f6ePrometheus\u652f\u6301</li> </ul> </li> <li>\u5c0f\u7ed3</li> <li>\u7b2c5\u7ae0 \u6570\u636e\u4e0e\u53ef\u89c6\u5316</li> <li>\u4f7f\u7528Console Template</li> <li>Grafana\u7684\u57fa\u672c\u6982\u5ff5</li> <li>Grafana\u4e0e\u6570\u636e\u53ef\u89c6\u5316<ul> <li>\u53d8\u5316\u8d8b\u52bf\uff1aGraph\u9762\u677f</li> <li>\u5206\u5e03\u7edf\u8ba1\uff1aHeatmap\u9762\u677f</li> <li>\u5f53\u524d\u72b6\u6001\uff1aSingleStat\u9762\u677f</li> </ul> </li> <li>\u6a21\u677f\u5316Dashboard</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c6\u7ae0 \u96c6\u7fa4\u4e0e\u9ad8\u53ef\u7528</li> <li>\u672c\u5730\u5b58\u50a8</li> <li>\u8fdc\u7a0b\u5b58\u50a8</li> <li>\u8054\u90a6\u96c6\u7fa4</li> <li>Prometheus\u9ad8\u53ef\u7528</li> <li>Alertmanager\u9ad8\u53ef\u7528</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c7\u7ae0 Prometheus\u670d\u52a1\u53d1\u73b0</li> <li>Prometheus\u4e0e\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8eConsul\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u670d\u52a1\u53d1\u73b0\u4e0eRelabel</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"SUMMARY/#part-iii-prometheus","title":"Part III - Prometheus\u5b9e\u6218","text":"<ul> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes</li> <li>\u521d\u8bc6Kubernetes</li> <li>\u90e8\u7f72Prometheus</li> <li>Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u76d1\u63a7Kubernetes\u96c6\u7fa4</li> <li>\u57fa\u4e8ePrometheus\u7684\u5f39\u6027\u4f38\u7f29</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c9\u7ae0 Prometheus Operator</li> <li>\u4ec0\u4e48\u662fPrometheus Operator</li> <li>\u4f7f\u7528Operator\u7ba1\u7406Prometheus</li> <li>\u4f7f\u7528Operator\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e</li> <li>\u5728Prometheus Operator\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e</li> <li>\u5c0f\u7ed3</li> <li>\u53c2\u8003\u8d44\u6599</li> </ul>"},{"location":"TODO/","title":"TODO","text":"<p>Relabeling: * metric_relabel_configs: Metric relabeling is applied to samples as the last step before ingestion * alert_relabel_configs:Alert relabeling is applied to alerts before they are sent to the Alertmanager</p>"},{"location":"about/","title":"Metus est at sanguine iustis gratia mutatus","text":""},{"location":"about/#parvam-properatus-siccis","title":"Parvam properatus siccis","text":"<p>Lorem markdownum tutela expulit et inveni dextrum sanguis quem linquit pactique accipiunt tinus. Misit das: pulchra sit. Angue moventem versus conscia gaudet corda solvit teste commune, colit. Ulla ut addit; longa primasque ora nubila pendentem umbra, nec dumque penna sua.</p>"},{"location":"about/#aquae-faverat-ambitiosa-acastus-nurus-nomen-titan","title":"Aquae faverat ambitiosa Acastus nurus nomen Titan","text":"<p>Petisses ingrati avari penitus: sortita, leti signis: segetes procubuit bina scelus mihi quidque protinus et vertar flammis. Auras nam nam nocturnos corpore, deos mearum laniavit, incautum capillis quisquis. In mirabile duritia: cum et vultus a se sine erat longior, iterum, fecit praenuntia vocanti pater.</p> <ol> <li>Clytien mora pro</li> <li>Oculos dolore</li> <li>Erat facit decipere</li> <li>Bis caput dum resecuta puellam hostem blanditiis</li> </ol>"},{"location":"about/#nisi-boum-dictas-spirandi-mente-linquit-colorem","title":"Nisi boum dictas spirandi mente linquit colorem","text":"<p>Adspergine carinis imitamine tellus tamen destruitis inmensum, membra desint ille ibis idem, salutent a. Phocis sit Atrides sanguine hirtus alimentaque capit concutiensque quoque adunco timent? Pax mihi sonum funibus Glaucus rubefacta retia, dictis nec ramis nate quid certe stamina rapidisque manu. Cadme postes, evitabile morsusque erat querenda iudex; est.</p>"},{"location":"about/#deam-inde","title":"Deam inde","text":"<p>Sanguine possit Stygio amorem, deum, volucris Ocyroen, boum et retinacula Pico Iovis corpus, tectus. Pallorque aequor. Achivae Boebes corpora; vomentes forte tuoque nutantem vocabitur virtute mansit ubi abdita habet.</p> <p>Parabat vultus manabant anhelitus pater doloris; et idem, est coetu tendens. Fientque Pirithoo laceranda pavida excidit laetos esset oculos ibi. Remollescit cetera!</p> <p>Lacerae caducas pulsa dum docti pulsarunt mirum! Et et taurus inexperrectus huic correptus; nomina insula quem. Flammas fretum; ministrat Polydoreo partimque, suo vera addidit crinem! Quoque motu unde cum vertice cetera.</p>"},{"location":"catalogue/","title":"\u76ee\u5f55","text":"<ul> <li>\u5168\u4e66\u7ec4\u7ec7</li> </ul>"},{"location":"catalogue/#part-i-prometheus","title":"Part I - Prometheus\u57fa\u7840","text":"<ul> <li>\u7b2c1\u7ae0 \u5929\u964d\u5947\u5175</li> <li>Prometheus\u7b80\u4ecb</li> <li>\u521d\u8bc6Prometheus<ul> <li>\u5b89\u88c5Prometheus Server</li> <li>\u4f7f\u7528Node Exporter\u91c7\u96c6\u4e3b\u673a\u6570\u636e</li> <li>\u4f7f\u7528PromQL\u67e5\u8be2\u76d1\u63a7\u6570\u636e</li> <li>\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316</li> </ul> </li> <li>\u4efb\u52a1\u548c\u5b9e\u4f8b</li> <li>Prometheus\u6838\u5fc3\u7ec4\u4ef6</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c2\u7ae0 \u63a2\u7d22PromQL</li> <li>\u7406\u89e3\u65f6\u95f4\u5e8f\u5217</li> <li>Metrics\u7c7b\u578b</li> <li>\u521d\u8bc6PromQL</li> <li>PromQL\u64cd\u4f5c\u7b26</li> <li>PromQL\u805a\u5408\u64cd\u4f5c</li> <li>PromQL\u5185\u7f6e\u51fd\u6570</li> <li>\u5728HTTP API\u4e2d\u4f7f\u7528PromQL</li> <li>\u6700\u4f73\u5b9e\u8df5\uff1a4\u4e2a\u9ec4\u91d1\u6307\u6807\u548cUSE\u65b9\u6cd5</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c3\u7ae0 Prometheus\u544a\u8b66\u5904\u7406</li> <li>Prometheus\u544a\u8b66\u7b80\u4ecb</li> <li>\u81ea\u5b9a\u4e49Prometheus\u544a\u8b66\u89c4\u5219</li> <li>\u90e8\u7f72AlertManager</li> <li>Alertmanager\u914d\u7f6e\u6982\u8ff0</li> <li>\u57fa\u4e8e\u6807\u7b7e\u7684\u544a\u8b66\u5904\u7406\u8def\u7531</li> <li>\u4f7f\u7528Receiver\u63a5\u6536\u544a\u8b66\u4fe1\u606f<ul> <li>\u96c6\u6210\u90ae\u4ef6\u7cfb\u7edf</li> <li>\u96c6\u6210Slack</li> <li>\u96c6\u6210\u4f01\u4e1a\u5fae\u4fe1</li> <li>\u96c6\u6210\u9489\u9489\uff1a\u57fa\u4e8eWebhook\u7684\u6269\u5c55</li> </ul> </li> <li>\u544a\u8b66\u6a21\u677f\u8be6\u89e3</li> <li>\u5c4f\u853d\u544a\u8b66\u901a\u77e5</li> <li>\u4f7f\u7528Recoding Rules\u4f18\u5316\u6027\u80fd</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"catalogue/#part-ii-prometheus","title":"Part II - Prometheus\u8fdb\u9636","text":"<ul> <li>\u7b2c4\u7ae0 Exporter\u8be6\u89e3</li> <li>Exporter\u662f\u4ec0\u4e48</li> <li>\u5e38\u7528Exporter<ul> <li>\u5bb9\u5668\u76d1\u63a7\uff1acAdvisor</li> <li>\u76d1\u63a7MySQL\u8fd0\u884c\u72b6\u6001\uff1aMySQLD Exporter</li> <li>\u7f51\u7edc\u63a2\u6d4b\uff1aBlackbox Exporter</li> </ul> </li> <li>\u4f7f\u7528Java\u81ea\u5b9a\u4e49Exporter<ul> <li>\u4f7f\u7528Client Java\u6784\u5efaExporter\u7a0b\u5e8f</li> <li>\u5728\u5e94\u7528\u4e2d\u5185\u7f6ePrometheus\u652f\u6301</li> </ul> </li> <li>\u5c0f\u7ed3</li> <li>\u7b2c5\u7ae0 \u6570\u636e\u4e0e\u53ef\u89c6\u5316</li> <li>\u4f7f\u7528Console Template</li> <li>Grafana\u7684\u57fa\u672c\u6982\u5ff5</li> <li>Grafana\u4e0e\u6570\u636e\u53ef\u89c6\u5316<ul> <li>\u53d8\u5316\u8d8b\u52bf\uff1aGraph\u9762\u677f</li> <li>\u5206\u5e03\u7edf\u8ba1\uff1aHeatmap\u9762\u677f</li> <li>\u5f53\u524d\u72b6\u6001\uff1aSingleStat\u9762\u677f</li> </ul> </li> <li>\u6a21\u677f\u5316Dashboard</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c6\u7ae0 \u96c6\u7fa4\u4e0e\u9ad8\u53ef\u7528</li> <li>\u672c\u5730\u5b58\u50a8</li> <li>\u8fdc\u7a0b\u5b58\u50a8</li> <li>\u8054\u90a6\u96c6\u7fa4</li> <li>Prometheus\u9ad8\u53ef\u7528</li> <li>Alertmanager\u9ad8\u53ef\u7528</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c7\u7ae0 Prometheus\u670d\u52a1\u53d1\u73b0</li> <li>Prometheus\u4e0e\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u57fa\u4e8eConsul\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u670d\u52a1\u53d1\u73b0\u4e0eRelabel</li> <li>\u5c0f\u7ed3</li> </ul>"},{"location":"catalogue/#part-iii-prometheus","title":"Part III - Prometheus\u5b9e\u6218","text":"<ul> <li>\u7b2c8\u7ae0 \u76d1\u63a7Kubernetes</li> <li>\u521d\u8bc6Kubernetes</li> <li>\u90e8\u7f72Prometheus</li> <li>Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0</li> <li>\u76d1\u63a7Kubernetes\u96c6\u7fa4</li> <li>\u57fa\u4e8ePrometheus\u7684\u5f39\u6027\u4f38\u7f29</li> <li>\u5c0f\u7ed3</li> <li>\u7b2c9\u7ae0 Prometheus Operator</li> <li>\u4ec0\u4e48\u662fPrometheus Operator</li> <li>\u4f7f\u7528Operator\u7ba1\u7406Prometheus</li> <li>\u4f7f\u7528Operator\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e</li> <li>\u5728Prometheus Operator\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e</li> <li>\u5c0f\u7ed3</li> <li>\u53c2\u8003\u8d44\u6599</li> </ul>"},{"location":"alert/","title":"\u7b2c3\u7ae0 Prometheus\u544a\u8b66\u5904\u7406","text":"<p>\u672c\u7ae0\u6211\u4eec\u5c06\u5e26\u9886\u8bfb\u8005\u63a2\u7d22Prometheus\u7684\u544a\u8b66\u5904\u7406\u673a\u5236\uff0c\u5728\u524d\u9762\u7684\u90e8\u5206\u4e2d\u5df2\u7ecf\u4ecb\u7ecd\u4e86\u544a\u8b66\u80fd\u529b\u5728Prometheus\u7684\u67b6\u6784\u4e2d\u88ab\u5212\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u5728Prometheus Server\u4e2d\u5b9a\u4e49\u544a\u8b66\u89c4\u5219\u4ee5\u53ca\u4ea7\u751f\u544a\u8b66\uff0cAlertmanager\u7ec4\u4ef6\u5219\u7528\u4e8e\u5904\u7406\u8fd9\u4e9b\u7531Prometheus\u4ea7\u751f\u7684\u544a\u8b66\u3002Alertmanager\u5373Prometheus\u4f53\u7cfb\u4e2d\u544a\u8b66\u7684\u7edf\u4e00\u5904\u7406\u4e2d\u5fc3\u3002Alertmanager\u63d0\u4f9b\u4e86\u591a\u79cd\u5185\u7f6e\u7b2c\u4e09\u65b9\u544a\u8b66\u901a\u77e5\u65b9\u5f0f\uff0c\u540c\u65f6\u8fd8\u63d0\u4f9b\u4e86\u5bf9Webhook\u901a\u77e5\u7684\u652f\u6301\uff0c\u901a\u8fc7Webhook\u7528\u6237\u53ef\u4ee5\u5b8c\u6210\u5bf9\u544a\u8b66\u66f4\u591a\u4e2a\u6027\u5316\u7684\u6269\u5c55\u3002</p> <p>\u672c\u7ae0\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u5728Prometheus\u4e2d\u81ea\u5b9a\u4e49\u544a\u8b66\u89c4\u5219</li> <li>\u7406\u89e3Alertmanager\u7279\u6027</li> <li>\u57fa\u4e8e\u6807\u7b7e\u7684\u52a8\u6001\u544a\u8b66\u5904\u7406</li> <li>\u5c06\u544a\u8b66\u901a\u77e5\u53d1\u9001\u5230\u7b2c\u4e09\u65b9\u670d\u52a1</li> <li>\u5982\u4f55\u4f7f\u7528Webhook\u6269\u5c55Alertmanager</li> <li>\u4ee5\u53ca\u4e00\u4e9b\u5176\u4ed6\u7684\u6027\u80fd\u4f18\u5316\u6a21\u5f0f</li> </ul>"},{"location":"alert/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>\u5f53\u6545\u969c\u53d1\u751f\u65f6\uff0c\u5373\u65f6\u83b7\u53d6\u5230\u5f02\u5e38\u7ed3\u679c\u662f\u5927\u591a\u6570\u7528\u6237\u4f7f\u7528\u76d1\u63a7\u7cfb\u7edf\u7684\u6700\u4e3b\u8981\u7684\u76ee\u7684\u4e4b\u4e00\u3002\u901a\u8fc7Prometheus\u63d0\u4f9b\u7684\u544a\u8b66\u4ee5\u53ca\u544a\u8b66\u5904\u7406\u80fd\u529b\uff0c\u901a\u8fc7\u5185\u7f6e\u7684\u544a\u8b66\u901a\u77e5\u80fd\u529b\uff0c\u80fd\u8fc7\u5e2e\u52a9\u7528\u6237\u5feb\u901f\u5b9e\u73b0\u544a\u8b66\u7684\u901a\u77e5\u3002\u540c\u65f6\u5176\u8fd8\u63d0\u4f9b\u4e86\u7b80\u5355\u6709\u6548\u7684\u6269\u5c55\u65b9\u5f0f\uff0c\u8ba9\u7528\u6237\u53ef\u4ee5\u57fa\u4e8ePrometheus\u7684\u544a\u8b66\u5904\u7406\u6a21\u5f0f\u5b9e\u73b0\u66f4\u591a\u7684\u5b9a\u5236\u5316\u9700\u6c42\u3002</p>"},{"location":"alert/alert-manager-config/","title":"Alertmanager\u914d\u7f6e\u6982\u8ff0","text":"<p>\u5728\u4e0a\u9762\u7684\u90e8\u5206\u4e2d\u5df2\u7ecf\u7b80\u5355\u4ecb\u7ecd\u8fc7\uff0c\u5728Alertmanager\u4e2d\u901a\u8fc7\u8def\u7531(Route)\u6765\u5b9a\u4e49\u544a\u8b66\u7684\u5904\u7406\u65b9\u5f0f\u3002\u8def\u7531\u662f\u4e00\u4e2a\u57fa\u4e8e\u6807\u7b7e\u5339\u914d\u7684\u6811\u72b6\u5339\u914d\u7ed3\u6784\u3002\u6839\u636e\u63a5\u6536\u5230\u544a\u8b66\u7684\u6807\u7b7e\u5339\u914d\u76f8\u5e94\u7684\u5904\u7406\u65b9\u5f0f\u3002\u8fd9\u91cc\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u8def\u7531\u76f8\u5173\u7684\u5185\u5bb9\u3002</p> <p>Alertmanager\u4e3b\u8981\u8d1f\u8d23\u5bf9Prometheus\u4ea7\u751f\u7684\u544a\u8b66\u8fdb\u884c\u7edf\u4e00\u5904\u7406\uff0c\u56e0\u6b64\u5728Alertmanager\u914d\u7f6e\u4e2d\u4e00\u822c\u4f1a\u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u4e3b\u8981\u90e8\u5206\uff1a</p> <ul> <li>\u5168\u5c40\u914d\u7f6e\uff08global\uff09\uff1a\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e9b\u5168\u5c40\u7684\u516c\u5171\u53c2\u6570\uff0c\u5982\u5168\u5c40\u7684SMTP\u914d\u7f6e\uff0cSlack\u914d\u7f6e\u7b49\u5185\u5bb9\uff1b</li> <li>\u6a21\u677f\uff08templates\uff09\uff1a\u7528\u4e8e\u5b9a\u4e49\u544a\u8b66\u901a\u77e5\u65f6\u7684\u6a21\u677f\uff0c\u5982HTML\u6a21\u677f\uff0c\u90ae\u4ef6\u6a21\u677f\u7b49\uff1b</li> <li>\u544a\u8b66\u8def\u7531\uff08route\uff09\uff1a\u6839\u636e\u6807\u7b7e\u5339\u914d\uff0c\u786e\u5b9a\u5f53\u524d\u544a\u8b66\u5e94\u8be5\u5982\u4f55\u5904\u7406\uff1b</li> <li>\u63a5\u6536\u4eba\uff08receivers\uff09\uff1a\u63a5\u6536\u4eba\u662f\u4e00\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\uff0c\u5b83\u53ef\u4ee5\u662f\u4e00\u4e2a\u90ae\u7bb1\u4e5f\u53ef\u4ee5\u662f\u5fae\u4fe1\uff0cSlack\u6216\u8005Webhook\u7b49\uff0c\u63a5\u6536\u4eba\u4e00\u822c\u914d\u5408\u544a\u8b66\u8def\u7531\u4f7f\u7528\uff1b</li> <li>\u6291\u5236\u89c4\u5219\uff08inhibit_rules\uff09\uff1a\u5408\u7406\u8bbe\u7f6e\u6291\u5236\u89c4\u5219\u53ef\u4ee5\u51cf\u5c11\u5783\u573e\u544a\u8b66\u7684\u4ea7\u751f</li> </ul> <p>\u5176\u5b8c\u6574\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>global:\n  [ resolve_timeout: &lt;duration&gt; | default = 5m ]\n  [ smtp_from: &lt;tmpl_string&gt; ] \n  [ smtp_smarthost: &lt;string&gt; ] \n  [ smtp_hello: &lt;string&gt; | default = \"localhost\" ]\n  [ smtp_auth_username: &lt;string&gt; ]\n  [ smtp_auth_password: &lt;secret&gt; ]\n  [ smtp_auth_identity: &lt;string&gt; ]\n  [ smtp_auth_secret: &lt;secret&gt; ]\n  [ smtp_require_tls: &lt;bool&gt; | default = true ]\n  [ slack_api_url: &lt;secret&gt; ]\n  [ victorops_api_key: &lt;secret&gt; ]\n  [ victorops_api_url: &lt;string&gt; | default = \"https://alert.victorops.com/integrations/generic/20131114/alert/\" ]\n  [ pagerduty_url: &lt;string&gt; | default = \"https://events.pagerduty.com/v2/enqueue\" ]\n  [ opsgenie_api_key: &lt;secret&gt; ]\n  [ opsgenie_api_url: &lt;string&gt; | default = \"https://api.opsgenie.com/\" ]\n  [ hipchat_api_url: &lt;string&gt; | default = \"https://api.hipchat.com/\" ]\n  [ hipchat_auth_token: &lt;secret&gt; ]\n  [ wechat_api_url: &lt;string&gt; | default = \"https://qyapi.weixin.qq.com/cgi-bin/\" ]\n  [ wechat_api_secret: &lt;secret&gt; ]\n  [ wechat_api_corp_id: &lt;string&gt; ]\n  [ http_config: &lt;http_config&gt; ]\n\ntemplates:\n  [ - &lt;filepath&gt; ... ]\n\nroute: &lt;route&gt;\n\nreceivers:\n  - &lt;receiver&gt; ...\n\ninhibit_rules:\n  [ - &lt;inhibit_rule&gt; ... ]\n</code></pre> <p>\u5728\u5168\u5c40\u914d\u7f6e\u4e2d\u9700\u8981\u6ce8\u610f\u7684\u662f<code>resolve_timeout</code>\uff0c\u8be5\u53c2\u6570\u5b9a\u4e49\u4e86\u5f53Alertmanager\u6301\u7eed\u591a\u957f\u65f6\u95f4\u672a\u63a5\u6536\u5230\u544a\u8b66\u540e\u6807\u8bb0\u544a\u8b66\u72b6\u6001\u4e3aresolved\uff08\u5df2\u89e3\u51b3\uff09\u3002\u8be5\u53c2\u6570\u7684\u5b9a\u4e49\u53ef\u80fd\u4f1a\u5f71\u54cd\u5230\u544a\u8b66\u6062\u590d\u901a\u77e5\u7684\u63a5\u6536\u65f6\u95f4\uff0c\u8bfb\u8005\u53ef\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u573a\u666f\u8fdb\u884c\u5b9a\u4e49\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a5\u5206\u949f\u3002\u5728\u63a5\u4e0b\u6765\u7684\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u5df2\u4e00\u4e9b\u5b9e\u9645\u7684\u4f8b\u5b50\u89e3\u91caAlertmanager\u7684\u5176\u5b83\u914d\u7f6e\u5185\u5bb9\u3002</p>"},{"location":"alert/alert-manager-extension-with-webhook/","title":"\u4f7f\u7528Webhook\u6269\u5c55Alertmanager","text":"<p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u9664\u4e86Alertmanager\u5df2\u7ecf\u5185\u7f6e\u7684\u96c6\u4e2d\u544a\u8b66\u901a\u77e5\u65b9\u5f0f\u4ee5\u5916\uff0c\u5bf9\u4e8e\u4e0d\u540c\u7684\u7528\u6237\u548c\u7ec4\u7ec7\u800c\u8a00\u8fd8\u9700\u8981\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u544a\u77e5\u65b9\u5f0f\u652f\u6301\u3002\u901a\u8fc7Alertmanager\u63d0\u4f9b\u7684webhook\u652f\u6301\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0\u8fd9\u4e00\u7c7b\u7684\u6269\u5c55\u3002\u9664\u4e86\u7528\u4e8e\u652f\u6301\u989d\u5916\u7684\u901a\u77e5\u65b9\u5f0f\uff0cwebhook\u8fd8\u53ef\u4ee5\u4e0e\u5176\u4ed6\u7b2c\u4e09\u65b9\u7cfb\u7edf\u96c6\u6210\u5b9e\u73b0\u8fd0\u7ef4\u81ea\u52a8\u5316\uff0c\u6216\u8005\u5f39\u6027\u4f38\u7f29\u7b49\u3002</p> <p>\u5728Alertmanager\u4e2d\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e\u5b9a\u4e49\u57fa\u4e8ewebhook\u7684\u544a\u8b66\u63a5\u6536\u5668receiver\u3002\u4e00\u4e2areceiver\u53ef\u4ee5\u5bf9\u5e94\u4e00\u7ec4webhook\u914d\u7f6e\u3002</p> <pre><code>name: &lt;string&gt;\nwebhook_configs:\n  [ - &lt;webhook_config&gt;, ... ]\n</code></pre> <p>\u6bcf\u4e00\u9879webhook_config\u7684\u5177\u4f53\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code># Whether or not to notify about resolved alerts.\n[ send_resolved: &lt;boolean&gt; | default = true ]\n\n# The endpoint to send HTTP POST requests to.\nurl: &lt;string&gt;\n\n# The HTTP client's configuration.\n[ http_config: &lt;http_config&gt; | default = global.http_config ]\n</code></pre> <p>send_resolved\u7528\u4e8e\u6307\u5b9a\u662f\u5426\u5728\u544a\u8b66\u6d88\u9664\u65f6\u53d1\u9001\u56de\u6267\u6d88\u606f\u3002url\u5219\u662f\u7528\u4e8e\u63a5\u6536webhook\u8bf7\u6c42\u7684\u5730\u5740\u3002http_configs\u5219\u662f\u5728\u9700\u8981\u5bf9\u8bf7\u6c42\u8fdb\u884cSSL\u914d\u7f6e\u65f6\u4f7f\u7528\u3002</p> <p>\u5f53\u7528\u6237\u5b9a\u4e49webhook\u7528\u4e8e\u63a5\u6536\u544a\u8b66\u4fe1\u606f\u540e\uff0c\u5f53\u544a\u8b66\u88ab\u89e6\u53d1\u65f6\uff0cAlertmanager\u4f1a\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u5411\u8fd9\u4e9burl\u5730\u5740\u53d1\u9001HTTP Post\u8bf7\u6c42\uff0c\u8bf7\u6c42\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"version\": \"4\",\n  \"groupKey\": &lt;string&gt;,    // key identifying the group of alerts (e.g. to deduplicate)\n  \"status\": \"&lt;resolved|firing&gt;\",\n  \"receiver\": &lt;string&gt;,\n  \"groupLabels\": &lt;object&gt;,\n  \"commonLabels\": &lt;object&gt;,\n  \"commonAnnotations\": &lt;object&gt;,\n  \"externalURL\": &lt;string&gt;,  // backlink to the Alertmanager.\n  \"alerts\": [\n    {\n      \"labels\": &lt;object&gt;,\n      \"annotations\": &lt;object&gt;,\n      \"startsAt\": \"&lt;rfc3339&gt;\",\n      \"endsAt\": \"&lt;rfc3339&gt;\"\n    }\n  ]\n}\n</code></pre>"},{"location":"alert/alert-manager-extension-with-webhook/#golangwebhook","title":"\u4f7f\u7528Golang\u521b\u5efawebhook\u670d\u52a1","text":"<p>\u9996\u5148\u6211\u4eec\u5c1d\u8bd5\u4f7f\u7528Golang\u521b\u5efa\u7528\u4e8e\u63a5\u6536webhook\u544a\u8b66\u901a\u77e5\u7684\u670d\u52a1\u3002\u9996\u5148\u521b\u5efamodel\u5305\uff0c\u7528\u4e8e\u6620\u5c04ALertmanager\u53d1\u9001\u7684\u544a\u8b66\u4fe1\u606f\uff0cAlertmanager\u7684\u4e00\u4e2a\u901a\u77e5\u4e2d\u6839\u636e\u914d\u7f6e\u7684group_by\u89c4\u5219\u53ef\u80fd\u4f1a\u5305\u542b\u591a\u6761\u544a\u8b66\u4fe1\u606fAlert\u3002\u521b\u5efa\u544a\u8b66\u901a\u77e5\u5bf9\u5e94\u7684\u7ed3\u6784\u4f53Notification\u3002</p> <pre><code>package model\n\nimport \"time\"\n\ntype Alert struct {\n    Labels      map[string]string `json:\"labels\"`\n    Annotations map[string]string `json:annotations`\n    StartsAt    time.Time         `json:\"startsAt\"`\n    EndsAt      time.Time         `json:\"endsAt\"`\n}\n\ntype Notification struct {\n    Version           string            `json:\"version\"`\n    GroupKey          string            `json:\"groupKey\"`\n    Status            string            `json:\"status\"`\n    Receiver          string            `json:receiver`\n    GroupLabels       map[string]string `json:groupLabels`\n    CommonLabels      map[string]string `json:commonLabels`\n    CommonAnnotations map[string]string `json:commonAnnotations`\n    ExternalURL       string            `json:externalURL`\n    Alerts            []Alert           `json:alerts`\n}\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528gin-gonic\u6846\u67b6\u521b\u5efa\u7528\u4e8e\u63a5\u6536Webhook\u901a\u77e5\u7684Web\u670d\u52a1\u3002\u5b9a\u4e49\u8def\u7531/webhook\u63a5\u6536\u6765\u81eaAlertmanager\u7684POST\u8bf7\u6c42\u3002</p> <pre><code>package main\n\nimport (\n    \"net/http\"\n\n    \"github.com/gin-gonic/gin\"\n    model \"github.com/yunlzheng/alertmanaer-dingtalk-webhook/model\"\n)\n\nfunc main() {\n    router := gin.Default()\n    router.POST(\"/webhook\", func(c *gin.Context) {\n        var notification model.Notification\n\n        err := c.BindJSON(&amp;notification)\n\n        if err != nil {\n            c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()})\n            return\n        }\n\n        c.JSON(http.StatusOK, gin.H{\"message\": \" successful receive alert notification message!\"})\n\n    })\n    router.Run()\n}\n</code></pre>"},{"location":"alert/alert-manager-extension-with-webhook/#_1","title":"\u4e0e\u9489\u9489\u96c6\u6210","text":"<p>\u9489\u9489\uff0c\u963f\u91cc\u5df4\u5df4\u51fa\u54c1\uff0c\u4e13\u4e3a\u4e2d\u56fd\u4f01\u4e1a\u6253\u9020\u7684\u514d\u8d39\u667a\u80fd\u79fb\u52a8\u529e\u516c\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u5373\u65f6\u901a\u8baf\u4ee5\u53ca\u79fb\u52a8\u529e\u516c\u7b49\u4e30\u5bcc\u7684\u529f\u80fd\u3002</p> <p>\u9489\u9489\u7fa4\u673a\u5668\u4eba\u662f\u9489\u9489\u7fa4\u7684\u9ad8\u7ea7\u6269\u5c55\u529f\u80fd\u3002\u7fa4\u673a\u5668\u4eba\u53ef\u4ee5\u5c06\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u4fe1\u606f\u805a\u5408\u5230\u7fa4\u804a\u4e2d\uff0c\u5b9e\u73b0\u81ea\u52a8\u5316\u7684\u4fe1\u606f\u540c\u6b65\u3002\u4f8b\u5982\uff1a\u901a\u8fc7\u805a\u5408GitHub\uff0cGitLab\u7b49\u6e90\u7801\u7ba1\u7406\u670d\u52a1\uff0c\u5b9e\u73b0\u6e90\u7801\u66f4\u65b0\u540c\u6b65\uff1b\u901a\u8fc7\u805a\u5408Trello\uff0cJIRA\u7b49\u9879\u76ee\u534f\u8c03\u670d\u52a1\uff0c\u5b9e\u73b0\u9879\u76ee\u4fe1\u606f\u540c\u6b65\u3002\u4e0d\u4ec5\u5982\u6b64\uff0c\u7fa4\u673a\u5668\u4eba\u652f\u6301Webhook\u534f\u8bae\u7684\u81ea\u5b9a\u4e49\u63a5\u5165\uff0c\u652f\u6301\u66f4\u591a\u53ef\u80fd\u6027\u3002\u8fd9\u91cc\u6211\u4eec\u5c06\u6f14\u793a\u5982\u679c\u5c06Alertmanager\u8fd0\u7ef4\u62a5\u8b66\u63d0\u9192\u901a\u8fc7\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\u805a\u5408\u5230\u9489\u9489\u7fa4\u3002</p> <p>\u8fd9\u91cc\u5c06\u7ee7\u7eed\u6269\u5c55webhook\u670d\u52a1\uff0c\u4ee5\u652f\u6301\u5c06Alertmanager\u7684\u544a\u8b66\u901a\u77e5\u8f6c\u53d1\u5230\u9489\u9489\u5e73\u53f0\u3002\u5b8c\u6574\u7684\u793a\u4f8b\u4ee3\u7801\u53ef\u4ee5\u4ecegithub\u4ed3\u5e93https://github.com/yunlzheng/alertmanaer-dingtalk-webhook\u4e2d\u83b7\u53d6\u3002</p>"},{"location":"alert/alert-manager-extension-with-webhook/#webhook","title":"\u81ea\u5b9a\u4e49webhook\u7fa4\u673a\u5668\u4eba","text":"<p>\u901a\u8fc7\u9489\u9489\u5ba2\u6237\u7aef\uff08\u5982\uff1a\u684c\u9762\u6216\u8005\u624b\u673a\uff09\u8fdb\u5165\u5230\u7fa4\u8bbe\u7f6e\u540e\u9009\u62e9\u201c\u7fa4\u673a\u5668\u4eba\u201d\u3002\u5c06\u663e\u793a\u5982\u4e0b\u754c\u9762\uff1a</p> <p></p> <p>\u9009\u62e9\u201c\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\u201d\uff0c\u5e76\u4e14\u6309\u7167\u63d0\u793a\u586b\u5199\u673a\u5668\u4eba\u540d\u79f0\uff0c\u83b7\u53d6\u673a\u5668\u4ebawebhook\u5730\u5740\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>webhook\u673a\u5668\u4eba\u521b\u5efa\u6210\u529f\u540e\uff0c\u7528\u6237\u5c31\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u65b9\u5f0f\u5411\u8be5\u5730\u5740\u53d1\u8d77HTTP POST\u8bf7\u6c42\uff0c\u5373\u53ef\u5b9e\u73b0\u5411\u8be5\u7fa4\u4e3b\u53d1\u9001\u6d88\u606f\u3002\u76ee\u524d\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\u652f\u6301\u6587\u672c(text)\uff0c\u8fde\u63a5(link)\uff0cmarkdown\u4e09\u79cd\u6d88\u606f\u7c7b\u578b\u3002</p> <p>\u4f8b\u5982\uff0c\u53ef\u4ee5\u5411webhook\u5730\u5740\u4ee5POST\u5f62\u5f0f\u53d1\u9001\u4ee5\u4e0b</p> <pre><code>{\n     \"msgtype\": \"markdown\",\n     \"markdown\": {\n         \"title\":\"Prometheus\u544a\u8b66\u4fe1\u606f\",\n         \"text\": \"#### \u76d1\u63a7\u6307\u6807\\n\" +\n                 \"&gt; \u76d1\u63a7\u63cf\u8ff0\u4fe1\u606f\\n\\n\" +\n                 \"&gt; ###### \u544a\u8b66\u65f6\u95f4 \\n\"\n     },\n    \"at\": {\n        \"atMobiles\": [\n            \"156xxxx8827\",\n            \"189xxxx8325\"\n        ], \n        \"isAtAll\": false\n    }\n }\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528curl\u9a8c\u8bc1\u9489\u9489webhook\u662f\u5426\u80fd\u591f\u6210\u529f\u8c03\u7528\uff1a</p> <pre><code>$ curl -l -H \"Content-type: application/json\" -X POST -d '{\"msgtype\": \"markdown\",\"markdown\": {\"title\":\"Prometheus\u544a\u8b66\u4fe1\u606f\",\"text\": \"#### \u76d1\u63a7\u6307\u6807\\n&gt; \u76d1\u63a7\u63cf\u8ff0\u4fe1\u606f\\n\\n&gt; ###### \u544a\u8b66\u65f6\u95f4 \\n\"},\"at\": {\"isAtAll\": false}}' https://oapi.dingtalk.com/robot/send?access_token=xxxx\n{\"errcode\":0,\"errmsg\":\"ok\"}\n</code></pre> <p>\u8c03\u7528\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u5728\u9489\u9489\u5e94\u7528\u7fa4\u6d88\u606f\u4e2d\u63a5\u6536\u5230\u7c7b\u4f3c\u4e8e\u5982\u4e0b\u901a\u77e5\u6d88\u606f:</p> <p></p>"},{"location":"alert/alert-manager-extension-with-webhook/#dingtalk","title":"\u5b9a\u4e49\u8f6c\u6362\u5668\u5c06\u544a\u8b66\u901a\u77e5\u8f6c\u5316\u4e3aDingtalk\u6d88\u606f\u5bf9\u8c61","text":"<p>\u8fd9\u91cc\u5b9a\u4e49\u7ed3\u6784\u4f53DingTalkMarkdown\u7528\u4e8e\u6620\u5c04Dingtalk\u7684\u6d88\u606f\u4f53\u3002</p> <pre><code>package model\n\ntype At struct {\n    AtMobiles []string `json:\"atMobiles\"`\n    IsAtAll   bool     `json:\"isAtAll\"`\n}\n\ntype DingTalkMarkdown struct {\n    MsgType  string    `json:\"msgtype\"`\n    At       *At       `json:at`\n    Markdown *Markdown `json:\"markdown\"`\n}\n\ntype Markdown struct {\n    Title string `json:\"title\"`\n    Text  string `json:\"text\"`\n}\n</code></pre> <p>\u5b9a\u4e49\u8f6c\u6362\u5668\u5c06Alertmanager\u53d1\u9001\u7684\u544a\u8b66\u901a\u77e5\u8f6c\u6362\u4e3aDingtalk\u7684\u6d88\u606f\u4f53\u3002</p> <pre><code>package transformer\n\nimport (\n    \"bytes\"\n    \"fmt\"\n\n    \"github.com/yunlzheng/alertmanaer-dingtalk-webhook/model\"\n)\n\n// TransformToMarkdown transform alertmanager notification to dingtalk markdow message\nfunc TransformToMarkdown(notification model.Notification) (markdown *model.DingTalkMarkdown, err error) {\n\n    groupKey := notification.GroupKey\n    status := notification.Status\n\n    annotations := notification.CommonAnnotations\n\n    var buffer bytes.Buffer\n\n    buffer.WriteString(fmt.Sprintf(\"### \u901a\u77e5\u7ec4%s(\u5f53\u524d\u72b6\u6001:%s) \\n\", groupKey, status))\n\n    buffer.WriteString(fmt.Sprintf(\"#### \u544a\u8b66\u9879:\\n\"))\n\n    for _, alert := range notification.Alerts {\n        annotations := alert.Annotations\n        buffer.WriteString(fmt.Sprintf(\"##### %s\\n &gt; %s\\n\", annotations[\"summary\"], annotations[\"description\"]))\n        buffer.WriteString(fmt.Sprintf(\"\\n&gt; \u5f00\u59cb\u65f6\u95f4\uff1a%s\\n\", alert.StartsAt.Format(\"15:04:05\")))\n    }\n\n    markdown = &amp;model.DingTalkMarkdown{\n        MsgType: \"markdown\",\n        Markdown: &amp;model.Markdown{\n            Title: fmt.Sprintf(\"\u901a\u77e5\u7ec4\uff1a%s(\u5f53\u524d\u72b6\u6001:%s)\", groupKey, status),\n            Text:  buffer.String(),\n        },\n        At: &amp;model.At{\n            IsAtAll: false,\n        },\n    }\n\n    return\n}\n</code></pre>"},{"location":"alert/alert-manager-extension-with-webhook/#dingtalk_1","title":"\u521b\u5efaDingtalk\u901a\u77e5\u53d1\u9001\u5305","text":"<p>notifier\u5305\u4e2d\u4f7f\u7528golang\u7684net/http\u5305\u5b9e\u73b0\u4e0eDingtalk\u7fa4\u673a\u5668\u4eba\u7684\u4ea4\u4e92\u3002Send\u65b9\u6cd5\u5305\u542b\u4e24\u4e2a\u53c2\u6570\uff1a\u63a5\u6536\u5230\u7684\u544a\u8b66\u901a\u77e5\u7ed3\u6784\u4f53\u6307\u9488\uff0c\u4ee5\u53caDingtalk\u7fa4\u673a\u5668\u4eba\u7684Webhook\u5730\u5740\u3002</p> <p>\u901a\u8fc7\u5305transformer.TransformToMarkdown\u5c06Alertmanager\u544a\u8b66\u901a\u77e5\u4e0eDingtalk\u6d88\u606f\u8fdb\u884c\u6620\u5c04\u3002</p> <pre><code>package notifier\n\nimport (\n    \"bytes\"\n    \"encoding/json\"\n    \"fmt\"\n    \"net/http\"\n\n    \"github.com/yunlzheng/alertmanaer-dingtalk-webhook/model\"\n    \"github.com/yunlzheng/alertmanaer-dingtalk-webhook/transformer\"\n)\n\nfunc Send(notification model.Notification, dingtalkRobot string) (err error) {\n\n    markdown, err := transformer.TransformToMarkdown(notification)\n\n    if err != nil {\n        return\n    }\n\n    data, err := json.Marshal(markdown)\n    if err != nil {\n        return\n    }\n\n    req, err := http.NewRequest(\n        \"POST\",\n        dingtalkRobot,\n        bytes.NewBuffer(data))\n\n    if err != nil {\n        return\n    }\n\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    client := &amp;http.Client{}\n    resp, err := client.Do(req)\n\n    if err != nil {\n        return\n    }\n\n    defer resp.Body.Close()\n    fmt.Println(\"response Status:\", resp.Status)\n    fmt.Println(\"response Headers:\", resp.Header)\n\n    return\n}\n</code></pre>"},{"location":"alert/alert-manager-extension-with-webhook/#_2","title":"\u6269\u5c55\u542f\u52a8\u51fd\u6570","text":"<p>\u9996\u5148\u4e3a\u7a0b\u5e8f\u6dfb\u52a0\u547d\u4ee4\u884c\u53c2\u6570\u652f\u6301\uff0c\u7528\u4e8e\u5728\u542f\u52a8\u65f6\u6dfb\u52a0\u5168\u5c40\u7684Dingtalk\u7fa4\u804a\u673a\u5668\u4eba\u5730\u5740\u3002</p> <pre><code>package main\n\nimport (\n  \"flag\"\n  ...\n  \"github.com/yunlzheng/alertmanaer-dingtalk-webhook/notifier\"\n)\n\nvar (\n    h            bool\n    defaultRobot string\n)\n\nfunc init() {\n    flag.BoolVar(&amp;h, \"h\", false, \"help\")\n    flag.StringVar(&amp;defaultRobot, \"defaultRobot\", \"\", \"global dingtalk robot webhook\")\n}\n\nfunc main() {\n\n    flag.Parse()\n\n    if h {\n        flag.Usage()\n        return\n    }\n\n  ...\n\n}\n</code></pre> <p>\u540c\u65f6\u901a\u8fc7notifier\u5305\u7684Send\u65b9\u6cd5\u5c06\u544a\u8b66\u901a\u77e5\u53d1\u9001\u7ed9Dingtalk\u7fa4\u804a\u673a\u5668\u4eba</p> <pre><code>func main() {\n\n  ...\n\n  err = notifier.Send(notification, defaultRobot)\n\n  if err != nil {\n    c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()})\n\n  }\n\n  c.JSON(http.StatusOK, gin.H{\"message\": \"send to dingtalk successful!\"})\n}\n</code></pre>"},{"location":"alert/alert-manager-extension-with-webhook/#dingtalk_2","title":"\u4f7f\u7528Dingtalk\u6269\u5c55","text":"<p>\u8fd0\u884c\u5e76\u542f\u52a8dingtalk webhook\u670d\u52a1\u4e4b\u540e\uff0c\u4fee\u6539Alertmanager\u914d\u7f6e\u6587\u4ef6, \u4e3adefault-receiver\u6dfb\u52a0webhook\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>receivers:\n  - name: default-receiver\n    email_configs:\n      - to: yunl.zheng@wise2c.com\n    webhook_configs:\n      - url: http://localhost:8080/webhook\n</code></pre> <p>\u91cd\u542fAlertmanager\u670d\u52a1\u540e\uff0c\u624b\u52a8\u62c9\u9ad8\u865a\u62df\u673aCPU\u4f7f\u7528\u7387\u89e6\u53d1\u544a\u8b66\u6761\u4ef6\uff0c\u6b64\u65f6Dingtalk\u5373\u53ef\u63a5\u6536\u5230\u76f8\u5e94\u7684\u544a\u8b66\u901a\u77e5\u4fe1\u606f:</p> <p></p>"},{"location":"alert/alert-manager-inhibit/","title":"\u5c4f\u853d\u544a\u8b66\u901a\u77e5","text":"<p>Alertmanager\u63d0\u4f9b\u4e86\u65b9\u5f0f\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u63a7\u5236\u544a\u8b66\u901a\u77e5\u7684\u884c\u4e3a\uff0c\u5305\u62ec\u9884\u5148\u5b9a\u4e49\u7684\u6291\u5236\u673a\u5236\u548c\u4e34\u65f6\u5b9a\u4e49\u7684\u9759\u9ed8\u89c4\u5219\u3002</p>"},{"location":"alert/alert-manager-inhibit/#_2","title":"\u6291\u5236\u673a\u5236","text":"<p>Alertmanager\u7684\u6291\u5236\u673a\u5236\u53ef\u4ee5\u907f\u514d\u5f53\u67d0\u79cd\u95ee\u9898\u544a\u8b66\u4ea7\u751f\u4e4b\u540e\u7528\u6237\u63a5\u6536\u5230\u5927\u91cf\u7531\u6b64\u95ee\u9898\u5bfc\u81f4\u7684\u4e00\u7cfb\u5217\u7684\u5176\u5b83\u544a\u8b66\u901a\u77e5\u3002\u4f8b\u5982\u5f53\u96c6\u7fa4\u4e0d\u53ef\u7528\u65f6\uff0c\u7528\u6237\u53ef\u80fd\u53ea\u5e0c\u671b\u63a5\u6536\u5230\u4e00\u6761\u544a\u8b66\uff0c\u544a\u8bc9\u4ed6\u8fd9\u65f6\u5019\u96c6\u7fa4\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u5927\u91cf\u7684\u5982\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u5f02\u5e38\u3001\u4e2d\u95f4\u4ef6\u670d\u52a1\u5f02\u5e38\u7684\u544a\u8b66\u901a\u77e5\u3002</p> <p>\u5728Alertmanager\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u4f7f\u7528inhibit_rules\u5b9a\u4e49\u4e00\u7ec4\u544a\u8b66\u7684\u6291\u5236\u89c4\u5219\uff1a</p> <pre><code>inhibit_rules:\n  [ - &lt;inhibit_rule&gt; ... ]\n</code></pre> <p>\u6bcf\u4e00\u6761\u6291\u5236\u89c4\u5219\u7684\u5177\u4f53\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>target_match:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]\ntarget_match_re:\n  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]\n\nsource_match:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]\nsource_match_re:\n  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]\n\n[ equal: '[' &lt;labelname&gt;, ... ']' ]\n</code></pre> <p>\u5f53\u5df2\u7ecf\u53d1\u9001\u7684\u544a\u8b66\u901a\u77e5\u5339\u914d\u5230target_match\u548ctarget_match_re\u89c4\u5219\uff0c\u5f53\u6709\u65b0\u7684\u544a\u8b66\u89c4\u5219\u5982\u679c\u6ee1\u8db3source_match\u6216\u8005\u5b9a\u4e49\u7684\u5339\u914d\u89c4\u5219\uff0c\u5e76\u4e14\u5df2\u53d1\u9001\u7684\u544a\u8b66\u4e0e\u65b0\u4ea7\u751f\u7684\u544a\u8b66\u4e2dequal\u5b9a\u4e49\u7684\u6807\u7b7e\u5b8c\u5168\u76f8\u540c\uff0c\u5219\u542f\u52a8\u6291\u5236\u673a\u5236\uff0c\u65b0\u7684\u544a\u8b66\u4e0d\u4f1a\u53d1\u9001\u3002</p> <p>\u4f8b\u5982\uff0c\u5b9a\u4e49\u5982\u4e0b\u6291\u5236\u89c4\u5219\uff1a</p> <pre><code>- source_match:\n    alertname: NodeDown\n    severity: critical\n  target_match:\n    severity: critical\n  equal:\n    - node\n</code></pre> <p>\u4f8b\u5982\u5f53\u96c6\u7fa4\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e3b\u673a\u8282\u70b9\u5f02\u5e38\u5b95\u673a\u5bfc\u81f4\u544a\u8b66NodeDown\u88ab\u89e6\u53d1\uff0c\u540c\u65f6\u5728\u544a\u8b66\u89c4\u5219\u4e2d\u5b9a\u4e49\u4e86\u544a\u8b66\u7ea7\u522bseverity=critical\u3002\u7531\u4e8e\u4e3b\u673a\u5f02\u5e38\u5b95\u673a\uff0c\u8be5\u4e3b\u673a\u4e0a\u90e8\u7f72\u7684\u6240\u6709\u670d\u52a1\uff0c\u4e2d\u95f4\u4ef6\u4f1a\u4e0d\u53ef\u7528\u5e76\u89e6\u53d1\u62a5\u8b66\u3002\u6839\u636e\u6291\u5236\u89c4\u5219\u7684\u5b9a\u4e49\uff0c\u5982\u679c\u6709\u65b0\u7684\u544a\u8b66\u7ea7\u522b\u4e3aseverity=critical\uff0c\u5e76\u4e14\u544a\u8b66\u4e2d\u6807\u7b7enode\u7684\u503c\u4e0eNodeDown\u544a\u8b66\u7684\u76f8\u540c\uff0c\u5219\u8bf4\u660e\u65b0\u7684\u544a\u8b66\u662f\u7531NodeDown\u5bfc\u81f4\u7684\uff0c\u5219\u542f\u52a8\u6291\u5236\u673a\u5236\u505c\u6b62\u5411\u63a5\u6536\u5668\u53d1\u9001\u901a\u77e5\u3002</p>"},{"location":"alert/alert-manager-inhibit/#_3","title":"\u4e34\u65f6\u9759\u9ed8","text":"<p>\u9664\u4e86\u57fa\u4e8e\u6291\u5236\u673a\u5236\u53ef\u4ee5\u63a7\u5236\u544a\u8b66\u901a\u77e5\u7684\u884c\u4e3a\u4ee5\u5916\uff0c\u7528\u6237\u6216\u8005\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7Alertmanager\u7684UI\u4e34\u65f6\u5c4f\u853d\u7279\u5b9a\u7684\u544a\u8b66\u901a\u77e5\u3002\u901a\u8fc7\u5b9a\u4e49\u6807\u7b7e\u7684\u5339\u914d\u89c4\u5219(\u5b57\u7b26\u4e32\u6216\u8005\u6b63\u5219\u8868\u8fbe\u5f0f)\uff0c\u5982\u679c\u65b0\u7684\u544a\u8b66\u901a\u77e5\u6ee1\u8db3\u9759\u9ed8\u89c4\u5219\u7684\u8bbe\u7f6e\uff0c\u5219\u505c\u6b62\u5411receiver\u53d1\u9001\u901a\u77e5\u3002</p> <p>\u8fdb\u5165Alertmanager UI\uff0c\u70b9\u51fb\"New Silence\"\u663e\u793a\u5982\u4e0b\u5185\u5bb9\uff1a</p> <p></p> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8be5UI\u5b9a\u4e49\u65b0\u7684\u9759\u9ed8\u89c4\u5219\u7684\u5f00\u59cb\u65f6\u95f4\u4ee5\u53ca\u6301\u7eed\u65f6\u95f4\uff0c\u901a\u8fc7Matchers\u90e8\u5206\u53ef\u4ee5\u8bbe\u7f6e\u591a\u6761\u5339\u914d\u89c4\u5219(\u5b57\u7b26\u4e32\u5339\u914d\u6216\u8005\u6b63\u5219\u5339\u914d)\u3002\u586b\u5199\u5f53\u524d\u9759\u9ed8\u89c4\u5219\u7684\u521b\u5efa\u8005\u4ee5\u53ca\u521b\u5efa\u539f\u56e0\u540e\uff0c\u70b9\u51fb\"Create\"\u6309\u94ae\u5373\u53ef\u3002</p> <p>\u901a\u8fc7\"Preview Alerts\"\u53ef\u4ee5\u67e5\u770b\u9884\u89c8\u5f53\u524d\u5339\u914d\u89c4\u5219\u5339\u914d\u5230\u7684\u544a\u8b66\u4fe1\u606f\u3002\u9759\u9ed8\u89c4\u5219\u521b\u5efa\u6210\u529f\u540e\uff0cAlertmanager\u4f1a\u5f00\u59cb\u52a0\u8f7d\u8be5\u89c4\u5219\u5e76\u4e14\u8bbe\u7f6e\u72b6\u6001\u4e3aPending,\u5f53\u89c4\u5219\u751f\u6548\u540e\u5219\u8fdb\u884c\u5230Active\u72b6\u6001\u3002</p> <p></p> <p>\u5f53\u9759\u9ed8\u89c4\u5219\u751f\u6548\u4ee5\u540e\uff0c\u4eceAlertmanager\u7684Alerts\u9875\u9762\u4e0b\u7528\u6237\u5c06\u4e0d\u4f1a\u770b\u5230\u8be5\u89c4\u5219\u5339\u914d\u5230\u7684\u544a\u8b66\u4fe1\u606f\u3002</p> <p></p> <p>\u5bf9\u4e8e\u5df2\u7ecf\u751f\u6548\u7684\u89c4\u5219\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u70b9\u51fb\u201cExpire\u201d\u6309\u94ae\u4f7f\u5f53\u524d\u89c4\u5219\u8fc7\u671f\u3002</p>"},{"location":"alert/alert-manager-mute/","title":"Alert manager mute","text":""},{"location":"alert/alert-manager-mute/#_1","title":"\u4e34\u65f6\u5c4f\u853d\u544a\u8b66\u901a\u77e5","text":"<p>\u9664\u4e86\u57fa\u4e8e\u6291\u5236\u673a\u5236\u53ef\u4ee5\u63a7\u5236\u544a\u8b66\u901a\u77e5\u7684\u884c\u4e3a\u4ee5\u5916\uff0c\u7528\u6237\u6216\u8005\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7Alertmanager\u7684UI\u4e34\u65f6\u5c4f\u853d\u7279\u5b9a\u7684\u544a\u8b66\u901a\u77e5\u3002\u901a\u8fc7\u5b9a\u4e49\u6807\u7b7e\u7684\u5339\u914d\u89c4\u5219(\u5b57\u7b26\u4e32\u6216\u8005\u6b63\u5219\u8868\u8fbe\u5f0f)\uff0c\u5982\u679c\u65b0\u7684\u544a\u8b66\u901a\u77e5\u6ee1\u8db3\u9759\u9ed8\u89c4\u5219\u7684\u8bbe\u7f6e\uff0c\u5219\u4e0d\u505c\u6b62\u5411receiver\u53d1\u9001\u901a\u77e5\u3002</p> <p>\u8fdb\u5165Alertmanager UI\uff0c\u70b9\u51fb\"New Silence\"\u663e\u793a\u5982\u4e0b\u5185\u5bb9\uff1a</p> <p></p> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8be5UI\u5b9a\u4e49\u65b0\u7684\u9759\u9ed8\u89c4\u5219\u7684\u5f00\u59cb\u65f6\u95f4\u4ee5\u53ca\u6301\u7eed\u65f6\u95f4\uff0c\u901a\u8fc7Matchers\u90e8\u5206\u53ef\u4ee5\u8bbe\u7f6e\u591a\u6761\u5339\u914d\u89c4\u5219(\u5b57\u7b26\u4e32\u5339\u914d\u6216\u8005\u6b63\u5219\u5339\u914d)\u3002\u586b\u5199\u5f53\u524d\u9759\u9ed8\u89c4\u5219\u7684\u521b\u5efa\u8005\u4ee5\u53ca\u521b\u5efa\u539f\u56e0\u540e\uff0c\u70b9\u51fb\"Create\"\u6309\u94ae\u5373\u53ef\u3002</p> <p>\u901a\u8fc7\"Preview Alerts\"\u53ef\u4ee5\u67e5\u770b\u9884\u89c8\u5f53\u524d\u5339\u914d\u89c4\u5219\u5339\u914d\u5230\u7684\u544a\u8b66\u4fe1\u606f\u3002\u9759\u9ed8\u89c4\u5219\u521b\u5efa\u6210\u529f\u540e\uff0cAlertmanager\u4f1a\u5f00\u59cb\u52a0\u8f7d\u8be5\u89c4\u5219\u5e76\u4e14\u8bbe\u7f6e\u72b6\u6001\u4e3aPending,\u5f53\u89c4\u5219\u751f\u6548\u540e\u5219\u8fdb\u884c\u5230Active\u72b6\u6001\u3002</p> <p></p> <p>\u5f53\u9759\u9ed8\u89c4\u5219\u751f\u6548\u4ee5\u540e\uff0c\u4eceAlertmanager\u7684Alerts\u9875\u9762\u4e0b\u7528\u6237\u5c06\u4e0d\u4f1a\u770b\u5230\u8be5\u89c4\u5219\u5339\u914d\u5230\u7684\u544a\u8b66\u4fe1\u606f\u3002</p> <p></p> <p>\u5bf9\u4e8e\u5df2\u7ecf\u751f\u6548\u7684\u89c4\u5219\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u70b9\u51fb\u201cExpire\u201d\u6309\u94ae\u4f7f\u5f53\u524d\u89c4\u5219\u8fc7\u671f\u3002</p>"},{"location":"alert/alert-manager-route/","title":"\u57fa\u4e8e\u6807\u7b7e\u7684\u544a\u8b66\u8def\u7531","text":"<p>\u5728Alertmanager\u7684\u914d\u7f6e\u4e2d\u4f1a\u5b9a\u4e49\u4e00\u4e2a\u57fa\u4e8e\u6807\u7b7e\u5339\u914d\u89c4\u5219\u7684\u544a\u8b66\u8def\u7531\u6811\uff0c\u4ee5\u786e\u5b9a\u5728\u63a5\u6536\u5230\u544a\u8b66\u540eAlertmanager\u9700\u8981\u5982\u4f55\u5bf9\u5176\u8fdb\u884c\u5904\u7406\uff1a</p> <pre><code>route: &lt;route&gt;\n</code></pre> <p>\u5176\u4e2droute\u4e2d\u5219\u4e3b\u8981\u5b9a\u4e49\u4e86\u544a\u8b66\u7684\u8def\u7531\u5339\u914d\u89c4\u5219\uff0c\u4ee5\u53caAlertmanager\u9700\u8981\u5c06\u5339\u914d\u5230\u7684\u544a\u8b66\u53d1\u9001\u7ed9\u54ea\u4e00\u4e2areceiver\uff0c\u4e00\u4e2a\u6700\u7b80\u5355\u7684route\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>route:\n  group_by: ['alertname']\n  receiver: 'web.hook'\nreceivers:\n- name: 'web.hook'\n  webhook_configs:\n  - url: 'http://127.0.0.1:5001/'\n</code></pre> <p>\u5982\u4e0a\u6240\u793a\uff1a\u5728Alertmanager\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8def\u7531\uff0c\u90a3\u5c31\u610f\u5473\u7740\u6240\u6709\u7531Prometheus\u4ea7\u751f\u7684\u544a\u8b66\u5728\u53d1\u9001\u5230Alertmanager\u4e4b\u540e\u90fd\u4f1a\u901a\u8fc7\u540d\u4e3a<code>web.hook</code>\u7684receiver\u63a5\u6536\u3002\u8fd9\u91cc\u7684web.hook\u5b9a\u4e49\u4e3a\u4e00\u4e2awebhook\u5730\u5740\u3002\u5f53\u7136\u5b9e\u9645\u573a\u666f\u4e0b\uff0c\u544a\u8b66\u5904\u7406\u53ef\u4e0d\u662f\u8fd9\u4e48\u7b80\u5355\u7684\u4e00\u4ef6\u4e8b\u60c5\uff0c\u5bf9\u4e8e\u4e0d\u540c\u7ea7\u522b\u7684\u544a\u8b66\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u6709\u5b8c\u5168\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u56e0\u6b64\u5728route\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5b9a\u4e49\u66f4\u591a\u7684\u5b50Route\uff0c\u8fd9\u4e9bRoute\u901a\u8fc7\u6807\u7b7e\u5339\u914d\u544a\u8b66\u7684\u5904\u7406\u65b9\u5f0f\uff0croute\u7684\u5b8c\u6574\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>[ receiver: &lt;string&gt; ]\n[ group_by: '[' &lt;labelname&gt;, ... ']' ]\n[ continue: &lt;boolean&gt; | default = false ]\n\nmatch:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]\n\nmatch_re:\n  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]\n\n[ group_wait: &lt;duration&gt; | default = 30s ]\n[ group_interval: &lt;duration&gt; | default = 5m ]\n[ repeat_interval: &lt;duration&gt; | default = 4h ]\n\nroutes:\n  [ - &lt;route&gt; ... ]\n</code></pre>"},{"location":"alert/alert-manager-route/#_2","title":"\u8def\u7531\u5339\u914d","text":"<p>\u6bcf\u4e00\u4e2a\u544a\u8b66\u90fd\u4f1a\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u9876\u7ea7\u7684route\u8fdb\u5165\u8def\u7531\u6811\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u9876\u7ea7\u7684route\u5fc5\u987b\u5339\u914d\u6240\u6709\u544a\u8b66(\u5373\u4e0d\u80fd\u6709\u4efb\u4f55\u7684\u5339\u914d\u8bbe\u7f6ematch\u548cmatch_re)\uff0c\u6bcf\u4e00\u4e2a\u8def\u7531\u90fd\u53ef\u4ee5\u5b9a\u4e49\u81ea\u5df1\u7684\u63a5\u53d7\u4eba\u4ee5\u53ca\u5339\u914d\u89c4\u5219\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u544a\u8b66\u8fdb\u5165\u5230\u9876\u7ea7route\u540e\u4f1a\u904d\u5386\u6240\u6709\u7684\u5b50\u8282\u70b9\uff0c\u76f4\u5230\u627e\u5230\u6700\u6df1\u7684\u5339\u914droute\uff0c\u5e76\u5c06\u544a\u8b66\u53d1\u9001\u5230\u8be5route\u5b9a\u4e49\u7684receiver\u4e2d\u3002\u4f46\u5982\u679croute\u4e2d\u8bbe\u7f6econtinue\u7684\u503c\u4e3afalse\uff0c\u90a3\u4e48\u544a\u8b66\u5728\u5339\u914d\u5230\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\u4e4b\u540e\u5c31\u76f4\u63a5\u505c\u6b62\u3002\u5982\u679ccontinue\u4e3atrue\uff0c\u62a5\u8b66\u5219\u4f1a\u7ee7\u7eed\u8fdb\u884c\u540e\u7eed\u5b50\u8282\u70b9\u7684\u5339\u914d\u3002\u5982\u679c\u5f53\u524d\u544a\u8b66\u5339\u914d\u4e0d\u5230\u4efb\u4f55\u7684\u5b50\u8282\u70b9\uff0c\u90a3\u8be5\u544a\u8b66\u5c06\u4f1a\u57fa\u4e8e\u5f53\u524d\u8def\u7531\u8282\u70b9\u7684\u63a5\u6536\u5668\u914d\u7f6e\u65b9\u5f0f\u8fdb\u884c\u5904\u7406\u3002</p> <p>\u5176\u4e2d\u544a\u8b66\u7684\u5339\u914d\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u9009\u62e9\u3002\u4e00\u79cd\u65b9\u5f0f\u57fa\u4e8e\u5b57\u7b26\u4e32\u9a8c\u8bc1\uff0c\u901a\u8fc7\u8bbe\u7f6ematch\u89c4\u5219\u5224\u65ad\u5f53\u524d\u544a\u8b66\u4e2d\u662f\u5426\u5b58\u5728\u6807\u7b7elabelname\u5e76\u4e14\u5176\u503c\u7b49\u4e8elabelvalue\u3002\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u5219\u57fa\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u901a\u8fc7\u8bbe\u7f6ematch_re\u9a8c\u8bc1\u5f53\u524d\u544a\u8b66\u6807\u7b7e\u7684\u503c\u662f\u5426\u6ee1\u8db3\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5185\u5bb9\u3002</p> <p>\u5982\u679c\u8b66\u62a5\u5df2\u7ecf\u6210\u529f\u53d1\u9001\u901a\u77e5, \u5982\u679c\u60f3\u8bbe\u7f6e\u53d1\u9001\u544a\u8b66\u901a\u77e5\u4e4b\u524d\u8981\u7b49\u5f85\u65f6\u95f4\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7repeat_interval\u53c2\u6570\u8fdb\u884c\u8bbe\u7f6e\u3002</p>"},{"location":"alert/alert-manager-route/#_3","title":"\u544a\u8b66\u5206\u7ec4","text":"<p>\u5728\u4e4b\u524d\u7684\u90e8\u5206\u6709\u8bb2\u8fc7\uff0cAlertmanager\u53ef\u4ee5\u5bf9\u544a\u8b66\u901a\u77e5\u8fdb\u884c\u5206\u7ec4\uff0c\u5c06\u591a\u6761\u544a\u8b66\u5408\u5408\u5e76\u4e3a\u4e00\u4e2a\u901a\u77e5\u3002\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528group_by\u6765\u5b9a\u4e49\u5206\u7ec4\u89c4\u5219\u3002\u57fa\u4e8e\u544a\u8b66\u4e2d\u5305\u542b\u7684\u6807\u7b7e\uff0c\u5982\u679c\u6ee1\u8db3group_by\u4e2d\u5b9a\u4e49\u6807\u7b7e\u540d\u79f0\uff0c\u90a3\u4e48\u8fd9\u4e9b\u544a\u8b66\u5c06\u4f1a\u5408\u5e76\u4e3a\u4e00\u4e2a\u901a\u77e5\u53d1\u9001\u7ed9\u63a5\u6536\u5668\u3002</p> <p>\u6709\u7684\u65f6\u5019\u4e3a\u4e86\u80fd\u591f\u4e00\u6b21\u6027\u6536\u96c6\u548c\u53d1\u9001\u66f4\u591a\u7684\u76f8\u5173\u4fe1\u606f\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7group_wait\u53c2\u6570\u8bbe\u7f6e\u7b49\u5f85\u65f6\u95f4\uff0c\u5982\u679c\u5728\u7b49\u5f85\u65f6\u95f4\u5185\uff0c\u5f53\u524dgroup\u63a5\u6536\u5230\u4e86\u65b0\u7684\u544a\u8b66\uff0c\u8fd9\u4e9b\u544a\u8b66\u5c06\u4f1a\u5408\u5e76\u4e3a\u4e00\u4e2a\u901a\u77e5\u5411receiver\u53d1\u9001\u3002</p> <p>\u800cgroup_interval\u914d\u7f6e\uff0c\u5219\u7528\u4e8e\u5b9a\u4e49\u76f8\u540c\u7684Group\u4e4b\u95f4\u53d1\u9001\u544a\u8b66\u901a\u77e5\u7684\u65f6\u95f4\u95f4\u9694\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u4f7f\u7528Prometheus\u76d1\u63a7\u591a\u4e2a\u96c6\u7fa4\u4ee5\u53ca\u90e8\u7f72\u5728\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u548c\u6570\u636e\u5e93\u670d\u52a1\uff0c\u5e76\u4e14\u5b9a\u4e49\u4ee5\u4e0b\u7684\u544a\u8b66\u5904\u7406\u8def\u7531\u89c4\u5219\u6765\u5bf9\u96c6\u7fa4\u4e2d\u7684\u5f02\u5e38\u8fdb\u884c\u901a\u77e5\u3002</p> <pre><code>route:\n  receiver: 'default-receiver'\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 4h\n  group_by: [cluster, alertname]\n  routes:\n  - receiver: 'database-pager'\n    group_wait: 10s\n    match_re:\n      service: mysql|cassandra\n  - receiver: 'frontend-pager'\n    group_by: [product, environment]\n    match:\n      team: frontend\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6240\u6709\u7684\u544a\u8b66\u90fd\u4f1a\u53d1\u9001\u7ed9\u96c6\u7fa4\u7ba1\u7406\u5458default-receiver\uff0c\u56e0\u6b64\u5728Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\u7684\u6839\u8def\u7531\u4e2d\uff0c\u5bf9\u544a\u8b66\u4fe1\u606f\u6309\u7167\u96c6\u7fa4\u4ee5\u53ca\u544a\u8b66\u7684\u540d\u79f0\u5bf9\u544a\u8b66\u8fdb\u884c\u5206\u7ec4\u3002</p> <p>\u5982\u679c\u544a\u8b66\u65f6\u6765\u6e90\u4e8e\u6570\u636e\u5e93\u670d\u52a1\u5982MySQL\u6216\u8005Cassandra\uff0c\u6b64\u65f6\u5219\u9700\u8981\u5c06\u544a\u8b66\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u5e93\u7ba1\u7406\u5458(database-pager)\u3002\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5355\u72ec\u5b50\u8def\u7531\uff0c\u5982\u679c\u544a\u8b66\u4e2d\u5305\u542bservice\u6807\u7b7e\uff0c\u5e76\u4e14service\u4e3aMySQL\u6216\u8005Cassandra,\u5219\u5411database-pager\u53d1\u9001\u544a\u8b66\u901a\u77e5\uff0c\u7531\u4e8e\u8fd9\u91cc\u6ca1\u6709\u5b9a\u4e49group_by\u7b49\u5c5e\u6027\uff0c\u8fd9\u4e9b\u5c5e\u6027\u7684\u914d\u7f6e\u4fe1\u606f\u5c06\u4ece\u4e0a\u7ea7\u8def\u7531\u7ee7\u627f\uff0cdatabase-pager\u5c06\u4f1a\u63a5\u6536\u5230\u6309cluster\u548calertname\u8fdb\u884c\u5206\u7ec4\u7684\u544a\u8b66\u901a\u77e5\u3002</p> <p>\u800c\u67d0\u4e9b\u544a\u8b66\u89c4\u5219\u53ef\u80fd\u6765\u6e90\u4e8e\u5f00\u53d1\u56e2\u961f\u7684\u5b9a\u4e49\uff0c\u8fd9\u4e9b\u544a\u8b66\u4e2d\u901a\u8fc7\u6dfb\u52a0\u6807\u7b7eteam\u6765\u6807\u793a\u8fd9\u4e9b\u544a\u8b66\u7684\u521b\u5efa\u8005\u3002\u5728Alertmanager\u914d\u7f6e\u6587\u4ef6\u7684\u544a\u8b66\u8def\u7531\u4e0b\uff0c\u5b9a\u4e49\u5355\u72ec\u5b50\u8def\u7531\u7528\u4e8e\u5904\u7406\u8fd9\u4e00\u7c7b\u7684\u544a\u8b66\u901a\u77e5\uff0c\u5982\u679c\u5339\u914d\u5230\u544a\u8b66\u4e2d\u5305\u542b\u6807\u7b7eteam\uff0c\u5e76\u4e14team\u7684\u503c\u4e3afrontend\uff0cAlertmanager\u5c06\u4f1a\u6309\u7167\u6807\u7b7eproduct\u548cenvironment\u5bf9\u544a\u8b66\u8fdb\u884c\u5206\u7ec4\u3002\u6b64\u65f6\u5982\u679c\u5e94\u7528\u51fa\u73b0\u5f02\u5e38\uff0c\u5f00\u53d1\u56e2\u961f\u5c31\u80fd\u6e05\u695a\u7684\u77e5\u9053\u54ea\u4e00\u4e2a\u73af\u5883(environment)\u4e2d\u7684\u54ea\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u53ef\u4ee5\u5feb\u901f\u5bf9\u5e94\u7528\u8fdb\u884c\u95ee\u9898\u5b9a\u4f4d\u3002</p>"},{"location":"alert/alert-manager-use-receiver/","title":"\u5185\u7f6e\u544a\u8b66\u63a5\u6536\u5668Receiver","text":"<p>\u524d\u4e0a\u4e00\u5c0f\u8282\u5df2\u7ecf\u8bb2\u8fc7\uff0c\u5728Alertmanager\u4e2d\u8def\u7531\u8d1f\u8d23\u5bf9\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u5206\u7ec4\u5339\u914d\uff0c\u5e76\u5c06\u50cf\u544a\u8b66\u63a5\u6536\u5668\u53d1\u9001\u901a\u77e5\u3002\u544a\u8b66\u63a5\u6536\u5668\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u5f62\u5f0f\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>receivers:\n  - &lt;receiver&gt; ...\n</code></pre> <p>\u6bcf\u4e00\u4e2areceiver\u5177\u6709\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684\u540d\u79f0\uff0c\u5e76\u4e14\u5bf9\u5e94\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u901a\u77e5\u65b9\u5f0f\uff1a</p> <pre><code>name: &lt;string&gt;\nemail_configs:\n  [ - &lt;email_config&gt;, ... ]\nhipchat_configs:\n  [ - &lt;hipchat_config&gt;, ... ]\npagerduty_configs:\n  [ - &lt;pagerduty_config&gt;, ... ]\npushover_configs:\n  [ - &lt;pushover_config&gt;, ... ]\nslack_configs:\n  [ - &lt;slack_config&gt;, ... ]\nopsgenie_configs:\n  [ - &lt;opsgenie_config&gt;, ... ]\nwebhook_configs:\n  [ - &lt;webhook_config&gt;, ... ]\nvictorops_configs:\n  [ - &lt;victorops_config&gt;, ... ]\n</code></pre> <p>\u76ee\u524d\u5b98\u65b9\u5185\u7f6e\u7684\u7b2c\u4e09\u65b9\u901a\u77e5\u96c6\u6210\u5305\u62ec\uff1a\u90ae\u4ef6\u3001 \u5373\u65f6\u901a\u8baf\u8f6f\u4ef6\uff08\u5982Slack\u3001Hipchat\uff09\u3001\u79fb\u52a8\u5e94\u7528\u6d88\u606f\u63a8\u9001(\u5982Pushover)\u548c\u81ea\u52a8\u5316\u8fd0\u7ef4\u5de5\u5177\uff08\u4f8b\u5982\uff1aPagerduty\u3001Opsgenie\u3001Victorops\uff09\u3002Alertmanager\u7684\u901a\u77e5\u65b9\u5f0f\u4e2d\u8fd8\u53ef\u4ee5\u652f\u6301Webhook\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5f00\u53d1\u8005\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a\u4e2a\u6027\u5316\u7684\u6269\u5c55\u652f\u6301\u3002</p>"},{"location":"alert/alert-template/","title":"Alert template","text":""},{"location":"alert/alert-template/#_1","title":"\u81ea\u5b9a\u4e49\u544a\u8b66\u6a21\u677f","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0bAlertmanager\u4f7f\u7528\u4e86\u7cfb\u7edf\u81ea\u5e26\u7684\u9ed8\u8ba4\u901a\u77e5\u6a21\u677f\uff0c\u6a21\u677f\u6e90\u7801\u53ef\u4ee5\u4ecehttps://github.com/prometheus/alertmanager/blob/master/template/default.tmpl\u83b7\u5f97\u3002Alertmanager\u7684\u901a\u77e5\u6a21\u677f\u57fa\u4e8eGo\u7684\u6a21\u677f\u7cfb\u7edf\u3002Alertmanager\u4e5f\u652f\u6301\u7528\u6237\u5b9a\u4e49\u548c\u4f7f\u7528\u81ea\u5df1\u7684\u6a21\u677f\uff0c\u4e00\u822c\u6765\u8bf4\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u9009\u62e9\u3002</p> <p>\u7b2c\u4e00\u79cd\uff0c\u57fa\u4e8e\u6a21\u677f\u5b57\u7b26\u4e32\u3002\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u5728Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u6a21\u677f\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982:</p> <pre><code>receivers:\n- name: 'slack-notifications'\n  slack_configs:\n  - channel: '#alerts'\n    text: 'https://internal.myorg.net/wiki/alerts/{{ .GroupLabels.app }}/{{ .GroupLabels.alertname }}'\n</code></pre> <p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u81ea\u5b9a\u4e49\u53ef\u590d\u7528\u7684\u6a21\u677f\u6587\u4ef6\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u521b\u5efa\u81ea\u5b9a\u4e49\u6a21\u677f\u6587\u4ef6custom-template.tmpl\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{ define \"slack.myorg.text\" }}https://internal.myorg.net/wiki/alerts/{{ .GroupLabels.app }}/{{ .GroupLabels.alertname }}{{ end}}\n</code></pre> <p>\u901a\u8fc7\u5728Alertmanager\u7684\u5168\u5c40\u8bbe\u7f6e\u4e2d\u5b9a\u4e49templates\u914d\u7f6e\u6765\u6307\u5b9a\u81ea\u5b9a\u4e49\u6a21\u677f\u7684\u8bbf\u95ee\u8def\u5f84:</p> <pre><code># Files from which custom notification template definitions are read.\n# The last component may use a wildcard matcher, e.g. 'templates/*.tmpl'.\ntemplates:\n  [ - &lt;filepath&gt; ... ]\n</code></pre> <p>\u5728\u8bbe\u7f6e\u4e86\u81ea\u5b9a\u4e49\u6a21\u677f\u7684\u8bbf\u95ee\u8def\u5f84\u540e\uff0c\u7528\u6237\u5219\u53ef\u4ee5\u76f4\u63a5\u5728\u914d\u7f6e\u4e2d\u4f7f\u7528\u8be5\u6a21\u677f\uff1a</p> <pre><code>receivers:\n- name: 'slack-notifications'\n  slack_configs:\n  - channel: '#alerts'\n    text: '{{ template \"slack.myorg.text\" . }}'\n\ntemplates:\n- '/etc/alertmanager/templates/myorg.tmpl'\n</code></pre>"},{"location":"alert/alert-with-slack/","title":"\u4e0eSlack\u96c6\u6210","text":"<p>Slack\u662f\u975e\u5e38\u6d41\u884c\u7684\u56e2\u961f\u6c9f\u901a\u5e94\u7528\uff0c\u63d0\u4f9b\u7fa4\u7ec4\u804a\u5929\u548c\u76f4\u63a5\u6d88\u606f\u53d1\u9001\u529f\u80fd\uff0c\u652f\u6301\u79fb\u52a8\u7aef\uff0cWeb \u548c\u684c\u9762\u5e73\u53f0\u3002\u5728\u56fd\u5916\u6709\u5927\u91cf\u7684IT\u56e2\u961f\u4f7f\u7528Slack\u4f5c\u4e3a\u56e2\u961f\u534f\u4f5c\u5e73\u53f0\u3002\u540c\u65f6\u5176\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u96c6\u6210\u80fd\u529b\uff0c\u5728Slack\u7684\u57fa\u7840\u4e0a\u4e5f\u884d\u751f\u51fa\u4e86\u5927\u91cf\u7684ChatOps\u76f8\u5173\u7684\u6280\u672f\u5b9e\u8df5\u3002\u8fd9\u90e8\u5206\u5c06\u4ecb\u7ecd\u5982\u4f55\u5c06Slack\u96c6\u6210\u5230Alertmanager\u4e2d\u3002</p>"},{"location":"alert/alert-with-slack/#slack_1","title":"\u8ba4\u8bc6Slack","text":"<p>Slack\u4f5c\u4e3a\u4e00\u6b3e\u5373\u65f6\u901a\u8baf\u5de5\u5177\uff0c\u534f\u4f5c\u6c9f\u901a\u4e3b\u8981\u901a\u8fc7Channel\uff08\u5e73\u53f0\uff09\u6765\u5b8c\u6210\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u4f01\u4e1a\u4e2d\u6839\u636e\u7528\u9014\u6dfb\u52a0\u591a\u4e2aChannel\uff0c\u5e76\u4e14\u901a\u8fc7Channel\u6765\u96c6\u6210\u5404\u79cd\u7b2c\u4e09\u65b9\u5de5\u5177\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a\u76d1\u63a7\u5efa\u7acb\u4e00\u4e2a\u5355\u72ec\u7684Channel\u7528\u4e8e\u63a5\u6536\u5404\u79cd\u76d1\u63a7\u4fe1\u606f\uff1a</p> <p></p> <p>\u901a\u8fc7\u4e00\u4e2a\u72ec\u7acb\u7684Channle\u53ef\u4ee5\u51cf\u5c11\u4fe1\u606f\u5bf9\u7528\u6237\u5de5\u4f5c\u7684\u5e72\u6270\uff0c\u5e76\u4e14\u5c06\u76f8\u5173\u4fe1\u606f\u805a\u5408\u5728\u4e00\u8d77\uff1a</p> <p></p> <p>Slack\u7684\u5f3a\u5927\u4e4b\u5904\u5728\u4e8e\u5728Channel\u4e2d\u6dfb\u52a0\u5404\u79cd\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u96c6\u6210\uff0c\u7528\u6237\u4e5f\u53ef\u4ee5\u57fa\u4e8eSlack\u5f00\u53d1\u81ea\u5df1\u7684\u804a\u5929\u673a\u5668\u4eba\u6765\u5b9e\u73b0\u4e00\u4e9b\u66f4\u9ad8\u7ea7\u7684\u80fd\u529b\uff0c\u4f8b\u5982\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0c\u63d0\u9ad8\u5f00\u53d1\u6548\u7387\u7b49\u3002</p>"},{"location":"alert/alert-with-slack/#incomming-webhooks","title":"\u6dfb\u52a0\u5e94\u7528\uff1aIncomming Webhooks","text":"<p>\u4e3a\u4e86\u80fd\u591f\u5728Monitoring\u4e2d\u63a5\u6536\u6765\u81eaAlertmanager\u7684\u6d88\u606f\uff0c\u6211\u4eec\u9700\u8981\u5728Channel\u7684\u8bbe\u7f6e\u9009\u9879\u4e2d\u4f7f\u7528\"Add an App\"\u4e3aMonitoring channel\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a<code>Incoming WebHooks</code>\u7684\u5e94\u7528\uff1a</p> <p></p> <p>\u6dfb\u52a0\u6210\u529f\u540eSlack\u4f1a\u663e\u793a<code>Incoming WebHooks</code>\u914d\u7f6e\u548c\u4f7f\u7528\u65b9\u5f0f\uff1a</p> <p></p> <p>Incomming Webhook\u7684\u5de5\u4f5c\u65b9\u5f0f\u5f88\u7b80\u5355\uff0cSlack\u4e3a\u5f53\u524dChannel\u521b\u5efa\u4e86\u4e00\u4e2a\u7528\u4e8e\u63a5\u6536\u6d88\u606f\u7684API\u5730\u5740\uff1a</p> <pre><code>https://hooks.slack.com/services/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\n</code></pre> <p>\u7528\u6237\u53ea\u9700\u8981\u4f7f\u7528Post\u65b9\u5f0f\u5411Channel\u53d1\u9001\u9700\u8981\u901a\u77e5\u7684\u6d88\u606f\u5373\u53ef\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u547d\u4ee4\u884c\u4e2d\u901a\u8fc7curl\u6a21\u62df\u4e00\u6b21\u6d88\u606f\u901a\u77e5\uff1a</p> <pre><code>curl -d \"payload={'text': 'This is a line of text in a channel.\\nAnd this is another line of text.'}\" https://hooks.slack.com/services/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\n</code></pre> <p>\u5728\u7f51\u7edc\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\uff0c\u5728Channel\u4e2d\u4f1a\u663e\u793a\u65b0\u7684\u901a\u77e5\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9664\u4e86\u53d1\u9001\u7eaf\u6587\u672c\u4ee5\u5916\uff0cslack\u8fd8\u652f\u6301\u5728\u6587\u672c\u5185\u5bb9\u4e2d\u6dfb\u52a0\u94fe\u63a5\uff0c\u4f8b\u5982\uff1a</p> <pre><code>payload={\"text\": \"A very important thing has occurred! &lt;https://alert-system.com/alerts/1234|Click here&gt; for details!\"}\n</code></pre> <p>\u6b64\u65f6\u63a5\u6536\u5230\u7684\u6d88\u606f\u4e2d\u5efa\u8f89\u5305\u542b\u4e00\u4e2a\u53ef\u70b9\u51fb\u7684\u8d85\u94fe\u63a5\u5730\u5740\u3002\u9664\u4e86payload\u4ee5\u5916\uff0cIncomming Webhhook\u8fd8\u652f\u6301\u4e00\u4e9b\u5176\u4ed6\u7684\u53c2\u6570\uff1a</p> \u53c2\u6570 \u4f5c\u7528 \u793a\u4f8b username \u8bbe\u7f6e\u5f53\u524d\u804a\u5929\u673a\u5668\u4eba\u7684\u540d\u79f0 webhookbot icon_url \u5f53\u524d\u804a\u5929\u673a\u5668\u4eba\u7684\u5934\u50cf\u5730\u5740 https://slack.com/img/icons/app-57.png icon_emoji \u4f7f\u7528emoji\u4f5c\u4e3a\u804a\u5929\u673a\u5668\u4eba\u7684\u5934\u50cf :ghost: channel \u6d88\u606f\u53d1\u9001\u7684\u76ee\u6807channel, \u9700\u8981\u76f4\u63a5\u53d1\u7ed9\u7279\u5b9a\u7528\u6237\u65f6\u4f7f\u7528@username\u5373\u53ef #monitoring \u6216\u8005 @username <p>\u4f8b\u5982\uff0c\u4f7f\u7528\u4ee5\u4e0a\u53c2\u6570\u53d1\u9001\u4e00\u6761\u66f4\u6709\u8da3\u7684\u6d88\u606f\uff1a</p> <pre><code>curl -X POST --data-urlencode \"payload={'channel': '#monitoring', 'username': 'webhookbot', 'text': 'This is posted to #monitoring and comes from a bot named webhookbot.', 'icon_emoji': ':ghost:'}\" https://hooks.slack.com/services/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\n</code></pre> <p></p>"},{"location":"alert/alert-with-slack/#alertmanagerslack","title":"\u5728Alertmanager\u4e2d\u4f7f\u7528Slack","text":"<p>\u5728\u4e86\u89e3\u4e86Slack\u4ee5\u53caIncomming Webhhook\u7684\u57fa\u672c\u4f7f\u7528\u65b9\u5f0f\u540e\uff0c\u5728Alertmanager\u4e2d\u6dfb\u52a0Slack\u652f\u6301\u5c31\u975e\u5e38\u7b80\u5355\u4e86\u3002</p> <p>\u5728Alertmanager\u7684\u5168\u5c40\u914d\u7f6e\u4e2d\uff0c\u5c06Incomming Webhhook\u5730\u5740\u4f5c\u4e3aslack_api_url\u6dfb\u52a0\u5230\u5168\u5c40\u914d\u7f6e\u4e2d\u5373\u53ef\uff1a</p> <pre><code>global:\n  slack_api_url: https://hooks.slack.com/services/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\n</code></pre> <p>\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u5728\u6bcf\u4e2areceiver\u4e2d\u5355\u72ec\u5b9a\u4e49\u81ea\u5df1\u7684slack_configs\u5373\u53ef\uff1a</p> <pre><code>receivers\uff1a\n- name: slack\n  slack_configs:\n    - channel: '#monitoring'\n      send_resolved: true\n</code></pre> <p>\u8fd9\u91cc\u5982\u679c\u6211\u4eec\u624b\u52a8\u62c9\u9ad8\u5f53\u524d\u4e3b\u673a\u7684CPU\u5229\u7528\u7387\uff0c\u5728#Monitoring\u5e73\u53f0\u4e2d\uff0c\u6211\u4eec\u4f1a\u63a5\u6536\u5230\u4e00\u6761\u544a\u8b66\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u800c\u5f53\u544a\u8b66\u9879\u6062\u590d\u6b63\u5e38\u540e\uff0c\u5219\u53ef\u4ee5\u63a5\u6536\u5230\u5982\u4e0b\u901a\u77e5\uff1a</p> <p></p> <p>\u5bf9\u4e8eIncomming Webhhook\u652f\u6301\u7684\u5176\u5b83\u81ea\u5b9a\u4e49\u53c2\u6570\uff0c\u4e5f\u53ef\u4ee5\u5728slack_config\u4e2d\u8fdb\u884c\u5b9a\u4e49\uff0cslack_config\u7684\u4e3b\u8981\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>channel: &lt;tmpl_string&gt;\n[ send_resolved: &lt;boolean&gt; | default = false ]\n[ api_url: &lt;secret&gt; | default = global.slack_api_url ]\n[ icon_emoji: &lt;tmpl_string&gt; ]\n[ icon_url: &lt;tmpl_string&gt; ]\n[ link_names: &lt;boolean&gt; | default = false ]\n[ username: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.username\" . }}' ]\n[ color: &lt;tmpl_string&gt; | default = '{{ if eq .Status \"firing\" }}danger{{ else }}good{{ end }}' ]\n[ footer: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.footer\" . }}' ]\n[ pretext: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.pretext\" . }}' ]\n[ text: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.text\" . }}' ]\n[ title: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.title\" . }}' ]\n[ title_link: &lt;tmpl_string&gt; | default = '{{ template \"slack.default.titlelink\" . }}' ]\n[ image_url: &lt;tmpl_string&gt; ]\n[ thumb_url: &lt;tmpl_string&gt; ]\n</code></pre> <p>\u5982\u679c\u8981\u8986\u76d6\u9ed8\u8ba4\u7684\u544a\u8b66\u5185\u5bb9\uff0c\u76f4\u63a5\u4f7f\u7528Go Template\u5373\u53ef\u3002\u4f8b\u5982\uff1a</p> <pre><code>color: '{{ if eq .Status \"firing\" }}danger{{ else }}good{{ end }}'\n</code></pre>"},{"location":"alert/alert-with-smtp/","title":"\u4e0eSMTP\u90ae\u4ef6\u96c6\u6210","text":"<p>\u90ae\u7bb1\u5e94\u8be5\u662f\u76ee\u524d\u4f01\u4e1a\u6700\u5e38\u7528\u7684\u544a\u8b66\u901a\u77e5\u65b9\u5f0f\uff0cAlertmanager\u5185\u7f6e\u4e86\u5bf9SMTP\u534f\u8bae\u7684\u652f\u6301\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4f01\u4e1a\u7528\u6237\u800c\u8a00\uff0c\u53ea\u9700\u8981\u4e00\u4e9b\u57fa\u672c\u7684\u914d\u7f6e\u5373\u53ef\u5b9e\u73b0\u901a\u8fc7\u90ae\u4ef6\u7684\u901a\u77e5\u3002</p> <p>\u5728Alertmanager\u4f7f\u7528\u90ae\u7bb1\u901a\u77e5\uff0c\u7528\u6237\u53ea\u9700\u8981\u5b9a\u4e49\u597dSMTP\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u5e76\u4e14\u5728receiver\u4e2d\u5b9a\u4e49\u63a5\u6536\u65b9\u7684\u90ae\u4ef6\u5730\u5740\u5373\u53ef\u3002\u5728Alertmanager\u4e2d\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728\u914d\u7f6e\u6587\u4ef6\u7684global\u4e2d\u5b9a\u4e49\u5168\u5c40\u7684SMTP\u914d\u7f6e\uff1a</p> <pre><code>global:\n  [ smtp_from: &lt;tmpl_string&gt; ]\n  [ smtp_smarthost: &lt;string&gt; ]\n  [ smtp_hello: &lt;string&gt; | default = \"localhost\" ]\n  [ smtp_auth_username: &lt;string&gt; ]\n  [ smtp_auth_password: &lt;secret&gt; ]\n  [ smtp_auth_identity: &lt;string&gt; ]\n  [ smtp_auth_secret: &lt;secret&gt; ]\n  [ smtp_require_tls: &lt;bool&gt; | default = true ]\n</code></pre> <p>\u5b8c\u6210\u5168\u5c40SMTP\u4e4b\u540e\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4e3areceiver\u914d\u7f6eemail_configs\u7528\u4e8e\u5b9a\u4e49\u4e00\u7ec4\u63a5\u6536\u544a\u8b66\u7684\u90ae\u7bb1\u5730\u5740\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>name: &lt;string&gt;\nemail_configs:\n  [ - &lt;email_config&gt;, ... ]\n</code></pre> <p>\u6bcf\u4e2aemail_config\u4e2d\u5b9a\u4e49\u76f8\u5e94\u7684\u63a5\u6536\u4eba\u90ae\u7bb1\u5730\u5740\uff0c\u90ae\u4ef6\u901a\u77e5\u6a21\u677f\u7b49\u4fe1\u606f\u5373\u53ef\uff0c\u5f53\u7136\u5982\u679c\u5f53\u524d\u63a5\u6536\u4eba\u9700\u8981\u5355\u72ec\u7684SMTP\u914d\u7f6e\uff0c\u90a3\u76f4\u63a5\u5728email_config\u4e2d\u8986\u76d6\u5373\u53ef\uff1a</p> <pre><code>[ send_resolved: &lt;boolean&gt; | default = false ]\nto: &lt;tmpl_string&gt;\n[ html: &lt;tmpl_string&gt; | default = '{{ template \"email.default.html\" . }}' ]\n[ headers: { &lt;string&gt;: &lt;tmpl_string&gt;, ... } ]\n</code></pre> <p>\u5982\u679c\u5f53\u524d\u6536\u4ef6\u4eba\u9700\u8981\u63a5\u53d7\u544a\u8b66\u6062\u590d\u7684\u901a\u77e5\u7684\u8bdd\uff0c\u5728email_config\u4e2d\u5b9a\u4e49<code>send_resolved</code>\u4e3atrue\u5373\u53ef\u3002</p> <p>\u5982\u679c\u6240\u6709\u7684\u90ae\u4ef6\u914d\u7f6e\u4f7f\u7528\u4e86\u76f8\u540c\u7684SMTP\u914d\u7f6e\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u5b9a\u4e49\u5168\u5c40\u7684SMTP\u914d\u7f6e\u3002</p> <p>\u8fd9\u91cc\uff0c\u4ee5Gmail\u90ae\u7bb1\u4e3a\u4f8b\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5168\u5c40\u7684SMTP\u914d\u7f6e\uff0c\u5e76\u4e14\u901a\u8fc7route\u5c06\u6240\u6709\u544a\u8b66\u4fe1\u606f\u53d1\u9001\u5230default-receiver\u4e2d:</p> <pre><code>global:\n  smtp_smarthost: smtp.gmail.com:587\n  smtp_from: &lt;smtp mail from&gt;\n  smtp_auth_username: &lt;usernae&gt;\n  smtp_auth_identity: &lt;username&gt;\n  smtp_auth_password: &lt;password&gt;\n\nroute:\n  group_by: ['alertname']\n  receiver: 'default-receiver'\n\nreceivers:\n  - name: default-receiver\n    email_configs:\n      - to: &lt;mail to address&gt;\n        send_resolved: true\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u65b0\u7684Google\u8d26\u53f7\u5b89\u5168\u89c4\u5219\u9700\u8981\u4f7f\u7528\u201c\u5e94\u7528\u4e13\u6709\u5bc6\u7801\u201d\u4f5c\u4e3a\u90ae\u7bb1\u767b\u5f55\u5bc6\u7801</p> <p>\u8fd9\u65f6\u5982\u679c\u624b\u52a8\u62c9\u9ad8\u4e3b\u673aCPU\u4f7f\u7528\u7387\uff0c\u4f7f\u5f97\u76d1\u63a7\u6837\u672c\u6570\u636e\u6ee1\u8db3\u544a\u8b66\u89e6\u53d1\u6761\u4ef6\u3002\u5728SMTP\u914d\u7f6e\u6b63\u786e\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u63a5\u6536\u5230\u5982\u4e0b\u7684\u544a\u8b66\u5185\u5bb9\uff1a</p> <p></p>"},{"location":"alert/alert-with-wechat/","title":"\u4e0e\u4f01\u4e1a\u5fae\u4fe1\u96c6\u6210","text":"<p>Alertmanager\u5df2\u7ecf\u5185\u7f6e\u4e86\u5bf9\u4f01\u4e1a\u5fae\u4fe1\u7684\u652f\u6301\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f01\u4e1a\u5fae\u4fe1\u6765\u7ba1\u7406\u62a5\u8b66\uff0c\u66f4\u8fdb\u4e00\u6b65\u53ef\u4ee5\u901a\u8fc7\u4f01\u4e1a\u5fae\u4fe1\u548c\u5fae\u4fe1\u7684\u4e92\u901a\u6765\u76f4\u63a5\u5c06\u544a\u8b66\u6d88\u606f\u8f6c\u53d1\u5230\u4e2a\u4eba\u5fae\u4fe1\u4e0a\u3002</p> <p>prometheus\u5b98\u7f51\u4e2d\u7ed9\u51fa\u4e86\u4f01\u4e1a\u5fae\u4fe1\u7684\u76f8\u5173\u914d\u7f6e\u8bf4\u660e</p> <pre><code># Whether or not to notify about resolved alerts.\n[ send_resolved: &lt;boolean&gt; | default = false ]\n\n# The API key to use when talking to the WeChat API.\n[ api_secret: &lt;secret&gt; | default = global.wechat_api_secret ]\n\n# The WeChat API URL.\n[ api_url: &lt;string&gt; | default = global.wechat_api_url ]\n\n# The corp id for authentication.\n[ corp_id: &lt;string&gt; | default = global.wechat_api_corp_id ]\n\n# API request data as defined by the WeChat API.\n[ message: &lt;tmpl_string&gt; | default = '{{ template \"wechat.default.message\" . }}' ]\n[ agent_id: &lt;string&gt; | default = '{{ template \"wechat.default.agent_id\" . }}' ]\n[ to_user: &lt;string&gt; | default = '{{ template \"wechat.default.to_user\" . }}' ]\n[ to_party: &lt;string&gt; | default = '{{ template \"wechat.default.to_party\" . }}' ]\n[ to_tag: &lt;string&gt; | default = '{{ template \"wechat.default.to_tag\" . }}' ]\n</code></pre> <p>\u4f01\u4e1a\u5fae\u4fe1\u76f8\u5173\u6982\u5ff5\u8bf4\u660e\u8bf7\u53c2\u8003\u4f01\u4e1a\u5fae\u4fe1API\u8bf4\u660e\uff0c\u53ef\u4ee5\u5728\u4f01\u4e1a\u5fae\u4fe1\u7684\u540e\u53f0\u4e2d\u5efa\u7acb\u591a\u4e2a\u5e94\u7528\uff0c\u6bcf\u4e2a\u5e94\u7528\u5bf9\u5e94\u4e0d\u540c\u7684\u62a5\u8b66\u5206\u7ec4\uff0c\u7531\u4f01\u4e1a\u5fae\u4fe1\u6765\u505a\u63a5\u6536\u6210\u5458\u7684\u5212\u5206\u3002\u5177\u4f53\u914d\u7f6e\u53c2\u8003\u5982\u4e0b\uff1a</p> <pre><code>global:\n  resolve_timeout: 10m\n  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'\n  wechat_api_secret: '\u5e94\u7528\u7684secret\uff0c\u5728\u5e94\u7528\u7684\u914d\u7f6e\u9875\u9762\u53ef\u4ee5\u770b\u5230'\n  wechat_api_corp_id: '\u4f01\u4e1aid\uff0c\u5728\u4f01\u4e1a\u7684\u914d\u7f6e\u9875\u9762\u53ef\u4ee5\u770b\u5230'\ntemplates:\n- '/etc/alertmanager/config/*.tmpl'\nroute:\n  group_by: ['alertname']\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  routes:\n  - receiver: 'wechat'\n    continue: true\ninhibit_rules:\n- source_match:\nreceivers:\n- name: 'wechat'\n  wechat_configs:\n  - send_resolved: false\n    corp_id: '\u4f01\u4e1aid\uff0c\u5728\u4f01\u4e1a\u7684\u914d\u7f6e\u9875\u9762\u53ef\u4ee5\u770b\u5230'\n    to_user: '@all'\n    to_party: ' PartyID1 | PartyID2 '\n    message: '{{ template \"wechat.default.message\" . }}'\n    agent_id: '\u5e94\u7528\u7684AgentId\uff0c\u5728\u5e94\u7528\u7684\u914d\u7f6e\u9875\u9762\u53ef\u4ee5\u770b\u5230'\n    api_secret: '\u5e94\u7528\u7684secret\uff0c\u5728\u5e94\u7528\u7684\u914d\u7f6e\u9875\u9762\u53ef\u4ee5\u770b\u5230'\n</code></pre> <p>\u914d\u7f6e\u6a21\u677f\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>{{ define \"wechat.default.message\" }}\n{{- if gt (len .Alerts.Firing) 0 -}}\n{{- range $index, $alert := .Alerts -}}\n{{- if eq $index 0 -}}\n\u544a\u8b66\u7c7b\u578b: {{ $alert.Labels.alertname }}\n\u544a\u8b66\u7ea7\u522b: {{ $alert.Labels.severity }}\n\n=====================\n{{- end }}\n===\u544a\u8b66\u8be6\u60c5===\n\u544a\u8b66\u8be6\u60c5: {{ $alert.Annotations.message }}\n\u6545\u969c\u65f6\u95f4: {{ $alert.StartsAt.Format \"2006-01-02 15:04:05\" }}\n===\u53c2\u8003\u4fe1\u606f===\n{{ if gt (len $alert.Labels.instance) 0 -}}\u6545\u969c\u5b9e\u4f8bip: {{ $alert.Labels.instance }};{{- end -}}\n{{- if gt (len $alert.Labels.namespace) 0 -}}\u6545\u969c\u5b9e\u4f8b\u6240\u5728namespace: {{ $alert.Labels.namespace }};{{- end -}}\n{{- if gt (len $alert.Labels.node) 0 -}}\u6545\u969c\u7269\u7406\u673aip: {{ $alert.Labels.node }};{{- end -}}\n{{- if gt (len $alert.Labels.pod_name) 0 -}}\u6545\u969cpod\u540d\u79f0: {{ $alert.Labels.pod_name }}{{- end }}\n=====================\n{{- end }}\n{{- end }}\n\n{{- if gt (len .Alerts.Resolved) 0 -}}\n{{- range $index, $alert := .Alerts -}}\n{{- if eq $index 0 -}}\n\u544a\u8b66\u7c7b\u578b: {{ $alert.Labels.alertname }}\n\u544a\u8b66\u7ea7\u522b: {{ $alert.Labels.severity }}\n\n=====================\n{{- end }}\n===\u544a\u8b66\u8be6\u60c5===\n\u544a\u8b66\u8be6\u60c5: {{ $alert.Annotations.message }}\n\u6545\u969c\u65f6\u95f4: {{ $alert.StartsAt.Format \"2006-01-02 15:04:05\" }}\n\u6062\u590d\u65f6\u95f4: {{ $alert.EndsAt.Format \"2006-01-02 15:04:05\" }}\n===\u53c2\u8003\u4fe1\u606f===\n{{ if gt (len $alert.Labels.instance) 0 -}}\u6545\u969c\u5b9e\u4f8bip: {{ $alert.Labels.instance }};{{- end -}}\n{{- if gt (len $alert.Labels.namespace) 0 -}}\u6545\u969c\u5b9e\u4f8b\u6240\u5728namespace: {{ $alert.Labels.namespace }};{{- end -}}\n{{- if gt (len $alert.Labels.node) 0 -}}\u6545\u969c\u7269\u7406\u673aip: {{ $alert.Labels.node }};{{- end -}}\n{{- if gt (len $alert.Labels.pod_name) 0 -}}\u6545\u969cpod\u540d\u79f0: {{ $alert.Labels.pod_name }};{{- end }}\n=====================\n{{- end }}\n{{- end }}\n{{- end }}\n</code></pre> <p>\u8fd9\u65f6\u5982\u679c\u67d0\u4e00\u5bb9\u5668\u9891\u7e41\u91cd\u542f\uff0c\u53ef\u4ee5\u63a5\u6536\u5230\u5982\u4e0b\u7684\u544a\u8b66\u5185\u5bb9\uff1a</p> <p></p>"},{"location":"alert/install-alert-manager/","title":"\u90e8\u7f72Alertmanager","text":"<p>Alertmanager\u548cPrometheus Server\u4e00\u6837\u5747\u91c7\u7528Golang\u5b9e\u73b0\uff0c\u5e76\u4e14\u6ca1\u6709\u7b2c\u4e09\u65b9\u4f9d\u8d56\u3002\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u6765\u90e8\u7f72Alertmanager\uff1a\u4e8c\u8fdb\u5236\u5305\u3001\u5bb9\u5668\u4ee5\u53ca\u6e90\u7801\u65b9\u5f0f\u5b89\u88c5\u3002</p>"},{"location":"alert/install-alert-manager/#alertmanager_1","title":"\u4f7f\u7528\u4e8c\u8fdb\u5236\u5305\u90e8\u7f72AlertManager","text":""},{"location":"alert/install-alert-manager/#_1","title":"\u83b7\u53d6\u5e76\u5b89\u88c5\u8f6f\u4ef6\u5305","text":"<p>Alertmanager\u6700\u65b0\u7248\u672c\u7684\u4e0b\u8f7d\u5730\u5740\u53ef\u4ee5\u4ecePrometheus\u5b98\u65b9\u7f51\u7ad9https://prometheus.io/download/\u83b7\u53d6\u3002</p> <pre><code>export VERSION=0.15.2\ncurl -LO https://github.com/prometheus/alertmanager/releases/download/v$VERSION/alertmanager-$VERSION.darwin-amd64.tar.gz\ntar xvf alertmanager-$VERSION.darwin-amd64.tar.gz\n</code></pre>"},{"location":"alert/install-alert-manager/#alertmanager_2","title":"\u521b\u5efaalertmanager\u914d\u7f6e\u6587\u4ef6","text":"<p>Alertmanager\u89e3\u538b\u540e\u4f1a\u5305\u542b\u4e00\u4e2a\u9ed8\u8ba4\u7684alertmanager.yml\u914d\u7f6e\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>global:\n  resolve_timeout: 5m\n\nroute:\n  group_by: ['alertname']\n  group_wait: 10s\n  group_interval: 10s\n  repeat_interval: 1h\n  receiver: 'web.hook'\nreceivers:\n- name: 'web.hook'\n  webhook_configs:\n  - url: 'http://127.0.0.1:5001/'\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\n</code></pre> <p>Alertmanager\u7684\u914d\u7f6e\u4e3b\u8981\u5305\u542b\u4e24\u4e2a\u90e8\u5206\uff1a\u8def\u7531(route)\u4ee5\u53ca\u63a5\u6536\u5668(receivers)\u3002\u6240\u6709\u7684\u544a\u8b66\u4fe1\u606f\u90fd\u4f1a\u4ece\u914d\u7f6e\u4e2d\u7684\u9876\u7ea7\u8def\u7531(route)\u8fdb\u5165\u8def\u7531\u6811\uff0c\u6839\u636e\u8def\u7531\u89c4\u5219\u5c06\u544a\u8b66\u4fe1\u606f\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u63a5\u6536\u5668\u3002</p> <p>\u5728Alertmanager\u4e2d\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7ec4\u63a5\u6536\u5668\uff0c\u6bd4\u5982\u53ef\u4ee5\u6309\u7167\u89d2\u8272(\u6bd4\u5982\u7cfb\u7edf\u8fd0\u7ef4\uff0c\u6570\u636e\u5e93\u7ba1\u7406\u5458)\u6765\u5212\u5206\u591a\u4e2a\u63a5\u6536\u5668\u3002\u63a5\u6536\u5668\u53ef\u4ee5\u5173\u8054\u90ae\u4ef6\uff0cSlack\u4ee5\u53ca\u5176\u5b83\u65b9\u5f0f\u63a5\u6536\u544a\u8b66\u4fe1\u606f\u3002</p> <p>\u5f53\u524d\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684\u63a5\u6536\u8005default-receiver\u7531\u4e8e\u8fd9\u91cc\u6ca1\u6709\u8bbe\u7f6e\u63a5\u6536\u65b9\u5f0f\uff0c\u76ee\u524d\u53ea\u76f8\u5f53\u4e8e\u4e00\u4e2a\u5360\u4f4d\u7b26\u3002\u5173\u4e8e\u63a5\u6536\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u4f1a\u5728\u540e\u7eed\u7ae0\u8282\u4ecb\u7ecd\u3002</p> <p>\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528route\u5b9a\u4e49\u4e86\u9876\u7ea7\u7684\u8def\u7531\uff0c\u8def\u7531\u662f\u4e00\u4e2a\u57fa\u4e8e\u6807\u7b7e\u5339\u914d\u89c4\u5219\u7684\u6811\u72b6\u7ed3\u6784\u3002\u6240\u6709\u7684\u544a\u8b66\u4fe1\u606f\u4ece\u9876\u7ea7\u8def\u7531\u5f00\u59cb\uff0c\u6839\u636e\u6807\u7b7e\u5339\u914d\u89c4\u5219\u8fdb\u5165\u5230\u4e0d\u540c\u7684\u5b50\u8def\u7531\uff0c\u5e76\u4e14\u6839\u636e\u5b50\u8def\u7531\u8bbe\u7f6e\u7684\u63a5\u6536\u5668\u53d1\u9001\u544a\u8b66\u3002\u76ee\u524d\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ea\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u9876\u7ea7\u8def\u7531route\u5e76\u4e14\u5b9a\u4e49\u7684\u63a5\u6536\u5668\u4e3adefault-receiver\u3002\u56e0\u6b64\uff0c\u6240\u6709\u7684\u544a\u8b66\u90fd\u4f1a\u53d1\u9001\u7ed9default-receiver\u3002\u5173\u4e8e\u8def\u7531\u7684\u8be6\u7ec6\u5185\u5bb9\u4f1a\u5728\u540e\u7eed\u8fdb\u884c\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>"},{"location":"alert/install-alert-manager/#alertmanager_3","title":"\u542f\u52a8Alertmanager","text":"<p>Alermanager\u4f1a\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u672c\u5730\u4e2d\uff0c\u9ed8\u8ba4\u7684\u5b58\u50a8\u8def\u5f84\u4e3a<code>data/</code>\u3002\u56e0\u6b64\uff0c\u5728\u542f\u52a8Alertmanager\u4e4b\u524d\u9700\u8981\u521b\u5efa\u76f8\u5e94\u7684\u76ee\u5f55\uff1a</p> <pre><code>./alertmanager\n</code></pre> <p>\u7528\u6237\u4e5f\u5728\u542f\u52a8Alertmanager\u65f6\u4f7f\u7528\u53c2\u6570\u4fee\u6539\u76f8\u5173\u914d\u7f6e\u3002<code>--config.file</code>\u7528\u4e8e\u6307\u5b9aalertmanager\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\uff0c<code>--storage.path</code>\u7528\u4e8e\u6307\u5b9a\u6570\u636e\u5b58\u50a8\u8def\u5f84\u3002</p>"},{"location":"alert/install-alert-manager/#_2","title":"\u67e5\u770b\u8fd0\u884c\u72b6\u6001","text":"<p>Alertmanager\u542f\u52a8\u540e\u53ef\u4ee5\u901a\u8fc79093\u7aef\u53e3\u8bbf\u95ee\uff0chttp://192.168.33.10:9093</p> <p></p> <p>Alert\u83dc\u5355\u4e0b\u53ef\u4ee5\u67e5\u770bAlertmanager\u63a5\u6536\u5230\u7684\u544a\u8b66\u5185\u5bb9\u3002Silences\u83dc\u5355\u4e0b\u5219\u53ef\u4ee5\u901a\u8fc7UI\u521b\u5efa\u9759\u9ed8\u89c4\u5219\uff0c\u8fd9\u90e8\u5206\u6211\u4eec\u4f1a\u5728\u540e\u7eed\u90e8\u5206\u4ecb\u7ecd\u3002\u8fdb\u5165Status\u83dc\u5355\uff0c\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u6001\u4ee5\u53ca\u914d\u7f6e\u4fe1\u606f\u3002</p>"},{"location":"alert/install-alert-manager/#prometheusalertmanager","title":"\u5173\u8054Prometheus\u4e0eAlertmanager","text":"<p>\u5728Prometheus\u7684\u67b6\u6784\u4e2d\u88ab\u5212\u5206\u6210\u4e24\u4e2a\u72ec\u7acb\u7684\u90e8\u5206\u3002Prometheus\u8d1f\u8d23\u4ea7\u751f\u544a\u8b66\uff0c\u800cAlertmanager\u8d1f\u8d23\u544a\u8b66\u4ea7\u751f\u540e\u7684\u540e\u7eed\u5904\u7406\u3002\u56e0\u6b64Alertmanager\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u9700\u8981\u5728Prometheus\u4e2d\u8bbe\u7f6eAlertmanager\u76f8\u5173\u7684\u4fe1\u606f\u3002</p> <p>\u7f16\u8f91Prometheus\u914d\u7f6e\u6587\u4ef6prometheus.yml,\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>alerting:\n  alertmanagers:\n    - static_configs:\n        - targets: ['localhost:9093']\n</code></pre> <p>\u91cd\u542fPrometheus\u670d\u52a1\uff0c\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u4ecehttp://192.168.33.10:9090/config\u67e5\u770balerting\u914d\u7f6e\u662f\u5426\u751f\u6548\u3002</p> <p>\u6b64\u65f6\uff0c\u518d\u6b21\u5c1d\u8bd5\u624b\u52a8\u62c9\u9ad8\u7cfb\u7edfCPU\u4f7f\u7528\u7387\uff1a</p> <pre><code>cat /dev/zero&gt;/dev/null\n</code></pre> <p>\u7b49\u5f85Prometheus\u544a\u8b66\u8fdb\u884c\u89e6\u53d1\u72b6\u6001\uff1a</p> <p></p> <p>\u67e5\u770bAlertmanager UI\u6b64\u65f6\u53ef\u4ee5\u770b\u5230Alertmanager\u63a5\u6536\u5230\u7684\u544a\u8b66\u4fe1\u606f\u3002</p> <p></p>"},{"location":"alert/install-alert-manager/#_3","title":"\u63a5\u4e0b\u6765","text":"<p>\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u6210\u529f\u5b89\u88c5\u90e8\u7f72\u4e86Alertmanager\u5e76\u4e14\u4e0ePrometheus\u5173\u8054\uff0c\u80fd\u591f\u6b63\u5e38\u63a5\u6536\u6765\u81eaPrometheus\u7684\u544a\u8b66\u4fe1\u606f\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u8be6\u7ec6\u4ecb\u7ecdAlertmanager\u662f\u5982\u4f55\u5904\u7406\u8fd9\u4e9b\u63a5\u6536\u5230\u7684\u544a\u8b66\u4fe1\u606f\u7684\u3002</p>"},{"location":"alert/prometheus-alert-manager-overview/","title":"Prometheus\u544a\u8b66\u7b80\u4ecb","text":"<p>\u544a\u8b66\u80fd\u529b\u5728Prometheus\u7684\u67b6\u6784\u4e2d\u88ab\u5212\u5206\u6210\u4e24\u4e2a\u72ec\u7acb\u7684\u90e8\u5206\u3002\u5982\u4e0b\u6240\u793a\uff0c\u901a\u8fc7\u5728Prometheus\u4e2d\u5b9a\u4e49AlertRule\uff08\u544a\u8b66\u89c4\u5219\uff09\uff0cPrometheus\u4f1a\u5468\u671f\u6027\u7684\u5bf9\u544a\u8b66\u89c4\u5219\u8fdb\u884c\u8ba1\u7b97\uff0c\u5982\u679c\u6ee1\u8db3\u544a\u8b66\u89e6\u53d1\u6761\u4ef6\u5c31\u4f1a\u5411Alertmanager\u53d1\u9001\u544a\u8b66\u4fe1\u606f\u3002</p> <p></p> <p>\u5728Prometheus\u4e2d\u4e00\u6761\u544a\u8b66\u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u51e0\u90e8\u5206\u7ec4\u6210\uff1a * \u544a\u8b66\u540d\u79f0\uff1a\u7528\u6237\u9700\u8981\u4e3a\u544a\u8b66\u89c4\u5219\u547d\u540d\uff0c\u5f53\u7136\u5bf9\u4e8e\u547d\u540d\u800c\u8a00\uff0c\u9700\u8981\u80fd\u591f\u76f4\u63a5\u8868\u8fbe\u51fa\u8be5\u544a\u8b66\u7684\u4e3b\u8981\u5185\u5bb9 * \u544a\u8b66\u89c4\u5219\uff1a\u544a\u8b66\u89c4\u5219\u5b9e\u9645\u4e0a\u4e3b\u8981\u7531PromQL\u8fdb\u884c\u5b9a\u4e49\uff0c\u5176\u5b9e\u9645\u610f\u4e49\u662f\u5f53\u8868\u8fbe\u5f0f\uff08PromQL\uff09\u67e5\u8be2\u7ed3\u679c\u6301\u7eed\u591a\u957f\u65f6\u95f4\uff08During\uff09\u540e\u51fa\u53d1\u544a\u8b66</p> <p>\u5728Prometheus\u4e2d\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7Group\uff08\u544a\u8b66\u7ec4\uff09\u5bf9\u4e00\u7ec4\u76f8\u5173\u7684\u544a\u8b66\u8fdb\u884c\u7edf\u4e00\u5b9a\u4e49\u3002\u5f53\u7136\u8fd9\u4e9b\u5b9a\u4e49\u90fd\u662f\u901a\u8fc7YAML\u6587\u4ef6\u6765\u7edf\u4e00\u7ba1\u7406\u7684\u3002</p> <p>Alertmanager\u4f5c\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u63a5\u6536\u5e76\u5904\u7406\u6765\u81eaPrometheus Server(\u4e5f\u53ef\u4ee5\u662f\u5176\u5b83\u7684\u5ba2\u6237\u7aef\u7a0b\u5e8f)\u7684\u544a\u8b66\u4fe1\u606f\u3002Alertmanager\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5904\u7406\uff0c\u6bd4\u5982\u5f53\u63a5\u6536\u5230\u5927\u91cf\u91cd\u590d\u544a\u8b66\u65f6\u80fd\u591f\u6d88\u9664\u91cd\u590d\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u540c\u65f6\u5bf9\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u5206\u7ec4\u5e76\u4e14\u8def\u7531\u5230\u6b63\u786e\u7684\u901a\u77e5\u65b9\uff0cPrometheus\u5185\u7f6e\u4e86\u5bf9\u90ae\u4ef6\uff0cSlack\u7b49\u591a\u79cd\u901a\u77e5\u65b9\u5f0f\u7684\u652f\u6301\uff0c\u540c\u65f6\u8fd8\u652f\u6301\u4e0eWebhook\u7684\u96c6\u6210\uff0c\u4ee5\u652f\u6301\u66f4\u591a\u5b9a\u5236\u5316\u7684\u573a\u666f\u3002\u4f8b\u5982\uff0c\u76ee\u524dAlertmanager\u8fd8\u4e0d\u652f\u6301\u9489\u9489\uff0c\u90a3\u7528\u6237\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7Webhook\u4e0e\u9489\u9489\u673a\u5668\u4eba\u8fdb\u884c\u96c6\u6210\uff0c\u4ece\u800c\u901a\u8fc7\u9489\u9489\u63a5\u6536\u544a\u8b66\u4fe1\u606f\u3002\u540c\u65f6AlertManager\u8fd8\u63d0\u4f9b\u4e86\u9759\u9ed8\u548c\u544a\u8b66\u6291\u5236\u673a\u5236\u6765\u5bf9\u544a\u8b66\u901a\u77e5\u884c\u4e3a\u8fdb\u884c\u4f18\u5316\u3002</p>"},{"location":"alert/prometheus-alert-manager-overview/#alertmanager","title":"Alertmanager\u7279\u6027","text":"<p>Alertmanager\u9664\u4e86\u63d0\u4f9b\u57fa\u672c\u7684\u544a\u8b66\u901a\u77e5\u80fd\u529b\u4ee5\u5916\uff0c\u8fd8\u4e3b\u8981\u63d0\u4f9b\u4e86\u5982\uff1a\u5206\u7ec4\u3001\u6291\u5236\u4ee5\u53ca\u9759\u9ed8\u7b49\u544a\u8b66\u7279\u6027\uff1a</p> <p></p>"},{"location":"alert/prometheus-alert-manager-overview/#_1","title":"\u5206\u7ec4","text":"<p>\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8be6\u7ec6\u7684\u544a\u8b66\u4fe1\u606f\u5408\u5e76\u6210\u4e00\u4e2a\u901a\u77e5\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6bd4\u5982\u7531\u4e8e\u7cfb\u7edf\u5b95\u673a\u5bfc\u81f4\u5927\u91cf\u7684\u544a\u8b66\u88ab\u540c\u65f6\u89e6\u53d1\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u88ab\u89e6\u53d1\u7684\u544a\u8b66\u5408\u5e76\u4e3a\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\uff0c\u907f\u514d\u4e00\u6b21\u6027\u63a5\u53d7\u5927\u91cf\u7684\u544a\u8b66\u901a\u77e5\uff0c\u800c\u65e0\u6cd5\u5bf9\u95ee\u9898\u8fdb\u884c\u5feb\u901f\u5b9a\u4f4d\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u96c6\u7fa4\u4e2d\u6709\u6570\u767e\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u670d\u52a1\u5b9e\u4f8b\uff0c\u5e76\u4e14\u4e3a\u6bcf\u4e00\u4e2a\u5b9e\u4f8b\u8bbe\u7f6e\u4e86\u544a\u8b66\u89c4\u5219\u3002\u5047\u5982\u6b64\u65f6\u53d1\u751f\u4e86\u7f51\u7edc\u6545\u969c\uff0c\u53ef\u80fd\u5bfc\u81f4\u5927\u91cf\u7684\u670d\u52a1\u5b9e\u4f8b\u65e0\u6cd5\u8fde\u63a5\u5230\u6570\u636e\u5e93\uff0c\u7ed3\u679c\u5c31\u4f1a\u6709\u6570\u767e\u4e2a\u544a\u8b66\u88ab\u53d1\u9001\u5230Alertmanager\u3002</p> <p>\u800c\u4f5c\u4e3a\u7528\u6237\uff0c\u53ef\u80fd\u53ea\u5e0c\u671b\u80fd\u591f\u5728\u4e00\u4e2a\u901a\u77e5\u4e2d\u5c31\u80fd\u67e5\u770b\u54ea\u4e9b\u670d\u52a1\u5b9e\u4f8b\u53d7\u5230\u5f71\u54cd\u3002\u8fd9\u65f6\u53ef\u4ee5\u6309\u7167\u670d\u52a1\u6240\u5728\u96c6\u7fa4\u6216\u8005\u544a\u8b66\u540d\u79f0\u5bf9\u544a\u8b66\u8fdb\u884c\u5206\u7ec4\uff0c\u800c\u5c06\u8fd9\u4e9b\u544a\u8b66\u5185\u805a\u5728\u4e00\u8d77\u6210\u4e3a\u4e00\u4e2a\u901a\u77e5\u3002</p> <p>\u544a\u8b66\u5206\u7ec4\uff0c\u544a\u8b66\u65f6\u95f4\uff0c\u4ee5\u53ca\u544a\u8b66\u7684\u63a5\u53d7\u65b9\u5f0f\u53ef\u4ee5\u901a\u8fc7Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"alert/prometheus-alert-manager-overview/#_2","title":"\u6291\u5236","text":"<p>\u6291\u5236\u662f\u6307\u5f53\u67d0\u4e00\u544a\u8b66\u53d1\u51fa\u540e\uff0c\u53ef\u4ee5\u505c\u6b62\u91cd\u590d\u53d1\u9001\u7531\u6b64\u544a\u8b66\u5f15\u53d1\u7684\u5176\u5b83\u544a\u8b66\u7684\u673a\u5236\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u96c6\u7fa4\u4e0d\u53ef\u8bbf\u95ee\u65f6\u89e6\u53d1\u4e86\u4e00\u6b21\u544a\u8b66\uff0c\u901a\u8fc7\u914d\u7f6eAlertmanager\u53ef\u4ee5\u5ffd\u7565\u4e0e\u8be5\u96c6\u7fa4\u6709\u5173\u7684\u5176\u5b83\u6240\u6709\u544a\u8b66\u3002\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u63a5\u6536\u5230\u5927\u91cf\u4e0e\u5b9e\u9645\u95ee\u9898\u65e0\u5173\u7684\u544a\u8b66\u901a\u77e5\u3002</p> <p>\u6291\u5236\u673a\u5236\u540c\u6837\u901a\u8fc7Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u8bbe\u7f6e\u3002</p>"},{"location":"alert/prometheus-alert-manager-overview/#_3","title":"\u9759\u9ed8","text":"<p>\u9759\u9ed8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u673a\u5236\u53ef\u4ee5\u5feb\u901f\u6839\u636e\u6807\u7b7e\u5bf9\u544a\u8b66\u8fdb\u884c\u9759\u9ed8\u5904\u7406\u3002\u5982\u679c\u63a5\u6536\u5230\u7684\u544a\u8b66\u7b26\u5408\u9759\u9ed8\u7684\u914d\u7f6e\uff0cAlertmanager\u5219\u4e0d\u4f1a\u53d1\u9001\u544a\u8b66\u901a\u77e5\u3002</p> <p>\u9759\u9ed8\u8bbe\u7f6e\u9700\u8981\u5728Alertmanager\u7684Web\u9875\u9762\u4e0a\u8fdb\u884c\u8bbe\u7f6e\u3002</p>"},{"location":"alert/prometheus-alert-rule/","title":"\u81ea\u5b9a\u4e49Prometheus\u544a\u8b66\u89c4\u5219","text":"<p>Prometheus\u4e2d\u7684\u544a\u8b66\u89c4\u5219\u5141\u8bb8\u4f60\u57fa\u4e8ePromQL\u8868\u8fbe\u5f0f\u5b9a\u4e49\u544a\u8b66\u89e6\u53d1\u6761\u4ef6\uff0cPrometheus\u540e\u7aef\u5bf9\u8fd9\u4e9b\u89e6\u53d1\u89c4\u5219\u8fdb\u884c\u5468\u671f\u6027\u8ba1\u7b97\uff0c\u5f53\u6ee1\u8db3\u89e6\u53d1\u6761\u4ef6\u540e\u5219\u4f1a\u89e6\u53d1\u544a\u8b66\u901a\u77e5\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7Prometheus\u7684Web\u754c\u9762\u67e5\u770b\u8fd9\u4e9b\u544a\u8b66\u89c4\u5219\u4ee5\u53ca\u544a\u8b66\u7684\u89e6\u53d1\u72b6\u6001\u3002\u5f53Prometheus\u4e0eAlertmanager\u5173\u8054\u4e4b\u540e\uff0c\u53ef\u4ee5\u5c06\u544a\u8b66\u53d1\u9001\u5230\u5916\u90e8\u670d\u52a1\u5982Alertmanager\u4e2d\u5e76\u901a\u8fc7Alertmanager\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u544a\u8b66\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5904\u7406\u3002</p>"},{"location":"alert/prometheus-alert-rule/#_1","title":"\u5b9a\u4e49\u544a\u8b66\u89c4\u5219","text":"<p>\u4e00\u6761\u5178\u578b\u7684\u544a\u8b66\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>groups:\n- name: example\n  rules:\n  - alert: HighErrorRate\n    expr: job:request_latency_seconds:mean5m{job=\"myjob\"} &gt; 0.5\n    for: 10m\n    labels:\n      severity: page\n    annotations:\n      summary: High request latency\n      description: description info\n</code></pre> <p>\u5728\u544a\u8b66\u89c4\u5219\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e00\u7ec4\u76f8\u5173\u7684\u89c4\u5219\u8bbe\u7f6e\u5b9a\u4e49\u5728\u4e00\u4e2agroup\u4e0b\u3002\u5728\u6bcf\u4e00\u4e2agroup\u4e2d\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a\u544a\u8b66\u89c4\u5219(rule)\u3002\u4e00\u6761\u544a\u8b66\u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u51e0\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>alert\uff1a\u544a\u8b66\u89c4\u5219\u7684\u540d\u79f0\u3002</li> <li>expr\uff1a\u57fa\u4e8ePromQL\u8868\u8fbe\u5f0f\u544a\u8b66\u89e6\u53d1\u6761\u4ef6\uff0c\u7528\u4e8e\u8ba1\u7b97\u662f\u5426\u6709\u65f6\u95f4\u5e8f\u5217\u6ee1\u8db3\u8be5\u6761\u4ef6\u3002</li> <li>for\uff1a\u8bc4\u4f30\u7b49\u5f85\u65f6\u95f4\uff0c\u53ef\u9009\u53c2\u6570\u3002\u7528\u4e8e\u8868\u793a\u53ea\u6709\u5f53\u89e6\u53d1\u6761\u4ef6\u6301\u7eed\u4e00\u6bb5\u65f6\u95f4\u540e\u624d\u53d1\u9001\u544a\u8b66\u3002\u5728\u7b49\u5f85\u671f\u95f4\u65b0\u4ea7\u751f\u544a\u8b66\u7684\u72b6\u6001\u4e3apending\u3002</li> <li>labels\uff1a\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u5141\u8bb8\u7528\u6237\u6307\u5b9a\u8981\u9644\u52a0\u5230\u544a\u8b66\u4e0a\u7684\u4e00\u7ec4\u9644\u52a0\u6807\u7b7e\u3002</li> <li>annotations\uff1a\u7528\u4e8e\u6307\u5b9a\u4e00\u7ec4\u9644\u52a0\u4fe1\u606f\uff0c\u6bd4\u5982\u7528\u4e8e\u63cf\u8ff0\u544a\u8b66\u8be6\u7ec6\u4fe1\u606f\u7684\u6587\u5b57\u7b49\uff0cannotations\u7684\u5185\u5bb9\u5728\u544a\u8b66\u4ea7\u751f\u65f6\u4f1a\u4e00\u540c\u4f5c\u4e3a\u53c2\u6570\u53d1\u9001\u5230Alertmanager\u3002</li> </ul> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u542f\u7528\u5b9a\u4e49\u7684\u544a\u8b66\u89c4\u5219\uff0c\u6211\u4eec\u9700\u8981\u5728Prometheus\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\u4e2d\u901a\u8fc7__rule_files__\u6307\u5b9a\u4e00\u7ec4\u544a\u8b66\u89c4\u5219\u6587\u4ef6\u7684\u8bbf\u95ee\u8def\u5f84\uff0cPrometheus\u542f\u52a8\u540e\u4f1a\u81ea\u52a8\u626b\u63cf\u8fd9\u4e9b\u8def\u5f84\u4e0b\u89c4\u5219\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5185\u5bb9\uff0c\u5e76\u4e14\u6839\u636e\u8fd9\u4e9b\u89c4\u5219\u8ba1\u7b97\u662f\u5426\u5411\u5916\u90e8\u53d1\u9001\u901a\u77e5\uff1a</p> <pre><code>rule_files:\n  [ - &lt;filepath_glob&gt; ... ]\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0bPrometheus\u4f1a\u6bcf\u5206\u949f\u5bf9\u8fd9\u4e9b\u544a\u8b66\u89c4\u5219\u8fdb\u884c\u8ba1\u7b97\uff0c\u5982\u679c\u7528\u6237\u60f3\u5b9a\u4e49\u81ea\u5df1\u7684\u544a\u8b66\u8ba1\u7b97\u5468\u671f\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7<code>evaluation_interval</code>\u6765\u8986\u76d6\u9ed8\u8ba4\u7684\u8ba1\u7b97\u5468\u671f\uff1a</p> <pre><code>global:\n  [ evaluation_interval: &lt;duration&gt; | default = 1m ]\n</code></pre>"},{"location":"alert/prometheus-alert-rule/#_2","title":"\u6a21\u677f\u5316","text":"<p>\u4e00\u822c\u6765\u8bf4\uff0c\u5728\u544a\u8b66\u89c4\u5219\u6587\u4ef6\u7684annotations\u4e2d\u4f7f\u7528<code>summary</code>\u63cf\u8ff0\u544a\u8b66\u7684\u6982\u8981\u4fe1\u606f\uff0c<code>description</code>\u7528\u4e8e\u63cf\u8ff0\u544a\u8b66\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u540c\u65f6Alertmanager\u7684UI\u4e5f\u4f1a\u6839\u636e\u8fd9\u4e24\u4e2a\u6807\u7b7e\u503c\uff0c\u663e\u793a\u544a\u8b66\u4fe1\u606f\u3002\u4e3a\u4e86\u8ba9\u544a\u8b66\u4fe1\u606f\u5177\u6709\u66f4\u597d\u7684\u53ef\u8bfb\u6027\uff0cPrometheus\u652f\u6301\u6a21\u677f\u5316label\u548cannotations\u7684\u4e2d\u6807\u7b7e\u7684\u503c\u3002</p> <p>\u901a\u8fc7<code>$labels.&lt;labelname&gt;</code>\u53d8\u91cf\u53ef\u4ee5\u8bbf\u95ee\u5f53\u524d\u544a\u8b66\u5b9e\u4f8b\u4e2d\u6307\u5b9a\u6807\u7b7e\u7684\u503c\u3002$value\u5219\u53ef\u4ee5\u83b7\u53d6\u5f53\u524dPromQL\u8868\u8fbe\u5f0f\u8ba1\u7b97\u7684\u6837\u672c\u503c\u3002</p> <pre><code># To insert a firing element's label values:\n{{ $labels.&lt;labelname&gt; }}\n# To insert the numeric expression value of the firing element:\n{{ $value }}\n</code></pre> <p>\u4f8b\u5982\uff0c\u53ef\u4ee5\u901a\u8fc7\u6a21\u677f\u5316\u4f18\u5316summary\u4ee5\u53cadescription\u7684\u5185\u5bb9\u7684\u53ef\u8bfb\u6027\uff1a</p> <pre><code>groups:\n- name: example\n  rules:\n\n  # Alert for any instance that is unreachable for &gt;5 minutes.\n  - alert: InstanceDown\n    expr: up == 0\n    for: 5m\n    labels:\n      severity: page\n    annotations:\n      summary: \"Instance {{ $labels.instance }} down\"\n      description: \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.\"\n\n  # Alert for any instance that has a median request latency &gt;1s.\n  - alert: APIHighRequestLatency\n    expr: api_http_request_latencies_second{quantile=\"0.5\"} &gt; 1\n    for: 10m\n    annotations:\n      summary: \"High request latency on {{ $labels.instance }}\"\n      description: \"{{ $labels.instance }} has a median request latency above 1s (current value: {{ $value }}s)\"\n</code></pre>"},{"location":"alert/prometheus-alert-rule/#_3","title":"\u67e5\u770b\u544a\u8b66\u72b6\u6001","text":"<p>\u5982\u4e0b\u6240\u793a\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7Prometheus WEB\u754c\u9762\u4e2d\u7684Alerts\u83dc\u5355\u67e5\u770b\u5f53\u524dPrometheus\u4e0b\u7684\u6240\u6709\u544a\u8b66\u89c4\u5219\uff0c\u4ee5\u53ca\u5176\u5f53\u524d\u6240\u5904\u7684\u6d3b\u52a8\u72b6\u6001\u3002</p> <p></p> <p>\u540c\u65f6\u5bf9\u4e8e\u5df2\u7ecfpending\u6216\u8005firing\u7684\u544a\u8b66\uff0cPrometheus\u4e5f\u4f1a\u5c06\u5b83\u4eec\u5b58\u50a8\u5230\u65f6\u95f4\u5e8f\u5217ALERTS{}\u4e2d\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u8868\u8fbe\u5f0f\uff0c\u67e5\u8be2\u544a\u8b66\u5b9e\u4f8b\uff1a</p> <pre><code>ALERTS{alertname=\"&lt;alert name&gt;\", alertstate=\"pending|firing\", &lt;additional alert labels&gt;}\n</code></pre> <p>\u6837\u672c\u503c\u4e3a1\u8868\u793a\u5f53\u524d\u544a\u8b66\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\uff08pending\u6216\u8005firing\uff09\uff0c\u5f53\u544a\u8b66\u4ece\u6d3b\u52a8\u72b6\u6001\u8f6c\u6362\u4e3a\u975e\u6d3b\u52a8\u72b6\u6001\u65f6\uff0c\u6837\u672c\u503c\u5219\u4e3a0\u3002</p>"},{"location":"alert/prometheus-alert-rule/#_4","title":"\u5b9e\u4f8b\uff1a\u5b9a\u4e49\u4e3b\u673a\u76d1\u63a7\u544a\u8b66","text":"<p>\u4fee\u6539Prometheus\u914d\u7f6e\u6587\u4ef6prometheus.yml,\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>rule_files:\n  - /etc/prometheus/rules/*.rules\n</code></pre> <p>\u5728\u76ee\u5f55/etc/prometheus/rules/\u4e0b\u521b\u5efa\u544a\u8b66\u6587\u4ef6hoststats-alert.rules\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>groups:\n- name: hostStatsAlert\n  rules:\n  - alert: hostCpuUsageAlert\n    expr: sum(avg without (cpu)(irate(node_cpu{mode!='idle'}[5m]))) by (instance) &gt; 0.85\n    for: 1m\n    labels:\n      severity: page\n    annotations:\n      summary: \"Instance {{ $labels.instance }} CPU usgae high\"\n      description: \"{{ $labels.instance }} CPU usage above 85% (current value: {{ $value }})\"\n  - alert: hostMemUsageAlert\n    expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal &gt; 0.85\n    for: 1m\n    labels:\n      severity: page\n    annotations:\n      summary: \"Instance {{ $labels.instance }} MEM usgae high\"\n      description: \"{{ $labels.instance }} MEM usage above 85% (current value: {{ $value }})\"\n</code></pre> <p>\u91cd\u542fPrometheus\u540e\u8bbf\u95eePrometheus UIhttp://127.0.0.1:9090/rules\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u4ee5\u52a0\u8f7d\u7684\u89c4\u5219\u6587\u4ef6\u3002</p> <p></p> <p>\u5207\u6362\u5230Alerts\u6807\u7b7ehttp://127.0.0.1:9090/alerts\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u544a\u8b66\u7684\u6d3b\u52a8\u72b6\u6001\u3002</p> <p></p> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u62c9\u9ad8\u7cfb\u7edf\u7684CPU\u4f7f\u7528\u7387\uff0c\u9a8c\u8bc1Prometheus\u7684\u544a\u8b66\u6d41\u7a0b\uff0c\u5728\u4e3b\u673a\u4e0a\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>cat /dev/zero&gt;/dev/null\n</code></pre> <p>\u8fd0\u884c\u547d\u4ee4\u540e\u67e5\u770bCPU\u4f7f\u7528\u7387\u60c5\u51b5\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>Prometheus\u9996\u6b21\u68c0\u6d4b\u5230\u6ee1\u8db3\u89e6\u53d1\u6761\u4ef6\u540e\uff0chostCpuUsageAlert\u663e\u793a\u7531\u4e00\u6761\u544a\u8b66\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\u3002\u7531\u4e8e\u544a\u8b66\u89c4\u5219\u4e2d\u8bbe\u7f6e\u4e861m\u7684\u7b49\u5f85\u65f6\u95f4\uff0c\u5f53\u524d\u544a\u8b66\u72b6\u6001\u4e3aPENDING\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5982\u679c1\u5206\u949f\u540e\u544a\u8b66\u6761\u4ef6\u6301\u7eed\u6ee1\u8db3\uff0c\u5219\u4f1a\u5b9e\u9645\u89e6\u53d1\u544a\u8b66\u5e76\u4e14\u544a\u8b66\u72b6\u6001\u4e3aFIRING\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p>"},{"location":"alert/prometheus-alert-rule/#_5","title":"\u63a5\u4e0b\u6765","text":"<p>\u5728\u8fd9\u4e00\u5c0f\u8282\u4e2d\u4ecb\u7ecd\u4e86\u5982\u4f55\u914d\u7f6e\u548c\u4f7f\u7528Prometheus\u63d0\u4f9b\u7684\u544a\u8b66\u80fd\u529b\uff0c\u5e76\u4e14\u5c1d\u8bd5\u5b9e\u73b0\u4e86\u5bf9\u4e3b\u673aCPU\u4ee5\u53ca\u5185\u5b58\u7684\u544a\u8b66\u89c4\u5219\u8bbe\u7f6e\u3002\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7Prometheus UI\u67e5\u770b\u5f53\u524d\u544a\u8b66\u7684\u6d3b\u52a8\u72b6\u6001\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5c1d\u8bd5\u5229\u7528Prometheus\u4f53\u7cfb\u4e2d\u7684\u53e6\u4e00\u4e2a\u7ec4\u4ef6Alertmanager\u5bf9\u8fd9\u4e9b\u89e6\u53d1\u7684\u544a\u8b66\u8fdb\u884c\u5904\u7406\uff0c\u5b9e\u73b0\u544a\u8b66\u901a\u77e5\u3002</p>"},{"location":"alert/prometheus-recoding-rules/","title":"\u4f7f\u7528Recoding Rules\u4f18\u5316\u6027\u80fd","text":"<p>\u901a\u8fc7PromQL\u53ef\u4ee5\u5b9e\u65f6\u5bf9Prometheus\u4e2d\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u67e5\u8be2\uff0c\u805a\u5408\u4ee5\u53ca\u5176\u5b83\u5404\u79cd\u8fd0\u7b97\u64cd\u4f5c\u3002\u800c\u5728\u67d0\u4e9bPromQL\u8f83\u4e3a\u590d\u6742\u4e14\u8ba1\u7b97\u91cf\u8f83\u5927\u65f6\uff0c\u76f4\u63a5\u4f7f\u7528PromQL\u53ef\u80fd\u4f1a\u5bfc\u81f4Prometheus\u54cd\u5e94\u8d85\u65f6\u7684\u60c5\u51b5\u3002\u8fd9\u65f6\u9700\u8981\u4e00\u79cd\u80fd\u591f\u7c7b\u4f3c\u4e8e\u540e\u53f0\u6279\u5904\u7406\u7684\u673a\u5236\u80fd\u591f\u5728\u540e\u53f0\u5b8c\u6210\u8fd9\u4e9b\u590d\u6742\u8fd0\u7b97\u7684\u8ba1\u7b97\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u800c\u8a00\u53ea\u9700\u8981\u67e5\u8be2\u8fd9\u4e9b\u8fd0\u7b97\u7ed3\u679c\u5373\u53ef\u3002Prometheus\u901a\u8fc7Recoding Rule\u89c4\u5219\u652f\u6301\u8fd9\u79cd\u540e\u53f0\u8ba1\u7b97\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u590d\u6742\u67e5\u8be2\u7684\u6027\u80fd\u4f18\u5316\uff0c\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002</p>"},{"location":"alert/prometheus-recoding-rules/#recoding-rules_1","title":"\u5b9a\u4e49Recoding rules","text":"<p>\u5728Prometheus\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u901a\u8fc7rule_files\u5b9a\u4e49recoding rule\u89c4\u5219\u6587\u4ef6\u7684\u8bbf\u95ee\u8def\u5f84\u3002</p> <pre><code>rule_files:\n  [ - &lt;filepath_glob&gt; ... ]\n</code></pre> <p>\u6bcf\u4e00\u4e2a\u89c4\u5219\u6587\u4ef6\u901a\u8fc7\u4ee5\u4e0b\u683c\u5f0f\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>groups:\n  [ - &lt;rule_group&gt; ]\n</code></pre> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\u6587\u4ef6\u53ef\u80fd\u662f\u8fd9\u4e2a\u6837\u5b50\u7684\uff1a</p> <pre><code>groups:\n  - name: example\n    rules:\n    - record: job:http_inprogress_requests:sum\n      expr: sum(http_inprogress_requests) by (job)\n</code></pre> <p>rule_group\u7684\u5177\u4f53\u914d\u7f6e\u9879\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># The name of the group. Must be unique within a file.\nname: &lt;string&gt;\n\n# How often rules in the group are evaluated.\n[ interval: &lt;duration&gt; | default = global.evaluation_interval ]\n\nrules:\n  [ - &lt;rule&gt; ... ]\n</code></pre> <p>\u4e0e\u544a\u8b66\u89c4\u5219\u4e00\u81f4\uff0c\u4e00\u4e2agroup\u4e0b\u53ef\u4ee5\u5305\u542b\u591a\u6761\u89c4\u5219rule\u3002</p> <pre><code># The name of the time series to output to. Must be a valid metric name.\nrecord: &lt;string&gt;\n\n# The PromQL expression to evaluate. Every evaluation cycle this is\n# evaluated at the current time, and the result recorded as a new set of\n# time series with the metric name as given by 'record'.\nexpr: &lt;string&gt;\n\n# Labels to add or overwrite before storing the result.\nlabels:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt; ]\n</code></pre> <p>\u6839\u636e\u89c4\u5219\u4e2d\u7684\u5b9a\u4e49\uff0cPrometheus\u4f1a\u5728\u540e\u53f0\u5b8c\u6210expr\u4e2d\u5b9a\u4e49\u7684PromQL\u8868\u8fbe\u5f0f\u8ba1\u7b97\uff0c\u5e76\u4e14\u5c06\u8ba1\u7b97\u7ed3\u679c\u4fdd\u5b58\u5230\u65b0\u7684\u65f6\u95f4\u5e8f\u5217record\u4e2d\u3002\u540c\u65f6\u8fd8\u53ef\u4ee5\u901a\u8fc7labels\u4e3a\u8fd9\u4e9b\u6837\u672c\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002</p> <p>\u8fd9\u4e9b\u89c4\u5219\u6587\u4ef6\u7684\u8ba1\u7b97\u9891\u7387\u4e0e\u544a\u8b66\u89c4\u5219\u8ba1\u7b97\u9891\u7387\u4e00\u81f4\uff0c\u90fd\u901a\u8fc7global.evaluation_interval\u5b9a\u4e49:</p> <pre><code>global:\n  [ evaluation_interval: &lt;duration&gt; | default = 1m ]\n</code></pre>"},{"location":"draft/alert-with-wechat/","title":"\u4e0e\u5fae\u4fe1\u8fdb\u884c\u96c6\u6210","text":"<p>\u5728\u56fd\u5185\uff0c\u5fae\u4fe1\u5df2\u7ecf\u662f\u6700\u5927\u7684\u5373\u65f6\u901a\u8baf\u5de5\u5177\u3002\u5fae\u4fe1\u9488\u5bf9\u4f01\u4e1a\u7684\u5e94\u7528\u573a\u666f\u4e13\u95e8\u9000\u51fa\u4e86\u9762\u5411\u4f01\u4e1a\u7248\u5fae\u4fe1\u3002\u5728\u8fd9\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u5c06\u4f01\u4e1a\u5fae\u4fe1\u96c6\u6210\u5230Alertmanager\u4e2d\u3002</p>"},{"location":"draft/share_dashboard/","title":"\u5171\u4eabDashboard","text":""},{"location":"draft/use-federation-in-operator/","title":"\u4f7f\u7528Prometheus\u6784\u5efa\u8054\u90a6\u96c6\u7fa4","text":"<p>\u901a\u8fc7\u672c\u7ae0\u524d\u51e0\u8282\u7684\u5185\u5bb9\u8bfb\u8005\u5e94\u8be5\u5bf9Prometheus Operator\u6709\u4e86\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\u3002 \u8fd9\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u901a\u8fc7Prometheus Operator\u642d\u5efaPrometheus\u8054\u90a6\u96c6\u7fa4\u3002</p> <p>references: * https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#endpoint * https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec * additionalScrapeConfigs</p>"},{"location":"draft/use_table_panel/","title":"\u8868\u683c\uff1aTable Panel","text":"<p>\u901a\u8fc7\u8868\u683c\u7684\u5f62\u5f0f\u53ef\u4ee5\u540c\u65f6\u663e\u793a\u591a\u6761\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u67e5\u770b\u548c\u6bd4\u8f83\u76d1\u63a7\u6307\u6807\u7684\u6570\u636e\u3002Table Panel\u662fGrafana\u63d0\u4f9b\u7684\u57fa\u7840\u53ef\u89c6\u5316\u7ec4\u4ef6\u4e4b\u4e00\u3002</p> <p></p> <p>\u5bf9\u4e8ePrometheus\u91c7\u96c6\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0cTable Panel\u652f\u6301\u76f4\u63a5\u5c06PromQL\u8fd4\u56de\u7684\u65f6\u95f4\u5e8f\u5217\u683c\u5f0f\u5316\u4e3a\u8868\u683c\u7684\u5f62\u5f0f\u8fdb\u884c\u5c55\u793a\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c55\u793a\u65f6\u95f4\u5e8f\u5217\u5e76\u4e14\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\u805a\u5408\u3002</p>"},{"location":"draft/use_table_panel/#_1","title":"\u683c\u5f0f\u5316\u65f6\u95f4\u5e8f\u5217","text":"<p>\u5982\u4e0b\u6240\u793a\uff0c\bTable Panel\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0bFormat as\u914d\u7f6e\u9009\u9879\u4e3aTable\u3002\u8be5\u914d\u7f6e\u4f1a\u76f4\u63a5\u5c06PromQL\u67e5\u8be2\u5230\u7684\u6240\u6709\u6837\u672c\u683c\u5f0f\u5316\u4e3aGrafana\u7684Table\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u76f4\u63a5\u5c55\u793a\u5230\u8868\u683c\u5f53\u4e2d\u3002</p> <p></p> <p>\u5176\u4e2d\u6837\u672c\u7684\u6240\u6709\u6807\u7b7e\u90fd\u88ab\u6620\u5c04\u6210\u8868\u683c\u7684\u5217\uff0c\u5176\u4e2d\u540d\u4e3aValue\u5217\u4f1a\u663e\u793a\u5f53\u524d\u6837\u672c\u7684\u503c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6837\u672c\u503c\u4e0d\u5e26\u4efb\u4f55\u7684\u5355\u4f4d\uff0c\u4e3a\u4e86\u8ba9Table Panel\u80fd\u591f\u81ea\u52a8\u5316\u683c\u5f0f\u5316\u6837\u672c\u503c\uff0c\u53ef\u4ee5\u901a\u8fc7Column Styles\u4e3a\b\bValue\u5b9a\u4e49\u6837\u672c\u503c\u7684\u683c\u5f0f\u5316\u65b9\u5f0f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p>"},{"location":"draft/use_table_panel/#table","title":"\u4f7f\u7528Table\u53ef\u89c6\u5316\u65f6\u95f4\u5e8f\u5217","text":""},{"location":"draft/use_table_panel/#_2","title":"\u6309\u884c\u663e\u793a\u65f6\u95f4\u5e8f\u5217","text":""},{"location":"draft/use_table_panel/#_3","title":"\u6309\u5217\u663e\u793a\u65f6\u95f4\u5e8f\u5217","text":""},{"location":"draft/use_table_panel/#_4","title":"\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u805a\u5408","text":""},{"location":"examples/ch1/","title":"Prometheus Standalone Environment","text":""},{"location":"examples/ch1/#components","title":"Components","text":"<ul> <li>Prometheus Server</li> <li>Alertmanager</li> <li>Node Exporter</li> </ul>"},{"location":"examples/kubernetes/","title":"\u5728Kubernetes\u4e0b\u5b89\u88c5\u90e8\u7f72Prometheus","text":"<p>\u90e8\u7f72Prometheus</p> <pre><code>kubectl create -f prometheus/prometheus-rbac-setup.yml\nkubectl create -f prometheus/prometheus-config.yml\nkubectl create -f prometheus/prometheus-deployment.yml\nkubectl create -f prometheus/prometheus-ingress.yml\n</code></pre> <p>\u90e8\u7f72Exporters</p> <pre><code>kubectl create -f prometheus/node-exporter-daemonset.yml\nkubectl create -f prometheus/blackbox-exporter-deployment.yml\n</code></pre> <p>\u90e8\u7f72\u6d4b\u8bd5\u5e94\u7528</p> <pre><code>kubectl create -f nginx-deployment.yml\nkubectl create -f nginx/nginx-service.yml\n</code></pre>"},{"location":"examples/operator/","title":"Use Operator Manage Prometheus","text":""},{"location":"examples/operator/#prepare-helm","title":"Prepare Helm","text":"<pre><code>brew install kubernetes-helm\nhelm init\n</code></pre>"},{"location":"examples/operator/#kubernetes-rbd","title":"Kubernetes RBD","text":"<pre><code># minikube vm\ndocker run -d --net=host -v /etc/ceph:/etc/ceph -e MON_IP=192.168.99.100 -e CEPH_PUBLIC_NETWORK=192.168.99.0/24 ceph/demo ceph\n</code></pre>"},{"location":"examples/operator/#install-operator","title":"Install Operator","text":"<pre><code>helm repo add coreos https://s3-eu-west-1.amazonaws.com/coreos-charts/stable/\n\nhelm install coreos/prometheus-operator --name prometheus-operator --namespace monitoring\n\nhelm install coreos/kube-prometheus --name kube-prometheus --set global.rbacEnable=true --namespace monitoring\n</code></pre>"},{"location":"examples/standalone/","title":"Standalone Prometheus Sample","text":""},{"location":"examples/standalone/#components","title":"Components:","text":"<ul> <li>Prometheus</li> <li>Node Exporter</li> <li>cAdvisor</li> <li>Grafana</li> </ul>"},{"location":"examples/standalone/#how-to-run","title":"How To Run","text":"<pre><code>go get github.com/mattn/goreman\n</code></pre> <pre><code>docker volume create grafana-storage\n</code></pre> <pre><code>goreman -f prometheus.procfile start\n</code></pre>"},{"location":"exporter/","title":"\u7b2c4\u7ae0 \u4f7f\u7528Exporter","text":"<p>\u5728\u7b2c1\u7ae0\u4e2d\u4e3a\u4e86\u91c7\u96c6\u4e3b\u673a\u7684\u76d1\u63a7\u6837\u672c\u6570\u636e\uff0c\u6211\u4eec\u5728\u4e3b\u673a\u4e0a\u5b89\u88c5\u4e86\u4e00\u4e2aNode Exporter\u7a0b\u5e8f\uff0c\u8be5\u7a0b\u5e8f\u5bf9\u5916\u66b4\u9732\u4e86\u4e00\u4e2a\u7528\u4e8e\u83b7\u53d6\u5f53\u524d\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684HTTP\u8bbf\u95ee\u5730\u5740\u3002\u8fd9\u6837\u7684\u4e00\u4e2a\u7a0b\u5e8f\u79f0\u4e3aExporter\uff0cExporter\u7684\u5b9e\u4f8b\u79f0\u4e3a\u4e00\u4e2aTarget\u3002Prometheus\u901a\u8fc7\u8f6e\u8be2\u7684\u65b9\u5f0f\u5b9a\u65f6\u4ece\u8fd9\u4e9bTarget\u4e2d\u83b7\u53d6\u76d1\u63a7\u6570\u636e\u6837\u672c\uff0c\u5e76\u4e14\u5b58\u50a8\u5728\u6570\u636e\u5e93\u5f53\u4e2d\u3002 \u5728\u8fd9\u4e00\u7ae0\u8282\u5f53\u4e2d\u6211\u4eec\u5c06\u91cd\u70b9\u8ba8\u8bba\u8fd9\u4e9b\u7528\u4e8e\u83b7\u53d6\u7279\u5b9a\u76ee\u6807\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u7a0b\u5e8fExporter\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u5e38\u7528Exporter\u7684\u4f7f\u7528\uff0c\u4f8b\u5982\u5982\u4f55\u76d1\u63a7\u6570\u636e\u5e93\uff0c\u6d88\u606f\u4e2d\u95f4\u4ef6\u7b49</li> <li>\u5982\u4f55\u5b9e\u73b0\u81ea\u5b9a\u4e49\u7684Exporter\u7a0b\u5e8f</li> <li>\u5982\u4f55\u5bf9\u5df2\u6709\u7684\u5e94\u7528\u7a0b\u5e8f\u6269\u5c55Prometheus\u76d1\u63a7\u652f\u6301</li> </ul>"},{"location":"exporter/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>Prometheus\u8d1f\u8d23\u6570\u636e\u7684\u7edf\u4e00\u6536\u96c6\u5e76\u4e14\u63d0\u4f9b\u7edf\u4e00\u7684\u67e5\u8be2\u63a5\u53e3PromQL\uff0c\u800c\u6240\u6709\u76d1\u63a7\u6570\u636e\u7684\u4ea7\u751f\u5219\u662f\u7531Exporter\u6765\u8fdb\u884c\u5b9e\u73b0\uff0c\u5bf9\u4e8e\u4efb\u4f55\u80fd\u591f\u63d0\u4f9bPromethues\u6807\u51c6\u7684\u76d1\u63a7\u6837\u672c\u7684\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u79f0\u4e3aExporter\u3002Exporter\u53ef\u4ee5\u662f\u4e00\u4e2a\u5355\u72ec\u7684\u4e3a\u4e86\u91c7\u96c6\u7279\u5b9a\u6570\u636e\u800c\u6784\u5efa\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5185\u7f6e\u4e8e\u7279\u5b9a\u7684\u7cfb\u7edf\u5f53\u4e2d\u3002</p>"},{"location":"exporter/client_library_java/","title":"\u4f7f\u7528Client Java\u6784\u5efaExporter\u7a0b\u5e8f","text":"<p>client_java\u662fPrometheus\u9488\u5bf9JVM\u7c7b\u5f00\u53d1\u8bed\u8a00\u7684client library\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u57fa\u4e8eclient_java\u7528\u6237\u53ef\u4ee5\u5feb\u901f\u5b9e\u73b0\u72ec\u7acb\u8fd0\u884c\u7684Exporter\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u5728\u6211\u4eec\u7684\u9879\u76ee\u6e90\u7801\u4e2d\u96c6\u6210client_java\u4ee5\u652f\u6301Prometheus\u3002</p>"},{"location":"exporter/client_library_java/#collector","title":"\u81ea\u5b9a\u4e49Collector","text":"<p>\u5728client_java\u7684simpleclient\u6a21\u5757\u4e2d\u63d0\u4f9b\u4e86\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u7684\u6838\u5fc3\u63a5\u53e3\u3002</p> <p>\u5982\u679c\u4f7f\u7528Gradle\u4f5c\u4e3a\u9879\u76ee\u6784\u5efa\u5de5\u5177\uff0c\u53ef\u4ee5\u901a\u8fc7\u5411build.gradle\u6dfb\u52a0simpleclient\u4f9d\u8d56\uff1a</p> <pre><code>compile 'io.prometheus:simpleclient:0.3.0'\n</code></pre> <p>\u5f53\u65e0\u6cd5\u76f4\u63a5\u4fee\u6539\u76d1\u63a7\u76ee\u6807\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49Collector\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u5bf9\u76d1\u63a7\u6837\u672c\u6536\u96c6\uff0c\u8be5\u6536\u96c6\u5668\u9700\u8981\u5b9e\u73b0collect()\u65b9\u6cd5\u5e76\u8fd4\u56de\u4e00\u7ec4\u76d1\u63a7\u6837\u672c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>public class YourCustomCollector extends Collector {\n    public List&lt;MetricFamilySamples&gt; collect() {\n        List&lt;MetricFamilySamples&gt; mfs = new ArrayList&lt;MetricFamilySamples&gt;();\n\n        String metricName = \"my_guage_1\";\n\n        // Your code to get metrics\n\n        MetricFamilySamples.Sample sample = new MetricFamilySamples.Sample(metricName, Arrays.asList(\"l1\"), Arrays.asList(\"v1\"), 4);\n        MetricFamilySamples.Sample sample2 = new MetricFamilySamples.Sample(metricName, Arrays.asList(\"l1\", \"l2\"), Arrays.asList(\"v1\", \"v2\"), 3);\n\n        MetricFamilySamples samples = new MetricFamilySamples(metricName, Type.GAUGE, \"help\", Arrays.asList(sample, sample2));\n\n        mfs.add(samples);\n        return mfs;\n    }\n}\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3amy_guage\u7684\u76d1\u63a7\u6307\u6807\uff0c\u8be5\u76d1\u63a7\u6307\u6807\u7684\u6240\u6709\u6837\u672c\u6570\u636e\u5747\u8f6c\u6362\u4e3a\u4e00\u4e2aMetricFamilySamples.Sample\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u5305\u542b\u4e86\u8be5\u6837\u672c\u7684\u6307\u6807\u540d\u79f0\u3001\u6807\u7b7e\u540d\u6570\u7ec4\u3001\u6807\u7b7e\u503c\u6570\u7ec4\u4ee5\u53ca\u6837\u672c\u6570\u636e\u7684\u503c\u3002</p> <p>\u76d1\u63a7\u6307\u6807my_guage\u7684\u6240\u6709\u6837\u672c\u503c\uff0c\u9700\u8981\u6301\u4e45\u5316\u5230\u4e00\u4e2aMetricFamilySamples\u5b9e\u4f8b\u4e2d\uff0cMetricFamilySamples\u6307\u5b9a\u4e86\u5f53\u524d\u76d1\u63a7\u6307\u6807\u7684\u540d\u79f0\u3001\u7c7b\u578b\u3001\u6ce8\u91ca\u4fe1\u606f\u7b49\u3002\u9700\u8981\u6ce8\u610f\u7684\u662fMetricFamilySamples\u4e2d\u6240\u6709\u6837\u672c\u7684\u540d\u79f0\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4\uff0c\u5426\u5219\u751f\u6210\u7684\u6570\u636e\u5c06\u65e0\u6cd5\u7b26\u5408Prometheus\u7684\u89c4\u8303\u3002</p> <p>\u76f4\u63a5\u4f7f\u7528MetricFamilySamples.Sample\u548cMetricFamilySamples\u7684\u65b9\u5f0f\u9002\u7528\u4e8e\u5f53\u67d0\u76d1\u63a7\u6307\u6807\u7684\u6837\u672c\u4e4b\u95f4\u7684\u6807\u7b7e\u53ef\u80fd\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u4f8b\u5982\uff0c\u5f53\u76d1\u63a7\u5bb9\u5668\u65f6\uff0c\u4e0d\u540c\u5bb9\u5668\u5b9e\u4f8b\u53ef\u80fd\u5305\u542b\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u6807\u7b7e\uff0c\u5982\u679c\u9700\u8981\u5c06\u8fd9\u4e9b\u6807\u7b7e\u53cd\u5e94\u5230\u6837\u672c\u4e0a\uff0c\u90a3\u4e48\u6bcf\u4e2a\u6837\u672c\u7684\u6807\u7b7e\u5219\u4e0d\u53ef\u80fd\u4fdd\u6301\u4e00\u81f4\u3002\u800c\u5982\u679c\u6240\u6709\u6837\u672c\u7684\u662f\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528client_java\u9488\u5bf9\u4e0d\u540c\u6307\u6807\u7c7b\u578b\u7684\u5b9e\u73b0GaugeMetricFamily\uff0cCounterMetricFamily\uff0cSummaryMetricFamily\u7b49\uff0c\u4f8b\u5982\uff1a</p> <pre><code>class YourCustomCollector2 extends Collector {\n  List&lt;MetricFamilySamples&gt; collect() {\n    List&lt;MetricFamilySamples&gt; mfs = new ArrayList&lt;MetricFamilySamples&gt;();\n\n    // With no labels.\n    mfs.add(new GaugeMetricFamily(\"my_gauge_2\", \"help\", 42));\n\n    // With labels\n    GaugeMetricFamily labeledGauge = new GaugeMetricFamily(\"my_other_gauge\", \"help\", Arrays.asList(\"labelname\"));\n    labeledGauge.addMetric(Arrays.asList(\"foo\"), 4);\n    labeledGauge.addMetric(Arrays.asList(\"bar\"), 5);\n    mfs.add(labeledGauge);\n\n    return mfs;\n  }\n}\n</code></pre>"},{"location":"exporter/client_library_java/#http-server","title":"\u4f7f\u7528HTTP Server\u66b4\u9732\u6837\u672c\u6570\u636e","text":"<p>client_java\u4e0b\u7684simpleclient_httpserver\u6a21\u5757\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684HTTP\u670d\u52a1\u5668\uff0c\u5f53\u5411\u8be5\u670d\u52a1\u5668\u53d1\u9001\u83b7\u53d6\u6837\u672c\u6570\u636e\u7684\u8bf7\u6c42\u540e\uff0c\u5b83\u4f1a\u81ea\u52a8\u8c03\u7528\u6240\u6709Collector\u7684collect()\u65b9\u6cd5\uff0c\u5e76\u5c06\u6240\u6709\u6837\u672c\u6570\u636e\u8f6c\u6362\u4e3aPrometheus\u8981\u6c42\u7684\u6570\u636e\u8f93\u51fa\u683c\u5f0f\u89c4\u8303\u3002\u5982\u679c\u7528\u6237\u4f7f\u7528\u4e86Gradle\u6784\u5efa\u9879\u76ee\uff0c\u53ef\u4ee5\u6dfb\u52a0\u4ee5\u4e0b\u4f9d\u8d56\uff1a</p> <pre><code>compile 'io.prometheus:simpleclient_httpserver:0.3.0'\n</code></pre> <p>\u6dfb\u52a0\u4f9d\u8d56\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728Exporter\u7a0b\u5e8f\u7684main\u65b9\u6cd5\u4e2d\u542f\u52a8\u4e00\u4e2aHTTPServer\u5b9e\u4f8b\uff1a</p> <pre><code>public class CustomExporter {\n    public static void main(String[] args) throws IOException {\n        HTTPServer server = new HTTPServer(1234);\n    }\n}\n</code></pre> <p>\u800c\u5728\u542f\u52a8\u4e4b\u524d\uff0c\u522b\u5fd8\u8bb0\u8c03\u7528Collector\u7684register()\u65b9\u6cd5\u3002\u5426\u5219HTTPServer\u662f\u627e\u4e0d\u5230\u4efb\u4f55\u7684Collector\u5b9e\u4f8b\u7684\uff1a</p> <pre><code>new YourCustomCollector().register();\nnew YourCustomCollector2().register();\n</code></pre> <p>\u8fd0\u884cCustomExporter\u5e76\u8bbf\u95eehttp://127.0.0.1:1234/metrics\uff0c\u5373\u53ef\u83b7\u53d6\u5230\u4ee5\u4e0b\u6570\u636e\uff1a</p> <pre><code>$ curl http://127.0.0.1:1234/metrics\n# HELP my_gauge help\n# TYPE my_gauge gauge\nmy_gauge 42.0\n# HELP my_other_gauge help\n# TYPE my_other_gauge gauge\nmy_other_gauge{labelname=\"foo\",} 4.0\nmy_other_gauge{labelname=\"bar\",} 5.0\n# HELP my_guage help\n# TYPE my_guage gauge\nmy_guage{l1=\"v1\",} 4.0\nmy_guage{l1=\"v1\",l2=\"v2\",} 3.0\n</code></pre> <p>\u5f53\u7136HTTPServer\u4e2d\u5e76\u4e0d\u5b58\u5728\u4ec0\u4e48\u9ed1\u9b54\u6cd5\uff0c\u5176\u5185\u90e8\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5f53\u8c03\u7528Collector\u5b9e\u4f8bregister()\u65b9\u6cd5\u65f6\uff0c\u4f1a\u5c06\u8be5\u5b9e\u4f8b\u4fdd\u5b58\u5230CollectorRegistry\u5f53\u4e2d\uff0cCollectorRegistry\u8d1f\u8d23\u7ef4\u62a4\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u7684Collector\u5b9e\u4f8b\u3002 HTTPServer\u5728\u63a5\u6536\u5230HTTP\u8bf7\u6c42\u4e4b\u540e\uff0c\u4f1a\u4eceCollectorRegistry\u4e2d\u62ff\u5230\u6240\u6709\u7684Collector\u5b9e\u4f8b\uff0c\u5e76\u8c03\u7528\u5176collect()\u65b9\u6cd5\u83b7\u53d6\u6240\u6709\u6837\u672c\uff0c\u6700\u540e\u683c\u5f0f\u5316\u4e3aPrometheus\u7684\u6807\u51c6\u8f93\u51fa\u3002</p> <p>\u9664\u4e86\u76f4\u63a5\u4f7f\u7528HTTPServer\u4ee5\u5916\u66b4\u9732\u6837\u672c\u6570\u636e\u4ee5\u5916\uff0cclient_java\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u5bf9Spring Boot\u3001Spring Web\u4ee5\u53caServlet\u7684\u652f\u6301\u3002</p>"},{"location":"exporter/client_library_java/#collector_1","title":"\u4f7f\u7528\u5185\u7f6e\u7684Collector","text":"<p>\u901a\u8fc7client_java\u4e2d\u5b9a\u4e49\u7684\u6807\u51c6\u63a5\u53e3\uff0c\u7528\u6237\u53ef\u4ee5\u5feb\u901f\u5b9e\u73b0\u81ea\u5df1\u7684\u76d1\u63a7\u6570\u636e\u6536\u96c6\u5668\uff0c\u5e76\u901a\u8fc7HTTPServer\u5c06\u6837\u672c\u6570\u636e\u8f93\u51fa\u7ed9Prometheus\u3002\u9664\u4e86\u63d0\u4f9b\u63a5\u53e3\u89c4\u8303\u4ee5\u5916\uff0cclient_java\u8fd8\u63d0\u4f9b\u4e86\u591a\u4e2a\u5185\u7f6e\u7684Collector\u6a21\u5757\uff0c\u4ee5simpleclient_hotspot\u4e3a\u4f8b\uff0c\u8be5\u6a21\u5757\u4e2d\u5185\u7f6e\u4e86\u5bf9JVM\u865a\u62df\u673a\u8fd0\u884c\u72b6\u6001\uff08GC\uff0c\u5185\u5b58\u6c60\uff0cJMX\uff0c\u7c7b\u52a0\u8f7d\uff0c\u7ebf\u7a0b\u6c60\u7b49\uff09\u6570\u636e\u7684Collector\u5b9e\u73b0\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728Gradle\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u4f9d\u8d56\uff0c\u5bfc\u5165simpleclient_hotspot\uff1a</p> <pre><code>compile 'io.prometheus:simpleclient_hotspot:0.3.0'\n</code></pre> <p>\u901a\u8fc7\u8c03\u7528io.prometheus.client.hotspot.DefaultExport\u7684initialize\u65b9\u6cd5\u6ce8\u518c\u8be5\u6a21\u5757\u4e2d\u6240\u6709\u7684Collector\u5b9e\u4f8b\uff1a</p> <pre><code>DefaultExports.initialize();\n</code></pre> <p>\u91cd\u65b0\u8fd0\u884cCustomExporter\uff0c\u5e76\u83b7\u53d6\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>$ curl http://127.0.0.1:1234/metrics\n# HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.\n# TYPE jvm_buffer_pool_used_bytes gauge\njvm_buffer_pool_used_bytes{pool=\"direct\",} 8192.0\njvm_buffer_pool_used_bytes{pool=\"mapped\",} 0.0\n</code></pre> <p>\u9664\u4e86\u4e4b\u524d\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u4ee5\u5916\uff0c\u5728\u54cd\u5e94\u5185\u5bb9\u4e2d\u8fd8\u4f1a\u5f97\u5230\u5f53\u524dJVM\u7684\u8fd0\u884c\u72b6\u6001\u6570\u636e\u3002\u5728client_java\u9879\u76ee\u4e2d\u9664\u4e86\u4f7f\u7528\u5185\u7f6e\u4e86\u5bf9JVM\u76d1\u63a7\u7684Collector\u4ee5\u5916\uff0c\u8fd8\u5b9e\u73b0\u4e86\u5bf9Hibernate\uff0cGuava Cache\uff0cJetty\uff0cLog4j\u3001Logback\u7b49\u76d1\u63a7\u6570\u636e\u6536\u96c6\u7684\u652f\u6301\u3002\u7528\u6237\u53ea\u9700\u8981\u6dfb\u52a0\u76f8\u5e94\u7684\u4f9d\u8d56\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u8fdb\u884c\u4f7f\u7528\u3002</p>"},{"location":"exporter/client_library_java/#_1","title":"\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u8fdb\u884c\u76d1\u63a7\u57cb\u70b9","text":"<p>\u5728client_java\u4e2d\u9664\u4e86\u4f7f\u7528Collector\u76f4\u63a5\u91c7\u96c6\u6837\u672c\u6570\u636e\u4ee5\u5916\uff0c\u8fd8\u76f4\u63a5\u63d0\u4f9b\u4e86\u5bf9Prometheus\u4e2d4\u79cd\u76d1\u63a7\u7c7b\u578b\u7684\u5b9e\u73b0\u5206\u522b\u662f\uff1aCounter\u3001Gauge\u3001Summary\u548cHistogram\u3002 \u57fa\u4e8e\u8fd9\u4e9b\u5b9e\u73b0\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u4e1a\u52a1\u6d41\u7a0b\u4e2d\u8fdb\u884c\u76d1\u63a7\u57cb\u70b9\u3002</p>"},{"location":"exporter/client_library_java/#gaugecounter","title":"\u7b80\u5355\u7c7b\u578bGauge\u548cCounter","text":"<p>\u4ee5Gauge\u4e3a\u4f8b\uff0c\u5f53\u6211\u4eec\u9700\u8981\u76d1\u63a7\u67d0\u4e2a\u4e1a\u52a1\u5f53\u524d\u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u65b9\u5f0f\u5b9e\u73b0\uff1a</p> <pre><code>public class YourClass {\n\n    static final Gauge inprogressRequests = Gauge.build()\n            .name(\"inprogress_requests\").help(\"Inprogress requests.\").register();\n\n    void processRequest() {\n        inprogressRequests.inc();\n        // Your code here.\n        inprogressRequests.dec();\n    }\n\n}\n</code></pre> <p>Gauge\u7ee7\u627f\u81eaCollector\uff0cregistoer()\u65b9\u6cd5\u4f1a\u5c06\u8be5Gauge\u5b9e\u4f8b\u6ce8\u518c\u5230CollectorRegistry\u4e2d\u3002\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3ainprogress_requests\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5176\u6ce8\u91ca\u4fe1\u606f\u4e3a\"Inprogress requests\"\u3002</p> <p>Gauge\u5bf9\u8c61\u4e3b\u8981\u5305\u542b\u4e24\u4e2a\u65b9\u6cd5inc()\u548cdec()\uff0c\u5206\u522b\u7528\u4e8e\u8ba1\u6570\u5668+1\u548c-1\u3002</p> <p>\u5982\u679c\u76d1\u63a7\u6307\u6807\u4e2d\u8fd8\u9700\u8981\u5b9a\u4e49\u6807\u7b7e\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528Gauge\u6784\u9020\u5668\u7684labelNames()\u65b9\u6cd5\uff0c\u58f0\u660e\u76d1\u63a7\u6307\u6807\u7684\u6807\u7b7e\uff0c\u540c\u65f6\u5728\u6837\u672c\u8ba1\u6570\u65f6\uff0c\u901a\u8fc7\u6307\u6807\u7684labels()\u65b9\u6cd5\u6307\u5b9a\u6807\u7b7e\u7684\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>public class YourClass {\n\n    static final Gauge inprogressRequests = Gauge.build()\n            .name(\"inprogress_requests\")\n            .labelNames(\"method\")\n            .help(\"Inprogress requests.\").register();\n\n    void processRequest() {\n        inprogressRequests.labels(\"get\").inc();\n        // Your code here.\n        inprogressRequests.labels(\"get\").dec();\n    }\n\n}\n</code></pre> <p>Counter\u4e0eGauge\u7684\u4f7f\u7528\u65b9\u6cd5\u4e00\u81f4\uff0c\u552f\u4e00\u7684\u533a\u522b\u5728\u4e8eCounter\u5b9e\u4f8b\u53ea\u5305\u542b\u4e00\u4e2ainc()\u65b9\u6cd5\uff0c\u7528\u4e8e\u8ba1\u6570\u5668+1\u3002</p>"},{"location":"exporter/client_library_java/#summaryhistogram","title":"\u590d\u6742\u7c7b\u578bSummary\u548cHistogram","text":"<p>Summary\u548cHistogram\u7528\u4e8e\u7edf\u8ba1\u548c\u5206\u6790\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002\u5982\u4e0b\u6240\u793a\uff0c\u901a\u8fc7Summary\u53ef\u4ee5\u5c06HTTP\u8bf7\u6c42\u7684\u5b57\u8282\u6570\u4ee5\u53ca\u8bf7\u6c42\u5904\u7406\u65f6\u95f4\u4f5c\u4e3a\u7edf\u8ba1\u6837\u672c\uff0c\u76f4\u63a5\u7edf\u8ba1\u5176\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002</p> <pre><code>class YourClass {\n  static final Summary receivedBytes = Summary.build()\n     .name(\"requests_size_bytes\").help(\"Request size in bytes.\").register();\n  static final Summary requestLatency = Summary.build()\n     .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\").register();\n\n  void processRequest(Request req) {\n    Summary.Timer requestTimer = requestLatency.startTimer();\n    try {\n      // Your code here.\n    } finally {\n      receivedBytes.observe(req.size());\n      requestTimer.observeDuration();\n    }\n  }\n}\n</code></pre> <p>\u9664\u4e86\u4f7f\u7528Timer\u8fdb\u884c\u8ba1\u65f6\u4ee5\u5916\uff0cSummary\u5b9e\u4f8b\u4e5f\u63d0\u4f9b\u4e86timer()\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5bf9\u7ebf\u7a0b\u6216\u8005Lamda\u8868\u8fbe\u5f0f\u8fd0\u884c\u65f6\u95f4\u8fdb\u884c\u7edf\u8ba1\uff1a</p> <pre><code>class YourClass {\n  static final Summary requestLatency = Summary.build()\n    .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\").register();\n\n  void processRequest(Request req) {\n    requestLatency.timer(new Runnable() {\n      public abstract void run() {\n        // Your code here.    \n      }\n    });  \n\n    // Or the Java 8 lambda equivalent   \n    requestLatency.timer(() -&gt; {\n      // Your code here.\n    });\n  }\n}\n</code></pre> <p>Summary\u548cHistogram\u7684\u7528\u6cd5\u57fa\u672c\u4fdd\u6301\u4e00\u81f4\uff0c\u533a\u522b\u5728\u4e8eSummary\u53ef\u4ee5\u6307\u5b9a\u5728\u5ba2\u6237\u7aef\u7edf\u8ba1\u7684\u5206\u4f4d\u6570\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>static final Summary requestLatency = Summary.build()\n    .quantile(0.5, 0.05)   // \u5176\u4e2d0.05\u4e3a\u8bef\u5dee\n    .quantile(0.9, 0.01)   // \u5176\u4e2d0.01\u4e3a\u8bef\u5dee\n    .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\").register();\n</code></pre> <p>\u5bf9\u4e8eHistogram\u800c\u8a00\uff0c\u9ed8\u8ba4\u7684\u5206\u5e03\u6876\u4e3a[.005, .01, .025, .05, .075, .1, .25, .5, .75, 1, 2.5, 5, 7.5, 10]\uff0c\u5982\u679c\u9700\u8981\u6307\u5b9a\u81ea\u5b9a\u4e49\u7684\u6876\u5206\u5e03\uff0c\u53ef\u4ee5\u4f7f\u7528buckets()\u65b9\u6cd5\u6307\u5b9a\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code> static final Histogram requestLatency = Histogram.build()\n            .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\")\n            .buckets(0.1, 0.2, 0.4, 0.8)\n            .register();\n</code></pre>"},{"location":"exporter/client_library_java/#pushgateway","title":"\u4e0ePushGateway\u96c6\u6210","text":"<p>\u5bf9\u4e8e\u4e00\u4e9b\u77ed\u5468\u671f\u6216\u8005\u4e34\u65f6\u91c7\u96c6\u7684\u6837\u672c\u6570\u636e\uff0cclient_java\u8fd8\u63d0\u4f9b\u4e86\u5bf9PushGateway\u7684\u652f\u6301\uff1a</p> <p>\u6dfb\u52a0\u4f9d\u8d56\uff1a</p> <pre><code>compile 'io.prometheus:simpleclient_pushgateway:0.3.0'\n</code></pre> <p>\u5982\u4e0b\u6240\u793a\uff0cPushGateway\u7684\u5b9e\u73b0\u7c7b\u53ef\u4ee5\u4ece\u6240\u6709\u6ce8\u518c\u5230defaultRegistry\u7684Collector\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u6837\u672c\u6570\u636e\u5e76\u76f4\u63a5\u63a8\u9001  \u5230\u5916\u90e8\u90e8\u7f72\u7684PushGateway\u670d\u52a1\u4e2d\u3002</p> <pre><code>public class PushGatewayIntegration {\n\n    public void push() throws IOException {\n        CollectorRegistry registry = CollectorRegistry.defaultRegistry;\n        PushGateway pg = new PushGateway(\"127.0.0.1:9091\");\n        pg.pushAdd(registry, \"my_batch_job\");\n    }\n\n}\n</code></pre>"},{"location":"exporter/commonly-eporter-usage/","title":"\u5e38\u7528Exporter","text":"<p>\u5728\u7b2c1\u7ae0\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u521d\u6b65\u4e86\u89e3\u4e86Node Exporter\u7684\u4f7f\u7528\u573a\u666f\u548c\u65b9\u6cd5\u3002\u672c\u5c0f\u8282\uff0c\u5c06\u4f1a\u4ecb\u7ecd\u66f4\u591a\u5e38\u7528\u7684Exporter\u7528\u6cd5\u3002\u5305\u62ec\u5982\u4f55\u76d1\u63a7\u5bb9\u5668\u8fd0\u884c\u72b6\u6001\uff0c\u5982\u4f55\u76d1\u63a7\u548c\u8bc4\u4f30MySQL\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u6001\u4ee5\u53ca\u5982\u4f55\u901a\u8fc7Prometheus\u5b9e\u73b0\u57fa\u4e8e\u7f51\u7edc\u63a2\u6d4b\u7684\u9ed1\u76d2\u76d1\u63a7\u3002</p>"},{"location":"exporter/custom_app_support_prometheus/","title":"\u5728\u5e94\u7528\u4e2d\u5185\u7f6ePrometheus\u652f\u6301","text":"<p>\u672c\u5c0f\u8282\u5c06\u4ee5Spring Boot\u4e3a\u4f8b\uff0c\u4ecb\u7ecd\u5982\u4f55\u5728\u5e94\u7528\u4ee3\u7801\u4e2d\u96c6\u6210client_java\u3002</p> <p>\u6dfb\u52a0Prometheus Java Client\u76f8\u5173\u7684\u4f9d\u8d56\uff1a</p> <pre><code>dependencies {\n    compile 'io.prometheus:simpleclient:0.0.24'\n    compile \"io.prometheus:simpleclient_spring_boot:0.0.24\"\n    compile \"io.prometheus:simpleclient_hotspot:0.0.24\"\n}\n</code></pre> <p>\u901a\u8fc7\u6ce8\u89e3@EnablePrometheusEndpoint\u542f\u7528Prometheus Endpoint\uff0c\u8fd9\u91cc\u540c\u65f6\u4f7f\u7528\u4e86simpleclient_hotspot\u4e2d\u63d0\u4f9b\u7684DefaultExporter\u3002\u8be5Exporter\u4f1a\u5728metrics endpoint\u4e2d\u7edf\u8ba1\u5f53\u524d\u5e94\u7528JVM\u7684\u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>@SpringBootApplication\n@EnablePrometheusEndpoint\npublic class SpringApplication implements CommandLineRunner {\n\n    public static void main(String[] args) {\n        SpringApplication.run(GatewayApplication.class, args);\n    }\n\n    @Override\n    public void run(String... strings) throws Exception {\n        DefaultExports.initialize();\n    }\n}\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0bPrometheus\u66b4\u9732\u7684metrics endpoint\u4e3a /prometheus\uff0c\u53ef\u4ee5\u901a\u8fc7endpoint\u914d\u7f6e\u8fdb\u884c\u4fee\u6539:</p> <pre><code>endpoints:\n  prometheus:\n    id: metrics\n  metrics:\n    id: springmetrics\n    sensitive: false\n    enabled: true\n</code></pre> <p>\u542f\u52a8\u5e94\u7528\u7a0b\u5e8f\u8bbf\u95eehttp://localhost:8080/metrics\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\u5185\u5bb9\uff1a</p> <pre><code># HELP jvm_gc_collection_seconds Time spent in a given JVM garbage collector in seconds.\n# TYPE jvm_gc_collection_seconds summary\njvm_gc_collection_seconds_count{gc=\"PS Scavenge\",} 11.0\njvm_gc_collection_seconds_sum{gc=\"PS Scavenge\",} 0.18\njvm_gc_collection_seconds_count{gc=\"PS MarkSweep\",} 2.0\njvm_gc_collection_seconds_sum{gc=\"PS MarkSweep\",} 0.121\n# HELP jvm_classes_loaded The number of classes that are currently loaded in the JVM\n# TYPE jvm_classes_loaded gauge\njvm_classes_loaded 8376.0\n# HELP jvm_classes_loaded_total The total number of classes that have been loaded since the JVM has started execution\n# TYPE jvm_classes_loaded_total counter\n...\n</code></pre>"},{"location":"exporter/custom_app_support_prometheus/#_1","title":"\u6dfb\u52a0\u62e6\u622a\u5668\uff0c\u4e3a\u76d1\u63a7\u57cb\u70b9\u505a\u51c6\u5907","text":"<p>\u9664\u4e86\u83b7\u53d6\u5e94\u7528JVM\u76f8\u5173\u7684\u72b6\u6001\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u80fd\u9700\u8981\u6dfb\u52a0\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7Metrics\u5b9e\u73b0\u5bf9\u7cfb\u7edf\u6027\u80fd\uff0c\u4ee5\u53ca\u4e1a\u52a1\u72b6\u6001\u8fdb\u884c\u91c7\u96c6\uff0c\u4ee5\u63d0\u4f9b\u65e5\u540e\u4f18\u5316\u7684\u76f8\u5173\u652f\u6491\u6570\u636e\u3002\u9996\u5148\u6211\u4eec\u4f7f\u7528\u62e6\u622a\u5668\u5904\u7406\u5bf9\u5e94\u7528\u7684\u6240\u6709\u8bf7\u6c42\u3002</p> <p>\u7ee7\u627fWebMvcConfigurerAdapter\u7c7b\u5e76\u590d\u5199addInterceptors\u65b9\u6cd5\uff0c\u5bf9\u6240\u6709\u8bf7\u6c42/**\u6dfb\u52a0\u62e6\u622a\u5668</p> <pre><code>@SpringBootApplication\n@EnablePrometheusEndpoint\npublic class SpringApplication extends WebMvcConfigurerAdapter implements CommandLineRunner {\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(new PrometheusMetricsInterceptor()).addPathPatterns(\"/**\");\n    }\n}\n</code></pre> <p>PrometheusMetricsInterceptor\u7ee7\u627f\u81eaHandlerInterceptorAdapter\uff0c\u901a\u8fc7\u590d\u5199\u7236\u65b9\u6cd5preHandle\u548cafterCompletion\u53ef\u4ee5\u62e6\u622a\u4e00\u4e2aHTTP\u8bf7\u6c42\u751f\u547d\u5468\u671f\u7684\u4e0d\u540c\u9636\u6bb5\uff1a</p> <pre><code>public class PrometheusMetricsInterceptor extends HandlerInterceptorAdapter {\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        return super.preHandle(request, response, handler);\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        super.afterCompletion(request, response, handler, ex);\n    }\n}\n</code></pre>"},{"location":"exporter/custom_app_support_prometheus/#_2","title":"\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807","text":"<p>\u4e00\u65e6PrometheusMetricsInterceptor\u80fd\u591f\u6210\u529f\u62e6\u622a\u548c\u5904\u7406\u8bf7\u6c42\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528client java\u81ea\u5b9a\u4e49\u591a\u79cd\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u8ba1\u6570\u5668\u53ef\u4ee5\u7528\u4e8e\u8bb0\u5f55\u53ea\u4f1a\u589e\u52a0\u4e0d\u4f1a\u51cf\u5c11\u7684\u6307\u6807\u7c7b\u578b\uff0c\u6bd4\u5982\u8bb0\u5f55\u5e94\u7528\u8bf7\u6c42\u7684\u603b\u91cf(http_requests_total)\uff0ccpu\u4f7f\u7528\u65f6\u95f4(process_cpu_seconds_total)\u7b49\u3002 \u4e00\u822c\u800c\u8a00\uff0cCounter\u7c7b\u578b\u7684metrics\u6307\u6807\u5728\u547d\u540d\u4e2d\u6211\u4eec\u4f7f\u7528_total\u7ed3\u675f\u3002</p> <p>\u4f7f\u7528Counter.build()\u521b\u5efaCounter\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5e76\u4e14\u901a\u8fc7name()\u65b9\u6cd5\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u7684\u540d\u79f0\uff0c\u901a\u8fc7labelNames()\u5b9a\u4e49\u8be5\u6307\u6807\u5305\u542b\u7684\u6807\u7b7e\u3002\u6700\u540e\u901a\u8fc7register()\u5c06\u8be5\u6307\u6807\u6ce8\u518c\u5230Collector\u7684defaultRegistry\u4e2d\u4e2d\u3002</p> <pre><code>public class PrometheusMetricsInterceptor extends HandlerInterceptorAdapter {\n\n    static final Counter requestCounter = Counter.build()\n            .name(\"io_namespace_http_requests_total\").labelNames(\"path\", \"method\", \"code\")\n            .help(\"Total requests.\").register();\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        String requestURI = request.getRequestURI();\n        String method = request.getMethod();\n        int status = response.getStatus();\n\n        requestCounter.labels(requestURI, method, String.valueOf(status)).inc();\n        super.afterCompletion(request, response, handler, ex);\n    }\n}\n</code></pre> <p>\u5728afterCompletion\u65b9\u6cd5\u4e2d\uff0c\u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524d\u8bf7\u6c42\u7684\u8bf7\u6c42\u8def\u5f84\u3001\u8bf7\u6c42\u65b9\u6cd5\u4ee5\u53ca\u72b6\u6001\u7801\u3002 \u8fd9\u91cc\u901a\u8fc7labels\u6307\u5b9a\u4e86\u5f53\u524d\u6837\u672c\u5404\u4e2a\u6807\u7b7e\u5bf9\u5e94\u7684\u503c\uff0c\u6700\u540e\u901a\u8fc7.inc()\u8ba1\u6570\u5668+1\uff1a</p> <pre><code>requestCounter.labels(requestURI, method, String.valueOf(status)).inc();\n</code></pre> <p>\u901a\u8fc7\u6307\u6807io_namespace_http_requests_total\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\uff1a</p> <ul> <li>\u67e5\u8be2\u5e94\u7528\u7684\u8bf7\u6c42\u603b\u91cf</li> </ul> <pre><code># PromQL\nsum(io_namespace_http_requests_total)\n</code></pre> <ul> <li>\u67e5\u8be2\u6bcf\u79d2Http\u8bf7\u6c42\u91cf</li> </ul> <pre><code># PromQL\nsum(rate(io_wise2c_gateway_requests_total[5m]))\n</code></pre> <ul> <li>\u67e5\u8be2\u5f53\u524d\u5e94\u7528\u8bf7\u6c42\u91cfTop N\u7684URI</li> </ul> <pre><code># PromQL\ntopk(10, sum(io_namespace_http_requests_total) by (path))\n</code></pre> <p>\u4f7f\u7528Gauge\u53ef\u4ee5\u53cd\u6620\u5e94\u7528\u7684__\u5f53\u524d\u72b6\u6001__,\u4f8b\u5982\u5728\u76d1\u63a7\u4e3b\u673a\u65f6\uff0c\u4e3b\u673a\u5f53\u524d\u7a7a\u95f2\u7684\u5185\u5bb9\u5927\u5c0f(node_memory_MemFree)\uff0c\u53ef\u7528\u5185\u5b58\u5927\u5c0f(node_memory_MemAvailable)\u3002\u6216\u8005\u5bb9\u5668\u5f53\u524d\u7684CPU\u4f7f\u7528\u7387,\u5185\u5b58\u4f7f\u7528\u7387\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528Gauge\u8bb0\u5f55\u5f53\u524d\u5e94\u7528\u6b63\u5728\u5904\u7406\u7684Http\u8bf7\u6c42\u6570\u91cf\u3002</p> <pre><code>public class PrometheusMetricsInterceptor extends HandlerInterceptorAdapter {\n\n    ...\u7701\u7565\u7684\u4ee3\u7801\n    static final Gauge inprogressRequests = Gauge.build()\n            .name(\"io_namespace_http_inprogress_requests\").labelNames(\"path\", \"method\")\n            .help(\"Inprogress requests.\").register();\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        // \u8ba1\u6570\u5668+1\n        inprogressRequests.labels(requestURI, method).inc();\n        return super.preHandle(request, response, handler);\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        // \u8ba1\u6570\u5668-1\n        inprogressRequests.labels(requestURI, method).dec();\n\n        super.afterCompletion(request, response, handler, ex);\n    }\n}\n</code></pre> <p>\u901a\u8fc7\u6307\u6807io_namespace_http_inprogress_requests\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2\u5e94\u7528\u5f53\u524d\u6b63\u5728\u5904\u7406\u4e2d\u7684Http\u8bf7\u6c42\u6570\u91cf\uff1a</p> <pre><code># PromQL\nio_namespace_http_inprogress_requests{}\n</code></pre> <p>Histogram\u4e3b\u8981\u7528\u4e8e\u5728\u6307\u5b9a\u5206\u5e03\u8303\u56f4\u5185(Buckets)\u8bb0\u5f55\u5927\u5c0f(\u5982http request bytes)\u6216\u8005\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\u3002\u4ee5\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4requests_latency_seconds\u4e3a\u4f8b\u3002</p> <pre><code>public class PrometheusMetricsInterceptor extends HandlerInterceptorAdapter {\n\n    static final Histogram requestLatencyHistogram = Histogram.build().labelNames(\"path\", \"method\", \"code\")\n            .name(\"io_namespace_http_requests_latency_seconds_histogram\").help(\"Request latency in seconds.\")\n            .register();\n\n    private Histogram.Timer histogramRequestTimer;\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        histogramRequestTimer = requestLatencyHistogram.labels(requestURI, method, String.valueOf(status)).startTimer();\n        ...\u7701\u7565\u7684\u4ee3\u7801\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        histogramRequestTimer.observeDuration();\n        ...\u7701\u7565\u7684\u4ee3\u7801\n    }\n}\n</code></pre> <p>Histogram\u4f1a\u81ea\u52a8\u521b\u5efa3\u4e2a\u6307\u6807\uff0c\u5206\u522b\u4e3a\uff1a</p> <ul> <li>\u4e8b\u4ef6\u53d1\u751f\u603b\u6b21\u6570\uff1a basename_count</li> </ul> <pre><code># \u5b9e\u9645\u542b\u4e49\uff1a \u5f53\u524d\u4e00\u5171\u53d1\u751f\u4e862\u6b21http\u8bf7\u6c42\nio_namespace_http_requests_latency_seconds_histogram_count{path=\"/\",method=\"GET\",code=\"200\",} 2.0\n</code></pre> <ul> <li>\u6240\u6709\u4e8b\u4ef6\u4ea7\u751f\u503c\u7684\u5927\u5c0f\u7684\u603b\u548c\uff1a basename_sum</li> </ul> <pre><code># \u5b9e\u9645\u542b\u4e49\uff1a \u53d1\u751f\u76842\u6b21http\u8bf7\u6c42\u603b\u7684\u54cd\u5e94\u65f6\u95f4\u4e3a13.107670803000001 \u79d2\nio_namespace_http_requests_latency_seconds_histogram_sum{path=\"/\",method=\"GET\",code=\"200\",} 13.107670803000001\n</code></pre> <ul> <li>\u4e8b\u4ef6\u4ea7\u751f\u7684\u503c\u5206\u5e03\u5728bucket\u4e2d\u7684\u6b21\u6570\uff1a basename_bucket{le=\"\u4e0a\u5305\u542b\"}</li> </ul> <pre><code># \u5728\u603b\u51712\u6b21\u8bf7\u6c42\u5f53\u4e2d\u3002http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4 &lt;=0.005 \u79d2 \u7684\u8bf7\u6c42\u6b21\u6570\u4e3a0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.005\",} 0.0\n# \u5728\u603b\u51712\u6b21\u8bf7\u6c42\u5f53\u4e2d\u3002http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4 &lt;=0.01 \u79d2 \u7684\u8bf7\u6c42\u6b21\u6570\u4e3a0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.01\",} 0.0\n# \u5728\u603b\u51712\u6b21\u8bf7\u6c42\u5f53\u4e2d\u3002http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4 &lt;=0.025 \u79d2 \u7684\u8bf7\u6c42\u6b21\u6570\u4e3a0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.025\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.05\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.075\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.1\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.25\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.5\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"0.75\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"1.0\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"2.5\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"5.0\",} 0.0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"7.5\",} 2.0\n# \u5728\u603b\u51712\u6b21\u8bf7\u6c42\u5f53\u4e2d\u3002http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4 &lt;=10 \u79d2 \u7684\u8bf7\u6c42\u6b21\u6570\u4e3a0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"10.0\",} 2.0\n# \u5728\u603b\u51712\u6b21\u8bf7\u6c42\u5f53\u4e2d\u3002http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4 10 \u79d2 \u7684\u8bf7\u6c42\u6b21\u6570\u4e3a0\nio_namespace_http_requests_latency_seconds_histogram_bucket{path=\"/\",method=\"GET\",code=\"200\",le=\"+Inf\",} 2.0\n</code></pre> <p>Summary\u548cHistogram\u975e\u5e38\u7c7b\u578b\u76f8\u4f3c\uff0c\u90fd\u53ef\u4ee5\u7edf\u8ba1\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\u6216\u8005\u53d1\u5c0f\uff0c\u4ee5\u53ca\u5176\u5206\u5e03\u60c5\u51b5\u3002Summary\u548cHistogram\u90fd\u63d0\u4f9b\u4e86\u5bf9\u4e8e\u4e8b\u4ef6\u7684\u8ba1\u6570_count\u4ee5\u53ca\u503c\u7684\u6c47\u603b_sum\u3002 \u56e0\u6b64\u4f7f\u7528_count,\u548c_sum\u65f6\u95f4\u5e8f\u5217\u53ef\u4ee5\u8ba1\u7b97\u51fa\u76f8\u540c\u7684\u5185\u5bb9\uff0c\u4f8b\u5982http\u6bcf\u79d2\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\uff1arate(basename_sum[5m]) / rate(basename_count[5m])\u3002\u540c\u65f6Summary\u548cHistogram\u90fd\u53ef\u4ee5\u8ba1\u7b97\u548c\u7edf\u8ba1\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u6bd4\u5982\u4e2d\u4f4d\u6570\uff0c9\u5206\u4f4d\u6570\u7b49\u7b49\u3002\u5176\u4e2d 0.0&lt;= \u5206\u4f4d\u6570Quantiles &lt;= 1.0\u3002</p> <p>\u4e0d\u540c\u5728\u4e8eHistogram\u53ef\u4ee5\u901a\u8fc7histogram_quantile\u51fd\u6570\u5728\u670d\u52a1\u5668\u7aef\u8ba1\u7b97\u5206\u4f4d\u6570\uff0c\u800cSumamry\u7684\u5206\u4f4d\u6570\u5219\u662f\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u8fdb\u884c\u5b9a\u4e49\u3002\u56e0\u6b64\u5bf9\u4e8e\u5206\u4f4d\u6570\u7684\u8ba1\u7b97\u3002 Summary\u5728\u901a\u8fc7PromQL\u8fdb\u884c\u67e5\u8be2\u65f6\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\uff0c\u800cHistogram\u5219\u4f1a\u6d88\u8017\u66f4\u591a\u7684\u8d44\u6e90\u3002\u76f8\u5bf9\u7684\u5bf9\u4e8e\u5ba2\u6237\u7aef\u800c\u8a00Histogram\u6d88\u8017\u7684\u8d44\u6e90\u66f4\u5c11\u3002</p> <pre><code>public class PrometheusMetricsInterceptor extends HandlerInterceptorAdapter {\n\n    static final Summary requestLatency = Summary.build()\n            .name(\"io_namespace_http_requests_latency_seconds_summary\")\n            .quantile(0.5, 0.05)\n            .quantile(0.9, 0.01)\n            .labelNames(\"path\", \"method\", \"code\")\n            .help(\"Request latency in seconds.\").register();\n\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        requestTimer = requestLatency.labels(requestURI, method, String.valueOf(status)).startTimer();\n        ...\u7701\u7565\u7684\u4ee3\u7801\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        requestTimer.observeDuration();\n        ...\u7701\u7565\u7684\u4ee3\u7801\n    }\n}\n</code></pre> <p>\u4f7f\u7528Summary\u6307\u6807\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\uff1a</p> <ul> <li>\u4e8b\u4ef6\u53d1\u751f\u603b\u7684\u6b21\u6570</li> </ul> <pre><code># \u542b\u4e49\uff1a\u5f53\u524dhttp\u8bf7\u6c42\u53d1\u751f\u603b\u6b21\u6570\u4e3a12\u6b21\nio_namespace_http_requests_latency_seconds_summary_count{path=\"/\",method=\"GET\",code=\"200\",} 12.0\n</code></pre> <ul> <li>\u4e8b\u4ef6\u4ea7\u751f\u7684\u503c\u7684\u603b\u548c</li> </ul> <pre><code># \u542b\u4e49\uff1a\u8fd912\u6b21http\u8bf7\u6c42\u7684\u603b\u54cd\u5e94\u65f6\u95f4\u4e3a 51.029495508s\nio_namespace_http_requests_latency_seconds_summary_sum{path=\"/\",method=\"GET\",code=\"200\",} 51.029495508\n</code></pre> <ul> <li>\u4e8b\u4ef6\u4ea7\u751f\u7684\u503c\u7684\u5206\u5e03\u60c5\u51b5</li> </ul> <pre><code># \u542b\u4e49\uff1a\u8fd912\u6b21http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4\u7684\u4e2d\u4f4d\u6570\u662f3.052404983s\nio_namespace_http_requests_latency_seconds_summary{path=\"/\",method=\"GET\",code=\"200\",quantile=\"0.5\",} 3.052404983\n# \u542b\u4e49\uff1a\u8fd912\u6b21http\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4\u76849\u5206\u4f4d\u6570\u662f8.003261666s\nio_namespace_http_requests_latency_seconds_summary{path=\"/\",method=\"GET\",code=\"200\",quantile=\"0.9\",} 8.003261666\n</code></pre>"},{"location":"exporter/custom_app_support_prometheus/#collector","title":"\u4f7f\u7528Collector\u66b4\u9732\u5176\u5b83\u6307\u6807","text":"<p>\u9664\u4e86\u5728\u62e6\u622a\u5668\u4e2d\u4f7f\u7528Prometheus\u63d0\u4f9b\u7684Counter,Summary,Gauage\u7b49\u6784\u9020\u76d1\u63a7\u6307\u6807\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684Collector\u5b9e\u73b0\u5bf9\u76f8\u5173\u4e1a\u52a1\u6307\u6807\u7684\u66b4\u9732\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49Collector\u76f4\u63a5\u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u6570\u636e\u5e93\u4e2d\u7edf\u8ba1\u76d1\u63a7\u6307\u6807.</p> <pre><code>@SpringBootApplication\n@EnablePrometheusEndpoint\npublic class SpringApplication extends WebMvcConfigurerAdapter implements CommandLineRunner {\n\n    @Autowired\n    private CustomExporter customExporter;\n\n    ...\u7701\u7565\u7684\u4ee3\u7801\n\n    @Override\n    public void run(String... args) throws Exception {\n        ...\u7701\u7565\u7684\u4ee3\u7801\n        customExporter.register();\n    }\n}\n</code></pre> <p>CustomExporter\u7ee7\u627f\u81eaio.prometheus.client.Collector\uff0c\u5728\u8c03\u7528Collector\u7684register()\u65b9\u6cd5\u540e\uff0c\u5f53\u8bbf\u95ee/metrics\u65f6\uff0c\u5219\u4f1a\u81ea\u52a8\u4eceCollector\u7684collection()\u65b9\u6cd5\u4e2d\u83b7\u53d6\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u7531\u4e8e\u8fd9\u91ccCustomExporter\u5b58\u5728\u4e8eSpring\u7684IOC\u5bb9\u5668\u5f53\u4e2d\uff0c\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u4e1a\u52a1\u4ee3\u7801\uff0c\u8fd4\u56de\u9700\u8981\u7684\u4e1a\u52a1\u76f8\u5173\u7684\u6307\u6807\u3002</p> <pre><code>import io.prometheus.client.Collector;\nimport io.prometheus.client.GaugeMetricFamily;\nimport org.springframework.stereotype.Component;\n\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.List;\n\n@Component\npublic class CustomExporter extends Collector {\n    @Override\n    public List&lt;MetricFamilySamples&gt; collect() {\n        List&lt;MetricFamilySamples&gt; mfs = new ArrayList&lt;&gt;();\n\n        # \u521b\u5efametrics\u6307\u6807\n        GaugeMetricFamily labeledGauge =\n                new GaugeMetricFamily(\"io_namespace_custom_metrics\", \"custom metrics\", Collections.singletonList(\"labelname\"));\n\n        # \u8bbe\u7f6e\u6307\u6807\u7684label\u4ee5\u53cavalue\n        labeledGauge.addMetric(Collections.singletonList(\"labelvalue\"), 1);\n\n        mfs.add(labeledGauge);\n        return mfs;\n    }\n}\n</code></pre> <p>\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4f7f\u7528CounterMetricFamily\uff0cSummaryMetricFamily\u58f0\u660e\u5176\u5b83\u7684\u6307\u6807\u7c7b\u578b\u3002</p>"},{"location":"exporter/custom_exporter_with_java/","title":"\u4f7f\u7528Java\u81ea\u5b9a\u4e49Exporter","text":"<p>\u672c\u5c0f\u8282\u5c06\u5e26\u9886\u8bfb\u8005\u4e86\u89e3Promrtheus\u63d0\u4f9b\u7684client_java\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u5e76\u4e14\u5728\u6700\u540e\u5728Spring Boot\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f7f\u7528client_java\uff0c\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u5c42\u9762\u63d0\u4f9b\u5bf9Prometheus\u7684\u652f\u6301\u3002</p>"},{"location":"exporter/install_blackbox_exporter/","title":"\u7f51\u7edc\u63a2\u6d4b\uff1aBlackbox Exporter","text":"<p>\u5728\u672c\u7ae0\u7684\u524d\u51e0\u4e2a\u5c0f\u8282\u4e2d\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecd\u4e86Prometheus\u4e0b\u5982\u4f55\u8fdb\u884c\u767d\u76d2\u76d1\u63a7\uff0c\u6211\u4eec\u76d1\u63a7\u4e3b\u673a\u7684\u8d44\u6e90\u7528\u91cf\u3001\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\u3001\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u7684\u8fd0\u884c\u6570\u636e\u3002 \u8fd9\u4e9b\u90fd\u662f\u652f\u6301\u4e1a\u52a1\u548c\u670d\u52a1\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u901a\u8fc7\u767d\u76d2\u80fd\u591f\u4e86\u89e3\u5176\u5185\u90e8\u7684\u5b9e\u9645\u8fd0\u884c\u72b6\u6001\uff0c\u901a\u8fc7\u5bf9\u76d1\u63a7\u6307\u6807\u7684\u89c2\u5bdf\u80fd\u591f\u9884\u5224\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u4ece\u800c\u5bf9\u6f5c\u5728\u7684\u4e0d\u786e\u5b9a\u56e0\u7d20\u8fdb\u884c\u4f18\u5316\u3002\u800c\u4ece\u5b8c\u6574\u7684\u76d1\u63a7\u903b\u8f91\u7684\u89d2\u5ea6\uff0c\u9664\u4e86\u5927\u91cf\u7684\u5e94\u7528\u767d\u76d2\u76d1\u63a7\u4ee5\u5916\uff0c\u8fd8\u5e94\u8be5\u6dfb\u52a0\u9002\u5f53\u7684\u9ed1\u76d2\u76d1\u63a7\u3002\u9ed1\u76d2\u76d1\u63a7\u5373\u4ee5\u7528\u6237\u7684\u8eab\u4efd\u6d4b\u8bd5\u670d\u52a1\u7684\u5916\u90e8\u53ef\u89c1\u6027\uff0c\u5e38\u89c1\u7684\u9ed1\u76d2\u76d1\u63a7\u5305\u62ecHTTP\u63a2\u9488\u3001TCP\u63a2\u9488\u7b49\u7528\u4e8e\u68c0\u6d4b\u7ad9\u70b9\u6216\u8005\u670d\u52a1\u7684\u53ef\u8bbf\u95ee\u6027\uff0c\u4ee5\u53ca\u8bbf\u95ee\u6548\u7387\u7b49\u3002</p> <p>\u9ed1\u76d2\u76d1\u63a7\u76f8\u8f83\u4e8e\u767d\u76d2\u76d1\u63a7\u6700\u5927\u7684\u4e0d\u540c\u5728\u4e8e\u9ed1\u76d2\u76d1\u63a7\u662f\u4ee5\u6545\u969c\u4e3a\u5bfc\u5411\u5f53\u6545\u969c\u53d1\u751f\u65f6\uff0c\u9ed1\u76d2\u76d1\u63a7\u80fd\u5feb\u901f\u53d1\u73b0\u6545\u969c\uff0c\u800c\u767d\u76d2\u76d1\u63a7\u5219\u4fa7\u91cd\u4e8e\u4e3b\u52a8\u53d1\u73b0\u6216\u8005\u9884\u6d4b\u6f5c\u5728\u7684\u95ee\u9898\u3002\u4e00\u4e2a\u5b8c\u5584\u7684\u76d1\u63a7\u76ee\u6807\u662f\u8981\u80fd\u591f\u4ece\u767d\u76d2\u7684\u89d2\u5ea6\u53d1\u73b0\u6f5c\u5728\u95ee\u9898\uff0c\u80fd\u591f\u5728\u9ed1\u76d2\u7684\u89d2\u5ea6\u5feb\u901f\u53d1\u73b0\u5df2\u7ecf\u53d1\u751f\u7684\u95ee\u9898\u3002</p> <p></p>"},{"location":"exporter/install_blackbox_exporter/#blackbox-exporter_1","title":"\u4f7f\u7528Blackbox Exporter","text":"<p>Blackbox Exporter\u662fPrometheus\u793e\u533a\u63d0\u4f9b\u7684\u5b98\u65b9\u9ed1\u76d2\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5141\u8bb8\u7528\u6237\u901a\u8fc7\uff1aHTTP\u3001HTTPS\u3001DNS\u3001TCP\u4ee5\u53caICMP\u7684\u65b9\u5f0f\u5bf9\u7f51\u7edc\u8fdb\u884c\u63a2\u6d4b\u3002\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528go get\u547d\u4ee4\u83b7\u53d6Blackbox Exporter\u6e90\u7801\u5e76\u751f\u6210\u672c\u5730\u53ef\u6267\u884c\u6587\u4ef6\uff1a</p> <pre><code>go get prometheus/blackbox_exporter\n</code></pre> <p>\u8fd0\u884cBlackbox Exporter\u65f6\uff0c\u9700\u8981\u7528\u6237\u63d0\u4f9b\u63a2\u9488\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u53ef\u80fd\u662f\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684HTTP\u5934\u4fe1\u606f\uff0c\u4e5f\u53ef\u80fd\u662f\u63a2\u6d4b\u65f6\u9700\u8981\u7684\u4e00\u4e9bTSL\u914d\u7f6e\uff0c\u4e5f\u53ef\u80fd\u662f\u63a2\u9488\u672c\u8eab\u7684\u9a8c\u8bc1\u884c\u4e3a\u3002\u5728Blackbox Exporter\u6bcf\u4e00\u4e2a\u63a2\u9488\u914d\u7f6e\u79f0\u4e3a\u4e00\u4e2amodule\uff0c\u5e76\u4e14\u4ee5YAML\u914d\u7f6e\u6587\u4ef6\u7684\u5f62\u5f0f\u63d0\u4f9b\u7ed9Blackbox Exporter\u3002 \u6bcf\u4e00\u4e2amodule\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u914d\u7f6e\u5185\u5bb9\uff0c\u5305\u62ec\u63a2\u9488\u7c7b\u578b\uff08prober\uff09\u3001\u9a8c\u8bc1\u8bbf\u95ee\u8d85\u65f6\u65f6\u95f4\uff08timeout\uff09\u3001\u4ee5\u53ca\u5f53\u524d\u63a2\u9488\u7684\u5177\u4f53\u914d\u7f6e\u9879\uff1a</p> <pre><code>  # \u63a2\u9488\u7c7b\u578b\uff1ahttp\u3001 tcp\u3001 dns\u3001 icmp.\n  prober: &lt;prober_string&gt;\n\n  # \u8d85\u65f6\u65f6\u95f4\n  [ timeout: &lt;duration&gt; ]\n\n  # \u63a2\u9488\u7684\u8be6\u7ec6\u914d\u7f6e\uff0c\u6700\u591a\u53ea\u80fd\u914d\u7f6e\u5176\u4e2d\u7684\u4e00\u4e2a\n  [ http: &lt;http_probe&gt; ]\n  [ tcp: &lt;tcp_probe&gt; ]\n  [ dns: &lt;dns_probe&gt; ]\n  [ icmp: &lt;icmp_probe&gt; ]\n</code></pre> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u63a2\u9488\u914d\u7f6e\u6587\u4ef6blockbox.yml\uff0c\u5305\u542b\u4e24\u4e2aHTTP\u63a2\u9488\u914d\u7f6e\u9879\uff1a</p> <pre><code>modules:\n  http_2xx:\n    prober: http\n    http:\n      method: GET\n  http_post_2xx:\n    prober: http\n    http:\n      method: POST\n</code></pre> <p>\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5e76\u6307\u5b9a\u4f7f\u7528\u7684\u63a2\u9488\u914d\u7f6e\u6587\u4ef6\u542f\u52a8Blockbox Exporter\u5b9e\u4f8b\uff1a</p> <pre><code>blackbox_exporter --config.file=/etc/prometheus/blackbox.yml\n</code></pre> <p>\u542f\u52a8\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95eehttp://127.0.0.1:9115/probe?module=http_2xx&amp;target=baidu.com\u5bf9baidu.com\u8fdb\u884c\u63a2\u6d4b\u3002\u8fd9\u91cc\u901a\u8fc7\u5728URL\u4e2d\u63d0\u4f9bmodule\u53c2\u6570\u6307\u5b9a\u4e86\u5f53\u524d\u4f7f\u7528\u7684\u63a2\u9488\uff0ctarget\u53c2\u6570\u6307\u5b9a\u63a2\u6d4b\u76ee\u6807\uff0c\u63a2\u9488\u7684\u63a2\u6d4b\u7ed3\u679c\u901a\u8fc7Metrics\u7684\u5f62\u5f0f\u8fd4\u56de\uff1a</p> <pre><code># HELP probe_dns_lookup_time_seconds Returns the time taken for probe dns lookup in seconds\n# TYPE probe_dns_lookup_time_seconds gauge\nprobe_dns_lookup_time_seconds 0.011633673\n# HELP probe_duration_seconds Returns how long the probe took to complete in seconds\n# TYPE probe_duration_seconds gauge\nprobe_duration_seconds 0.117332275\n# HELP probe_failed_due_to_regex Indicates if probe failed due to regex\n# TYPE probe_failed_due_to_regex gauge\nprobe_failed_due_to_regex 0\n# HELP probe_http_content_length Length of http content response\n# TYPE probe_http_content_length gauge\nprobe_http_content_length 81\n# HELP probe_http_duration_seconds Duration of http request by phase, summed over all redirects\n# TYPE probe_http_duration_seconds gauge\nprobe_http_duration_seconds{phase=\"connect\"} 0.055551141\nprobe_http_duration_seconds{phase=\"processing\"} 0.049736019\nprobe_http_duration_seconds{phase=\"resolve\"} 0.011633673\nprobe_http_duration_seconds{phase=\"tls\"} 0\nprobe_http_duration_seconds{phase=\"transfer\"} 3.8919e-05\n# HELP probe_http_redirects The number of redirects\n# TYPE probe_http_redirects gauge\nprobe_http_redirects 0\n# HELP probe_http_ssl Indicates if SSL was used for the final redirect\n# TYPE probe_http_ssl gauge\nprobe_http_ssl 0\n# HELP probe_http_status_code Response HTTP status code\n# TYPE probe_http_status_code gauge\nprobe_http_status_code 200\n# HELP probe_http_version Returns the version of HTTP of the probe response\n# TYPE probe_http_version gauge\nprobe_http_version 1.1\n# HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6\n# TYPE probe_ip_protocol gauge\nprobe_ip_protocol 4\n# HELP probe_success Displays whether or not the probe was a success\n# TYPE probe_success gauge\nprobe_success 1\n</code></pre> <p>\u4ece\u8fd4\u56de\u7684\u6837\u672c\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u83b7\u53d6\u7ad9\u70b9\u7684DNS\u89e3\u6790\u8017\u65f6\u3001\u7ad9\u70b9\u54cd\u5e94\u65f6\u95f4\u3001HTTP\u54cd\u5e94\u72b6\u6001\u7801\u7b49\u7b49\u548c\u7ad9\u70b9\u8bbf\u95ee\u8d28\u91cf\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\uff0c\u4ece\u800c\u5e2e\u52a9\u7ba1\u7406\u5458\u4e3b\u52a8\u7684\u53d1\u73b0\u6545\u969c\u548c\u95ee\u9898\u3002</p>"},{"location":"exporter/install_blackbox_exporter/#prometheus","title":"\u4e0ePrometheus\u96c6\u6210","text":"<p>\u63a5\u4e0b\u6765\uff0c\u53ea\u9700\u8981\u5728Prometheus\u4e0b\u914d\u7f6e\u5bf9Blockbox Exporter\u5b9e\u4f8b\u7684\u91c7\u96c6\u4efb\u52a1\u5373\u53ef\u3002\u6700\u76f4\u89c2\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a</p> <pre><code>- job_name: baidu_http2xx_probe\n  params:\n    module:\n    - http_2xx\n    target:\n    - baidu.com\n  metrics_path: /probe\n  static_configs:\n  - targets:\n    - 127.0.0.1:9115\n- job_name: prometheus_http2xx_probe\n  params:\n    module:\n    - http_2xx\n    target:\n    - prometheus.io\n  metrics_path: /probe\n  static_configs:\n  - targets:\n    - 127.0.0.1:9115\n</code></pre> <p>\u8fd9\u91cc\u5206\u522b\u914d\u7f6e\u4e86\u540d\u4e3abaidu_http2x_probe\u548cprometheus_http2xx_probe\u7684\u91c7\u96c6\u4efb\u52a1\uff0c\u5e76\u4e14\u901a\u8fc7params\u6307\u5b9a\u4f7f\u7528\u7684\u63a2\u9488\uff08module\uff09\u4ee5\u53ca\u63a2\u6d4b\u76ee\u6807\uff08target\uff09\u3002</p> <p>\u90a3\u95ee\u9898\u5c31\u6765\u4e86\uff0c\u5047\u5982\u6211\u4eec\u6709N\u4e2a\u76ee\u6807\u7ad9\u70b9\u4e14\u90fd\u9700\u8981M\u79cd\u63a2\u6d4b\u65b9\u5f0f\uff0c\u90a3\u4e48Prometheus\u4e2d\u5c06\u5305\u542bN * M\u4e2a\u91c7\u96c6\u4efb\u52a1\uff0c\u4ece\u914d\u7f6e\u7ba1\u7406\u7684\u89d2\u5ea6\u6765\u8bf4\u663e\u7136\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002 \u5728\u7b2c7\u7ae0\u7684\u201c\u670d\u52a1\u53d1\u73b0\u4e0eRelabel\u201d\u5c0f\u8282\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u7684Relabeling\u80fd\u529b\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u53ef\u4ee5\u91c7\u7528Relabling\u7684\u65b9\u5f0f\u5bf9\u8fd9\u4e9b\u914d\u7f6e\u8fdb\u884c\u7b80\u5316\uff0c\u914d\u7f6e\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>scrape_configs:\n  - job_name: 'blackbox'\n    metrics_path: /probe\n    params:\n      module: [http_2xx]\n    static_configs:\n      - targets:\n        - http://prometheus.io    # Target to probe with http.\n        - https://prometheus.io   # Target to probe with https.\n        - http://example.com:8080 # Target to probe with http on port 8080.\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 127.0.0.1:9115\n</code></pre> <p>\u8fd9\u91cc\u9488\u5bf9\u6bcf\u4e00\u4e2a\u63a2\u9488\u670d\u52a1\uff08\u5982http_2xx\uff09\u5b9a\u4e49\u4e00\u4e2a\u91c7\u96c6\u4efb\u52a1\uff0c\u5e76\u4e14\u76f4\u63a5\u5c06\u4efb\u52a1\u7684\u91c7\u96c6\u76ee\u6807\u5b9a\u4e49\u4e3a\u6211\u4eec\u9700\u8981\u63a2\u6d4b\u7684\u7ad9\u70b9\u3002\u5728\u91c7\u96c6\u6837\u672c\u6570\u636e\u4e4b\u524d\u901a\u8fc7relabel_configs\u5bf9\u91c7\u96c6\u4efb\u52a1\u8fdb\u884c\u52a8\u6001\u8bbe\u7f6e\u3002 </p> <ul> <li>\u7b2c1\u6b65\uff0c\u6839\u636eTarget\u5b9e\u4f8b\u7684\u5730\u5740\uff0c\u5199\u5165<code>__param_target</code>\u6807\u7b7e\u4e2d\u3002<code>__param_&lt;name&gt;</code>\u5f62\u5f0f\u7684\u6807\u7b7e\u8868\u793a\uff0c\u5728\u91c7\u96c6\u4efb\u52a1\u65f6\u4f1a\u5728\u8bf7\u6c42\u76ee\u6807\u5730\u5740\u4e2d\u6dfb\u52a0<code>&lt;name&gt;</code>\u53c2\u6570\uff0c\u7b49\u540c\u4e8eparams\u7684\u8bbe\u7f6e\uff1b</li> <li>\u7b2c2\u6b65\uff0c\u83b7\u53d6__param_target\u7684\u503c\uff0c\u5e76\u590d\u5199\u5230instance\u6807\u7b7e\u4e2d\uff1b</li> <li>\u7b2c3\u6b65\uff0c\u590d\u5199Target\u5b9e\u4f8b\u7684<code>__address__</code>\u6807\u7b7e\u503c\u4e3aBlockBox Exporter\u5b9e\u4f8b\u7684\u8bbf\u95ee\u5730\u5740\u3002</li> </ul> <p>\u901a\u8fc7\u4ee5\u4e0a3\u4e2arelabel\u6b65\u9aa4\uff0c\u5373\u53ef\u5927\u5927\u7b80\u5316Prometheus\u4efb\u52a1\u914d\u7f6e\u7684\u590d\u6742\u5ea6:</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u8be6\u7ec6\u4ecb\u7ecdBlackbox\u4e2d\u5e38\u7528\u7684HTTP\u63a2\u9488\u4f7f\u7528\u65b9\u5f0f</p>"},{"location":"exporter/install_blackbox_exporter/#http","title":"HTTP\u63a2\u9488","text":"<p>HTTP\u63a2\u9488\u662f\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7\u65f6\u6700\u5e38\u7528\u7684\u63a2\u9488\u4e4b\u4e00\uff0c\u901a\u8fc7HTTP\u63a2\u9488\u80fd\u591f\u7f51\u7ad9\u6216\u8005HTTP\u670d\u52a1\u5efa\u7acb\u6709\u6548\u7684\u76d1\u63a7\uff0c\u5305\u62ec\u5176\u672c\u8eab\u7684\u53ef\u7528\u6027\uff0c\u4ee5\u53ca\u7528\u6237\u4f53\u9a8c\u76f8\u5173\u7684\u5982\u54cd\u5e94\u65f6\u95f4\u7b49\u7b49\u3002\u9664\u4e86\u80fd\u591f\u5728\u670d\u52a1\u51fa\u73b0\u5f02\u5e38\u7684\u65f6\u5019\u53ca\u65f6\u62a5\u8b66\uff0c\u8fd8\u80fd\u5e2e\u52a9\u7cfb\u7edf\u7ba1\u7406\u5458\u5206\u6790\u548c\u4f18\u5316\u7f51\u7ad9\u4f53\u9a8c\u3002</p> <p>\u5728\u4e0a\u4e00\u5c0f\u8282\u8bb2\u8fc7\uff0cBlockbox Exporter\u4e2d\u6240\u6709\u7684\u63a2\u9488\u5747\u662f\u4ee5Module\u7684\u4fe1\u606f\u8fdb\u884c\u914d\u7f6e\u3002\u5982\u4e0b\u6240\u793a\uff0c\u914d\u7f6e\u4e86\u4e00\u4e2a\u6700\u7b80\u5355\u7684HTTP\u63a2\u9488\uff1a</p> <pre><code>modules:\n  http_2xx_example:\n    prober: http\n    http:\n</code></pre> <p>\u901a\u8fc7prober\u914d\u7f6e\u9879\u6307\u5b9a\u63a2\u9488\u7c7b\u578b\u3002\u914d\u7f6e\u9879http\u7528\u4e8e\u81ea\u5b9a\u4e49\u63a2\u9488\u7684\u63a2\u6d4b\u65b9\u5f0f\uff0c\u8fd9\u91cc\u6709\u6ca1\u5bf9http\u914d\u7f6e\u9879\u6dfb\u52a0\u4efb\u4f55\u914d\u7f6e\uff0c\u8868\u793a\u5b8c\u5168\u4f7f\u7528HTTP\u63a2\u9488\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u63a2\u9488\u5c06\u4f7f\u7528HTTP GET\u7684\u65b9\u5f0f\u5bf9\u76ee\u6807\u670d\u52a1\u8fdb\u884c\u63a2\u6d4b\uff0c\u5e76\u4e14\u9a8c\u8bc1\u8fd4\u56de\u72b6\u6001\u7801\u662f\u5426\u4e3a2XX\uff0c\u662f\u5219\u8868\u793a\u9a8c\u8bc1\u6210\u529f\uff0c\u5426\u5219\u5931\u8d25\u3002</p>"},{"location":"exporter/install_blackbox_exporter/#http_1","title":"\u81ea\u5b9a\u4e49HTTP\u8bf7\u6c42","text":"<p>HTTP\u670d\u52a1\u901a\u5e38\u4f1a\u4ee5\u4e0d\u540c\u7684\u5f62\u5f0f\u5bf9\u5916\u5c55\u73b0\uff0c\u6709\u4e9b\u53ef\u80fd\u5c31\u662f\u4e00\u4e9b\u7b80\u5355\u7684\u7f51\u9875\uff0c\u800c\u6709\u4e9b\u5219\u53ef\u80fd\u662f\u4e00\u4e9b\u57fa\u4e8eREST\u7684API\u670d\u52a1\u3002 \u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684HTTP\u7684\u63a2\u6d4b\u9700\u8981\u7ba1\u7406\u5458\u80fd\u591f\u5bf9HTTP\u63a2\u9488\u7684\u884c\u4e3a\u8fdb\u884c\u66f4\u591a\u7684\u81ea\u5b9a\u4e49\u8bbe\u7f6e\uff0c\u5305\u62ec\uff1aHTTP\u8bf7\u6c42\u65b9\u6cd5\u3001HTTP\u5934\u4fe1\u606f\u3001\u8bf7\u6c42\u53c2\u6570\u7b49\u3002\u5bf9\u4e8e\u67d0\u4e9b\u542f\u7528\u4e86\u5b89\u5168\u8ba4\u8bc1\u7684\u670d\u52a1\u8fd8\u9700\u8981\u80fd\u591f\u5bf9HTTP\u63a2\u6d4b\u8bbe\u7f6e\u76f8\u5e94\u7684Auth\u652f\u6301\u3002\u5bf9\u4e8eHTTPS\u7c7b\u578b\u7684\u670d\u52a1\u8fd8\u9700\u8981\u80fd\u591f\u5bf9\u8bc1\u4e66\u8fdb\u884c\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u8fd9\u91cc\u901a\u8fc7method\u5b9a\u4e49\u4e86\u63a2\u6d4b\u65f6\u4f7f\u7528\u7684\u8bf7\u6c42\u65b9\u6cd5\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u9700\u8981\u8bf7\u6c42\u53c2\u6570\u7684\u670d\u52a1\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7headers\u5b9a\u4e49\u76f8\u5173\u7684\u8bf7\u6c42\u5934\u4fe1\u606f\uff0c\u4f7f\u7528body\u5b9a\u4e49\u8bf7\u6c42\u5185\u5bb9\uff1a</p> <pre><code>http_post_2xx:\n    prober: http\n    timeout: 5s\n    http:\n      method: POST\n      headers:\n        Content-Type: application/json\n      body: '{}'\n</code></pre> <p>\u5982\u679cHTTP\u670d\u52a1\u542f\u7528\u4e86\u5b89\u5168\u8ba4\u8bc1\uff0cBlockbox Exporter\u5185\u7f6e\u4e86\u5bf9basic_auth\u7684\u652f\u6301\uff0c\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u76f8\u5173\u7684\u8ba4\u8bc1\u4fe1\u606f\u5373\u53ef\uff1a</p> <pre><code>http_basic_auth_example:\n    prober: http\n    timeout: 5s\n    http:\n      method: POST\n      headers:\n        Host: \"login.example.com\"\n      basic_auth:\n        username: \"username\"\n        password: \"mysecret\"\n</code></pre> <p>\u5bf9\u4e8e\u4f7f\u7528\u4e86Bear Token\u7684\u670d\u52a1\u4e5f\u53ef\u4ee5\u901a\u8fc7bearer_token\u914d\u7f6e\u9879\u76f4\u63a5\u6307\u5b9a\u4ee4\u724c\u5b57\u7b26\u4e32\uff0c\u6216\u8005\u901a\u8fc7bearer_token_file\u6307\u5b9a\u4ee4\u724c\u6587\u4ef6\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e9b\u542f\u7528\u4e86HTTPS\u7684\u670d\u52a1\uff0c\u4f46\u662f\u9700\u8981\u81ea\u5b9a\u4e49\u8bc1\u4e66\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7tls_config\u6307\u5b9a\u76f8\u5173\u7684\u8bc1\u4e66\u4fe1\u606f\uff1a</p> <pre><code> http_custom_ca_example:\n    prober: http\n    http:\n      method: GET\n      tls_config:\n        ca_file: \"/certs/my_cert.crt\"\n</code></pre>"},{"location":"exporter/install_blackbox_exporter/#_1","title":"\u81ea\u5b9a\u4e49\u63a2\u9488\u884c\u4e3a","text":"<p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0bHTTP\u63a2\u9488\u53ea\u4f1a\u5bf9HTTP\u8fd4\u56de\u72b6\u6001\u7801\u8fdb\u884c\u6821\u9a8c\uff0c\u5982\u679c\u72b6\u6001\u7801\u4e3a2XX\uff08200 &lt;= StatusCode &lt; 300\uff09\u5219\u8868\u793a\u63a2\u6d4b\u6210\u529f\uff0c\u5e76\u4e14\u63a2\u9488\u8fd4\u56de\u7684\u6307\u6807probe_success\u503c\u4e3a1\u3002</p> <p>\u5982\u679c\u7528\u6237\u9700\u8981\u6307\u5b9aHTTP\u8fd4\u56de\u72b6\u6001\u7801\uff0c\u6216\u8005\u5bf9HTTP\u7248\u672c\u6709\u7279\u6b8a\u8981\u6c42\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u4f7f\u7528valid_http_versions\u548cvalid_status_codes\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]\n      valid_status_codes: []\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cBlockbox\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u4e5f\u4f1a\u5305\u542b\u6307\u6807probe_http_ssl\uff0c\u7528\u4e8e\u8868\u660e\u5f53\u524d\u63a2\u9488\u662f\u5426\u4f7f\u7528\u4e86SSL\uff1a</p> <pre><code># HELP probe_http_ssl Indicates if SSL was used for the final redirect\n# TYPE probe_http_ssl gauge\nprobe_http_ssl 0\n</code></pre> <p>\u800c\u5982\u679c\u7528\u6237\u5bf9\u4e8eHTTP\u670d\u52a1\u662f\u5426\u542f\u7528SSL\u6709\u5f3a\u5236\u7684\u6807\u51c6\u3002\u5219\u53ef\u4ee5\u4f7f\u7528fail_if_ssl\u548cfail_if_not_ssl\u8fdb\u884c\u914d\u7f6e\u3002fail_if_ssl\u4e3atrue\u65f6\uff0c\u8868\u793a\u5982\u679c\u7ad9\u70b9\u542f\u7528\u4e86SSL\u5219\u63a2\u9488\u5931\u8d25\uff0c\u53cd\u4e4b\u6210\u529f\u3002fail_if_not_ssl\u521a\u597d\u76f8\u53cd\u3002</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      valid_status_codes: []\n      method: GET\n      no_follow_redirects: false\n      fail_if_ssl: false\n      fail_if_not_ssl: false\n</code></pre> <p>\u9664\u4e86\u57fa\u4e8eHTTP\u72b6\u6001\u7801\uff0cHTTP\u534f\u8bae\u7248\u672c\u4ee5\u53ca\u662f\u5426\u542f\u7528SSL\u4f5c\u4e3a\u63a7\u5236\u63a2\u9488\u63a2\u6d4b\u884c\u4e3a\u6210\u529f\u4e0e\u5426\u7684\u6807\u51c6\u4ee5\u5916\uff0c\u8fd8\u53ef\u4ee5\u5339\u914dHTTP\u670d\u52a1\u7684\u54cd\u5e94\u5185\u5bb9\u3002\u4f7f\u7528fail_if_matches_regexp\u548cfail_if_not_matches_regexp\u7528\u6237\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7ec4\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u7528\u4e8e\u9a8c\u8bc1HTTP\u8fd4\u56de\u5185\u5bb9\u662f\u5426\u7b26\u5408\u6216\u8005\u4e0d\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5185\u5bb9\u3002</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      method: GET\n      fail_if_matches_regexp:\n        - \"Could not connect to database\"\n      fail_if_not_matches_regexp:\n        - \"Download the latest version here\"\n</code></pre> <p>\u6700\u540e\u9700\u8981\u63d0\u9192\u7684\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bHTTP\u63a2\u9488\u4f1a\u8d70IPV6\u7684\u534f\u8bae\u3002 \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528preferred_ip_protocol=ip4\u5f3a\u5236\u901a\u8fc7IPV4\u7684\u65b9\u5f0f\u8fdb\u884c\u63a2\u6d4b\u3002\u5728Bloackbox\u54cd\u5e94\u7684\u76d1\u63a7\u6837\u672c\u4e2d\uff0c\u4e5f\u4f1a\u901a\u8fc7\u6307\u6807probe_ip_protocol\uff0c\u8868\u660e\u5f53\u524d\u7684\u534f\u8bae\u4f7f\u7528\u60c5\u51b5\uff1a</p> <pre><code># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6\n# TYPE probe_ip_protocol gauge\nprobe_ip_protocol 6\n</code></pre> <p>\u9664\u4e86\u652f\u6301\u5bf9HTTP\u534f\u8bae\u8fdb\u884c\u7f51\u7edc\u63a2\u6d4b\u4ee5\u5916\uff0cBlackbox\u8fd8\u652f\u6301\u5bf9TCP\u3001DNS\u3001ICMP\u7b49\u5176\u4ed6\u7f51\u7edc\u534f\u8bae\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u4eceBlackbox\u7684Github\u9879\u76ee\u4e2d\u83b7\u53d6\u66f4\u591a\u4f7f\u7528\u4fe1\u606f\u3002</p>"},{"location":"exporter/use-prometheus-monitor-container/","title":"\u5bb9\u5668\u76d1\u63a7\uff1acAdvisor","text":"<p>Docker\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5e94\u7528\u5bb9\u5668\u5f15\u64ce\uff0c\u8ba9\u5f00\u53d1\u8005\u53ef\u4ee5\u6253\u5305\u4ed6\u4eec\u7684\u5e94\u7528\u4ee5\u53ca\u4f9d\u8d56\u5305\u5230\u4e00\u4e2a\u53ef\u79fb\u690d\u7684\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u53d1\u5e03\u5230\u4efb\u4f55\u6d41\u884c\u7684Linux/Windows/Mac\u673a\u5668\u4e0a\u3002\u5bb9\u5668\u955c\u50cf\u6b63\u6210\u4e3a\u4e00\u4e2a\u65b0\u7684\u6807\u51c6\u5316\u8f6f\u4ef6\u4ea4\u4ed8\u65b9\u5f0f\u3002</p> <p>\u4f8b\u5982\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5feb\u901f\u5728\u672c\u5730\u542f\u52a8\u4e00\u4e2aNginx\u670d\u52a1\uff1a</p> <pre><code>docker run -itd nginx\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u83b7\u53d6\u5230Docker\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7Docker\u7684stats\u547d\u4ee4\u83b7\u53d6\u5230\u5f53\u524d\u4e3b\u673a\u4e0a\u8fd0\u884c\u5bb9\u5668\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b\u5bb9\u5668\u7684CPU\u5229\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u91cf\u3001\u7f51\u7edcIO\u603b\u91cf\u4ee5\u53ca\u78c1\u76d8IO\u603b\u91cf\u7b49\u4fe1\u606f\u3002</p> <pre><code>$ docker stats\nCONTAINER           CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS\n9a1648bec3b2        0.30%               196KiB / 3.855GiB     0.00%               828B / 0B           827kB / 0B          1\n</code></pre> <p>\u9664\u4e86\u4f7f\u7528\u547d\u4ee4\u4ee5\u5916\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u901a\u8fc7Docker\u63d0\u4f9b\u7684HTTP API\u67e5\u770b\u5bb9\u5668\u8be6\u7ec6\u7684\u76d1\u63a7\u7edf\u8ba1\u4fe1\u606f\u3002</p>"},{"location":"exporter/use-prometheus-monitor-container/#cadvisor_1","title":"\u4f7f\u7528CAdvisor","text":"<p>CAdvisor\u662fGoogle\u5f00\u6e90\u7684\u4e00\u6b3e\u7528\u4e8e\u5c55\u793a\u548c\u5206\u6790\u5bb9\u5668\u8fd0\u884c\u72b6\u6001\u7684\u53ef\u89c6\u5316\u5de5\u5177\u3002\u901a\u8fc7\u5728\u4e3b\u673a\u4e0a\u8fd0\u884cCAdvisor\u7528\u6237\u53ef\u4ee5\u8f7b\u677e\u7684\u83b7\u53d6\u5230\u5f53\u524d\u4e3b\u673a\u4e0a\u5bb9\u5668\u7684\u8fd0\u884c\u7edf\u8ba1\u4fe1\u606f\uff0c\u5e76\u4ee5\u56fe\u8868\u7684\u5f62\u5f0f\u5411\u7528\u6237\u5c55\u793a\u3002</p> <p>\u5728\u672c\u5730\u8fd0\u884cCAdvisor\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u8fd0\u884c\u4e00\u4e0b\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>docker run \\\n  --volume=/:/rootfs:ro \\\n  --volume=/var/run:/var/run:rw \\\n  --volume=/sys:/sys:ro \\\n  --volume=/var/lib/docker/:/var/lib/docker:ro \\\n  --publish=8080:8080 \\\n  --detach=true \\\n  --name=cadvisor \\\n  google/cadvisor:latest\n</code></pre> <p>\u901a\u8fc7\u8bbf\u95eehttp://localhost:8080\u53ef\u4ee5\u67e5\u770b\uff0c\u5f53\u524d\u4e3b\u673a\u4e0a\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>CAdvisor\u662f\u4e00\u4e2a\u7b80\u5355\u6613\u7528\u7684\u5de5\u5177\uff0c\u76f8\u6bd4\u4e8e\u4f7f\u7528Docker\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u7528\u6237\u4e0d\u7528\u518d\u767b\u5f55\u5230\u670d\u52a1\u5668\u4e2d\u5373\u53ef\u4ee5\u53ef\u89c6\u5316\u56fe\u8868\u7684\u5f62\u5f0f\u67e5\u770b\u4e3b\u673a\u4e0a\u6240\u6709\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\u3002</p> <p>\u800c\u5728\u591a\u4e3b\u673a\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u6240\u6709\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2aCAdvisor\u518d\u901a\u8fc7\u5404\u81ea\u7684UI\u67e5\u770b\u76d1\u63a7\u4fe1\u606f\u663e\u7136\u4e0d\u592a\u65b9\u4fbf\uff0c\u540c\u65f6CAdvisor\u9ed8\u8ba4\u53ea\u4fdd\u5b582\u5206\u949f\u7684\u76d1\u63a7\u6570\u636e\u3002\u597d\u6d88\u606f\u662fCAdvisor\u5df2\u7ecf\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u652f\u6301\u3002\u8bbf\u95eehttp://localhost:8080/metrics\u5373\u53ef\u83b7\u53d6\u5230\u6807\u51c6\u7684Prometheus\u76d1\u63a7\u6837\u672c\u8f93\u51fa:</p> <pre><code># HELP cadvisor_version_info A metric with a constant '1' value labeled by kernel version, OS version, docker version, cadvisor version &amp; cadvisor revision.\n# TYPE cadvisor_version_info gauge\ncadvisor_version_info{cadvisorRevision=\"1e567c2\",cadvisorVersion=\"v0.28.3\",dockerVersion=\"17.09.1-ce\",kernelVersion=\"4.9.49-moby\",osVersion=\"Alpine Linux v3.4\"} 1\n# HELP container_cpu_load_average_10s Value of container cpu load average over the last 10 seconds.\n# TYPE container_cpu_load_average_10s gauge\ncontainer_cpu_load_average_10s{container_label_maintainer=\"\",id=\"/\",image=\"\",name=\"\"} 0\ncontainer_cpu_load_average_10s{container_label_maintainer=\"\",id=\"/docker\",image=\"\",name=\"\"} 0\ncontainer_cpu_load_average_10s{container_label_maintainer=\"\",id=\"/docker/15535a1e09b3a307b46d90400423d5b262ec84dc55b91ca9e7dd886f4f764ab3\",image=\"busybox\",name=\"lucid_shaw\"} 0\ncontainer_cpu_load_average_10s{container_label_maintainer=\"\",id=\"/docker/46750749b97bae47921d49dccdf9011b503e954312b8cffdec6268c249afa2dd\",image=\"google/cadvisor:latest\",name=\"cadvisor\"} 0\ncontainer_cpu_load_average_10s{container_label_maintainer=\"NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;\",id=\"/docker/f51fd4d4f410965d3a0fd7e9f3250218911c1505e12960fb6dd7b889e75fc114\",image=\"nginx\",name=\"confident_brattain\"} 0\n</code></pre> <p>\u4e0b\u9762\u8868\u683c\u4e2d\u5217\u4e3e\u4e86\u4e00\u4e9bCAdvisor\u4e2d\u83b7\u53d6\u5230\u7684\u5178\u578b\u76d1\u63a7\u6307\u6807\uff1a</p> \u6307\u6807\u540d\u79f0 \u7c7b\u578b \u542b\u4e49 container_cpu_load_average_10s gauge \u8fc7\u53bb10\u79d2\u5bb9\u5668CPU\u7684\u5e73\u5747\u8d1f\u8f7d container_cpu_usage_seconds_total counter \u5bb9\u5668\u5728\u6bcf\u4e2aCPU\u5185\u6838\u4e0a\u7684\u7d2f\u79ef\u5360\u7528\u65f6\u95f4 (\u5355\u4f4d\uff1a\u79d2) container_cpu_system_seconds_total counter System CPU\u7d2f\u79ef\u5360\u7528\u65f6\u95f4\uff08\u5355\u4f4d\uff1a\u79d2\uff09 container_cpu_user_seconds_total counter User CPU\u7d2f\u79ef\u5360\u7528\u65f6\u95f4\uff08\u5355\u4f4d\uff1a\u79d2\uff09 container_fs_usage_bytes gauge \u5bb9\u5668\u4e2d\u6587\u4ef6\u7cfb\u7edf\u7684\u4f7f\u7528\u91cf(\u5355\u4f4d\uff1a\u5b57\u8282) container_fs_limit_bytes gauge \u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u603b\u91cf(\u5355\u4f4d\uff1a\u5b57\u8282) container_fs_reads_bytes_total counter \u5bb9\u5668\u7d2f\u79ef\u8bfb\u53d6\u6570\u636e\u7684\u603b\u91cf(\u5355\u4f4d\uff1a\u5b57\u8282) container_fs_writes_bytes_total counter \u5bb9\u5668\u7d2f\u79ef\u5199\u5165\u6570\u636e\u7684\u603b\u91cf(\u5355\u4f4d\uff1a\u5b57\u8282) container_memory_max_usage_bytes gauge \u5bb9\u5668\u7684\u6700\u5927\u5185\u5b58\u4f7f\u7528\u91cf\uff08\u5355\u4f4d\uff1a\u5b57\u8282\uff09 container_memory_usage_bytes gauge \u5bb9\u5668\u5f53\u524d\u7684\u5185\u5b58\u4f7f\u7528\u91cf\uff08\u5355\u4f4d\uff1a\u5b57\u8282 container_spec_memory_limit_bytes gauge \u5bb9\u5668\u7684\u5185\u5b58\u4f7f\u7528\u91cf\u9650\u5236 machine_memory_bytes gauge \u5f53\u524d\u4e3b\u673a\u7684\u5185\u5b58\u603b\u91cf container_network_receive_bytes_total counter \u5bb9\u5668\u7f51\u7edc\u7d2f\u79ef\u63a5\u6536\u6570\u636e\u603b\u91cf\uff08\u5355\u4f4d\uff1a\u5b57\u8282\uff09 container_network_transmit_bytes_total counter \u5bb9\u5668\u7f51\u7edc\u7d2f\u79ef\u4f20\u8f93\u6570\u636e\u603b\u91cf\uff08\u5355\u4f4d\uff1a\u5b57\u8282\uff09"},{"location":"exporter/use-prometheus-monitor-container/#prometheus","title":"\u4e0ePrometheus\u96c6\u6210","text":"<p>\u4fee\u6539/etc/prometheus/prometheus.yml\uff0c\u5c06cAdvisor\u6dfb\u52a0\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u4efb\u52a1\u76ee\u6807\u5f53\u4e2d\uff1a</p> <pre><code>- job_name: cadvisor\n  static_configs:\n  - targets:\n    - localhost:8080\n</code></pre> <p>\u542f\u52a8Prometheus\u670d\u52a1:</p> <pre><code>prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/data/prometheus\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5728Prometheus UI\u4e2d\u67e5\u770b\u5230\u5f53\u524d\u6240\u6709\u7684Target\u72b6\u6001\uff1a</p> <p></p> <p>\u5f53\u80fd\u591f\u6b63\u5e38\u91c7\u96c6\u5230cAdvisor\u7684\u6837\u672c\u6570\u636e\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8ba1\u7b97\u5bb9\u5668\u7684CPU\u4f7f\u7528\u7387\uff1a</p> <pre><code>sum(irate(container_cpu_usage_seconds_total{image!=\"\"}[1m])) without (cpu)\n</code></pre> <p></p> <p>\u67e5\u8be2\u5bb9\u5668\u5185\u5b58\u4f7f\u7528\u91cf\uff08\u5355\u4f4d\uff1a\u5b57\u8282\uff09:</p> <pre><code>container_memory_usage_bytes{image!=\"\"}\n</code></pre> <p>\u67e5\u8be2\u5bb9\u5668\u7f51\u7edc\u63a5\u6536\u91cf\u901f\u7387\uff08\u5355\u4f4d\uff1a\u5b57\u8282/\u79d2\uff09\uff1a</p> <pre><code>sum(rate(container_network_receive_bytes_total{image!=\"\"}[1m])) without (interface)\n</code></pre> <p></p> <p>\u67e5\u8be2\u5bb9\u5668\u7f51\u7edc\u4f20\u8f93\u91cf\u901f\u7387\uff08\u5355\u4f4d\uff1a\u5b57\u8282/\u79d2\uff09\uff1a</p> <pre><code>sum(rate(container_network_transmit_bytes_total{image!=\"\"}[1m])) without (interface)\n</code></pre> <p></p> <p>\u67e5\u8be2\u5bb9\u5668\u6587\u4ef6\u7cfb\u7edf\u8bfb\u53d6\u901f\u7387\uff08\u5355\u4f4d\uff1a\u5b57\u8282/\u79d2\uff09\uff1a</p> <pre><code>sum(rate(container_fs_reads_bytes_total{image!=\"\"}[1m])) without (device)\n</code></pre> <p></p> <p>\u67e5\u8be2\u5bb9\u5668\u6587\u4ef6\u7cfb\u7edf\u5199\u5165\u901f\u7387\uff08\u5355\u4f4d\uff1a\u5b57\u8282/\u79d2\uff09\uff1a</p> <pre><code>sum(rate(container_fs_writes_bytes_total{image!=\"\"}[1m])) without (device)\n</code></pre> <p></p>"},{"location":"exporter/use-promethues-monitor-mysql/","title":"\u76d1\u63a7MySQL\u8fd0\u884c\u72b6\u6001\uff1aMySQLD Exporter","text":"<p>MySQL\u662f\u4e00\u4e2a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u7531\u745e\u5178MySQL AB\u516c\u53f8\u5f00\u53d1\uff0c\u76ee\u524d\u5c5e\u4e8eOracle\u65d7\u4e0b\u7684\u4ea7\u54c1\u3002 MySQL\u662f\u6700\u6d41\u884c\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u4e4b\u4e00\u3002\u6570\u636e\u5e93\u7684\u7a33\u5b9a\u8fd0\u884c\u662f\u4fdd\u8bc1\u4e1a\u52a1\u53ef\u7528\u6027\u7684\u5173\u952e\u56e0\u7d20\u4e4b\u4e00\u3002\u8fd9\u4e00\u5c0f\u8282\u5f53\u4e2d\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Prometheus\u63d0\u4f9b\u7684MySQLD Exporter\u5b9e\u73b0\u5bf9MySQL\u6570\u636e\u5e93\u6027\u80fd\u4ee5\u53ca\u8d44\u6e90\u5229\u7528\u7387\u7684\u76d1\u63a7\u548c\u5ea6\u91cf\u3002</p>"},{"location":"exporter/use-promethues-monitor-mysql/#mysqld-exporter","title":"\u90e8\u7f72MySQLD Exporter","text":"<p>\u4e3a\u4e86\u7b80\u5316\u6d4b\u8bd5\u73af\u5883\u590d\u6742\u5ea6\uff0c\u8fd9\u91cc\u4f7f\u7528Docker Compose\u5b9a\u4e49\u5e76\u542f\u52a8MySQL\u4ee5\u53caMySQLD Exporter\uff1a</p> <pre><code>version: '3'\nservices:\n  mysql:\n    image: mysql:5.7\n    ports:\n      - \"3306:3306\"\n    environment:\n      - MYSQL_ROOT_PASSWORD=password\n      - MYSQL_DATABASE=database\n  mysqlexporter:\n    image: prom/mysqld-exporter\n    ports:\n      - \"9104:9104\"\n    environment:\n      - DATA_SOURCE_NAME=root:password@(mysql:3306)/database\n</code></pre> <p>\u8fd9\u91cc\u901a\u8fc7\u73af\u5883\u53d8\u91cfDATA_SOURCE_NAME\u65b9\u5f0f\u5b9a\u4e49\u76d1\u63a7\u76ee\u6807\u3002\u4f7f\u7528Docker Compose\u542f\u52a8\u6d4b\u8bd5\u7528\u7684MySQL\u5b9e\u4f8b\u4ee5\u53caMySQLD Exporter:</p> <pre><code>$ docker-compose up -d\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u767b\u5f55\u5230MySQL\u5bb9\u5668\u5f53\u4e2d\uff0c\u5e76\u6267\u884cMySQL\u76f8\u5173\u7684\u6307\u4ee4\uff1a</p> <pre><code>$ docker exec -it &lt;mysql_container_id&gt; mysql -uroot -ppassword\nmysql&gt;\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7http://localhost:9104\u8bbf\u95eeMySQLD Exporter\u66b4\u9732\u7684\u670d\u52a1\uff1a</p> <p>\u53ef\u4ee5\u901a\u8fc7/metrics\u67e5\u770bmysql_up\u6307\u6807\u5224\u65ad\u5f53\u524dMySQLD Exporter\u662f\u5426\u6b63\u5e38\u8fde\u63a5\u5230\u4e86MySQL\u5b9e\u4f8b\uff0c\u5f53\u6307\u6807\u503c\u4e3a1\u65f6\u8868\u793a\u80fd\u591f\u6b63\u5e38\u83b7\u53d6\u76d1\u63a7\u6570\u636e\uff1a</p> <pre><code># HELP mysql_up Whether the MySQL server is up.\n# TYPE mysql_up gauge\nmysql_up 1\n</code></pre> <p>\u4fee\u6539Prometheus\u914d\u7f6e\u6587\u4ef6/etc/prometheus/prometheus.yml\uff0c\u589e\u52a0\u5bf9MySQLD Exporter\u5b9e\u4f8b\u7684\u91c7\u96c6\u4efb\u52a1\u914d\u7f6e:</p> <pre><code>- job_name: mysqld\n  static_configs:\n  - targets:\n    - localhost:9104\n</code></pre> <p>\u542f\u52a8Prometheus:</p> <pre><code>prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/data/prometheus\n</code></pre> <p>\u901a\u8fc7Prometheus\u7684\u72b6\u6001\u9875\uff0c\u53ef\u4ee5\u67e5\u770b\u5f53\u524dTarget\u7684\u72b6\u6001\uff1a</p> <p></p> <p>\u4e3a\u4e86\u786e\u4fdd\u6570\u636e\u5e93\u7684\u7a33\u5b9a\u8fd0\u884c\uff0c\u901a\u5e38\u4f1a\u5173\u6ce8\u4e00\u4e0b\u56db\u4e2a\u4e0e\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u76f8\u5173\u7684\u6307\u6807\uff1a\u67e5\u8be2\u541e\u5410\u91cf\u3001\u8fde\u63a5\u60c5\u51b5\u3001\u7f13\u51b2\u6c60\u4f7f\u7528\u60c5\u51b5\u4ee5\u53ca\u67e5\u8be2\u6267\u884c\u6027\u80fd\u7b49\u3002</p>"},{"location":"exporter/use-promethues-monitor-mysql/#_1","title":"\u76d1\u63a7\u6570\u636e\u5e93\u541e\u5410\u91cf","text":"<p>\u5bf9\u4e8e\u6570\u636e\u5e93\u800c\u8a00\uff0c\u6700\u91cd\u8981\u7684\u5de5\u4f5c\u5c31\u662f\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u589e\u3001\u5220\u3001\u6539\u3001\u67e5\u3002\u4e3a\u4e86\u8861\u91cf\u6570\u636e\u5e93\u670d\u52a1\u5668\u5f53\u524d\u7684\u541e\u5410\u91cf\u53d8\u5316\u60c5\u51b5\u3002\u5728MySQL\u5185\u90e8\u901a\u8fc7\u4e00\u4e2a\u540d\u4e3aQuestions\u7684\u8ba1\u6570\u5668\uff0c\u5f53\u5ba2\u6237\u7aef\u53d1\u9001\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u540e\uff0c\u5176\u503c\u5c31\u4f1a+1\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0bMySQL\u6307\u4ee4\u67e5\u8be2Questions\u7b49\u670d\u52a1\u5668\u72b6\u6001\u53d8\u91cf\u7684\u503c\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Questions\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Questions     | 1326  |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>MySQLD Exporter\u4e2d\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u901a\u8fc7mysql_global_status_questions\u53cd\u6620\u5f53\u524dQuestions\u8ba1\u6570\u5668\u7684\u5927\u5c0f\uff1a</p> <pre><code># HELP mysql_global_status_questions Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_questions untyped\nmysql_global_status_questions 1016\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0bPromQL\u53ef\u4ee5\u67e5\u770b\u5f53\u524dMySQL\u5b9e\u4f8b\u67e5\u8be2\u901f\u7387\u7684\u53d8\u5316\u60c5\u51b5\uff0c\u67e5\u8be2\u6570\u91cf\u7684\u7a81\u53d8\u5f80\u5f80\u6697\u793a\u7740\u53ef\u80fd\u53d1\u751f\u4e86\u67d0\u4e9b\u4e25\u91cd\u7684\u95ee\u9898\uff0c\u56e0\u6b64\u7528\u4e8e\u7528\u6237\u5e94\u8be5\u5173\u6ce8\u5e76\u4e14\u8bbe\u7f6e\u54cd\u5e94\u7684\u544a\u8b66\u89c4\u5219\uff0c\u4ee5\u53ca\u65f6\u83b7\u53d6\u8be5\u6307\u6807\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>rate(mysql_global_status_questions[2m])\n</code></pre> <p>\u4e00\u822c\u8fd8\u53ef\u4ee5\u4ece\u76d1\u63a7\u8bfb\u64cd\u4f5c\u548c\u5199\u64cd\u4f5c\u7684\u6267\u884c\u60c5\u51b5\u8fdb\u884c\u5224\u65ad\u3002\u901a\u8fc7MySQL\u5168\u5c40\u72b6\u6001\u4e2d\u7684Com_select\u53ef\u4ee5\u67e5\u8be2\u5230\u5f53\u524d\u670d\u52a1\u5668\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u7684\u603b\u6b21\u6570\uff1a\u76f8\u5e94\u7684\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7Com_insert\u3001Com_update\u4ee5\u53caCom_delete\u7684\u603b\u91cf\u8861\u91cf\u5f53\u524d\u670d\u52a1\u5668\u5199\u64cd\u4f5c\u7684\u603b\u6b21\u6570\uff0c\u4f8b\u5982\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u67e5\u8be2\u5f53\u524dMySQL\u5b9e\u4f8binsert\u8bed\u53e5\u7684\u6267\u884c\u6b21\u6570\u603b\u91cf\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Com_insert\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Com_insert    | 0     |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u4eceMySQLD Exporter\u7684/metrics\u8fd4\u56de\u7684\u76d1\u63a7\u6837\u672c\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7global_status_commands_total\u83b7\u53d6\u5f53\u524d\u5b9e\u4f8b\u5404\u7c7b\u6307\u4ee4\u6267\u884c\u7684\u6b21\u6570\uff1a</p> <pre><code># HELP mysql_global_status_commands_total Total number of executed MySQL commands.\n# TYPE mysql_global_status_commands_total counter\nmysql_global_status_commands_total{command=\"admin_commands\"} 0\nmysql_global_status_commands_total{command=\"alter_db\"} 0\nmysql_global_status_commands_total{command=\"alter_db_upgrade\"} 0\nmysql_global_status_commands_total{command=\"select\"} 10\nmysql_global_status_commands_total{command=\"insert\"} 2\nmysql_global_status_commands_total{command=\"update\"} 2\nmysql_global_status_commands_total{command=\"delete\"} 1\n</code></pre> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0bPromQL\u67e5\u770b\u5f53\u524dMySQL\u5b9e\u4f8b\u5199\u64cd\u4f5c\u901f\u7387\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>sum(rate(mysql_global_status_commands_total{command=~\"insert|update|delete\"}[2m])) without (command)\n</code></pre>"},{"location":"exporter/use-promethues-monitor-mysql/#_2","title":"\u8fde\u63a5\u60c5\u51b5","text":"<p>\u5728MySQL\u4e2d\u901a\u8fc7\u5168\u5c40\u8bbe\u7f6emax_connections\u9650\u5236\u4e86\u5f53\u524d\u670d\u52a1\u5668\u5141\u8bb8\u7684\u6700\u5927\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u91cf\u3002\u4e00\u65e6\u53ef\u7528\u8fde\u63a5\u6570\u88ab\u7528\u5c3d\uff0c\u65b0\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u90fd\u4f1a\u88ab\u76f4\u63a5\u62d2\u7edd\u3002 \u56e0\u6b64\u5f53\u76d1\u63a7MySQL\u8fd0\u884c\u72b6\u6001\u65f6\uff0c\u9700\u8981\u65f6\u523b\u5173\u6ce8MySQL\u670d\u52a1\u5668\u7684\u8fde\u63a5\u60c5\u51b5\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u67e5\u770b\u5f53\u524dMySQL\u670d\u52a1\u7684max_connections\u914d\u7f6e\uff1a</p> <pre><code>mysql&gt; SHOW VARIABLES LIKE 'max_connections';\n+-----------------+-------+\n| Variable_name   | Value |\n+-----------------+-------+\n| max_connections | 151   |\n+-----------------+-------+\n1 row in set (0.01 sec)\n</code></pre> <p>MySQL\u9ed8\u8ba4\u7684\u6700\u5927\u94fe\u63a5\u6570\u4e3a151\u3002\u4e34\u65f6\u8c03\u6574\u6700\u5927\u8fde\u63a5\u6570\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u8fdb\u884c\u8bbe\u7f6e\uff1a</p> <pre><code>SET GLOBAL max_connections = 200;\n</code></pre> <p>\u5982\u679c\u60f3\u6c38\u4e45\u5316\u8bbe\u7f6e\uff0c\u5219\u9700\u8981\u901a\u8fc7\u4fee\u6539MySQL\u914d\u7f6e\u6587\u4ef6my.cnf\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>max_connections = 200\n</code></pre> <p>\u901a\u8fc7Global Status\u4e2d\u7684Threads_connected\u3001Aborted_connects\u3001Connection_errors_max_connections\u4ee5\u53caThreads_running\u53ef\u4ee5\u67e5\u770b\u5f53\u524dMySQL\u5b9e\u4f8b\u7684\u8fde\u63a5\u60c5\u51b5\u3002</p> <p>\u4f8b\u5982\uff0c\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u53ef\u4ee5\u76f4\u63a5\u5f53\u524dMySQL\u5b9e\u4f8b\u7684\u8fde\u63a5\u6570\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Threads_connected\";\n+-------------------+-------+\n| Variable_name     | Value |\n+-------------------+-------+\n| Threads_connected | 1     |\n+-------------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u5f53\u6240\u6709\u53ef\u7528\u8fde\u63a5\u90fd\u88ab\u5360\u7528\u65f6\uff0c\u5982\u679c\u4e00\u4e2a\u5ba2\u6237\u7aef\u5c1d\u8bd5\u8fde\u63a5\u81f3MySQL\uff0c\u4f1a\u51fa\u73b0\u201cToo many connections(\u8fde\u63a5\u6570\u8fc7\u591a)\u201d\u9519\u8bef\uff0c\u540c\u65f6Connection_errors_max_connections\u7684\u503c\u4e5f\u4f1a\u589e\u52a0\u3002\u4e3a\u4e86\u9632\u6b62\u51fa\u73b0\u6b64\u7c7b\u60c5\u51b5\uff0c\u4f60\u5e94\u8be5\u76d1\u63a7\u53ef\u7528\u8fde\u63a5\u7684\u6570\u91cf\uff0c\u5e76\u786e\u4fdd\u5176\u503c\u4fdd\u6301\u5728max_connections\u9650\u5236\u4ee5\u5185\u3002\u540c\u65f6\u5982\u679cAborted_connects\u7684\u6570\u91cf\u4e0d\u65ad\u589e\u52a0\u65f6\uff0c\u8bf4\u660e\u5ba2\u6237\u7aef\u5c1d\u8bd5\u8fde\u63a5\u5230MySQL\u90fd\u5931\u8d25\u4e86\u3002\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7Connection_errors_max_connections\u4ee5\u53caConnection_errors_internal\u5206\u6790\u8fde\u63a5\u5931\u8d25\u7684\u95ee\u9898\u539f\u56e0\u3002</p> <p>\u4e0b\u9762\u5217\u4e3e\u4e86\u4e0eMySQL\u8fde\u63a5\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\uff1a</p> <ul> <li>mysql_global_variables_max_connections\uff1a \u5141\u8bb8\u7684\u6700\u5927\u8fde\u63a5\u6570\uff1b</li> <li>mysql_global_status_threads_connected\uff1a \u5f53\u524d\u5f00\u653e\u7684\u8fde\u63a5\uff1b</li> <li>mysql_global_status_threads_running\uff1a\u5f53\u524d\u5f00\u653e\u7684\u8fde\u63a5\uff1b</li> <li>mysql_global_status_aborted_connects\uff1a\u5f53\u524d\u5f00\u653e\u7684\u8fde\u63a5\uff1b</li> <li>mysql_global_status_connection_errors_total{error=\"max_connections\"}\uff1a\u7531\u4e8e\u8d85\u51fa\u6700\u5927\u8fde\u63a5\u6570\u5bfc\u81f4\u7684\u9519\u8bef\uff1b</li> <li>mysql_global_status_connection_errors_total{error=\"internal\"}\uff1a\u7531\u4e8e\u7cfb\u7edf\u5185\u90e8\u5bfc\u81f4\u7684\u9519\u8bef\uff1b</li> </ul> <p>\u901a\u8fc7PromQL\u67e5\u8be2\u5f53\u524d\u5269\u4f59\u7684\u53ef\u7528\u8fde\u63a5\u6570\uff1a</p> <pre><code>mysql_global_variables_max_connections - mysql_global_status_threads_connected\n</code></pre> <p>\u4f7f\u7528PromQL\u67e5\u8be2\u5f53\u524dMySQL\u5b9e\u4f8b\u8fde\u63a5\u62d2\u7edd\u6570\uff1a</p> <pre><code>mysql_global_status_aborted_connects\n</code></pre>"},{"location":"exporter/use-promethues-monitor-mysql/#_3","title":"\u76d1\u63a7\u7f13\u51b2\u6c60\u4f7f\u7528\u60c5\u51b5","text":"<p>MySQL\u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ceInnoDB\u4f7f\u7528\u4e86\u4e00\u7247\u79f0\u4e3a\u7f13\u51b2\u6c60\u7684\u5185\u5b58\u533a\u57df\uff0c\u7528\u4e8e\u7f13\u5b58\u6570\u636e\u8868\u4ee5\u53ca\u7d22\u5f15\u7684\u6570\u636e\u3002 \u5f53\u7f13\u51b2\u6c60\u7684\u8d44\u6e90\u4f7f\u7528\u8d85\u51fa\u9650\u5236\u540e\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u5e93\u6027\u80fd\u7684\u4e0b\u964d\uff0c\u540c\u65f6\u5f88\u591a\u67e5\u8be2\u547d\u4ee4\u4f1a\u76f4\u63a5\u5728\u78c1\u76d8\u4e2d\u6267\u884c\uff0c\u5bfc\u81f4\u78c1\u76d8I/O\u4e0d\u65ad\u6500\u5347\u3002 \u56e0\u6b64\uff0c\u5e94\u8be5\u5173\u6ce8MySQL\u7f13\u51b2\u6c60\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff0c\u5e76\u4e14\u5728\u5408\u7406\u7684\u65f6\u95f4\u6269\u5927\u7f13\u51b2\u6c60\u7684\u5927\u5c0f\u53ef\u4ee5\u4f18\u5316\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p> <p>Innodb_buffer_pool_pages_total\u53cd\u6620\u4e86\u5f53\u524d\u7f13\u51b2\u6c60\u4e2d\u7684\u5185\u5b58\u9875\u7684\u603b\u9875\u6570\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u67e5\u770b\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Innodb_buffer_pool_pages_total\";\n+--------------------------------+-------+\n| Variable_name                  | Value |\n+--------------------------------+-------+\n| Innodb_buffer_pool_pages_total | 8191  |\n+--------------------------------+-------+\n1 row in set (0.02 sec)\n</code></pre> <p>MySQLD Exporter\u901a\u8fc7\u4ee5\u4e0b\u6307\u6807\u8fd4\u56de\u7f13\u51b2\u6c60\u4e2d\u5404\u7c7b\u5185\u5b58\u9875\u7684\u6570\u91cf\uff1a</p> <pre><code># HELP mysql_global_status_buffer_pool_pages Innodb buffer pool pages by state.\n# TYPE mysql_global_status_buffer_pool_pages gauge\nmysql_global_status_buffer_pool_pages{state=\"data\"} 516\nmysql_global_status_buffer_pool_pages{state=\"dirty\"} 0\nmysql_global_status_buffer_pool_pages{state=\"free\"} 7675\nmysql_global_status_buffer_pool_pages{state=\"misc\"} 0\n</code></pre> <p>Innodb_buffer_pool_read_requests\u8bb0\u5f55\u4e86\u6b63\u5e38\u4ece\u7f13\u51b2\u6c60\u8bfb\u53d6\u6570\u636e\u7684\u8bf7\u6c42\u6570\u91cf\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u67e5\u770b\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Innodb_buffer_pool_read_requests\";\n+----------------------------------+--------+\n| Variable_name                    | Value  |\n+----------------------------------+--------+\n| Innodb_buffer_pool_read_requests | 797023 |\n+----------------------------------+--------+\n1 row in set (0.00 sec)\n</code></pre> <p>MySQLD Exporter\u901a\u8fc7\u4ee5\u4e0b\u6307\u6807\u8fd4\u56de\u7f13\u51b2\u6c60\u4e2dInnodb_buffer_pool_read_requests\u7684\u503c\uff1a</p> <pre><code># HELP mysql_global_status_innodb_buffer_pool_read_requests Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_innodb_buffer_pool_read_requests untyped\nmysql_global_status_innodb_buffer_pool_read_requests 736711\n</code></pre> <p>\u5f53\u7f13\u51b2\u6c60\u65e0\u6cd5\u6ee1\u8db3\u65f6\uff0cMySQL\u53ea\u80fd\u4ece\u78c1\u76d8\u4e2d\u8bfb\u53d6\u6570\u636e\u3002Innodb_buffer_pool_reads\u5373\u8bb0\u5f55\u4e86\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u7684\u8bf7\u6c42\u6570\u91cf\u3002\u901a\u5e38\u6765\u8bf4\u4ece\u5185\u5b58\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u901f\u5ea6\u8981\u6bd4\u4ece\u78c1\u76d8\u4e2d\u8bfb\u53d6\u5feb\u5f88\u591a\uff0c\u56e0\u6b64\uff0c\u5982\u679cInnodb_buffer_pool_reads\u7684\u503c\u5f00\u59cb\u589e\u52a0\uff0c\u53ef\u80fd\u610f\u5473\u7740\u6570\u636e\u5e93\u7684\u6027\u80fd\u6709\u95ee\u9898\u3002 \u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u53ea\u80fd\u67e5\u770bInnodb_buffer_pool_reads\u7684\u6570\u91cf</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Innodb_buffer_pool_reads\";\n+--------------------------+-------+\n| Variable_name            | Value |\n+--------------------------+-------+\n| Innodb_buffer_pool_reads | 443   |\n+--------------------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u5728MySQLD Exporter\u4e2d\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u6807\u67e5\u770bInnodb_buffer_pool_reads\u7684\u6570\u91cf\u3002</p> <pre><code># HELP mysql_global_status_innodb_buffer_pool_reads Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_innodb_buffer_pool_reads untyped\nmysql_global_status_innodb_buffer_pool_reads 443\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u76d1\u63a7\u6307\u6807\uff0c\u4ee5\u53ca\u5b9e\u9645\u76d1\u63a7\u7684\u573a\u666f\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528PromQL\u5feb\u901f\u5efa\u7acb\u591a\u4e2a\u76d1\u63a7\u9879\u3002</p> <p>\u901a\u8fc7\u4ee5\u4e0bPromQL\u53ef\u4ee5\u5f97\u5230\u5404\u4e2aMySQL\u5b9e\u4f8b\u7684\u7f13\u51b2\u6c60\u5229\u7528\u7387\u3002\u4e00\u822c\u6765\u8bf4\u8fd8\u9700\u8981\u7ed3\u5408Innodb_buffer_pool_reads\u7684\u589e\u957f\u7387\u60c5\u51b5\u6765\u5224\u65ad\u7f13\u51b2\u6c60\u5927\u5c0f\u662f\u5426\u5408\u7406\uff1a</p> <pre><code>(sum(mysql_global_status_buffer_pool_pages) by (instance) - sum(mysql_global_status_buffer_pool_pages{state=\"free\"}) by (instance)) / sum(mysql_global_status_buffer_pool_pages) by (instance)\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0bPromQL\u8ba1\u7b972\u5206\u949f\u5185\u78c1\u76d8\u8bfb\u53d6\u8bf7\u6c42\u6b21\u6570\u7684\u589e\u957f\u7387\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>rate(mysql_global_status_innodb_buffer_pool_reads[2m])\n</code></pre>"},{"location":"exporter/use-promethues-monitor-mysql/#_4","title":"\u67e5\u8be2\u6027\u80fd","text":"<p>MySQL\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2aSlow_queries\u7684\u8ba1\u6570\u5668\uff0c\u5f53\u67e5\u8be2\u7684\u6267\u884c\u65f6\u95f4\u8d85\u8fc7long_query_time\u7684\u503c\u540e\uff0c\u8ba1\u6570\u5668\u5c31\u4f1a+1\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a10\u79d2\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u5728MySQL\u4e2d\u67e5\u8be2\u5f53\u524dlong_query_time\u7684\u8bbe\u7f6e\uff1a</p> <pre><code>mysql&gt; SHOW VARIABLES LIKE 'long_query_time';\n+-----------------+-----------+\n| Variable_name   | Value     |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524dMySQL\u5b9e\u4f8b\u4e2dSlow_queries\u7684\u6570\u91cf\uff1a</p> <pre><code>mysql&gt; SHOW GLOBAL STATUS LIKE \"Slow_queries\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Slow_queries  | 0     |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>MySQLD Exporter\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u901a\u8fc7\u4ee5\u4e0b\u6307\u6807\u5c55\u793a\u5f53\u524d\u7684Slow_queries\u7684\u503c\uff1a</p> <pre><code># HELP mysql_global_status_slow_queries Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_slow_queries untyped\nmysql_global_status_slow_queries 0\n</code></pre> <p>\u901a\u8fc7\u76d1\u63a7Slow_queries\u7684\u589e\u957f\u7387\uff0c\u53ef\u4ee5\u53cd\u6620\u51fa\u5f53\u524dMySQL\u670d\u52a1\u5668\u7684\u6027\u80fd\u72b6\u6001\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0bPromQL\u67e5\u8be2Slow_queries\u7684\u589e\u957f\u60c5\u51b5\uff1a</p> <pre><code>rate(mysql_global_status_slow_queries[2m])\n</code></pre> <p>\u5728MySQL\u4e2d\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5response time\u63d2\u4ef6\uff0c\u4ece\u800c\u652f\u6301\u8bb0\u5f55\u67e5\u8be2\u65f6\u95f4\u533a\u95f4\u7684\u7edf\u8ba1\u4fe1\u606f\u3002\u542f\u52a8\u8be5\u529f\u80fd\u540eMySQLD Exporter\u4e5f\u4f1a\u81ea\u52a8\u83b7\u53d6\u5230\u76f8\u5173\u6570\u636e\uff0c\u4ece\u800c\u53ef\u4ee5\u7ec6\u5316MySQL\u67e5\u8be2\u54cd\u5e94\u65f6\u95f4\u7684\u5206\u5e03\u60c5\u51b5\u3002 \u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u81ea\u884c\u5c1d\u8bd5\u3002</p>"},{"location":"exporter/what-is-prometheus-exporter/","title":"Exporter\u662f\u4ec0\u4e48","text":"<p>\u5e7f\u4e49\u4e0a\u8bb2\uff0c\u6240\u6709\u53ef\u4ee5\u5411Prometheus\u63d0\u4f9b\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u88ab\u79f0\u4e3a\u4e00\u4e2aExporter\u3002\u800cExporter\u7684\u4e00\u4e2a\u5b9e\u4f8b\u79f0\u4e3atarget\uff0c\u5982\u4e0b\u6240\u793a\uff0cPrometheus\u901a\u8fc7\u8f6e\u8be2\u7684\u65b9\u5f0f\u5b9a\u671f\u4ece\u8fd9\u4e9btarget\u4e2d\u83b7\u53d6\u6837\u672c\u6570\u636e:</p> <p></p>"},{"location":"exporter/what-is-prometheus-exporter/#exporter_1","title":"Exporter\u7684\u6765\u6e90","text":"<p>\u4eceExporter\u7684\u6765\u6e90\u4e0a\u6765\u8bb2\uff0c\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff1a</p> <ul> <li>\u793e\u533a\u63d0\u4f9b\u7684</li> </ul> <p>Prometheus\u793e\u533a\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684Exporter\u5b9e\u73b0\uff0c\u6db5\u76d6\u4e86\u4ece\u57fa\u7840\u8bbe\u65bd\uff0c\u4e2d\u95f4\u4ef6\u4ee5\u53ca\u7f51\u7edc\u7b49\u5404\u4e2a\u65b9\u9762\u7684\u76d1\u63a7\u529f\u80fd\u3002\u8fd9\u4e9bExporter\u53ef\u4ee5\u5b9e\u73b0\u5927\u90e8\u5206\u901a\u7528\u7684\u76d1\u63a7\u9700\u6c42\u3002\u4e0b\u8868\u5217\u4e3e\u4e00\u4e9b\u793e\u533a\u4e2d\u5e38\u7528\u7684Exporter\uff1a</p> \u8303\u56f4 \u5e38\u7528Exporter \u6570\u636e\u5e93 MySQL Exporter, Redis Exporter, MongoDB Exporter, MSSQL Exporter\u7b49 \u786c\u4ef6 Apcupsd Exporter\uff0cIoT Edison Exporter\uff0c IPMI Exporter, Node Exporter\u7b49 \u6d88\u606f\u961f\u5217 Beanstalkd Exporter, Kafka Exporter, NSQ Exporter, RabbitMQ Exporter\u7b49 \u5b58\u50a8 Ceph Exporter, Gluster Exporter, HDFS Exporter, ScaleIO Exporter\u7b49 HTTP\u670d\u52a1 Apache Exporter, HAProxy Exporter, Nginx Exporter\u7b49 API\u670d\u52a1 AWS ECS Exporter\uff0c Docker Cloud Exporter, Docker Hub Exporter, GitHub Exporter\u7b49 \u65e5\u5fd7 Fluentd Exporter, Grok Exporter\u7b49 \u76d1\u63a7\u7cfb\u7edf Collectd Exporter, Graphite Exporter, InfluxDB Exporter, Nagios Exporter, SNMP Exporter\u7b49 \u5176\u5b83 Blockbox Exporter, JIRA Exporter, Jenkins Exporter\uff0c Confluence Exporter\u7b49 <ul> <li>\u7528\u6237\u81ea\u5b9a\u4e49\u7684</li> </ul> <p>\u9664\u4e86\u76f4\u63a5\u4f7f\u7528\u793e\u533a\u63d0\u4f9b\u7684Exporter\u7a0b\u5e8f\u4ee5\u5916\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u57fa\u4e8ePrometheus\u63d0\u4f9b\u7684Client Library\u521b\u5efa\u81ea\u5df1\u7684Exporter\u7a0b\u5e8f\uff0c\u76ee\u524dPrometheus\u793e\u533a\u5b98\u65b9\u63d0\u4f9b\u4e86\u5bf9\u4ee5\u4e0b\u7f16\u7a0b\u8bed\u8a00\u7684\u652f\u6301\uff1aGo\u3001Java/Scala\u3001Python\u3001Ruby\u3002\u540c\u65f6\u8fd8\u6709\u7b2c\u4e09\u65b9\u5b9e\u73b0\u7684\u5982\uff1aBash\u3001C++\u3001Common Lisp\u3001Erlang,\u3001Haskeel\u3001Lua\u3001Node.js\u3001PHP\u3001Rust\u7b49\u3002</p>"},{"location":"exporter/what-is-prometheus-exporter/#exporter_2","title":"Exporter\u7684\u8fd0\u884c\u65b9\u5f0f","text":"<p>\u4eceExporter\u7684\u8fd0\u884c\u65b9\u5f0f\u4e0a\u6765\u8bb2\uff0c\u53c8\u53ef\u4ee5\u5206\u4e3a\uff1a</p> <ul> <li>\u72ec\u7acb\u4f7f\u7528\u7684</li> </ul> <p>\u4ee5\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u8fc7\u7684Node Exporter\u4e3a\u4f8b\uff0c\u7531\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u5e76\u4e0d\u76f4\u63a5\u652f\u6301Prometheus\uff0c\u540c\u65f6\u7528\u6237\u4e5f\u65e0\u6cd5\u901a\u8fc7\u76f4\u63a5\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u4e0a\u63d0\u4f9b\u5bf9Prometheus\u7684\u652f\u6301\u3002\u56e0\u6b64\uff0c\u7528\u6237\u53ea\u80fd\u901a\u8fc7\u72ec\u7acb\u8fd0\u884c\u4e00\u4e2a\u7a0b\u5e8f\u7684\u65b9\u5f0f\uff0c\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u76f8\u5173\u63a5\u53e3\uff0c\u5c06\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u6001\u6570\u636e\u8f6c\u6362\u4e3a\u53ef\u4f9bPrometheus\u8bfb\u53d6\u7684\u76d1\u63a7\u6570\u636e\u3002 \u9664\u4e86Node Exporter\u4ee5\u5916\uff0c\u6bd4\u5982MySQL Exporter\u3001Redis Exporter\u7b49\u90fd\u662f\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5b9e\u73b0\u7684\u3002 \u8fd9\u4e9bExporter\u7a0b\u5e8f\u626e\u6f14\u4e86\u4e00\u4e2a\u4e2d\u95f4\u4ee3\u7406\u4eba\u7684\u89d2\u8272\u3002</p> <ul> <li>\u96c6\u6210\u5230\u5e94\u7528\u4e2d\u7684</li> </ul> <p>\u4e3a\u4e86\u80fd\u591f\u66f4\u597d\u7684\u76d1\u63a7\u7cfb\u7edf\u7684\u5185\u90e8\u8fd0\u884c\u72b6\u6001\uff0c\u6709\u4e9b\u5f00\u6e90\u9879\u76ee\u5982Kubernetes\uff0cETCD\u7b49\u76f4\u63a5\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86Prometheus\u7684Client Library\uff0c\u63d0\u4f9b\u4e86\u5bf9Prometheus\u7684\u76f4\u63a5\u652f\u6301\u3002\u8fd9\u79cd\u65b9\u5f0f\u6253\u7834\u7684\u76d1\u63a7\u7684\u754c\u9650\uff0c\u8ba9\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u76f4\u63a5\u5c06\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u66b4\u9732\u7ed9Prometheus\uff0c\u9002\u5408\u4e8e\u4e00\u4e9b\u9700\u8981\u66f4\u591a\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u9700\u6c42\u7684\u9879\u76ee\u3002</p>"},{"location":"exporter/what-is-prometheus-exporter/#exporter_3","title":"Exporter\u89c4\u8303","text":"<p>\u6240\u6709\u7684Exporter\u7a0b\u5e8f\u90fd\u9700\u8981\u6309\u7167Prometheus\u7684\u89c4\u8303\uff0c\u8fd4\u56de\u76d1\u63a7\u7684\u6837\u672c\u6570\u636e\u3002\u4ee5Node Exporter\u4e3a\u4f8b\uff0c\u5f53\u8bbf\u95ee/metrics\u5730\u5740\u65f6\u4f1a\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code># HELP node_cpu Seconds the cpus spent in each mode.\n# TYPE node_cpu counter\nnode_cpu{cpu=\"cpu0\",mode=\"idle\"} 362812.7890625\n# HELP node_load1 1m load average.\n# TYPE node_load1 gauge\nnode_load1 3.0703125\n</code></pre> <p>\u8fd9\u662f\u4e00\u79cd\u57fa\u4e8e\u6587\u672c\u7684\u683c\u5f0f\u89c4\u8303\uff0c\u5728Prometheus 2.0\u4e4b\u524d\u7684\u7248\u672c\u8fd8\u652f\u6301Protocol buffer\u89c4\u8303\u3002\u76f8\u6bd4\u4e8eProtocol buffer\u6587\u672c\u5177\u6709\u66f4\u597d\u7684\u53ef\u8bfb\u6027\uff0c\u4ee5\u53ca\u8de8\u5e73\u53f0\u6027\u3002Prometheus 2.0\u7684\u7248\u672c\u4e5f\u5df2\u7ecf\u4e0d\u518d\u652f\u6301Protocol buffer\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5bf9Protocol buffer\u89c4\u8303\u505a\u8be6\u7ec6\u7684\u9610\u8ff0\u3002</p> <p>Exporter\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\uff0c\u4e3b\u8981\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a\u6837\u672c\u7684\u4e00\u822c\u6ce8\u91ca\u4fe1\u606f\uff08HELP\uff09\uff0c\u6837\u672c\u7684\u7c7b\u578b\u6ce8\u91ca\u4fe1\u606f\uff08TYPE\uff09\u548c\u6837\u672c\u3002Prometheus\u4f1a\u5bf9Exporter\u54cd\u5e94\u7684\u5185\u5bb9\u9010\u884c\u89e3\u6790\uff1a</p> <p>\u5982\u679c\u5f53\u524d\u884c\u4ee5# HELP\u5f00\u59cb\uff0cPrometheus\u5c06\u4f1a\u6309\u7167\u4ee5\u4e0b\u89c4\u5219\u5bf9\u5185\u5bb9\u8fdb\u884c\u89e3\u6790\uff0c\u5f97\u5230\u5f53\u524d\u7684\u6307\u6807\u540d\u79f0\u4ee5\u53ca\u76f8\u5e94\u7684\u8bf4\u660e\u4fe1\u606f\uff1a</p> <pre><code># HELP &lt;metrics_name&gt; &lt;doc_string&gt;\n</code></pre> <p>\u5982\u679c\u5f53\u524d\u884c\u4ee5# TYPE\u5f00\u59cb\uff0cPrometheus\u4f1a\u6309\u7167\u4ee5\u4e0b\u89c4\u5219\u5bf9\u5185\u5bb9\u8fdb\u884c\u89e3\u6790\uff0c\u5f97\u5230\u5f53\u524d\u7684\u6307\u6807\u540d\u79f0\u4ee5\u53ca\u6307\u6807\u7c7b\u578b:</p> <pre><code># TYPE &lt;metrics_name&gt; &lt;metrics_type&gt;\n</code></pre> <p>TYPE\u6ce8\u91ca\u884c\u5fc5\u987b\u51fa\u73b0\u5728\u6307\u6807\u7684\u7b2c\u4e00\u4e2a\u6837\u672c\u4e4b\u524d\u3002\u5982\u679c\u6ca1\u6709\u660e\u786e\u7684\u6307\u6807\u7c7b\u578b\u9700\u8981\u8fd4\u56de\u4e3auntyped\u3002 \u9664\u4e86# \u5f00\u5934\u7684\u6240\u6709\u884c\u90fd\u4f1a\u88ab\u89c6\u4e3a\u662f\u76d1\u63a7\u6837\u672c\u6570\u636e\u3002 \u6bcf\u4e00\u884c\u6837\u672c\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u683c\u5f0f\u89c4\u8303:</p> <pre><code>metric_name [\n  \"{\" label_name \"=\" `\"` label_value `\"` { \",\" label_name \"=\" `\"` label_value `\"` } [ \",\" ] \"}\"\n] value [ timestamp ]\n</code></pre> <p>\u5176\u4e2dmetric_name\u548clabel_name\u5fc5\u987b\u9075\u5faaPromQL\u7684\u683c\u5f0f\u89c4\u8303\u8981\u6c42\u3002value\u662f\u4e00\u4e2afloat\u683c\u5f0f\u7684\u6570\u636e\uff0ctimestamp\u7684\u7c7b\u578b\u4e3aint64\uff08\u4ece1970-01-01 00:00:00\u4ee5\u6765\u7684\u6beb\u79d2\u6570\uff09\uff0ctimestamp\u4e3a\u53ef\u9009\u9ed8\u8ba4\u4e3a\u5f53\u524d\u65f6\u95f4\u3002\u5177\u6709\u76f8\u540cmetric_name\u7684\u6837\u672c\u5fc5\u987b\u6309\u7167\u4e00\u4e2a\u7ec4\u7684\u5f62\u5f0f\u6392\u5217\uff0c\u5e76\u4e14\u6bcf\u4e00\u884c\u5fc5\u987b\u662f\u552f\u4e00\u7684\u6307\u6807\u540d\u79f0\u548c\u6807\u7b7e\u952e\u503c\u5bf9\u7ec4\u5408\u3002</p> <p>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\u5bf9\u4e8ehistogram\u548csummary\u7c7b\u578b\u7684\u6837\u672c\u3002\u9700\u8981\u6309\u7167\u4ee5\u4e0b\u7ea6\u5b9a\u8fd4\u56de\u6837\u672c\u6570\u636e\uff1a</p> <ul> <li>\u7c7b\u578b\u4e3asummary\u6216\u8005histogram\u7684\u6307\u6807x\uff0c\u8be5\u6307\u6807\u6240\u6709\u6837\u672c\u7684\u503c\u7684\u603b\u548c\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u5355\u72ec\u7684x_sum\u6307\u6807\u8868\u793a\u3002</li> <li> <p>\u7c7b\u578b\u4e3asummary\u6216\u8005histogram\u7684\u6307\u6807x\uff0c\u8be5\u6307\u6807\u6240\u6709\u6837\u672c\u7684\u603b\u6570\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u5355\u72ec\u7684x_count\u6307\u6807\u8868\u793a\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u7c7b\u578b\u4e3asummary\u7684\u6307\u6807x\uff0c\u5176\u4e0d\u540c\u5206\u4f4d\u6570quantile\u6240\u4ee3\u8868\u7684\u6837\u672c\uff0c\u9700\u8981\u4f7f\u7528\u5355\u72ec\u7684x{quantile=\"y\"}\u8868\u793a\u3002</p> </li> <li>\u5bf9\u4e8e\u7c7b\u578bhistogram\u7684\u6307\u6807x\u4e3a\u4e86\u8868\u793a\u5176\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u6bcf\u4e00\u4e2a\u5206\u5e03\u9700\u8981\u4f7f\u7528x_bucket{le=\"y\"}\u8868\u793a\uff0c\u5176\u4e2dy\u4e3a\u5f53\u524d\u5206\u5e03\u7684\u4e0a\u4f4d\u6570\u3002\u540c\u65f6\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u6837\u672cx_bucket{le=\"+Inf\"}\uff0c\u5e76\u4e14\u5176\u6837\u672c\u503c\u5fc5\u987b\u548cx_count\u76f8\u540c\u3002</li> <li>\u5bf9\u4e8ehistogram\u548csummary\u7684\u6837\u672c\uff0c\u5fc5\u987b\u6309\u7167\u5206\u4f4d\u6570quantile\u548c\u5206\u5e03le\u7684\u503c\u7684\u9012\u589e\u987a\u5e8f\u6392\u5e8f\u3002</li> </ul> <p>\u4ee5\u4e0b\u662f\u7c7b\u578b\u4e3ahistogram\u548csummary\u7684\u6837\u672c\u8f93\u51fa\u793a\u4f8b\uff1a</p> <pre><code># A histogram, which has a pretty complex representation in the text format:\n# HELP http_request_duration_seconds A histogram of the request duration.\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{le=\"0.05\"} 24054\nhttp_request_duration_seconds_bucket{le=\"0.1\"} 33444\nhttp_request_duration_seconds_bucket{le=\"0.2\"} 100392\nhttp_request_duration_seconds_bucket{le=\"+Inf\"} 144320\nhttp_request_duration_seconds_sum 53423\nhttp_request_duration_seconds_count 144320\n\n# Finaly a summary, which has a complex representation, too:\n# HELP rpc_duration_seconds A summary of the RPC duration in seconds.\n# TYPE rpc_duration_seconds summary\nrpc_duration_seconds{quantile=\"0.01\"} 3102\nrpc_duration_seconds{quantile=\"0.05\"} 3272\nrpc_duration_seconds{quantile=\"0.5\"} 4773\nrpc_duration_seconds_sum 1.7560473e+07\nrpc_duration_seconds_count 2693\n</code></pre> <p>\u5bf9\u4e8e\u67d0\u4e9bPrometheus\u8fd8\u6ca1\u6709\u63d0\u4f9b\u652f\u6301\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u7528\u6237\u53ea\u9700\u8981\u6309\u7167\u4ee5\u4e0a\u89c4\u8303\u8fd4\u56de\u54cd\u5e94\u7684\u6587\u672c\u6570\u636e\u5373\u53ef\u3002</p>"},{"location":"exporter/what-is-prometheus-exporter/#_1","title":"\u6307\u5b9a\u6837\u672c\u683c\u5f0f\u7684\u7248\u672c","text":"<p>\u5728Exporter\u54cd\u5e94\u7684HTTP\u5934\u4fe1\u606f\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7Content-Type\u6307\u5b9a\u7279\u5b9a\u7684\u89c4\u8303\u7248\u672c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>HTTP/1.1 200 OK\nContent-Encoding: gzip\nContent-Length: 2906\nContent-Type: text/plain; version=0.0.4\nDate: Sat, 17 Mar 2018 08:47:06 GMT\n</code></pre> <p>\u5176\u4e2dversion\u7528\u4e8e\u6307\u5b9aText-based\u7684\u683c\u5f0f\u7248\u672c\uff0c\u5f53\u6ca1\u6709\u6307\u5b9a\u7248\u672c\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u4f7f\u7528\u6700\u65b0\u683c\u5f0f\u89c4\u8303\u7684\u7248\u672c\u3002\u540c\u65f6HTTP\u54cd\u5e94\u5934\u8fd8\u9700\u8981\u6307\u5b9a\u538b\u7f29\u683c\u5f0f\u4e3agzip\u3002</p>"},{"location":"grafana/","title":"\u7b2c5\u7ae0 \u53ef\u89c6\u5316\u4e00\u5207","text":"<p>\"You can't fix what you can't see\"\u3002\u53ef\u89c6\u5316\u662f\u76d1\u63a7\u7684\u6838\u5fc3\u76ee\u6807\u4e4b\u4e00\uff0c\u5728\u672c\u7ae0\u4e2d\u6211\u4eec\u5c06\u4ecb\u7ecdPrometheus\u4e0b\u7684\u53ef\u89c6\u5316\u6280\u672f\u3002\u4f8b\u5982\uff0cPrometheus\u81ea\u8eab\u63d0\u4f9b\u7684Console Template\u80fd\u529b\u4ee5\u53caGrafana\u8fd9\u4e00\u53ef\u89c6\u5316\u5de5\u5177\u5b9e\u73b0\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316\u3002Prometheus UI\u63d0\u4f9b\u4e86\u57fa\u672c\u7684\u6570\u636e\u53ef\u89c6\u5316\u80fd\u529b\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u76f4\u63a5\u4f7f\u7528PromQL\u67e5\u8be2\u6570\u636e\uff0c\u5e76\u5c06\u6570\u636e\u901a\u8fc7\u53ef\u89c6\u5316\u56fe\u8868\u7684\u65b9\u5f0f\u8fdb\u884c\u5c55\u793a\uff0c\u800c\u5b9e\u9645\u7684\u5e94\u7528\u573a\u666f\u4e2d\u5f80\u5f80\u4e0d\u540c\u7684\u4eba\u5bf9\u4e8e\u53ef\u89c6\u5316\u7684\u9700\u6c42\u4e0d\u4e00\u6837\uff0c\u5173\u6ce8\u7684\u6307\u6807\u4e5f\u4e0d\u4e00\u6837\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u80fd\u591f\u6709\u80fd\u529b\uff0c\u6784\u5efa\u51fa\u4e0d\u540c\u7684\u53ef\u89c6\u5316\u62a5\u8868\u9875\u9762\u3002 \u672c\u7ae0\u5b66\u4e60\u7684\u5185\u5bb9\u5c31\u4e3b\u8981\u89e3\u51b3\u4ee5\u4e0a\u95ee\u9898\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u4f7f\u7528Console Template\u521b\u5efa\u53ef\u89c6\u5316\u9875\u9762</li> <li>\u4f7f\u7528Grafana\u521b\u5efa\u66f4\u7cbe\u7f8e\u7684\u6570\u636e\u4eea\u8868\u76d8</li> </ul>"},{"location":"grafana/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>\"You can't fix what you can't see\"\u3002\u53ef\u89c6\u5316\u662f\u76d1\u63a7\u7684\u6838\u5fc3\u76ee\u6807\u4e4b\u4e00\uff0c\u5728\u672c\u7ae0\u4e2d\u6211\u4eec\u5b66\u4e60\u4e86\u5982\u4f55\u901a\u8fc7Prometheus\u5185\u7f6e\u7684Console Template\u5b9e\u73b0\u57fa\u672c\u7684\u53ef\u89c6\u5316\u80fd\u529b\uff0c\u4ee5\u53ca\u901a\u8fc7\u66f4\u4e13\u4e1a\u7684\u5f00\u6e90\u5de5\u5177Grafana\u5b9e\u73b0Prometheus\u7684\u6570\u636e\u53ef\u89c6\u5316\u3002</p>"},{"location":"grafana/grafana-intro/","title":"Grafana\u7b80\u4ecb","text":"<p>Console Template\u867d\u7136\u80fd\u6ee1\u8db3\u4e00\u5b9a\u7684\u53ef\u89c6\u5316\u9700\u6c42\uff0c\u4f46\u662f\u4e5f\u4ec5\u4ec5\u662f\u5bf9Prometheus\u7684\u57fa\u672c\u80fd\u529b\u7684\u8865\u5145\u3002\u540c\u65f6\u4f7f\u7528\u4e5f\u4f1a\u6709\u8bb8\u591a\u95ee\u9898\uff0c\u9996\u5148\u7528\u6237\u9700\u8981\u5b66\u4e60\u548c\u4e86\u89e3Go Template\u6a21\u677f\u8bed\u8a00\uff0c\u5e76\u4e14\u5176\u652f\u6301\u7684\u53ef\u89c6\u5316\u56fe\u8868\u7c7b\u578b\u4e5f\u975e\u5e38\u6709\u9650\uff0c\u6700\u540e\u5176\u7ba1\u7406\u4e5f\u6709\u4e00\u5b9a\u7684\u6210\u672c\u3002\u5728\u7b2c1\u7ae0\u7684\u201c\u521d\u8bc6Prometheus\u201d\u4e2d\u6211\u4eec\u5df2\u7ecf\u5c1d\u8bd5\u901a\u8fc7Grafana\u5feb\u901f\u642d\u5efa\u8fc7\u4e00\u4e2a\u4e3b\u673a\u76d1\u63a7\u7684Dashboard\uff0c\u5728\u672c\u7ae0\u4e2d\u5c06\u4f1a\u5e26\u6765\u8bfb\u8005\u5b66\u4e60\u5982\u4f55\u4f7f\u7528Grafana\u521b\u5efa\u66f4\u52a0\u7cbe\u7f8e\u7684\u53ef\u89c6\u5316\u62a5\u8868\u3002</p>"},{"location":"grafana/grafana-intro/#grafana_1","title":"Grafana\u57fa\u672c\u6982\u5ff5","text":"<p>\u9996\u5148Grafana\u662f\u4e00\u4e2a\u901a\u7528\u7684\u53ef\u89c6\u5316\u5de5\u5177\u3002\u2018\u901a\u7528\u2019\u610f\u5473\u7740Grafana\u4e0d\u4ec5\u4ec5\u9002\u7528\u4e8e\u5c55\u793aPrometheus\u4e0b\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4e5f\u540c\u6837\u9002\u7528\u4e8e\u4e00\u4e9b\u5176\u4ed6\u7684\u6570\u636e\u53ef\u89c6\u5316\u9700\u6c42\u3002\u5728\u5f00\u59cb\u4f7f\u7528Grafana\u4e4b\u524d\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u660e\u786e\u4e00\u4e9bGrafana\u4e0b\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u4ee5\u5e2e\u52a9\u7528\u6237\u80fd\u591f\u5feb\u901f\u7406\u89e3Grafana\u3002</p>"},{"location":"grafana/grafana-intro/#data-source","title":"\u6570\u636e\u6e90\uff08Data Source\uff09","text":"<p>\b\u5bf9\u4e8eGrafana\u800c\u8a00\uff0cPrometheus\u8fd9\u7c7b\u4e3a\u5176\u63d0\u4f9b\b\u6570\u636e\u7684\u5bf9\u8c61\u5747\u79f0\u4e3a\u6570\u636e\u6e90\uff08Data Source\uff09\u3002\u76ee\u524d\uff0cGrafana\u5b98\u65b9\u63d0\u4f9b\u4e86\u5bf9\uff1aGraphite, InfluxDB, OpenTSDB, Prometheus, Elasticsearch, CloudWatch\u7684\u652f\u6301\u3002\u5bf9\u4e8eGrafana\u7ba1\u7406\u5458\u800c\u8a00\uff0c\u53ea\u9700\u8981\u5c06\u8fd9\u4e9b\u5bf9\u8c61\u4ee5\u6570\u636e\u6e90\u7684\u5f62\u5f0f\u6dfb\u52a0\u5230Grafana\u4e2d\uff0cGrafana\u4fbf\u53ef\u4ee5\u8f7b\u677e\u7684\u5b9e\u73b0\u5bf9\u8fd9\u4e9b\b\u6570\u636e\u7684\u53ef\u89c6\u5316\u5de5\u4f5c\u3002</p>"},{"location":"grafana/grafana-intro/#dashboard","title":"\u4eea\u8868\u76d8\uff08Dashboard\uff09","text":"<p>\u901a\u8fc7\u6570\u636e\u6e90\u5b9a\u4e49\u597d\u53ef\u89c6\u5316\u7684\u6570\u636e\u6765\u6e90\u4e4b\u540e\uff0c\u5bf9\u4e8e\u7528\u6237\u800c\u8a00\u6700\u91cd\u8981\u7684\u4e8b\u60c5\u5c31\u662f\u5b9e\u73b0\u6570\u636e\u7684\u53ef\u89c6\u5316\u3002\u5728Grafana\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7Dashboard\u6765\u7ec4\u7ec7\u548c\u7ba1\u7406\u6211\u4eec\u7684\u6570\u636e\u53ef\u89c6\u5316\u56fe\u8868\uff1a</p> <p></p> <p>\u5982\u4e0a\u6240\u793a\uff0c\u5728\u4e00\u4e2aDashboard\u4e2d\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u53ef\u89c6\u5316\u5355\u5143\u4e3a\u4e00\u4e2aPanel\uff08\u9762\u677f\uff09\uff0cPanel\u901a\u8fc7\u5982\u8d8b\u52bf\u56fe\uff0c\u70ed\u529b\u56fe\u7684\u5f62\u5f0f\u5c55\u793a\u53ef\u89c6\u5316\u6570\u636e\u3002 \u5e76\u4e14\u5728Dashboard\u4e2d\u6bcf\u4e00\u4e2aPanel\u662f\u4e00\u4e2a\u5b8c\u5168\u72ec\u7acb\u7684\u90e8\u5206\uff0c\u901a\u8fc7Panel\u7684Query Editor\uff08\u67e5\u8be2\u7f16\u8f91\u5668\uff09\u6211\u4eec\u53ef\u4ee5\u4e3a\u6bcf\u4e00\u4e2aPanel\u8bbe\u7f6e\u67e5\u8be2\u7684\u6570\u636e\u6e90\u4ee5\u53ca\u6570\u636e\u67e5\u8be2\u65b9\u5f0f\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u4ee5Prometheus\u4f5c\u4e3a\u6570\u636e\u6e90\uff0c\u90a3\u5728Query Editor\u4e2d\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u4f7f\u7528\u7684\u662fPromQL\uff0c\u800cPanel\u5219\u4f1a\u8d1f\u8d23\u4ece\u7279\u5b9a\u7684Prometheus\u4e2d\u67e5\u8be2\u51fa\b\u76f8\u5e94\u7684\u6570\u636e\uff0c\u5e76\u4e14\u5c06\u5176\u53ef\u89c6\u5316\u3002\u7531\u4e8e\u6bcf\u4e2aPanel\u662f\u5b8c\u5168\u72ec\u7acb\u7684\uff0c\u56e0\u6b64\u5728\u4e00\u4e2aDashboard\u4e2d\uff0c\u5f80\u5f80\u53ef\u80fd\u4f1a\u5305\u542b\u6765\u81ea\u591a\u4e2aData Source\u7684\u6570\u636e\u3002</p> <p>Grafana\u901a\u8fc7\u63d2\u4ef6\u7684\u5f62\u5f0f\u63d0\u4f9b\u4e86\u591a\u79cd\b\bPanel\u7684\u5b9e\u73b0\uff0c\u5e38\u7528\u7684\u5982\uff1aGraph Panel\uff0cHeatmap Panel\uff0cSingleStat Panel\u4ee5\u53caTable Panel\u7b49\u3002\u7528\u6237\u8fd8\u53ef\u901a\u8fc7\u63d2\u4ef6\u5b89\u88c5\u66f4\u591a\u7c7b\u578b\u7684Panel\u9762\u677f\u3002</p> <p>\u9664\u4e86Panel\u4ee5\u5916\uff0c\u5728Dashboard\u9875\u9762\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2aRow\uff08\u884c\uff09\uff0c\u6765\u7ec4\u7ec7\u548c\u7ba1\u7406\u4e00\u7ec4\u76f8\u5173\u7684Panel\u3002</p> <p>\u9664\u4e86Panel, Row\u8fd9\u4e9b\u5bf9\u8c61\u4ee5\u5916\uff0cGrafana\u8fd8\u5141\u8bb8\u7528\u6237\u4e3aDashboard\u5b9a\u4e49Templating variables\uff08\u6a21\u677f\u53c2\u6570\uff09\uff0c\u4ece\u800c\u5b9e\u73b0\u53ef\u4ee5\u4e0e\u7528\u6237\u52a8\u6001\u4ea4\u4e92\u7684Dashboard\u9875\u9762\u3002\u540c\u65f6Grafana\u901a\u8fc7JSON\b\u6570\u636e\u7ed3\u6784\u7ba1\u7406\u4e86\u6574\u4e2aDasboard\u7684\u5b9a\u4e49\uff0c\u56e0\u6b64\u8fd9\u4e9bDashboard\u4e5f\u662f\u975e\u5e38\u65b9\u4fbf\u8fdb\u884c\u5171\u4eab\u7684\u3002Grafana\u8fd8\u4e13\u95e8\u4e3aDashboard\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5171\u4eab\u670d\u52a1\uff1ahttps://grafana.com/dashboards\uff0c\u901a\u8fc7\u8be5\u670d\u52a1\u7528\u6237\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0Dashboard\u7684\u5171\u4eab\uff0c\u540c\u65f6\u6211\u4eec\u4e5f\u80fd\u5feb\u901f\u7684\u4ece\u4e2d\u627e\u5230\u6211\u4eec\u5e0c\u671b\u7684Dashboard\u5b9e\u73b0\uff0c\u5e76\b\u5bfc\u5165\u5230\u81ea\u5df1\u7684Grafana\u4e2d\u3002</p>"},{"location":"grafana/grafana-intro/#_1","title":"\u7ec4\u7ec7\u548c\u7528\u6237","text":"<p>\u4f5c\u4e3a\u4e00\u4e2a\u901a\u7528\u53ef\u89c6\u5316\u5de5\u5177\uff0cGrafana\u9664\u4e86\u63d0\u4f9b\u7075\u6d3b\u7684\u53ef\u89c6\u5316\u5b9a\u5236\u80fd\u529b\u4ee5\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u9762\u5411\u4f01\u4e1a\u7684\u7ec4\u7ec7\u7ea7\u7ba1\u7406\u80fd\u529b\u3002\u5728Grafana\u4e2dDashboard\u662f\u5c5e\u4e8e\u4e00\u4e2aOrganization\uff08\u7ec4\u7ec7\uff09\uff0c\u901a\u8fc7Organization\uff0c\u53ef\u4ee5\u5728\u66f4\u5927\u89c4\u6a21\u4e0a\u4f7f\u7528Grafana\uff0c\u4f8b\u5982\u5bf9\u4e8e\u4e00\u4e2a\u4f01\u4e1a\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u591a\u4e2aOrganization\uff0c\u5176\u4e2dUser\uff08\u7528\u6237\uff09\u53ef\u4ee5\u5c5e\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a\u4e0d\u540c\u7684Organization\u3002 \u5e76\u4e14\u5728\u4e0d\u540c\u7684Organization\u4e0b\uff0c\u53ef\u4ee5\u4e3aUser\u8d4b\u4e88\u4e0d\u540c\u7684\u6743\u9650\u3002 \u4ece\u800c\u53ef\u4ee5\u6709\u6548\u7684\u6839\u636e\u4f01\u4e1a\u7684\u7ec4\u7ec7\u67b6\u6784\u5b9a\u4e49\u6574\u4e2a\u7ba1\u7406\u6a21\u578b\u3002</p>"},{"location":"grafana/grafana-panels/","title":"Grafana\u4e0e\u6570\u636e\u53ef\u89c6\u5316","text":"<p>\u5728\u7b2c1\u7ae0\u7684\u201c\u521d\u59cbPrometheus\u201d\u90e8\u5206\uff0c\u6211\u4eec\u5df2\u7ecf\u5e26\u9886\u8bfb\u8005\u5927\u81f4\u4e86\u89e3\u4e86Grafana\u7684\u57fa\u672c\u4f7f\u7528\u65b9\u5f0f\u3002\u5bf9\u4e8eGrafana\u800c\u8a00\uff0cPrometheus\u5c31\u662f\u4e00\u4e2a\u7528\u4e8e\u5b58\u50a8\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u6570\u636e\u6e90\uff08Data Source\uff09\uff0c\u901a\u8fc7\u4f7f\u7528PromQL\u67e5\u8be2\u7279\u5b9aPrometheus\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u5e76\u4e14\u5728Panel\u4e2d\u5b9e\u73b0\u53ef\u89c6\u5316\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5e26\u9886\u8bfb\u8005\u4e86\u89e3\u5982\u4f55\u901a\u8fc7Panel\u521b\u5efa\u7cbe\u7f8e\u7684\u53ef\u89c6\u5316\u56fe\u8868\u3002</p>"},{"location":"grafana/grafana-panels/#panel","title":"\u8ba4\u8bc6\u9762\u677f\uff08Panel\uff09","text":"<p>Panel\u662fGrafana\u4e2d\u6700\u57fa\u672c\u7684\u53ef\u89c6\u5316\u5355\u5143\u3002\u6bcf\u4e00\u79cd\u7c7b\u578b\u7684\u9762\u677f\u90fd\u63d0\u4f9b\u4e86\u76f8\u5e94\u7684\u67e5\u8be2\u7f16\u8f91\u5668(Query Editor)\uff0c\u8ba9\u7528\u6237\u53ef\u4ee5\u4ece\u4e0d\u540c\u7684\u6570\u636e\u6e90\uff08\u5982Prometheus\uff09\u4e2d\u67e5\u8be2\u51fa\u76f8\u5e94\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5e76\u4e14\u4ee5\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u5c55\u73b0\u3002</p> <p>Grafana\u4e2d\u6240\u6709\u7684\u9762\u677f\u5747\u4ee5\u63d2\u4ef6\u7684\u5f62\u5f0f\u8fdb\u884c\u4f7f\u7528\uff0c\u5f53\u524d\u5185\u7f6e\u4e865\u79cd\u7c7b\u578b\u7684\u9762\u677f\uff0c\u5206\u522b\u662f\uff1aGraph\uff0cSinglestat\uff0cHeatmap, Dashlist\uff0cTable\u4ee5\u53caText\u3002</p> <p>\u5176\u4e2d\u50cfGraph\u8fd9\u6837\u7684\u9762\u677f\u5141\u8bb8\u7528\u6237\u53ef\u89c6\u5316\u4efb\u610f\u591a\u4e2a\u76d1\u63a7\u6307\u6807\u4ee5\u53ca\u591a\u6761\u65f6\u95f4\u5e8f\u5217\u3002\u800cSiglestat\u5219\u5fc5\u987b\u8981\u6c42\u67e5\u8be2\u7ed3\u679c\u4e3a\u5355\u4e2a\u6837\u672c\u3002Dashlist\u548cText\u76f8\u5bf9\u6bd4\u8f83\u7279\u6b8a\uff0c\u5b83\u4eec\u4e0e\u7279\u5b9a\u7684\u6570\u636e\u6e90\u65e0\u5173\u3002</p> <p>\u901a\u8fc7Grafana UI\u7528\u6237\u53ef\u4ee5\u5728\u4e00\u4e2aDashboard\u4e0b\u6dfb\u52a0Panel\uff0c\u70b9\u51fbDashboard\u53f3\u4e0a\u89d2\u7684\u201cAdd Panel\u201d\u6309\u94ae\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u5c06\u4f1a\u663e\u793a\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u53ef\u4f7f\u7528\u7684Panel\u7c7b\u578b\uff1a</p> <p></p> <p>\u9009\u62e9\u60f3\u8981\u521b\u5efa\u7684\u9762\u677f\u7c7b\u578b\u5373\u53ef\u3002\u8fd9\u91cc\u4ee5Graph\u9762\u677f\u4e3a\u4f8b\uff0c\u521b\u5efaPanel\u4e4b\u540e\uff0c\u5e76\u5207\u6362\u5230\u7f16\u8f91\u6a21\u5f0f\uff0c\u5c31\u53ef\u4ee5\u8fdb\u5165Panel\u7684\u914d\u7f6e\u9875\u9762\u3002\u5bf9\u4e8e\u4e00\u4e2aPanel\u800c\u8a00\uff0c\u4e00\u822c\u6765\u8bf4\u4f1a\u5305\u542b2\u4e2a\u4e3b\u8981\u7684\u914d\u7f6e\u9009\u9879\uff1aGeneral\uff08\u901a\u7528\u8bbe\u7f6e\uff09\u3001Metrics\uff08\u5ea6\u91cf\u6307\u6807\uff09\u3002\u5176\u4f59\u7684\u914d\u7f6e\u5219\u6839\u636ePanel\u7c7b\u578b\u7684\u4e0d\u540c\u800c\u4e0d\u540c\u3002</p> <p>\u5728\u901a\u7528\u8bbe\u7f6e\u4e2d\uff0c\u9664\u4e86\u4e00\u4e9bPanel\u7684\u57fa\u672c\u4fe1\u606f\u4ee5\u5916\uff0c\u6700\u4e3b\u8981\u7684\u80fd\u529b\u5c31\u662f\u5b9a\u4e49\u52a8\u6001Panel\u7684\u80fd\u529b\uff0c\u8fd9\u90e8\u5206\u5185\u5bb9\u4f1a\u5728\u672c\u7ae0\u7684\u201c\u6a21\u677f\u5316Dashboard\u201d\u5c0f\u7ed3\u4e2d\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u5bf9\u4e8e\u4f7f\u7528Prometheus\u4f5c\u4e3a\u6570\u636e\u6e90\u7684\u7528\u6237\uff0c\u6700\u4e3b\u8981\u7684\u9700\u8981\u4e86\u89e3\u7684\u5c31\u662fMetrics\u8bbe\u7f6e\u7684\u4f7f\u7528\u3002\u5728Metric\u9009\u9879\u4e2d\u53ef\u4ee5\u5b9a\u4e49\u4e86Grafana\u4ece\u54ea\u4e9b\u6570\u636e\u6e90\u4e2d\u67e5\u8be2\u6837\u672c\u6570\u636e\u3002Data Source\u4e2d\u6307\u5b9a\u5f53\u524d\u67e5\u8be2\u7684\u6570\u636e\u6e90\uff0cGrafana\u4f1a\u52a0\u8f7d\u5f53\u524d\u7ec4\u7ec7\u4e2d\u6dfb\u52a0\u7684\u6240\u6709\u6570\u636e\u6e90\u3002\u5176\u4e2d\u8fd8\u4f1a\u5305\u542b\u4e24\u4e2a\u7279\u6b8a\u7684\u6570\u636e\u6e90\uff1aMixed\u548cGrafana\u3002 Mixed\u7528\u4e8e\u9700\u8981\u4ece\u591a\u4e2a\u6570\u636e\u6e90\u4e2d\u67e5\u8be2\u548c\u6e32\u67d3\u6570\u636e\u7684\u573a\u666f\uff0cGrafana\u5219\u7528\u4e8e\u9700\u8981\u67e5\u8be2Grafana\u81ea\u8eab\u72b6\u6001\u65f6\u4f7f\u7528\u3002</p> <p>\u5f53\u9009\u4e2d\u6570\u636e\u6e90\u65f6\uff0cPanel\u4f1a\u6839\u636e\u5f53\u524d\u6570\u636e\u6e90\u7c7b\u578b\u52a0\u8f7d\u4e0d\u540c\u7684Query Editor\u754c\u9762\u3002\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecdPrometheus Query Editor\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u5f53\u9009\u4e2d\u7684\u6570\u636e\u6e90\u7c7b\u578b\u4e3aPrometheus\u65f6\uff0c\u4f1a\u663e\u793a\u5982\u4e0b\u754c\u9762\uff1a</p> <p></p> <p>Grafana\u63d0\u4f9b\u4e86\u5bf9PromQL\u7684\u5b8c\u6574\u652f\u6301\uff0c\u5728Query Editor\u4e2d\uff0c\u53ef\u4ee5\u6dfb\u52a0\u4efb\u610f\u4e2aQuery\uff0c\u5e76\u4e14\u4f7f\u7528PromQL\u8868\u8fbe\u5f0f\u4ecePrometheus\u4e2d\u67e5\u8be2\u76f8\u5e94\u7684\u6837\u672c\u6570\u636e\u3002</p> <pre><code>avg (irate(node_cpu{mode!='idle'}[2m])) without (cpu)\n</code></pre> <p>\u6bcf\u4e2aPromQL\u8868\u8fbe\u5f0f\u90fd\u53ef\u80fd\u8fd4\u56de\u591a\u6761\u65f6\u95f4\u5e8f\u5217\u3002Legend format\u7528\u4e8e\u63a7\u5236\u5982\u4f55\u683c\u5f0f\u5316\u6bcf\u6761\u65f6\u95f4\u5e8f\u5217\u7684\u56fe\u4f8b\u4fe1\u606f\u3002Grafana\u652f\u6301\u901a\u8fc7\u6a21\u677f\u7684\u65b9\u5f0f\uff0c\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u52a8\u6001\u751f\u6210\u56fe\u4f8b\u540d\u79f0\uff0c\u4f8b\u5982\uff1a\u4f7f\u7528{{instance}}\u8868\u793a\u4f7f\u7528\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684instance\u6807\u7b7e\u7684\u503c\u4f5c\u4e3a\u56fe\u4f8b\u540d\u79f0\uff1a</p> <pre><code>{{instance}}-{{mode}}\n</code></pre> <p>\u5f53\u67e5\u8be2\u5230\u7684\u6837\u672c\u6570\u636e\u91cf\u975e\u5e38\u5927\u65f6\u53ef\u4ee5\u5bfc\u81f4Grafana\u6e32\u67d3\u56fe\u6807\u65f6\u51fa\u73b0\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\uff0c\u901a\u8fc7Min Step\u53ef\u4ee5\u63a7\u5236Prometheus\u67e5\u8be2\u6570\u636e\u65f6\u7684\u6700\u5c0f\u6b65\u957f\uff08Step\uff09\uff0c\u4ece\u800c\u51cf\u5c11\u4ecePrometheus\u8fd4\u56de\u7684\u6570\u636e\u91cf\u3002</p> <p>Resolution\u9009\u9879\uff0c\u5219\u53ef\u4ee5\u63a7\u5236Grafana\u81ea\u8eab\u6e32\u67d3\u7684\u6570\u636e\u91cf\u3002\u4f8b\u5982\uff0c\u5982\u679cResolution\u7684\u503c\u4e3a1/10\uff0cGrafana\u4f1a\u5c06Prometeus\u8fd4\u56de\u768410\u4e2a\u6837\u672c\u6570\u636e\u5408\u5e76\u6210\u4e00\u4e2a\u70b9\u3002\u56e0\u6b64Resolution\u8d8a\u5c0f\u53ef\u89c6\u5316\u7684\u7cbe\u786e\u6027\u8d8a\u9ad8\uff0c\u53cd\u4e4b\uff0c\u53ef\u89c6\u5316\u7684\u7cbe\u5ea6\u8d8a\u4f4e\u3002</p> <p>Format as\u9009\u9879\u5b9a\u4e49\u5982\u4f55\u683c\u5f0f\u5316Prometheus\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u3002\u8fd9\u91cc\u63d0\u4f9b\u4e863\u4e2a\u9009\u9879\uff1aTable,Time Series\u548cHeatmap\uff0c\u5206\u522b\u7528\u4e8eTable\u9762\u677f\uff0cGraph\u9762\u677f\u548cHeatmap\u9762\u677f\u7684\u6570\u636e\u53ef\u89c6\u5316\u3002</p> <p>\u9664\u6b64\u4ee5\u5916\uff0cQuery Editor\u8fd8\u63d0\u4f9b\u4e86\u8c03\u8bd5\u76f8\u5173\u7684\u529f\u80fd\uff0c\u70b9\u51fbQuery Inspector\u53ef\u4ee5\u5c55\u5f00\u76f8\u5173\u7684\u8c03\u8bd5\u9762\u677f\uff1a</p> <p></p> <p>\u5728\u9762\u677f\u4e2d\uff0c\u53ef\u4ee5\u67e5\u770b\u5f53\u524dPrometheus\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\uff0c\u7528\u6237\u4e5f\u53ef\u4ee5\u63d0\u4f9bMock\u6570\u636e\b\u6e32\u67d3\u56fe\u50cf\u3002</p>"},{"location":"grafana/templating/","title":"\u6a21\u677f\u5316Dashboard","text":"<p>\u5728\u524d\u9762\u7684\u5c0f\u8282\u4e2d\u4ecb\u7ecd\u4e86Grafana\u4e2d4\u4e2d\u5e38\u7528\u7684\u53ef\u89c6\u5316\u9762\u677f\u7684\u4f7f\u7528\uff0c\u901a\u8fc7\u5728\u9762\u677f\u4e2d\u4f7f\u7528PromQL\u8868\u8fbe\u5f0f\uff0cGrafana\u80fd\u591f\u65b9\u4fbf\u7684\u5c06Prometheus\u8fd4\u56de\u7684\u6570\u636e\u8fdb\u884c\u53ef\u89c6\u5316\u5c55\u793a\u3002\u4f8b\u5982\uff0c\u5728\u5c55\u793a\u4e3b\u673aCPU\u4f7f\u7528\u7387\u65f6\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>1 - (avg(irate(node_cpu{mode='idle'}[5m])) without (cpu))\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fd4\u56de\u5f53\u524dPrometheus\u4e2d\u5b58\u50a8\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\uff0c\u6bcf\u4e00\u53f0\u4e3b\u673a\u90fd\u4f1a\u6709\u4e00\u6761\u5355\u72ec\u7684\u66f2\u7ebf\u7528\u4e8e\u4f53\u73b0\u5176CPU\u4f7f\u7528\u7387\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <p></p> <p>\u800c\u5f53\u7528\u6237\u53ea\u60f3\u5173\u6ce8\u5176\u4e2d\u67d0\u4e9b\u4e3b\u673a\u65f6\uff0c\u57fa\u4e8e\u5f53\u524d\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u5230\u7684\u77e5\u8bc6\u53ea\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u8981\u4e48\u6bcf\u6b21\u624b\u52a8\u4fee\u6539Panel\u4e2d\u7684PromQL\u8868\u8fbe\u5f0f\uff0c\u8981\u4e48\u76f4\u63a5\u4e3a\u8fd9\u4e9b\u4e3b\u673a\u521b\u5efa\u5355\u72ec\u7684Panel\u3002\u4f46\u662f\u65e0\u8bba\u5982\u4f55\uff0c\u8fd9\u4e9b\u786c\u7f16\u7801\u65b9\u5f0f\u90fd\u4f1a\u76f4\u63a5\u5bfc\u81f4Dashboard\u914d\u7f6e\u7684\u9891\u7e41\u4fee\u6539\u3002\u5728\u8fd9\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u5c06\u5b66\u4e60\u4f7f\u7528Dashboard\u53d8\u91cf\u7684\u65b9\u5f0f\u89e3\u51b3\u4ee5\u4e0a\u95ee\u9898\u3002</p>"},{"location":"grafana/templating/#_1","title":"\u53d8\u91cf","text":"<p>\u5728Grafana\u4e2d\u7528\u6237\u53ef\u4ee5\u4e3aDashboard\u5b9a\u4e49\u4e00\u7ec4\u53d8\u91cf\uff08Variables\uff09\uff0c\u53d8\u91cf\u4e00\u822c\u5305\u542b\u4e00\u4e2a\u5230\u591a\u4e2a\u53ef\u9009\u503c\u3002\u5982\u4e0b\u6240\u793a\uff0cGrafana\u901a\u8fc7\u5c06\u53d8\u91cf\u6e32\u67d3\u4e3a\u4e00\u4e2a\u4e0b\u62c9\u6846\u9009\u9879\uff0c\u4ece\u800c\u4f7f\u7528\u6237\u53ef\u4ee5\u52a8\u6001\u7684\u6539\u53d8\u53d8\u91cf\u7684\u503c\uff1a</p> <p></p> <p>\u4f8b\u5982\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3anode\u7684\u53d8\u91cf\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728PromQL\u8868\u8fbe\u5f0f\u6216\u8005Panel\u7684\u6807\u9898\u4e2d\u901a\u8fc7\u4ee5\u4e0b\u5f62\u5f0f\u4f7f\u7528\u8be5\u53d8\u91cf\uff1a</p> <pre><code>1 - (avg(irate(node_cpu{mode='idle', instance=~\"$node\"}[5m])) without (cpu))\n</code></pre> <p>\u53d8\u91cf\u7684\u503c\u53ef\u4ee5\u652f\u6301\u5355\u9009\u6216\u8005\u591a\u9009\uff0c\u5f53\u5bf9\u63a5Prometheus\u65f6\uff0cGrafana\u4f1a\u81ea\u52a8\u5c06$node\u7684\u503c\u683c\u5f0f\u5316\u4e3a\u5982\u201chost1|host2|host3\u201d\u7684\u5f62\u5f0f\u3002\u914d\u5408\u4f7f\u7528PromQL\u7684\u6807\u7b7e\u6b63\u5219\u5339\u914d\u201c=~\u201d\uff0c\u901a\u8fc7\u52a8\u6001\u6539\u53d8PromQL\u4ece\u800c\u5b9e\u73b0\u57fa\u4e8e\u6807\u7b7e\u5feb\u901f\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\u3002</p>"},{"location":"grafana/templating/#_2","title":"\u53d8\u91cf\u5b9a\u4e49","text":"<p>\u901a\u8fc7Dashboard\u9875\u9762\u7684Settings\u9009\u9879\uff0c\u53ef\u4ee5\u8fdb\u5165Dashboard\u7684\u914d\u7f6e\u9875\u9762\u5e76\u4e14\u9009\u62e9Variables\u5b50\u83dc\u5355:</p> <p></p> <p>\u7528\u6237\u9700\u8981\u6307\u5b9a\u53d8\u91cf\u7684\u540d\u79f0\uff0c\u540e\u7eed\u7528\u6237\u5c31\u53ef\u4ee5\u901a\u8fc7$variable_name\u7684\u5f62\u5f0f\u5f15\u7528\u8be5\u53d8\u91cf\u3002Grafana\u76ee\u524d\u652f\u63016\u79cd\u4e0d\u540c\u7684\u53d8\u91cf\u7c7b\u578b\uff0c\u800c\u80fd\u548cPrometheus\u4e00\u8d77\u5de5\u4f5c\u7684\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b5\u79cd\u7c7b\u578b\uff1a</p> \u7c7b\u578b \u5de5\u4f5c\u65b9\u5f0f Query \u5141\u8bb8\u7528\u6237\u901a\u8fc7Datasource\u67e5\u8be2\u8868\u8fbe\u5f0f\u7684\u8fd4\u56de\u503c\u52a8\u6001\u751f\u6210\u53d8\u91cf\u7684\u53ef\u9009\u503c Interval \u8be5\u53d8\u91cf\u4ee3\u8868\u65f6\u95f4\u8de8\u5ea6\uff0c\u901a\u8fc7Interval\u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u52a8\u6001\u6539\u53d8PromQL\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e2d\u7684\u65f6\u95f4\u8303\u56f4\u3002\u5982rate(node_cpu[2m]) Datasource \u5141\u8bb8\u7528\u6237\u52a8\u6001\u5207\u6362\u5f53\u524dDashboard\u7684\u6570\u636e\u6e90\uff0c\u7279\u522b\u9002\u7528\u4e8e\u540c\u4e00\u4e2aDashboard\u5c55\u793a\u591a\u4e2a\u6570\u636e\u6e90\u6570\u636e\u7684\u60c5\u51b5 Custom \u7528\u6237\u76f4\u63a5\u901a\u8fc7\u624b\u52a8\u7684\u65b9\u5f0f\uff0c\u5b9a\u4e49\u53d8\u91cf\u7684\u53ef\u9009\u503c Constant \u5e38\u91cf\uff0c\u5728\u5bfc\u5165Dashboard\u65f6\uff0c\u4f1a\u8981\u6c42\u7528\u6237\u8bbe\u7f6e\u8be5\u5e38\u91cf\u7684\u503c <p>Label\u5c5e\u6027\u7528\u4e8e\u6307\u5b9a\u754c\u9762\u4e2d\u53d8\u91cf\u7684\u663e\u793a\u540d\u79f0\uff0cHide\u5c5e\u6027\u5219\u7528\u4e8e\u6307\u5b9a\u5728\u6e32\u67d3\u754c\u9762\u65f6\u662f\u5426\u9690\u85cf\u8be5\u53d8\u91cf\u7684\u4e0b\u62c9\u6846\u3002</p>"},{"location":"grafana/templating/#_3","title":"\u4f7f\u7528\u53d8\u91cf\u8fc7\u6ee4\u65f6\u95f4\u5e8f\u5217","text":"<p>\u5f53Prometheus\u540c\u65f6\u91c7\u96c6\u4e86\u591a\u4e2a\u4e3b\u673a\u8282\u70b9\u7684\u76d1\u63a7\u6837\u672c\u6570\u636e\u65f6\uff0c\u7528\u6237\u5e0c\u671b\u80fd\u591f\u624b\u52a8\u9009\u62e9\u5e76\u67e5\u770b\u5176\u4e2d\u7279\u5b9a\u4e3b\u673a\u7684\u76d1\u63a7\u6570\u636e\u3002\u8fd9\u65f6\u6211\u4eec\u9700\u8981\u4f7f\u7528Query\u7c7b\u578b\u7684\u53d8\u91cf\u3002</p> <p></p> <p>\u5982\u4e0a\u6240\u793a\uff0c\u8fd9\u91cc\u6211\u4eec\u4e3aDashboard\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3anode\u7684\u53d8\u91cf\uff0c\u5e76\u4e14\u6307\u5b9a\u5176\u7c7b\u578b\u4e3aQuery\u3002Query\u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u5141\u8bb8\u7528\u6237\u6307\u5b9a\u6570\u636e\u6e90\u4ee5\u53ca\u67e5\u8be2\u8868\u8fbe\u5f0f\uff0c\u5e76\u901a\u8fc7\u6b63\u5219\b\u5339\u914d\uff08Regex\uff09\u7684\u65b9\u5f0f\u5bf9\u67e5\u8be2\u7ed3\u679c\u8fdb\u884c\u5904\u7406\uff0c\u4ece\u800c\u52a8\u6001\u751f\u6210\u53d8\u91cf\u7684\u53ef\u9009\u503c\u3002\u5728\u8fd9\u91cc\u6307\u5b9a\u4e86\u6570\u636e\u6e90\u4e3aPrometheus\uff0c\u901a\u8fc7\u4f7f\u7528node_load1\u6211\u4eec\u5f97\u5230\u4e86\u4e24\u6761\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>node_load1{instance=\"foo:9100\",job=\"node\"}\nnode_load1{instance=\"localhost:9100\",job=\"node\"}\n</code></pre> <p>\u901a\u8fc7\u6307\u5b9a\u6b63\u5219\u5339\u914d\u8868\u8fbe\u5f0f\u4e3a<code>/.*instance=\"([^\"]*).*/</code>\u4ece\u800c\u5339\u914d\u51fa\u6807\u7b7einstance\u7684\u503c\u4f5c\u4e3anode\u53d8\u91cf\u7684\u6240\u6709\u53ef\u9009\u9879\uff0c\u5373\uff1a</p> <pre><code>foo:9100\nlocalhost:9100\n</code></pre> <p>Selection Options\u9009\u9879\u4e2d\u53ef\u4ee5\u6307\u5b9a\u8be5\u53d8\u91cf\u7684\u4e0b\u62c9\u6846\u662f\u5426\u652f\u6301\u591a\u9009\uff0c\u4ee5\u53ca\u662f\u5426\u5305\u542b\u5168\u9009\uff08All\uff09\u9009\u9879\u3002</p> <p>\u4fdd\u5b58\u53d8\u91cf\u540e\uff0c\u7528\u6237\u53ef\u4ee5\u5728Panel\u7684General\u6216\u8005Metrics\u4e2d\u901a\u8fc7$node\u7684\u65b9\u5f0f\u4f7f\u7528\u8be5\u53d8\u91cf\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u5141\u8bb8\u7528\u6237\u591a\u9009\u5728PromQL\u8868\u8fbe\u5f0f\u4e2d\u5e94\u8be5\u4f7f\u7528\u6807\u7b7e\u7684\u6b63\u5219\u5339\u914d\u6a21\u5f0f\uff0c\u56e0\u4e3aGrafana\u4f1a\u81ea\u52a8\u5c06\u591a\u4e2a\u9009\u9879\u683c\u5f0f\u5316\u4e3a\u5982\u201cfoo:9100|localhost:9100\u201d\u7684\u5f62\u5f0f\u3002</p> <p>\u4f7f\u7528Query\u7c7b\u578b\u7684\u53d8\u91cf\u80fd\u591f\u6839\u636e\u5141\u8bb8\u7528\u6237\u80fd\u591f\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\u5bf9\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u3002\u5728\u5b9a\u4e49Query\u7c7b\u578b\u53d8\u91cf\u65f6\uff0c\u9664\u4e86\u4f7f\u7528PromQL\u67e5\u8be2\u65f6\u95f4\u5e8f\u5217\u4ee5\u8fc7\u6ee4\u6807\u7b7e\u7684\u65b9\u5f0f\u4ee5\u5916\uff0cGrafana\u8fd8\u63d0\u4f9b\u4e86\u51e0\u4e2a\u6709\u7528\u7684\u51fd\u6570\uff1a</p> \u51fd\u6570 \u4f5c\u7528 label_values(label) \u8fd4\u56dePrometheus\u6240\u6709\u76d1\u63a7\u6307\u6807\u4e2d\uff0c\u6807\u7b7e\u540d\u4e3alabel\u7684\u6240\u6709\u53ef\u9009\u503c label_values(metric, label) \u8fd4\u56dePrometheus\u6240\u6709\u76d1\u63a7\u6307\u6807metric\u4e2d\uff0c\u6807\u7b7e\u540d\u4e3alabel\u7684\u6240\u6709\u53ef\u9009\u503c metrics(metric) \u8fd4\u56de\u6240\u6709\u6307\u6807\u540d\u79f0\u6ee1\u8db3metric\u5b9a\u4e49\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\b\u6307\u6807\u540d\u79f0 query_result(query) \u8fd4\u56deprometheus\u67e5\u8be2\u8bed\u53e5\u7684\u67e5\u8be2\u7ed3\u679c <p>\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u76d1\u63a7Prometheus\u6240\u6709\u91c7\u96c6\u4efb\u52a1\u7684\u72b6\u6001\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\uff0c\u83b7\u53d6\u5f53\u524d\u6240\u6709\u91c7\u96c6\u4efb\u52a1\u7684\u540d\u79f0\uff1a</p> <pre><code>label_values(up, job)\n</code></pre> <p>\u4f8b\u5982\uff0c\u6709\u65f6\u5019\u6211\u4eec\u60f3\u8981\u52a8\u6001\u4fee\u6539\u53d8\u91cf\u67e5\u8be2\u7ed3\u679c\u3002\u6bd4\u5982\u67d0\u4e00\u4e2a\u8282\u70b9\u7ed1\u5b9a\u4e86\u591a\u4e2aip\uff0c\u4e00\u4e2a\u7528\u4e8e\u5185\u7f51\u8bbf\u95ee\uff0c\u4e00\u4e2a\u7528\u4e8e\u5916\u7f51\u8bbf\u95ee\uff0c\u6b64\u65f6prometheus\u91c7\u96c6\u5230\u7684\u6307\u6807\u662f\u5185\u7f51\u7684ip\uff0c\u4f46\u6211\u4eec\u9700\u8981\u7684\u662f\u5916\u7f51ip\u3002\u8fd9\u91cc\u6211\u4eec\u60f3\u8981\u80fd\u5728Grafana\u4e2d\u52a8\u6001\u6539\u53d8\u6807\u7b7e\u503c\uff0c\u8fdb\u884cip\u6bb5\u7684\u66ff\u6362\uff0c\u800c\u907f\u514d\u4eceprometheus\u6216exporter\u4e2d\u4fee\u6539\u91c7\u96c6\u6307\u6807\u3002</p> <p>\u8fd9\u65f6\u9700\u8981\u4f7f\u7528grafana\u7684query_result\u51fd\u6570</p> <pre><code># \u5c0610.10.15.xxx\u6bb5\u7684ip\u5730\u5740\u66ff\u6362\u4e3a10.20.15.xxx\u6bb5 \u6ce8\uff1a\u66ff\u6362\u7aef\u53e3\u540c\u7406\nquery_result(label_replace(kube_pod_info{pod=~\"$pod\"}, \"node\", \"10.20.15.$1\", \"node\", \"10.10.15.(.*)\"))\n</code></pre> <pre><code># \u901a\u8fc7\u6b63\u5219\u4ece\u8fd4\u56de\u7ed3\u679c\u4e2d\u5339\u914d\u51fa\u6240\u9700\u8981\u7684ip\u5730\u5740\nregex\uff1a/.*node=\"(.*?)\".*/\n</code></pre> <p>\u5728grafana\u4e2d\u914d\u7f6e\u5982\u56fe\uff1a </p>"},{"location":"grafana/templating/#panelrow","title":"\u4f7f\u7528\u53d8\u91cf\u52a8\u6001\u521b\u5efaPanel\u548cRow","text":"<p>\u5f53\u5728\u4e00\u4e2aPanel\u4e2d\u5c55\u793a\u591a\u6761\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u65f6\uff0c\u901a\u8fc7\u4f7f\u7528\u53d8\u91cf\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u8fc7\u6ee4\uff0c\u63d0\u9ad8\u7528\u6237\u4ea4\u4e92\u6027\u3002\u9664\u6b64\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u53d8\u91cf\u81ea\u52a8\u751f\u6210Panel\u6216\u8005Row\u3002 \u5982\u4e0b\u6240\u793a\uff0c\u5f53\u9700\u8981\u53ef\u89c6\u5316\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u91c7\u96c6\u4efb\u52a1\u7684\u76d1\u63a7\u4efb\u52a1\u8fd0\u884c\u72b6\u6001\u65f6\uff0c\u7531\u4e8ePrometheus\u7684\u91c7\u96c6\u4efb\u52a1\u914d\u7f6e\u53ef\u80fd\u968f\u65f6\u53d1\u751f\u53d8\u66f4\uff0c\u901a\u8fc7\u786c\u7f16\u7801\u7684\u5f62\u5f0f\u5b9e\u73b0\uff0c\u4f1a\u5bfc\u81f4Dashboard\u914d\u7f6e\u7684\u9891\u7e41\u53d8\u66f4\uff1a</p> <p></p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u8fd9\u91cc\u4e3aDashboard\u5b9a\u4e49\u4e86\u4e00\u904d\u540d\u4e3ajob\u7684\u53d8\u91cf\uff1a</p> <p></p> <p>\u901a\u8fc7\u4f7f\u7528label_values\u51fd\u6570\uff0c\u83b7\u53d6\u5230\u5f53\u524dPrometheus\u76d1\u63a7\u6307\u6807up\u4e2d\u6240\u6709\u53ef\u9009\u7684job\b\u6807\u7b7e\u7684\u503c\uff1a</p> <pre><code>label_values(up, job)\n</code></pre> <p>\u5982\u679c\u53d8\u91cf\u542f\u7528\u4e86Multi-value\u6216\u8005Include All Option\u9009\u9879\u7684\u53d8\u91cf\uff0c\u90a3\u4e48\u5728Panel\u7684General\u9009\u9879\u7684Repeat\u4e2d\u53ef\u4ee5\u9009\u62e9\u81ea\u52a8\u8fed\u4ee3\u7684\u53d8\u91cf\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86Singlestat\u5c55\u793a\u6240\u6709\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\u7684\u72b6\u6001\uff1a</p> <p></p> <p>Repeat\u9009\u9879\u8bbe\u7f6e\u5b8c\u6210\u540e\uff0cGrafana\u4f1a\u6839\u636e\u5f53\u524d\u7528\u6237\u7684\u9009\u62e9\uff0c\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u5230\u591a\u4e2aPanel\u5b9e\u4f8b\u3002 \u4e3a\u4e86\u80fd\u591f\u4f7fSinglestat Panel\u80fd\u591f\u5c55\u793a\u6b63\u786e\u7684\u6570\u636e\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u5728Prometheus\u4e2d\uff0c\u6211\u4eec\u4f9d\u7136\u4f7f\u7528\u4e86$job\u53d8\u91cf\uff0c\u4e0d\u8fc7\u6b64\u65f6\u7684$job\u53cd\u5e94\u7684\u662f\u5f53\u524d\u8fed\u4ee3\u7684\u503c\uff1a</p> <p></p> <p>\u800c\u5982\u679c\u8fd8\u5e0c\u671b\u80fd\u591f\u81ea\u52a8\u751f\u6210Row\uff0c\u53ea\u9700\u8981\u5728Row\u7684\u8bbe\u7f6e\u4e2d\uff0c\u9009\u62e9\u9700\u8981Repeat\u7684\u53d8\u91cf\u5373\u53ef\uff1a</p> <p></p>"},{"location":"grafana/use-console-template/","title":"\u4f7f\u7528Console Template","text":"<p>\u5728\u7b2c1\u7ae0\u4ee5\u53ca\u7b2c2\u7ae0\u7684\u5185\u5bb9\u4e2d\uff0c\u8bfb\u8005\u5df2\u7ecf\u5bf9Prometheus\u5df2\u7ecf\u6709\u4e86\u4e00\u4e2a\u76f8\u5bf9\u5b8c\u6210\u7684\u8ba4\u8bc6\uff0c\u5e76\u4e14\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86\u5982\u4f55\u901a\u8fc7PromQL\u5bf9\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u8fdb\u884c\u67e5\u8be2\u548c\u5206\u6790\uff0c\u5e76\u4e14\u901a\u8fc7Prometheus\u4e2d\u7684Graph\u9762\u677f\u67e5\u8be2\u6570\u636e\u5f62\u6210\u56fe\u8868\u3002\u4f46\u662f\u7f3a\u70b9\u4e5f\u5f88\u660e\u663e\uff0c\u8fd9\u4e9b\u67e5\u8be2\u7ed3\u679c\u90fd\u662f\u4e34\u65f6\u7684\uff0c\u65e0\u6cd5\u6301\u4e45\u5316\u7684\uff0c\u66f4\u522b\u8bf4\u6211\u4eec\u60f3\u5b9e\u65f6\u5173\u6ce8\u67d0\u4e9b\u7279\u5b9a\u76d1\u63a7\u6307\u6807\u7684\u53d8\u5316\u8d8b\u52bf\u3002</p> <p>\u4e3a\u4e86\u7b80\u5316\u8fd9\u4e9b\u95ee\u9898Prometheus\u5185\u7f6e\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6848<code>Console Template</code>,\u5b83\u5141\u8bb8\u7528\u6237\u901a\u8fc7Go\u6a21\u677f\u8bed\u8a00\u521b\u5efa\u4efb\u610f\u7684\u63a7\u5236\u53f0\u754c\u9762\uff0c\u5e76\u4e14\u901a\u8fc7Prometheus Server\u5bf9\u5916\u63d0\u4f9b\u8bbf\u95ee\u8def\u5f84\u3002</p>"},{"location":"grafana/use-console-template/#_1","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u9996\u5148\u6211\u4eec\u5148\u4ece\u4e00\u4e2a\u5c0f\u4f8b\u5b50\u5f00\u59cb\uff0c\u521b\u5efa\u6211\u4eec\u7684\u7b2c\u4e00\u4e2aConsole Template\u9875\u9762\u3002\u4e0eConsole Template\u6709\u5173\u7684\u4e24\u4e2a\u542f\u52a8\u53c2\u6570\u4e3a<code>--web.console.libraries</code>\u548c<code>--web.console.templates</code>,\u5176\u5206\u522b\u6307\u5b9a\u9875\u9762\u7ec4\u4ef6\u4ee5\u53ca\u9875\u9762\u7684\u5b58\u50a8\u8def\u5f84\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5176\u5206\u522b\u6307\u5411Prometheus\u5f53\u524d\u5b89\u88c5\u8def\u5f84\u7684<code>console_libraries</code>\u548c<code>consoles</code>\u76ee\u5f55\u3002</p> <p>Prometheus\u5728<code>console_libraries</code>\u76ee\u5f55\u4e2d\u5df2\u7ecf\u5185\u7f6e\u4e86\u4e00\u4e9b\u57fa\u672c\u7684\u754c\u9762\u7ec4\u4ef6\uff0c\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002</p> <p>\u5728<code>consoles</code>\u76ee\u5f55\u4e0b\u521b\u5efaindex.html\u6587\u4ef6\u540e\uff0c\u5237\u65b0Prometheus\u754c\u9762\u53ef\u4ee5\u770b\u5230\u5728\u9876\u90e8\u83dc\u5355\u4e2d\u591a\u4e86\u4e00\u4e2aConsoles\u83dc\u5355\u9879\uff0c\u5982\u4e0b\u6240\u793a\u3002\u8be5\u9009\u9879\u9ed8\u8ba4\u6307\u5411<code>consoles/index.html</code>\u6587\u4ef6\uff1a</p> <p></p> <p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u65f6\u5019\u70b9\u51fb\u8be5\u83dc\u5355\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e00\u4e2a\u7a7a\u767d\u9875\u3002\u56e0\u4e3a\u76ee\u524dindex.html\u6587\u4ef6\u4e2d\u8fd8\u672a\u586b\u5145\u4efb\u4f55\u5185\u5bb9\uff1a</p>"},{"location":"grafana/use-console-template/#_2","title":"\u5b9a\u4e49\u9875\u9762\u83dc\u5355","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u5148\u76f4\u63a5\u4f7f\u7528console_libraries\u4e2d\u5b9a\u4e49\u7684<code>head</code>\u7ec4\u4ef6\uff0c\u5e76\u52a0\u5165\u5230index.html\u6587\u4ef6\u4e2d\uff1a</p> <pre><code>{{template \"head\" .}}\n</code></pre> <p>\u6b64\u65f6\uff0c\u5982\u679c\u6211\u4eec\u5237\u65b0\u6d4f\u89c8\u5668\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <p></p> <p><code>head</code>\u7ec4\u4ef6\u7684\u5b9a\u4e49\uff0c\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u5173\u952e\u5b57<code>define \"head\"</code>\u5728console_libraries\u76ee\u5f55\u4e2d\u67e5\u627e\u3002\u9ed8\u8ba4\u5176\u5e94\u8be5\u662f\u5b9a\u4e49\u5728<code>prom.lib</code>\u6587\u4ef6\u4e2d\uff1a</p> <pre><code>{{ define \"head\" }}\n&lt;html&gt;\n&lt;head&gt;\n{{ template \"prom_console_head\" }}\n&lt;/head&gt;\n&lt;body&gt;\n{{ template \"navbar\" . }}\n{{ end }}\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5b9a\u5236\u5316\u83dc\u5355\u7684\u5185\u5bb9\uff0c\u90a3\u4e00\u6837\u7684\u8bfb\u8005\u53ea\u9700\u8981\u627e\u5230<code>navbar</code>\u7ec4\u4ef6\u7684\u5b9a\u4e49\u5373\u53ef\u3002\u5f53\u7136\u7528\u6237\u4e5f\u53ef\u4ee5\u521b\u5efa\u81ea\u5df1\u7684\u7ec4\u4ef6\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u5e0c\u671bConsole Template\u9875\u9762\u7684\u83dc\u5355\u4e0ePrometheus UI\u4e00\u81f4\uff0c\u53ea\u9700\u8981\u4fee\u6539navbar\u7ec4\u4ef6\u7684\u5b9a\u4e49\u5373\u53ef\uff0c\u627e\u5230<code>menu.lib</code>\u5e76\u4fee\u6539navbar\u7ec4\u4ef6:</p> <pre><code>{{ define \"navbar\" }}\n&lt;nav class=\"navbar navbar-inverse navbar-static-top\"&gt;\n  &lt;div class=\"container-fluid\"&gt;\n    &lt;!-- Brand and toggle get grouped for better mobile display --&gt;\n    &lt;div class=\"navbar-header\"&gt;\n      &lt;button type=\"button\" class=\"navbar-toggle collapsed\" data-toggle=\"collapse\" data-target=\"#bs-example-navbar-collapse-1\"&gt;\n        &lt;span class=\"sr-only\"&gt;Toggle navigation&lt;/span&gt;\n        &lt;span class=\"icon-bar\"&gt;&lt;/span&gt;\n        &lt;span class=\"icon-bar\"&gt;&lt;/span&gt;\n        &lt;span class=\"icon-bar\"&gt;&lt;/span&gt;\n      &lt;/button&gt;\n      &lt;a class=\"navbar-brand\" href=\"{{ pathPrefix }}/\"&gt;Prometheus&lt;/a&gt;\n    &lt;/div&gt;\n\n    &lt;div class=\"collapse navbar-collapse\" id=\"bs-example-navbar-collapse-1\"&gt;\n      &lt;ul class=\"nav navbar-nav\"&gt;\n        &lt;li&gt;&lt;a href=\"{{ pathPrefix }}/alerts\"&gt;Alerts&lt;/a&gt;&lt;/li&gt;\n        &lt;li&gt;&lt;a href=\"{{ pathPrefix }}/graph\"&gt;Graph&lt;/a&gt;&lt;/li&gt;\n      &lt;/div&gt;\n    &lt;/ul&gt;\n  &lt;/div&gt;\n&lt;/nav&gt;\n{{ end }}\n</code></pre> <p>\u5982\u679c\u4e0d\u9700\u8981\u4fa7\u8fb9\u83dc\u5355\u680f\uff0c\u76f4\u63a5\u5728head\u7ec4\u4ef6\u4e2d\u79fb\u9664<code>{{ template \"menu\" . }}</code>\u90e8\u5206\u5373\u53ef\uff0c\u4fee\u6539\u540e\u5237\u65b0\u9875\u9762\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u65e0\u8bba\u662f<code>.lib</code>\u6587\u4ef6\u8fd8\u662f<code>.html</code>\u6587\u4ef6\u5747\u4f7f\u7528\u4e86Go Template\u7684\u8bed\u8a00\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u81ea\u884c\u5728Go\u8bed\u8a00\u5b98\u7f51\u4e86\u89e3\u66f4\u591a\u5185\u5bb9<code>https://golang.org/pkg/text/template/</code></p>"},{"location":"grafana/use-console-template/#_3","title":"\u5b9a\u4e49\u56fe\u8868","text":"<p>\u5728Console Template\u4e2d\u6211\u4eec\u53ef\u4ee5\u5728\u9875\u9762\u4e2d\u4f7f\u7528\u5185\u7f6e\u7684<code>PromConsole.Graph()</code>\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u901a\u8fc7<code>head</code>\u52a0\u8f7d\u76f8\u5e94\u7684js\u6e90\u7801\uff0c\u5728\u8be5\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u6307\u5b9a\u7279\u5b9a\u7684DOM\u8282\u70b9\u4ee5\u53ca\u76f8\u5e94\u7684PromQL\u8868\u8fbe\u5f0f\uff0c\u5373\u53ef\u5728\u7279\u5b9a\u533a\u57df\u56fe\u5f62\u5316\u663e\u793a\u76f8\u5e94\u7684\u56fe\u8868\u5185\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>&lt;h1&gt;Prometheus HTTP Request Rate&lt;/h1&gt;\n\n&lt;h3&gt;Queries&lt;/h3&gt;\n&lt;div id=\"queryGraph\"&gt;&lt;/div&gt;\n&lt;script&gt;\nnew PromConsole.Graph({\n  node: document.querySelector(\"#queryGraph\"),\n  expr: \"sum(rate(prometheus_http_request_duration_seconds_count{job='prometheus'}[5m]))\",\n  name: \"Queries\",\n  yAxisFormatter: PromConsole.NumberFormatter.humanizeNoSmallPrefix,\n  yHoverFormatter: PromConsole.NumberFormatter.humanizeNoSmallPrefix,\n  yUnits: \"/s\",\n  yTitle: \"Queries\"\n})\n&lt;/script&gt;\n</code></pre> <p>\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2aid\u4e3aqueryGraph\u7684div\u8282\u70b9\uff0c\u901a\u8fc7\u5728\u9875\u9762\u4e2d\u4f7f\u7528PromConsole.Graph\u51fd\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed8\u5236\u51fa\u8868\u8fbe\u5f0f<code>sum(rate(prometheus_http_request_duration_seconds_count{job='prometheus'}[5m]))</code>\u7684\u53ef\u89c6\u5316\u56fe\u8868\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9664\u4e86\u6700\u57fa\u672c\u7684node\u4ee5\u53caexpr\u53c2\u6570\u4ee5\u5916\uff0c\u8be5\u51fd\u6570\u8fd8\u652f\u6301\u7684\u5b8c\u6574\u53c2\u6570\u5982\u4e0b\uff1a</p> \u53c2\u6570\u540d\u79f0 \u4f5c\u7528 expr Required. Expression to graph. Can be a list. node Required. DOM node to render into. duration Optional. Duration of the graph. Defaults to 1 hour. endTime Optional. Unixtime the graph ends at. Defaults to now. width Optional. Width of the graph, excluding titles. Defaults to auto-detection. height Optional. Height of the graph, excluding titles and legends. Defaults to 200 pixels. min Optional. Minimum x-axis value. Defaults to lowest data value. max Optional. Maximum y-axis value. Defaults to highest data value. renderer Optional. Type of graph. Options are line and area (stacked graph). Defaults to line. name Optional. Title of plots in legend and hover detail. If passed a string, [[ label ]] will be substituted with the label value. If passed a function, it will be passed a map of labels and should return the name as a string. Can be a list. xTitle Optional. Title of the x-axis. Defaults to Time. yUnits Optional. Units of the y-axis. Defaults to empty. yTitle Optional. Title of the y-axis. Defaults to empty. yAxisFormatter Optional. Number formatter for the y-axis. Defaults to PromConsole.NumberFormatter.humanize. yHoverFormatter Optional. Number formatter for the hover detail. Defaults to PromConsole.NumberFormatter.humanizeExact. colorScheme Optional. Color scheme to be used by the plots. Can be either a list of hex color codes or one of the color scheme names supported by Rickshaw. Defaults to 'colorwheel'. <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u53c2\u6570<code>expr</code>\u548c<code>name</code>\u5747\u662flist\u7c7b\u578b\uff0c\u5176\u5fc5\u987b\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u3002</p> <p>\u9664\u4e86\u76f4\u63a5\u4f7f\u7528<code>PromConsole.Graph</code>\u51fd\u6570\u663e\u793a\u53ef\u89c6\u5316\u56fe\u8868\u4ee5\u5916\uff0c\u5728Console Template\u4e2d\u8fd8\u53ef\u4ee5\u4f7f\u7528\u6a21\u677f\u7ec4\u4ef6<code>prom_query_drilldown</code>\u5b9a\u4e49\u4e00\u4e2a\u8fde\u63a5\u76f4\u63a5\u8df3\u8f6c\u5230Graph\u9875\u9762\uff0c\u5e76\u663e\u793a\u76f8\u5e94\u8868\u8fbe\u5f0f\u7684\u67e5\u8be2\u7ed3\u679c\uff0c \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>&lt;h3&gt;Links&lt;/h3&gt;\n{{ template \"prom_query_drilldown\" (args \"prometheus_http_response_size_bytes_bucket\") }}\n</code></pre> <p>\u9664\u4e86\u4ee5\u4e0a\u90e8\u5206\u4ee5\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u548c\u539f\u751fPrometheus UI\u4e00\u6837\u5b9a\u4e49\u4e00\u4e2a\u65f6\u95f4\u8f74\u63a7\u5236\u5668\uff0c\u65b9\u4fbf\u7528\u6237\u6309\u9700\u67e5\u8be2\u6570\u636e\uff1a</p> <p></p> <p>\u52a0\u5165\u8fd9\u4e2a\u65f6\u95f4\u8f74\u63a7\u5236\u5668\u7684\u65b9\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u76f4\u63a5\u5f15\u7528\u4ee5\u4e0b\u6a21\u677f\u5373\u53ef\uff1a</p> <pre><code>{{ template \"prom_graph_timecontrol\" . }}\n</code></pre>"},{"location":"grafana/use_graph_panel/","title":"\u53d8\u5316\u8d8b\u52bf\uff1aGraph\u9762\u677f","text":"<p>Graph\u9762\u677f\u662f\u6700\u5e38\u7528\u7684\u4e00\u79cd\u53ef\u89c6\u5316\u9762\u677f\uff0c\u5176\u901a\u8fc7\u6298\u7ebf\u56fe\u6216\u8005\u67f1\u72b6\u56fe\u7684\u5f62\u5f0f\u663e\u793a\u76d1\u63a7\u6837\u672c\u968f\u65f6\u95f4\u800c\u53d8\u5316\u7684\u8d8b\u52bf\u3002Graph\u9762\u677f\u5929\u751f\u9002\u7528\u4e8ePrometheus\u4e2dGauge\u548cCounter\u7c7b\u578b\u76d1\u63a7\u6307\u6807\u7684\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316\u3002\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u67e5\u770b\u4e3b\u673aCPU\u3001\u5185\u5b58\u4f7f\u7528\u7387\u7684\u968f\u65f6\u95f4\u53d8\u5316\u7684\u60c5\u51b5\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528Graph\u9762\u677f\u3002\u540c\u65f6\uff0cGraph\u8fd8\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u652f\u6301\u591a\u4e2a\u6570\u636e\u4e4b\u95f4\u7684\u5bf9\u6bd4\u3002</p> <p></p>"},{"location":"grafana/use_graph_panel/#graphprometheus","title":"Graph\u9762\u677f\u4e0ePrometheus","text":"<p>Graph\u9762\u677f\u901a\u8fc7\u6298\u7ebf\u56fe\u6216\u8005\u67f1\u72b6\u56fe\u7684\u5f62\u5f0f\uff0c\u80fd\u591f\u5c55\u793a\u76d1\u63a7\u6837\u672c\u6570\u636e\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u53d8\u5316\u8d8b\u52bf\uff0c\u56e0\u6b64\u5176\u5929\u751f\u9002\u5408Prometheus\u4e2d\u7684Counter\u548cGauge\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u7684\u53ef\u89c6\u5316\uff0c\u5bf9\u4e8eHistogram\u7c7b\u578b\u7684\u6307\u6807\u4e5f\u53ef\u4ee5\u652f\u6301\uff0c\u4e0d\u8fc7\u53ef\u89c6\u5316\u6548\u679c\u4e0d\u5982Heatmap Panel\u6765\u7684\u76f4\u89c2\u3002</p>"},{"location":"grafana/use_graph_panel/#graphcountergauge","title":"\u4f7f\u7528Graph\u9762\u677f\u53ef\u89c6\u5316Counter/Gauge","text":"<p>\u4ee5\u4e3b\u673a\u4e3a\u4f8b\uff0c\bCPU\u4f7f\u7528\u7387\u7684\u53d8\u5316\u8d8b\u52bf\u5929\u7136\u9002\u7528\u4e8e\u4f7f\u7528Grapn\u9762\u677f\u6765\u8fdb\u884c\u5c55\u793a\uff1a</p> <p></p> <p>\u5728Metrics\u9009\u9879\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0bPromQL\u5b9a\u4e49\b\u5982\u4f55\u4ecePrometheus\u4e2d\u8bfb\u53d6\u6570\u636e\uff1a</p> <pre><code>1 - (avg(irate(node_cpu{mode='idle'}[5m])) without (cpu))\n</code></pre> <p>\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6839\u636e\u5f53\u524dPrometheus\u7684\u6570\u636e\u91c7\u96c6\u60c5\u51b5\uff0c\u8be5PromQL\u4f1a\u8fd4\u56de\u591a\u6761\u65f6\u95f4\u5e8f\u5217\uff08\u5728\u793a\u4f8b\u4e2d\u4f1a\u8fd4\u56de3\u6761\uff09\u3002Graph\u9762\u677f\u4f1a\u4ece\u65f6\u95f4\u5e8f\u5217\u4e2d\u83b7\u53d6\u6837\u672c\u6570\u636e\uff0c\u5e76\u7ed8\u5236\u5230\u56fe\u8868\u4e2d\u3002 \u4e3a\u4e86\u8ba9\u6298\u7ebf\u56fe\u6709\u66f4\u597d\u7684\u53ef\u8bfb\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5b9a\u4e49Legend format\u4e3a<code>{{ instance }}</code>\u63a7\u5236\u6bcf\u6761\u7ebf\u7684\u56fe\u4f8b\u540d\u79f0\uff1a</p> <p></p> <p>\u7531\u4e8e\u5f53\u524d\u4f7f\u7528\u7684PromQL\u7684\u6570\u636e\u8303\u56f4\u4e3a0~1\u8868\u793aCPU\u7684\u4f7f\u7528\u7387\uff0c\u4e3a\u4e86\u80fd\u591f\u66f4\u6709\u6548\u7684\u8868\u8fbe\u51fa\u5ea6\u91cf\u5355\u4f4d\u7684\u6982\u5ff5\uff0c\u6211\u4eec\u9700\u8981\u5bf9Graph\u56fe\u8868\u7684\u5750\u6807\u8f74\u663e\u793a\u8fdb\u884c\u4f18\u5316\u3002\u5982\u4e0b\u6240\u793a\uff0c\u5728Axes\u9009\u9879\u4e2d\u53ef\u4ee5\u63a7\u5236\u56fe\u6807\u7684X\u8f74\u548cY\u8f74\u76f8\u5173\u7684\u884c\u4e3a\uff1a</p> <p></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cY\u8f74\u4f1a\u76f4\u63a5\u663e\u793a\u5f53\u524d\u6837\u672c\u7684\u503c\uff0c\u901a\u8fc7Left Y\u7684Unit\u53ef\u4ee5\u8ba9Graph\u9762\u677f\u81ea\u52a8\u683c\u5f0f\u5316\u6837\u672c\u503c\u3002\u5f53\u524d\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u5f53\u524d\u4e3b\u673aCPU\u4f7f\u7528\u7387\u7684\u5c0f\u6570\u8868\u793a\uff0c\u56e0\u6b64\uff0c\u8fd9\u91cc\u9009\u62e9\u5355\u4f4d\u4e3apercent(0.0.-1.0)\u3002\u9664\u4e86\u767e\u5206\u6bd4\u4ee5\u5916\uff0cGraph\u9762\u677f\u652f\u6301\u5982\u65e5\u671f\u3001\u8d27\u5e01\u3001\u91cd\u91cf\u3001\u9762\u79ef\u7b49\u5404\u79cd\u7c7b\u578b\u5355\u4f4d\u7684\u81ea\u52a8\u6362\u7b97\uff0c\u7528\u6237\u6839\u636e\u81ea\u5df1\u5f53\u524d\u6837\u672c\u7684\u503c\u542b\u4e49\u9009\u62e9\u5373\u53ef\u3002</p> <p>\u9664\u4e86\u5728Metrics\u8bbe\u7f6e\u56fe\u4f8b\u7684\u663e\u793a\u540d\u79f0\u4ee5\u5916\uff0c\u5728Graph\u9762\u677f\u7684Legend\u9009\u9879\u53ef\u4ee5\u8fdb\u4e00\u6b65\u63a7\u5236\u56fe\u4f8b\u7684\u663e\u793a\u65b9\u5f0f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>Options\u4e2d\u53ef\u4ee5\u8bbe\u7f6e\u56fe\u4f8b\u7684\u663e\u793a\u65b9\u5f0f\u4ee5\u53ca\u5c55\u793a\u4f4d\u7f6e\uff0cValues\u4e2d\u53ef\u4ee5\u8bbe\u7f6e\u662f\u5426\u663e\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u6700\u5c0f\u503c\uff0c\u5e73\u5747\u503c\u7b49\u3002 Decimals\u7528\u4e8e\u914d\u7f6e\u8fd9\u4e9b\u503c\u663e\u793a\u65f6\u4fdd\u7559\u7684\u5c0f\u6570\u4f4d\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9664\u4e86\u4ee5\u4e0a\u8bbe\u7f6e\u4ee5\u5916\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u5bf9\u56fe\u8868\u8fdb\u884c\u4e00\u4e9b\u66f4\u9ad8\u7ea7\u7684\u5b9a\u5236\u5316\uff0c\u4ee5\u4fbf\u80fd\u591f\u66f4\u76f4\u89c2\u7684\u4ece\u53ef\u89c6\u5316\u56fe\u8868\u4e2d\u83b7\u53d6\u4fe1\u606f\u3002\u5728Graph\u9762\u677f\u4e2dDisplay\u9009\u9879\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5b9e\u73b0\u66f4\u591a\u7684\u53ef\u89c6\u5316\u5b9a\u5236\u7684\u80fd\u529b\uff0c\u5176\u4e2d\u5305\u542b\u4e09\u4e2a\u90e8\u5206\uff1aDraw options\u3001Series overrides\u548cThresholds\u3002</p> <p></p> <p>Draw Options\u7528\u4e8e\u8bbe\u7f6e\u5f53\u524d\u56fe\u6807\u7684\u5c55\u793a\u5f62\u5f0f\u3001\u6837\u5f0f\u4ee5\u53ca\u4ea4\u4e92\u63d0\u793a\u884c\u4e3a\u3002\u5176\u4e2d\uff0cDraw Modes\u7528\u4e8e\u63a7\u5236\u56fe\u5f62\u5c55\u793a\u5f62\u5f0f\uff1aBar\uff08\u67f1\u72b6\uff09\u3001Lines\uff08\u7ebf\u6761\uff09\u3001Points\uff08\u70b9\uff09\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u540c\u65f6\u542f\u7528\u591a\u79cd\u6a21\u5f0f\u3002Mode Options\u5219\u8bbe\u7f6e\u5404\u4e2a\u5c55\u793a\u6a21\u5f0f\u4e0b\u7684\u76f8\u5173\u6837\u5f0f\u3002Hover tooltip\u7528\u4e8e\u63a7\u5236\u5f53\u9f20\u6807\u79fb\u52a8\u5230\u56fe\u5f62\u65f6\uff0c\u663e\u793a\u63d0\u793a\u6846\u4e2d\u7684\u5185\u5bb9\u3002</p> <p>\u5982\u679c\u5e0c\u671b\u5f53\u524d\u56fe\u8868\u4e2d\u7684\u65f6\u95f4\u5e8f\u5217\u4ee5\u4e0d\u540c\u7684\u5f62\u5f0f\u5c55\u793a\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7Series overrides\u63a7\u5236\uff0c\u987e\u540d\u601d\u4e49\uff0c\u53ef\u4ee5\u4e3a\u6307\u5b9a\u7684\u65f6\u95f4\u5e8f\u5217\u6307\u5b9a\u81ea\u5b9a\u4e49\u7684Draw Options\u914d\u7f6e\uff0c\u4ece\u800c\u8ba9\u5176\u4ee5\u4e0d\u540c\u7684\u6837\u5f0f\u5c55\u793a\u3002\u4f8b\u5982\uff1a</p> <p></p> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u6761\u81ea\u5b9a\u4e49\u89c4\u5219\uff0c\u5176\u5339\u914d\u56fe\u4f8b\u540d\u79f0\u6ee1\u8db3/localhost/\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5e76\u5b9a\u4e49\u5176\u4ee5\u70b9\u7684\u5f62\u5f0f\u663e\u793a\u5728\u56fe\u8868\u4e2d\uff0c\u4fee\u6539\u540e\u7684\u56fe\u6807\u663e\u793a\u6548\u679c\u5982\u4e0b\uff1a</p> <p></p> <p>Display\u9009\u9879\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\u662fThresholds\uff0cThreshold\u4e3b\u8981\u7528\u4e8e\u4e00\u4e9b\u81ea\u5b9a\u4e49\u4e00\u4e9b\u6837\u672c\u7684\u9608\u503c\uff0c\u4f8b\u5982\uff0c\u5b9a\u4e49\u4e00\u4e2aThreshold\u89c4\u5219\uff0c\u5982\u679cCPU\u8d85\u8fc750%\u7684\u533a\u57df\u663e\u793a\u4e3awarning\u72b6\u6001\uff0c\u53ef\u4ee5\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <p></p> <p>Graph\u9762\u677f\u5219\u4f1a\u5728\b\u56fe\u8868\u4e2d\u663e\u793a\u4e00\u6761\u9608\u503c\uff0c\u5e76\u4e14\u5c06\u6240\u6709\u9ad8\u4e8e\u8be5\u9608\u503c\u7684\u533a\u57df\u663e\u793a\u4e3awarining\u72b6\u6001\uff0c\u901a\u8fc7\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u76f4\u89c2\u7684\u5728\u56fe\u8868\u4e2d\u663e\u793a\u4e00\u4e9b\u53ef\u80fd\u51fa\u73b0\u5f02\u5e38\u7684\u533a\u57df\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u7528\u6237\u4e3a\u8be5\u56fe\u8868\u81ea\u5b9a\u4e49\u4e86Alert\uff08\u544a\u8b66\uff09\u914d\u7f6e\uff0cThresholds\u5c06\u4f1a\u88ab\u8b66\u7528\uff0c\u5e76\u4e14\u6839\u636eAlert\u4e2d\u5b9a\u4e49\u7684Threshold\u5728\u56fe\u5f62\u4e2d\u663e\u793a\u9608\u503c\u5185\u5bb9\u3002\u5173\u4e8eAlert\u7684\u4f7f\u7528\u4f1a\u5728\u540e\u7eed\u90e8\u5206\uff0c\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>"},{"location":"grafana/use_graph_panel/#graphhistogram","title":"\u4f7f\u7528Graph\u9762\u677f\u53ef\u89c6\u5316Histogram","text":"<p>\u4ee5Prometheus\u81ea\u8eab\u7684\u76d1\u63a7\u6307\u6807prometheus_tsdb_compaction_duration\u4e3a\u4f8b\uff0c\u8be5\u76d1\u63a7\u6307\u6807\u8bb0\u5f55\u4e86Prometheus\u8fdb\u884c\u6570\u636e\u538b\u7f29\u4efb\u52a1\u7684\u8fd0\u884c\u8017\u65f6\u7684\u5206\u5e03\u7edf\u8ba1\u60c5\u51b5\u3002\u5982\u4e0b\u6240\u793a\uff0c\u662fPrometheus\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\uff1a</p> <pre><code># HELP prometheus_tsdb_compaction_duration Duration of compaction runs.\n# TYPE prometheus_tsdb_compaction_duration histogram\nprometheus_tsdb_compaction_duration_bucket{le=\"1\"} 2\nprometheus_tsdb_compaction_duration_bucket{le=\"2\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"4\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"8\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"16\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"32\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"64\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"128\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"256\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"512\"} 36\nprometheus_tsdb_compaction_duration_bucket{le=\"+Inf\"} 36\nprometheus_tsdb_compaction_duration_sum 51.31017077500001\nprometheus_tsdb_compaction_duration_count 36\n</code></pre> <p>\u5728\u7b2c2\u7ae0\u7684\u201cMetric\u7c7b\u578b\u201d\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u4ecb\u7ecd\u8fc7Histogram\u7684\u6307\u6807\uff0cHistogram\u7528\u4e8e\u7edf\u8ba1\u6837\u672c\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u5176\u4e2d\u6807\u7b7ele\u5b9a\u4e49\u4e86\u5206\u5e03\u6876Bucket\u7684\u8fb9\u754c\uff0c\u5982\u4e0a\u6240\u793a\uff0c\u8868\u793a\u5f53\u524dPrometheus\u5171\u8fdb\u884c\u4e8636\u6b21\u6570\u636e\u538b\u7f29\uff0c\u603b\u8017\u65f6\u4e3a51.31017077500001ms\u3002\u5176\u4e2d\u4efb\u52a1\u8017\u65f6\u57280~1ms\u533a\u95f4\u5185\u7684\u4e3a2\u6b21\u3001\u57280~2ms\u533a\u95f4\u8303\u56f4\u5185\u4e3a36\u6b21\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u5982\u679c\u9700\u8981\u5728Graph\u4e2d\u663e\u793aHistogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u9700\u8981\u5728Query Editor\u4e2d\u5b9a\u4e49\u67e5\u8be2\u7ed3\u679c\u7684Format as\u4e3aHeatmap\u3002\u901a\u8fc7\u8be5\u8bbe\u7f6eGrafana\u4f1a\u81ea\u52a8\u8ba1\u7b97Histogram\u4e2d\u7684Bucket\u8fb9\u754c\u8303\u56f4\u4ee5\u53ca\u8be5\u8303\u56f4\u5185\u7684\u503c\uff1a</p> <p></p> <p>Graph\u9762\u677f\u91cd\u65b0\u8ba1\u7b97\u4e86Bucket\u8fb9\u754c\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u57280~1ms\u8303\u56f4\u5185\u7684\u4efb\u52a1\u6b21\u6570\u4e3a2\uff0c\u57281~2ms\u8303\u56f4\u5185\u7684\u8fd0\u884c\u4efb\u52a1\u6b21\u6570\u4e3a34\u3002\u901a\u8fc7\u56fe\u5f62\u7684\u9762\u79ef\uff0c\u53ef\u4ee5\u53cd\u6620\u51fa\u5404\u4e2aBucket\u4e0b\u7684\u5927\u81f4\u6570\u636e\u5206\u5e03\u60c5\u51b5\uff1a</p> <p></p> <p>\u4e0d\u8fc7\u901a\u8fc7Graph\u9762\u677f\u5c55\u793aHistogram\u4e5f\u5e76\u4e0d\u592a\u76f4\u89c2\uff0c\u5176\u5e76\u4e0d\u80fd\u76f4\u63a5\u53cd\u6620\u51faBucket\u7684\b\u5927\u5c0f\u4ee5\u53ca\u5206\u5e03\u60c5\u51b5\uff0c\u56e0\u6b64\u5728Grafana V5\u7248\u672c\u4ee5\u540e\u66f4\u63a8\u8350\u4f7f\u7528Heatmap\u9762\u677f\u7684\u65b9\u5f0f\u5c55\u793aHistogram\u6837\u672c\u6570\u636e\u3002\u5173\u4e8eHeatmap\u9762\u677f\u7684\u4f7f\u7528\u5c06\u4f1a\u5728\u63a5\u4e0b\u6765\u7684\u90e8\u5206\u4ecb\u7ecd\u3002</p>"},{"location":"grafana/use_heatmap_panel/","title":"\u5206\u5e03\u7edf\u8ba1\uff1aHeatmap\u9762\u677f","text":"<p>Heatmap\u662fGrafana v4.3\u7248\u672c\u4ee5\u540e\u65b0\u6dfb\u52a0\u7684\u53ef\u89c6\u5316\u9762\u677f\uff0c\u901a\u8fc7\u70ed\u56fe\u53ef\u4ee5\u76f4\u89c2\u7684\u67e5\u770b\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002\u5728Grafana v5.1\u7248\u672c\u4e2dHeatmap\u5b8c\u5584\u4e86\u5bf9Prometheus\u7684\u652f\u6301\u3002\u8fd9\u90e8\u5206\uff0c\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Heatmap Panel\u5b9e\u73b0\u5bf9Prometheus\u76d1\u63a7\u6307\u6807\u7684\u53ef\u89c6\u5316\u3002</p>"},{"location":"grafana/use_heatmap_panel/#heatmaphistogram","title":"\u4f7f\u7528Heatmap\u53ef\u89c6\u5316Histogram\u6837\u672c\u5206\u5e03\u60c5\u51b5","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u4f7f\u7528Graph\u9762\u677f\u6765\u53ef\u89c6\u5316Histogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807prometheus_tsdb_compaction_duration_bucket\u3002\u867d\u7136\u80fd\u5c55\u793a\u5404\u4e2aBucket\u533a\u95f4\u5185\u7684\u6837\u672c\u5206\u5e03\uff0c\u4f46\u662f\u65e0\u8bba\u662f\u4ee5\u7ebf\u56fe\u8fd8\u662f\u67f1\u72b6\u56fe\u7684\u5f62\u5f0f\u5c55\u793a\uff0c\u90fd\u4e0d\u591f\u76f4\u89c2\u3002\u5bf9\u4e8eHistogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u6765\u8bf4\uff0c\u66f4\u597d\u7684\u9009\u62e9\u662f\u91c7\u7528Heatmap Panel\uff0c\u5982\u4e0b\u6240\u793a\uff0cHeatmap Panel\u53ef\u4ee5\u81ea\u52a8\u5bf9Histogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u5206\u5e03\u60c5\u51b5\u8fdb\u884c\u8ba1\u5212\uff0c\u83b7\u53d6\u5230\u6bcf\u4e2a\u533a\u95f4\u8303\u56f4\u5185\u7684\u6837\u672c\u4e2a\u6570\uff0c\u5e76\u4e14\u4ee5\b\u989c\u8272\u7684\u6df1\u6d45\u6765\u8868\u793a\u5f53\u524d\u533a\u95f4\u5185\u6837\u672c\u4e2a\u6570\u7684\u5927\u5c0f\u3002\u800c\u56fe\u5f62\u7684\u9ad8\u5ea6\uff0c\u5219\u53cd\u6620\u51fa\u5f53\u524d\u65f6\u95f4\u70b9\uff0c\u6837\u672c\u5206\u5e03\u7684\u79bb\u6563\u7a0b\u5ea6\u3002</p> <p></p> <p>\u5728Grafana\u4e2d\u4f7f\u7528Heatmap Panel\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u5728Dashboard\u9875\u9762\u53f3\u4e0a\u89d2\u83dc\u5355\u4e2d\u70b9\u51fb\u201cadd panel\u201d\u6309\u94ae\uff0c\u5e76\u9009\u62e9Heatmap Panel\u5373\u53ef\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0cHeapmap Panel\u7684\u7f16\u8f91\u9875\u9762\u4e2d\uff0c\u4e3b\u8981\u5305\u542b5\u7c7b\u914d\u7f6e\u9009\u9879\uff0c\u5206\u522b\u662f\uff1aGeneral\u3001Metrics\u3001Axes\u3001Display\u3001Time range\u3002</p> <p></p> <p>\u5176\u4e2d\u5927\u90e8\u5206\u7684\u914d\u7f6e\u9009\u9879\u4e0eGraph\u9762\u677f\u57fa\u672c\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd9\u91cc\u5c31\u4e0d\u91cd\u590d\u4ecb\u7ecd\u4e86\u3002</p> <p>\u5f53\u4f7f\u7528Heatmap\u53ef\u89c6\u5316Histogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u65f6\uff0c\b\u9700\u8981\u8bbe\u7f6eFormat as\u9009\u9879\u4e3aHeatmap\u3002\u5f53\u4f7f\u7528Heatmap\u683c\u5f0f\u5316\u6570\u636e\u540e\uff0cGrafana\u4f1a\u81ea\u52a8\u6839\u636e\u6837\u672c\u7684\b\u4e2d\u7684le\u6807\u7b7e\uff0c\u8ba1\u7b97\u5404\u4e2aBucket\u6876\u5185\u7684\u5206\u5e03\uff0c\u5e76\u4e14\u6309\u7167Bucket\u5bf9\u6570\u636e\u8fdb\u884c\u91cd\u65b0\u6392\u5e8f\u3002Legend format\u6a21\u677f\u5219\u5c06\u4f1a\u63a7\u5236Y\u8f74\u4e2d\u7684\u663e\u793a\u5185\u5bb9\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cHeatmap Panel\u4f1a\u81ea\u884c\u5bf9PromQL\u67e5\u8be2\u51fa\u7684\u6570\u636e\u8fdb\u884c\u5206\u5e03\u60c5\u51b5\u7edf\u8ba1\uff0c\u800c\u5728Prometheus\u4e2dHistogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u5176\u5b9e\u662f\u5df2\u7ecf\u81ea\u5e26\u4e86\u5206\u5e03\u7684Bucket\u4fe1\u606f\u7684\uff0c\u56e0\u6b64\u4e3a\u4e86\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9bBucket\u4fe1\u606f\uff0c\u6211\u4eec\u9700\u8981\u5728Axes\u9009\u9879\u4e2d\u5b9a\u4e49\u6570\u636e\u7684Date format\u9700\u8981\u5b9a\u4e49\u4e3aTime series buckets\u3002\u8be5\u9009\u9879\u8868\u793aHeatmap Panel\u4e0d\u9700\u8981\u81ea\u8eab\u5bf9\u6570\u636e\b\u7684\u5206\u5e03\u60c5\u51b5\u8fdb\u884c\u8ba1\u7b97\uff0c\u76f4\u63a5\u4f7f\u7528\u65f6\u95f4\u5e8f\u5217\u4e2d\u8fd4\u56de\u7684Bucket\u5373\u53ef\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u901a\u8fc7\u4ee5\u4e0a\u8bbe\u7f6e\uff0c\u5373\u53ef\u5b9e\u73b0\u5bf9Histogram\u7c7b\u578b\u76d1\u63a7\u6307\u6807\u7684\u53ef\u89c6\u5316\u3002</p>"},{"location":"grafana/use_heatmap_panel/#heatmap_1","title":"\u4f7f\u7528Heatmap\u53ef\u89c6\u5316\u5176\u5b83\u7c7b\u578b\u6837\u672c\u5206\u5e03\u60c5\u51b5","text":"<p>\u5bf9\u4e8e\u975eHistogram\u7c7b\u578b\uff0c\u7531\u4e8e\u5176\u76d1\u63a7\u6837\u672c\u4e2d\u5e76\u4e0d\u5305\u542bBucket\u76f8\u5173\u4fe1\u606f\uff0c\u56e0\u6b64\u5728Metrics\u9009\u9879\u4e2d\u9700\u8981\u5b9a\u4e49Format as\u4e3aTime series\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5e76\u4e14\u901a\u8fc7\b\bAxes\u9009\u9879\b\u4e2d\u9009\u62e9Data format\u65b9\u5f0f\u4e3aTime series\u3002\u8bbe\u7f6e\u8be5\u9009\u9879\u540eHeatmap Panel\u4f1a\u8981\u6c42\u7528\u6237\u63d0\u4f9bBucket\u5206\u5e03\u8303\u56f4\u7684\u8bbe\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5728Y\u8f74\uff08Y Axis\uff09\u4e2d\u9700\u8981\u901a\u8fc7Scale\u5b9a\u4e49Bucket\u6876\u7684\u5206\u5e03\u8303\u56f4\uff0c\b\u9ed8\u8ba4\u7684Bucket\u8303\u56f4\u652f\u6301\u5305\u62ec\uff1aliner\uff08\u7ebf\u6027\u5206\u5e03\uff09\u3001log(base 10)\uff0810\u7684\u5bf9\u6570\uff09\u3001log(base 32)\uff0832\u7684\u5bf9\u6570\uff09\u3001log(base 1024)\uff081024\u7684\u5bf9\u6570\uff09\u7b49\u3002</p> <p>\u4f8b\u5982\uff0c\b\u4e0a\u56fe\u4e2d\u8bbe\u7f6e\u7684Scale\u4e3alog(base 2)\uff0c\u90a3\u4e48\u5728Bucket\u8303\u56f4\u5c062\u7684\u5bf9\u6570\u7684\u5f62\u5f0f\u8fdb\u884c\u5206\u5e03\uff0c\u5373[1,2,4,8,....]\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u901a\u8fc7\u4ee5\u4e0a\u8bbe\u7f6e\uff0cHeatmap\u4f1a\b\u81ea\u52a8\u6839\u636e\u7528\u6237\u5b9a\u4e49\u7684Bucket\u8303\u56f4\u5bf9Prometheus\u4e2d\u67e5\u8be2\u5230\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u5206\u5e03\u7edf\u8ba1\u3002</p>"},{"location":"grafana/use_singlestat_panel/","title":"\u5f53\u524d\u72b6\u6001\uff1aSingleStat\u9762\u677f","text":"<p>SingleStat Panel\u4fa7\u91cd\u4e8e\u5c55\u793a\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u800c\u975e\u53d8\u5316\u8d8b\u52bf\u3002\u5982\u4e0b\u6240\u793a\uff0c\u5728\u4ee5\u4e0b\u573a\u666f\u4e2d\u7279\u522b\u9002\u7528\u4e8e\u4f7f\u7528SingleStat\uff1a</p> <ul> <li>\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u6001\uff1b</li> <li>\u5f53\u524d\u57fa\u7840\u8bbe\u65bd\u8d44\u6e90\u7684\u4f7f\u7528\u91cf\uff1b</li> <li>\u5f53\u524d\u7cfb\u7edf\u4e2d\u67d0\u4e9b\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\u6216\u8005\u8d44\u6e90\u6570\u91cf\u7b49\u3002</li> </ul> <p>\u5982\u4e0b\u6240\u793a\uff0c\u662f\u4f7f\u7528SingleStat\u8fdb\u884c\u6570\u636e\u53ef\u89c6\u5316\u7684\u663e\u793a\u6548\u679c\uff1a</p> <p></p>"},{"location":"grafana/use_singlestat_panel/#singlestat-panel","title":"\u4f7f\u7528SingleStat Panel","text":"<p>\u4eceDashboardc\u521b\u5efaSinglestat Panel\uff0c\u5e76\u8fdb\u5165\u7f16\u8f91\u9875\u9762\uff0c \u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5bf9\u4e8eSingleStat Panel\u800c\u8a00\uff0c\u5176\u53ea\u80fd\u5904\u7406\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\uff0c\u5426\u5219\u9875\u9762\u4e2d\u4f1a\u63d0\u793a\u201cMultiple Series Error\u201d\u9519\u8bef\u4fe1\u606f\u3002\u8fd9\u91cc\u4f7f\u7528\u5982\u4e0bPromQL\u67e5\u8be2\u5f53\u524d\u4e3b\u673a\u8d1f\u8f7d\uff1a</p> <pre><code>node_load1{instance=\"localhost:9100\"}\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5f53\u524d\u9762\u677f\u4e2d\u4f1a\u663e\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u4e2d\u6240\u6709\u6837\u672c\u7684\u5e73\u5747\u503c\uff0c\u800c\u5b9e\u9645\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\b\u9700\u8981\u663e\u793a\u7684\u662f\u5f53\u524d\u4e3b\u673a\u5f53\u524d\u7684\u8d1f\u8f7d\u60c5\u51b5\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7SingleStat Panel\u7684Options\u9009\u9879\u63a7\u5236\u5f53\u524d\u9762\u677f\u7684\u663e\u793a\u6a21\u5f0f\uff1a</p> <p></p> <p>\u5982\u4e0a\u6240\u793a\uff0c\u901a\u8fc7Value\u914d\u7f6e\u9879\u7ec4\u53ef\u4ee5\u63a7\u5236\u5f53\u524d\u9762\u677f\u4e2d\u663e\u793a\u7684\u503c\uff0c\u4ee5\u53ca\u5b57\u4f53\u5927\u5c0f\u7b49\u3002\u5bf9\u4e8e\u4e3b\u673a\u8d1f\u8f7d\u800c\u8a00\uff0c\u6211\u4eec\u5e0c\u671b\u80fd\u591f\u663e\u793a\u5f53\u524d\u7684\u6700\u65b0\u503c\uff0c\u56e0\u6b64\u4fee\u6539Stat\u4e3aCurrent\u5373\u53ef\u3002</p> <p>\u5982\u679c\u5e0c\u671b\u9762\u677f\u80fd\u591f\u6839\u636e\u4e0d\u540c\u7684\u503c\u663e\u793a\u4e0d\u540c\u7684\u989c\u8272\u7684\u8bdd\uff0c\u5219\u53ef\u4ee5\u5b9a\u4e49Thresholds\u4e0eColors\u7684\u6620\u5c04\b\u5173\u7cfb\uff0c\u4f8b\u5982\uff0c\u5b9a\u4e49Thresholds\u7684\u5206\u5272\u533a\u95f4\u503c\u4e3a\u201c0,1\u201d\uff0c\u5219\u5f53Value\u7684\u503c\u843d\u5230\u4e0d\u540c\u7684\u8303\u56f4\u5185\u65f6\uff0c\u5c06\u663e\u793a\u4e0d\u540c\u7684\u989c\u8272\u3002</p> <p>\u5982\u679c\u5e0c\u671b\u80fd\u591f\u663e\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u6837\u672c\u503c\u53d8\u5316\u60c5\u51b5\uff0c\u5219\u53ef\u4ee5\u542f\u7528Spark lines\u914d\u7f6e\u3002\u542f\u7528\u4e4b\u540e\uff0cSinglestat\u9762\u677f\u4e2d\u9664\u4e86\u4f1a\u663e\u793a\u5f53\u524d\u7684\u6700\u65b0\u6837\u672c\u503c\u4ee5\u5916\uff0c\u4e5f\u4f1a\u540c\u65f6\u5c06\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6570\u636e\u4ee5\u8d8b\u52bf\u56fe\u7684\u5f62\u5f0f\u8fdb\u884c\u5c55\u793a\u3002</p> <p>\u9664\u4e86\u901a\u8fc7\u6570\u5b57\u5927\u5c0f\u53cd\u5e94\u5f53\u524d\u72b6\u6001\u4ee5\u5916\uff0c\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u53ef\u80fd\b\b\u66f4\u5173\u5fc3\u7684\u662f\b\u8fd9\u4e9b\u6570\u5b57\u8868\u793a\u7684\u610f\u4e49\u3002\u4f8b\u5982\uff0c\u5728Prometheus\u76d1\u63a7\u670d\u52a1\u7684\u5065\u5eb7\u72b6\u6001\u65f6\uff0c\u5728\u6837\u672c\u6570\u636e\u4e2d\u4f1a\u901a\u8fc70\u8868\u793a\u4e0d\u5065\u5eb7\uff0c1\u8868\u793a\u5065\u5eb7\u3002 \u4f46\u662f\u5982\u679c\u76f4\u63a5\u5c060\u62161\u663e\u793a\u5728\u9762\u677f\u4e2d\uff0c\u90a3\u4e48\u53ef\u89c6\u5316\u6548\u679c\u5c06\u7f3a\u4e4f\u4e00\u5b9a\u7684\u53ef\u8bfb\u6027\u3002</p> <p>\u4e3a\u4e86\u63d0\u5347\u6570\u5b57\u7684\u53ef\u8bfb\u6027\uff0c\u53ef\u4ee5\u5728Singlestat Panel\u4e2d\u53ef\u4ee5\u901a\u8fc7Value Mappings\u5b9a\u4e49\u503c\u7684\u6620\u5c04\u5173\u7cfb\u3002Siglesta\u652f\u6301\u503c\u6620\u5c04\uff08value to text\uff09\u548c\u533a\u95f4\u6620\u5c04\uff08range to text\uff09\u4e24\u79cd\u65b9\u5f0f\u3002 \u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5f53\u9762\u677f\u4e2dValue\u7684\u503c\u57280~0.99\u8303\u56f4\u5185\u5219\u663e\u793a\u4e3aHealth\uff0c\u5426\u5219\u663e\u793a\u4e3aUnhealth\u3002\u8fd9\u79cd\u6a21\u5f0f\u7279\u522b\u9002\u5408\u4e8e\u5c55\u793a\u670d\u52a1\u7684\u5065\u5eb7\u72b6\u6001\u3002 \u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u5c06Value\u6620\u5c04\u4e3a\u4efb\u610f\u7684\u5b57\u7b26\uff0c\u751a\u81f3\u662f\u76f4\u63a5\u4f7f\u7528Emoji(http://www.iemoji.com/)\u8868\u60c5\uff1a</p> <p></p>"},{"location":"ha/READMD/","title":"\u7b2c6\u7ae0 \u96c6\u7fa4\u4e0e\u9ad8\u53ef\u7528","text":"<p>Prometheus\u5185\u7f6e\u4e86\u4e00\u4e2a\u57fa\u4e8e\u672c\u5730\u5b58\u50a8\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u3002\u5728Prometheus\u8bbe\u8ba1\u4e0a\uff0c\u4f7f\u7528\u672c\u5730\u5b58\u50a8\u53ef\u4ee5\u964d\u4f4ePrometheus\u90e8\u7f72\u548c\u7ba1\u7406\u7684\u590d\u6742\u5ea6\uff0c\u540c\u65f6\u51cf\u5c11\u9ad8\u53ef\u7528\uff08HA\uff09\u5e26\u6765\u7684\u590d\u6742\u6027\u3002 \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u53ea\u9700\u8981\u90e8\u7f72\u591a\u5957Prometheus\uff0c\u91c7\u96c6\u76f8\u540c\u7684Targets\u5373\u53ef\u5b9e\u73b0\u57fa\u672c\u7684HA\u3002\u540c\u65f6\u7531\u4e8ePromethus\u9ad8\u6548\u7684\u6570\u636e\u5904\u7406\u80fd\u529b\uff0c\u5355\u4e2aPrometheus Server\u57fa\u672c\u4e0a\u80fd\u591f\u5e94\u5bf9\u5927\u90e8\u5206\u7528\u6237\u76d1\u63a7\u89c4\u6a21\u7684\u9700\u6c42\u3002</p> <p>\u5f53\u7136\u672c\u5730\u5b58\u50a8\u4e5f\u5e26\u6765\u4e86\u4e00\u4e9b\u4e0d\u597d\u7684\u5730\u65b9\uff0c\u9996\u5148\u5c31\u662f\u6570\u636e\u6301\u4e45\u5316\u7684\u95ee\u9898\uff0c\u7279\u522b\u662f\u5728\u50cfKubernetes\u8fd9\u6837\u7684\u52a8\u6001\u96c6\u7fa4\u73af\u5883\u4e0b\uff0c\u5982\u679cPrometheus\u7684\u5b9e\u4f8b\u88ab\u91cd\u65b0\u8c03\u5ea6\uff0c\u90a3\u6240\u6709\u5386\u53f2\u76d1\u63a7\u6570\u636e\u90fd\u4f1a\u4e22\u5931\u3002 \u5176\u6b21\u672c\u5730\u5b58\u50a8\u4e5f\u610f\u5473\u7740Prometheus\u4e0d\u9002\u5408\u4fdd\u5b58\u5927\u91cf\u5386\u53f2\u6570\u636e(\u4e00\u822cPrometheus\u63a8\u8350\u53ea\u4fdd\u7559\u51e0\u5468\u6216\u8005\u51e0\u4e2a\u6708\u7684\u6570\u636e)\u3002\u6700\u540e\u672c\u5730\u5b58\u50a8\u4e5f\u5bfc\u81f4Prometheus\u65e0\u6cd5\u8fdb\u884c\u5f39\u6027\u6269\u5c55\u3002\u4e3a\u4e86\u9002\u5e94\u8fd9\u65b9\u9762\u7684\u9700\u6c42\uff0cPrometheus\u63d0\u4f9b\u4e86remote_write\u548cremote_read\u7684\u7279\u6027\uff0c\u652f\u6301\u5c06\u6570\u636e\u5b58\u50a8\u5230\u8fdc\u7aef\u548c\u4ece\u8fdc\u7aef\u8bfb\u53d6\u6570\u636e\u3002\u901a\u8fc7\u5c06\u76d1\u63a7\u4e0e\u6570\u636e\u5206\u79bb\uff0cPrometheus\u80fd\u591f\u66f4\u597d\u5730\u8fdb\u884c\u5f39\u6027\u6269\u5c55\u3002</p> <p>\u9664\u4e86\u672c\u5730\u5b58\u50a8\u65b9\u9762\u7684\u95ee\u9898\uff0c\u7531\u4e8ePrometheus\u57fa\u4e8ePull\u6a21\u578b\uff0c\u5f53\u6709\u5927\u91cf\u7684Target\u9700\u8981\u91c7\u6837\u672c\u65f6\uff0c\u5355\u4e00Prometheus\u5b9e\u4f8b\u5728\u6570\u636e\u6293\u53d6\u65f6\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\uff0c\u8054\u90a6\u96c6\u7fa4\u7684\u7279\u6027\u53ef\u4ee5\u8ba9Prometheus\u5c06\u6837\u672c\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684Prometheus\u5b9e\u4f8b\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7\u4e00\u4e2a\u7edf\u4e00\u7684\u4e2d\u5fc3\u8282\u70b9\u8fdb\u884c\u805a\u5408\uff0c\u4ece\u800c\u53ef\u4ee5\u4f7fPrometheuse\u53ef\u4ee5\u6839\u636e\u89c4\u6a21\u8fdb\u884c\u6269\u5c55\u3002</p> <p>\u9664\u4e86\u8ba8\u8bbaPrometheus\u81ea\u8eab\u7684\u9ad8\u53ef\u7528\uff0cAlertmanager\u4f5c\u4e3aPrometheus\u4f53\u7cfb\u4e2d\u7684\u544a\u8b66\u5904\u7406\u4e2d\u5fc3\uff0c\u672c\u7ae0\u7684\u6700\u540e\u90e8\u5206\u4f1a\u8ba8\u8bba\u5982\u4f55\u5b9e\u73b0Alertmanager\u7684\u9ad8\u53ef\u7528\u90e8\u7f72\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a * Prometheus\u672c\u5730\u5b58\u50a8\u673a\u5236 * Prometheus\u7684\u8fdc\u7a0b\u5b58\u50a8\u673a\u5236 * Prometheus\u8054\u90a6\u96c6\u7fa4 * Prometheus\u9ad8\u53ef\u7528\u90e8\u7f72\u67b6\u6784 * Alertmanager\u9ad8\u53ef\u7528\u90e8\u7f72\u67b6\u6784</p>"},{"location":"ha/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>Prometheus\u7684\u7b80\u5355\u6027\u8d2f\u7a7f\u4e8e\u6574\u4e2aPrometheus\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u65e0\u8bba\u662f\u5355\u673a\u90e8\u7f72\u8fd8\u662f\u96c6\u7fa4\u5316\u90e8\u7f72\uff0c\u7b80\u5355\u6027\u4e00\u81f4\u662fPrometheus\u8bbe\u8ba1\u7684\u57fa\u672c\u539f\u5219\u3002\u8fd9\u672c\u7ae0\u4e2d\uff0c\u6211\u4eec\u7cfb\u7edf\u5b66\u4e60\u4e86\u5982\u679c\u5b9e\u73b0Prometheus\u4e0b\u5404\u4e2a\u4e2d\u95f4\u7684\u9ad8\u53ef\u7528\u90e8\u7f72\u65b9\u5f0f\uff0c\u540c\u65f6\u7ed9\u51fa\u4e86\u96c6\u4e2d\u5e38\u7528\u7684\u9ad8\u53ef\u7528\u65b9\u6848\uff0c\u8bfb\u8005\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u6c42\u6765\u9009\u62e9\u5982\u4f55\u90e8\u7f72\u81ea\u5df1\u7684Promethues\u96c6\u7fa4\u3002</p>"},{"location":"ha/alertmanager-high-availability/","title":"Alertmanager\u9ad8\u53ef\u7528","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u4e3b\u8981\u8ba8\u8bba\u4e86Prometheus Server\u81ea\u8eab\u7684\u9ad8\u53ef\u7528\u95ee\u9898\u3002\u800c\u63a5\u4e0b\u6765\uff0c\u91cd\u70b9\u5c06\u653e\u5728\u544a\u8b66\u5904\u7406\u4e5f\u5c31\u662fAlertmanager\u90e8\u5206\u3002\u5982\u4e0b\u6240\u793a\u3002</p> <p></p> <p>\u4e3a\u4e86\u63d0\u5347Prometheus\u7684\u670d\u52a1\u53ef\u7528\u6027\uff0c\u901a\u5e38\u7528\u6237\u4f1a\u90e8\u7f72\u4e24\u4e2a\u6216\u8005\u4e24\u4e2a\u4ee5\u4e0a\u7684Promthus Server\uff0c\u5b83\u4eec\u5177\u6709\u5b8c\u5168\u76f8\u540c\u7684\u914d\u7f6e\u5305\u62ecJob\u914d\u7f6e\uff0c\u4ee5\u53ca\u544a\u8b66\u914d\u7f6e\u7b49\u3002\u5f53\u67d0\u4e00\u4e2aPrometheus Server\u53d1\u751f\u6545\u969c\u540e\u53ef\u4ee5\u786e\u4fddPrometheus\u6301\u7eed\u53ef\u7528\u3002</p> <p>\u540c\u65f6\u57fa\u4e8eAlertmanager\u7684\u544a\u8b66\u5206\u7ec4\u673a\u5236\u5373\u4f7f\u4e0d\u540c\u7684Prometheus Sever\u5206\u522b\u53d1\u9001\u76f8\u540c\u7684\u544a\u8b66\u7ed9Alertmanager\uff0cAlertmanager\u4e5f\u53ef\u4ee5\u81ea\u52a8\u5c06\u8fd9\u4e9b\u544a\u8b66\u5408\u5e76\u4e3a\u4e00\u4e2a\u901a\u77e5\u5411receiver\u53d1\u9001\u3002</p> <p></p> <p>\u4f46\u4e0d\u5e78\u7684\u662f\uff0c\u867d\u7136Alertmanager\u80fd\u591f\u540c\u65f6\u5904\u7406\u591a\u4e2a\u76f8\u540c\u7684Prometheus Server\u6240\u4ea7\u751f\u7684\u544a\u8b66\u3002\u4f46\u662f\u7531\u4e8e\u5355\u4e2aAlertmanager\u7684\u5b58\u5728\uff0c\u5f53\u524d\u7684\u90e8\u7f72\u7ed3\u6784\u5b58\u5728\u660e\u663e\u7684\u5355\u70b9\u6545\u969c\u98ce\u9669\uff0c\u5f53Alertmanager\u5355\u70b9\u5931\u6548\u540e\uff0c\u544a\u8b66\u7684\u540e\u7eed\u6240\u6709\u4e1a\u52a1\u5168\u90e8\u5931\u6548\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\uff0c\u5c31\u662f\u5c1d\u8bd5\u90e8\u7f72\u591a\u5957Alertmanager\u3002\u4f46\u662f\u7531\u4e8eAlertmanager\u4e4b\u95f4\u4e0d\u5b58\u5728\u5e76\u4e0d\u4e86\u89e3\u5f7c\u6b64\u7684\u5b58\u5728\uff0c\u56e0\u6b64\u5219\u4f1a\u51fa\u73b0\u544a\u8b66\u901a\u77e5\u88ab\u4e0d\u540c\u7684Alertmanager\u91cd\u590d\u53d1\u9001\u591a\u6b21\u7684\u95ee\u9898\u3002</p> <p></p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0c\u5982\u4e0b\u6240\u793a\u3002Alertmanager\u5f15\u5165\u4e86Gossip\u673a\u5236\u3002Gossip\u673a\u5236\u4e3a\u591a\u4e2aAlertmanager\u4e4b\u95f4\u63d0\u4f9b\u4e86\u4fe1\u606f\u4f20\u9012\u7684\u673a\u5236\u3002\u786e\u4fdd\u53ca\u65f6\u5728\u591a\u4e2aAlertmanager\u5206\u522b\u63a5\u6536\u5230\u76f8\u540c\u544a\u8b66\u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\uff0c\u4e5f\u53ea\u6709\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\u88ab\u53d1\u9001\u7ed9Receiver\u3002</p> <p></p>"},{"location":"ha/alertmanager-high-availability/#gossip","title":"Gossip\u534f\u8bae","text":"<p>Gossip\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u534f\u8bae\uff0c\u7528\u4e8e\u5b9e\u73b0\u5206\u5e03\u5f0f\u8282\u70b9\u4e4b\u95f4\u7684\u4fe1\u606f\u4ea4\u6362\u548c\u72b6\u6001\u540c\u6b65\u3002Gossip\u534f\u8bae\u540c\u6b65\u72b6\u6001\u7c7b\u4f3c\u4e8e\u6d41\u8a00\u6216\u8005\u75c5\u6bd2\u7684\u4f20\u64ad\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u4e00\u822c\u6765\u8bf4Gossip\u6709\u4e24\u79cd\u5b9e\u73b0\u65b9\u5f0f\u5206\u522b\u4e3aPush-based\u548cPull-based\u3002\u5728Push-based\u5f53\u96c6\u7fa4\u4e2d\u67d0\u4e00\u8282\u70b9A\u5b8c\u6210\u4e00\u4e2a\u5de5\u4f5c\u540e\uff0c\u968f\u673a\u7684\u4ece\u5176\u5b83\u8282\u70b9B\u5e76\u5411\u5176\u53d1\u9001\u76f8\u5e94\u7684\u6d88\u606f\uff0c\u8282\u70b9B\u63a5\u6536\u5230\u6d88\u606f\u540e\u5728\u91cd\u590d\u5b8c\u6210\u76f8\u540c\u7684\u5de5\u4f5c\uff0c\u76f4\u5230\u4f20\u64ad\u5230\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u3002\u800cPull-based\u7684\u5b9e\u73b0\u4e2d\u8282\u70b9A\u4f1a\u968f\u673a\u7684\u5411\u8282\u70b9B\u53d1\u8d77\u8be2\u95ee\u662f\u5426\u6709\u65b0\u7684\u72b6\u6001\u9700\u8981\u540c\u6b65\uff0c\u5982\u679c\u6709\u5219\u8fd4\u56de\u3002</p> <p>\u5728\u7b80\u5355\u4e86\u89e3\u4e86Gossip\u534f\u8bae\u4e4b\u540e\uff0c\u6211\u4eec\u6765\u770bAlertmanager\u662f\u5982\u4f55\u57fa\u4e8eGossip\u534f\u8bae\u5b9e\u73b0\u96c6\u7fa4\u9ad8\u53ef\u7528\u7684\u3002\u5982\u4e0b\u6240\u793a\uff0c\u5f53Alertmanager\u63a5\u6536\u5230\u6765\u81eaPrometheus\u7684\u544a\u8b66\u6d88\u606f\u540e\uff0c\u4f1a\u6309\u7167\u4ee5\u4e0b\u6d41\u7a0b\u5bf9\u544a\u8b66\u8fdb\u884c\u5904\u7406\uff1a</p> <p></p> <ol> <li>\u5728\u7b2c\u4e00\u4e2a\u9636\u6bb5Silence\u4e2d\uff0cAlertmanager\u4f1a\u5224\u65ad\u5f53\u524d\u901a\u77e5\u662f\u5426\u5339\u914d\u5230\u4efb\u4f55\u7684\u9759\u9ed8\u89c4\u5219\uff0c\u5982\u679c\u6ca1\u6709\u5219\u8fdb\u5165\u4e0b\u4e00\u4e2a\u9636\u6bb5\uff0c\u5426\u5219\u4e2d\u65ad\u6d41\u6c34\u7ebf\u4e0d\u53d1\u9001\u901a\u77e5\u3002</li> <li>\u5728\u7b2c\u4e8c\u4e2a\u9636\u6bb5Wait\u4e2d\uff0cAlertmanager\u4f1a\u6839\u636e\u5f53\u524dAlertmanager\u5728\u96c6\u7fa4\u4e2d\u6240\u5728\u7684\u987a\u5e8f(index)\u7b49\u5f85index * 5s\u7684\u65f6\u95f4\u3002</li> <li>\u5f53\u524dAlertmanager\u7b49\u5f85\u9636\u6bb5\u7ed3\u675f\u540e\uff0cDedup\u9636\u6bb5\u5219\u4f1a\u5224\u65ad\u5f53\u524dAlertmanager\u6570\u636e\u5e93\u4e2d\u8be5\u901a\u77e5\u662f\u5426\u5df2\u7ecf\u53d1\u9001\uff0c\u5982\u679c\u5df2\u7ecf\u53d1\u9001\u5219\u4e2d\u65ad\u6d41\u6c34\u7ebf\uff0c\u4e0d\u53d1\u9001\u544a\u8b66\uff0c\u5426\u5219\u8fdb\u5165\u4e0b\u4e00\u9636\u6bb5Send\u5bf9\u5916\u53d1\u9001\u544a\u8b66\u901a\u77e5\u3002</li> <li>\u544a\u8b66\u53d1\u9001\u5b8c\u6210\u540e\u8be5Alertmanager\u8fdb\u5165\u6700\u540e\u4e00\u4e2a\u9636\u6bb5Gossip\uff0cGossip\u4f1a\u901a\u77e5\u5176\u4ed6Alertmanager\u5b9e\u4f8b\u5f53\u524d\u544a\u8b66\u5df2\u7ecf\u53d1\u9001\u3002\u5176\u4ed6\u5b9e\u4f8b\u63a5\u6536\u5230Gossip\u6d88\u606f\u540e\uff0c\u5219\u4f1a\u5728\u81ea\u5df1\u7684\u6570\u636e\u5e93\u4e2d\u4fdd\u5b58\u8be5\u901a\u77e5\u5df2\u53d1\u9001\u7684\u8bb0\u5f55\u3002</li> </ol> <p>\u56e0\u6b64\u5982\u4e0b\u6240\u793a\uff0cGossip\u673a\u5236\u7684\u5173\u952e\u5728\u4e8e\u4e24\u70b9\uff1a</p> <p></p> <ul> <li>Silence\u8bbe\u7f6e\u540c\u6b65\uff1aAlertmanager\u542f\u52a8\u9636\u6bb5\u57fa\u4e8ePull-based\u4ece\u96c6\u7fa4\u5176\u5b83\u8282\u70b9\u540c\u6b65Silence\u72b6\u6001\uff0c\u5f53\u6709\u65b0\u7684Silence\u4ea7\u751f\u65f6\u4f7f\u7528Push-based\u65b9\u5f0f\u5728\u96c6\u7fa4\u4e2d\u4f20\u64adGossip\u4fe1\u606f\u3002</li> <li>\u901a\u77e5\u53d1\u9001\u72b6\u6001\u540c\u6b65\uff1a\u544a\u8b66\u901a\u77e5\u53d1\u9001\u5b8c\u6210\u540e\uff0c\u57fa\u4e8ePush-based\u540c\u6b65\u544a\u8b66\u53d1\u9001\u72b6\u6001\u3002Wait\u9636\u6bb5\u53ef\u4ee5\u786e\u4fdd\u96c6\u7fa4\u72b6\u6001\u4e00\u81f4\u3002</li> </ul> <p>Alertmanager\u57fa\u4e8eGossip\u5b9e\u73b0\u7684\u96c6\u7fa4\u673a\u5236\u867d\u7136\u4e0d\u80fd\u4fdd\u8bc1\u6240\u6709\u5b9e\u4f8b\u4e0a\u7684\u6570\u636e\u65f6\u523b\u4fdd\u6301\u4e00\u81f4\uff0c\u4f46\u662f\u5b9e\u73b0\u4e86CAP\u7406\u8bba\u4e2d\u7684AP\u7cfb\u7edf\uff0c\u5373\u53ef\u7528\u6027\u548c\u5206\u533a\u5bb9\u9519\u6027\u3002\u540c\u65f6\u5bf9\u4e8ePrometheus Server\u800c\u8a00\u4fdd\u6301\u4e86\u914d\u7f6e\u4e86\u7b80\u5355\u6027\uff0cPrometheus Server\u4e4b\u95f4\u4e0d\u9700\u8981\u4efb\u4f55\u7684\u72b6\u6001\u540c\u6b65\u3002</p>"},{"location":"ha/alertmanager-high-availability/#_1","title":"\u642d\u5efa\u672c\u5730\u96c6\u7fa4\u73af\u5883","text":"<p>\u4e3a\u4e86\u80fd\u591f\u8ba9Alertmanager\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u901a\u8baf\uff0c\u9700\u8981\u5728Alertmanager\u542f\u52a8\u65f6\u8bbe\u7f6e\u76f8\u5e94\u7684\u53c2\u6570\u3002\u5176\u4e2d\u4e3b\u8981\u7684\u53c2\u6570\u5305\u62ec\uff1a</p> <ul> <li>--cluster.listen-address string: \u5f53\u524d\u5b9e\u4f8b\u96c6\u7fa4\u670d\u52a1\u76d1\u542c\u5730\u5740</li> <li>--cluster.peer value: \u521d\u59cb\u5316\u65f6\u5173\u8054\u7684\u5176\u5b83\u5b9e\u4f8b\u7684\u96c6\u7fa4\u670d\u52a1\u5730\u5740</li> </ul> <p>\u4f8b\u5982\uff1a</p> <p>\u5b9a\u4e49Alertmanager\u5b9e\u4f8ba1\uff0c\u5176\u4e2dAlertmanager\u7684\u670d\u52a1\u8fd0\u884c\u57289093\u7aef\u53e3\uff0c\u96c6\u7fa4\u670d\u52a1\u5730\u5740\u8fd0\u884c\u57288001\u7aef\u53e3\u3002</p> <pre><code>alertmanager  --web.listen-address=\":9093\" --cluster.listen-address=\"127.0.0.1:8001\" --config.file=/etc/prometheus/alertmanager.yml  --storage.path=/data/alertmanager/\n</code></pre> <p>\u5b9a\u4e49Alertmanager\u5b9e\u4f8ba2\uff0c\u5176\u4e2d\u4e3b\u670d\u52a1\u8fd0\u884c\u57289094\u7aef\u53e3\uff0c\u96c6\u7fa4\u670d\u52a1\u8fd0\u884c\u57288002\u7aef\u53e3\u3002\u4e3a\u4e86\u5c06a1\uff0ca2\u7ec4\u6210\u96c6\u7fa4\u3002 a2\u542f\u52a8\u65f6\u9700\u8981\u5b9a\u4e49--cluster.peer\u53c2\u6570\u5e76\u4e14\u6307\u5411a1\u5b9e\u4f8b\u7684\u96c6\u7fa4\u670d\u52a1\u5730\u5740:8001\u3002</p> <pre><code>alertmanager  --web.listen-address=\":9094\" --cluster.listen-address=\"127.0.0.1:8002\" --cluster.peer=127.0.0.1:8001 --config.file=/etc/prometheus/alertmanager.yml  --storage.path=/data/alertmanager2/\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u5728\u672c\u5730\u6a21\u62df\u96c6\u7fa4\u73af\u5883\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u591a\u7ebf\u7a0b\u7ba1\u7406\u5de5\u5177goreman\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5728\u672c\u5730\u5b89\u88c5goreman\u547d\u4ee4\u884c\u5de5\u5177\u3002</p> <pre><code>go get github.com/mattn/goreman\n</code></pre>"},{"location":"ha/alertmanager-high-availability/#alertmanager_1","title":"\u521b\u5efaAlertmanager\u96c6\u7fa4","text":"<p>\u521b\u5efaAlertmanager\u914d\u7f6e\u6587\u4ef6/etc/prometheus/alertmanager-ha.yml, \u4e3a\u4e86\u9a8c\u8bc1Alertmanager\u7684\u96c6\u7fa4\u884c\u4e3a\uff0c\u8fd9\u91cc\u5728\u672c\u5730\u542f\u52a8\u4e00\u4e2awebhook\u670d\u52a1\u7528\u4e8e\u6253\u5370Alertmanager\u53d1\u9001\u7684\u544a\u8b66\u901a\u77e5\u4fe1\u606f\u3002</p> <pre><code>route:\n  receiver: 'default-receiver'\nreceivers:\n  - name: default-receiver\n    webhook_configs:\n    - url: 'http://127.0.0.1:5001/'\n</code></pre> <p>\u672c\u5730webhook\u670d\u52a1\u53ef\u4ee5\u76f4\u63a5\u4eceGithub\u83b7\u53d6\u3002</p> <pre><code># \u83b7\u53d6alertmanager\u63d0\u4f9b\u7684webhook\u793a\u4f8b\uff0c\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u5b9a\u4e49\u4e86main\u51fd\u6570\uff0cgo get\u4f1a\u81ea\u52a8\u5c06\u5176\u7f16\u8bd1\u6210\u53ef\u6267\u884c\u6587\u4ef6\ngo get github.com/prometheus/alertmanager/examples/webhook\n# \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u6307\u5411GOPATH\u7684bin\u76ee\u5f55\nexport PATH=$GOPATH/bin:$PATH\n# \u542f\u52a8\u670d\u52a1\nwebhook\n</code></pre> <p>\u793a\u4f8b\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u521b\u5efaalertmanager.procfile\u6587\u4ef6\uff0c\u5e76\u4e14\u5b9a\u4e49\u4e86\u4e09\u4e2aAlertmanager\u8282\u70b9\uff08a1\uff0ca2\uff0ca3\uff09\u4ee5\u53ca\u7528\u4e8e\u63a5\u6536\u544a\u8b66\u901a\u77e5\u7684webhook\u670d\u52a1:</p> <pre><code>a1: alertmanager  --web.listen-address=\":9093\" --cluster.listen-address=\"127.0.0.1:8001\" --config.file=/etc/prometheus/alertmanager-ha.yml  --storage.path=/data/alertmanager/ --log.level=debug\na2: alertmanager  --web.listen-address=\":9094\" --cluster.listen-address=\"127.0.0.1:8002\" --cluster.peer=127.0.0.1:8001 --config.file=/etc/prometheus/alertmanager-ha.yml  --storage.path=/data/alertmanager2/ --log.level=debug\na3: alertmanager  --web.listen-address=\":9095\" --cluster.listen-address=\"127.0.0.1:8003\" --cluster.peer=127.0.0.1:8001 --config.file=/etc/prometheus/alertmanager-ha.yml  --storage.path=/data/alertmanager2/ --log.level=debug\n\nwebhook: webhook\n</code></pre> <p>\u5728Procfile\u6587\u4ef6\u6240\u5728\u76ee\u5f55\uff0c\u6267\u884cgoreman start\u547d\u4ee4\uff0c\u542f\u52a8\u6240\u6709\u8fdb\u7a0b:</p> <pre><code>$ goreman -f alertmanager.procfile start\n10:27:57      a1 | level=debug ts=2018-03-12T02:27:57.399166371Z caller=cluster.go:125 component=cluster msg=\"joined cluster\" peers=0\n10:27:57      a3 | level=info ts=2018-03-12T02:27:57.40004678Z caller=main.go:346 msg=Listening address=:9095\n10:27:57      a1 | level=info ts=2018-03-12T02:27:57.400212246Z caller=main.go:271 msg=\"Loading configuration file\" file=/etc/prometheus/alertmanager.yml\n10:27:57      a1 | level=info ts=2018-03-12T02:27:57.405638714Z caller=main.go:346 msg=Listening address=:9093\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210\u540e\u8bbf\u95ee\u4efb\u610fAlertmanager\u8282\u70b9http://localhost:9093/#/status,\u53ef\u4ee5\u67e5\u770b\u5f53\u524dAlertmanager\u96c6\u7fa4\u7684\u72b6\u6001\u3002</p> <p></p> <p>\u5f53\u96c6\u7fa4\u4e2d\u7684Alertmanager\u8282\u70b9\u4e0d\u5728\u4e00\u53f0\u4e3b\u673a\u65f6\uff0c\u901a\u5e38\u9700\u8981\u4f7f\u7528--cluster.advertise-address\u53c2\u6570\u6307\u5b9a\u5f53\u524d\u8282\u70b9\u6240\u5728\u7f51\u7edc\u5730\u5740\u3002</p> <p>\u6ce8\u610f\uff1a\u7531\u4e8egoreman\u4e0d\u4fdd\u8bc1\u8fdb\u7a0b\u4e4b\u95f4\u7684\u542f\u52a8\u987a\u5e8f\uff0c\u5982\u679c\u96c6\u7fa4\u72b6\u6001\u672a\u8fbe\u5230\u9884\u671f\uff0c\u53ef\u4ee5\u4f7f\u7528<code>goreman -f alertmanager.procfile run restart a2</code>\u91cd\u542fa2\uff0ca3\u670d\u52a1\u3002</p> <p>\u5f53Alertmanager\u96c6\u7fa4\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528send-alerts.sh\u811a\u672c\u5bf9\u96c6\u7fa4\u8fdb\u884c\u7b80\u5355\u6d4b\u8bd5\uff0c\u8fd9\u91cc\u5229\u7528curl\u5206\u522b\u54113\u4e2aAlertmanager\u5b9e\u4f8b\u53d1\u9001\u544a\u8b66\u4fe1\u606f\u3002</p> <pre><code>alerts1='[\n  {\n    \"labels\": {\n       \"alertname\": \"DiskRunningFull\",\n       \"dev\": \"sda1\",\n       \"instance\": \"example1\"\n     },\n     \"annotations\": {\n        \"info\": \"The disk sda1 is running full\",\n        \"summary\": \"please check the instance example1\"\n      }\n  },\n  {\n    \"labels\": {\n       \"alertname\": \"DiskRunningFull\",\n       \"dev\": \"sdb2\",\n       \"instance\": \"example2\"\n     },\n     \"annotations\": {\n        \"info\": \"The disk sdb2 is running full\",\n        \"summary\": \"please check the instance example2\"\n      }\n  },\n  {\n    \"labels\": {\n       \"alertname\": \"DiskRunningFull\",\n       \"dev\": \"sda1\",\n       \"instance\": \"example3\",\n       \"severity\": \"critical\"\n     }\n  },\n  {\n    \"labels\": {\n       \"alertname\": \"DiskRunningFull\",\n       \"dev\": \"sda1\",\n       \"instance\": \"example3\",\n       \"severity\": \"warning\"\n     }\n  }\n]'\n\ncurl -XPOST -d\"$alerts1\" http://localhost:9093/api/v1/alerts\ncurl -XPOST -d\"$alerts1\" http://localhost:9094/api/v1/alerts\ncurl -XPOST -d\"$alerts1\" http://localhost:9095/api/v1/alerts\n</code></pre> <p>\u8fd0\u884csend-alerts.sh\u540e\uff0c\u67e5\u770balertmanager\u65e5\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\uff0c3\u4e2aAlertmanager\u5b9e\u4f8b\u5206\u522b\u63a5\u6536\u5230\u6a21\u62df\u7684\u544a\u8b66\u4fe1\u606f\uff1a</p> <pre><code>10:43:36      a1 | level=debug ts=2018-03-12T02:43:36.853370185Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=DiskRunningFull[6543bc1][active]\n10:43:36      a2 | level=debug ts=2018-03-12T02:43:36.871180749Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=DiskRunningFull[8320f0a][active]\n10:43:36      a3 | level=debug ts=2018-03-12T02:43:36.894923811Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=DiskRunningFull[8320f0a][active]\n</code></pre> <p>\u67e5\u770bwebhook\u65e5\u5fd7\u53ea\u63a5\u6536\u5230\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\uff1a</p> <pre><code>10:44:06 webhook | 2018/03/12 10:44:06 {\n10:44:06 webhook |  &gt;  \"receiver\": \"default-receiver\",\n10:44:06 webhook |  &gt;  \"status\": \"firing\",\n10:44:06 webhook |  &gt;  \"alerts\": [\n10:44:06 webhook |  &gt;    {\n10:44:06 webhook |  &gt;      \"status\": \"firing\",\n10:44:06 webhook |  &gt;      \"labels\": {\n10:44:06 webhook |  &gt;        \"alertname\": \"DiskRunningFull\",\n</code></pre>"},{"location":"ha/alertmanager-high-availability/#prometheusalertmanager","title":"\u591a\u5b9e\u4f8bPrometheus\u4e0eAlertmanager\u96c6\u7fa4","text":"<p>\u7531\u4e8eGossip\u673a\u5236\u7684\u5b9e\u73b0\uff0c\u5728Prometheus\u548cAlertmanager\u5b9e\u4f8b\u4e4b\u95f4\u4e0d\u8981\u4f7f\u7528\u4efb\u4f55\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u9700\u8981\u786e\u4fddPrometheus\u5c06\u544a\u8b66\u53d1\u9001\u5230\u6240\u6709\u7684Alertmanager\u5b9e\u4f8b\u4e2d\uff1a</p> <pre><code>alerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      - 127.0.0.1:9093\n      - 127.0.0.1:9094\n      - 127.0.0.1:9095\n</code></pre> <p>\u521b\u5efaPrometheus\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6/etc/prometheus/prometheus-ha.yml\uff0c\u5b8c\u6574\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>global:\n  scrape_interval: 15s\n  scrape_timeout: 10s\n  evaluation_interval: 15s\nrule_files:\n  - /etc/prometheus/rules/*.rules\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      - 127.0.0.1:9093\n      - 127.0.0.1:9094\n      - 127.0.0.1:9095\nscrape_configs:\n- job_name: prometheus\n  static_configs:\n  - targets:\n    - localhost:9090\n- job_name: 'node'\n  static_configs:\n  - targets: ['localhost:9100']\n</code></pre> <p>\u540c\u65f6\u5b9a\u4e49\u544a\u8b66\u89c4\u5219\u6587\u4ef6/etc/prometheus/rules/hoststats-alert.rules\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>groups:\n- name: hostStatsAlert\n  rules:\n  - alert: hostCpuUsageAlert\n    expr: sum(avg without (cpu)(irate(node_cpu{mode!='idle'}[5m]))) by (instance) * 100 &gt; 50\n    for: 1m\n    labels:\n      severity: page\n    annotations:\n      summary: \"Instance {{ $labels.instance }} CPU usgae high\"\n      description: \"{{ $labels.instance }} CPU usage above 50% (current value: {{ $value }})\"\n  - alert: hostMemUsageAlert\n    expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal * 100 &gt; 85\n    for: 1m\n    labels:\n      severity: page\n    annotations:\n      summary: \"Instance {{ $labels.instance }} MEM usgae high\"\n      description: \"{{ $labels.instance }} MEM usage above 85% (current value: {{ $value }})\"\n</code></pre> <p>\u672c\u793a\u4f8b\u90e8\u7f72\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u521b\u5efaprometheus.procfile\u6587\u4ef6\uff0c\u521b\u5efa\u4e24\u4e2aPrometheus\u8282\u70b9\uff0c\u5206\u522b\u76d1\u542c9090\u548c9091\u7aef\u53e3:</p> <pre><code>p1: prometheus --config.file=/etc/prometheus/prometheus-ha.yml --storage.tsdb.path=/data/prometheus/ --web.listen-address=\"127.0.0.1:9090\"\np2: prometheus --config.file=/etc/prometheus/prometheus-ha.yml --storage.tsdb.path=/data/prometheus2/ --web.listen-address=\"127.0.0.1:9091\"\n\nnode_exporter: node_exporter -web.listen-address=\"0.0.0.0:9100\"\n</code></pre> <p>\u4f7f\u7528goreman\u542f\u52a8\u591a\u8282\u70b9Prometheus\uff1a</p> <pre><code>goreman -f prometheus.procfile -p 8556 start\n</code></pre> <p>Prometheus\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u624b\u52a8\u62c9\u9ad8\u7cfb\u7edfCPU\u4f7f\u7528\u7387\uff1a</p> <pre><code>cat /dev/zero&gt;/dev/null\n</code></pre> <p>\u6ce8\u610f\uff0c\u5bf9\u4e8e\u591a\u6838\u4e3b\u673a\uff0c\u5982\u679cCPU\u8fbe\u4e0d\u5230\u9884\u671f\uff0c\u8fd0\u884c\u591a\u4e2a\u547d\u4ee4\u3002</p> <p>\u5f53CPU\u5229\u7528\u7387\u8fbe\u5230\u544a\u8b66\u89c4\u5219\u89e6\u53d1\u6761\u4ef6\uff0c\u4e24\u4e2aPrometheus\u5b9e\u4f8b\u544a\u8b66\u5206\u522b\u88ab\u89e6\u53d1\u3002\u67e5\u770bAlertmanager\u8f93\u51fa\u65e5\u5fd7\uff1a</p> <pre><code>11:14:41      a3 | level=debug ts=2018-03-12T03:14:41.945493505Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=hostCpuUsageAlert[7d698ac][active]\n11:14:41      a1 | level=debug ts=2018-03-12T03:14:41.945534548Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=hostCpuUsageAlert[7d698ac][active]\n11:14:41      a2 | level=debug ts=2018-03-12T03:14:41.945687812Z caller=dispatch.go:188 component=dispatcher msg=\"Received alert\" alert=hostCpuUsageAlert[7d698ac][active]\n</code></pre> <p>3\u4e2aAlertmanager\u5b9e\u4f8b\u5206\u522b\u63a5\u6536\u5230\u6765\u81ea\u4e0d\u540cPrometheus\u5b9e\u4f8b\u7684\u544a\u8b66\u4fe1\u606f\u3002\u800cWebhook\u670d\u52a1\u53ea\u63a5\u6536\u5230\u6765\u81eaAlertmanager\u96c6\u7fa4\u7684\u4e00\u6761\u544a\u8b66\u901a\u77e5\uff1a</p> <pre><code>11:15:11 webhook | 2018/03/12 11:15:11 {\n11:15:11 webhook |  &gt;  \"receiver\": \"default-receiver\",\n11:15:11 webhook |  &gt;  \"status\": \"firing\",\n11:15:11 webhook |  &gt;  \"alerts\": [\n11:15:11 webhook |  &gt;    {\n11:15:11 webhook |  &gt;      \"status\": \"firing\",\n11:15:11 webhook |  &gt;      \"labels\": {\n11:15:11 webhook |  &gt;        \"alertname\": \"hostCpuUsageAlert\",\n</code></pre>"},{"location":"ha/prometheus-and-high-availability/","title":"Prometheus\u9ad8\u53ef\u7528\u90e8\u7f72","text":"<p>Prometheus\u7684\u672c\u5730\u5b58\u50a8\u7ed9Prometheus\u5e26\u6765\u4e86\u7b80\u5355\u9ad8\u6548\u7684\u4f7f\u7528\u4f53\u9a8c\uff0c\u53ef\u4ee5\u8ba9Prometheus\u5728\u5355\u8282\u70b9\u7684\u60c5\u51b5\u4e0b\u6ee1\u8db3\u5927\u90e8\u5206\u7528\u6237\u7684\u76d1\u63a7\u9700\u6c42\u3002\u4f46\u662f\u672c\u5730\u5b58\u50a8\u4e5f\u540c\u65f6\u9650\u5236\u4e86Prometheus\u7684\u53ef\u6269\u5c55\u6027\uff0c\u5e26\u6765\u4e86\u6570\u636e\u6301\u4e45\u5316\u7b49\u4e00\u7cfb\u5217\u7684\u95ee\u9898\u3002\u901a\u8fc7Prometheus\u7684Remote Storage\u7279\u6027\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e00\u7cfb\u5217\u95ee\u9898\uff0c\u5305\u62ecPrometheus\u7684\u52a8\u6001\u6269\u5c55\uff0c\u4ee5\u53ca\u5386\u53f2\u6570\u636e\u7684\u5b58\u50a8\u3002</p> <p>\u800c\u9664\u4e86\u6570\u636e\u6301\u4e45\u5316\u95ee\u9898\u4ee5\u5916\uff0c\u5f71\u54cdPrometheus\u6027\u80fd\u8868\u73b0\u7684\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u56e0\u7d20\u5c31\u662f\u6570\u636e\u91c7\u96c6\u4efb\u52a1\u91cf\uff0c\u4ee5\u53ca\u5355\u53f0Prometheus\u80fd\u591f\u5904\u7406\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u3002\u56e0\u6b64\u5f53\u76d1\u63a7\u89c4\u6a21\u5927\u5230Prometheus\u5355\u53f0\u65e0\u6cd5\u6709\u6548\u5904\u7406\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u9009\u62e9\u5229\u7528Prometheus\u7684\u8054\u90a6\u96c6\u7fa4\u7684\u7279\u6027\uff0c\u5c06Prometheus\u7684\u76d1\u63a7\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684\u5b9e\u4f8b\u5f53\u4e2d\u3002</p> <p>\u8fd9\u4e00\u90e8\u5206\u5c06\u91cd\u70b9\u8ba8\u8bbaPrometheus\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u5e76\u4e14\u6839\u636e\u4e0d\u540c\u7684\u4f7f\u7528\u573a\u666f\u4ecb\u7ecd\u4e86\u4e00\u79cd\u5e38\u89c1\u7684\u9ad8\u53ef\u7528\u65b9\u6848\u3002</p>"},{"location":"ha/prometheus-and-high-availability/#ha","title":"\u57fa\u672cHA\uff1a\u670d\u52a1\u53ef\u7528\u6027","text":"<p>\u7531\u4e8ePrometheus\u7684Pull\u673a\u5236\u7684\u8bbe\u8ba1\uff0c\u4e3a\u4e86\u786e\u4fddPrometheus\u670d\u52a1\u7684\u53ef\u7528\u6027\uff0c\u7528\u6237\u53ea\u9700\u8981\u90e8\u7f72\u591a\u5957Prometheus Server\u5b9e\u4f8b\uff0c\u5e76\u4e14\u91c7\u96c6\u76f8\u540c\u7684Exporter\u76ee\u6807\u5373\u53ef\u3002</p> <p></p> <p>\u57fa\u672c\u7684HA\u6a21\u5f0f\u53ea\u80fd\u786e\u4fddPrometheus\u670d\u52a1\u7684\u53ef\u7528\u6027\u95ee\u9898\uff0c\u4f46\u662f\u4e0d\u89e3\u51b3Prometheus Server\u4e4b\u95f4\u7684\u6570\u636e\u4e00\u81f4\u6027\u95ee\u9898\u4ee5\u53ca\u6301\u4e45\u5316\u95ee\u9898(\u6570\u636e\u4e22\u5931\u540e\u65e0\u6cd5\u6062\u590d)\uff0c\u4e5f\u65e0\u6cd5\u8fdb\u884c\u52a8\u6001\u7684\u6269\u5c55\u3002\u56e0\u6b64\u8fd9\u79cd\u90e8\u7f72\u65b9\u5f0f\u9002\u5408\u76d1\u63a7\u89c4\u6a21\u4e0d\u5927\uff0cPrometheus Server\u4e5f\u4e0d\u4f1a\u9891\u7e41\u53d1\u751f\u8fc1\u79fb\u7684\u60c5\u51b5\uff0c\u5e76\u4e14\u53ea\u9700\u8981\u4fdd\u5b58\u77ed\u5468\u671f\u76d1\u63a7\u6570\u636e\u7684\u573a\u666f\u3002</p>"},{"location":"ha/prometheus-and-high-availability/#ha_1","title":"\u57fa\u672cHA + \u8fdc\u7a0b\u5b58\u50a8","text":"<p>\u5728\u57fa\u672cHA\u6a21\u5f0f\u7684\u57fa\u7840\u4e0a\u901a\u8fc7\u6dfb\u52a0Remote Storage\u5b58\u50a8\u652f\u6301\uff0c\u5c06\u76d1\u63a7\u6570\u636e\u4fdd\u5b58\u5728\u7b2c\u4e09\u65b9\u5b58\u50a8\u670d\u52a1\u4e0a\u3002</p> <p></p> <p>\u5728\u89e3\u51b3\u4e86Prometheus\u670d\u52a1\u53ef\u7528\u6027\u7684\u57fa\u7840\u4e0a\uff0c\u540c\u65f6\u786e\u4fdd\u4e86\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u5f53Prometheus Server\u53d1\u751f\u5b95\u673a\u6216\u8005\u6570\u636e\u4e22\u5931\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5feb\u901f\u7684\u6062\u590d\u3002 \u540c\u65f6Prometheus Server\u53ef\u80fd\u5f88\u597d\u7684\u8fdb\u884c\u8fc1\u79fb\u3002\u56e0\u6b64\uff0c\u8be5\u65b9\u6848\u9002\u7528\u4e8e\u7528\u6237\u76d1\u63a7\u89c4\u6a21\u4e0d\u5927\uff0c\u4f46\u662f\u5e0c\u671b\u80fd\u591f\b\u5c06\u76d1\u63a7\u6570\u636e\u6301\u4e45\u5316\uff0c\u540c\u65f6\u80fd\u591f\u786e\u4fddPrometheus Server\u7684\u53ef\u8fc1\u79fb\u6027\u7684\u573a\u666f\u3002</p>"},{"location":"ha/prometheus-and-high-availability/#ha_2","title":"\u57fa\u672cHA + \u8fdc\u7a0b\u5b58\u50a8 + \u8054\u90a6\u96c6\u7fa4","text":"<p>\u5f53\u5355\u53f0Prometheus Server\u65e0\u6cd5\u5904\u7406\u5927\u91cf\u7684\u91c7\u96c6\u4efb\u52a1\u65f6\uff0c\u7528\u6237\u53ef\u4ee5\u8003\u8651\u57fa\u4e8ePrometheus\u8054\u90a6\u96c6\u7fa4\u7684\u65b9\u5f0f\u5c06\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684Prometheus\u5b9e\u4f8b\u5f53\u4e2d\u5373\u5728\u4efb\u52a1\u7ea7\u522b\u529f\u80fd\u5206\u533a\u3002</p> <p></p> <p>\u8fd9\u79cd\u90e8\u7f72\u65b9\u5f0f\u4e00\u822c\u9002\u7528\u4e8e\u4e24\u79cd\u573a\u666f\uff1a</p> <p>\u573a\u666f\u4e00\uff1a\u5355\u6570\u636e\u4e2d\u5fc3 + \u5927\u91cf\u7684\u91c7\u96c6\u4efb\u52a1</p> <p>\u8fd9\u79cd\u573a\u666f\u4e0bPrometheus\u7684\u6027\u80fd\u74f6\u9888\u4e3b\u8981\u5728\u4e8e\u5927\u91cf\u7684\u91c7\u96c6\u4efb\u52a1\uff0c\u56e0\u6b64\u7528\u6237\u9700\u8981\u5229\u7528Prometheus\u8054\u90a6\u96c6\u7fa4\u7684\u7279\u6027\uff0c\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684Prometheus\u5b50\u670d\u52a1\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u529f\u80fd\u5206\u533a\u3002\u4f8b\u5982\u4e00\u4e2aPrometheus Server\u8d1f\u8d23\u91c7\u96c6\u57fa\u7840\u8bbe\u65bd\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\uff0c\u53e6\u5916\u4e00\u4e2aPrometheus Server\u8d1f\u8d23\u91c7\u96c6\u5e94\u7528\u76d1\u63a7\u6307\u6807\u3002\u518d\u6709\u4e0a\u5c42Prometheus Server\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u6c47\u805a\u3002</p> <p>\u573a\u666f\u4e8c\uff1a\u591a\u6570\u636e\u4e2d\u5fc3</p> <p>\u8fd9\u79cd\u6a21\u5f0f\u4e5f\u9002\u5408\u4e0e\u591a\u6570\u636e\u4e2d\u5fc3\u7684\u60c5\u51b5\uff0c\u5f53Prometheus Server\u65e0\u6cd5\u76f4\u63a5\u4e0e\u6570\u636e\u4e2d\u5fc3\u4e2d\u7684Exporter\u8fdb\u884c\u901a\u8baf\u65f6\uff0c\u5728\u6bcf\u4e00\u4e2a\u6570\u636e\u4e2d\u90e8\u7f72\u4e00\u4e2a\u5355\u72ec\u7684Prometheus Server\u8d1f\u8d23\u5f53\u524d\u6570\u636e\u4e2d\u5fc3\u7684\u91c7\u96c6\u4efb\u52a1\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u65b9\u5f0f\u3002\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u7528\u6237\u8fdb\u884c\u5927\u91cf\u7684\u7f51\u7edc\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u786e\u4fdd\u4e3bPrometheus Server\u5b9e\u4f8b\u80fd\u591f\u4e0e\u5f53\u524d\u6570\u636e\u4e2d\u5fc3\u7684Prometheus Server\u901a\u8baf\u5373\u53ef\u3002 \u4e2d\u5fc3Prometheus Server\u8d1f\u8d23\u5b9e\u73b0\u5bf9\u591a\u6570\u636e\u4e2d\u5fc3\u6570\u636e\u7684\u805a\u5408\u3002</p>"},{"location":"ha/prometheus-and-high-availability/#_1","title":"\u6309\u7167\u5b9e\u4f8b\u8fdb\u884c\u529f\u80fd\u5206\u533a","text":"<p>\u8fd9\u65f6\u5728\u8003\u8651\u53e6\u5916\u4e00\u79cd\u6781\u7aef\u60c5\u51b5\uff0c\u5373\u5355\u4e2a\u91c7\u96c6\u4efb\u52a1\u7684Target\u6570\u4e5f\u53d8\u5f97\u975e\u5e38\u5de8\u5927\u3002\u8fd9\u65f6\u7b80\u5355\u901a\u8fc7\u8054\u90a6\u96c6\u7fa4\u8fdb\u884c\u529f\u80fd\u5206\u533a\uff0cPrometheus Server\u4e5f\u65e0\u6cd5\u6709\u6548\u5904\u7406\u65f6\u3002\u8fd9\u79cd\u60c5\u51b5\u53ea\u80fd\u8003\u8651\u7ee7\u7eed\u5728\u5b9e\u4f8b\u7ea7\u522b\u8fdb\u884c\u529f\u80fd\u5212\u5206\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5c06\u7edf\u4e00\u4efb\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u7684\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684Prometheus\u5b9e\u4f8b\u3002\u901a\u8fc7relabel\u8bbe\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u786e\u4fdd\u5f53\u524dPrometheus Server\u53ea\u6536\u96c6\u5f53\u524d\u91c7\u96c6\u4efb\u52a1\u7684\u4e00\u90e8\u5206\u5b9e\u4f8b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <pre><code>global:\n  external_labels:\n    slave: 1  # This is the 2nd slave. This prevents clashes between slaves.\nscrape_configs:\n  - job_name: some_job\n    relabel_configs:\n    - source_labels: [__address__]\n      modulus:       4\n      target_label:  __tmp_hash\n      action:        hashmod\n    - source_labels: [__tmp_hash]\n      regex:         ^1$\n      action:        keep\n</code></pre> <p>\u5e76\u4e14\u901a\u8fc7\u5f53\u524d\u6570\u636e\u4e2d\u5fc3\u7684\u4e00\u4e2a\u4e2d\u5fc3Prometheus Server\u5c06\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u805a\u5408\u5230\u4efb\u52a1\u7ea7\u522b\u3002</p> <pre><code>- scrape_config:\n  - job_name: slaves\n    honor_labels: true\n    metrics_path: /federate\n    params:\n      match[]:\n        - '{__name__=~\"^slave:.*\"}'   # Request all slave-level time series\n    static_configs:\n      - targets:\n        - slave0:9090\n        - slave1:9090\n        - slave3:9090\n        - slave4:9090\n</code></pre>"},{"location":"ha/prometheus-and-high-availability/#_2","title":"\u9ad8\u53ef\u7528\u65b9\u6848\u9009\u62e9","text":"<p>\u4e0a\u9762\u7684\u90e8\u5206\uff0c\u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\u6f14\u793a\u4e863\u79cd\u4e0d\u540c\u7684\u9ad8\u53ef\u7528\u90e8\u7f72\u65b9\u6848\u3002\u5f53\u7136\u5bf9\u4e8ePrometheus\u90e8\u7f72\u65b9\u6848\u9700\u8981\u7528\u6237\u6839\u636e\u76d1\u63a7\u89c4\u6a21\u4ee5\u53ca\u81ea\u8eab\u7684\u9700\u6c42\u8fdb\u884c\u52a8\u6001\u8c03\u6574\uff0c\u4e0b\u8868\u5c55\u793a\u4e86Prometheus\u548c\u9ad8\u53ef\u7528\u6709\u51733\u4e2a\u9009\u9879\u5404\u81ea\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u7075\u6d3b\u9009\u62e9\u3002</p> \u9009\u9879\\\u9700\u6c42 \u670d\u52a1\u53ef\u7528\u6027 \u6570\u636e\u6301\u4e45\u5316 \u6c34\u5e73\u6269\u5c55 \u4e3b\u5907HA v x x \u8fdc\u7a0b\u5b58\u50a8 x v x \u8054\u90a6\u96c6\u7fa4 x x v"},{"location":"ha/prometheus-local-storage/","title":"Prometheus\u6570\u636e\u5b58\u50a8","text":""},{"location":"ha/prometheus-local-storage/#_1","title":"\u672c\u5730\u5b58\u50a8","text":"<p>Prometheus 2.x \u91c7\u7528\u81ea\u5b9a\u4e49\u7684\u5b58\u50a8\u683c\u5f0f\u5c06\u6837\u672c\u6570\u636e\u4fdd\u5b58\u5728\u672c\u5730\u78c1\u76d8\u5f53\u4e2d\u3002\u5982\u4e0b\u6240\u793a\uff0c\u6309\u7167\u4e24\u4e2a\u5c0f\u65f6\u4e3a\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\uff0c\u5c06\u4e24\u5c0f\u65f6\u5185\u4ea7\u751f\u7684\u6570\u636e\u5b58\u50a8\u5728\u4e00\u4e2a\u5757(Block)\u4e2d\uff0c\u6bcf\u4e00\u4e2a\u5757\u4e2d\u5305\u542b\u8be5\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6240\u6709\u6837\u672c\u6570\u636e(chunks)\uff0c\u5143\u6570\u636e\u6587\u4ef6(meta.json)\u4ee5\u53ca\u7d22\u5f15\u6587\u4ef6(index)\u3002</p> <pre><code>t0            t1             t2             now\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502           \u2502  \u2502           \u2502  \u2502           \u2502                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502           \u2502  \u2502           \u2502  \u2502  mutable  \u2502 &lt;\u2500\u2500\u2500 write \u2500\u2500\u2500\u2500 \u2524 Prometheus \u2502\n \u2502           \u2502  \u2502           \u2502  \u2502           \u2502                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                        ^\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518                              \u2502\n                              \u2502                                   query\n                              \u2502                                     \u2502\n                            merge \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u5f53\u524d\u65f6\u95f4\u7a97\u53e3\u5185\u6b63\u5728\u6536\u96c6\u7684\u6837\u672c\u6570\u636e\uff0cPrometheus\u5219\u4f1a\u76f4\u63a5\u5c06\u6570\u636e\u4fdd\u5b58\u5728\u5185\u5b58\u5f53\u4e2d\u3002\u4e3a\u4e86\u786e\u4fdd\u6b64\u671f\u95f4\u5982\u679cPrometheus\u53d1\u751f\u5d29\u6e83\u6216\u8005\u91cd\u542f\u65f6\u80fd\u591f\u6062\u590d\u6570\u636e\uff0cPrometheus\u542f\u52a8\u65f6\u4f1a\u4ece\u5199\u5165\u65e5\u5fd7(WAL)\u8fdb\u884c\u91cd\u64ad\uff0c\u4ece\u800c\u6062\u590d\u6570\u636e\u3002\u6b64\u671f\u95f4\u5982\u679c\u901a\u8fc7API\u5220\u9664\u65f6\u95f4\u5e8f\u5217\uff0c\u5220\u9664\u8bb0\u5f55\u4e5f\u4f1a\u4fdd\u5b58\u5728\u5355\u72ec\u7684\u903b\u8f91\u6587\u4ef6\u5f53\u4e2d(tombstone)\u3002</p> <p>\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8fd9\u4e9b\u5757\u4fdd\u5b58\u5728\u5355\u72ec\u7684\u76ee\u5f55\u5f53\u4e2d\uff0cPrometheus\u4fdd\u5b58\u5757\u6570\u636e\u7684\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>./data \n   |- 01BKGV7JBM69T2G1BGBGM6KB12 # \u5757\n      |- meta.json  # \u5143\u6570\u636e\n      |- wal        # \u5199\u5165\u65e5\u5fd7\n        |- 000002\n        |- 000001\n   |- 01BKGTZQ1SYQJTR4PB43C8PD98  # \u5757\n      |- meta.json  #\u5143\u6570\u636e\n      |- index   # \u7d22\u5f15\u6587\u4ef6\n      |- chunks  # \u6837\u672c\u6570\u636e\n        |- 000001\n      |- tombstones # \u903b\u8f91\u6570\u636e\n   |- 01BKGTZQ1HHWHV8FBJXW1Y3W0K\n      |- meta.json\n      |- wal\n        |-000001\n</code></pre> <p>\u901a\u8fc7\u65f6\u95f4\u7a97\u53e3\u7684\u5f62\u5f0f\u4fdd\u5b58\u6240\u6709\u7684\u6837\u672c\u6570\u636e\uff0c\u53ef\u4ee5\u660e\u663e\u63d0\u9ad8Prometheus\u7684\u67e5\u8be2\u6548\u7387\uff0c\u5f53\u67e5\u8be2\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6240\u6709\u6837\u672c\u6570\u636e\u65f6\uff0c\u53ea\u9700\u8981\u7b80\u5355\u7684\u4ece\u843d\u5728\u8be5\u8303\u56f4\u5185\u7684\u5757\u4e2d\u67e5\u8be2\u6570\u636e\u5373\u53ef\u3002</p> <p>\u540c\u65f6\u8be5\u5b58\u50a8\u65b9\u5f0f\u53ef\u4ee5\u7b80\u5316\u5386\u53f2\u6570\u636e\u7684\u5220\u9664\u903b\u8f91\u3002\u53ea\u8981\u4e00\u4e2a\u5757\u7684\u65f6\u95f4\u8303\u56f4\u843d\u5728\u4e86\u914d\u7f6e\u7684\u4fdd\u7559\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u4e22\u5f03\u8be5\u5757\u5373\u53ef\u3002</p> <pre><code>                      |\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \n \u2502 1          \u2502  \u2502 2  |     \u2502  \u2502 3         \u2502  \u2502 4         \u2502 . . .\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \n                      |\n                      |\n             retention boundary\n</code></pre>"},{"location":"ha/prometheus-local-storage/#_2","title":"\u672c\u5730\u5b58\u50a8\u914d\u7f6e","text":"<p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u542f\u52a8\u53c2\u6570\u7684\u65b9\u5f0f\u4fee\u6539\u672c\u5730\u5b58\u50a8\u7684\u914d\u7f6e\u3002</p> \u542f\u52a8\u53c2\u6570 \u9ed8\u8ba4\u503c \u542b\u4e49 --storage.tsdb.path data/ Base path for metrics storage --storage.tsdb.retention 15d How long to retain samples in the storage --storage.tsdb.min-block-duration 2h The timestamp range of head blocks after which they get persisted --storage.tsdb.max-block-duration 36h The maximum timestamp range of compacted blocks,It's the minimum duration of any persisted block. --storage.tsdb.no-lockfile false Do not create lockfile in data directory <p>\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\uff0cPrometheus\u4e2d\u5b58\u50a8\u7684\u6bcf\u4e00\u4e2a\u6837\u672c\u5927\u6982\u5360\u75281-2\u5b57\u8282\u5927\u5c0f\u3002\u5982\u679c\u9700\u8981\u5bf9Prometheus Server\u7684\u672c\u5730\u78c1\u76d8\u7a7a\u95f4\u505a\u5bb9\u91cf\u89c4\u5212\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u516c\u5f0f\u8ba1\u7b97\uff1a</p> <pre><code>needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample\n</code></pre> <p>\u4ece\u4e0a\u9762\u516c\u5f0f\u4e2d\u53ef\u4ee5\u770b\u51fa\u5728\u4fdd\u7559\u65f6\u95f4(retention_time_seconds)\u548c\u6837\u672c\u5927\u5c0f(bytes_per_sample)\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u60f3\u51cf\u5c11\u672c\u5730\u78c1\u76d8\u7684\u5bb9\u91cf\u9700\u6c42\uff0c\u53ea\u80fd\u901a\u8fc7\u51cf\u5c11\u6bcf\u79d2\u83b7\u53d6\u6837\u672c\u6570(ingested_samples_per_second)\u7684\u65b9\u5f0f\u3002\u56e0\u6b64\u6709\u4e24\u79cd\u624b\u6bb5\uff0c\u4e00\u662f\u51cf\u5c11\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\uff0c\u4e8c\u662f\u589e\u52a0\u91c7\u96c6\u6837\u672c\u7684\u65f6\u95f4\u95f4\u9694\u3002\u8003\u8651\u5230Prometheus\u4f1a\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u538b\u7f29\u6548\u7387\uff0c\u51cf\u5c11\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\u6548\u679c\u66f4\u660e\u663e\u3002</p>"},{"location":"ha/prometheus-local-storage/#_3","title":"\u4ece\u5931\u8d25\u4e2d\u6062\u590d","text":"<p>\u5982\u679c\u672c\u5730\u5b58\u50a8\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\u5c31\u662f\u505c\u6b62Prometheus\u5e76\u4e14\u5220\u9664data\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u8bb0\u5f55\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u5220\u9664\u90a3\u4e9b\u53d1\u751f\u9519\u8bef\u7684\u5757\u76ee\u5f55\uff0c\u4e0d\u8fc7\u76f8\u5e94\u7684\u7528\u6237\u4f1a\u4e22\u5931\u8be5\u5757\u4e2d\u4fdd\u5b58\u7684\u5927\u6982\u4e24\u4e2a\u5c0f\u65f6\u7684\u76d1\u63a7\u8bb0\u5f55\u3002</p>"},{"location":"ha/prometheus-remote-storage/","title":"\u8fdc\u7a0b\u5b58\u50a8","text":"<p>Prometheus\u7684\u672c\u5730\u5b58\u50a8\u8bbe\u8ba1\u53ef\u4ee5\u51cf\u5c11\u5176\u81ea\u8eab\u8fd0\u7ef4\u548c\u7ba1\u7406\u7684\u590d\u6742\u5ea6\uff0c\u540c\u65f6\u80fd\u591f\u6ee1\u8db3\u5927\u90e8\u5206\u7528\u6237\u76d1\u63a7\u89c4\u6a21\u7684\u9700\u6c42\u3002\u4f46\u662f\u672c\u5730\u5b58\u50a8\u4e5f\u610f\u5473\u7740Prometheus\u65e0\u6cd5\u6301\u4e45\u5316\u6570\u636e\uff0c\u65e0\u6cd5\u5b58\u50a8\u5927\u91cf\u5386\u53f2\u6570\u636e\uff0c\u540c\u65f6\u4e5f\u65e0\u6cd5\u7075\u6d3b\u6269\u5c55\u548c\u8fc1\u79fb\u3002</p> <p>\u4e3a\u4e86\u4fdd\u6301Prometheus\u7684\u7b80\u5355\u6027\uff0cPrometheus\u5e76\u6ca1\u6709\u5c1d\u8bd5\u5728\u81ea\u8eab\u4e2d\u89e3\u51b3\u4ee5\u4e0a\u95ee\u9898\uff0c\u800c\u662f\u901a\u8fc7\u5b9a\u4e49\u4e24\u4e2a\u6807\u51c6\u63a5\u53e3(remote_write/remote_read)\uff0c\u8ba9\u7528\u6237\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e24\u4e2a\u63a5\u53e3\u5bf9\u63a5\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u4efb\u610f\u7b2c\u4e09\u65b9\u7684\u5b58\u50a8\u670d\u52a1\u4e2d\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5728Prometheus\u4e2d\u79f0\u4e3aRemote Storage\u3002</p>"},{"location":"ha/prometheus-remote-storage/#remote-write","title":"Remote Write","text":"<p>\u7528\u6237\u53ef\u4ee5\u5728Prometheus\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9aRemote Write(\u8fdc\u7a0b\u5199)\u7684URL\u5730\u5740\uff0c\u4e00\u65e6\u8bbe\u7f6e\u4e86\u8be5\u914d\u7f6e\u9879\uff0cPrometheus\u5c06\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u901a\u8fc7HTTP\u7684\u5f62\u5f0f\u53d1\u9001\u7ed9\u9002\u914d\u5668(Adaptor)\u3002\u800c\u7528\u6237\u5219\u53ef\u4ee5\u5728\u9002\u914d\u5668\u4e2d\u5bf9\u63a5\u5916\u90e8\u4efb\u610f\u7684\u670d\u52a1\u3002\u5916\u90e8\u670d\u52a1\u53ef\u4ee5\u662f\u771f\u6b63\u7684\u5b58\u50a8\u7cfb\u7edf\uff0c\u516c\u6709\u4e91\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u662f\u6d88\u606f\u961f\u5217\u7b49\u4efb\u610f\u5f62\u5f0f\u3002</p> <p></p>"},{"location":"ha/prometheus-remote-storage/#remote-read","title":"Remote Read","text":"<p>\u5982\u4e0b\u56fe\u6240\u793a\uff0cPrometheus\u7684Remote Read(\u8fdc\u7a0b\u8bfb)\u4e5f\u901a\u8fc7\u4e86\u4e00\u4e2a\u9002\u914d\u5668\u5b9e\u73b0\u3002\u5728\u8fdc\u7a0b\u8bfb\u7684\u6d41\u7a0b\u5f53\u4e2d\uff0c\u5f53\u7528\u6237\u53d1\u8d77\u67e5\u8be2\u8bf7\u6c42\u540e\uff0cPrometheus\u5c06\u5411remote_read\u4e2d\u914d\u7f6e\u7684URL\u53d1\u8d77\u67e5\u8be2\u8bf7\u6c42(matchers,ranges)\uff0cAdaptor\u6839\u636e\u8bf7\u6c42\u6761\u4ef6\u4ece\u7b2c\u4e09\u65b9\u5b58\u50a8\u670d\u52a1\u4e2d\u83b7\u53d6\u54cd\u5e94\u7684\u6570\u636e\u3002\u540c\u65f6\u5c06\u6570\u636e\u8f6c\u6362\u4e3aPrometheus\u7684\u539f\u59cb\u6837\u672c\u6570\u636e\u8fd4\u56de\u7ed9Prometheus Server\u3002</p> <p>\u5f53\u83b7\u53d6\u5230\u6837\u672c\u6570\u636e\u540e\uff0cPrometheus\u5728\u672c\u5730\u4f7f\u7528PromQL\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u4e8c\u6b21\u5904\u7406\u3002</p> <p>\u6ce8\u610f\uff1a\u542f\u7528\u8fdc\u7a0b\u8bfb\u8bbe\u7f6e\u540e\uff0c\u53ea\u5728\u6570\u636e\u67e5\u8be2\u65f6\u6709\u6548\uff0c\u5bf9\u4e8e\u89c4\u5219\u6587\u4ef6\u7684\u5904\u7406\uff0c\u4ee5\u53caMetadata API\u7684\u5904\u7406\u90fd\u53ea\u57fa\u4e8ePrometheus\u672c\u5730\u5b58\u50a8\u5b8c\u6210\u3002</p> <p></p>"},{"location":"ha/prometheus-remote-storage/#_2","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>Prometheus\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0remote_write\u548cremote_read\u914d\u7f6e\uff0c\u5176\u4e2durl\u7528\u4e8e\u6307\u5b9a\u8fdc\u7a0b\u8bfb/\u5199\u7684HTTP\u670d\u52a1\u5730\u5740\u3002\u5982\u679c\u8be5URL\u542f\u52a8\u4e86\u8ba4\u8bc1\u5219\u53ef\u4ee5\u901a\u8fc7basic_auth\u8fdb\u884c\u5b89\u5168\u8ba4\u8bc1\u914d\u7f6e\u3002\u5bf9\u4e8ehttps\u7684\u652f\u6301\u9700\u8981\u8bbe\u5b9atls_concig\u3002proxy_url\u4e3b\u8981\u7528\u4e8ePrometheus\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u9002\u914d\u5668\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u3002</p> <p>remote_write\u548cremote_read\u5177\u4f53\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>remote_write:\n    url: &lt;string&gt;\n    [ remote_timeout: &lt;duration&gt; | default = 30s ]\n    write_relabel_configs:\n    [ - &lt;relabel_config&gt; ... ]\n    basic_auth:\n    [ username: &lt;string&gt; ]\n    [ password: &lt;string&gt; ]\n    [ bearer_token: &lt;string&gt; ]\n    [ bearer_token_file: /path/to/bearer/token/file ]\n    tls_config:\n    [ &lt;tls_config&gt; ]\n    [ proxy_url: &lt;string&gt; ]\n\nremote_read:\n    url: &lt;string&gt;\n    required_matchers:\n    [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]\n    [ remote_timeout: &lt;duration&gt; | default = 30s ]\n    [ read_recent: &lt;boolean&gt; | default = false ]\n    basic_auth:\n    [ username: &lt;string&gt; ]\n    [ password: &lt;string&gt; ]\n    [ bearer_token: &lt;string&gt; ]\n    [ bearer_token_file: /path/to/bearer/token/file ]\n    [ &lt;tls_config&gt; ]\n    [ proxy_url: &lt;string&gt; ]\n</code></pre>"},{"location":"ha/prometheus-remote-storage/#remote-storage-adaptor","title":"\u81ea\u5b9a\u4e49Remote Storage Adaptor","text":"<p>\u5b9e\u73b0\u81ea\u5b9a\u4e49Remote Storage\u9700\u8981\u7528\u6237\u5206\u522b\u521b\u5efa\u7528\u4e8e\u652f\u6301remote_read\u548cremote_write\u7684HTTP\u670d\u52a1\u3002</p> <p></p> <p>\u5f53\u524dPrometheus\u4e2dRemote Storage\u76f8\u5173\u7684\u534f\u8bae\u4e3b\u8981\u901a\u8fc7\u4ee5\u4e0bproto\u6587\u4ef6\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>syntax = \"proto3\";\npackage prometheus;\n\noption go_package = \"prompb\";\n\nimport \"types.proto\";\n\nmessage WriteRequest {\n  repeated prometheus.TimeSeries timeseries = 1;\n}\n\nmessage ReadRequest {\n  repeated Query queries = 1;\n}\n\nmessage ReadResponse {\n  // In same order as the request's queries.\n  repeated QueryResult results = 1;\n}\n\nmessage Query {\n  int64 start_timestamp_ms = 1;\n  int64 end_timestamp_ms = 2;\n  repeated prometheus.LabelMatcher matchers = 3;\n}\n\nmessage QueryResult {\n  // Samples within a time series must be ordered by time.\n  repeated prometheus.TimeSeries timeseries = 1;\n}\n</code></pre> <p>\u4ee5\u4e0b\u4ee3\u7801\u5c55\u793a\u4e86\u4e00\u4e2a\u7b80\u5355\u7684remote_write\u670d\u52a1\uff0c\u521b\u5efa\u7528\u4e8e\u63a5\u6536remote_write\u7684HTTP\u670d\u52a1\uff0c\u5c06\u8bf7\u6c42\u5185\u5bb9\u8f6c\u6362\u6210WriteRequest\u540e\uff0c\u7528\u6237\u5c31\u53ef\u4ee5\u6309\u7167\u81ea\u5df1\u7684\u9700\u6c42\u8fdb\u884c\u540e\u7eed\u7684\u903b\u8f91\u5904\u7406\u3002</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"io/ioutil\"\n    \"net/http\"\n\n    \"github.com/gogo/protobuf/proto\"\n    \"github.com/golang/snappy\"\n    \"github.com/prometheus/common/model\"\n\n    \"github.com/prometheus/prometheus/prompb\"\n)\n\nfunc main() {\n    http.HandleFunc(\"/receive\", func(w http.ResponseWriter, r *http.Request) {\n        compressed, err := ioutil.ReadAll(r.Body)\n        if err != nil {\n            http.Error(w, err.Error(), http.StatusInternalServerError)\n            return\n        }\n\n        reqBuf, err := snappy.Decode(nil, compressed)\n        if err != nil {\n            http.Error(w, err.Error(), http.StatusBadRequest)\n            return\n        }\n\n        var req prompb.WriteRequest\n        if err := proto.Unmarshal(reqBuf, &amp;req); err != nil {\n            http.Error(w, err.Error(), http.StatusBadRequest)\n            return\n        }\n\n        for _, ts := range req.Timeseries {\n            m := make(model.Metric, len(ts.Labels))\n            for _, l := range ts.Labels {\n                m[model.LabelName(l.Name)] = model.LabelValue(l.Value)\n            }\n            fmt.Println(m)\n\n            for _, s := range ts.Samples {\n                fmt.Printf(\"  %f %d\\n\", s.Value, s.Timestamp)\n            }\n        }\n    })\n\n    http.ListenAndServe(\":1234\", nil)\n}\n</code></pre>"},{"location":"ha/prometheus-remote-storage/#influxdbremote-storage","title":"\u4f7f\u7528Influxdb\u4f5c\u4e3aRemote Storage","text":"<p>\u76ee\u524dPrometheus\u793e\u533a\u4e5f\u63d0\u4f9b\u4e86\u90e8\u5206\u5bf9\u4e8e\u7b2c\u4e09\u65b9\u6570\u636e\u5e93\u7684Remote Storage\u652f\u6301\uff1a</p> \u5b58\u50a8\u670d\u52a1 \u652f\u6301\u6a21\u5f0f AppOptics write Chronix write Cortex: read/write CrateDB read/write Gnocchi write Graphite write InfluxDB read/write OpenTSDB write PostgreSQL/TimescaleDB: read/write SignalFx write <p>\u8fd9\u91cc\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Influxdb\u4f5c\u4e3aPrometheus\u7684Remote Storage\uff0c\u4ece\u800c\u786e\u4fdd\u5f53Prometheus\u53d1\u751f\u5b95\u673a\u6216\u8005\u91cd\u542f\u4e4b\u540e\u80fd\u591f\u4eceInfluxdb\u4e2d\u6062\u590d\u548c\u83b7\u53d6\u5386\u53f2\u6570\u636e\u3002</p> <p>\u8fd9\u91cc\u4f7f\u7528docker-compose\u5b9a\u4e49\u5e76\u542f\u52a8Influxdb\u6570\u636e\u5e93\u670d\u52a1\uff0cdocker-compose.yml\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>version: '2'\nservices:\n  influxdb:\n    image: influxdb:1.3.5\n    command: -config /etc/influxdb/influxdb.conf\n    ports:\n      - \"8086:8086\"\n    environment:\n      - INFLUXDB_DB=prometheus\n      - INFLUXDB_ADMIN_ENABLED=true\n      - INFLUXDB_ADMIN_USER=admin\n      - INFLUXDB_ADMIN_PASSWORD=admin\n      - INFLUXDB_USER=prom\n      - INFLUXDB_USER_PASSWORD=prom\n</code></pre> <p>\u542f\u52a8influxdb\u670d\u52a1</p> <pre><code>$ docker-compose up -d\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES\n795d0ead87a1        influxdb:1.3.5      \"/entrypoint.sh -c...\"   3 hours ago         Up 3 hours          0.0.0.0:8086-&gt;8086/tcp   localhost_influxdb_1\n</code></pre> <p>\u83b7\u53d6\u5e76\u542f\u52a8Prometheus\u63d0\u4f9b\u7684Remote Storage Adapter\uff1a</p> <pre><code>go get github.com/prometheus/prometheus/documentation/examples/remote_storage/remote_storage_adapter\n</code></pre> <p>\u83b7\u53d6remote_storage_adapter\u6e90\u7801\u540e\uff0cgo\u4f1a\u81ea\u52a8\u628a\u76f8\u5173\u7684\u6e90\u7801\u7f16\u8bd1\u6210\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u5e76\u4e14\u4fdd\u5b58\u5728$GOPATH/bin/\u76ee\u5f55\u4e0b\u3002</p> <p>\u542f\u52a8remote_storage_adapter\u5e76\u4e14\u8bbe\u7f6eInfluxdb\u76f8\u5173\u7684\u8ba4\u8bc1\u4fe1\u606f\uff1a</p> <pre><code>INFLUXDB_PW=prom $GOPATH/bin/remote_storage_adapter -influxdb-url=http://localhost:8086 -influxdb.username=prom -influxdb.database=prometheus -influxdb.retention-policy=autogen\n</code></pre> <p>\u4fee\u6539prometheus.yml\u6dfb\u52a0Remote Storage\u76f8\u5173\u7684\u914d\u7f6e\u5185\u5bb9\uff1a</p> <pre><code>remote_write:\n  - url: \"http://localhost:9201/write\"\n\nremote_read:\n  - url: \"http://localhost:9201/read\"\n</code></pre> <p>\u91cd\u65b0\u542f\u52a8Prometheus\u80fd\u591f\u83b7\u53d6\u6570\u636e\u540e\uff0c\u767b\u5f55\u5230influxdb\u5bb9\u5668\uff0c\u5e76\u9a8c\u8bc1\u6570\u636e\u5199\u5165\u3002\u5982\u4e0b\u6240\u793a\uff0c\u5f53\u6570\u636e\u80fd\u591f\u6b63\u5e38\u5199\u5165Influxdb\u540e\u53ef\u4ee5\u770b\u5230Prometheus\u76f8\u5173\u7684\u6307\u6807\u3002</p> <pre><code>docker exec -it 795d0ead87a1 influx\nConnected to http://localhost:8086 version 1.3.5\nInfluxDB shell version: 1.3.5\n&gt; auth\nusername: prom\npassword:\n\n&gt; use prometheus\n&gt; SHOW MEASUREMENTS\nname: measurements\nname\n----\ngo_gc_duration_seconds\ngo_gc_duration_seconds_count\ngo_gc_duration_seconds_sum\ngo_goroutines\ngo_info\ngo_memstats_alloc_bytes\ngo_memstats_alloc_bytes_total\ngo_memstats_buck_hash_sys_bytes\ngo_memstats_frees_total\ngo_memstats_gc_cpu_fraction\ngo_memstats_gc_sys_bytes\ngo_memstats_heap_alloc_bytes\ngo_memstats_heap_idle_bytes\n</code></pre> <p>\u5f53\u6570\u636e\u5199\u5165\u6210\u529f\u540e\uff0c\u505c\u6b62Prometheus\u670d\u52a1\u3002\u540c\u65f6\u5220\u9664Prometheus\u7684data\u76ee\u5f55\uff0c\u6a21\u62dfPrometheus\u6570\u636e\u4e22\u5931\u7684\u60c5\u51b5\u540e\u91cd\u542fPrometheus\u3002\u6253\u5f00Prometheus UI\u5982\u679c\u914d\u7f6e\u6b63\u5e38\uff0cPrometheus\u53ef\u4ee5\u6b63\u5e38\u67e5\u8be2\u5230\u672c\u5730\u5b58\u50a8\u4ee5\u5220\u9664\u7684\u5386\u53f2\u6570\u636e\u8bb0\u5f55\u3002</p> <p></p>"},{"location":"ha/scale-prometheus-with-federation/","title":"\u8054\u90a6\u96c6\u7fa4","text":"<p>\u901a\u8fc7Remote Storage\u53ef\u4ee5\u5206\u79bb\u76d1\u63a7\u6837\u672c\u91c7\u96c6\u548c\u6570\u636e\u5b58\u50a8\uff0c\u89e3\u51b3Prometheus\u7684\u6301\u4e45\u5316\u95ee\u9898\u3002\u8fd9\u4e00\u90e8\u5206\u4f1a\u91cd\u70b9\u8ba8\u8bba\u5982\u4f55\u5229\u7528\u8054\u90a6\u96c6\u7fa4\u7279\u6027\u5bf9Prometheus\u8fdb\u884c\u6269\u5c55\uff0c\u4ee5\u9002\u5e94\u4e0d\u540c\u76d1\u63a7\u89c4\u6a21\u7684\u53d8\u5316\u3002</p>"},{"location":"ha/scale-prometheus-with-federation/#_2","title":"\u4f7f\u7528\u8054\u90a6\u96c6\u7fa4","text":"<p>\u5bf9\u4e8e\u5927\u90e8\u5206\u76d1\u63a7\u89c4\u6a21\u800c\u8a00\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u6bcf\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3(\u4f8b\u5982\uff1aEC2\u53ef\u7528\u533a\uff0cKubernetes\u96c6\u7fa4)\u5b89\u88c5\u4e00\u4e2aPrometheus Server\u5b9e\u4f8b\uff0c\u5c31\u53ef\u4ee5\u5728\u5404\u4e2a\u6570\u636e\u4e2d\u5fc3\u5904\u7406\u4e0a\u5343\u89c4\u6a21\u7684\u96c6\u7fa4\u3002\u540c\u65f6\u5c06Prometheus Server\u90e8\u7f72\u5230\u4e0d\u540c\u7684\u6570\u636e\u4e2d\u5fc3\u53ef\u4ee5\u907f\u514d\u7f51\u7edc\u914d\u7f6e\u7684\u590d\u6742\u6027\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5728\u6bcf\u4e2a\u6570\u636e\u4e2d\u5fc3\u90e8\u7f72\u5355\u72ec\u7684Prometheus Server\uff0c\u7528\u4e8e\u91c7\u96c6\u5f53\u524d\u6570\u636e\u4e2d\u5fc3\u76d1\u63a7\u6570\u636e\u3002\u5e76\u7531\u4e00\u4e2a\u4e2d\u5fc3\u7684Prometheus Server\u8d1f\u8d23\u805a\u5408\u591a\u4e2a\u6570\u636e\u4e2d\u5fc3\u7684\u76d1\u63a7\u6570\u636e\u3002\u8fd9\u4e00\u7279\u6027\u5728Prometheus\u4e2d\u79f0\u4e3a\u8054\u90a6\u96c6\u7fa4\u3002</p> <p>\u8054\u90a6\u96c6\u7fa4\u7684\u6838\u5fc3\u5728\u4e8e\u6bcf\u4e00\u4e2aPrometheus Server\u90fd\u5305\u542b\u4e00\u4e2a\u7528\u4e8e\u83b7\u53d6\u5f53\u524d\u5b9e\u4f8b\u4e2d\u76d1\u63a7\u6837\u672c\u7684\u63a5\u53e3/federate\u3002\u5bf9\u4e8e\u4e2d\u5fc3Prometheus Server\u800c\u8a00\uff0c\u65e0\u8bba\u662f\u4ece\u5176\u4ed6\u7684Prometheus\u5b9e\u4f8b\u8fd8\u662fExporter\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u6570\u636e\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u4efb\u4f55\u5dee\u5f02\u3002</p> <pre><code>scrape_configs:\n  - job_name: 'federate'\n    scrape_interval: 15s\n    honor_labels: true\n    metrics_path: '/federate'\n    params:\n      'match[]':\n        - '{job=\"prometheus\"}'\n        - '{__name__=~\"job:.*\"}'\n        - '{__name__=~\"node.*\"}'\n    static_configs:\n      - targets:\n        - '192.168.77.11:9090'\n        - '192.168.77.12:9090'\n</code></pre> <p>\u4e3a\u4e86\u6709\u6548\u7684\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u901a\u8fc7params\u53c2\u6570\u53ef\u4ee5\u7528\u4e8e\u6307\u5b9a\u53ea\u83b7\u53d6\u67d0\u4e9b\u65f6\u95f4\u5e8f\u5217\u7684\u6837\u672c\u6570\u636e\uff0c\u4f8b\u5982</p> <pre><code>\"http://192.168.77.11:9090/federate?match[]={job%3D\"prometheus\"}&amp;match[]={__name__%3D~\"job%3A.*\"}&amp;match[]={__name__%3D~\"node.*\"}\"\n</code></pre> <p>\u901a\u8fc7URL\u4e2d\u7684match[]\u53c2\u6570\u6307\u5b9a\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u9700\u8981\u83b7\u53d6\u7684\u65f6\u95f4\u5e8f\u5217\u3002match[]\u53c2\u6570\u5fc5\u987b\u662f\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u9009\u62e9\u5668\uff0c\u4f8b\u5982up\u6216\u8005{job=\"api-server\"}\u3002\u914d\u7f6e\u591a\u4e2amatch[]\u53c2\u6570\uff0c\u7528\u4e8e\u83b7\u53d6\u591a\u7ec4\u65f6\u95f4\u5e8f\u5217\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>horbor_labels\u914d\u7f6etrue\u53ef\u4ee5\u786e\u4fdd\u5f53\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6307\u6807\u51b2\u7a81\u65f6\uff0c\u80fd\u591f\u81ea\u52a8\u5ffd\u7565\u51b2\u7a81\u7684\u76d1\u63a7\u6570\u636e\u3002\u5982\u679c\u4e3afalse\u65f6\uff0cprometheus\u4f1a\u81ea\u52a8\u5c06\u51b2\u7a81\u7684\u6807\u7b7e\u66ff\u6362\u4e3a\u201cexported_\u201d\u7684\u5f62\u5f0f\u3002"},{"location":"ha/scale-prometheus-with-federation/#_3","title":"\u529f\u80fd\u5206\u533a","text":"<p>\u8054\u90a6\u96c6\u7fa4\u7684\u7279\u6027\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u6839\u636e\u4e0d\u540c\u7684\u76d1\u63a7\u89c4\u6a21\u5bf9Prometheus\u90e8\u7f72\u67b6\u6784\u8fdb\u884c\u8c03\u6574\u3002\u4f8b\u5982\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u5728\u5404\u4e2a\u6570\u636e\u4e2d\u5fc3\u4e2d\u90e8\u7f72\u591a\u4e2aPrometheus Server\u5b9e\u4f8b\u3002\u6bcf\u4e00\u4e2aPrometheus Server\u5b9e\u4f8b\u53ea\u8d1f\u8d23\u91c7\u96c6\u5f53\u524d\u6570\u636e\u4e2d\u5fc3\u4e2d\u7684\u4e00\u90e8\u5206\u4efb\u52a1(Job)\uff0c\u4f8b\u5982\u53ef\u4ee5\u5c06\u4e0d\u540c\u7684\u76d1\u63a7\u4efb\u52a1\u5206\u79bb\u5230\u4e0d\u540c\u7684Prometheus\u5b9e\u4f8b\u5f53\u4e2d\uff0c\u518d\u6709\u4e2d\u5fc3Prometheus\u5b9e\u4f8b\u8fdb\u884c\u805a\u5408\u3002</p> <p></p> <p>\u529f\u80fd\u5206\u533a\uff0c\u5373\u901a\u8fc7\u8054\u90a6\u96c6\u7fa4\u7684\u7279\u6027\u5728\u4efb\u52a1\u7ea7\u522b\u5bf9Prometheus\u91c7\u96c6\u4efb\u52a1\u8fdb\u884c\u5212\u5206\uff0c\u4ee5\u652f\u6301\u89c4\u6a21\u7684\u6269\u5c55\u3002</p>"},{"location":"kubernetes/READMD/","title":"\u7b2c8\u7ae0 Kubernetes\u76d1\u63a7\u5b9e\u6218","text":"<p>Kubenetes\u662f\u4e00\u6b3e\u7531Google\u5f00\u53d1\u7684\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c\u5728Google\u5df2\u7ecf\u4f7f\u7528\u8d85\u8fc715\u5e74\u3002\u4f5c\u4e3a\u5bb9\u5668\u9886\u57df\u4e8b\u5b9e\u7684\u6807\u51c6\uff0cKubernetes\u53ef\u4ee5\u6781\u5927\u7684\u7b80\u5316\u5e94\u7528\u7684\u7ba1\u7406\u548c\u90e8\u7f72\u590d\u6742\u5ea6\u3002\u672c\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecdKubernetes\u7684\u4e00\u4e9b\u57fa\u672c\u6982\u5ff5\uff0c\u5e76\u4e14\u4ece0\u5f00\u59cb\u5229\u7528Prometheus\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684Kubernetes\u96c6\u7fa4\u76d1\u63a7\u7cfb\u7edf\u3002\u540c\u65f6\u6211\u4eec\u8fd8\u5c06\u5b66\u4e60\u5982\u4f55\u901a\u8fc7Prometheus Operator\u7b80\u5316\u5728Kubernetes\u4e0b\u90e8\u7f72\u548c\u7ba1\u7406Promethues\u7684\u8fc7\u7a0b\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u7406\u89e3Kubernetes\u7684\u5de5\u4f5c\u673a\u5236</li> <li>Prometheus\u5728Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236</li> <li>\u76d1\u63a7Kubernetes\u96c6\u7fa4\u72b6\u6001</li> <li>\u76d1\u63a7\u96c6\u7fa4\u57fa\u7840\u8bbe\u65bd</li> <li>\u76d1\u63a7\u96c6\u7fa4\u5e94\u7528\u5bb9\u5668\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5</li> <li>\u76d1\u63a7\u7528\u6237\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f</li> <li>\u5bf9Service\u548cIngress\u8fdb\u884c\u7f51\u7edc\u63a2\u6d4b</li> <li>\u901a\u8fc7Operator\u9ad8\u6548\u7ba1\u7406\u548c\u90e8\u7f72\u5728Kubernetes\u96c6\u7fa4\u4e2d\u7684Prometheus</li> </ul>"},{"location":"kubernetes/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>Kubernetes\u4e0ePromethues\u6709\u7740\u5341\u5206\u76f8\u4f3c\u7684\u5386\u7a0b\uff0c\u5747\u662f\u6e90\u81eaGoogle\u5185\u90e8\u591a\u5e74\u7684\u8fd0\u7ef4\u7ecf\u9a8c\u3002\u5e76\u4e14\u76f8\u7ee7\u4eceCNCF\u57fa\u91d1\u4f1a\u6b63\u5f0f\u6bd5\u4e1a\u3002\u5b83\u4eec\u5206\u522b\u4ee3\u8868\u4e86\u4e91\u539f\u751f\u6a21\u5f0f\u4e0b\u5bb9\u5668\u7f16\u6392\u4ee5\u53ca\u76d1\u63a7\u7684\u4e8b\u5b9e\u6807\u51c6\u3002</p>"},{"location":"kubernetes/deploy-prometheus-in-kubernetes/","title":"\u5728Kubernetes\u4e0b\u90e8\u7f72Prometheus","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u4e0eKubernetes\u7684\u5e94\u7528\u7ba1\u7406\u6a21\u578b\uff0c\u5e76\u4e14\u5229\u7528MiniKube\u5728\u672c\u5730\u642d\u5efa\u4e86\u4e00\u4e2a\u5355\u8282\u70b9\u7684Kubernetes\u3002\u8fd9\u4e00\u90e8\u5206\u6211\u4eec\u5c06\u5e26\u9886\u8bfb\u8005\u901a\u8fc7Kubernetes\u90e8\u7f72Prometheus\u5b9e\u4f8b\u3002</p>"},{"location":"kubernetes/deploy-prometheus-in-kubernetes/#configmaps","title":"\u4f7f\u7528ConfigMaps\u7ba1\u7406\u5e94\u7528\u914d\u7f6e","text":"<p>\u5f53\u4f7f\u7528Deployment\u7ba1\u7406\u548c\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u7528\u6237\u53ef\u4ee5\u65b9\u4fbf\u4e86\u5bf9\u5e94\u7528\u8fdb\u884c\u6269\u5bb9\u6216\u8005\u7f29\u5bb9\uff0c\u4ece\u800c\u4ea7\u751f\u591a\u4e2aPod\u5b9e\u4f8b\u3002\u4e3a\u4e86\u80fd\u591f\u7edf\u4e00\u7ba1\u7406\u8fd9\u4e9bPod\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5728Kubernetes\u4e2d\u53ef\u4ee5\u4f7f\u7528ConfigMaps\u8d44\u6e90\u5b9a\u4e49\u548c\u7ba1\u7406\u8fd9\u4e9b\u914d\u7f6e\uff0c\u5e76\u4e14\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u6216\u8005\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u7684\u65b9\u5f0f\u8ba9\u5bb9\u5668\u4f7f\u7528\u8fd9\u4e9b\u914d\u7f6e\u3002</p> <p>\u8fd9\u91cc\u5c06\u4f7f\u7528ConfigMaps\u7ba1\u7406Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u521b\u5efaprometheus-config.yml\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval:     15s \n      evaluation_interval: 15s\n    scrape_configs:\n      - job_name: 'prometheus'\n        static_configs:\n        - targets: ['localhost:9090']\n</code></pre> <p>\u4f7f\u7528kubectl\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u5728\u547d\u540d\u7a7a\u95f4default\u521b\u5efaConfigMap\u8d44\u6e90\uff1a</p> <pre><code>kubectl create -f prometheus-config.yml\nconfigmap \"prometheus-config\" created\n</code></pre>"},{"location":"kubernetes/deploy-prometheus-in-kubernetes/#deploymentprometheus","title":"\u4f7f\u7528Deployment\u90e8\u7f72Prometheus","text":"<p>\u5f53ConfigMap\u8d44\u6e90\u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7Volume\u6302\u8f7d\u7684\u65b9\u5f0f\uff0c\u5c06Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u3002 \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7Deployment\u90e8\u7f72Prometheus Server\u5b9e\u4f8b\uff0c\u521b\u5efaprometheus-deployment.yml\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9:</p> <pre><code>apiVersion: v1\nkind: \"Service\"\nmetadata:\n  name: prometheus\n  labels:\n    name: prometheus\nspec:\n  ports:\n  - name: prometheus\n    protocol: TCP\n    port: 9090\n    targetPort: 9090\n  selector:\n    app: prometheus\n  type: NodePort\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    name: prometheus\n  name: prometheus\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      containers:\n      - name: prometheus\n        image: prom/prometheus:v2.2.1\n        command:\n        - \"/bin/prometheus\"\n        args:\n        - \"--config.file=/etc/prometheus/prometheus.yml\"\n        ports:\n        - containerPort: 9090\n          protocol: TCP\n        volumeMounts:\n        - mountPath: \"/etc/prometheus\"\n          name: prometheus-config\n      volumes:\n      - name: prometheus-config\n        configMap:\n          name: prometheus-config\n</code></pre> <p>\u8be5\u6587\u4ef6\u4e2d\u5206\u522b\u5b9a\u4e49\u4e86Service\u548cDeployment\uff0cService\u7c7b\u578b\u4e3aNodePort\uff0c\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u865a\u62df\u673aIP\u548c\u7aef\u53e3\u8bbf\u95ee\u5230Prometheus\u5b9e\u4f8b\u3002\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u5b9e\u4f8b\u4f7f\u7528ConfigMap\u4e2d\u7ba1\u7406\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u91cc\u901a\u8fc7volumes\u58f0\u660e\u4e86\u4e00\u4e2a\u78c1\u76d8\u5377\u3002\u5e76\u4e14\u901a\u8fc7volumeMounts\u5c06\u8be5\u78c1\u76d8\u5377\u6302\u8f7d\u5230\u4e86Prometheus\u5b9e\u4f8b\u7684/etc/prometheus\u76ee\u5f55\u4e0b\u3002</p> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u8d44\u6e90\uff0c\u5e76\u67e5\u770b\u8d44\u6e90\u7684\u521b\u5efa\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl create -f prometheus-deployment.yml\nservice \"prometheus\" created\ndeployment \"prometheus\" created\n\n$ kubectl get pods\nNAME                               READY     STATUS        RESTARTS   AGE\nprometheus-55f655696d-wjqcl        1/1       Running       0          5s\n\n$ kubectl get svc\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nkubernetes      ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          131d\nprometheus      NodePort    10.101.255.236   &lt;none&gt;        9090:32584/TCP   42s\n</code></pre> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7MiniKube\u865a\u62df\u673a\u7684IP\u5730\u5740\u548c\u7aef\u53e332584\u8bbf\u95ee\u5230Prometheus\u7684\u670d\u52a1\u3002</p> <p></p>"},{"location":"kubernetes/hap-with-prometheus/","title":"\u57fa\u4e8ePrometheus\u7684\u5f39\u6027\u4f38\u7f29","text":"<p>\u5f39\u6027\u4f38\u7f29\uff08AutoScaling\uff09\u662f\u6307\u5e94\u7528\u53ef\u4ee5\u6839\u636e\u5f53\u524d\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u81ea\u52a8\u6c34\u5e73\u6269\u5bb9\u6216\u8005\u7f29\u5bb9\u7684\u80fd\u529b\u3002</p>"},{"location":"kubernetes/kubernetes-with-minikube/","title":"\u521d\u8bc6Kubernetes","text":"<p>Kubenetes\u662f\u4e00\u6b3e\u7531Google\u5f00\u53d1\u7684\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff08GitHub\u6e90\u7801\uff09\uff0c\u5728Google\u5df2\u7ecf\u4f7f\u7528\u8d85\u8fc715\u5e74\uff08Kubernetest\u524d\u8eab\u662fGoogle\u7684\u5185\u90e8\u5de5\u5177Borg\uff09\u3002Kubernetes\u5c06\u4e00\u7cfb\u5217\u7684\u4e3b\u673a\u770b\u505a\u662f\u4e00\u4e2a\u53d7\u7ba1\u7406\u7684\u6d77\u91cf\u8d44\u6e90\uff0c\u8fd9\u4e9b\u6d77\u91cf\u8d44\u6e90\u7ec4\u6210\u4e86\u4e00\u4e2a\u80fd\u591f\u65b9\u4fbf\u8fdb\u884c\u6269\u5c55\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u800c\u5728Kubernetes\u4e2d\u8fd0\u884c\u7740\u7684\u5bb9\u5668\u5219\u53ef\u4ee5\u89c6\u4e3a\u662f\u8fd9\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8fd0\u884c\u7684\u201c\u8fdb\u7a0b\u201d\uff0c\u901a\u8fc7Kubernetes\u8fd9\u4e00\u4e2d\u592e\u534f\u8c03\u5668\uff0c\u89e3\u51b3\u4e86\u57fa\u4e8e\u5bb9\u5668\u5e94\u7528\u7a0b\u5e8f\u7684\u8c03\u5ea6\u3001\u4f38\u7f29\u3001\u8bbf\u95ee\u8d1f\u8f7d\u5747\u8861\u4ee5\u53ca\u6574\u4e2a\u7cfb\u7edf\u7684\u7ba1\u7406\u548c\u76d1\u63a7\u7684\u95ee\u9898\u3002</p>"},{"location":"kubernetes/kubernetes-with-minikube/#kubernetes_1","title":"Kubernetes\u5e94\u7528\u7ba1\u7406\u6a21\u578b","text":"<p>\u4e0b\u56fe\u5c55\u793a\u4e86Kubernetes\u7684\u5e94\u7528\u7ba1\u7406\u6a21\u578b\uff1a</p> <p></p> <p>Pod\u662fKubernetes\u4e2d\u7684\u6700\u5c0f\u8c03\u5ea6\u8d44\u6e90\u3002Pod\u4e2d\u4f1a\u5305\u542b\u4e00\u7ec4\u5bb9\u5668\uff0c\u5b83\u4eec\u4e00\u8d77\u5de5\u4f5c\uff0c\u5e76\u4e14\u5bf9\u5916\u63d0\u4f9b\u4e00\u4e2a\uff08\u6216\u8005\u4e00\u7ec4\uff09\u529f\u80fd\u3002\u5bf9\u4e8e\u8fd9\u7ec4\u5bb9\u5668\u800c\u8a00\u5b83\u4eec\u5171\u4eab\u76f8\u540c\u7684\u7f51\u7edc\u548c\u5b58\u50a8\u8d44\u6e90\uff0c\u56e0\u6b64\u5b83\u4eec\u4e4b\u95f4\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u672c\u5730\u7f51\u7edc\uff08127.0.0.1\uff09\u8fdb\u884c\u8bbf\u95ee\u3002\u5f53Pod\u88ab\u521b\u5efa\u65f6\uff0c\u8c03\u5ea6\u5668\uff08kube-schedule\uff09\u4f1a\u4ece\u96c6\u7fa4\u4e2d\u627e\u5230\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\u8fd0\u884c\u5b83\u3002</p> <p>\u5982\u679c\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u9700\u8981\u542f\u52a8\u591a\u4e2a\u5b9e\u4f8b\uff08\u526f\u672c\uff09\uff0c\u5219\u9700\u8981\u4f7f\u7528\u5230\u63a7\u5236\u5668\uff08Controller\uff09\u3002\u7528\u6237\u53ef\u4ee5\u5728Controller\u5b9a\u4e49Pod\u7684\u8c03\u5ea6\u89c4\u5219\u3001\u8fd0\u884c\u7684\u526f\u672c\u6570\u91cf\u4ee5\u53ca\u5347\u7ea7\u7b56\u7565\u7b49\u7b49\u4fe1\u606f\uff0c\u5f53\u67d0\u4e9bPod\u53d1\u751f\u6545\u969c\u4e4b\u540e\uff0cController\u4f1a\u5c1d\u8bd5\u81ea\u52a8\u4fee\u590d\uff0c\u76f4\u5230Pod\u7684\u8fd0\u884c\u72b6\u6001\u6ee1\u8db3Controller\u4e2d\u5b9a\u4e49\u7684\u9884\u671f\u72b6\u6001\u4e3a\u6b62\u3002Kubernetes\u4e2d\u63d0\u4f9b\u4e86\u591a\u79cdController\u7684\u5b9e\u73b0\uff0c\u5305\u62ec\uff1aDeployment\uff08\u65e0\u72b6\u6001\u5e94\u7528\uff09\u3001StatefulSet\uff08\u6709\u72b6\u6001\u5e94\u7528\uff09\u3001Daemonset\uff08\u5b88\u62a4\u6a21\u5f0f\uff09\u7b49\uff0c\u4ee5\u652f\u6301\u4e0d\u540c\u7c7b\u578b\u5e94\u7528\u7684\u90e8\u7f72\u548c\u8c03\u5ea6\u6a21\u5f0f\u3002</p> <p>\u901a\u8fc7Controller\u548cPod\u6211\u4eec\u5b9a\u4e49\u4e86\u5e94\u7528\u7a0b\u5e8f\u662f\u5982\u4f55\u8fd0\u884c\u7684\uff0c\u63a5\u4e0b\u6765\u9700\u8981\u89e3\u51b3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u90e8\u7f72\u5728Kubernetes\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u3002Kubernetes\u5c06\u8fd9\u4e00\u95ee\u9898\u5212\u5206\u4e3a\u4e24\u4e2a\u95ee\u9898\u57df\uff0c\u7b2c\u4e00\uff0c\u96c6\u7fa4\u5185\u7684\u5e94\u7528\u5982\u4f55\u901a\u4fe1\u3002\u7b2c\u4e8c\uff0c\u5916\u90e8\u7684\u7528\u6237\u5982\u4f55\u8bbf\u95ee\u90e8\u7f72\u5728\u96c6\u7fa4\u5185\u7684\u5e94\u7528\uff1f</p> <p>\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u95ee\u9898\uff0c\u5728Kubernetes\u4e2d\u901a\u8fc7\u5b9a\u4e49Service\uff08\u670d\u52a1\uff09\u6765\u89e3\u51b3\u3002Service\u5728Kubernetes\u96c6\u7fa4\u5185\u626e\u6f14\u4e86\u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\u7684\u4f5c\u7528\u3002\u5728Kubernetes\u4e0b\u90e8\u7f72\u7684Pod\u5b9e\u4f8b\u90fd\u4f1a\u5305\u542b\u4e00\u7ec4\u63cf\u8ff0\u81ea\u8eab\u4fe1\u606f\u7684label\uff0c\u800c\u521b\u5efaService\uff0c\u53ef\u4ee5\u58f0\u660e\u4e00\u4e2aSelector\uff08\u6807\u7b7e\u9009\u62e9\u5668\uff09\u3002Service\u901a\u8fc7Selector\uff0c\u627e\u5230\u5339\u914d\u6807\u7b7e\u89c4\u5219\u7684Pod\u5b9e\u4f8b\uff0c\u5e76\u5c06\u5bf9Service\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u4ee3\u7406\u7684Pod\u4e2d\u3002Service\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u96c6\u7fa4\u5185\u7684\u5e94\u7528\u5c31\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528Service\u7684\u540d\u79f0\u4f5c\u4e3aDNS\u57df\u540d\u8fdb\u884c\u76f8\u4e92\u8bbf\u95ee\u3002</p> <p>\u800c\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff0cKubernetes\u4e2d\u5b9a\u4e49\u4e86\u5355\u72ec\u7684\u8d44\u6e90Ingress\uff08\u5165\u53e3\uff09\u3002Ingress\u662f\u4e00\u4e2a\u5de5\u4f5c\u57287\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5176\u8d1f\u8d23\u4ee3\u7406\u5916\u90e8\u8fdb\u5165\u96c6\u7fa4\u5185\u7684\u8bf7\u6c42\uff0c\u5e76\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u4e2d\u3002</p> <p>\u6700\u540e\uff0c\u5bf9\u4e8e\u540c\u4e00\u4e2aKubernetes\u96c6\u7fa4\u5176\u53ef\u80fd\u88ab\u591a\u4e2a\u7ec4\u7ec7\u4f7f\u7528\uff0c\u4e3a\u4e86\u9694\u79bb\u8fd9\u4e9b\u4e0d\u540c\u7ec4\u7ec7\u521b\u5efa\u7684\u5e94\u7528\u7a0b\u5e8f\uff0cKubernetes\u5b9a\u4e49\u4e86Namespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\u5bf9\u8d44\u6e90\u8fdb\u884c\u9694\u79bb\u3002</p>"},{"location":"kubernetes/kubernetes-with-minikube/#kubernetes_2","title":"Kubernetes\u67b6\u6784\u6a21\u578b","text":"<p>\u4e3a\u4e86\u80fd\u591f\u66f4\u597d\u7684\u7406\u89e3Kubernetes\u4e0b\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3Kubernetes\u7684\u57fa\u672c\u67b6\u6784\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u662fKubernetes\u7684\u67b6\u6784\u793a\u610f\u56fe\uff1a</p> <p></p> <p>Kubernetes\u7684\u6838\u5fc3\u7ec4\u4ef6\u4e3b\u8981\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1aMaster\u7ec4\u4ef6\u548cNode\u7ec4\u4ef6\uff0c\u5176\u4e2dMatser\u7ec4\u4ef6\u63d0\u4f9b\u4e86\u96c6\u7fa4\u5c42\u9762\u7684\u7ba1\u7406\u529f\u80fd\uff0c\u5b83\u4eec\u8d1f\u8d23\u54cd\u5e94\u7528\u6237\u8bf7\u6c42\u5e76\u4e14\u5bf9\u96c6\u7fa4\u8d44\u6e90\u8fdb\u884c\u7edf\u4e00\u7684\u8c03\u5ea6\u548c\u7ba1\u7406\u3002Node\u7ec4\u4ef6\u4f1a\u8fd0\u884c\u5728\u96c6\u7fa4\u7684\u6240\u6709\u8282\u70b9\u4e0a\uff0c\u5b83\u4eec\u8d1f\u8d23\u7ba1\u7406\u548c\u7ef4\u62a4\u8282\u70b9\u4e2d\u8fd0\u884c\u7684Pod\uff0c\u4e3aKubernetes\u96c6\u7fa4\u63d0\u4f9b\u8fd0\u884c\u65f6\u73af\u5883\u3002</p> <p>Master\u7ec4\u4ef6\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>kube-apiserver\uff1a\u8d1f\u8d23\u5bf9\u5916\u66b4\u9732Kubernetes API\uff1b</li> <li>etcd\uff1a\u7528\u4e8e\u5b58\u50a8Kubernetes\u96c6\u7fa4\u7684\u6240\u6709\u6570\u636e\uff1b</li> <li>kube-scheduler: \u8d1f\u8d23\u4e3a\u65b0\u521b\u5efa\u7684Pod\u9009\u62e9\u53ef\u4f9b\u5176\u8fd0\u884c\u7684\u8282\u70b9\uff1b</li> <li>kube-controller-manager\uff1a \u5305\u542bNode Controller\uff0cDeployment Controller\uff0cEndpoint Controller\u7b49\u7b49\uff0c\u901a\u8fc7\u4e0eapiserver\u4ea4\u4e92\u4f7f\u76f8\u5e94\u7684\u8d44\u6e90\u8fbe\u5230\u9884\u671f\u72b6\u6001\u3002</li> </ul> <p>Node\u7ec4\u4ef6\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>kubelet\uff1a\u8d1f\u8d23\u7ef4\u62a4\u548c\u7ba1\u7406\u8282\u70b9\u4e0aPod\u7684\u8fd0\u884c\u72b6\u6001\uff1b</li> <li>kube-proxy\uff1a\u8d1f\u8d23\u7ef4\u62a4\u4e3b\u673a\u4e0a\u7684\u7f51\u7edc\u89c4\u5219\u4ee5\u53ca\u8f6c\u53d1\u3002</li> <li>Container Runtime\uff1a\u5982Docker,rkt,runc\u7b49\u63d0\u4f9b\u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u3002</li> </ul>"},{"location":"kubernetes/kubernetes-with-minikube/#kubernetes_3","title":"Kubernetes\u76d1\u63a7\u7b56\u7565","text":"<p>Kubernetes\u4f5c\u4e3a\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u4e86\u4e00\u4e2a\u53ef\u4ee5\u7edf\u4e00\u8c03\u5ea6\uff0c\u7edf\u4e00\u7ba1\u7406\u7684\u4e91\u64cd\u4f5c\u7cfb\u7edf\u3002\u5176\u89e3\u51b3\u5982\u7528\u6237\u5e94\u7528\u7a0b\u5e8f\u5982\u4f55\u8fd0\u884c\u7684\u95ee\u9898\u3002\u800c\u4e00\u65e6\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5927\u91cf\u57fa\u4e8eKubernetes\u90e8\u7f72\u548c\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u540e\uff0c\u4f5c\u4e3a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u8fd8\u9700\u8981\u5145\u5206\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u4ee5\u53caKubernetes\u96c6\u7fa4\u670d\u52a1\u8fd0\u884c\u8d28\u91cf\u5982\u4f55\uff0c\u901a\u8fc7\u5bf9\u5e94\u7528\u4ee5\u53ca\u96c6\u7fa4\u8fd0\u884c\u72b6\u6001\u6570\u636e\u7684\u6536\u96c6\u548c\u5206\u6790\uff0c\u6301\u7eed\u4f18\u5316\u548c\u6539\u8fdb\uff0c\u4ece\u800c\u63d0\u4f9b\u4e00\u4e2a\u5b89\u5168\u53ef\u9760\u7684\u751f\u4ea7\u8fd0\u884c\u73af\u5883\u3002 \u8fd9\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u5c06\u8ba8\u8bba\u5f53\u4f7f\u7528Kubernetes\u65f6\u7684\u76d1\u63a7\u7b56\u7565\u8be5\u5982\u4f55\u8bbe\u8ba1\u3002</p> <p>\u4ece\u7269\u7406\u7ed3\u6784\u4e0a\u8bb2Kubernetes\u4e3b\u8981\u7528\u4e8e\u6574\u5408\u548c\u7ba1\u7406\u5e95\u5c42\u7684\u57fa\u7840\u8bbe\u65bd\u8d44\u6e90\uff0c\u5bf9\u5916\u63d0\u4f9b\u5e94\u7528\u5bb9\u5668\u7684\u81ea\u52a8\u5316\u90e8\u7f72\u548c\u7ba1\u7406\u80fd\u529b\uff0c\u8fd9\u4e9b\u57fa\u7840\u8bbe\u65bd\u53ef\u80fd\u662f\u7269\u7406\u673a\u3001\u865a\u62df\u673a\u3001\u4e91\u4e3b\u673a\u7b49\u7b49\u3002\u56e0\u6b64\uff0c\u57fa\u7840\u8d44\u6e90\u7684\u4f7f\u7528\u76f4\u63a5\u5f71\u54cd\u5f53\u524d\u96c6\u7fa4\u7684\u5bb9\u91cf\u548c\u5e94\u7528\u7684\u72b6\u6001\u3002\u5728\u8fd9\u90e8\u5206\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8\u96c6\u7fa4\u4e2d\u5404\u4e2a\u8282\u70b9\u7684\u4e3b\u673a\u8d1f\u8f7d\uff0cCPU\u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u3001\u5b58\u50a8\u7a7a\u95f4\u4ee5\u53ca\u7f51\u7edc\u541e\u5410\u7b49\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u4ece\u81ea\u8eab\u67b6\u6784\u4e0a\u8bb2\uff0ckube-apiserver\u662fKubernetes\u63d0\u4f9b\u6240\u6709\u670d\u52a1\u7684\u5165\u53e3\uff0c\u65e0\u8bba\u662f\u5916\u90e8\u7684\u5ba2\u6237\u7aef\u8fd8\u662f\u96c6\u7fa4\u5185\u90e8\u7684\u7ec4\u4ef6\u90fd\u76f4\u63a5\u4e0ekube-apiserver\u8fdb\u884c\u901a\u8baf\u3002\u56e0\u6b64\uff0ckube-apiserver\u7684\u5e76\u53d1\u548c\u541e\u5410\u91cf\u76f4\u63a5\u51b3\u5b9a\u4e86\u96c6\u7fa4\u6027\u80fd\u7684\u597d\u574f\u3002\u5176\u6b21\uff0c\u5bf9\u4e8e\u5916\u90e8\u7528\u6237\u800c\u8a00\uff0cKubernetes\u662f\u5426\u80fd\u591f\u5feb\u901f\u7684\u5b8c\u6210pod\u7684\u8c03\u5ea6\u4ee5\u53ca\u542f\u52a8\uff0c\u662f\u5f71\u54cd\u5176\u4f7f\u7528\u4f53\u9a8c\u7684\u5173\u952e\u56e0\u7d20\u3002\u800c\u8fd9\u4e2a\u8fc7\u7a0b\u4e3b\u8981\u7531kube-scheduler\u8d1f\u8d23\u5b8c\u6210\u8c03\u5ea6\u5de5\u4f5c\uff0c\u800ckubelet\u5b8c\u6210pod\u7684\u521b\u5efa\u548c\u542f\u52a8\u5de5\u4f5c\u3002\u56e0\u6b64\u5728Kubernetes\u96c6\u7fa4\u672c\u8eab\u6211\u4eec\u9700\u8981\u8bc4\u4ef7\u5176\u81ea\u8eab\u7684\u670d\u52a1\u8d28\u91cf\uff0c\u4e3b\u8981\u5173\u6ce8\u5728Kubernetes\u7684API\u54cd\u5e94\u65f6\u95f4\uff0c\u4ee5\u53caPod\u7684\u542f\u52a8\u65f6\u95f4\u7b49\u6307\u6807\u4e0a\u3002</p> <p>Kubernetes\u7684\u6700\u7ec8\u76ee\u6807\u8fd8\u662f\u9700\u8981\u4e3a\u4e1a\u52a1\u670d\u52a1\uff0c\u56e0\u6b64\u6211\u4eec\u8fd8\u9700\u8981\u80fd\u591f\u76d1\u63a7\u5e94\u7528\u5bb9\u5668\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002\u5bf9\u4e8e\u5185\u7f6e\u4e86\u5bf9Prometheus\u652f\u6301\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u8981\u652f\u6301\u4ece\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u4e2d\u91c7\u96c6\u5185\u90e8\u7684\u76d1\u63a7\u6307\u6807\u3002\u6700\u540e\uff0c\u7ed3\u5408\u9ed1\u76d2\u76d1\u63a7\u6a21\u5f0f\uff0c\u5bf9\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u670d\u52a1\u8fdb\u884c\u63a2\u6d4b\uff0c\u4ece\u800c\u5f53\u5e94\u7528\u53d1\u751f\u6545\u969c\u540e\uff0c\u80fd\u591f\u5feb\u901f\u5904\u7406\u548c\u6062\u590d\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u9700\u8981\u7efc\u5408\u4f7f\u7528\u767d\u76d2\u76d1\u63a7\u548c\u9ed1\u76d2\u76d1\u63a7\u6a21\u5f0f\uff0c\u5efa\u7acb\u4ece\u57fa\u7840\u8bbe\u65bd\uff0cKubernetes\u6838\u5fc3\u7ec4\u4ef6\uff0c\u5e94\u7528\u5bb9\u5668\u7b49\u5168\u9762\u7684\u76d1\u63a7\u4f53\u7cfb\u3002</p> <p>\u5728\u767d\u76d2\u76d1\u63a7\u5c42\u9762\u6211\u4eec\u9700\u8981\u5173\u6ce8\uff1a</p> <ul> <li>\u57fa\u7840\u8bbe\u65bd\u5c42\uff08Node\uff09\uff1a\u4e3a\u6574\u4e2a\u96c6\u7fa4\u548c\u5e94\u7528\u63d0\u4f9b\u8fd0\u884c\u65f6\u8d44\u6e90\uff0c\u9700\u8981\u901a\u8fc7\u5404\u8282\u70b9\u7684kubelet\u83b7\u53d6\u8282\u70b9\u7684\u57fa\u672c\u72b6\u6001\uff0c\u540c\u65f6\u901a\u8fc7\u5728\u8282\u70b9\u4e0a\u90e8\u7f72Node Exporter\u83b7\u53d6\u8282\u70b9\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1b</li> <li>\u5bb9\u5668\u57fa\u7840\u8bbe\u65bd\uff08Container\uff09\uff1a\u4e3a\u5e94\u7528\u63d0\u4f9b\u8fd0\u884c\u65f6\u73af\u5883\uff0cKubelet\u5185\u7f6e\u4e86\u5bf9cAdvisor\u7684\u652f\u6301\uff0c\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7Kubelet\u7ec4\u4ef6\u83b7\u53d6\u7ed9\u8282\u70b9\u4e0a\u5bb9\u5668\u76f8\u5173\u76d1\u63a7\u6307\u6807\uff1b</li> <li>\u7528\u6237\u5e94\u7528\uff08Pod\uff09\uff1aPod\u4e2d\u4f1a\u5305\u542b\u4e00\u7ec4\u5bb9\u5668\uff0c\u5b83\u4eec\u4e00\u8d77\u5de5\u4f5c\uff0c\u5e76\u4e14\u5bf9\u5916\u63d0\u4f9b\u4e00\u4e2a\uff08\u6216\u8005\u4e00\u7ec4\uff09\u529f\u80fd\u3002\u5982\u679c\u7528\u6237\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u90a3\u4e48\u6211\u4eec\u8fd8\u5e94\u8be5\u91c7\u96c6\u8fd9\u4e9bPod\u66b4\u9732\u7684\u76d1\u63a7\u6307\u6807\uff1b</li> <li>Kubernetes\u7ec4\u4ef6\uff1a\u83b7\u53d6\u5e76\u76d1\u63a7Kubernetes\u6838\u5fc3\u7ec4\u4ef6\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u786e\u4fdd\u5e73\u53f0\u81ea\u8eab\u7684\u7a33\u5b9a\u8fd0\u884c\u3002</li> </ul> <p>\u800c\u5728\u9ed1\u76d2\u76d1\u63a7\u5c42\u9762\uff0c\u5219\u4e3b\u8981\u9700\u8981\u5173\u6ce8\u4ee5\u4e0b\uff1a</p> <ul> <li>\u5185\u90e8\u670d\u52a1\u8d1f\u8f7d\u5747\u8861\uff08Service\uff09\uff1a\u5728\u96c6\u7fa4\u5185\uff0c\u901a\u8fc7Service\u5728\u96c6\u7fa4\u66b4\u9732\u5e94\u7528\u529f\u80fd\uff0c\u96c6\u7fa4\u5185\u5e94\u7528\u548c\u5e94\u7528\u4e4b\u95f4\u8bbf\u95ee\u65f6\u63d0\u4f9b\u5185\u90e8\u7684\u8d1f\u8f7d\u5747\u8861\u3002\u901a\u8fc7Blackbox Exporter\u63a2\u6d4bService\u7684\u53ef\u7528\u6027\uff0c\u786e\u4fdd\u5f53Service\u4e0d\u53ef\u7528\u65f6\u80fd\u591f\u5feb\u901f\u5f97\u5230\u544a\u8b66\u901a\u77e5\uff1b</li> <li>\u5916\u90e8\u8bbf\u95ee\u5165\u53e3\uff08Ingress\uff09\uff1a\u901a\u8fc7Ingress\u63d0\u4f9b\u96c6\u7fa4\u5916\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u4ece\u800c\u53ef\u4ee5\u4f7f\u5916\u90e8\u5ba2\u6237\u7aef\u80fd\u591f\u8bbf\u95ee\u5230\u90e8\u7f72\u5728Kubernetes\u96c6\u7fa4\u5185\u7684\u670d\u52a1\u3002\u56e0\u6b64\u4e5f\u9700\u8981\u901a\u8fc7Blackbox Exporter\u5bf9Ingress\u7684\u53ef\u7528\u6027\u8fdb\u884c\u63a2\u6d4b\uff0c\u786e\u4fdd\u5916\u90e8\u7528\u6237\u80fd\u591f\u6b63\u5e38\u8bbf\u95ee\u96c6\u7fa4\u5185\u7684\u529f\u80fd\uff1b</li> </ul>"},{"location":"kubernetes/kubernetes-with-minikube/#kubernetes_4","title":"\u642d\u5efa\u672c\u5730Kubernetes\u96c6\u7fa4","text":"<p>\u4e3a\u4e86\u80fd\u591f\u66f4\u76f4\u89c2\u7684\u4e86\u89e3\u548c\u4f7f\u7528Kubernetes\uff0c\u6211\u4eec\u5c06\u5728\u672c\u5730\u901a\u8fc7\u5de5\u5177Minikube(https://github.com/kubernetes/minikube)\u642d\u5efa\u4e00\u4e2a\u672c\u5730\u7684Kubernetes\u6d4b\u8bd5\u73af\u5883\u3002Minikube\u4f1a\u5728\u672c\u5730\u901a\u8fc7\u865a\u62df\u673a\u8fd0\u884c\u4e00\u4e2a\u5355\u8282\u70b9\u7684Kubernetes\u96c6\u7fa4\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u6216\u8005\u5f00\u53d1\u4eba\u5458\u5728\u672c\u5730\u8fdb\u884c\u4e0eKubernetes\u76f8\u5173\u7684\u5f00\u53d1\u548c\u6d4b\u8bd5\u5de5\u4f5c\u3002</p> <p>\u5b89\u88c5MiniKube\u7684\u65b9\u5f0f\u5f88\u7b80\u5355\uff0c\u5bf9\u4e8eMac\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528Brew\u8fdb\u884c\u5b89\u88c5:</p> <pre><code>brew cask install minikube\n</code></pre> <p>\u5176\u5b83\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\uff0c\u53ef\u4ee5\u67e5\u770bMinikube\u9879\u76ee\u7684\u5b98\u65b9\u8bf4\u660e\u6587\u6863\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\u3002\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u5728\u672c\u673a\u901a\u8fc7\u547d\u4ee4\u884c\u542f\u52a8Kubernetes\u96c6\u7fa4:</p> <pre><code>$ minikube start\nStarting local Kubernetes v1.7.5 cluster...\nStarting VM...\nSSH-ing files into VM...\nSetting up certs...\nStarting cluster components...\nConnecting to cluster...\nSetting up kubeconfig...\nKubectl is now configured to use the cluster.\n</code></pre> <p>MiniKube\u4f1a\u81ea\u52a8\u914d\u7f6e\u672c\u673a\u7684kubelet\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u7528\u4e8e\u4e0e\u5bf9\u96c6\u7fa4\u8d44\u6e90\u8fdb\u884c\u7ba1\u7406\u3002\u540c\u65f6Kubernetes\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2aDashboard\u7ba1\u7406\u754c\u9762\uff0c\u5728MiniKube\u4e0b\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6253\u5f00\uff1a</p> <pre><code>$ minikube dashboard\nOpening kubernetes dashboard in default browser...\n</code></pre> <p>Kubernetes\u4e2d\u7684Dashboard\u672c\u8eab\u4e5f\u662f\u901a\u8fc7Deployment\u8fdb\u884c\u90e8\u7f72\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7MiniKube\u627e\u5230\u5f53\u524d\u96c6\u7fa4\u865a\u62df\u673a\u7684IP\u5730\u5740\uff1a</p> <pre><code>$ minikube ip\n192.168.99.100\n</code></pre> <p>\u901a\u8fc7kubectl\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u627e\u5230Dashboard\u5bf9\u5e94\u7684Service\u5bf9\u5916\u66b4\u9732\u7684\u7aef\u53e3\uff0c\u5982\u4e0b\u6240\u793a\uff0ckubernetes-dashboard\u662f\u4e00\u4e2aNodePort\u7c7b\u578b\u7684Service\uff0c\u5e76\u5bf9\u5916\u66b4\u9732\u4e8630000\u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get service --namespace=kube-system\nNAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE\nkube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP   131d\nkubernetes-dashboard   NodePort    10.105.168.160   &lt;none&gt;        80:30000/TCP    131d\n</code></pre> <p>\u5728Dashbord\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u53ef\u89c6\u5316\u7684\u7ba1\u7406\u5f53\u524d\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u8d44\u6e90\uff0c\u4ee5\u53ca\u76d1\u89c6\u5176\u8d44\u6e90\u8fd0\u884c\u72b6\u6001\u3002</p> <p></p> <p>Kubernetes\u73af\u5883\u51c6\u5907\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u5c1d\u8bd5\u5728Kubernetes\u4e0b\u5c1d\u8bd5\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u3002Kubernetes\u4e2d\u7ba1\u7406\u7684\u6240\u6709\u8d44\u6e90\u90fd\u53ef\u4ee5\u901a\u8fc7YAML\u6587\u4ef6\u8fdb\u884c\u63cf\u8ff0\u3002\u5982\u4e0b\u6240\u793a\uff0c\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3anginx-deploymeht.yml\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\n  labels:\n    app: nginx\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.7.9\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u5728\u8be5YAML\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u9700\u8981\u521b\u5efa\u7684\u8d44\u6e90\u7c7b\u578b\u4e3aDeployment\uff0c\u5728metadata\u4e2d\u58f0\u660e\u4e86\u8be5Deployment\u7684\u540d\u79f0\u4ee5\u53ca\u6807\u7b7e\u3002spec\u4e2d\u5219\u5b9a\u4e49\u4e86\u8be5Deployment\u7684\u5177\u4f53\u8bbe\u7f6e\uff0c\u901a\u8fc7replicas\u5b9a\u4e49\u4e86\u8be5Deployment\u521b\u5efa\u540e\u5c06\u4f1a\u81ea\u52a8\u521b\u5efa3\u4e2aPod\u5b9e\u4f8b\u3002\u8fd0\u884c\u7684Pod\u4ee5\u53ca\u8fdb\u884c\u5219\u901a\u8fc7template\u8fdb\u884c\u5b9a\u4e49\u3002</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\u4f7f\u7528\uff0c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl create -f nginx-deployment.yml\ndeployment \"nginx-deployment\" created\n</code></pre> <p>\u5728\u672a\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u7684\u60c5\u51b5\u4e0b\uff0ckubectl\u9ed8\u8ba4\u5173\u8054default\u547d\u540d\u7a7a\u95f4\u3002\u7531\u4e8e\u8fd9\u91cc\u6ca1\u6709\u6307\u5b9aNamespace\uff0c\u8be5Deployment\u5c06\u4f1a\u5728\u9ed8\u8ba4\u7684\u547d\u4ee4\u7a7a\u95f4default\u4e2d\u521b\u5efa\u3002 \u901a\u8fc7kubectl get\u547d\u4ee4\u67e5\u770b\u5f53\u524dDeployment\u7684\u90e8\u7f72\u8fdb\u5ea6\uff1a</p> <pre><code># \u67e5\u770bDeployment\u7684\u8fd0\u884c\u72b6\u6001\n$ kubectl get deployments\nNAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nnginx-deployment   3         3         3            3           1m\n\n# \u67e5\u770b\u8fd0\u884c\u7684Pod\u5b9e\u4f8b\n$ kubectl get pods\nNAME                                READY     STATUS    RESTARTS   AGE\nnginx-deployment-6d8f46cfb7-5f9qm   1/1       Running   0          1m\nnginx-deployment-6d8f46cfb7-9ppb8   1/1       Running   0          1m\nnginx-deployment-6d8f46cfb7-nfmsw   1/1       Running   0          1m\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9\u7528\u6237\u6216\u8005\u5176\u5b83\u670d\u52a1\u80fd\u591f\u8bbf\u95ee\u5230Nginx\u5b9e\u4f8b\uff0c\u8fd9\u91cc\u901a\u8fc7\u4e00\u4e2a\u540d\u4e3anginx-service.yml\u7684\u6587\u4ef6\u5b9a\u4e49Service\u8d44\u6e90\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: nginx-service\nspec:\n  selector:\n    app: nginx\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n  type: NodePort\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cService\u8d44\u6e90\u53ea\u80fd\u901a\u8fc7\u96c6\u7fa4\u7f51\u7edc\u8fdb\u884c\u8bbf\u95ee(type=ClusterIP)\u3002\u8fd9\u91cc\u4e3a\u4e86\u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u8be5Service\uff0c\u9700\u8981\u5c06\u5bb9\u5668\u7aef\u53e3\u6620\u5c04\u5230\u4e3b\u673a\u4e0a\uff0c\u56e0\u6b64\u5b9a\u4e49\u8be5Service\u7c7b\u578b\u4e3aNodePort\u3002</p> <p>\u521b\u5efa\u5e76\u67e5\u770bService\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl create -f nginx-service.yml\nservice \"nginx-service\" created\n\n$ kubectl get svc\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nkubernetes      ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        131d\nnginx-service   NodePort    10.104.103.112   &lt;none&gt;        80:32022/TCP   10s\n</code></pre> <p>\u901a\u8fc7nginx-server\u6620\u5c04\u5230\u865a\u62df\u673a\u768432022\u7aef\u53e3\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u5230Nginx\u5b9e\u4f8b\u768480\u7aef\u53e3\uff1a</p> <p></p> <p>\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u5982\u679c\u9700\u8981\u5bf9Nginx\u5b9e\u4f8b\u8fdb\u884c\u6269\u5c55\uff0c\u53ef\u4ee5\u4f7f\u7528\uff1a</p> <pre><code>$ kubectl scale deployments/nginx-deployment --replicas=4\ndeployment \"nginx-deployment\" scaled\n</code></pre> <p>\u901a\u8fc7kubectl\u547d\u4ee4\u8fd8\u53ef\u4ee5\u5bf9\u955c\u50cf\u8fdb\u884c\u6eda\u52a8\u5347\u7ea7\uff1a</p> <pre><code>$ kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1\ndeployment \"nginx-deployment\" image updated\n\n$ kubectl get pods\nNAME                                READY     STATUS              RESTARTS   AGE\nnginx-deployment-58b94fcb9-8fjm6    0/1       ContainerCreating   0          52s\nnginx-deployment-58b94fcb9-qzlwx    0/1       ContainerCreating   0          51s\nnginx-deployment-6d8f46cfb7-5f9qm   1/1       Running             0          45m\nnginx-deployment-6d8f46cfb7-7xs6z   0/1       Terminating         0          2m\nnginx-deployment-6d8f46cfb7-9ppb8   1/1       Running             0          45m\nnginx-deployment-6d8f46cfb7-nfmsw   1/1       Running             0          45m\n</code></pre> <p>\u5982\u679c\u5347\u7ea7\u540e\u670d\u52a1\u51fa\u73b0\u5f02\u5e38\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5bf9\u5e94\u7528\u8fdb\u884c\u56de\u6eda\uff1a</p> <pre><code>$ kubectl rollout undo deployment/nginx-deployment\ndeployment \"nginx-deployment\"\n</code></pre> <p>Kubernetes\u4f9d\u6258\u4e8eGoogle\u4e30\u5bcc\u7684\u5927\u89c4\u6a21\u5e94\u7528\u7ba1\u7406\u7ecf\u9a8c\u3002\u901a\u8fc7\u5c06\u96c6\u7fa4\u73af\u5883\u62bd\u8c61\u4e3a\u4e00\u4e2a\u7edf\u4e00\u8c03\u5ea6\u548c\u7ba1\u7406\u7684\u4e91\"\u64cd\u4f5c\u7cfb\u7edf\uff0c\u89c6\u5bb9\u5668\u4e3a\u8fd9\u4e2a\u64cd\u4f5c\u4e2d\u72ec\u81ea\u8fd0\u884c\u7684\u201c\u8fdb\u7a0b\u201d\uff0c\u8fdb\u7a0b\u95f4\u7684\u9694\u79bb\u901a\u8fc7\u547d\u540d\u7a7a\u95f4\uff08Namespace\uff09\u5b8c\u6210\uff0c\u5b9e\u73b0\u4e86\u5bf9\u5e94\u7528\u751f\u547d\u5468\u671f\u7ba1\u7406\u4ece\u81ea\u52a8\u5316\u5230\u81ea\u4e3b\u5316\u7684\u8de8\u8d8a\u3002</p>"},{"location":"kubernetes/prometheus-with-kubernetes/","title":"Prometheus\u4e0eKubernetes","text":"<p>Kubernetes\u4f5c\u4e3a\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u4e86\u4e00\u4e2a\u53ef\u4ee5\u7edf\u4e00\u8c03\u5ea6\uff0c\u7edf\u4e00\u7ba1\u7406\u7684\u4e91\u64cd\u4f5c\u7cfb\u7edf\u3002\u5176\u89e3\u51b3\u5982\u7528\u6237\u5e94\u7528\u7a0b\u5e8f\u5982\u4f55\u8fd0\u884c\u7684\u95ee\u9898\u3002\u800c\u4e00\u65e6\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5927\u91cf\u57fa\u4e8eKubernetes\u90e8\u7f72\u548c\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u540e\uff0c\u4f5c\u4e3a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u8fd8\u9700\u8981\u5145\u5206\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u4ee5\u53caKubernetes\u96c6\u7fa4\u670d\u52a1\u8fd0\u884c\u8d28\u91cf\u5982\u4f55\uff0c\u901a\u8fc7\u5bf9\u5e94\u7528\u4ee5\u53ca\u96c6\u7fa4\u8fd0\u884c\u72b6\u6001\u6570\u636e\u7684\u6536\u96c6\u548c\u5206\u6790\uff0c\u6301\u7eed\u4f18\u5316\u548c\u6539\u8fdb\uff0c\u4ece\u800c\u63d0\u4f9b\u4e00\u4e2a\u5b89\u5168\u53ef\u9760\u7684\u751f\u4ea7\u8fd0\u884c\u73af\u5883\u3002 \u8fd9\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u5c06\u8ba8\u8bba\u5f53\u4f7f\u7528Kubernetes\u65f6\u7684\u76d1\u63a7\u7b56\u7565\u8be5\u5982\u4f55\u8bbe\u8ba1\u3002</p>"},{"location":"kubernetes/prometheus-with-kubernetes/#kubernetes","title":"Kubernetes\u67b6\u6784","text":"<p>\u4e3a\u4e86\u80fd\u591f\u66f4\u597d\u7684\u7406\u89e3Kubernetes\u4e0b\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3Kubernetes\u7684\u57fa\u672c\u67b6\u6784\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u662fKubernetes\u7684\u67b6\u6784\u793a\u610f\u56fe\uff1a</p> <p></p> <p>Kubernetes\u7684\u6838\u5fc3\u7ec4\u4ef6\u4e3b\u8981\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1aMaster\u7ec4\u4ef6\u548cNode\b\u7ec4\u4ef6\uff0c\b\u5176\u4e2dMatser\u7ec4\u4ef6\u63d0\u4f9b\u4e86\u96c6\u7fa4\u5c42\u9762\u7684\u7ba1\u7406\u529f\u80fd\uff0c\u5b83\u4eec\u8d1f\u8d23\u54cd\u5e94\u7528\u6237\u8bf7\u6c42\uff0c\u5904\u7406\u96c6\u7fa4\u5b9e\u9645\uff0c\u5e76\u4e14\u5bf9\u96c6\u7fa4\u8d44\u6e90\u8fdb\u884c\u7edf\u4e00\u7684\u8c03\u5ea6\u548c\u7ba1\u7406\u3002Node\u7ec4\u4ef6\u4f1a\u8fd0\u884c\u5728\u96c6\u7fa4\u7684\u6240\u6709\u8282\u70b9\u4e0a\uff0c\u5b83\u4eec\u8d1f\u8d23\u7ba1\u7406\u548c\u7ef4\u62a4\u8282\u70b9\u4e2d\u8fd0\u884c\u7684Pod\uff0c\u4e3aKubernetes\u96c6\u7fa4\u63d0\u4f9b\u8fd0\u884c\u65f6\u73af\u5883\u3002</p> <p>Master\u7ec4\u4ef6\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>kube-apiserver\uff1a\u8d1f\u8d23\u5bf9\u5916\u66b4\u9732Kubernetes API\uff1b</li> <li>etcd\uff1a\u7528\u4e8e\u5b58\u50a8Kubernetes\u96c6\u7fa4\u7684\u6240\u6709\u6570\u636e\uff1b</li> <li>kube-scheduler: \u8d1f\u8d23\u4e3a\u65b0\u521b\u5efa\u7684Pod\u9009\u62e9\u53ef\u4f9b\u5176\u8fd0\u884c\u7684\u8282\u70b9\uff1b</li> <li>kube-controller-manager\uff1a \u5305\u542bNode Controller\uff0cDeployment Controller\uff0cEndpoint Controller\u7b49\u7b49\uff0c\u901a\u8fc7\u4e0eapiserver\u4ea4\u4e92\u4f7f\u76f8\u5e94\u7684\u8d44\u6e90\u8fbe\u5230\u9884\u671f\u72b6\u6001\u3002</li> </ul> <p>Node\u7ec4\u4ef6\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>kubelet\uff1a\u8d1f\u8d23\u7ef4\u62a4\u548c\u7ba1\u7406\u8282\u70b9\u4e0aPod\u7684\u8fd0\u884c\u72b6\u6001\uff1b</li> <li>kube-proxy\uff1a\u8d1f\u8d23\u7ef4\u62a4\u4e3b\u673a\u4e0a\u7684\u7f51\u7edc\u89c4\u5219\u4ee5\u53ca\u8f6c\u53d1\u3002</li> <li>Container Runtime\uff1a\u5982Docker,rkt,runc\u7b49\u63d0\u4f9b\u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u3002</li> </ul>"},{"location":"kubernetes/prometheus-with-kubernetes/#kubernetes_1","title":"\u76d1\u63a7Kubernetes","text":"<p>\u4ece\u7269\u7406\u7ed3\u6784\u4e0a\u8bb2Kubernetes\u4e3b\u8981\u7528\u4e8e\u6574\u5408\u548c\u7ba1\u7406\u5e95\u5c42\u7684\u57fa\u7840\u8bbe\u65bd\u8d44\u6e90\uff0c\u5bf9\u5916\u63d0\u4f9b\u5e94\u7528\u5bb9\u5668\u7684\u81ea\u52a8\u5316\u90e8\u7f72\u548c\u7ba1\u7406\u80fd\u529b\uff0c\u8fd9\u4e9b\u57fa\u7840\u8bbe\u65bd\u53ef\u80fd\u662f\u7269\u7406\u673a\u3001\u865a\u62df\u673a\u3001\u4e91\u4e3b\u673a\u7b49\u7b49\u3002\u56e0\u6b64\uff0c\u57fa\u7840\u8d44\u6e90\u7684\u4f7f\u7528\u76f4\u63a5\u5f71\u54cd\u5f53\u524d\u96c6\u7fa4\u7684\u5bb9\u91cf\u548c\u5e94\u7528\u7684\u72b6\u6001\u3002\u5728\u8fd9\u90e8\u5206\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8\u96c6\u7fa4\u4e2d\u5404\u4e2a\u8282\u70b9\u7684\u4e3b\u673a\u8d1f\u8f7d\uff0cCPU\u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u3001\u5b58\u50a8\u7a7a\u95f4\u4ee5\u53ca\u7f51\u7edc\u541e\u5410\u7b49\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u4ece\u81ea\u8eab\u67b6\u6784\u4e0a\u8bb2\uff0ckube-apiserver\u662fKubernetes\u63d0\u4f9b\u6240\u6709\u670d\u52a1\u7684\u5165\u53e3\uff0c\u65e0\u8bba\u662f\u5916\u90e8\u7684\u5ba2\u6237\u7aef\u8fd8\u662f\u96c6\u7fa4\u5185\u90e8\u7684\u7ec4\u4ef6\u90fd\u76f4\u63a5\u4e0ekube-apiserver\u8fdb\u884c\u901a\u8baf\u3002\u56e0\u6b64\uff0ckube-apiserver\u7684\u5e76\u53d1\u548c\u541e\u5410\u91cf\u76f4\u63a5\u51b3\u5b9a\u4e86\u96c6\u7fa4\u6027\u80fd\u7684\u597d\u574f\u3002\u5176\u6b21\uff0c\u5bf9\u4e8e\u5916\u90e8\u7528\u6237\u800c\u8a00\uff0cKubernetes\u662f\u5426\u80fd\u591f\u5feb\u901f\u7684\u5b8c\u6210pod\u7684\u8c03\u5ea6\u4ee5\u53ca\u542f\u52a8\uff0c\u662f\u5f71\u54cd\u5176\u4f7f\u7528\u4f53\u9a8c\u7684\u5173\u952e\u56e0\u7d20\u3002\u800c\u8fd9\u4e2a\u8fc7\u7a0b\u4e3b\u8981\u7531kube-scheduler\u8d1f\u8d23\u5b8c\u6210\u8c03\u5ea6\u5de5\u4f5c\uff0c\u800ckubelet\u5b8c\u6210pod\u7684\u521b\u5efa\u548c\u542f\u52a8\u5de5\u4f5c\u3002\u56e0\u6b64\u5728Kubernetes\u96c6\u7fa4\u672c\u8eab\u6211\u4eec\u9700\u8981\u8bc4\u4ef7\u5176\u81ea\u8eab\u7684\u670d\u52a1\u8d28\u91cf\uff0c\u4e3b\u8981\u5173\u6ce8\u5728Kubernetes\u7684API\u54cd\u5e94\u65f6\u95f4\uff0c\u4ee5\u53caPod\u7684\u542f\u52a8\u65f6\u95f4\u7b49\u6307\u6807\u4e0a\u3002</p> <p>Kubernetes\u7684\u6700\u7ec8\u76ee\u6807\u8fd8\u662f\u9700\u8981\u4e3a\u4e1a\u52a1\u670d\u52a1\uff0c\u56e0\u6b64\u6211\u4eec\u8fd8\u9700\u8981\u80fd\u591f\u76d1\u63a7\u5e94\u7528\u5bb9\u5668\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002\u5bf9\u4e8e\u5185\u7f6e\u4e86\u5bf9Prometheus\u652f\u6301\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u8981\u652f\u6301\u4ece\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u4e2d\u91c7\u96c6\u5185\u90e8\u7684\u76d1\u63a7\u6307\u6807\u3002\u6700\u540e\uff0c\u7ed3\u5408\u9ed1\u76d2\u76d1\u63a7\u6a21\u5f0f\uff0c\u5bf9\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u670d\u52a1\u8fdb\u884c\u63a2\u6d4b\uff0c\u4ece\u800c\u5f53\u5e94\u7528\u53d1\u751f\u6545\u969c\u540e\uff0c\u80fd\u591f\u5feb\u901f\u5904\u7406\u548c\u6062\u590d\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u4e0d\u8003\u8651Kubernetes\u81ea\u8eab\u7ec4\u4ef6\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u8981\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u6211\u4eec\u5e94\u8be5\u8003\u8651\uff0c\u4ee5\u4e0b5\u4e2a\u65b9\u9762\uff1a</p> <ul> <li>\u96c6\u7fa4\u8282\u70b9\u72b6\u6001\u76d1\u63a7\uff1a\u4ece\u96c6\u7fa4\u4e2d\u5404\u8282\u70b9\u7684kubelet\u670d\u52a1\u83b7\u53d6\u8282\u70b9\u7684\u57fa\u672c\u8fd0\u884c\u72b6\u6001\uff1b</li> <li>\u96c6\u7fa4\u8282\u70b9\u8d44\u6e90\u7528\u91cf\u76d1\u63a7\uff1a\u901a\u8fc7Daemonset\u7684\u5f62\u5f0f\u5728\u96c6\u7fa4\u4e2d\u5404\u4e2a\u8282\u70b9\u90e8\u7f72Node Exporter\u91c7\u96c6\u8282\u70b9\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1b</li> <li>\u8282\u70b9\u4e2d\u8fd0\u884c\u7684\u5bb9\u5668\u76d1\u63a7\uff1a\u901a\u8fc7\u5404\u4e2a\u8282\u70b9\u4e2dkubelet\u5185\u7f6e\u7684cAdvisor\u4e2d\u83b7\u53d6\u4e2a\u8282\u70b9\u4e2d\u6240\u6709\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\u548c\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1b</li> <li>\u4ece\u9ed1\u76d2\u76d1\u63a7\u7684\u89d2\u5ea6\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72Blackbox Exporter\u63a2\u9488\u670d\u52a1\uff0c\u68c0\u6d4bService\u548cIngress\u7684\u53ef\u7528\u6027\uff1b</li> <li>\u5982\u679c\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u76d1\u63a7\u652f\u6301\uff0c\u90a3\u4e48\u6211\u4eec\u8fd8\u5e94\u8be5\u627e\u5230\u76f8\u5e94\u7684Pod\u5b9e\u4f8b\uff0c\u5e76\u4ece\u8be5Pod\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u5176\u5185\u90e8\u8fd0\u884c\u72b6\u6001\u7684\u76d1\u63a7\u6307\u6807\u3002</li> </ul>"},{"location":"kubernetes/service-discovery-with-kubernetes/","title":"Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u5728Kubernetes\u4e0b\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684Prometheus\u5b9e\u4f8b\uff0c\u4e0d\u8fc7\u5f53\u524d\u6765\u8bf4\u5b83\u5e76\u4e0d\u80fd\u53d1\u6325\u5176\u76d1\u63a7\u7cfb\u7edf\u7684\u4f5c\u7528\uff0c\u9664\u4e86Prometheus\uff0c\u6682\u65f6\u6ca1\u6709\u4efb\u4f55\u7684\u76d1\u63a7\u91c7\u96c6\u76ee\u6807\u3002\u5728\u7b2c7\u7ae0\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u5b83\u80fd\u591f\u4e0e\u901a\u8fc7\u4e0e\u201c\u4e2d\u95f4\u4ee3\u7406\u4eba\u201c\u7684\u4ea4\u4e92\uff0c\u4ece\u800c\u52a8\u6001\u7684\u83b7\u53d6\u9700\u8981\u76d1\u63a7\u7684\u76ee\u6807\u5b9e\u4f8b\u3002\u800c\u5728Kubernetes\u4e0bPrometheus\u5c31\u662f\u9700\u8981\u4e0eKubernetes\u7684API\u8fdb\u884c\u4ea4\u4e92\uff0c\u4ece\u800c\u80fd\u591f\u52a8\u6001\u7684\u53d1\u73b0Kubernetes\u4e2d\u90e8\u7f72\u7684\u6240\u6709\u53ef\u76d1\u63a7\u7684\u76ee\u6807\u8d44\u6e90\u3002</p>"},{"location":"kubernetes/service-discovery-with-kubernetes/#kubernetes_1","title":"Kubernetes\u7684\u8bbf\u95ee\u6388\u6743","text":"<p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u80fd\u591f\u8bbf\u95ee\u6536\u5230\u8ba4\u8bc1\u4fdd\u62a4\u7684Kubernetes API\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u505a\u7684\u662f\uff0c\u5bf9Prometheus\u8fdb\u884c\u8bbf\u95ee\u6388\u6743\u3002\u5728Kubernetes\u4e2d\u4e3b\u8981\u4f7f\u7528\u57fa\u4e8e\u89d2\u8272\u7684\u8bbf\u95ee\u63a7\u5236\u6a21\u578b(Role-Based Access Control)\uff0c\u7528\u4e8e\u7ba1\u7406Kubernetes\u4e0b\u8d44\u6e90\u8bbf\u95ee\u6743\u9650\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u5728Kubernetes\u4e0b\u5b9a\u4e49\u89d2\u8272\uff08ClusterRole\uff09\uff0c\u5e76\u4e14\u4e3a\u8be5\u89d2\u8272\u8d4b\u4e88\u76f8\u5e94\u7684\u8bbf\u95ee\u6743\u9650\u3002\u540c\u65f6\u521b\u5efaPrometheus\u6240\u4f7f\u7528\u7684\u8d26\u53f7\uff08ServiceAccount\uff09\uff0c\u6700\u540e\u5219\u662f\u5c06\u8be5\u8d26\u53f7\u4e0e\u89d2\u8272\u8fdb\u884c\u7ed1\u5b9a\uff08ClusterRoleBinding\uff09\u3002\u8fd9\u4e9b\u6240\u6709\u7684\u64cd\u4f5c\u5728Kubernetes\u540c\u6837\u88ab\u89c6\u4e3a\u662f\u4e00\u7cfb\u5217\u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u901a\u8fc7YAML\u6587\u4ef6\u8fdb\u884c\u63cf\u8ff0\u5e76\u521b\u5efa\uff0c\u8fd9\u91cc\u521b\u5efaprometheus-rbac-setup.yml\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/proxy\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups:\n  - extensions\n  resources:\n  - ingresses\n  verbs: [\"get\", \"list\", \"watch\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: default\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: default\n</code></pre> <p>\u5176\u4e2d\u9700\u8981\u6ce8\u610f\u7684\u662fClusterRole\u662f\u5168\u5c40\u7684\uff0c\u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u3002\u800cServiceAccount\u662f\u5c5e\u4e8e\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u7684\u8d44\u6e90\u3002\u901a\u8fc7kubectl\u547d\u4ee4\u521b\u5efaRBAC\u5bf9\u5e94\u7684\u5404\u4e2a\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl create -f prometheus-rbac-setup.yml\nclusterrole \"prometheus\" created\nserviceaccount \"prometheus\" created\nclusterrolebinding \"prometheus\" created\n</code></pre> <p>\u5728\u5b8c\u6210\u89d2\u8272\u6743\u9650\u4ee5\u53ca\u7528\u6237\u7684\u7ed1\u5b9a\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6307\u5b9aPrometheus\u4f7f\u7528\u7279\u5b9a\u7684ServiceAccount\u521b\u5efaPod\u5b9e\u4f8b\u3002\u4fee\u6539prometheus-deployment.yml\u6587\u4ef6\uff0c\u5e76\u6dfb\u52a0serviceAccountName\u548cserviceAccount\u5b9a\u4e49\uff1a</p> <pre><code>spec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      serviceAccountName: prometheus\n      serviceAccount: prometheus\n</code></pre> <p>\u901a\u8fc7kubectl apply\u5bf9Deployment\u8fdb\u884c\u53d8\u66f4\u5347\u7ea7\uff1a</p> <pre><code>$ kubectl apply -f prometheus-deployment.yml\nservice \"prometheus\" configured\ndeployment \"prometheus\" configured\n\n$ kubectl get pods\nNAME                               READY     STATUS        RESTARTS   AGE\nprometheus-55f655696d-wjqcl        0/1       Terminating   0          38m\nprometheus-69f9ddb588-czn2c        1/1       Running       0          6s\n</code></pre> <p>\u6307\u5b9aServiceAccount\u521b\u5efa\u7684Pod\u5b9e\u4f8b\u4e2d\uff0c\u4f1a\u81ea\u52a8\u5c06\u7528\u4e8e\u8bbf\u95eeKubernetes API\u7684CA\u8bc1\u4e66\u4ee5\u53ca\u5f53\u524d\u8d26\u6237\u5bf9\u5e94\u7684\u8bbf\u95ee\u4ee4\u724c\u6587\u4ef6\u6302\u8f7d\u5230Pod\u5b9e\u4f8b\u7684/var/run/secrets/kubernetes.io/serviceaccount/\u76ee\u5f55\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>kubectl exec -it prometheus-69f9ddb588-czn2c ls /var/run/secrets/kubernetes.io/serviceaccount/\nca.crt     namespace  token\n</code></pre>"},{"location":"kubernetes/service-discovery-with-kubernetes/#_1","title":"\u670d\u52a1\u53d1\u73b0","text":"<p>\u5728Kubernetes\u4e0b\uff0cPromethues\u901a\u8fc7\u4e0eKubernetes API\u96c6\u6210\u76ee\u524d\u4e3b\u8981\u652f\u63015\u79cd\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u5206\u522b\u662f\uff1aNode\u3001Service\u3001Pod\u3001Endpoints\u3001Ingress\u3002</p> <p>\u901a\u8fc7kubectl\u547d\u4ee4\u884c\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get nodes -o wide\nNAME       STATUS    ROLES     AGE       VERSION   EXTERNAL-IP   OS-IMAGE            KERNEL-VERSION   CONTAINER-RUNTIME\nminikube   Ready     &lt;none&gt;    164d      v1.8.0    &lt;none&gt;        Buildroot 2017.02   4.9.13           docker://Unknown\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u80fd\u591f\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u5728Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u6dfb\u52a0\u5982\u4e0bJob\u914d\u7f6e\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n</code></pre> <p>\u901a\u8fc7\u6307\u5b9akubernetes_sd_config\u7684\u6a21\u5f0f\u4e3anode\uff0cPrometheus\u4f1a\u81ea\u52a8\u4eceKubernetes\u4e2d\u53d1\u73b0\u5230\u6240\u6709\u7684node\u8282\u70b9\u5e76\u4f5c\u4e3a\u5f53\u524dJob\u76d1\u63a7\u7684Target\u5b9e\u4f8b\u3002\u5982\u4e0b\u6240\u793a\uff0c\u8fd9\u91cc\u9700\u8981\u6307\u5b9a\u7528\u4e8e\u8bbf\u95eeKubernetes API\u7684ca\u4ee5\u53catoken\u6587\u4ef6\u8def\u5f84\u3002</p> <p>\u5bf9\u4e8eIngress\uff0cService\uff0cEndpoints, Pod\u7684\u4f7f\u7528\u65b9\u5f0f\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u4e0b\u9762\u7ed9\u51fa\u4e86\u4e00\u4e2a\u5b8c\u6574Prometheus\u914d\u7f6e\u7684\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: v1\ndata:\n  prometheus.yml: |-\n    global:\n      scrape_interval:     15s \n      evaluation_interval: 15s\n    scrape_configs:\n\n    - job_name: 'kubernetes-nodes'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n\n    - job_name: 'kubernetes-service'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: service\n\n    - job_name: 'kubernetes-endpoints'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: endpoints\n\n    - job_name: 'kubernetes-ingress'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: ingress\n\n    - job_name: 'kubernetes-pods'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: pod\n\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n</code></pre> <p>\u66f4\u65b0Prometheus\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u91cd\u5efaPrometheus\u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl apply -f prometheus-config.yml\nconfigmap \"prometheus-config\" configured\n\n$ kubectl get pods\nprometheus-69f9ddb588-rbrs2        1/1       Running   0          4m\n\n$ kubectl delete pods prometheus-69f9ddb588-rbrs2\npod \"prometheus-69f9ddb588-rbrs2\" deleted\n\n$ kubectl get pods\nprometheus-69f9ddb588-rbrs2        0/1       Terminating   0          4m\nprometheus-69f9ddb588-wtlsn        1/1       Running       0          14s\n</code></pre> <p>Prometheus\u4f7f\u7528\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u91cd\u5efa\u4e4b\u540e\uff0c\u6253\u5f00Prometheus UI\uff0c\u901a\u8fc7Service Discovery\u9875\u9762\u53ef\u4ee5\u67e5\u770b\u5230\u5f53\u524dPrometheus\u901a\u8fc7Kubernetes\u53d1\u73b0\u7684\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a</p> <p></p> <p>\u540c\u65f6Prometheus\u4f1a\u81ea\u52a8\u5c06\u8be5\u8d44\u6e90\u7684\u6240\u6709\u4fe1\u606f\uff0c\u5e76\u901a\u8fc7\u6807\u7b7e\u7684\u5f62\u5f0f\u4f53\u73b0\u5728Target\u5bf9\u8c61\u4e0a\u3002\u5982\u4e0b\u6240\u793a\uff0c\u662fPrometheus\u83b7\u53d6\u5230\u7684Node\u8282\u70b9\u7684\u6807\u7b7e\u4fe1\u606f\uff1a</p> <pre><code>__address__=\"192.168.99.100:10250\"\n__meta_kubernetes_node_address_Hostname=\"minikube\"\n__meta_kubernetes_node_address_InternalIP=\"192.168.99.100\"\n__meta_kubernetes_node_annotation_alpha_kubernetes_io_provided_node_ip=\"192.168.99.100\"\n__meta_kubernetes_node_annotation_node_alpha_kubernetes_io_ttl=\"0\"\n__meta_kubernetes_node_annotation_volumes_kubernetes_io_controller_managed_attach_detach=\"true\"\n__meta_kubernetes_node_label_beta_kubernetes_io_arch=\"amd64\"\n__meta_kubernetes_node_label_beta_kubernetes_io_os=\"linux\"\n__meta_kubernetes_node_label_kubernetes_io_hostname=\"minikube\"\n__meta_kubernetes_node_name=\"minikube\"\n__metrics_path__=\"/metrics\"\n__scheme__=\"https\"\ninstance=\"minikube\"\njob=\"kubernetes-nodes\"\n</code></pre> <p>\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u901a\u8fc7Prometheus\u81ea\u52a8\u53d1\u73b0Kubernetes\u96c6\u7fa4\u4e2d\u7684\u5404\u7c7b\u8d44\u6e90\u4ee5\u53ca\u5176\u57fa\u672c\u4fe1\u606f\u3002\u4e0d\u8fc7\uff0c\u5982\u679c\u73b0\u5728\u67e5\u770bPrometheus\u7684Target\u72b6\u6001\u9875\u9762\uff0c\u7ed3\u679c\u53ef\u80fd\u4f1a\u8ba9\u4eba\u4e0d\u592a\u6ee1\u610f\uff1a</p> <p></p> <p>\u867d\u7136Prometheus\u80fd\u591f\u81ea\u52a8\u53d1\u73b0\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u5e76\u4e14\u5c06\u5176\u4f5c\u4e3aTarget\u5bf9\u8c61\u8fdb\u884c\u6570\u636e\u91c7\u96c6\u3002 \u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\u90fd\u662f\u652f\u6301Promethues\u7684\uff0c\u5e76\u4e14\u4e0d\u540c\u7c7b\u578b\u8d44\u6e90\u5bf9\u8c61\u7684\u91c7\u96c6\u65b9\u5f0f\u53ef\u80fd\u662f\u4e0d\u540c\u7684\u3002\u56e0\u6b64\uff0c\u5728\u5b9e\u9645\u7684\u64cd\u4f5c\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u6709\u660e\u786e\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u5e76\u4e14\u9488\u5bf9\u4e0d\u540c\u7c7b\u578b\u7684\u76d1\u63a7\u76ee\u6807\u8bbe\u7f6e\u4e0d\u540c\u7684\u6570\u636e\u91c7\u96c6\u65b9\u5f0f\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5229\u7528Prometheus\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u5b9e\u73b0\u5bf9Kubernetes\u96c6\u7fa4\u7684\u5168\u9762\u76d1\u63a7\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-containers-in-k8s/","title":"\u5e94\u7528\u5bb9\u5668\u76d1\u63a7","text":"<p>\u5728\u7b2c4\u7ae0\u7684\u201c\u76d1\u63a7\u5bb9\u5668\u8fd0\u884c\u72b6\u6001\u201d\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86\u5982\u4f55\u4f7f\u7528cAdvisor\u76d1\u63a7\u4e3b\u673a\u4e2d\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\u3002\u800cKubernetes\u76f4\u63a5\u5728Kubelet\u7ec4\u4ef6\u4e2d\u96c6\u6210\u4e86cAdvisor\uff0ccAdvisor\u4f1a\u81ea\u52a8\u91c7\u96c6\u5f53\u524d\u8282\u70b9\u4e0a\u5bb9\u5668CPU\uff0c\u5185\u5b58\uff0c\u6587\u4ef6\u7cfb\u7edf\uff0c\u7f51\u7edc\u7b49\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u5176\u9ed8\u8ba4\u8fd0\u884c\u7aef\u53e3\u4e3a4194\u3002</p> <p>\u767b\u5f55\u5230MiniKube\u4e3b\u673a\uff0c\u5e76\u4e14\u8bbf\u95ee\u672c\u673a\u76844194\u7aef\u53e3\uff0c\u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524d\u8282\u70b9\u4e0acAdvisor\u7684\u76d1\u63a7\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>$ minikube ssh\n\n$  curl 127.0.0.1:4194/metrics\n...\n# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.\n# TYPE process_start_time_seconds gauge\nprocess_start_time_seconds 1.52506226634e+09\n# HELP process_virtual_memory_bytes Virtual memory size in bytes.\n# TYPE process_virtual_memory_bytes gauge\nprocess_virtual_memory_bytes 1.1649622016e+10\n</code></pre> <p>\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5229\u7528Prometheus\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u81ea\u52a8\u7684\u627e\u5230\u8fd9\u4e9b\bcAdvisor\u7684\u91c7\u96c6\u76ee\u6807\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-containers-in-k8s/#node","title":"\u57fa\u4e8eNode\u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u901a\u8fc7Kubernetes\u81ea\u52a8\u7684\u53d1\u73b0\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709Node\u8282\u70b9\u3002</p> <pre><code> kubernetes_sd_configs:\n - role: node\n</code></pre> <p>\u5982\u4e0a\u6240\u793a\uff0c\u5f53role\u7684\u914d\u7f6e\u4e3anode\u65f6\uff0cPrometheus\u4f1a\u901a\u8fc7Kubernetes API\u627e\u5230\u96c6\u7fa4\u4e2d\u7684\u6240\u6709Node\u5bf9\u8c61\uff0c\u5e76\u4e14\u5c06\u5176\u8f6c\u6362\u4e3aPrometheus\u7684Target\u5bf9\u8c61\uff0c\u4ecePrometheus UI\u4e2d\u53ef\u4ee5\u67e5\u770b\u8be5Target\u5b9e\u4f8b\u5305\u542b\u7684\u6240\u6709Metadata\u6807\u7b7e\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u5728\u4eceMiniKube\u96c6\u7fa4\u4e2d\u83b7\u53d6\u5230\u7684\u4e00\u4e2a\u8282\u70b9Metadata\u6807\u7b7e\u4fe1\u606f\uff1a</p> <pre><code>__address__=\"192.168.99.100:10250\"\n__meta_kubernetes_node_address_Hostname=\"minikube\"\n__meta_kubernetes_node_address_InternalIP=\"192.168.99.100\"\n__meta_kubernetes_node_annotation_alpha_kubernetes_io_provided_node_ip=\"192.168.99.100\"\n__meta_kubernetes_node_annotation_node_alpha_kubernetes_io_ttl=\"0\"\n__meta_kubernetes_node_annotation_volumes_kubernetes_io_controller_managed_attach_detach=\"true\"\n__meta_kubernetes_node_label_beta_kubernetes_io_arch=\"amd64\"\n__meta_kubernetes_node_label_beta_kubernetes_io_os=\"linux\"\n__meta_kubernetes_node_label_kubernetes_io_hostname=\"minikube\"\n__meta_kubernetes_node_name=\"minikube\"\n__metrics_path__=\"/metrics\"\n__scheme__=\"https\"\ninstance=\"minikube\"  \njob=\"kubernetes-nodes\"\n</code></pre> <p>\u5176\u4e2d<code>__address__</code>\u9ed8\u8ba4\u4e3a\u5f53\u524d\u8282\u70b9\u4e0a\u8fd0\u884c\u7684kubelet\u7684\u8bbf\u95ee\u5730\u5740\u3002\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\uff0c\u901a\u8fc7node\u52a8\u6001\u53d1\u73b0\u7684Target\u4f1a\u5305\u542b\u5982\u4e0b\u51e0\u7c7b\u6807\u7b7e\uff1a</p> <ul> <li><code>__meta_kubernetes_node_name</code>\uff1a\u8be5\u8282\u70b9\u5728\u96c6\u7fa4\u4e2d\u7684\u540d\u79f0\uff1b</li> <li><code>__meta_kubernetes_node_label_&lt;labelname&gt;</code>\uff1a\u8be5\u8282\u70b9\u4e2d\u5305\u542b\u7684\u7528\u6237\u81ea\u5b9a\u4e49\u6807\u7b7e\u4ee5\u53caKubernetes\u81ea\u52a8\u751f\u6210\u7684\u6807\u7b7e\uff1b</li> <li><code>__meta_kubernetes_node_annotation_&lt;annotationname&gt;</code>\uff1a\u8be5\u8282\u70b9\u4e2d\u5305\u542b\u7684Kubernetes\u81ea\u52a8\u751f\u6210\u7684\u6ce8\u89e3\u4fe1\u606f\uff1b</li> <li><code>__meta_kubernetes_node_address_&lt;address_type&gt;</code>\uff1a\u8be5\u8282\u70b9\u5404\u79cd\u7c7b\u578b\uff08NodeInternalIP\uff0cNodeExternalIP\uff0cNodeLegacyHostIP\uff0cNodeHostName\uff09\u7684\u8bbf\u95ee\u5730\u5740\u3002</li> </ul> <p>\u7528\u6237\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u8282\u70b9\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get nodes/minikube -o yaml\n</code></pre>"},{"location":"kubernetes/use-prometheus-monitor-containers-in-k8s/#relabeling","title":"\u4f7f\u7528Relabeling\u4fee\u6539\u91c7\u96c6\u4efb\u52a1","text":"<p>\u4e3a\u4e86\u80fd\u591f\u901a\u8fc7Prometheus\u91c7\u96c6\u5230cAdvisor\u7684metrics\u670d\u52a1\uff0c\u6211\u4eec\u4e3acAdvisor\u5b9a\u4e49\u4e86\u5355\u72ec\u91c7\u96c6\u4efb\u52a1\u3002\u8be5\u4efb\u52a1\u5c06\u57fa\u4e8eNode\u6a21\u5f0f\u53d1\u73b0\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u8282\u70b9\uff0c\u5e76\u901a\u8fc7Relabel\u4fee\u6539Target\u7684\u6570\u636e\u91c7\u96c6\u914d\u7f6e\uff0c\u4ece\u800c\u83b7\u53d6\u5230cAdvisor\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4fee\u6539prometheus-config.yml\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\ndata:\n  prometheus.yml: |-\n    global:\n      scrape_interval:     15s\n      evaluation_interval: 15s\n    scrape_configs:\n    - job_name: 'kubernetes-cadvisor'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - source_labels: [__address__]\n        regex: (.+):(.+)\n        action: replace\n        target_label: __address__\n        replacement: $1:4194\n      - action: replace\n        target_label: __scheme__\n        replacement: http\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e09\u4e2arelabel\u6b65\u9aa4\uff1a</p> <ol> <li>\u9ed8\u8ba4\u83b7\u53d6\u5230\u7684target\u5730\u5740\u4e3a\uff0c\u5f53\u524d\u8282\u70b9\u4e2dkubelet\u7684\u8bbf\u95ee\u5730\u5740\u3002\u56e0\u6b64\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f(.+):(.+)\u5339\u914d\u51faIP\u5730\u5740\u548c\u7aef\u53e3\uff0c\u5e76\u5c06\u5c06\u5339\u914d\u5230\u7684\u5185\u5bb9\u6309\u7167$1:4194\u7684\u5f62\u5f0f\u8986\u76d6<code>__address__</code>\u7684\u503c\u3002 \u4ece\u800c\u83b7\u5f97cAdvisor\u8bbf\u95ee\u5730\u5740\uff1b</li> <li>\u9ed8\u8ba4\u8fd4\u56de\u7684<code>__scheme__</code>\u4e3ahttps\uff0c\u901a\u8fc7\u76f4\u63a5\u4fee\u6539\u5176\u503c\u4e3ahttp\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba9Prometheus\u901a\u8fc7\u8bbf\u95eehttp://IP:4193/metrics\u4f5c\u4e3a\u91c7\u96c6\u76ee\u6807\u5730\u5740\uff1b</li> <li>\u6700\u540e\u901a\u8fc7labelmap\u5c06\u8be5\u8282\u70b9\u4e0a\u7684\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u5199\u5165\u5230\u6837\u672c\u4e2d\uff0c\u4ece\u800c\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u901a\u8fc7\u8fd9\u4e9b\u6807\u7b7e\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u3002</li> </ol> <p></p> <p>\u5982\u4e0a\u6240\u793a\uff0cPrometheus\u901a\u8fc7\u81ea\u52a8\u53d1\u73b0Node\u8282\u70b9\uff0c\u5e76\u901a\u8fc7Relabel\u81ea\u5b9a\u4e49\u91c7\u96c6\u65b9\u5f0f\u540e\u7684\u7ed3\u679c\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u901a\u8fc7\u96c6\u7fa4\u4e2d\u4e3b\u673a\u76844194\u7aef\u53e3\u83b7\u53d6cAdvisor\u6570\u636e\uff0c\u5e76\u4e0d\u9002\u7528\u4e8eKubernetes\u96c6\u7fa4\uff0c\u8fd9\u79cd\u65b9\u5f0f\u9650\u5236\u4e86cAdvisor\u670d\u52a1\u7684\u8fd0\u884c\u7aef\u53e3\u3002\u9664\u4e86\u76f4\u63a5\u8bbf\u95ee\u5404\u4e2a\u8282\u70b9\u7684cAdvisor\u670d\u52a1\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7Kubernetes\u7684API Server\u4f5c\u4e3a\u4ee3\u7406\u83b7\u53d6\u8282\u70b9\u4e0a\u7684cAdvisor\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u9664\u4e86\u76f4\u63a5\u8bbf\u95eecAdvisor\u76d1\u542c\u7684\u7aef\u53e3\u4ee5\u5916\uff0c\u66f4\u901a\u7528\u7684\u65b9\u5f0f\u662f\u901a\u8fc7apiserver\u8bbf\u95eekubelet\u63d0\u4f9b\u7684/metrics/cadvisor\u63a5\u53e3\u83b7\u53d6cAdvisor\u7684\u6837\u672c\u6570\u636e\u3002\u4f8b\u5982\uff0c\u60f3\u8981\u83b7\u53d6\u8282\u70b9minikube\u4e0acAdvisor\u7684\u76d1\u63a7\u6570\u636e\u53ef\u4ee5\u4f7f\u7528ca\u8bc1\u4e66\u548c\u4ee4\u724c\u5728Kubernetes\u96c6\u7fa4\u5185\u8bbf\u95ee\u4ee5\u4e0b\u5730\u5740\u83b7\u53d6\uff1a</p> <pre><code>https://kubernetes.default.svc:443/api/v1/nodes/minikube/proxy/metrics/cadvisor\n</code></pre> <p>\u56e0\u6b64\uff0c\u4fee\u6539kubernetes-cadvisor\u7684relabel\u914d\u7f6e\uff0c\u901a\u8fc7\u83b7\u53d6\u8282\u70b9\u7684<code>__meta_kubernetes_node_name</code>\u5e76\u91cd\u5199<code>__metrics_path__</code>\u5c06\u91c7\u96c6\u4efb\u52a1\u5730\u5740\u91cd\u5b9a\u5411\u5230apiserver\u7684API\u5730\u5740\uff1a</p> <pre><code>    - job_name: 'kubernetes-cadvisor'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0cPrometheus\u4f7f\u7528\u4e86\u8bbf\u95ee\u5730\u5740\u540e\u7684\u4efb\u52a1\u91c7\u96c6\u72b6\u6001\uff1a</p> <p></p>"},{"location":"kubernetes/use-prometheus-monitor-k8s-cluster-state/","title":"\u76d1\u63a7\u96c6\u7fa4\u72b6\u6001","text":"<p>\u5f53\u4f7f\u7528Kubernetes\u7ba1\u7406\u4e00\u4e2a\u591a\u8282\u70b9\u7684\u96c6\u7fa4\u4e2d\uff0c\u9664\u4e86\u9700\u8981\u5173\u6ce8\u96c6\u7fa4\u4e2d\u90e8\u7f72\u5e94\u7528\u7684\u8fd0\u884c\u72b6\u6001\u548c\u8282\u70b9\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u5e94\u8be5\u5173\u6ce8Kubernetes\u672c\u8eab\u7684\u72b6\u6001\u3002Kubernetes\u4f5c\u4e3a\u4e00\u4e2a\u4e2d\u592e\u5316\u7684\u4efb\u52a1\u8c03\u5ea6\u7cfb\u7edf\uff0c\u6211\u4eec\u5e0c\u671b\u5b83\u80fd\u591f\u76f8\u5bf9\u8f83\u5feb\u7684\u5b8c\u6210\u5bf9\u7528\u6237\u64cd\u4f5c\u7684\u54cd\u5e94\u3002\u5728\u8fd9\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5229\u7528Prometheus\u76d1\u63a7Kubernetes API\u7684\u54cd\u5e94\u65f6\u95f4\uff0c\u4ece\u800c\u8bc4\u4f30\u5f53\u524d\u96c6\u7fa4\u7684\u8fd0\u884c\u72b6\u6001\u4ee5\u53ca\u6027\u80fd\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-k8s-cluster-state/#prometheusapi-server","title":"\u4f7f\u7528Prometheus\u91c7\u96c6API Server\u76d1\u63a7\u6570\u636e","text":"<p>\u5728Kubernetes\u96c6\u7fa4\u4e2d\u547d\u540d\u7a7a\u95f4default\u4e2d\u4f1a\u5305\u542b\u4e00\u4e2a\u540d\u4e3akubernetes\u7684\u9ed8\u8ba4Service:</p> <pre><code>$ kubectl get svc kubernetes\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   133d\n</code></pre> <p>\u8be5Service\u5b9e\u9645\u6307\u5411\u7684\u662fKubernetes\u7ec4\u4ef6apiserver\u63d0\u4f9b\u7684\u670d\u52a1\uff1a</p> <pre><code>$ kubectl get endpoints kubernetes\nNAME         ENDPOINTS        AGE\nkubernetes   10.0.2.15:8443   133d\n</code></pre> <p>Apiserver\u7ec4\u4ef6\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u56e0\u6b64\u53ea\u8981\u901a\u8fc7CA\u8bc1\u4e66\u548c\u4ee4\u724c\u8bbf\u95eehttps://kubernetes.default.svc:443/metrics\u5373\u53ef\u83b7\u53d6apiserver\u7ec4\u4ef6\u4e2d\u8bb0\u5f55\u7684\u6240\u6709\u76d1\u63a7\u6837\u6570\u636e\u3002</p> <p>\u4e86\u89e3\u4ee5\u4e0a\u57fa\u7840\u77e5\u8bc6\u4ee5\u540e\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u5e94\u4fee\u6539Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002\u4fee\u6539prometheus-config.yml\u6587\u4ef6\uff0c\u4e3aPometheus\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code> - job_name: 'kubernetes-apiservers'\n   kubernetes_sd_configs:\n   - role: endpoints\n   scheme: https\n   tls_config:\n     ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n   bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n   relabel_configs:\n   - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n     action: keep\n     regex: default;kubernetes;https\n   - target_label: __address__\n     replacement: kubernetes.default.svc:443\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1kubernetes-apiservers\uff0c\u8be5\u4efb\u52a1\u57fa\u4e8eendpoints\u6a21\u5f0f\u83b7\u53d6\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709endpoints\uff0c\u5e76\u4e14\u53ea\u4fdd\u7559default\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u670d\u52a1\u540d\u79f0\u4e3akubernetes\u7684\u5b9e\u4f8b\u4f5c\u4e3a\u76d1\u63a7\u5bf9\u8c61\u3002 \u7531\u4e8e\u57fa\u4e8eServiceAccount\u63d0\u4f9b\u7684CA\u8bc1\u4e66\u4e2d\uff0c\u5e76\u4e0d\u5305\u542bEndpoint\u7684\u5730\u5740\uff0c\u56e0\u6b64\u8fd9\u91cc\u8fd8\u9700\u8981\u5c06\u9ed8\u8ba4\u7684<code>__address__</code>\u66ff\u6362\u4e3a\u96c6\u7fa4\u5185\u7684DNS\u5730\u5740kubernetes.default.svc\u3002</p> <p>\u57fa\u4e8e\u4ee5\u4e0a\u670d\u52a1\u53d1\u73b0\u4ee5\u53carelabel\u7684\u8fc7\u7a0b\u540e\uff0cPrometheus\u5c31\u80fd\u591f\u6b63\u5e38\u7684\u4eceapiserver\u4e2d\u8fc7\u53bb\u76d1\u63a7\u6837\u672c\u6570\u636e\uff1a</p> <p></p>"},{"location":"kubernetes/use-prometheus-monitor-k8s-cluster-state/#kubernetes","title":"\u8bc4\u4f30Kubernetes\u6027\u80fd","text":"<p>\u5f53Prometheus\u80fd\u591f\u4eceKubernetes\u7684APIServer\u4e2d\u83b7\u53d6\u76d1\u63a7\u6837\u672c\u6570\u636e\u540e\uff0c\u5c31\u53ef\u4ee5\u5bf9\u5f53\u524dKubernetes\u96c6\u7fa4\u7684\u6027\u80fd\u505a\u51fa\u8bc4\u4f30\u3002\u65e0\u8bba\u662fKubernetes\u7684\u81ea\u8eab\u7ec4\u4ef6\u8fd8\u662f\u5ba2\u6237\u7aef\u8bf7\u6c42\u90fd\u9700\u8981\u7ecf\u8fc7Kubernetes\u7684apiserver\uff0c\u56e0\u6b64\u5728\u8bc4\u4f30Kubernetes\u6027\u80fd\u65f6\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u5173\u6ce8Kubernetes\u7684API\u54cd\u5e94\u65f6\u95f4\u3002\u5bf9\u4e8ePod\u542f\u52a8\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u6307\u6807kubelet_pod_start_latency_microseconds\u83b7\u53d6\u3002</p> <p>\u4f8b\u5982\uff0c\u901a\u8fc7\u4ee5\u4e0bPromQL\u83b7\u53d6\u5f53\u524d\u96c6\u7fa499%\u7684Pod\u542f\u52a8\u65f6\u95f4\u5927\u81f4\u572818.40s\u4ee5\u5185\uff1a</p> <pre><code>kubelet_pod_start_latency_microseconds{quantile=\"0.99\"}\n</code></pre> <p></p> <p>Pod\u5e73\u5747\u542f\u52a8\u65f6\u95f4\u5927\u81f4\u4e3a42s\u5de6\u53f3\uff08\u5305\u542b\u955c\u50cf\u4e0b\u8f7d\u65f6\u95f4\uff09\uff1a</p> <pre><code>kubelet_pod_start_latency_microseconds_sum / kubelet_pod_start_latency_microseconds_count\n</code></pre> <p></p> <p>\u5176\u6b21\uff0c\u5bf9\u4e8e\u7528\u6237\u800c\u8a00\uff0c\u4ed6\u4eec\u66f4\u5173\u6ce8\u901a\u8fc7\u5bb9\u5668\u542f\u52a8\u670d\u52a1\u6240\u9700\u7684\u65f6\u95f4\uff0c\u56e0\u6b64\uff0c\u7b2c\u4e8c\u4e2a\u5173\u952e\u6307\u6807\u5373Pod\u7684\u542f\u52a8\u65f6\u95f4\u3002\u6307\u6807apiserver_request_latencies_summary\u548capiserver_request_latencies_bucket\u5747\u53ef\u7528\u4e8e\u7edf\u8ba1\u4ee5\u4e0b\u5404\u79cd\u7c7b\u578bAPI\u54cd\u5e94\u65f6\u95f4\u7684\u5206\u5e03\u60c5\u51b5\uff1a</p> Action Resources PUT Pods, Nodes, Deployments, DaemonSets\u7b49 POST Pods, Nodes, Deployments, DaemonSets\u7b49 LIST Pods, Nodes, Deployments, DaemonSets\u7b49 GET Pods, Nodes, Deployments, DaemonSets\u7b49"},{"location":"kubernetes/use-prometheus-monitor-k8s-svc-and-ingress-state/","title":"\u76d1\u63a7Service\u548cIngress\u53ef\u7528\u6027","text":"<p>\u5728\u7b2c4\u7ae0\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5982\u4f55\u57fa\u4e8eBlackbox Exporter\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7\uff0c\u9ed1\u76d2\u76d1\u63a7\u4fa7\u91cd\u4e8e\u4ece\u7528\u6237\u89d2\u5ea6\u6765\u6d4b\u8bd5\u670d\u52a1\u7684\u53ef\u7528\u6027\u3002\u5f53\u7528\u6237\u5728Kubernetes\u4e2d\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u4e3a\u4e86\u80fd\u8ba9\u7a0b\u5e8f\u4e4b\u95f4\u80fd\u591f\u76f8\u4e92\u8bbf\u95ee\uff0c\u9700\u8981\u4f7f\u7528\u5230Service\u3002\u800c\u5982\u679c\uff0c\u9700\u8981\u8ba9Kubernetes\u96c6\u7fa4\u5916\u7684\u7528\u6237\u80fd\u591f\u8bbf\u95ee\u8bbf\u95ee\u96c6\u7fa4\u5185\u7684\u5e94\u7528\uff0c\u5219\u9700\u8981\u4f7f\u7528\u5230Ingress\u3002</p> <p>Ingress\u548cService\u5747\u626e\u6f14\u4e86\u8d1f\u8f7d\u5747\u8861\u7684\u89d2\u8272\uff0c\u901a\u8fc7\u7f51\u7edc\u63a2\u9488\u5bf9Ingress\u548cService\u5bf9\u5e94\u7684\u670d\u52a1\u8fdb\u884c\u76d1\u63a7\uff0c\u80fd\u591f\u5feb\u901f\u5224\u65ad\u5f53\u524d\u670d\u52a1\u7684\u53ef\u7528\u6027\uff0c\u5e76\u4e14\u5728\u53d1\u751f\u6545\u969c\u65f6\u80fd\u591f\u5373\u4f7f\u7684\u505a\u51fa\u54cd\u5e94\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-k8s-svc-and-ingress-state/#kubernetesblackbox-exporter","title":"\u5728Kubernetes\u4e0b\u90e8\u7f72Blackbox Exporter","text":"<p>\u5982\u4e0b\u6240\u793a\uff0c\u901a\u8fc7Deployment\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5355\u5b9e\u4f8b\u7684Blackbox-exporter\u5b9e\u4f8b\uff0c\u5e76\u4e14\u4e3a\u5176\u5b9a\u4e49\u4e86\u76f8\u5e94\u7684Service\u3002\u901a\u8fc7Service\u66b4\u9732\u7684DNS\u5730\u5740\uff0c\u96c6\u7fa4\u5185\u7684Prometheus\u80fd\u591f\u975e\u5e38\u7b80\u5355\u7684\u901a\u8fc7\u57df\u540d\uff1ablackbox-exporter.default.svc.cluster.local\u8bbf\u95ee\u5230Blackbox\u7684\u5b9e\u4f8b\uff1a</p> <pre><code>\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: blackbox-exporter\n  name: blackbox-exporter\nspec:\n  ports:\n  - name: blackbox\n    port: 9115\n    protocol: TCP\n  selector:\n    app: blackbox-exporter\n  type: ClusterIP\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: blackbox-exporter\n  name: blackbox-exporter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: blackbox-exporter\n  template:\n    metadata:\n      labels:\n        app: blackbox-exporter\n    spec:\n      containers:\n      - image: prom/blackbox-exporter\n        name: blackbox-exporter\n</code></pre> <p>\u901a\u8fc7kubectl\u547d\u4ee4\uff0c\u53ef\u4ee5\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72Blackbox Exporter\u5b9e\u4f8b:</p> <pre><code>kubectl create -f blackbox-exporter-deployment.yml\n</code></pre> <p>\u5982\u4e0b\u6240\u793a\uff0c\u5728\u955c\u50cfprom/blackbox-exporter\u4e2d\u5305\u542b\u4e86\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u51e0\u4e2a\u5e38\u7528\u7684\u63a2\u9488\u914d\u7f6e\uff1a</p> <pre><code>modules:\n  http_2xx:\n    prober: http\n    http:\n  http_post_2xx:\n    prober: http\n    http:\n      method: POST\n  tcp_connect:\n    prober: tcp\n  pop3s_banner:\n    prober: tcp\n    tcp:\n      query_response:\n      - expect: \"^+OK\"\n      tls: true\n      tls_config:\n        insecure_skip_verify: false\n  ssh_banner:\n    prober: tcp\n    tcp:\n      query_response:\n      - expect: \"^SSH-2.0-\"\n  irc_banner:\n    prober: tcp\n    tcp:\n      query_response:\n      - send: \"NICK prober\"\n      - send: \"USER prober prober prober :prober\"\n      - expect: \"PING :([^ ]+)\"\n        send: \"PONG ${1}\"\n      - expect: \"^:[^ ]+ 001\"\n  icmp:\n    prober: icmp\n</code></pre>"},{"location":"kubernetes/use-prometheus-monitor-k8s-svc-and-ingress-state/#service","title":"\u63a2\u6d4bService\u53ef\u7528\u6027","text":"<pre><code>   - job_name: 'kubernetes-services'\n      metrics_path: /probe\n      params:\n        module: [http_2xx]\n      kubernetes_sd_configs:\n      - role: service\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n      - source_labels: [__address__]\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.default.svc.cluster.local:9115\n      - source_labels: [__param_target]\n        target_label: instance\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        target_label: kubernetes_name\n</code></pre>"},{"location":"kubernetes/use-prometheus-monitor-k8s-svc-and-ingress-state/#ingress","title":"\u63a2\u6d4bIngress\u53ef\u7528\u6027","text":"<pre><code>    - job_name: 'kubernetes-ingresses'\n      metrics_path: /probe\n      params:\n        module: [http_2xx]\n      kubernetes_sd_configs:\n      - role: ingress\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]\n        regex: (.+);(.+);(.+)\n        replacement: ${1}://${2}${3}\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.default.svc.cluster.local:9115\n      - source_labels: [__param_target]\n        target_label: instance\n      - action: labelmap\n        regex: __meta_kubernetes_ingress_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_ingress_name]\n        target_label: kubernetes_name\n</code></pre>"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/","title":"\u4f7f\u7528Prometheus\u76d1\u63a7Kubernetes\u96c6\u7fa4","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u5728Kubernetes\u4e0b\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u5e76\u4e14\u901a\u8fc7kubernetes_sd_config\u5b9e\u73b0\u4e86\u5bf9Kubernetes\u4e0b\u5404\u7c7b\u8d44\u6e90\u7684\u81ea\u52a8\u53d1\u73b0\u3002\u5728\u672c\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5e26\u9886\u8bfb\u8005\u5229\u7528Promethues\u63d0\u4f9b\u7684\u670d\u52a1\u53d1\u73b0\u80fd\u529b\uff0c\u5b9e\u73b0\u5bf9Kubernetes\u96c6\u7fa4\u4ee5\u53ca\u5176\u4e2d\u90e8\u7f72\u7684\u5404\u7c7b\u8d44\u6e90\u7684\u81ea\u52a8\u5316\u76d1\u63a7\u3002</p> <p>\u4e0b\u8868\u4e2d\uff0c\u68b3\u7406\u4e86\u76d1\u63a7Kubernetes\u96c6\u7fa4\u76d1\u63a7\u7684\u5404\u4e2a\u7ef4\u5ea6\u4ee5\u53ca\u7b56\u7565\uff1a</p> \u76ee\u6807 \u670d\u52a1\u53d1\u73b0\u6a21\u5f0f \u76d1\u63a7\u65b9\u6cd5 \u6570\u636e\u6e90 \u4ece\u96c6\u7fa4\u5404\u8282\u70b9kubelet\u7ec4\u4ef6\u4e2d\u83b7\u53d6\u8282\u70b9kubelet\u7684\u57fa\u672c\u8fd0\u884c\u72b6\u6001\u7684\u76d1\u63a7\u6307\u6807 node \u767d\u76d2\u76d1\u63a7 kubelet \u4ece\u96c6\u7fa4\u5404\u8282\u70b9kubelet\u5185\u7f6e\u7684cAdvisor\u4e2d\u83b7\u53d6\uff0c\u8282\u70b9\u4e2d\u8fd0\u884c\u7684\u5bb9\u5668\u7684\u76d1\u63a7\u6307\u6807 node \u767d\u76d2\u76d1\u63a7 kubelet \u4ece\u90e8\u7f72\u5230\u5404\u4e2a\u8282\u70b9\u7684Node Exporter\u4e2d\u91c7\u96c6\u4e3b\u673a\u8d44\u6e90\u76f8\u5173\u7684\u8fd0\u884c\u8d44\u6e90 node \u767d\u76d2\u76d1\u63a7 node exporter \u5bf9\u4e8e\u5185\u7f6e\u4e86Prometheus\u652f\u6301\u7684\u5e94\u7528\uff0c\u9700\u8981\u4ecePod\u5b9e\u4f8b\u4e2d\u91c7\u96c6\u5176\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807 pod \u767d\u76d2\u76d1\u63a7 custom pod \u83b7\u53d6API Server\u7ec4\u4ef6\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u5e76\u4ece\u4e2d\u83b7\u53d6Kubernetes\u96c6\u7fa4\u76f8\u5173\u7684\u8fd0\u884c\u76d1\u63a7\u6307\u6807 endpoints \u767d\u76d2\u76d1\u63a7 api server \u83b7\u53d6\u96c6\u7fa4\u4e2dService\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u5e76\u901a\u8fc7Blackbox Exporter\u83b7\u53d6\u7f51\u7edc\u63a2\u6d4b\u6307\u6807 service \u9ed1\u76d2\u76d1\u63a7 blackbox exporter \u83b7\u53d6\u96c6\u7fa4\u4e2dIngress\u7684\u8bbf\u95ee\u4fe1\u606f\uff0c\u5e76\u901a\u8fc7Blackbox Exporter\u83b7\u53d6\u7f51\u7edc\u63a2\u6d4b\u6307\u6807 ingress \u9ed1\u76d2\u76d1\u63a7 blackbox exporter"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/#kubelet","title":"\u4eceKubelet\u83b7\u53d6\u8282\u70b9\u8fd0\u884c\u72b6\u6001","text":"<p>Kubelet\u7ec4\u4ef6\u8fd0\u884c\u5728Kubernetes\u96c6\u7fa4\u7684\u5404\u4e2a\u8282\u70b9\u4e2d\uff0c\u5176\u8d1f\u8d23\u7ef4\u62a4\u548c\u7ba1\u7406\u8282\u70b9\u4e0aPod\u7684\u8fd0\u884c\u72b6\u6001\u3002kubelet\u7ec4\u4ef6\u7684\u6b63\u5e38\u8fd0\u884c\u76f4\u63a5\u5173\u7cfb\u5230\u8be5\u8282\u70b9\u662f\u5426\u80fd\u591f\u6b63\u5e38\u7684\u88abKubernetes\u96c6\u7fa4\u6b63\u5e38\u4f7f\u7528\u3002</p> <p>\u57fa\u4e8eNode\u6a21\u5f0f\uff0cPrometheus\u4f1a\u81ea\u52a8\u53d1\u73b0Kubernetes\u4e2d\u6240\u6709Node\u8282\u70b9\u7684\u4fe1\u606f\u5e76\u4f5c\u4e3a\u76d1\u63a7\u7684\u76ee\u6807Target\u3002 \u800c\u8fd9\u4e9bTarget\u7684\u8bbf\u95ee\u5730\u5740\u5b9e\u9645\u4e0a\u5c31\u662fKubelet\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u5e76\u4e14Kubelet\u5b9e\u9645\u4e0a\u76f4\u63a5\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u652f\u6301\u3002</p> <p>\u4fee\u6539prometheus.yml\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u91c7\u96c6\u4efb\u52a1\u914d\u7f6e\uff1a</p> <pre><code>  - job_name: 'kubernetes-kubelet'\n    scheme: https\n    tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    kubernetes_sd_configs:\n    - role: node\n    relabel_configs:\n    - action: labelmap\n      regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528Node\u6a21\u5f0f\u81ea\u52a8\u53d1\u73b0\u96c6\u7fa4\u4e2d\u6240\u6709Kubelet\u4f5c\u4e3a\u76d1\u63a7\u7684\u6570\u636e\u91c7\u96c6\u76ee\u6807\uff0c\u540c\u65f6\u901a\u8fc7labelmap\u6b65\u9aa4\uff0c\u5c06Node\u8282\u70b9\u4e0a\u7684\u6807\u7b7e\uff0c\u4f5c\u4e3a\u6837\u672c\u7684\u6807\u7b7e\u4fdd\u5b58\u5230\u65f6\u95f4\u5e8f\u5217\u5f53\u4e2d\u3002</p> <p>\u91cd\u65b0\u52a0\u8f7dpromethues\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u91cd\u5efaPrometheus\u7684Pod\u5b9e\u4f8b\u540e\uff0c\u67e5\u770bkubernetes-kubelet\u4efb\u52a1\u91c7\u96c6\u72b6\u6001\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4ee5\u4e0b\u9519\u8bef\u63d0\u793a\u4fe1\u606f\uff1a</p> <pre><code>Get https://192.168.99.100:10250/metrics: x509: cannot validate certificate for 192.168.99.100 because it doesn't contain any IP SANs\n</code></pre> <p>\u8fd9\u662f\u7531\u4e8e\u5f53\u524d\u4f7f\u7528\u7684ca\u8bc1\u4e66\u4e2d\uff0c\u5e76\u4e0d\u5305\u542b192.168.99.100\u7684\u5730\u5740\u4fe1\u606f\u3002\u4e3a\u4e86\u89e3\u51b3\u8be5\u95ee\u9898\uff0c\u7b2c\u4e00\u79cd\u65b9\u6cd5\u662f\u76f4\u63a5\u8df3\u8fc7ca\u8bc1\u4e66\u6821\u9a8c\u8fc7\u7a0b\uff0c\u901a\u8fc7\u5728tls_config\u4e2d\u8bbe\u7f6e insecure_skip_verify\u4e3atrue\u5373\u53ef\u3002 \u8fd9\u6837Prometheus\u5728\u91c7\u96c6\u6837\u672c\u6570\u636e\u65f6\uff0c\u5c06\u4f1a\u81ea\u52a8\u8df3\u8fc7ca\u8bc1\u4e66\u7684\u6821\u9a8c\u8fc7\u7a0b\uff0c\u4ece\u800c\u4ecekubelet\u91c7\u96c6\u5230\u76d1\u63a7\u6570\u636e\uff1a</p> <pre><code>  - job_name: 'kubernetes-kubelet'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p></p> <p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u4e0d\u76f4\u63a5\u901a\u8fc7kubelet\u7684metrics\u670d\u52a1\u91c7\u96c6\u76d1\u63a7\u6570\u636e\uff0c\u800c\u901a\u8fc7Kubernetes\u7684api-server\u63d0\u4f9b\u7684\u4ee3\u7406API\u8bbf\u95ee\u5404\u4e2a\u8282\u70b9\u4e2dkubelet\u7684metrics\u670d\u52a1\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>  - job_name: 'kubernetes-kubelet'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics\n</code></pre> <p>\u901a\u8fc7relabeling\uff0c\u5c06\u4eceKubernetes\u83b7\u53d6\u5230\u7684\u9ed8\u8ba4\u5730\u5740<code>__address__</code>\u66ff\u6362\u4e3akubernetes.default.svc:443\u3002\u540c\u65f6\u5c06<code>__metrics_path__</code>\u66ff\u6362\u4e3aapi-server\u7684\u4ee3\u7406\u5730\u5740/api/v1/nodes/${1}/proxy/metrics\u3002</p> <p></p> <p>\u901a\u8fc7\u83b7\u53d6\u5404\u4e2a\u8282\u70b9\u4e2dkubelet\u7684\u76d1\u63a7\u6307\u6807\uff0c\u7528\u6237\u53ef\u4ee5\u8bc4\u4f30\u96c6\u7fa4\u4e2d\u5404\u8282\u70b9\u7684\u6027\u80fd\u8868\u73b0\u3002\u4f8b\u5982,\u901a\u8fc7\u6307\u6807kubelet_pod_start_latency_microseconds\u53ef\u4ee5\u83b7\u5f97\u5f53\u524d\u8282\u70b9\u4e2dPod\u542f\u52a8\u65f6\u95f4\u76f8\u5173\u7684\u7edf\u8ba1\u6570\u636e\u3002</p> <pre><code>kubelet_pod_start_latency_microseconds{quantile=\"0.99\"}\n</code></pre> <p></p> <p>Pod\u5e73\u5747\u542f\u52a8\u65f6\u95f4\u5927\u81f4\u4e3a42s\u5de6\u53f3\uff08\u5305\u542b\u955c\u50cf\u4e0b\u8f7d\u65f6\u95f4\uff09\uff1a</p> <pre><code>kubelet_pod_start_latency_microseconds_sum / kubelet_pod_start_latency_microseconds_count\n</code></pre> <p></p> <p>\u9664\u6b64\u4ee5\u5916\uff0c\u76d1\u63a7\u6307\u6807kubelet_docker_*\u8fd8\u53ef\u4ee5\u4f53\u73b0\u51fakubelet\u4e0e\u5f53\u524d\u8282\u70b9\u7684docker\u670d\u52a1\u7684\u8c03\u7528\u60c5\u51b5\uff0c\u4ece\u800c\u53ef\u4ee5\u53cd\u6620\u51fadocker\u672c\u8eab\u662f\u5426\u4f1a\u5f71\u54cdkubelet\u7684\u6027\u80fd\u8868\u73b0\u7b49\u95ee\u9898\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/#kubelet_1","title":"\u4eceKubelet\u83b7\u53d6\u8282\u70b9\u5bb9\u5668\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5","text":"<p>\u5404\u8282\u70b9\u7684kubelet\u7ec4\u4ef6\u4e2d\u9664\u4e86\u5305\u542b\u81ea\u8eab\u7684\u76d1\u63a7\u6307\u6807\u4fe1\u606f\u4ee5\u5916\uff0ckubelet\u7ec4\u4ef6\u8fd8\u5185\u7f6e\u4e86\u5bf9cAdvisor\u7684\u652f\u6301\u3002cAdvisor\u80fd\u591f\u83b7\u53d6\u5f53\u524d\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u6240\u6709\u5bb9\u5668\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff0c\u901a\u8fc7\u8bbf\u95eekubelet\u7684/metrics/cadvisor\u5730\u5740\u53ef\u4ee5\u83b7\u53d6\u5230cadvisor\u7684\u76d1\u63a7\u6307\u6807\uff0c\u56e0\u6b64\u548c\u83b7\u53d6kubelet\u76d1\u63a7\u6307\u6807\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u540c\u6837\u901a\u8fc7node\u6a21\u5f0f\u81ea\u52a8\u53d1\u73b0\u6240\u6709\u7684kubelet\u4fe1\u606f\uff0c\u5e76\u901a\u8fc7\u9002\u5f53\u7684relabel\u8fc7\u7a0b\uff0c\u4fee\u6539\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\u7684\u914d\u7f6e\u3002 \u4e0e\u91c7\u96c6kubelet\u81ea\u8eab\u76d1\u63a7\u6307\u6807\u76f8\u4f3c\uff0c\u8fd9\u91cc\u4e5f\u6709\u4e24\u79cd\u65b9\u5f0f\u91c7\u96c6cadvisor\u4e2d\u7684\u76d1\u63a7\u6307\u6807\uff1a</p> <p>\u65b9\u5f0f\u4e00\uff1a\u76f4\u63a5\u8bbf\u95eekubelet\u7684/metrics/cadvisor\u5730\u5740\uff0c\u9700\u8981\u8df3\u8fc7ca\u8bc1\u4e66\u8ba4\u8bc1\uff1a</p> <pre><code>    - job_name: 'kubernetes-cadvisor'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: metrics/cadvisor\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p></p> <p>\u65b9\u5f0f\u4e8c\uff1a\u901a\u8fc7api-server\u63d0\u4f9b\u7684\u4ee3\u7406\u5730\u5740\u8bbf\u95eekubelet\u7684/metrics/cadvisor\u5730\u5740\uff1a</p> <pre><code>    - job_name: 'kubernetes-cadvisor'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p></p>"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/#nodeexporter","title":"\u4f7f\u7528NodeExporter\u76d1\u63a7\u96c6\u7fa4\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5","text":"<p>\u4e3a\u4e86\u80fd\u591f\u91c7\u96c6\u96c6\u7fa4\u4e2d\u5404\u4e2a\u8282\u70b9\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u5728\u5404\u8282\u70b9\u4e2d\u90e8\u7f72\u4e00\u4e2aNode Exporter\u5b9e\u4f8b\u3002\u5728\u672c\u7ae0\u7684\u201c\u90e8\u7f72Prometheus\u201d\u5c0f\u8282\uff0c\u6211\u4eec\u4f7f\u7528\u4e86Kubernetes\u5185\u7f6e\u7684\u63a7\u5236\u5668\u4e4b\u4e00Deployment\u3002Deployment\u80fd\u591f\u786e\u4fddPrometheus\u7684Pod\u80fd\u591f\u6309\u7167\u9884\u671f\u7684\u72b6\u6001\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u800cPod\u5b9e\u4f8b\u53ef\u80fd\u968f\u673a\u8fd0\u884c\u5728\u4efb\u610f\u8282\u70b9\u4e0a\u3002\u800c\u4e0ePrometheus\u7684\u90e8\u7f72\u4e0d\u540c\u7684\u662f\uff0c\u5bf9\u4e8eNode Exporter\u800c\u8a00\u6bcf\u4e2a\u8282\u70b9\u53ea\u9700\u8981\u8fd0\u884c\u4e00\u4e2a\u552f\u4e00\u7684\u5b9e\u4f8b\uff0c\u6b64\u65f6\uff0c\u5c31\u9700\u8981\u4f7f\u7528Kubernetes\u7684\u53e6\u5916\u4e00\u79cd\u63a7\u5236\u5668Daemonset\u3002\u987e\u540d\u601d\u4e49\uff0cDaemonset\u7684\u7ba1\u7406\u65b9\u5f0f\u7c7b\u4f3c\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u5b88\u62a4\u8fdb\u7a0b\u3002Daemonset\u4f1a\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u6240\u6709\uff08\u4e5f\u53ef\u4ee5\u6307\u5b9a\uff09\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u552f\u4e00\u7684Pod\u5b9e\u4f8b\u3002</p> <p>\u521b\u5efanode-exporter-daemonset.yml\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\nspec:\n  template:\n    metadata:\n      annotations:\n        prometheus.io/scrape: 'true'\n        prometheus.io/port: '9100'\n        prometheus.io/path: 'metrics'\n      labels:\n        app: node-exporter\n      name: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        imagePullPolicy: IfNotPresent\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          hostPort: 9100\n          name: scrape\n      hostNetwork: true\n      hostPID: true\n</code></pre> <p>\u7531\u4e8eNode Exporter\u9700\u8981\u80fd\u591f\u8bbf\u95ee\u5bbf\u4e3b\u673a\uff0c\u56e0\u6b64\u8fd9\u91cc\u6307\u5b9a\u4e86hostNetwork\u548chostPID\uff0c\u8ba9Pod\u5b9e\u4f8b\u80fd\u591f\u4ee5\u4e3b\u673a\u7f51\u7edc\u4ee5\u53ca\u7cfb\u7edf\u8fdb\u7a0b\u7684\u5f62\u5f0f\u8fd0\u884c\u3002\u540c\u65f6YAML\u6587\u4ef6\u4e2d\u4e5f\u521b\u5efa\u4e86NodeExporter\u76f8\u5e94\u7684Service\u3002\u8fd9\u6837\u901a\u8fc7Service\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u5bf9\u5e94\u7684NodeExporter\u5b9e\u4f8b\u3002</p> <pre><code>$ kubectl create -f node-exporter-daemonset.yml\nservice \"node-exporter\" created\ndaemonset \"node-exporter\" created\n</code></pre> <p>\u67e5\u770bDaemonset\u4ee5\u53caPod\u7684\u8fd0\u884c\u72b6\u6001</p> <pre><code>$ kubectl get daemonsets\nNAME            DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nnode-exporter   1         1         1         1            1           &lt;none&gt;          15s\n\n$ kubectl get pods\nNAME                               READY     STATUS    RESTARTS   AGE\n...\nnode-exporter-9h56z                1/1       Running   0          51s\n</code></pre> <p>\u7531\u4e8eNode Exporter\u662f\u4ee5\u4e3b\u673a\u7f51\u7edc\u7684\u5f62\u5f0f\u8fd0\u884c\uff0c\u56e0\u6b64\u76f4\u63a5\u8bbf\u95eeMiniKube\u7684\u865a\u62df\u673aIP\u52a0\u4e0aPod\u7684\u7aef\u53e3\u5373\u53ef\u8bbf\u95ee\u5f53\u524d\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Node Exporter\u5b9e\u4f8b:</p> <pre><code>$ minikube ip\n192.168.99.100\n\n$ curl http://192.168.99.100:9100/metrics\n...\nprocess_start_time_seconds 1.5251401593e+09\n# HELP process_virtual_memory_bytes Virtual memory size in bytes.\n# TYPE process_virtual_memory_bytes gauge\nprocess_virtual_memory_bytes 1.1984896e+08\n</code></pre> <p>\u76ee\u524d\u4e3a\u6b62\uff0c\u901a\u8fc7Daemonset\u7684\u5f62\u5f0f\u5c06Node Exporter\u90e8\u7f72\u5230\u4e86\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a\u8282\u70b9\u4e2d\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7Prometheus\u7684pod\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u627e\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684Node Exporter\u5b9e\u4f8b\u5373\u53ef\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8eKubernetes\u4e2d\u5e76\u975e\u6240\u6709\u7684Pod\u90fd\u63d0\u4f9b\u4e86\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u6709\u4e9b\u53ef\u80fd\u53ea\u662f\u4e00\u4e9b\u7b80\u5355\u7684\u7528\u6237\u5e94\u7528\uff0c\u4e3a\u4e86\u533a\u5206\u54ea\u4e9bPod\u5b9e\u4f8b\u662f\u53ef\u4ee5\u4f9bPrometheus\u8fdb\u884c\u91c7\u96c6\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u4e3aNode Exporter\u6dfb\u52a0\u4e86\u6ce8\u89e3\uff1a</p> <pre><code>prometheus.io/scrape: 'true'\n</code></pre> <p>\u7531\u4e8eKubernetes\u4e2dPod\u53ef\u80fd\u4f1a\u5305\u542b\u591a\u4e2a\u5bb9\u5668\uff0c\u8fd8\u9700\u8981\u7528\u6237\u901a\u8fc7\u6ce8\u89e3\u6307\u5b9a\u7528\u6237\u63d0\u4f9b\u76d1\u63a7\u6307\u6807\u7684\u91c7\u96c6\u7aef\u53e3\uff1a</p> <pre><code>prometheus.io/port: '9100'\n</code></pre> <p>\u800c\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0cPod\u4e2d\u7684\u5bb9\u5668\u53ef\u80fd\u5e76\u6ca1\u6709\u4f7f\u7528\u9ed8\u8ba4\u7684/metrics\u4f5c\u4e3a\u76d1\u63a7\u91c7\u96c6\u8def\u5f84\uff0c\u56e0\u6b64\u8fd8\u9700\u8981\u652f\u6301\u7528\u6237\u6307\u5b9a\u91c7\u96c6\u8def\u5f84\uff1a</p> <pre><code>prometheus.io/path: 'metrics'\n</code></pre> <p>\u4e3aPrometheus\u521b\u5efa\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1kubernetes-pods\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>  - job_name: 'kubernetes-pods'\n    kubernetes_sd_configs:\n    - role: pod\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n      action: keep\n      regex: true\n    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n      action: replace\n      target_label: __metrics_path__\n      regex: (.+)\n    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n      action: replace\n      regex: ([^:]+)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_label_(.+)\n    - source_labels: [__meta_kubernetes_namespace]\n      action: replace\n      target_label: kubernetes_namespace\n    - source_labels: [__meta_kubernetes_pod_name]\n      action: replace\n      target_label: kubernetes_pod_name\n</code></pre> <p></p> <p>\u901a\u8fc7\u4ee5\u4e0arelabel\u8fc7\u7a0b\u5b9e\u73b0\u5bf9Pod\u5b9e\u4f8b\u7684\u8fc7\u6ee4\uff0c\u4ee5\u53ca\u91c7\u96c6\u4efb\u52a1\u5730\u5740\u66ff\u6362\uff0c\u4ece\u800c\u5b9e\u73b0\u5bf9\u7279\u5b9aPod\u5b9e\u4f8b\u76d1\u63a7\u6307\u6807\u7684\u91c7\u96c6\u3002\u9700\u8981\u8bf4\u660e\u7684\u662fkubernetes-pods\u5e76\u4e0d\u662f\u53ea\u9488\u5bf9Node Exporter\u800c\u8a00\uff0c\u5bf9\u4e8e\u7528\u6237\u4efb\u610f\u90e8\u7f72\u7684Pod\u5b9e\u4f8b\uff0c\u53ea\u8981\u5176\u63d0\u4f9b\u4e86\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u7528\u6237\u90fd\u53ef\u4ee5\u901a\u8fc7\u4e3aPod\u6dfb\u52a0\u6ce8\u89e3\u7684\u5f62\u5f0f\u4e3a\u5176\u6dfb\u52a0\u76d1\u63a7\u6307\u6807\u91c7\u96c6\u7684\u652f\u6301\u3002</p>"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/#kube-apiserver","title":"\u4ecekube-apiserver\u83b7\u53d6\u96c6\u7fa4\u8fd0\u884c\u76d1\u63a7\u6307\u6807","text":"<p>\u5728\u5f00\u59cb\u6b63\u5f0f\u5185\u5bb9\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0bKubernetes\u4e2dService\u662f\u5982\u4f55\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u7684\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e00\u822c\u6765\u8bf4Service\u6709\u4e24\u4e2a\u4e3b\u8981\u7684\u4f7f\u7528\u573a\u666f\uff1a</p> <p></p> <ul> <li>\u4ee3\u7406\u5bf9\u96c6\u7fa4\u5185\u90e8\u5e94\u7528Pod\u5b9e\u4f8b\u7684\u8bf7\u6c42\uff1a\u5f53\u521b\u5efaService\u65f6\u5982\u679c\u6307\u5b9a\u4e86\u6807\u7b7e\u9009\u62e9\u5668\uff0cKubernetes\u4f1a\u76d1\u542c\u96c6\u7fa4\u4e2d\u6240\u6709\u7684Pod\u53d8\u5316\u60c5\u51b5\uff0c\u901a\u8fc7Endpoints\u81ea\u52a8\u7ef4\u62a4\u6ee1\u8db3\u6807\u7b7e\u9009\u62e9\u5668\u7684Pod\u5b9e\u4f8b\u7684\u8bbf\u95ee\u4fe1\u606f\uff1b</li> <li>\u4ee3\u7406\u5bf9\u96c6\u7fa4\u5916\u90e8\u670d\u52a1\u7684\u8bf7\u6c42\uff1a\u5f53\u521b\u5efaService\u65f6\u5982\u679c\u4e0d\u6307\u5b9a\u4efb\u4f55\u7684\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u6b64\u65f6\u9700\u8981\u7528\u6237\u624b\u52a8\u521b\u5efaService\u5bf9\u5e94\u7684Endpoint\u8d44\u6e90\u3002\u4f8b\u5982\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u4e3a\u4e86\u786e\u4fdd\u6570\u636e\u7684\u5b89\u5168\uff0c\u6211\u4eec\u901a\u5e38\u8bb2\u6570\u636e\u5e93\u670d\u52a1\u90e8\u7f72\u5230\u96c6\u7fa4\u5916\u3002 \u8fd9\u662f\u4e3a\u4e86\u907f\u514d\u96c6\u7fa4\u5185\u7684\u5e94\u7528\u786c\u7f16\u7801\u6570\u636e\u5e93\u7684\u8bbf\u95ee\u4fe1\u606f\uff0c\u8fd9\u662f\u5c31\u53ef\u4ee5\u901a\u8fc7\u5728\u96c6\u7fa4\u5185\u521b\u5efaService\uff0c\u5e76\u6307\u5411\u5916\u90e8\u7684\u6570\u636e\u5e93\u670d\u52a1\u5b9e\u4f8b\u3002</li> </ul> <p>kube-apiserver\u626e\u6f14\u4e86\u6574\u4e2aKubernetes\u96c6\u7fa4\u7ba1\u7406\u7684\u5165\u53e3\u7684\u89d2\u8272\uff0c\u8d1f\u8d23\u5bf9\u5916\u66b4\u9732Kubernetes API\u3002kube-apiserver\u7ec4\u4ef6\u4e00\u822c\u662f\u72ec\u7acb\u90e8\u7f72\u5728\u96c6\u7fa4\u5916\u7684\uff0c\u4e3a\u4e86\u80fd\u591f\u8ba9\u90e8\u7f72\u5728\u96c6\u7fa4\u5185\u7684\u5e94\u7528\uff08kubernetes\u63d2\u4ef6\u6216\u8005\u7528\u6237\u5e94\u7528\uff09\u80fd\u591f\u4e0ekube-apiserver\u4ea4\u4e92\uff0cKubernetes\u4f1a\u9ed8\u8ba4\u5728\u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3akubernetes\u7684\u670d\u52a1\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get svc kubernetes -o wide\nNAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE       SELECTOR\nkubernetes            ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          166d      &lt;none&gt;\n</code></pre> <p>\u800c\u8be5kubernetes\u670d\u52a1\u4ee3\u7406\u7684\u540e\u7aef\u5b9e\u9645\u5730\u5740\u901a\u8fc7endpoints\u8fdb\u884c\u7ef4\u62a4\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get endpoints kubernetes\nNAME         ENDPOINTS        AGE\nkubernetes   10.0.2.15:8443   166d\n</code></pre> <p>\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u96c6\u7fa4\u5185\u7684\u5e94\u7528\u6216\u8005\u7cfb\u7edf\u4e3b\u673a\u5c31\u53ef\u4ee5\u901a\u8fc7\u96c6\u7fa4\u5185\u90e8\u7684DNS\u57df\u540dkubernetes.default.svc\u8bbf\u95ee\u5230\u90e8\u7f72\u5916\u90e8\u7684kube-apiserver\u5b9e\u4f8b\u3002</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u76d1\u63a7kube-apiserver\u76f8\u5173\u7684\u6307\u6807\uff0c\u53ea\u9700\u8981\u901a\u8fc7endpoints\u8d44\u6e90\u627e\u5230kubernetes\u5bf9\u5e94\u7684\u6240\u6709\u540e\u7aef\u5730\u5740\u5373\u53ef\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u521b\u5efa\u76d1\u63a7\u4efb\u52a1kubernetes-apiservers\uff0c\u8fd9\u91cc\u6307\u5b9a\u4e86\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\u4e3aendpoints\u3002Prometheus\u4f1a\u67e5\u627e\u5f53\u524d\u96c6\u7fa4\u4e2d\u6240\u6709\u7684endpoints\u914d\u7f6e\uff0c\u5e76\u901a\u8fc7relabel\u8fdb\u884c\u5224\u65ad\u662f\u5426\u4e3aapiserver\u5bf9\u5e94\u7684\u8bbf\u95ee\u5730\u5740\uff1a</p> <pre><code>    - job_name: 'kubernetes-apiservers'\n      kubernetes_sd_configs:\n      - role: endpoints\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        action: keep\n        regex: default;kubernetes;https\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n</code></pre> <p>\u5728relabel_configs\u914d\u7f6e\u4e2d\u7b2c\u4e00\u6b65\u7528\u4e8e\u5224\u65ad\u5f53\u524dendpoints\u662f\u5426\u4e3akube-apiserver\u5bf9\u7528\u7684\u5730\u5740\u3002\u7b2c\u4e8c\u6b65\uff0c\u66ff\u6362\u76d1\u63a7\u91c7\u96c6\u5730\u5740\u5230kubernetes.default.svc:443\u5373\u53ef\u3002\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u91cd\u5efaPrometheus\u5b9e\u4f8b\uff0c\u5f97\u5230\u4ee5\u4e0b\u7ed3\u679c\u3002</p> <p></p>"},{"location":"kubernetes/use-prometheus-monitor-kubernetes/#ingressservice","title":"\u5bf9Ingress\u548cService\u8fdb\u884c\u7f51\u7edc\u63a2\u6d4b","text":"<p>\u4e3a\u4e86\u80fd\u591f\u5bf9Ingress\u548cService\u8fdb\u884c\u63a2\u6d4b\uff0c\u6211\u4eec\u9700\u8981\u5728\u96c6\u7fa4\u90e8\u7f72Blackbox Exporter\u5b9e\u4f8b\u3002 \u5982\u4e0b\u6240\u793a\uff0c\u521b\u5efablackbox-exporter.yaml\u7528\u4e8e\u63cf\u8ff0\u90e8\u7f72\u76f8\u5173\u7684\u5185\u5bb9:</p> <pre><code>\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: blackbox-exporter\n  name: blackbox-exporter\nspec:\n  ports:\n  - name: blackbox\n    port: 9115\n    protocol: TCP\n  selector:\n    app: blackbox-exporter\n  type: ClusterIP\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: blackbox-exporter\n  name: blackbox-exporter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: blackbox-exporter\n  template:\n    metadata:\n      labels:\n        app: blackbox-exporter\n    spec:\n      containers:\n      - image: prom/blackbox-exporter\n        imagePullPolicy: IfNotPresent\n        name: blackbox-exporter\n</code></pre> <p>\u901a\u8fc7kubectl\u547d\u4ee4\u90e8\u7f72Blackbox Exporter\u5b9e\u4f8b\uff0c\u8fd9\u91cc\u5c06\u90e8\u7f72\u4e00\u4e2aBlackbox Exporter\u7684Pod\u5b9e\u4f8b\uff0c\u540c\u65f6\u901a\u8fc7\u670d\u52a1blackbox-exporter\u5728\u96c6\u7fa4\u5185\u66b4\u9732\u8bbf\u95ee\u5730\u5740blackbox-exporter.default.svc.cluster.local\uff0c\u5bf9\u4e8e\u96c6\u7fa4\u5185\u7684\u4efb\u610f\u670d\u52a1\u90fd\u53ef\u4ee5\u901a\u8fc7\u8be5\u5185\u90e8DNS\u57df\u540d\u8bbf\u95eeBlackbox Exporter\u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl get pods\nNAME                                        READY     STATUS        RESTARTS   AGE\nblackbox-exporter-f77fc78b6-72bl5           1/1       Running       0          4s\n\n$ kubectl get svc\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nblackbox-exporter           ClusterIP   10.109.144.192   &lt;none&gt;        9115/TCP         3m\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u80fd\u591f\u81ea\u52a8\u7684\u5bf9Service\u8fdb\u884c\u63a2\u6d4b\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u81ea\u52a8\u627e\u5230\u6240\u6709\u7684Service\u4fe1\u606f\u3002 \u5982\u4e0b\u6240\u793a\uff0c\u5728Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u540d\u4e3akubernetes-services\u7684\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\uff1a</p> <pre><code>    - job_name: 'kubernetes-services'\n      metrics_path: /probe\n      params:\n        module: [http_2xx]\n      kubernetes_sd_configs:\n      - role: service\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n      - source_labels: [__address__]\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.default.svc.cluster.local:9115\n      - source_labels: [__param_target]\n        target_label: instance\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        target_label: kubernetes_name\n</code></pre> <p>\u5728\u8be5\u4efb\u52a1\u914d\u7f6e\u4e2d\uff0c\u901a\u8fc7\u6307\u5b9akubernetes_sd_config\u7684role\u4e3aservice\u6307\u5b9a\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff1a</p> <pre><code>  kubernetes_sd_configs:\n    - role: service\n</code></pre> <p>\u4e3a\u4e86\u533a\u5206\u96c6\u7fa4\u4e2d\u9700\u8981\u8fdb\u884c\u63a2\u6d4b\u7684Service\u5b9e\u4f8b\uff0c\u6211\u4eec\u901a\u8fc7\u6807\u7b7e\u2018prometheus.io/probe: true\u2019\u8fdb\u884c\u5224\u65ad\uff0c\u4ece\u800c\u8fc7\u6ee4\u51fa\u9700\u8981\u63a2\u6d4b\u7684\u6240\u6709Service\u5b9e\u4f8b\uff1a</p> <pre><code>      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n</code></pre> <p>\u5e76\u4e14\u5c06\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u83b7\u53d6\u5230\u7684Service\u5b9e\u4f8b\u5730\u5740<code>__address__</code>\u8f6c\u6362\u4e3a\u83b7\u53d6\u76d1\u63a7\u6570\u636e\u7684\u8bf7\u6c42\u53c2\u6570\u3002\u540c\u65f6\u5c06<code>__address</code>\u6267\u884cBlackbox Exporter\u5b9e\u4f8b\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u5e76\u4e14\u91cd\u5199\u4e86\u6807\u7b7einstance\u7684\u5185\u5bb9\uff1a</p> <pre><code>      - source_labels: [__address__]\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.default.svc.cluster.local:9115\n      - source_labels: [__param_target]\n        target_label: instance\n</code></pre> <p>\u6700\u540e\uff0c\u4e3a\u76d1\u63a7\u6837\u672c\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u6807\u7b7e\u4fe1\u606f\uff1a</p> <pre><code>      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        target_label: kubernetes_name\n</code></pre> <p>\u5bf9\u4e8eIngress\u800c\u8a00\uff0c\u4e5f\u662f\u4e00\u4e2a\u76f8\u5bf9\u7c7b\u4f3c\u7684\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u7ed9\u51fa\u5bf9Ingress\u63a2\u6d4b\u7684Prometheus\u4efb\u52a1\u914d\u7f6e\u4f5c\u4e3a\u53c2\u8003\uff1a</p> <pre><code>    - job_name: 'kubernetes-ingresses'\n      metrics_path: /probe\n      params:\n        module: [http_2xx]\n      kubernetes_sd_configs:\n      - role: ingress\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]\n        regex: (.+);(.+);(.+)\n        replacement: ${1}://${2}${3}\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.default.svc.cluster.local:9115\n      - source_labels: [__param_target]\n        target_label: instance\n      - action: labelmap\n        regex: __meta_kubernetes_ingress_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_ingress_name]\n        target_label: kubernetes_name\n</code></pre>"},{"location":"kubernetes/use-promethues-monitor-node-in-k8s/","title":"\u76d1\u63a7\u96c6\u7fa4\u57fa\u7840\u8bbe\u65bd","text":"<p>\u5728\u7b2c1\u7ae0\u7684\u201c\u521d\u59cbPrometheus\u201d\u5c0f\u8282\uff0c\u6211\u4eec\u5df2\u7ecf\u57fa\u672c\u4e86\u89e3\u548c\u4f7f\u7528\u8fc7Node Exporter\u3002Node Exporter\u80fd\u591f\u91c7\u96c6\u548c\u83b7\u53d6\u5f53\u524d\u6240\u5728\u4e3b\u673a\u7684\u8fd0\u884c\u72b6\u6001\u6570\u636e\u3002\u672c\u8282\u5c06\u5e26\u9886\u8bfb\u8005\u5728Kubernetes\u4e2d\u90e8\u7f72Node Exporter\uff0c\u5e76\u4e14\u901a\u8fc7Prometheus\u81ea\u52a8\u76d1\u63a7\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002</p>"},{"location":"kubernetes/use-promethues-monitor-node-in-k8s/#daemonsetnode-exporter","title":"\u4f7f\u7528Daemonset\u90e8\u7f72Node Exporter","text":"<p>\u5728\u672c\u7ae0\u7684\u201c\u90e8\u7f72Prometheus\u201d\u5c0f\u8282\uff0c\u6211\u4eec\u4f7f\u7528\u4e86Kubernetes\u5185\u7f6e\u7684\u63a7\u5236\u5668\u4e4b\u4e00Deployment\u3002Deployment\u80fd\u591f\u786e\u4fddPrometheus\u7684Pod\u80fd\u591f\u6309\u7167\u9884\u671f\u7684\u72b6\u6001\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u800cPod\u5b9e\u4f8b\u53ef\u80fd\u968f\u673a\u8fd0\u884c\u5728\u4efb\u610f\u8282\u70b9\u4e0a\u3002\u800c\u4e0ePrometheus\u7684\u90e8\u7f72\u4e0d\u540c\u7684\u662f\uff0c\u5bf9\u4e8eNode Exporter\u800c\u8a00\u6bcf\u4e2a\u8282\u70b9\u53ea\u8fd0\u884c\u4e00\u4e2a\u552f\u4e00\u7684\u5b9e\u4f8b\uff0c\u6b64\u65f6\uff0c\u5c31\u9700\u8981\u4f7f\u7528Kubernetes\u7684\u53e6\u5916\u4e00\u79cd\u63a7\u5236\u5668Daemonset\u3002\u987e\u540d\u601d\u4e49\uff0cDaemonset\u7684\u7ba1\u7406\u65b9\u5f0f\u7c7b\u4f3c\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u5b88\u62a4\u8fdb\u7a0b\u3002Daemonset\u4f1a\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u6240\u6709\uff08\u4e5f\u53ef\u4ee5\u6307\u5b9a\uff09\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u552f\u4e00\u7684Pod\u5b9e\u4f8b\u3002</p> <p>\u521b\u5efanode-exporter-daemonset.yml\u6587\u4ef6\uff0c\u5e76\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  labels:\n    app: node-exporter\n    name: node-exporter\n  name: node-exporter\nspec:\n  ports:\n  - name: scrape\n    port: 9100\n    protocol: TCP\n  selector:\n    app: node-exporter\n  type: ClusterIP\n---\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  name: node-exporter\nspec:\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n      name: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          hostPort: 9100\n          name: scrape\n      hostNetwork: true\n      hostPID: true\n</code></pre> <p>\u7531\u4e8eNode Exporter\u9700\u8981\u80fd\u591f\u8bbf\u95ee\u5bbf\u4e3b\u673a\uff0c\u56e0\u6b64\u8fd9\u91cc\u6307\u5b9a\u4e86hostNetwork\u548chostPID\uff0c\u8ba9Pod\u5b9e\u4f8b\u80fd\u591f\u4ee5\u4e3b\u673a\u7f51\u7edc\u4ee5\u53ca\u7cfb\u7edf\u8fdb\u7a0b\u7684\u5f62\u5f0f\u8fd0\u884c\u3002\u540c\u65f6YAML\u6587\u4ef6\u4e2d\u4e5f\u521b\u5efa\u4e86NodeExporter\u76f8\u5e94\u7684Service\u3002\u8fd9\u6837\u901a\u8fc7Service\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u5bf9\u5e94\u7684NodeExporter\u5b9e\u4f8b\u3002</p> <pre><code>$ kubectl create -f node-exporter-daemonset.yml\nservice \"node-exporter\" created\ndaemonset \"node-exporter\" created\n</code></pre> <p>\u67e5\u770bDaemonset\u4ee5\u53caPod\u7684\u8fd0\u884c\u72b6\u6001</p> <pre><code>$ kubectl get daemonsets\nNAME            DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nnode-exporter   1         1         1         1            1           &lt;none&gt;          15s\n\n$ kubectl get pods\nNAME                               READY     STATUS    RESTARTS   AGE\n...\nnode-exporter-9h56z                1/1       Running   0          51s\n</code></pre> <p>\u7531\u4e8eNode Exporter\u662f\u4ee5\u4e3b\u673a\u7f51\u7edc\u7684\u5f62\u5f0f\u8fd0\u884c\uff0c\u56e0\u6b64\u76f4\u63a5\u8bbf\u95eeMiniKube\u7684\u865a\u62df\u673aIP\u52a0\u4e0aPod\u7684\u7aef\u53e3\u5373\u53ef\u8bbf\u95ee\u5f53\u524d\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Node Exporter\u5b9e\u4f8b:</p> <pre><code>$ minikube ip\n192.168.99.100\n\n$ curl http://192.168.99.100:9100/metrics\n...\nprocess_start_time_seconds 1.5251401593e+09\n# HELP process_virtual_memory_bytes Virtual memory size in bytes.\n# TYPE process_virtual_memory_bytes gauge\nprocess_virtual_memory_bytes 1.1984896e+08\n</code></pre>"},{"location":"kubernetes/use-promethues-monitor-node-in-k8s/#kubernetesservice","title":"Kubernetes\u4e0bService\u8d1f\u8f7d\u5747\u8861\u539f\u7406","text":"<p>\u5728Kubernetes\u4e0bService\u662f\u4f5c\u4e3a\u4e00\u4e2a\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5b58\u5728\uff0c\u5b83\u5bf9\u5916\u66b4\u9732\u4e00\u4e2a\u552f\u4e00\u8bbf\u95ee\u5730\u5740\uff08ClusterIP\uff09\uff0c\u540e\u7aef\u5219\u901a\u8fc7Endpoint\u6307\u5411\u591a\u4e2aPod\u5b9e\u4f8b\u3002</p> <p></p> <p>\u5728Kubernetes\u4e2dService\u548cEndpoint\u662f\u4e24\u4e2a\u72ec\u7acb\u7684\u8d44\u6e90\u3002\u5982\u679c\u521b\u5efaService\u7684\u65f6\uff0c\u6307\u5b9a\u4e86Selector\u9009\u62e9\u5668\u3002\u90a3\u4e48Kubernetes\u4f1a\u81ea\u52a8\u6839\u636e\u9009\u62e9\u5668\u7684\u53bb\u5339\u914dPod\u5b9e\u4f8b\uff0c\u5e76\u6839\u636e\u8fd9\u4e9bPod\u7684\u8bbf\u95ee\u4fe1\u606f\uff0c\u81ea\u52a8\u521b\u5efaEndpoint\u8d44\u6e90\u3002</p> <p>\u4f8b\u5982\uff0c\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u67e5\u770bNode Exporter\u5b9e\u4f8b\u5bf9\u5e94\u7684IP\u5730\u5740\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME                               READY     STATUS    RESTARTS   AGE       IP               NODE\nnode-exporter-st4cd                1/1       Running   0          4m        192.168.99.100   minikube\n</code></pre> <p>\u7531\u4e8eService\u4e2d\u6307\u5b9a\u4e86\u6807\u7b7e\u9009\u62e9\u5668\uff08app: node-exporter\uff09\uff0cKubernetes\u5c31\u4f1a\u81ea\u52a8\u627e\u5230\u8be5\u9009\u62e9\u5668\u5bf9\u5e94\u7684Pod\u5b9e\u4f8b\u7684\u8bbf\u95ee\u4fe1\u606f\uff08\u8fd9\u91cc\u662f192.168.99.100\uff1a9100\uff09\uff0c\u5e76\u521b\u5efaService\u5bf9\u5e94\u7684Endpoint\uff0c\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get endpoints node-exporter\nNAME            ENDPOINTS                                               AGE\nnode-exporter   192.168.99.100:9100                                     4m\n</code></pre> <p>\u6700\u540e\u67e5\u770bService\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe svc node-exporter\nName:              node-exporter\nNamespace:         default\nLabels:            app=node-exporter\n                   name=node-exporter\nAnnotations:       prometheus.io/scrape=true\nSelector:          app=node-exporter\nType:              ClusterIP\nIP:                10.100.42.83\nPort:              scrape  9100/TCP\nTargetPort:        9100/TCP\nEndpoints:         192.168.99.100:9100\nSession Affinity:  None\nEvents:            &lt;none&gt;\n</code></pre> <p>\u5c06Service\u4e0eEndpoint\u5206\u79bb\u8fd8\u5e26\u6765\u53e6\u5916\u4e00\u4e2a\u597d\u5904\uff0c\u5982\u679c\u6211\u4eec\u5e0c\u671b\u96c6\u7fa4\u5185\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u80fd\u591f\u901a\u8fc7Service\u7684\u5f62\u5f0f\u8bbf\u95ee\u5230\u96c6\u7fa4\u5916\u7684\u8d44\u6e90\uff08\u5982\uff0c\u5916\u90e8\u90e8\u7f72\u7684MySQL\uff09\u3002\u8fd9\u662f\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u4e0d\u5305\u542bSelector\u7684Service\u5373\u53ef\uff0c\u5e76\u4e14\u624b\u6bb5\u521b\u5efa\u8be5Service\u9700\u8981\u4ee3\u7406\u7684\u5916\u90e8\u670d\u52a1\u5373\u53ef\u3002</p> <p>\u4f8b\u5982\uff0c\u521b\u5efa\u670d\u52a1mysql-production\uff0c\u5e76\u4e14\u6307\u5411\u96c6\u7fa4\u5916\u8fd0\u884c\u7684MySQL\u670d\u52a1\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-production\nspec:\n  ports:\n    - port: 3306\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: mysql-production\nsubsets:\n  - addresses:\n      - ip: 192.168.1.25\n    ports:\n      - port: 3306\n</code></pre>"},{"location":"kubernetes/use-promethues-monitor-node-in-k8s/#endpointnode-exporter","title":"\u4f7f\u7528Endpoint\u53d1\u73b0Node Exporter\u5b9e\u4f8b","text":"<p>\u5728\u4e86\u89e3\u4e86Kubernetes\u4e0bService\u4e0eEndpoint\u7684\u5173\u7cfb\u4ee5\u540e\uff0c\b\u6211\u4eec\u5c31\u80fd\u5927\u6982\u7406\u89e3\uff0c\u5728Kubernetes\u4e0b\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u901a\u8fc7Endpoint\b\u662f\u80fd\u591f\u627e\u5230\u7279\u5b9a\u670d\u52a1\u7684\u591a\u4e2a\u8bbf\u95ee\u5730\u5740\u7684\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e9b\u5730\u5740\u83b7\u53d6\u5230\u76f8\u5e94\u7684\u76d1\u63a7\u6307\u6807\u3002 \u800cService\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5219\u9002\u7528\u4e8e\u4f5c\u4e3a\u670d\u52a1\u53ef\u7528\u6027\u7684\u63a2\u6d4b\u6807\u51c6\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06Blackbox\u4e0eService\u76f8\u7ed3\u5408\uff0c\u76d1\u63a7\u670d\u52a1\u7684\u53ef\u7528\u6027\u3002</p> <p>\u5728Prometheus\u4e2d\uff0c\u901a\u8fc7\u8bbe\u7f6ekubernetes_sd_config\u7684role\u4e3aendpoints\u6307\u5b9a\u5f53\u524d\u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff1a</p> <pre><code>kubernetes_sd_configs:\n- role: endpoints\n</code></pre> <p>\u4e0d\u8fc7\uff0c\u4e3a\u4e86\u533a\u5206\u96c6\u7fa4\u4e2d\u54ea\u4e9bEndpoint\u662f\u53ef\u4ee5\u91c7\u96c6\u7684\uff0c\u800c\u54ea\u4e9b\u662f\u4e0d\u53ef\u4ee5\u91c7\u96c6\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e3aService\u6dfb\u52a0\u7279\u5b9a\u7684\u6807\u7b7e\u8fdb\u884c\u6807\u8bb0\u3002\u4f8b\u5982\uff0cNode Exporter\u7684Service\u4e2d\u5305\u542b\u4e86\u81ea\u5b9a\u4e49\u7684\u6ce8\u89e3\uff1a</p> <pre><code>metadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n</code></pre> <p>\u901a\u8fc7Kubernetes\u83b7\u53d6\u5230\u7684Endpoint\u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u662f\u901a\u8fc7Kubernetes\u81ea\u52a8\u53d1\u73b0\u7684Endpoint\u5bf9\u8c61\u7684\u6240\u6709metadata\u6807\u7b7e\uff1a</p> <pre><code>__address__=\"192.168.99.100:9100\"\n__meta_kubernetes_endpoint_port_name=\"scrape\"\n__meta_kubernetes_endpoint_port_protocol=\"TCP\"\n__meta_kubernetes_endpoint_ready=\"true\"\n__meta_kubernetes_endpoints_name=\"node-exporter\"\n__meta_kubernetes_namespace=\"default\"\n__meta_kubernetes_pod_container_name=\"node-exporter\"\n__meta_kubernetes_pod_container_port_name=\"scrape\"\n__meta_kubernetes_pod_container_port_number=\"9100\"\n__meta_kubernetes_pod_container_port_protocol=\"TCP\"\n__meta_kubernetes_pod_host_ip=\"192.168.99.100\"\n__meta_kubernetes_pod_ip=\"192.168.99.100\"\n__meta_kubernetes_pod_label_app=\"node-exporter\"\n__meta_kubernetes_pod_label_controller_revision_hash=\"4286002507\"\n__meta_kubernetes_pod_label_pod_template_generation=\"1\"\n__meta_kubernetes_pod_name=\"node-exporter-st4cd\"\n__meta_kubernetes_pod_node_name=\"minikube\"\n__meta_kubernetes_pod_ready=\"true\"\n__meta_kubernetes_pod_uid=\"7fe1c063-4ce5-11e8-a82a-08002717c1c9\"\n__meta_kubernetes_service_annotation_prometheus_io_scrape=\"true\"\n__meta_kubernetes_service_label_app=\"node-exporter\"\n__meta_kubernetes_service_label_name=\"node-exporter\"\n__meta_kubernetes_service_name=\"node-exporter\"\n__metrics_path__=\"/metrics\"\n__scheme__=\"http\"\njob=\"kubernetes-service-endpoints\"\n</code></pre> <p>\u7531\u4e8e\u8be5Endpoint\u5c5e\u4e8e\u7279\u5b9a\u7684Servie\uff0c\u5e76\u4e14backend\u6307\u5411\u4e86\u5177\u4f53\u7684Pod\u5b9e\u4f8b\uff0c\u6240\u4ee5\u8fd4\u56de\u7684metadata\u6807\u7b7e\u4e2d\u5305\u542b\u4e86\u5173\u8054\u7684Service\u7684\u4fe1\u606f\uff08\u4ee5<code>__meta_kubernetes_service</code>\u4f5c\u4e3a\u524d\u7f00\uff09\u4ee5\u53ca\u540e\u7aefPod\u7684\u76f8\u5173\u4fe1\u606f\uff08\u4ee5<code>__meta_kubernetes_pod</code>\u4f5c\u4e3a\u6d45\u9189\uff09\u3002</p> <p>\u901a\u8fc7relabeling\u7684keep\u6a21\u5f0f\uff0c\u9009\u62e9\u53ea\u83b7\u53d6\u5305\u542b\u4e86\u6807\u7b7e<code>__meta_kubernetes_service_annotation_prometheus_io_scrape</code>\u5e76\u4e14\u5176\u503c\u4e3atrue\u7684Endpoint\u4f5c\u4e3a\u76d1\u63a7\u76ee\u6807\uff1a</p> <pre><code>  - job_name: 'kubernetes-service-endpoints'\n    kubernetes_sd_configs:\n    - role: endpoints\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n      action: keep\n      regex: true\n    - source_labels: [__meta_kubernetes_endpoints_name]\n      target_label: job\n</code></pre> <p></p> <p>\u8fd9\u79cd\u57fa\u4e8eService\u7684annotations\u6765\u63a7\u5236Prometheus\u7684\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u6269\u5c55\u51fa\u66f4\u591a\u7684\u73a9\u6cd5\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u5e76\u6ca1\u6709\u901a\u8fc7/metrics\u66b4\u9732\u76d1\u63a7\u6837\u672c\u6570\u636e\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u66f4\u5b8c\u6574\u7684\u91c7\u96c6\u4efb\u52a1\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code> -  job_name: 'kubernetes-service-endpoints'\n    kubernetes_sd_configs:\n    - role: endpoints\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n      action: keep\n      regex: true\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n      action: replace\n      target_label: __scheme__\n      regex: (https?)\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n      action: replace\n      target_label: __metrics_path__\n      regex: (.+)\n    - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n      action: replace\n      target_label: __address__\n      regex: ([^:]+)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - source_labels: [__meta_kubernetes_namespace]\n      action: replace\n      target_label: kubernetes_namespace\n    - source_labels: [__meta_kubernetes_service_name]\n      action: replace\n      target_label: kubernetes_name\n    - source_labels: [__meta_kubernetes_endpoints_name]\n      target_label: job\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u6b65\u9aa4\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728Service\u6dfb\u52a0\u6ce8\u89e3\u7684\u5f62\u5f0f\uff0c\u66f4\u7075\u6d3b\u7684\u63a7\u5236Prometheus\u7684\u4efb\u52a1\u91c7\u96c6\u4fe1\u606f\uff0c\u4f8b\u5982\uff0c\u901a\u8fc7\u6dfb\u52a0\u6ce8\u89e3\u81ea\u5b9a\u4e49\u91c7\u96c6\u6570\u636e\u7684\u76f8\u5173\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n    prometheus.io/scheme: 'https'\n    prometheus.io/path: '/custom_metrics'\n</code></pre> <p></p>"},{"location":"operator/","title":"\u7b2c9\u7ae0 Prometheus Operator","text":"<p>\u672c\u7ae0\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Prometheus Operator\u7b80\u5316\u5728Kubernetes\u4e0b\u90e8\u7f72\u548c\u7ba1\u7406Prmetheus\u7684\u590d\u6742\u5ea6\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u4e3a\u4ec0\u4e48\u9700\u8981\u4f7f\u7528Prometheus Operator</li> <li>Prometheus Operator\u7684\u4e3b\u8981\u6982\u5ff5</li> <li>\u5982\u4f55\u5229\u7528Prometheus Operator\u81ea\u52a8\u5316\u8fd0\u7ef4Prometheus</li> <li>\u5982\u4f55\u4f7f\u7528Prometheus Operator\u81ea\u52a8\u5316\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e</li> </ul>"},{"location":"operator/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>\u5728\u672c\u7ae0\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728Kubernetes\u4e0b\u5982\u4f55\u4f7f\u7528Operator\u6765\u6709\u72b6\u6001\u7684\u8fd0\u7ef4\u548c\u7ba1\u7406Prometheus\u4ee5\u53caAlertmanager\u7b49\u7ec4\u4ef6\u3002</p>"},{"location":"operator/use-custom-configuration-in-operator/","title":"\u5728Prometheus Operator\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e","text":"<p>\u5728Prometheus Operator\u6211\u4eec\u901a\u8fc7\u58f0\u660e\u5f0f\u7684\u521b\u5efa\u5982Prometheus, ServiceMonitor\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u7c7b\u578b\u6765\u81ea\u52a8\u5316\u90e8\u7f72\u548c\u7ba1\u7406Prometheus\u7684\u76f8\u5173\u7ec4\u4ef6\u4ee5\u53ca\u914d\u7f6e\u3002\u800c\u5728\u4e00\u4e9b\u7279\u6b8a\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u4e8e\u7528\u6237\u800c\u8a00\uff0c\u53ef\u80fd\u8fd8\u662f\u5e0c\u671b\u80fd\u591f\u624b\u52a8\u7ba1\u7406Prometheus\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u975e\u901a\u8fc7Prometheus Operator\u81ea\u52a8\u5b8c\u6210\u3002 \u4e3a\u4ec0\u4e48\uff1f \u5b9e\u9645\u4e0aPrometheus Operator\u5bf9\u4e8eJob\u7684\u914d\u7f6e\u53ea\u9002\u7528\u4e8e\u5728Kubernetes\u4e2d\u90e8\u7f72\u548c\u7ba1\u7406\u7684\u5e94\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u4f60\u5e0c\u671b\u4f7f\u7528Prometheus\u76d1\u63a7\u4e00\u4e9b\u5176\u4ed6\u7684\u8d44\u6e90\uff0c\u4f8b\u5982AWS\u6216\u8005\u5176\u4ed6\u5e73\u53f0\u4e2d\u7684\u57fa\u7840\u8bbe\u65bd\u6216\u8005\u5e94\u7528\uff0c\u8fd9\u4e9b\u5e76\u4e0d\u5728Prometheus Operator\u7684\u80fd\u529b\u8303\u56f4\u4e4b\u5185\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u5728\u901a\u8fc7Prometheus Operator\u521b\u5efa\u7684Prometheus\u5b9e\u4f8b\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u53ea\u80fd\u521b\u5efa\u4e00\u4e2a\u4e0d\u5305\u542b\u4efb\u4f55\u4e0e\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u76f8\u5173\u7684Prometheus\u5b9e\u4f8b</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst-cc\n  namespace: monitoring\nspec:\n  serviceAccountName: prometheus\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u5230prometheus-inst-cc.yaml\u6587\u4ef6\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7kubectl\u521b\u5efa:</p> <pre><code>$ kubectl -n monitoring create -f prometheus-inst-cc.yaml\nprometheus.monitoring.coreos.com/inst-cc created\n</code></pre> <p>\u5982\u679c\u67e5\u770b\u65b0\u5efaPrometheus\u7684Pod\u5b9e\u4f8bYAML\u5b9a\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230Pod\u4e2d\u4f1a\u5305\u542b\u4e00\u4e2avolume\u914d\u7f6e\uff1a</p> <pre><code>volumes:\n  - name: config\n    secret:\n      defaultMode: 420\n      secretName: prometheus-inst-cc\n</code></pre> <p>Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u5b9e\u9645\u4e0a\u662f\u4fdd\u5b58\u5728\u540d\u4e3a<code>prometheus-&lt;name-of-prometheus-object&gt;</code>\u7684Secret\u4e2d\uff0c\u5f53\u7528\u6237\u521b\u5efa\u7684Prometheus\u4e2d\u5173\u8054ServiceMonitor\u8fd9\u7c7b\u4f1a\u5f71\u54cd\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u7684\u5b9a\u4e49\u65f6\uff0cPromethues Operator\u4f1a\u81ea\u52a8\u7ba1\u7406\u3002\u800c\u5982\u679cPrometheus\u5b9a\u4e49\u4e2d\u4e0d\u5305\u542b\u4efb\u4f55\u4e0e\u914d\u7f6e\u76f8\u5173\u7684\u5b9a\u4e49\uff0c\u90a3\u4e48Secret\u7684\u7ba1\u7406\u6743\u9650\u5c31\u843d\u5230\u4e86\u7528\u6237\u81ea\u5df1\u624b\u4e2d\u3002</p> <p>\u901a\u8fc7\u4fee\u6539prometheus-inst-cc\u7684\u5185\u5bb9\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba9\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684Prometheus\u914d\u7f6e\u6587\u4ef6\uff0c\u4f5c\u4e3a\u793a\u4f8b\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2aprometheus.yaml\u6587\u4ef6\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>global:\n  scrape_interval: 10s\n  scrape_timeout: 10s\n  evaluation_interval: 10s\n</code></pre> <p>\u751f\u6210\u6587\u4ef6\u5185\u5bb9\u7684base64\u7f16\u7801\u540e\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ cat prometheus.yaml | base64\nZ2xvYmFsOgogIHNjcmFwZV9pbnRlcnZhbDogMTBzCiAgc2NyYXBlX3RpbWVvdXQ6IDEwcwogIGV2YWx1YXRpb25faW50ZXJ2YWw6IDEwcw==\n</code></pre> <p>\u4fee\u6539\u540d\u4e3aprometheus-inst-cc\u7684Secret\u5185\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl -n monitoring edit secret prometheus-inst-cc\n# \u7701\u7565\u5176\u5b83\u5185\u5bb9\ndata:\n  prometheus.yaml: \"Z2xvYmFsOgogIHNjcmFwZV9pbnRlcnZhbDogMTBzCiAgc2NyYXBlX3RpbWVvdXQ6IDEwcwogIGV2YWx1YXRpb25faW50ZXJ2YWw6IDEwcw==\"\n</code></pre> <p>\u901a\u8fc7port-forward\u5728\u672c\u5730\u8bbf\u95ee\u65b0\u5efa\u7684Prometheus\u5b9e\u4f8b\uff0c\u89c2\u5bdf\u914d\u7f6e\u6587\u4ef6\u53d8\u5316\u5373\u53ef\uff1a</p> <pre><code>kubectl -n monitoring port-forward statefulsets/prometheus-inst-cc 9091:9090\n</code></pre>"},{"location":"operator/use-operator-manage-monitor/","title":"Use operator manage monitor","text":""},{"location":"operator/use-operator-manage-monitor/#operator","title":"\u4f7f\u7528Operator\u7ba1\u7406\u544a\u8b66","text":""},{"location":"operator/use-operator-manage-monitor/#prometheusrule","title":"\u4f7f\u7528PrometheusRule\u5b9a\u4e49\u544a\u8b66\u89c4\u5219","text":"<p>\u5bf9\u4e8ePrometheus\u800c\u8a00\uff0c\u5728\u539f\u751f\u7684\u7ba1\u7406\u65b9\u5f0f\u4e0a\uff0c\u6211\u4eec\u9700\u8981\u624b\u52a8\u521b\u5efaPrometheus\u7684\u544a\u8b66\u6587\u4ef6\uff0c\u5e76\u4e14\u901a\u8fc7\u5728Prometheus\u914d\u7f6e\u4e2d\u58f0\u660e\u5f0f\u7684\u52a0\u8f7d\u3002\u800c\u5728Prometheus Operator\u6a21\u5f0f\u4e2d\uff0c\u544a\u8b66\u89c4\u5219\u4e5f\u7f16\u7a0b\u4e00\u4e2a\u901a\u8fc7Kubernetes API \u58f0\u660e\u5f0f\u521b\u5efa\u7684\u4e00\u4e2a\u8d44\u6e90\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: example\n    role: alert-rules\n  name: prometheus-example-rules\nspec:\n  groups:\n  - name: ./example.rules\n    rules:\n    - alert: ExampleAlert\n      expr: vector(1)\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u4e3aexample-rule.yaml\u6587\u4ef6\uff0c\u5e76\u4e14\u901a\u8fc7kubectl\u547d\u4ee4\u521b\u5efa\u76f8\u5e94\u7684\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl -n monitoring create -f example-rule.yaml\nprometheusrule \"prometheus-example-rules\" created\n</code></pre> <p>\u544a\u8b66\u89c4\u5219\u521b\u5efa\u6210\u529f\u540e\uff0c\u901a\u8fc7\u5728Prometheus\u4e2d\u4f7f\u7528ruleSelector\u901a\u8fc7\u9009\u62e9\u9700\u8981\u5173\u8054\u7684PrometheusRule\u5373\u53ef\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  serviceAccountName: prometheus\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  ruleSelector:\n    matchLabels:\n      role: alert-rules\n      prometheus: example\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>Prometheus\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u540e\uff0c\u4eceUI\u4e2d\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u901a\u8fc7PrometheusRule\u81ea\u52a8\u521b\u5efa\u7684\u544a\u8b66\u89c4\u5219\u914d\u7f6e\uff1a</p> <p></p> <p>\u5982\u679c\u67e5\u770bAlerts\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u544a\u8b66\u5df2\u7ecf\u5904\u4e8e\u89e6\u53d1\u72b6\u6001\u3002</p>"},{"location":"operator/use-operator-manage-monitor/#operatoralertmanager","title":"\u4f7f\u7528Operator\u7ba1\u7406Alertmanager\u5b9e\u4f8b","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u901a\u8fc7Prometheus Operator\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578b\u7ba1\u7406\u4e86Prometheus\u7684\u5b9e\u4f8b\uff0c\u76d1\u63a7\u914d\u7f6e\u4ee5\u53ca\u544a\u8b66\u89c4\u5219\u7b49\u8d44\u6e90\u3002\u901a\u8fc7Prometheus Operator\u5c06\u539f\u672c\u624b\u52a8\u7ba1\u7406\u7684\u5de5\u4f5c\u5168\u90e8\u53d8\u6210\u58f0\u660e\u5f0f\u7684\u7ba1\u7406\u6a21\u5f0f\uff0c\u5927\u5927\u7b80\u5316\u4e86Kubernetes\u4e0b\u7684Prometheus\u8fd0\u7ef4\u7ba1\u7406\u7684\u590d\u6742\u5ea6\u3002 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u7ee7\u7eed\u4f7f\u7528Prometheus Operator\u5b9a\u4e49\u548c\u7ba1\u7406Alertmanager\u76f8\u5173\u7684\u5185\u5bb9\u3002</p> <p>\u4e3a\u4e86\u901a\u8fc7Prometheus Operator\u7ba1\u7406Alertmanager\u5b9e\u4f8b\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u8d44\u6e90Alertmanager\u8fdb\u884c\u5b9a\u4e49\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u901a\u8fc7replicas\u53ef\u4ee5\u63a7\u5236Alertmanager\u7684\u5b9e\u4f8b\u6570\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Alertmanager\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  replicas: 3\n</code></pre> <p>\u5f53replicas\u5927\u4e8e1\u65f6\uff0cPrometheus Operator\u4f1a\u81ea\u52a8\u901a\u8fc7\u96c6\u7fa4\u7684\u65b9\u5f0f\u521b\u5efaAlertmanager\u3002\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u4e3a\u6587\u4ef6alertmanager-inst.yaml\uff0c\u5e76\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\uff1a</p> <pre><code>$ kubectl -n monitoring create -f alertmanager-inst.yaml\nalertmanager.monitoring.coreos.com/inst created\n</code></pre> <p>\u67e5\u770bPod\u7684\u60c5\u51b5\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0Alertmanager\u7684Pod\u5b9e\u4f8b\u4e00\u76f4\u5904\u4e8eContainerCreating\u7684\u72b6\u6001\u4e2d:</p> <pre><code>$ kubectl -n monitoring get pods\nNAME                                   READY     STATUS              RESTARTS   AGE\nalertmanager-inst-0                    0/2       ContainerCreating   0          32s\n</code></pre> <p>\u901a\u8fc7kubectl describe\u547d\u4ee4\u67e5\u770b\u8be5Alertmanager\u7684Pod\u5b9e\u4f8b\u72b6\u6001\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u5185\u5bb9\u7684\u544a\u8b66\u4fe1\u606f\uff1a</p> <pre><code>MountVolume.SetUp failed for volume \"config-volume\" : secrets \"alertmanager-inst\" not found\n</code></pre> <p>\u8fd9\u662f\u7531\u4e8ePrometheus Operator\u901a\u8fc7Statefulset\u7684\u65b9\u5f0f\u521b\u5efa\u7684Alertmanager\u5b9e\u4f8b\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f1a\u901a\u8fc7<code>alertmanager-{ALERTMANAGER_NAME}</code>\u7684\u547d\u540d\u89c4\u5219\u53bb\u67e5\u627eSecret\u914d\u7f6e\u5e76\u4ee5\u6587\u4ef6\u6302\u8f7d\u7684\u65b9\u5f0f\uff0c\u5c06Secret\u7684\u5185\u5bb9\u4f5c\u4e3a\u914d\u7f6e\u6587\u4ef6\u6302\u8f7d\u5230Alertmanager\u5b9e\u4f8b\u5f53\u4e2d\u3002\u56e0\u6b64\uff0c\u8fd9\u91cc\u8fd8\u9700\u8981\u4e3aAlertmanager\u521b\u5efa\u76f8\u5e94\u7684\u914d\u7f6e\u5185\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u662fAlertmanager\u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>global:\n  resolve_timeout: 5m\nroute:\n  group_by: ['job']\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  receiver: 'webhook'\nreceivers:\n- name: 'webhook'\n  webhook_configs:\n  - url: 'http://alertmanagerwh:30500/'\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u4e3a\u6587\u4ef6alertmanager.yaml\uff0c\u5e76\u4e14\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u540d\u4e3aalrtmanager-inst\u7684Secret\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl -n monitoring create secret generic alertmanager-inst --from-file=alertmanager.yaml\nsecret/alertmanager-inst created\n</code></pre> <p>\u5728Secret\u521b\u5efa\u6210\u529f\u540e\uff0c\u67e5\u770b\u5f53\u524dAlertmanager Pod\u5b9e\u4f8b\u72b6\u6001\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl -n monitoring get pods\nNAME                                   READY     STATUS    RESTARTS   AGE\nalertmanager-inst-0                    2/2       Running   0          5m\nalertmanager-inst-1                    2/2       Running   0          52s\nalertmanager-inst-2                    2/2       Running   0          37s\n</code></pre> <p>\u4f7f\u7528port-forward\u5c06Alertmanager\u6620\u5c04\u5230\u672c\u5730\uff1a</p> <pre><code>$ kubectl -n monitoring port-forward statefulsets/alertmanager-inst 9093:9093\n</code></pre> <p>\u8bbf\u95eehttp://localhost:9093/#/status\uff0c\u5e76\u67e5\u770b\u5f53\u524d\u96c6\u7fa4\u72b6\u6001\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4fee\u6539\u6211\u4eec\u7684Prometheus\u8d44\u6e90\u5b9a\u4e49\uff0c\u901a\u8fc7alerting\u6307\u5b9a\u4f7f\u7528\u7684Alertmanager\u8d44\u6e90\u5373\u53ef\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  serviceAccountName: prometheus\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  ruleSelector:\n    matchLabels:\n      role: alert-rules\n      prometheus: example\n  alerting:\n    alertmanagers:\n    - name: alertmanager-example\n      namespace: monitoring\n      port: web\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>\u7b49\u5f85Prometheus\u91cd\u65b0\u52a0\u8f7d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230Prometheus Operator\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e86\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>  alertmanagers:\n  - kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - monitoring\n    scheme: http\n    path_prefix: /\n    timeout: 10s\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      separator: ;\n      regex: alertmanager-example\n      replacement: $1\n      action: keep\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: web\n      replacement: $1\n      action: keep\n</code></pre> <p>\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u89c4\u5219\u5c06Prometheus\u4e0eAlertmanager\u8fdb\u884c\u4e86\u81ea\u52a8\u5173\u8054\u3002</p>"},{"location":"operator/use-operator-manage-prometheus/","title":"\u4f7f\u7528Operator\u7ba1\u7406Prometheus","text":""},{"location":"operator/use-operator-manage-prometheus/#prometheus","title":"\u521b\u5efaPrometheus\u5b9e\u4f8b","text":"<p>\u5f53\u96c6\u7fa4\u4e2d\u5df2\u7ecf\u5b89\u88c5Prometheus Operator\u4e4b\u540e\uff0c\u5bf9\u4e8e\u90e8\u7f72Prometheus Server\u5b9e\u4f8b\u5c31\u53d8\u6210\u4e86\u58f0\u660e\u4e00\u4e2aPrometheus\u8d44\u6e90\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u5728Monitoring\u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u4e00\u4e2aPrometheus\u5b9e\u4f8b\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u5230prometheus-inst.yaml\u6587\u4ef6\uff0c\u5e76\u901a\u8fc7kubectl\u8fdb\u884c\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f prometheus-inst.yaml\nprometheus.monitoring.coreos.com/inst-1 created\n</code></pre> <p>\u6b64\u65f6\uff0c\u67e5\u770bmonitoring\u547d\u540d\u7a7a\u95f4\u4e0b\u7684statefulsets\u8d44\u6e90\uff0c\u53ef\u4ee5\u770b\u5230Prometheus Operator\u81ea\u52a8\u901a\u8fc7Statefulset\u521b\u5efa\u7684Prometheus\u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl -n monitoring get statefulsets\nNAME              DESIRED   CURRENT   AGE\nprometheus-inst   1         1         1m\n</code></pre> <p>\u67e5\u770bPod\u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl -n monitoring get pods\nNAME                                   READY     STATUS    RESTARTS   AGE\nprometheus-inst-0                      3/3       Running   1          1m\nprometheus-operator-6db8dbb7dd-2hz55   1/1       Running   0          45m\n</code></pre> <p>\u901a\u8fc7port-forward\u8bbf\u95eePrometheus\u5b9e\u4f8b:</p> <pre><code>$ kubectl -n monitoring port-forward statefulsets/prometheus-inst 9090:9090\n</code></pre> <p>\u901a\u8fc7http://localhost:9090\u53ef\u4ee5\u5728\u672c\u5730\u76f4\u63a5\u6253\u5f00Prometheus Operator\u521b\u5efa\u7684Prometheus\u5b9e\u4f8b\u3002\u67e5\u770b\u914d\u7f6e\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u76ee\u524dOperator\u521b\u5efa\u4e86\u53ea\u5305\u542b\u57fa\u672c\u914d\u7f6e\u7684Prometheus\u5b9e\u4f8b\uff1a</p> <p></p>"},{"location":"operator/use-operator-manage-prometheus/#servicemonitor","title":"\u4f7f\u7528ServiceMonitor\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e","text":"<p>\u4fee\u6539\u76d1\u63a7\u914d\u7f6e\u9879\u4e5f\u662fPrometheus\u4e0b\u5e38\u7528\u7684\u8fd0\u7ef4\u64cd\u4f5c\u4e4b\u4e00\uff0c\u4e3a\u4e86\u80fd\u591f\u81ea\u52a8\u5316\u7684\u7ba1\u7406Prometheus\u7684\u914d\u7f6e\uff0cPrometheus Operator\u4f7f\u7528\u4e86\u81ea\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578bServiceMonitor\u6765\u63cf\u8ff0\u76d1\u63a7\u5bf9\u8c61\u7684\u4fe1\u606f\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u9996\u5148\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a\u793a\u4f8b\u5e94\u7528\uff0c\u5c06\u4ee5\u4e0b\u5185\u5bb9\u4fdd\u5b58\u5230example-app.yaml\uff0c\u5e76\u4f7f\u7528kubectl\u547d\u4ee4\u884c\u5de5\u5177\u521b\u5efa\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: example-app\n  labels:\n    app: example-app\nspec:\n  selector:\n    app: example-app\n  ports:\n  - name: web\n    port: 8080\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: example-app\nspec:\n  selector:\n    matchLabels:\n      app: example-app\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: example-app\n    spec:\n      containers:\n      - name: example-app\n        image: fabxc/instrumented_app\n        ports:\n        - name: web\n          containerPort: 8080\n\n</code></pre> <p>\u793a\u4f8b\u5e94\u7528\u4f1a\u901a\u8fc7Deployment\u521b\u5efa3\u4e2aPod\u5b9e\u4f8b\uff0c\u5e76\u4e14\u901a\u8fc7Service\u66b4\u9732\u5e94\u7528\u8bbf\u95ee\u4fe1\u606f\u3002</p> <pre><code>$ kubectl get pods\nNAME                        READY     STATUS    RESTARTS   AGE\nexample-app-94c8bc8-l27vx   2/2       Running   0          1m\nexample-app-94c8bc8-lcsrm   2/2       Running   0          1m\nexample-app-94c8bc8-n6wp5   2/2       Running   0          1m\n</code></pre> <p>\u5728\u672c\u5730\u540c\u6837\u901a\u8fc7port-forward\u8bbf\u95ee\u4efb\u610fPod\u5b9e\u4f8b</p> <pre><code>$ kubectl port-forward deployments/example-app 8080:8080\n</code></pre> <p>\u8bbf\u95ee\u672c\u5730\u7684http://localhost:8080/metrics\u5b9e\u4f8b\u5e94\u7528\u7a0b\u5e8f\u4f1a\u8fd4\u56de\u4ee5\u4e0b\u6837\u672c\u6570\u636e\uff1a</p> <pre><code># TYPE codelab_api_http_requests_in_progress gauge\ncodelab_api_http_requests_in_progress 3\n# HELP codelab_api_request_duration_seconds A histogram of the API HTTP request durations in seconds.\n# TYPE codelab_api_request_duration_seconds histogram\ncodelab_api_request_duration_seconds_bucket{method=\"GET\",path=\"/api/bar\",status=\"200\",le=\"0.0001\"} 0\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u80fd\u591f\u91c7\u96c6\u90e8\u7f72\u5728Kubernetes\u4e0b\u5e94\u7528\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5728\u539f\u751f\u7684Prometheus\u914d\u7f6e\u65b9\u5f0f\u4e2d\uff0c\u6211\u4eec\u5728Prometheus\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u5355\u72ec\u7684Job\uff0c\u540c\u65f6\u4f7f\u7528kubernetes_sd\u5b9a\u4e49\u6574\u4e2a\u670d\u52a1\u53d1\u73b0\u8fc7\u7a0b\u3002\u800c\u5728Prometheus Operator\u4e2d\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u58f0\u660e\u4e00\u4e2aServiceMonitor\u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: example-app\n  namespace: monitoring\n  labels:\n    team: frontend\nspec:\n  namespaceSelector:\n    matchNames:\n    - default\n  selector:\n    matchLabels:\n      app: example-app\n  endpoints:\n  - port: web\n</code></pre> <p>\u901a\u8fc7\u5b9a\u4e49selector\u4e2d\u7684\u6807\u7b7e\u5b9a\u4e49\u9009\u62e9\u76d1\u63a7\u76ee\u6807\u7684Pod\u5bf9\u8c61\uff0c\u540c\u65f6\u5728endpoints\u4e2d\u6307\u5b9aport\u540d\u79f0\u4e3aweb\u7684\u7aef\u53e3\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0bServiceMonitor\u548c\u76d1\u63a7\u5bf9\u8c61\u5fc5\u987b\u662f\u5728\u76f8\u540cNamespace\u4e0b\u7684\u3002\u5728\u672c\u793a\u4f8b\u4e2d\u7531\u4e8ePrometheus\u662f\u90e8\u7f72\u5728Monitoring\u547d\u540d\u7a7a\u95f4\u4e0b\uff0c\u56e0\u6b64\u4e3a\u4e86\u80fd\u591f\u5173\u8054default\u547d\u540d\u7a7a\u95f4\u4e0b\u7684example\u5bf9\u8c61\uff0c\u9700\u8981\u4f7f\u7528namespaceSelector\u5b9a\u4e49\u8ba9\u5176\u53ef\u4ee5\u8de8\u547d\u540d\u7a7a\u95f4\u5173\u8054ServiceMonitor\u8d44\u6e90\u3002\u4fdd\u5b58\u4ee5\u4e0a\u5185\u5bb9\u5230example-app-service-monitor.yaml\u6587\u4ef6\u4e2d\uff0c\u5e76\u901a\u8fc7kubectl\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f example-app-service-monitor.yaml\nservicemonitor.monitoring.coreos.com/example-app created\n</code></pre> <p>\u5982\u679c\u5e0c\u671bServiceMonitor\u53ef\u4ee5\u5173\u8054\u4efb\u610f\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u6807\u7b7e\uff0c\u5219\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5b9a\u4e49\uff1a</p> <pre><code>spec:\n  namespaceSelector:\n    any: true\n</code></pre> <p>\u5982\u679c\u76d1\u63a7\u7684Target\u5bf9\u8c61\u542f\u7528\u4e86BasicAuth\u8ba4\u8bc1\uff0c\u90a3\u5728\u5b9a\u4e49ServiceMonitor\u5bf9\u8c61\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528endpoints\u914d\u7f6e\u4e2d\u5b9a\u4e49basicAuth\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: example-app\n  namespace: monitoring\n  labels:\n    team: frontend\nspec:\n  namespaceSelector:\n    matchNames:\n    - default\n  selector:\n    matchLabels:\n      app: example-app\n  endpoints:\n  - basicAuth:\n      password:\n        name: basic-auth\n        key: password\n      username:\n        name: basic-auth\n        key: user\n    port: web\n</code></pre> <p>\u5176\u4e2dbasicAuth\u4e2d\u5173\u8054\u4e86\u540d\u4e3abasic-auth\u7684Secret\u5bf9\u8c61\uff0c\u7528\u6237\u9700\u8981\u624b\u52a8\u5c06\u8ba4\u8bc1\u4fe1\u606f\u4fdd\u5b58\u5230Secret\u4e2d:</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: basic-auth\ndata:\n  password: dG9vcg== # base64\u7f16\u7801\u540e\u7684\u5bc6\u7801\n  user: YWRtaW4= # base64\u7f16\u7801\u540e\u7684\u7528\u6237\u540d\ntype: Opaque\n</code></pre>"},{"location":"operator/use-operator-manage-prometheus/#promethuesservicemonitor","title":"\u5173\u8054Promethues\u4e0eServiceMonitor","text":"<p>Prometheus\u4e0eServiceMonitor\u4e4b\u95f4\u7684\u5173\u8054\u5173\u7cfb\u4f7f\u7528serviceMonitorSelector\u5b9a\u4e49\uff0c\u5728Prometheus\u4e2d\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5f53\u524d\u9700\u8981\u76d1\u63a7\u7684ServiceMonitor\u5bf9\u8c61\u3002\u4fee\u6539prometheus-inst.yaml\u4e2dPrometheus\u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a \u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus\u5173\u8054\u5230ServiceMonitor\uff0c\u9700\u8981\u5728Pormtheus\u5b9a\u4e49\u4e2d\u4f7f\u7528serviceMonitorSelector\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5f53\u524dPrometheus\u9700\u8981\u76d1\u63a7\u7684ServiceMonitor\u5bf9\u8c61\u3002\u4fee\u6539prometheus-inst.yaml\u4e2dPrometheus\u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>\u5c06\u5bf9Prometheus\u7684\u53d8\u66f4\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>$ kubectl -n monitoring apply -f prometheus-inst.yaml\n</code></pre> <p>\u6b64\u65f6\uff0c\u5982\u679c\u67e5\u770bPrometheus\u914d\u7f6e\u4fe1\u606f\uff0c\u6211\u4eec\u4f1a\u60ca\u559c\u7684\u53d1\u73b0Prometheus\u4e2d\u914d\u7f6e\u6587\u4ef6\u81ea\u52a8\u5305\u542b\u4e86\u4e00\u6761\u540d\u4e3amonitoring/example-app/0\u7684Job\u914d\u7f6e\uff1a</p> <pre><code>global:\n  scrape_interval: 30s\n  scrape_timeout: 10s\n  evaluation_interval: 30s\n  external_labels:\n    prometheus: monitoring/inst\n    prometheus_replica: prometheus-inst-0\nalerting:\n  alert_relabel_configs:\n  - separator: ;\n    regex: prometheus_replica\n    replacement: $1\n    action: labeldrop\nrule_files:\n- /etc/prometheus/rules/prometheus-inst-rulefiles-0/*.yaml\nscrape_configs:\n- job_name: monitoring/example-app/0\n  scrape_interval: 30s\n  scrape_timeout: 10s\n  metrics_path: /metrics\n  scheme: http\n  kubernetes_sd_configs:\n  - role: endpoints\n    namespaces:\n      names:\n      - default\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_service_label_app]\n    separator: ;\n    regex: example-app\n    replacement: $1\n    action: keep\n  - source_labels: [__meta_kubernetes_endpoint_port_name]\n    separator: ;\n    regex: web\n    replacement: $1\n    action: keep\n  - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name]\n    separator: ;\n    regex: Node;(.*)\n    target_label: node\n    replacement: ${1}\n    action: replace\n  - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name]\n    separator: ;\n    regex: Pod;(.*)\n    target_label: pod\n    replacement: ${1}\n    action: replace\n  - source_labels: [__meta_kubernetes_namespace]\n    separator: ;\n    regex: (.*)\n    target_label: namespace\n    replacement: $1\n    action: replace\n  - source_labels: [__meta_kubernetes_service_name]\n    separator: ;\n    regex: (.*)\n    target_label: service\n    replacement: $1\n    action: replace\n  - source_labels: [__meta_kubernetes_pod_name]\n    separator: ;\n    regex: (.*)\n    target_label: pod\n    replacement: $1\n    action: replace\n  - source_labels: [__meta_kubernetes_service_name]\n    separator: ;\n    regex: (.*)\n    target_label: job\n    replacement: ${1}\n    action: replace\n  - separator: ;\n    regex: (.*)\n    target_label: endpoint\n    replacement: web\n    action: replace\n</code></pre> <p>\u4e0d\u8fc7\uff0c\u5982\u679c\u7ec6\u5fc3\u7684\u8bfb\u8005\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u867d\u7136Job\u914d\u7f6e\u6709\u4e86\uff0c\u4f46\u662fPrometheus\u7684Target\u4e2d\u5e76\u6ca1\u5305\u542b\u4efb\u4f55\u7684\u76d1\u63a7\u5bf9\u8c61\u3002\u67e5\u770bPrometheus\u7684Pod\u5b9e\u4f8b\u65e5\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a</p> <pre><code>level=error ts=2018-12-15T12:52:48.452108433Z caller=main.go:240 component=k8s_client_runtime err=\"github.com/prometheus/prometheus/discovery/kubernetes/kubernetes.go:300: Failed to list *v1.Endpoints: endpoints is forbidden: User \\\"system:serviceaccount:monitoring:default\\\" cannot list endpoints in the namespace \\\"default\\\"\"\n</code></pre>"},{"location":"operator/use-operator-manage-prometheus/#serviceaccount","title":"\u81ea\u5b9a\u4e49ServiceAccount","text":"<p>\u7531\u4e8e\u9ed8\u8ba4\u521b\u5efa\u7684Prometheus\u5b9e\u4f8b\u4f7f\u7528\u7684\u662fmonitoring\u547d\u540d\u7a7a\u95f4\u4e0b\u7684default\u8d26\u53f7\uff0c\u8be5\u8d26\u53f7\u5e76\u6ca1\u6709\u6743\u9650\u80fd\u591f\u83b7\u53d6default\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u4efb\u4f55\u8d44\u6e90\u4fe1\u606f\u3002</p> <p>\u4e3a\u4e86\u4fee\u590d\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u5728Monitoring\u547d\u540d\u7a7a\u95f4\u4e0b\u4e3a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3aPrometheus\u7684ServiceAccount\uff0c\u5e76\u4e14\u4e3a\u8be5\u8d26\u53f7\u8d4b\u4e88\u76f8\u5e94\u7684\u96c6\u7fa4\u8bbf\u95ee\u6743\u9650\u3002</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: monitoring\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources:\n  - configmaps\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: monitoring\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u5185\u5bb9\u4fdd\u5b58\u5230prometheus-rbac.yaml\u6587\u4ef6\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7kubectl\u521b\u5efa\u76f8\u5e94\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl -n monitoring create -f prometheus-rbac.yaml\nserviceaccount/prometheus created\nclusterrole.rbac.authorization.k8s.io/prometheus created\nclusterrolebinding.rbac.authorization.k8s.io/prometheus created\n</code></pre> <p>\u5728\u5b8c\u6210ServiceAccount\u521b\u5efa\u540e\uff0c\u4fee\u6539prometheus-inst.yaml\uff0c\u5e76\u6dfb\u52a0ServiceAccount\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: inst\n  namespace: monitoring\nspec:\n  serviceAccountName: prometheus\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 400Mi\n</code></pre> <p>\u4fdd\u5b58Prometheus\u53d8\u66f4\u5230\u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>$ kubectl -n monitoring apply -f prometheus-inst.yaml\nprometheus.monitoring.coreos.com/inst configured\n</code></pre> <p>\u7b49\u5f85Prometheus Operator\u5b8c\u6210\u76f8\u5173\u914d\u7f6e\u53d8\u66f4\u540e\uff0c\u6b64\u65f6\u67e5\u770bPrometheus\uff0c\u6211\u4eec\u5c31\u80fd\u770b\u5230\u5f53\u524dPrometheus\u5df2\u7ecf\u80fd\u591f\u6b63\u5e38\u7684\u91c7\u96c6\u5b9e\u4f8b\u5e94\u7528\u7684\u76f8\u5173\u76d1\u63a7\u6570\u636e\u4e86\u3002</p>"},{"location":"operator/what-is-prometheus-operator/","title":"\u4ec0\u4e48\u662fPrometheus Operator","text":"<p>\u5728\u7b2c8\u7ae0\u4e2d\uff0c\u4e3a\u4e86\u5728Kubernetes\u80fd\u591f\u65b9\u4fbf\u7684\u7ba1\u7406\u548c\u90e8\u7f72Prometheus\uff0c\u6211\u4eec\u4f7f\u7528ConfigMap\u4e86\u7ba1\u7406Prometheus\u914d\u7f6e\u6587\u4ef6\u3002\u6bcf\u6b21\u5bf9Prometheus\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u5347\u7ea7\u65f6\uff0c\uff0c\u6211\u4eec\u9700\u8981\u624b\u52a8\u79fb\u9664\u5df2\u7ecf\u8fd0\u884c\u7684Pod\u5b9e\u4f8b\uff0c\u4ece\u800c\u8ba9Kubernetes\u53ef\u4ee5\u4f7f\u7528\u6700\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u521b\u5efaPrometheus\u3002 \u800c\u5982\u679c\u5e94\u7528\u5b9e\u4f8b\u7684\u6570\u91cf\u66f4\u591a\u65f6\uff0c\u901a\u8fc7\u624b\u52a8\u7684\u65b9\u5f0f\u90e8\u7f72\u548c\u5347\u7ea7Prometheus\u8fc7\u7a0b\u7e41\u7410\u5e76\u4e14\u6548\u7387\u4f4e\u4e0b\u3002</p> <p>\u4ece\u672c\u8d28\u4e0a\u6765\u8bb2Prometheus\u5c5e\u4e8e\u662f\u5178\u578b\u7684\u6709\u72b6\u6001\u5e94\u7528\uff0c\u800c\u5176\u6709\u5305\u542b\u4e86\u4e00\u4e9b\u81ea\u8eab\u7279\u6709\u7684\u8fd0\u7ef4\u7ba1\u7406\u548c\u914d\u7f6e\u7ba1\u7406\u65b9\u5f0f\u3002\u800c\u8fd9\u4e9b\u90fd\u65e0\u6cd5\u901a\u8fc7Kubernetes\u539f\u751f\u63d0\u4f9b\u7684\u5e94\u7528\u7ba1\u7406\u6982\u5ff5\u5b9e\u73b0\u81ea\u52a8\u5316\u3002\u4e3a\u4e86\u7b80\u5316\u8fd9\u7c7b\u5e94\u7528\u7a0b\u5e8f\u7684\u7ba1\u7406\u590d\u6742\u5ea6\uff0cCoreOS\u7387\u5148\u5f15\u5165\u4e86Operator\u7684\u6982\u5ff5\uff0c\u5e76\u4e14\u9996\u5148\u63a8\u51fa\u4e86\u9488\u5bf9\u5728Kubernetes\u4e0b\u8fd0\u884c\u548c\u7ba1\u7406Etcd\u7684Etcd Operator\u3002\u5e76\u968f\u540e\u63a8\u51fa\u4e86Prometheus Operator\u3002</p>"},{"location":"operator/what-is-prometheus-operator/#prometheus-operator_1","title":"Prometheus Operator\u7684\u5de5\u4f5c\u539f\u7406","text":"<p>\u4ece\u6982\u5ff5\u4e0a\u6765\u8bb2Operator\u5c31\u662f\u9488\u5bf9\u7ba1\u7406\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u7684\uff0c\u5728Kubernetes\u57fa\u672c\u7684Resource\u548cController\u7684\u6982\u5ff5\u4e0a\uff0c\u4ee5\u6269\u5c55Kubernetes api\u7684\u5f62\u5f0f\u3002\u5e2e\u52a9\u7528\u6237\u521b\u5efa\uff0c\u914d\u7f6e\u548c\u7ba1\u7406\u590d\u6742\u7684\u6709\u72b6\u6001\u5e94\u7528\u7a0b\u5e8f\u3002\u4ece\u800c\u5b9e\u73b0\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u7684\u5e38\u89c1\u64cd\u4f5c\u4ee5\u53ca\u8fd0\u7ef4\u81ea\u52a8\u5316\u3002</p> <p>\u5728Kubernetes\u4e2d\u6211\u4eec\u4f7f\u7528Deployment\u3001DamenSet\uff0cStatefulSet\u6765\u7ba1\u7406\u5e94\u7528Workload\uff0c\u4f7f\u7528Service\uff0cIngress\u6765\u7ba1\u7406\u5e94\u7528\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u4f7f\u7528ConfigMap\u548cSecret\u6765\u7ba1\u7406\u5e94\u7528\u914d\u7f6e\u3002\u6211\u4eec\u5728\u96c6\u7fa4\u4e2d\u5bf9\u8fd9\u4e9b\u8d44\u6e90\u7684\u521b\u5efa\uff0c\u66f4\u65b0\uff0c\u5220\u9664\u7684\u52a8\u4f5c\u90fd\u4f1a\u88ab\u8f6c\u6362\u4e3a\u4e8b\u4ef6(Event)\uff0cKubernetes\u7684Controller Manager\u8d1f\u8d23\u76d1\u542c\u8fd9\u4e9b\u4e8b\u4ef6\u5e76\u89e6\u53d1\u76f8\u5e94\u7684\u4efb\u52a1\u6765\u6ee1\u8db3\u7528\u6237\u7684\u671f\u671b\u3002\u8fd9\u79cd\u65b9\u5f0f\u6211\u4eec\u6210\u4e3a\u58f0\u660e\u5f0f\uff0c\u7528\u6237\u53ea\u9700\u8981\u5173\u5fc3\u5e94\u7528\u7a0b\u5e8f\u7684\u6700\u7ec8\u72b6\u6001\uff0c\u5176\u5b83\u7684\u90fd\u901a\u8fc7Kubernetes\u6765\u5e2e\u52a9\u6211\u4eec\u5b8c\u6210\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5927\u5927\u7b80\u5316\u5e94\u7528\u7684\u914d\u7f6e\u7ba1\u7406\u590d\u6742\u5ea6\u3002</p> <p>\u800c\u9664\u4e86\u8fd9\u4e9b\u539f\u751f\u7684Resource\u8d44\u6e90\u4ee5\u5916\uff0cKubernetes\u8fd8\u5141\u8bb8\u7528\u6237\u6dfb\u52a0\u81ea\u5df1\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90(Custom Resource)\u3002\u5e76\u4e14\u901a\u8fc7\u5b9e\u73b0\u81ea\u5b9a\u4e49Controller\u6765\u5b9e\u73b0\u5bf9Kubernetes\u7684\u6269\u5c55\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u662fPrometheus Operator\u7684\u67b6\u6784\u793a\u610f\u56fe\uff1a</p> <p></p> <p>Prometheus\u7684\u672c\u804c\u5c31\u662f\u4e00\u7ec4\u7528\u6237\u81ea\u5b9a\u4e49\u7684CRD\u8d44\u6e90\u4ee5\u53caController\u7684\u5b9e\u73b0\uff0cPrometheus Operator\u8d1f\u8d23\u76d1\u542c\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u53d8\u5316\uff0c\u5e76\u4e14\u6839\u636e\u8fd9\u4e9b\u8d44\u6e90\u7684\u5b9a\u4e49\u81ea\u52a8\u5316\u7684\u5b8c\u6210\u5982Prometheus Server\u81ea\u8eab\u4ee5\u53ca\u914d\u7f6e\u7684\u81ea\u52a8\u5316\u7ba1\u7406\u5de5\u4f5c\u3002</p>"},{"location":"operator/what-is-prometheus-operator/#prometheus-operator_2","title":"Prometheus Operator\u80fd\u505a\u4ec0\u4e48","text":"<p>\u8981\u4e86\u89e3Prometheus Operator\u80fd\u505a\u4ec0\u4e48\uff0c\u5176\u5b9e\u5c31\u662f\u8981\u4e86\u89e3Prometheus Operator\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u54ea\u4e9b\u81ea\u5b9a\u4e49\u7684Kubernetes\u8d44\u6e90\uff0c\u5217\u51fa\u4e86Prometheus Operator\u76ee\u524d\u63d0\u4f9b\u7684\ufe0f4\u7c7b\u8d44\u6e90\uff1a</p> <ul> <li>Prometheus\uff1a\u58f0\u660e\u5f0f\u521b\u5efa\u548c\u7ba1\u7406Prometheus Server\u5b9e\u4f8b\uff1b</li> <li>ServiceMonitor\uff1a\u8d1f\u8d23\u58f0\u660e\u5f0f\u7684\u7ba1\u7406\u76d1\u63a7\u914d\u7f6e\uff1b</li> <li>PrometheusRule\uff1a\u8d1f\u8d23\u58f0\u660e\u5f0f\u7684\u7ba1\u7406\u544a\u8b66\u914d\u7f6e\uff1b</li> <li>Alertmanager\uff1a\u58f0\u660e\u5f0f\u7684\u521b\u5efa\u548c\u7ba1\u7406Alertmanager\u5b9e\u4f8b\u3002</li> </ul> <p>\u7b80\u8a00\u4e4b\uff0cPrometheus Operator\u80fd\u591f\u5e2e\u52a9\u7528\u6237\u81ea\u52a8\u5316\u7684\u521b\u5efa\u4ee5\u53ca\u7ba1\u7406Prometheus Server\u4ee5\u53ca\u5176\u76f8\u5e94\u7684\u914d\u7f6e\u3002</p>"},{"location":"operator/what-is-prometheus-operator/#kubernetesprometheus-operator","title":"\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72Prometheus Operator","text":"<p>\u5728Kubernetes\u4e2d\u5b89\u88c5Prometheus Operator\u975e\u5e38\u7b80\u5355\uff0c\u7528\u6237\u53ef\u4ee5\u4ece\u4ee5\u4e0b\u5730\u5740\u4e2d\u8fc7\u53bbPrometheus Operator\u7684\u6e90\u7801\uff1a</p> <pre><code>git clone https://github.com/coreos/prometheus-operator.git\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u4e3aPromethues Operator\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u547d\u540d\u7a7a\u95f4monitoring\uff1a</p> <pre><code>kubectl create namespace monitoring\n</code></pre> <p>\u7531\u4e8e\u9700\u8981\u5bf9Prometheus Operator\u8fdb\u884cRBAC\u6388\u6743\uff0c\u800c\u9ed8\u8ba4\u7684bundle.yaml\u4e2d\u4f7f\u7528\u4e86default\u547d\u540d\u7a7a\u95f4\uff0c\u56e0\u6b64\uff0c\u5728\u5b89\u88c5Prometheus Operator\u4e4b\u524d\u9700\u8981\u5148\u66ff\u6362\u4e00\u4e0bbundle.yaml\u6587\u4ef6\u4e2d\u6240\u6709namespace\u5b9a\u4e49\uff0c\u7531default\u4fee\u6539\u4e3amonitoring\u3002 \u901a\u8fc7\u8fd0\u884c\u4e00\u4e0b\u547d\u4ee4\u5b89\u88c5Prometheus Operator\u7684Deployment\u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl -n monitoring apply -f bundle.yaml\nclusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created\nclusterrole.rbac.authorization.k8s.io/prometheus-operator created\ndeployment.apps/prometheus-operator created\nserviceaccount/prometheus-operator created\nservice/prometheus-operator created\n</code></pre> <p>Prometheus Operator\u901a\u8fc7Deployment\u7684\u5f62\u5f0f\u8fdb\u884c\u90e8\u7f72\uff0c\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus Operator\u80fd\u591f\u76d1\u542c\u548c\u7ba1\u7406Kubernetes\u8d44\u6e90\u540c\u65f6\u4e5f\u521b\u5efa\u4e86\u5355\u72ec\u7684ServiceAccount\u4ee5\u53ca\u76f8\u5173\u7684\u6388\u6743\u52a8\u4f5c\u3002</p> <p>\u67e5\u770bPrometheus Operator\u90e8\u7f72\u72b6\u6001\uff0c\u4ee5\u786e\u4fdd\u5df2\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>$ kubectl -n monitoring get pods\nNAME                                   READY     STATUS    RESTARTS   AGE\nprometheus-operator-6db8dbb7dd-2hz55   1/1       Running   0          19s\n</code></pre>"},{"location":"promql/","title":"\u7b2c2\u7ae0\uff1a \u63a2\u7d22PromQL","text":"<p>\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u63a2\u79d8Prometheus\u7684\u81ea\u5b9a\u4e49\u67e5\u8be2\u8bed\u8a00PromQL\u3002\u901a\u8fc7PromQL\u7528\u6237\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u5bf9\u76d1\u63a7\u6837\u672c\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\u5206\u6790\uff0cPromQL\u652f\u6301\u5e38\u89c1\u7684\u8fd0\u7b97\u64cd\u4f5c\u7b26\uff0c\u540c\u65f6PromQL\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u5185\u7f6e\u51fd\u6570\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u9ad8\u7ea7\u5904\u7406\u3002\u5f53\u7136\u5728\u5b66\u4e60PromQL\u4e4b\u524d\uff0c\u7528\u6237\u8fd8\u9700\u8981\u4e86\u89e3Prometheus\u7684\u6837\u672c\u6570\u636e\u6a21\u578b\u3002PromQL\u4f5c\u4e3aPrometheus\u7684\u6838\u5fc3\u80fd\u529b\u9664\u4e86\u5b9e\u73b0\u6570\u636e\u7684\u5bf9\u5916\u67e5\u8be2\u548c\u5c55\u73b0\uff0c\u540c\u65f6\u544a\u8b66\u76d1\u63a7\u4e5f\u662f\u4f9d\u8d56PromQL\u5b9e\u73b0\u7684\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>Prometheus\u7684\u6570\u636e\u6a21\u578b</li> <li>Prometheus\u4e2d\u76d1\u63a7\u6307\u6807\u7684\u7c7b\u578b</li> <li>\u6df1\u5165PromQL</li> <li>4\u4e2a\u9ec4\u91d1\u6307\u6807\u548cUSE\u65b9\u6cd5</li> </ul>"},{"location":"promql/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>PromQL\u662fPrometheus\u7684\u6807\u51c6\u67e5\u8be2\u8bed\u53e5\uff0c\u901a\u8fc7\u5f3a\u5927\u7684\u6570\u636e\u7edf\u8ba1\u80fd\u529b\uff0c\u4f7f\u5f97\u5c06\u76d1\u63a7\u6307\u6807\u4e0e\u5b9e\u9645\u4e1a\u52a1\u8fdb\u884c\u5173\u8054\u6210\u4e3a\u53ef\u80fd\u3002\u540c\u65f6\u901a\u8fc7\u5185\u7f6e\u7684\u9884\u6d4b\u51fd\u6570\uff0c\u80fd\u591f\u5e2e\u52a9\u7528\u6237\u5c06\u4f20\u7edf\u7684\u9762\u5411\u7ed3\u679c\u8f6c\u53d8\u4e3a\u9762\u5411\u9884\u6d4b\u7684\u65b9\u5f0f\u3002\u4ece\u800c\u66f4\u6709\u6548\u7684\u4e3a\u4e1a\u52a1\u548c\u7cfb\u7edf\u7684\u6b63\u5e38\u8fd0\u884c\u4fdd\u9a7e\u62a4\u822a\u3002</p>"},{"location":"promql/prometheus-aggr-ops/","title":"PromQL\u805a\u5408\u64cd\u4f5c","text":"<p>Prometheus\u8fd8\u63d0\u4f9b\u4e86\u4e0b\u5217\u5185\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u7b26\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u4f5c\u7528\u57df\u77ac\u65f6\u5411\u91cf\u3002\u53ef\u4ee5\u5c06\u77ac\u65f6\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u5f62\u6210\u4e00\u4e2a\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <ul> <li><code>sum</code> (\u6c42\u548c)</li> <li><code>min</code> (\u6700\u5c0f\u503c)</li> <li><code>max</code> (\u6700\u5927\u503c)</li> <li><code>avg</code> (\u5e73\u5747\u503c)</li> <li><code>stddev</code> (\u6807\u51c6\u5dee)</li> <li><code>stdvar</code> (\u6807\u51c6\u65b9\u5dee)</li> <li><code>count</code> (\u8ba1\u6570)</li> <li><code>count_values</code> (\u5bf9value\u8fdb\u884c\u8ba1\u6570)</li> <li><code>bottomk</code> (\u540en\u6761\u65f6\u5e8f)</li> <li><code>topk</code> (\u524dn\u6761\u65f6\u5e8f)</li> <li><code>quantile</code> (\u5206\u4f4d\u6570)</li> </ul> <p>\u4f7f\u7528\u805a\u5408\u64cd\u4f5c\u7684\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]\n</code></pre> <p>\u5176\u4e2d\u53ea\u6709<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>\u652f\u6301\u53c2\u6570(parameter)\u3002</p> <p>without\u7528\u4e8e\u4ece\u8ba1\u7b97\u7ed3\u679c\u4e2d\u79fb\u9664\u5217\u4e3e\u7684\u6807\u7b7e\uff0c\u800c\u4fdd\u7559\u5176\u5b83\u6807\u7b7e\u3002by\u5219\u6b63\u597d\u76f8\u53cd\uff0c\u7ed3\u679c\u5411\u91cf\u4e2d\u53ea\u4fdd\u7559\u5217\u51fa\u7684\u6807\u7b7e\uff0c\u5176\u4f59\u6807\u7b7e\u5219\u79fb\u9664\u3002\u901a\u8fc7without\u548cby\u53ef\u4ee5\u6309\u7167\u6837\u672c\u7684\u95ee\u9898\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sum(http_requests_total) without (instance)\n</code></pre> <p>\u7b49\u4ef7\u4e8e</p> <pre><code>sum(http_requests_total) by (code,handler,job,method)\n</code></pre> <p>\u5982\u679c\u53ea\u9700\u8981\u8ba1\u7b97\u6574\u4e2a\u5e94\u7528\u7684HTTP\u8bf7\u6c42\u603b\u91cf\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(http_requests_total)\n</code></pre> <p>count_values\u7528\u4e8e\u65f6\u95f4\u5e8f\u5217\u4e2d\u6bcf\u4e00\u4e2a\u6837\u672c\u503c\u51fa\u73b0\u7684\u6b21\u6570\u3002count_values\u4f1a\u4e3a\u6bcf\u4e00\u4e2a\u552f\u4e00\u7684\u6837\u672c\u503c\u8f93\u51fa\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u5e76\u4e14\u6bcf\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7e\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>count_values(\"count\", http_requests_total)\n</code></pre> <p>topk\u548cbottomk\u5219\u7528\u4e8e\u5bf9\u6837\u672c\u503c\u8fdb\u884c\u6392\u5e8f\uff0c\u8fd4\u56de\u5f53\u524d\u6837\u672c\u503c\u524dn\u4f4d\uff0c\u6216\u8005\u540en\u4f4d\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u83b7\u53d6HTTP\u8bf7\u6c42\u6570\u524d5\u4f4d\u7684\u65f6\u5e8f\u6837\u672c\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>topk(5, http_requests_total)\n</code></pre> <p>quantile\u7528\u4e8e\u8ba1\u7b97\u5f53\u524d\u6837\u672c\u6570\u636e\u503c\u7684\u5206\u5e03\u60c5\u51b5quantile(\u03c6, express)\u5176\u4e2d0 \u2264 \u03c6 \u2264 1\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u03c6\u4e3a0.5\u65f6\uff0c\u5373\u8868\u793a\u627e\u5230\u5f53\u524d\u6837\u672c\u6570\u636e\u4e2d\u7684\u4e2d\u4f4d\u6570\uff1a</p> <pre><code>quantile(0.5, http_requests_total)\n</code></pre>"},{"location":"promql/prometheus-metrics-types/","title":"Metric\u7c7b\u578b","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u5e26\u9886\u8bfb\u8005\u4e86\u89e3\u4e86Prometheus\u7684\u5e95\u5c42\u6570\u636e\u6a21\u578b\uff0c\u5728Prometheus\u7684\u5b58\u50a8\u5b9e\u73b0\u4e0a\u6240\u6709\u7684\u76d1\u63a7\u6837\u672c\u90fd\u662f\u4ee5time-series\u7684\u5f62\u5f0f\u4fdd\u5b58\u5728Prometheus\u5185\u5b58\u7684TSDB\uff08\u65f6\u5e8f\u6570\u636e\u5e93\uff09\u4e2d\uff0c\u800ctime-series\u6240\u5bf9\u5e94\u7684\u76d1\u63a7\u6307\u6807(metric)\u4e5f\u662f\u901a\u8fc7labelset\u8fdb\u884c\u552f\u4e00\u547d\u540d\u7684\u3002</p> <p>\u4ece\u5b58\u50a8\u4e0a\u6765\u8bb2\u6240\u6709\u7684\u76d1\u63a7\u6307\u6807metric\u90fd\u662f\u76f8\u540c\u7684\uff0c\u4f46\u662f\u5728\u4e0d\u540c\u7684\u573a\u666f\u4e0b\u8fd9\u4e9bmetric\u53c8\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u5dee\u5f02\u3002 \u4f8b\u5982\uff0c\u5728Node Exporter\u8fd4\u56de\u7684\u6837\u672c\u4e2d\u6307\u6807node_load1\u53cd\u5e94\u7684\u662f\u5f53\u524d\u7cfb\u7edf\u7684\u8d1f\u8f7d\u72b6\u6001\uff0c\u968f\u7740\u65f6\u95f4\u7684\u53d8\u5316\u8fd9\u4e2a\u6307\u6807\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u662f\u5728\u4e0d\u65ad\u53d8\u5316\u7684\u3002\u800c\u6307\u6807node_cpu\u6240\u83b7\u53d6\u5230\u7684\u6837\u672c\u6570\u636e\u5374\u4e0d\u540c\uff0c\u5b83\u662f\u4e00\u4e2a\u6301\u7eed\u589e\u5927\u7684\u503c\uff0c\u56e0\u4e3a\u5176\u53cd\u5e94\u7684\u662fCPU\u7684\u7d2f\u79ef\u4f7f\u7528\u65f6\u95f4\uff0c\u4ece\u7406\u8bba\u4e0a\u8bb2\u53ea\u8981\u7cfb\u7edf\u4e0d\u5173\u673a\uff0c\u8fd9\u4e2a\u503c\u662f\u4f1a\u65e0\u9650\u53d8\u5927\u7684\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u5e2e\u52a9\u7528\u6237\u7406\u89e3\u548c\u533a\u5206\u8fd9\u4e9b\u4e0d\u540c\u76d1\u63a7\u6307\u6807\u4e4b\u95f4\u7684\u5dee\u5f02\uff0cPrometheus\u5b9a\u4e49\u4e864\u79cd\u4e0d\u540c\u7684\u6307\u6807\u7c7b\u578b(metric type)\uff1aCounter\uff08\u8ba1\u6570\u5668\uff09\u3001Gauge\uff08\u4eea\u8868\u76d8\uff09\u3001Histogram\uff08\u76f4\u65b9\u56fe\uff09\u3001Summary\uff08\u6458\u8981\uff09\u3002</p> <p>\u5728Exporter\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u5176\u6ce8\u91ca\u4e2d\u4e5f\u5305\u542b\u4e86\u8be5\u6837\u672c\u7684\u7c7b\u578b\u3002\u4f8b\u5982\uff1a</p> <pre><code># HELP node_cpu Seconds the cpus spent in each mode.\n# TYPE node_cpu counter\nnode_cpu{cpu=\"cpu0\",mode=\"idle\"} 362812.7890625\n</code></pre>"},{"location":"promql/prometheus-metrics-types/#counter","title":"Counter\uff1a\u53ea\u589e\u4e0d\u51cf\u7684\u8ba1\u6570\u5668","text":"<p>Counter\u7c7b\u578b\u7684\u6307\u6807\u5176\u5de5\u4f5c\u65b9\u5f0f\u548c\u8ba1\u6570\u5668\u4e00\u6837\uff0c\u53ea\u589e\u4e0d\u51cf\uff08\u9664\u975e\u7cfb\u7edf\u53d1\u751f\u91cd\u7f6e\uff09\u3002\u5e38\u89c1\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5982http_requests_total\uff0cnode_cpu\u90fd\u662fCounter\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u3002 \u4e00\u822c\u5728\u5b9a\u4e49Counter\u7c7b\u578b\u6307\u6807\u7684\u540d\u79f0\u65f6\u63a8\u8350\u4f7f\u7528_total\u4f5c\u4e3a\u540e\u7f00\u3002</p> <p>Counter\u662f\u4e00\u4e2a\u7b80\u5355\u4f46\u6709\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8bb0\u5f55\u67d0\u4e9b\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\uff0c\u901a\u8fc7\u4ee5\u65f6\u5e8f\u7684\u5f62\u5f0f\u5b58\u50a8\u8fd9\u4e9b\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u8f7b\u677e\u7684\u4e86\u89e3\u8be5\u4e8b\u4ef6\u4ea7\u751f\u901f\u7387\u7684\u53d8\u5316\u3002 PromQL\u5185\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u548c\u51fd\u6570\u53ef\u4ee5\u8ba9\u7528\u6237\u5bf9\u8fd9\u4e9b\u6570\u636e\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5206\u6790\uff1a</p> <p>\u4f8b\u5982\uff0c\u901a\u8fc7rate()\u51fd\u6570\u83b7\u53d6HTTP\u8bf7\u6c42\u91cf\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>rate(http_requests_total[5m])\n</code></pre> <p>\u67e5\u8be2\u5f53\u524d\u7cfb\u7edf\u4e2d\uff0c\u8bbf\u95ee\u91cf\u524d10\u7684HTTP\u5730\u5740\uff1a</p> <pre><code>topk(10, http_requests_total)\n</code></pre>"},{"location":"promql/prometheus-metrics-types/#gauge","title":"Gauge\uff1a\u53ef\u589e\u53ef\u51cf\u7684\u4eea\u8868\u76d8","text":"<p>\u4e0eCounter\u4e0d\u540c\uff0cGauge\u7c7b\u578b\u7684\u6307\u6807\u4fa7\u91cd\u4e8e\u53cd\u5e94\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u3002\u56e0\u6b64\u8fd9\u7c7b\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u53ef\u589e\u53ef\u51cf\u3002\u5e38\u89c1\u6307\u6807\u5982\uff1anode_memory_MemFree\uff08\u4e3b\u673a\u5f53\u524d\u7a7a\u95f2\u7684\u5185\u5b58\u5927\u5c0f\uff09\u3001node_memory_MemAvailable\uff08\u53ef\u7528\u5185\u5b58\u5927\u5c0f\uff09\u90fd\u662fGauge\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u901a\u8fc7Gauge\u6307\u6807\uff0c\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\uff1a</p> <pre><code>node_memory_MemFree\n</code></pre> <p>\u5bf9\u4e8eGauge\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u901a\u8fc7PromQL\u5185\u7f6e\u51fd\u6570delta()\u53ef\u4ee5\u83b7\u53d6\u6837\u672c\u5728\u4e00\u6bb5\u65f6\u95f4\u8fd4\u56de\u5185\u7684\u53d8\u5316\u60c5\u51b5\u3002\u4f8b\u5982\uff0c\u8ba1\u7b97CPU\u6e29\u5ea6\u5728\u4e24\u4e2a\u5c0f\u65f6\u5185\u7684\u5dee\u5f02\uff1a</p> <pre><code>delta(cpu_temp_celsius{host=\"zeus\"}[2h])\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u4f7f\u7528deriv()\u8ba1\u7b97\u6837\u672c\u7684\u7ebf\u6027\u56de\u5f52\u6a21\u578b\uff0c\u751a\u81f3\u662f\u76f4\u63a5\u4f7f\u7528predict_linear()\u5bf9\u6570\u636e\u7684\u53d8\u5316\u8d8b\u52bf\u8fdb\u884c\u9884\u6d4b\u3002\u4f8b\u5982\uff0c\u9884\u6d4b\u7cfb\u7edf\u78c1\u76d8\u7a7a\u95f4\u57284\u4e2a\u5c0f\u65f6\u4e4b\u540e\u7684\u5269\u4f59\u60c5\u51b5\uff1a</p> <pre><code>predict_linear(node_filesystem_free{job=\"node\"}[1h], 4 * 3600)\n</code></pre>"},{"location":"promql/prometheus-metrics-types/#histogramsummary","title":"\u4f7f\u7528Histogram\u548cSummary\u5206\u6790\u6570\u636e\u5206\u5e03\u60c5\u51b5","text":"<p>\u9664\u4e86Counter\u548cGauge\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u4ee5\u5916\uff0cPrometheus\u8fd8\u5b9a\u4e49\u4e86Histogram\u548cSummary\u7684\u6307\u6807\u7c7b\u578b\u3002Histogram\u548cSummary\u4e3b\u8981\u7528\u4e8e\u7edf\u8ba1\u548c\u5206\u6790\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002</p> <p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u4eba\u4eec\u90fd\u503e\u5411\u4e8e\u4f7f\u7528\u67d0\u4e9b\u91cf\u5316\u6307\u6807\u7684\u5e73\u5747\u503c\uff0c\u4f8b\u5982CPU\u7684\u5e73\u5747\u4f7f\u7528\u7387\u3001\u9875\u9762\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u3002\u8fd9\u79cd\u65b9\u5f0f\u7684\u95ee\u9898\u5f88\u660e\u663e\uff0c\u4ee5\u7cfb\u7edfAPI\u8c03\u7528\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u4e3a\u4f8b\uff1a\u5982\u679c\u5927\u591a\u6570API\u8bf7\u6c42\u90fd\u7ef4\u6301\u5728100ms\u7684\u54cd\u5e94\u65f6\u95f4\u8303\u56f4\u5185\uff0c\u800c\u4e2a\u522b\u8bf7\u6c42\u7684\u54cd\u5e94\u65f6\u95f4\u9700\u89815s\uff0c\u90a3\u4e48\u5c31\u4f1a\u5bfc\u81f4\u67d0\u4e9bWEB\u9875\u9762\u7684\u54cd\u5e94\u65f6\u95f4\u843d\u5230\u4e2d\u4f4d\u6570\u7684\u60c5\u51b5\uff0c\u800c\u8fd9\u79cd\u73b0\u8c61\u88ab\u79f0\u4e3a\u957f\u5c3e\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u533a\u5206\u662f\u5e73\u5747\u7684\u6162\u8fd8\u662f\u957f\u5c3e\u7684\u6162\uff0c\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u6309\u7167\u8bf7\u6c42\u5ef6\u8fdf\u7684\u8303\u56f4\u8fdb\u884c\u5206\u7ec4\u3002\u4f8b\u5982\uff0c\u7edf\u8ba1\u5ef6\u8fdf\u57280~10ms\u4e4b\u95f4\u7684\u8bf7\u6c42\u6570\u6709\u591a\u5c11\u800c10~20ms\u4e4b\u95f4\u7684\u8bf7\u6c42\u6570\u53c8\u6709\u591a\u5c11\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5feb\u901f\u5206\u6790\u7cfb\u7edf\u6162\u7684\u539f\u56e0\u3002Histogram\u548cSummary\u90fd\u662f\u4e3a\u4e86\u80fd\u591f\u89e3\u51b3\u8fd9\u6837\u95ee\u9898\u7684\u5b58\u5728\uff0c\u901a\u8fc7Histogram\u548cSummary\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u76d1\u63a7\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002 </p> <p>\u4f8b\u5982\uff0c\u6307\u6807prometheus_tsdb_wal_fsync_duration_seconds\u7684\u6307\u6807\u7c7b\u578b\u4e3aSummary\u3002 \u5b83\u8bb0\u5f55\u4e86Prometheus Server\u4e2dwal_fsync\u5904\u7406\u7684\u5904\u7406\u65f6\u95f4\uff0c\u901a\u8fc7\u8bbf\u95eePrometheus Server\u7684/metrics\u5730\u5740\uff0c\u53ef\u4ee5\u83b7\u53d6\u5230\u4ee5\u4e0b\u76d1\u63a7\u6837\u672c\u6570\u636e\uff1a</p> <pre><code># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.\n# TYPE prometheus_tsdb_wal_fsync_duration_seconds summary\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.5\"} 0.012352463\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.9\"} 0.014458005\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"0.99\"} 0.017316173\nprometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002\nprometheus_tsdb_wal_fsync_duration_seconds_count 216\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u6837\u672c\u4e2d\u53ef\u4ee5\u5f97\u77e5\u5f53\u524dPrometheus Server\u8fdb\u884cwal_fsync\u64cd\u4f5c\u7684\u603b\u6b21\u6570\u4e3a216\u6b21\uff0c\u8017\u65f62.888716127000002s\u3002\u5176\u4e2d\u4e2d\u4f4d\u6570\uff08quantile=0.5\uff09\u7684\u8017\u65f6\u4e3a0.012352463\uff0c9\u5206\u4f4d\u6570\uff08quantile=0.9\uff09\u7684\u8017\u65f6\u4e3a0.014458005s\u3002</p> <p>\u5728Prometheus Server\u81ea\u8eab\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u6211\u4eec\u8fd8\u80fd\u627e\u5230\u7c7b\u578b\u4e3aHistogram\u7684\u76d1\u63a7\u6307\u6807prometheus_tsdb_compaction_chunk_range_bucket\u3002</p> <pre><code># HELP prometheus_tsdb_compaction_chunk_range Final time range of chunks on their first compaction\n# TYPE prometheus_tsdb_compaction_chunk_range histogram\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"100\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"400\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"1600\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"6400\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"25600\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"102400\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"409600\"} 0\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"1.6384e+06\"} 260\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"6.5536e+06\"} 780\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"2.62144e+07\"} 780\nprometheus_tsdb_compaction_chunk_range_bucket{le=\"+Inf\"} 780\nprometheus_tsdb_compaction_chunk_range_sum 1.1540798e+09\nprometheus_tsdb_compaction_chunk_range_count 780\n</code></pre> <p>\u4e0eSummary\u7c7b\u578b\u7684\u6307\u6807\u76f8\u4f3c\u4e4b\u5904\u5728\u4e8eHistogram\u7c7b\u578b\u7684\u6837\u672c\u540c\u6837\u4f1a\u53cd\u5e94\u5f53\u524d\u6307\u6807\u7684\u8bb0\u5f55\u7684\u603b\u6570(\u4ee5_count\u4f5c\u4e3a\u540e\u7f00)\u4ee5\u53ca\u5176\u503c\u7684\u603b\u91cf\uff08\u4ee5_sum\u4f5c\u4e3a\u540e\u7f00\uff09\u3002\u4e0d\u540c\u5728\u4e8eHistogram\u6307\u6807\u76f4\u63a5\u53cd\u5e94\u4e86\u5728\u4e0d\u540c\u533a\u95f4\u5185\u6837\u672c\u7684\u4e2a\u6570\uff0c\u533a\u95f4\u901a\u8fc7\u6807\u7b7elen\u8fdb\u884c\u5b9a\u4e49\u3002</p> <p>\u540c\u65f6\u5bf9\u4e8eHistogram\u7684\u6307\u6807\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7histogram_quantile()\u51fd\u6570\u8ba1\u7b97\u51fa\u5176\u503c\u7684\u5206\u4f4d\u6570\u3002\u4e0d\u540c\u5728\u4e8eHistogram\u901a\u8fc7histogram_quantile\u51fd\u6570\u662f\u5728\u670d\u52a1\u5668\u7aef\u8ba1\u7b97\u7684\u5206\u4f4d\u6570\u3002 \u800cSumamry\u7684\u5206\u4f4d\u6570\u5219\u662f\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u8ba1\u7b97\u5b8c\u6210\u3002\u56e0\u6b64\u5bf9\u4e8e\u5206\u4f4d\u6570\u7684\u8ba1\u7b97\u800c\u8a00\uff0cSummary\u5728\u901a\u8fc7PromQL\u8fdb\u884c\u67e5\u8be2\u65f6\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\uff0c\u800cHistogram\u5219\u4f1a\u6d88\u8017\u66f4\u591a\u7684\u8d44\u6e90\u3002\u53cd\u4e4b\u5bf9\u4e8e\u5ba2\u6237\u7aef\u800c\u8a00Histogram\u6d88\u8017\u7684\u8d44\u6e90\u66f4\u5c11\u3002\u5728\u9009\u62e9\u8fd9\u4e24\u79cd\u65b9\u5f0f\u65f6\u7528\u6237\u5e94\u8be5\u6309\u7167\u81ea\u5df1\u7684\u5b9e\u9645\u573a\u666f\u8fdb\u884c\u9009\u62e9\u3002</p>"},{"location":"promql/prometheus-promql-best-praticase/","title":"\u6700\u4f73\u5b9e\u8df5\uff1a4\u4e2a\u9ec4\u91d1\u6307\u6807\u548cUSE\u65b9\u6cd5","text":"<p>\u524d\u9762\u90e8\u5206\u4ecb\u7ecd\u4e86Prometheus\u7684\u6570\u636e\u5b58\u50a8\u6a21\u578b\u4ee5\u53ca4\u79cd\u6307\u6807\u7c7b\u578b\uff0c\u540c\u65f6Prometheus\u63d0\u4f9b\u7684\u5f3a\u5927\u7684PromQL\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u4e2a\u6027\u5316\u5904\u7406\u3002Prometheus\u57fa\u4e8e\u6307\u6807\u63d0\u4f9b\u4e86\u4e00\u4e2a\u901a\u7528\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u3002\u8fd9\u91cc\u5148\u601d\u8003\u4e00\u4e2a\u57fa\u672c\u7684\u95ee\u9898\uff0c\u5728\u5b9e\u73b0\u76d1\u63a7\u65f6\uff0c\u6211\u4eec\u5230\u5e95\u5e94\u8be5\u76d1\u63a7\u54ea\u4e9b\u5bf9\u8c61\u4ee5\u53ca\u54ea\u4e9b\u6307\u6807\uff1f</p>"},{"location":"promql/prometheus-promql-best-praticase/#_1","title":"\u76d1\u63a7\u6240\u6709","text":"<p>\u5728\u4e4b\u524dPrometheus\u7b80\u4ecb\u90e8\u5206\u4ecb\u7ecd\u76d1\u63a7\u7684\u57fa\u672c\u76ee\u6807\uff0c\u9996\u5148\u662f\u53ca\u65f6\u53d1\u73b0\u95ee\u9898\uff0c\u5176\u6b21\u662f\u8981\u80fd\u591f\u5feb\u901f\u5bf9\u95ee\u9898\u8fdb\u884c\u5b9a\u4f4d\u3002\u5bf9\u4e8e\u4f20\u7edf\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u800c\u8a00\uff0c\u7528\u6237\u770b\u5230\u7684\u4f9d\u7136\u662f\u4e00\u4e2a\u9ed1\u76d2\uff0c\u7528\u6237\u65e0\u6cd5\u771f\u6b63\u4e86\u89e3\u7cfb\u7edf\u7684\u771f\u6b63\u7684\u8fd0\u884c\u72b6\u6001\u3002\u56e0\u6b64Prometheus\u9f13\u52b1\u7528\u6237\u76d1\u63a7\u6240\u6709\u7684\u4e1c\u897f\u3002\b\u4e0b\u9762\u5217\u4e3e\u4e00\u4e9b\u5e38\u7528\u7684\u76d1\u63a7\u7ef4\u5ea6\u3002</p> \u7ea7\u522b \u76d1\u63a7\u4ec0\u4e48 Exporter \u7f51\u7edc \u7f51\u7edc\u534f\u8bae\uff1ahttp\u3001dns\u3001tcp\u3001icmp\uff1b\u7f51\u7edc\u786c\u4ef6\uff1a\u8def\u7531\u5668\uff0c\u4ea4\u6362\u673a\u7b49 BlackBox Exporter;SNMP Exporter \u4e3b\u673a \u8d44\u6e90\u7528\u91cf node exporter \u5bb9\u5668 \u8d44\u6e90\u7528\u91cf cAdvisor \u5e94\u7528(\u5305\u62ecLibrary) \u5ef6\u8fdf\uff0c\u9519\u8bef\uff0cQPS\uff0c\u5185\u90e8\u72b6\u6001\u7b49 \u4ee3\u7801\u4e2d\u96c6\u6210Prmometheus Client \u4e2d\u95f4\u4ef6\u72b6\u6001 \u8d44\u6e90\u7528\u91cf\uff0c\u4ee5\u53ca\u670d\u52a1\u72b6\u6001 \u4ee3\u7801\u4e2d\u96c6\u6210Prmometheus Client \u7f16\u6392\u5de5\u5177 \u96c6\u7fa4\u8d44\u6e90\u7528\u91cf\uff0c\u8c03\u5ea6\u7b49 Kubernetes Components"},{"location":"promql/prometheus-promql-best-praticase/#_2","title":"\u76d1\u63a7\u6a21\u5f0f","text":"<p>\u9664\u4e86\u4e0a\u8ff0\u4ecb\u7ecd\u7684\u4e0d\u540c\u76d1\u63a7\u7ea7\u522b\u4ee5\u5916\u3002\u5b9e\u9645\u4e0a\u6839\u636e\u4e0d\u540c\u7684\u7cfb\u7edf\u7c7b\u578b\u548c\u76ee\u6807\uff0c\u8fd9\u91cc\u8fd8\u6709\u4e00\u4e9b\u901a\u7528\u7684\u5957\u8def\u548c\u6a21\u5f0f\u53ef\u4ee5\u4f7f\u7528\u3002</p>"},{"location":"promql/prometheus-promql-best-praticase/#4","title":"4\u4e2a\u9ec4\u91d1\u6307\u6807","text":"<p>Four Golden Signals\u662fGoogle\u9488\u5bf9\u5927\u91cf\u5206\u5e03\u5f0f\u76d1\u63a7\u7684\u7ecf\u9a8c\u603b\u7ed3\uff0c4\u4e2a\u9ec4\u91d1\u6307\u6807\u53ef\u4ee5\u5728\u670d\u52a1\u7ea7\u522b\u5e2e\u52a9\u8861\u91cf\u7ec8\u7aef\u7528\u6237\u4f53\u9a8c\u3001\u670d\u52a1\u4e2d\u65ad\u3001\u4e1a\u52a1\u5f71\u54cd\u7b49\u5c42\u9762\u7684\u95ee\u9898\u3002\u4e3b\u8981\u5173\u6ce8\u4e0e\u4ee5\u4e0b\u56db\u79cd\u7c7b\u578b\u7684\u6307\u6807\uff1a\u5ef6\u8fdf\uff0c\u901a\u8baf\u91cf\uff0c\u9519\u8bef\u4ee5\u53ca\u9971\u548c\u5ea6\uff1a</p> <ul> <li>\u5ef6\u8fdf\uff1a\u670d\u52a1\u8bf7\u6c42\u6240\u9700\u65f6\u95f4\u3002</li> </ul> <p>\u8bb0\u5f55\u7528\u6237\u6240\u6709\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\uff0c\u91cd\u70b9\u662f\u8981\u533a\u5206\u6210\u529f\u8bf7\u6c42\u7684\u5ef6\u8fdf\u65f6\u95f4\u548c\u5931\u8d25\u8bf7\u6c42\u7684\u5ef6\u8fdf\u65f6\u95f4\u3002 \u4f8b\u5982\u5728\u6570\u636e\u5e93\u6216\u8005\u5176\u4ed6\u5173\u952e\u7978\u7aef\u670d\u52a1\u5f02\u5e38\u89e6\u53d1HTTP 500\u7684\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u4e5f\u53ef\u80fd\u4f1a\u5f88\u5feb\u5f97\u5230\u8bf7\u6c42\u5931\u8d25\u7684\u54cd\u5e94\u5185\u5bb9\uff0c\u5982\u679c\u4e0d\u52a0\u533a\u5206\u8ba1\u7b97\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5ef6\u8fdf\uff0c\u53ef\u80fd\u5bfc\u81f4\u8ba1\u7b97\u7ed3\u679c\u4e0e\u5b9e\u9645\u7ed3\u679c\u4ea7\u751f\u5de8\u5927\u7684\u5dee\u5f02\u3002\u9664\u6b64\u4ee5\u5916\uff0c\u5728\u5fae\u670d\u52a1\u4e2d\u901a\u5e38\u63d0\u5021\u201c\u5feb\u901f\u5931\u8d25\u201d\uff0c\u5f00\u53d1\u4eba\u5458\u9700\u8981\u7279\u522b\u6ce8\u610f\u8fd9\u4e9b\u5ef6\u8fdf\u8f83\u5927\u7684\u9519\u8bef\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u7f13\u6162\u7684\u9519\u8bef\u4f1a\u660e\u663e\u5f71\u54cd\u7cfb\u7edf\u7684\u6027\u80fd\uff0c\u56e0\u6b64\u8ffd\u8e2a\u8fd9\u4e9b\u9519\u8bef\u7684\u5ef6\u8fdf\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <ul> <li>\u901a\u8baf\u91cf\uff1a\u76d1\u63a7\u5f53\u524d\u7cfb\u7edf\u7684\u6d41\u91cf\uff0c\u7528\u4e8e\u8861\u91cf\u670d\u52a1\u7684\u5bb9\u91cf\u9700\u6c42\u3002</li> </ul> <p>\u6d41\u91cf\u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u7cfb\u7edf\u800c\u8a00\u53ef\u80fd\u4ee3\u8868\u4e0d\u540c\u7684\u542b\u4e49\u3002\u4f8b\u5982\uff0c\u5728HTTP REST API\u4e2d, \u6d41\u91cf\u901a\u5e38\u662f\u6bcf\u79d2HTTP\u8bf7\u6c42\u6570\uff1b</p> <ul> <li>\u9519\u8bef\uff1a\u76d1\u63a7\u5f53\u524d\u7cfb\u7edf\u6240\u6709\u53d1\u751f\u7684\u9519\u8bef\u8bf7\u6c42\uff0c\u8861\u91cf\u5f53\u524d\u7cfb\u7edf\u9519\u8bef\u53d1\u751f\u7684\u901f\u7387\u3002</li> </ul> <p>\u5bf9\u4e8e\u5931\u8d25\u800c\u8a00\u6709\u4e9b\u662f\u663e\u5f0f\u7684(\u6bd4\u5982, HTTP 500\u9519\u8bef)\uff0c\u800c\u6709\u4e9b\u662f\u9690\u5f0f(\u6bd4\u5982\uff0cHTTP\u54cd\u5e94200\uff0c\u4f46\u5b9e\u9645\u4e1a\u52a1\u6d41\u7a0b\u4f9d\u7136\u662f\u5931\u8d25\u7684)\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e9b\u663e\u5f0f\u7684\u9519\u8bef\u5982HTTP 500\u53ef\u4ee5\u901a\u8fc7\u5728\u8d1f\u8f7d\u5747\u8861\u5668(\u5982Nginx)\u4e0a\u8fdb\u884c\u6355\u83b7\uff0c\u800c\u5bf9\u4e8e\u4e00\u4e9b\u7cfb\u7edf\u5185\u90e8\u7684\u5f02\u5e38\uff0c\u5219\u53ef\u80fd\u9700\u8981\u76f4\u63a5\u4ece\u670d\u52a1\u4e2d\u6dfb\u52a0\u94a9\u5b50\u7edf\u8ba1\u5e76\u8fdb\u884c\u83b7\u53d6\u3002</p> <ul> <li>\u9971\u548c\u5ea6\uff1a\u8861\u91cf\u5f53\u524d\u670d\u52a1\u7684\u9971\u548c\u5ea6\u3002</li> </ul> <p>\u4e3b\u8981\u5f3a\u8c03\u6700\u80fd\u5f71\u54cd\u670d\u52a1\u72b6\u6001\u7684\u53d7\u9650\u5236\u7684\u8d44\u6e90\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u7cfb\u7edf\u4e3b\u8981\u53d7\u5185\u5b58\u5f71\u54cd\uff0c\u90a3\u5c31\u4e3b\u8981\u5173\u6ce8\u7cfb\u7edf\u7684\u5185\u5b58\u72b6\u6001\uff0c\u5982\u679c\u7cfb\u7edf\u4e3b\u8981\u53d7\u9650\u4e8e\u78c1\u76d8I/O\uff0c\u90a3\u5c31\u4e3b\u8981\u89c2\u6d4b\u78c1\u76d8I/O\u7684\u72b6\u6001\u3002\u56e0\u4e3a\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u5f53\u8fd9\u4e9b\u8d44\u6e90\u8fbe\u5230\u9971\u548c\u540e\uff0c\u670d\u52a1\u7684\u6027\u80fd\u4f1a\u660e\u663e\u4e0b\u964d\u3002\u540c\u65f6\u8fd8\u53ef\u4ee5\u5229\u7528\u9971\u548c\u5ea6\u5bf9\u7cfb\u7edf\u505a\u51fa\u9884\u6d4b\uff0c\u6bd4\u5982\uff0c\u201c\u78c1\u76d8\u662f\u5426\u53ef\u80fd\u57284\u4e2a\u5c0f\u65f6\u5019\u5c31\u6ee1\u4e86\u201d\u3002</p>"},{"location":"promql/prometheus-promql-best-praticase/#red","title":"RED\u65b9\u6cd5","text":"<p>RED\u65b9\u6cd5\u662fWeave Cloud\u5728\u57fa\u4e8eGoogle\u7684\u201c4\u4e2a\u9ec4\u91d1\u6307\u6807\u201d\u7684\u539f\u5219\u4e0b\u7ed3\u5408Prometheus\u4ee5\u53caKubernetes\u5bb9\u5668\u5b9e\u8df5\uff0c\u7ec6\u5316\u548c\u603b\u7ed3\u7684\u65b9\u6cd5\u8bba\uff0c\u7279\u522b\u9002\u5408\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u4ee5\u53ca\u5fae\u670d\u52a1\u67b6\u6784\u5e94\u7528\u7684\u76d1\u63a7\u548c\u5ea6\u91cf\u3002\u4e3b\u8981\u5173\u6ce8\u4ee5\u4e0b\u4e09\u79cd\u5173\u952e\u6307\u6807\uff1a</p> <ul> <li>(\u8bf7\u6c42)\u901f\u7387\uff1a\u670d\u52a1\u6bcf\u79d2\u63a5\u6536\u7684\u8bf7\u6c42\u6570\u3002</li> <li>(\u8bf7\u6c42)\u9519\u8bef\uff1a\u6bcf\u79d2\u5931\u8d25\u7684\u8bf7\u6c42\u6570\u3002</li> <li>(\u8bf7\u6c42)\u8017\u65f6\uff1a\u6bcf\u4e2a\u8bf7\u6c42\u7684\u8017\u65f6\u3002</li> </ul> <p>\u5728\u201c4\u5927\u9ec4\u91d1\u4fe1\u53f7\u201d\u7684\u539f\u5219\u4e0b\uff0cRED\u65b9\u6cd5\u53ef\u4ee5\u6709\u6548\u7684\u5e2e\u52a9\u7528\u6237\u8861\u91cf\u4e91\u539f\u751f\u4ee5\u53ca\u5fae\u670d\u52a1\u5e94\u7528\u4e0b\u7684\u7528\u6237\u4f53\u9a8c\u95ee\u9898\u3002</p>"},{"location":"promql/prometheus-promql-best-praticase/#use","title":"USE\u65b9\u6cd5","text":"<p>USE\u65b9\u6cd5\u5168\u79f0\"Utilization Saturation and Errors Method\"\uff0c\u4e3b\u8981\u7528\u4e8e\u5206\u6790\u7cfb\u7edf\u6027\u80fd\u95ee\u9898\uff0c\u53ef\u4ee5\u6307\u5bfc\u7528\u6237\u5feb\u901f\u8bc6\u522b\u8d44\u6e90\u74f6\u9888\u4ee5\u53ca\u9519\u8bef\u7684\u65b9\u6cd5\u3002\u6b63\u5982USE\u65b9\u6cd5\u7684\u540d\u5b57\u6240\u8868\u793a\u7684\u542b\u4e49\uff0cUSE\u65b9\u6cd5\u4e3b\u8981\u5173\u6ce8\u4e0e\u8d44\u6e90\u7684\uff1a\u4f7f\u7528\u7387(Utilization)\u3001\u9971\u548c\u5ea6(Saturation)\u4ee5\u53ca\u9519\u8bef(Errors)\u3002</p> <ul> <li>\u4f7f\u7528\u7387\uff1a\u5173\u6ce8\u7cfb\u7edf\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\u3002 \u8fd9\u91cc\u7684\u8d44\u6e90\u4e3b\u8981\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\uff1aCPU\uff0c\u5185\u5b58\uff0c\u7f51\u7edc\uff0c\u78c1\u76d8\u7b49\u7b49\u3002100%\u7684\u4f7f\u7528\u7387\u901a\u5e38\u662f\u7cfb\u7edf\u6027\u80fd\u74f6\u9888\u7684\u6807\u5fd7\u3002</li> <li>\u9971\u548c\u5ea6\uff1a\u4f8b\u5982CPU\u7684\u5e73\u5747\u8fd0\u884c\u6392\u961f\u957f\u5ea6\uff0c\u8fd9\u91cc\u4e3b\u8981\u662f\u9488\u5bf9\u8d44\u6e90\u7684\u9971\u548c\u5ea6(\u6ce8\u610f\uff0c\u4e0d\u540c\u4e8e4\u5927\u9ec4\u91d1\u4fe1\u53f7)\u3002\u4efb\u4f55\u8d44\u6e90\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u7684\u9971\u548c\u90fd\u53ef\u80fd\u5bfc\u81f4\u7cfb\u7edf\u6027\u80fd\u7684\u4e0b\u964d\u3002</li> <li>\u9519\u8bef\uff1a\u9519\u8bef\u8ba1\u6570\u3002\u4f8b\u5982\uff1a\u201c\u7f51\u5361\u5728\u6570\u636e\u5305\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u68c0\u6d4b\u5230\u7684\u4ee5\u592a\u7f51\u7f51\u7edc\u51b2\u7a81\u4e8614\u6b21\u201d\u3002</li> </ul> <p>\u901a\u8fc7\u5bf9\u8d44\u6e90\u4ee5\u4e0a\u6307\u6807\u6301\u7eed\u89c2\u5bdf\uff0c\u901a\u8fc7\u4ee5\u4e0b\u6d41\u7a0b\u53ef\u4ee5\u77e5\u9053\u7528\u6237\u8bc6\u522b\u8d44\u6e90\u74f6\u9888\uff1a</p> <p></p>"},{"location":"promql/prometheus-promql-functions/","title":"PromQL\u5185\u7f6e\u51fd\u6570","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u770b\u5230\u4e86\u7c7b\u4f3c\u4e8eirate()\u8fd9\u6837\u7684\u51fd\u6570\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8ba1\u7b97\u76d1\u63a7\u6307\u6807\u7684\u589e\u957f\u7387\u3002\u9664\u4e86irate\u4ee5\u5916\uff0cPrometheus\u8fd8\u63d0\u4f9b\u4e86\u5176\u5b83\u5927\u91cf\u7684\u5185\u7f6e\u51fd\u6570\uff0c\u53ef\u4ee5\u5bf9\u65f6\u5e8f\u6570\u636e\u8fdb\u884c\u4e30\u5bcc\u7684\u5904\u7406\u3002\u672c\u5c0f\u8282\u5c06\u5e26\u8bfb\u8005\u4e86\u89e3\u4e00\u4e9b\u5e38\u7528\u7684\u5185\u7f6e\u51fd\u6570\u4ee5\u53ca\u76f8\u5173\u7684\u4f7f\u7528\u573a\u666f\u548c\u7528\u6cd5\u3002</p>"},{"location":"promql/prometheus-promql-functions/#counter","title":"\u8ba1\u7b97Counter\u6307\u6807\u589e\u957f\u7387","text":"<p>\u6211\u4eec\u77e5\u9053Counter\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u5176\u7279\u70b9\u662f\u53ea\u589e\u4e0d\u51cf\uff0c\u5728\u6ca1\u6709\u53d1\u751f\u91cd\u7f6e\uff08\u5982\u670d\u52a1\u5668\u91cd\u542f\uff0c\u5e94\u7528\u91cd\u542f\uff09\u7684\u60c5\u51b5\u4e0b\u5176\u6837\u672c\u503c\u5e94\u8be5\u662f\u4e0d\u65ad\u589e\u5927\u7684\u3002\u4e3a\u4e86\u80fd\u591f\u66f4\u76f4\u89c2\u7684\u8868\u793a\u6837\u672c\u6570\u636e\u7684\u53d8\u5316\u5267\u70c8\u60c5\u51b5\uff0c\u9700\u8981\u8ba1\u7b97\u6837\u672c\u7684\u589e\u957f\u901f\u7387\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6837\u672c\u589e\u957f\u7387\u53cd\u6620\u51fa\u4e86\u6837\u672c\u53d8\u5316\u7684\u5267\u70c8\u7a0b\u5ea6\uff1a</p> <p></p> <p>increase(v range-vector)\u51fd\u6570\u662fPromQL\u4e2d\u63d0\u4f9b\u7684\u4f17\u591a\u5185\u7f6e\u51fd\u6570\u4e4b\u4e00\u3002\u5176\u4e2d\u53c2\u6570v\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0cincrease\u51fd\u6570\u83b7\u53d6\u533a\u95f4\u5411\u91cf\u4e2d\u7684\u7b2c\u4e00\u4e2a\u540e\u6700\u540e\u4e00\u4e2a\u6837\u672c\u5e76\u8fd4\u56de\u5176\u589e\u957f\u91cf\u3002\u56e0\u6b64\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u8868\u8fbe\u5f0fCounter\u7c7b\u578b\u6307\u6807\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>increase(node_cpu[2m]) / 120\n</code></pre> <p>\u8fd9\u91cc\u901a\u8fc7node_cpu[2m]\u83b7\u53d6\u65f6\u95f4\u5e8f\u5217\u6700\u8fd1\u4e24\u5206\u949f\u7684\u6240\u6709\u6837\u672c\uff0cincrease\u8ba1\u7b97\u51fa\u6700\u8fd1\u4e24\u5206\u949f\u7684\u589e\u957f\u91cf\uff0c\u6700\u540e\u9664\u4ee5\u65f6\u95f4120\u79d2\u5f97\u5230node_cpu\u6837\u672c\u5728\u6700\u8fd1\u4e24\u5206\u949f\u7684\u5e73\u5747\u589e\u957f\u7387\u3002\u5e76\u4e14\u8fd9\u4e2a\u503c\u4e5f\u8fd1\u4f3c\u4e8e\u4e3b\u673a\u8282\u70b9\u6700\u8fd1\u4e24\u5206\u949f\u5185\u7684\u5e73\u5747CPU\u4f7f\u7528\u7387\u3002</p> <p>\u9664\u4e86\u4f7f\u7528increase\u51fd\u6570\u4ee5\u5916\uff0cPromQL\u4e2d\u8fd8\u76f4\u63a5\u5185\u7f6e\u4e86rate(v range-vector)\u51fd\u6570\uff0crate\u51fd\u6570\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u533a\u95f4\u5411\u91cfv\u5728\u65f6\u95f4\u7a97\u53e3\u5185\u5e73\u5747\u589e\u957f\u901f\u7387\u3002\u56e0\u6b64\uff0c\u901a\u8fc7\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u53ef\u4ee5\u5f97\u5230\u4e0eincrease\u51fd\u6570\u76f8\u540c\u7684\u7ed3\u679c\uff1a</p> <pre><code>rate(node_cpu[2m])\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u4f7f\u7528rate\u6216\u8005increase\u51fd\u6570\u53bb\u8ba1\u7b97\u6837\u672c\u7684\u5e73\u5747\u589e\u957f\u901f\u7387\uff0c\u5bb9\u6613\u9677\u5165\u201c\u957f\u5c3e\u95ee\u9898\u201d\u5f53\u4e2d\uff0c\u5176\u65e0\u6cd5\u53cd\u5e94\u5728\u65f6\u95f4\u7a97\u53e3\u5185\u6837\u672c\u6570\u636e\u7684\u7a81\u53d1\u53d8\u5316\u3002 \u4f8b\u5982\uff0c\u5bf9\u4e8e\u4e3b\u673a\u800c\u8a00\u57282\u5206\u949f\u7684\u65f6\u95f4\u7a97\u53e3\u5185\uff0c\u53ef\u80fd\u5728\u67d0\u4e00\u4e2a\u7531\u4e8e\u8bbf\u95ee\u91cf\u6216\u8005\u5176\u5b83\u95ee\u9898\u5bfc\u81f4CPU\u5360\u7528100%\u7684\u60c5\u51b5\uff0c\u4f46\u662f\u901a\u8fc7\u8ba1\u7b97\u5728\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u5e73\u5747\u589e\u957f\u7387\u5374\u65e0\u6cd5\u53cd\u5e94\u51fa\u8be5\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8be5\u95ee\u9898\uff0cPromQL\u63d0\u4f9b\u4e86\u53e6\u5916\u4e00\u4e2a\u7075\u654f\u5ea6\u66f4\u9ad8\u7684\u51fd\u6570irate(v range-vector)\u3002irate\u540c\u6837\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u8ba1\u7b97\u7387\uff0c\u4f46\u662f\u5176\u53cd\u5e94\u51fa\u7684\u662f\u77ac\u65f6\u589e\u957f\u7387\u3002irate\u51fd\u6570\u662f\u901a\u8fc7\u533a\u95f4\u5411\u91cf\u4e2d\u6700\u540e\u4e24\u4e2a\u6837\u672c\u6570\u636e\u6765\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u901f\u7387\u3002\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u5728\u65f6\u95f4\u7a97\u53e3\u8303\u56f4\u5185\u7684\u201c\u957f\u5c3e\u95ee\u9898\u201d\uff0c\u5e76\u4e14\u4f53\u73b0\u51fa\u66f4\u597d\u7684\u7075\u654f\u5ea6\uff0c\u901a\u8fc7irate\u51fd\u6570\u7ed8\u5236\u7684\u56fe\u6807\u80fd\u591f\u66f4\u597d\u7684\u53cd\u5e94\u6837\u672c\u6570\u636e\u7684\u77ac\u65f6\u53d8\u5316\u72b6\u6001\u3002</p> <pre><code>irate(node_cpu[2m])\n</code></pre> <p>irate\u51fd\u6570\u76f8\u6bd4\u4e8erate\u51fd\u6570\u63d0\u4f9b\u4e86\u66f4\u9ad8\u7684\u7075\u654f\u5ea6\uff0c\u4e0d\u8fc7\u5f53\u9700\u8981\u5206\u6790\u957f\u671f\u8d8b\u52bf\u6216\u8005\u5728\u544a\u8b66\u89c4\u5219\u4e2d\uff0cirate\u7684\u8fd9\u79cd\u7075\u654f\u5ea6\u53cd\u800c\u5bb9\u6613\u9020\u6210\u5e72\u6270\u3002\u56e0\u6b64\u5728\u957f\u671f\u8d8b\u52bf\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u8350\u4f7f\u7528rate\u51fd\u6570\u3002</p>"},{"location":"promql/prometheus-promql-functions/#gauge","title":"\u9884\u6d4bGauge\u6307\u6807\u53d8\u5316\u8d8b\u52bf","text":"<p>\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u7ba1\u7406\u5458\u4e3a\u4e86\u786e\u4fdd\u4e1a\u52a1\u7684\u6301\u7eed\u53ef\u7528\u8fd0\u884c\uff0c\u4f1a\u9488\u5bf9\u670d\u52a1\u5668\u7684\u8d44\u6e90\u8bbe\u7f6e\u76f8\u5e94\u7684\u544a\u8b66\u9608\u503c\u3002\u4f8b\u5982\uff0c\u5f53\u78c1\u76d8\u7a7a\u95f4\u53ea\u5269512MB\u65f6\u5411\u76f8\u5173\u4eba\u5458\u53d1\u9001\u544a\u8b66\u901a\u77e5\u3002 \u8fd9\u79cd\u57fa\u4e8e\u9608\u503c\u7684\u544a\u8b66\u6a21\u5f0f\u5bf9\u4e8e\u5f53\u8d44\u6e90\u7528\u91cf\u662f\u5e73\u6ed1\u589e\u957f\u7684\u60c5\u51b5\u4e0b\u662f\u80fd\u591f\u6709\u6548\u7684\u5de5\u4f5c\u7684\u3002 \u4f46\u662f\u5982\u679c\u8d44\u6e90\u4e0d\u662f\u5e73\u6ed1\u53d8\u5316\u7684\u5462\uff1f \u6bd4\u5982\u6709\u4e9b\u67d0\u4e9b\u4e1a\u52a1\u589e\u957f\uff0c\u5b58\u50a8\u7a7a\u95f4\u7684\u589e\u957f\u901f\u7387\u63d0\u5347\u4e86\u597d\u51e0\u500d\u3002\u8fd9\u65f6\uff0c\u5982\u679c\u57fa\u4e8e\u539f\u6709\u9608\u503c\u53bb\u89e6\u53d1\u544a\u8b66\uff0c\u5f53\u7cfb\u7edf\u7ba1\u7406\u5458\u63a5\u6536\u5230\u544a\u8b66\u4ee5\u540e\u53ef\u80fd\u8fd8\u6ca1\u6765\u5f97\u53ca\u53bb\u5904\u7406\u95ee\u9898\uff0c\u7cfb\u7edf\u5c31\u5df2\u7ecf\u4e0d\u53ef\u7528\u4e86\u3002 \u56e0\u6b64\u9608\u503c\u901a\u5e38\u6765\u8bf4\u4e0d\u662f\u56fa\u5b9a\u7684\uff0c\u9700\u8981\u5b9a\u671f\u8fdb\u884c\u8c03\u6574\u624d\u80fd\u4fdd\u8bc1\u8be5\u544a\u8b66\u9608\u503c\u80fd\u591f\u53d1\u6325\u53bb\u4f5c\u7528\u3002 \u90a3\u4e48\u8fd8\u6709\u6ca1\u6709\u66f4\u597d\u7684\u65b9\u6cd5\u5417\uff1f</p> <p>PromQL\u4e2d\u5185\u7f6e\u7684predict_linear(v range-vector, t scalar) \u51fd\u6570\u53ef\u4ee5\u5e2e\u52a9\u7cfb\u7edf\u7ba1\u7406\u5458\u66f4\u597d\u7684\u5904\u7406\u6b64\u7c7b\u60c5\u51b5\uff0cpredict_linear\u51fd\u6570\u53ef\u4ee5\u9884\u6d4b\u65f6\u95f4\u5e8f\u5217v\u5728t\u79d2\u540e\u7684\u503c\u3002\u5b83\u57fa\u4e8e\u7b80\u5355\u7ebf\u6027\u56de\u5f52\u7684\u65b9\u5f0f\uff0c\u5bf9\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\uff0c\u4ece\u800c\u53ef\u4ee5\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u53d8\u5316\u8d8b\u52bf\u505a\u51fa\u9884\u6d4b\u3002\u4f8b\u5982\uff0c\u57fa\u4e8e2\u5c0f\u65f6\u7684\u6837\u672c\u6570\u636e\uff0c\u6765\u9884\u6d4b\u4e3b\u673a\u53ef\u7528\u78c1\u76d8\u7a7a\u95f4\u7684\u662f\u5426\u57284\u4e2a\u5c0f\u65f6\u5019\u88ab\u5360\u6ee1\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>predict_linear(node_filesystem_free{job=\"node\"}[2h], 4 * 3600) &lt; 0\n</code></pre>"},{"location":"promql/prometheus-promql-functions/#histogram","title":"\u7edf\u8ba1Histogram\u6307\u6807\u7684\u5206\u4f4d\u6570","text":"<p>\u5728\u672c\u7ae0\u7684\u7b2c2\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u7684\u56db\u79cd\u76d1\u63a7\u6307\u6807\u7c7b\u578b\uff0c\u5176\u4e2dHistogram\u548cSummary\u90fd\u53ef\u4ee5\u7528\u4e8e\u7edf\u8ba1\u548c\u5206\u6790\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5\u3002\u533a\u522b\u5728\u4e8eSummary\u662f\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u8ba1\u7b97\u4e86\u6570\u636e\u5206\u5e03\u7684\u5206\u4f4d\u6570\u60c5\u51b5\u3002\u800cHistogram\u7684\u5206\u4f4d\u6570\u8ba1\u7b97\u9700\u8981\u901a\u8fc7histogram_quantile(\u03c6 float, b instant-vector)\u51fd\u6570\u8fdb\u884c\u8ba1\u7b97\u3002\u5176\u4e2d\u03c6\uff080&lt;\u03c6&lt;1\uff09\u8868\u793a\u9700\u8981\u8ba1\u7b97\u7684\u5206\u4f4d\u6570\uff0c\u5982\u679c\u9700\u8981\u8ba1\u7b97\u4e2d\u4f4d\u6570\u03c6\u53d6\u503c\u4e3a0.5\uff0c\u4ee5\u6b64\u7c7b\u63a8\u5373\u53ef\u3002</p> <p>\u4ee5\u6307\u6807http_request_duration_seconds_bucket\u4e3a\u4f8b\uff1a</p> <pre><code># HELP http_request_duration_seconds request duration histogram\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{le=\"0.5\"} 0\nhttp_request_duration_seconds_bucket{le=\"1\"} 1\nhttp_request_duration_seconds_bucket{le=\"2\"} 2\nhttp_request_duration_seconds_bucket{le=\"3\"} 3\nhttp_request_duration_seconds_bucket{le=\"5\"} 3\nhttp_request_duration_seconds_bucket{le=\"+Inf\"} 3\nhttp_request_duration_seconds_sum 6\nhttp_request_duration_seconds_count 3\n</code></pre> <p>\u5f53\u8ba1\u7b979\u5206\u4f4d\u6570\u65f6\uff0c\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>histogram_quantile(0.5, http_request_duration_seconds_bucket)\n</code></pre> <p>\u901a\u8fc7\u5bf9Histogram\u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u7528\u6237\u53ef\u4ee5\u8f7b\u677e\u83b7\u53d6\u6837\u672c\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5\u3002\u540c\u65f6\u5206\u4f4d\u6570\u7684\u8ba1\u7b97\uff0c\u4e5f\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u7528\u4e8e\u8bc4\u5224\u5f53\u524d\u76d1\u63a7\u6307\u6807\u7684\u670d\u52a1\u6c34\u5e73\u3002</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u901a\u8fc7histogram_quantile\u8ba1\u7b97\u7684\u5206\u4f4d\u6570\uff0c\u5e76\u975e\u4e3a\u7cbe\u786e\u503c\uff0c\u800c\u662f\u901a\u8fc7http_request_duration_seconds_bucket\u548chttp_request_duration_seconds_sum\u8fd1\u4f3c\u8ba1\u7b97\u7684\u7ed3\u679c\u3002</p>"},{"location":"promql/prometheus-promql-functions/#_1","title":"\u52a8\u6001\u6807\u7b7e\u66ff\u6362","text":"<p>\u4e00\u822c\u6765\u8bf4\u6765\u8bf4\uff0c\u4f7f\u7528PromQL\u67e5\u8be2\u5230\u65f6\u95f4\u5e8f\u5217\u540e\uff0c\u53ef\u89c6\u5316\u5de5\u5177\u4f1a\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u6765\u6e32\u67d3\u56fe\u8868\u3002\u4f8b\u5982\u901a\u8fc7up\u6307\u6807\u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524d\u6240\u6709\u8fd0\u884c\u7684Exporter\u5b9e\u4f8b\u4ee5\u53ca\u5176\u72b6\u6001\uff1a</p> <pre><code>up{instance=\"localhost:8080\",job=\"cadvisor\"}    1\nup{instance=\"localhost:9090\",job=\"prometheus\"}  1\nup{instance=\"localhost:9100\",job=\"node\"}    1\n</code></pre> <p>\u8fd9\u662f\u53ef\u89c6\u5316\u5de5\u5177\u6e32\u67d3\u56fe\u6807\u65f6\u53ef\u80fd\u6839\u636e\uff0cinstance\u548cjob\u7684\u503c\u8fdb\u884c\u6e32\u67d3\uff0c\u4e3a\u4e86\u80fd\u591f\u8ba9\u5ba2\u6237\u7aef\u7684\u56fe\u6807\u66f4\u5177\u6709\u53ef\u8bfb\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7label_replace\u6807\u7b7e\u4e3a\u65f6\u95f4\u5e8f\u5217\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002label_replace\u7684\u5177\u4f53\u53c2\u6570\u5982\u4e0b\uff1a</p> <pre><code>label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)\n</code></pre> <p>\u8be5\u51fd\u6570\u4f1a\u4f9d\u6b21\u5bf9v\u4e2d\u7684\u6bcf\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u5904\u7406\uff0c\u901a\u8fc7regex\u5339\u914dsrc_label\u7684\u503c\uff0c\u5e76\u5c06\u5339\u914d\u90e8\u5206relacement\u5199\u5165\u5230dst_label\u6807\u7b7e\u4e2d\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>label_replace(up, \"host\", \"$1\", \"instance\",  \"(.*):.*\")\n</code></pre> <p>\u51fd\u6570\u5904\u7406\u540e\uff0c\u65f6\u95f4\u5e8f\u5217\u5c06\u5305\u542b\u4e00\u4e2ahost\u6807\u7b7e\uff0chost\u6807\u7b7e\u7684\u503c\u4e3aExporter\u5b9e\u4f8b\u7684IP\u5730\u5740\uff1a</p> <pre><code>up{host=\"localhost\",instance=\"localhost:8080\",job=\"cadvisor\"}   1\nup{host=\"localhost\",instance=\"localhost:9090\",job=\"prometheus\"} 1\nup{host=\"localhost\",instance=\"localhost:9100\",job=\"node\"} 1\n</code></pre> <p>\u9664\u4e86label_replace\u4ee5\u5916\uff0cPrometheus\u8fd8\u63d0\u4f9b\u4e86label_join\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u53ef\u4ee5\u5c06\u65f6\u95f4\u5e8f\u5217\u4e2dv\u591a\u4e2a\u6807\u7b7esrc_label\u7684\u503c\uff0c\u901a\u8fc7separator\u4f5c\u4e3a\u8fde\u63a5\u7b26\u5199\u5165\u5230\u4e00\u4e2a\u65b0\u7684\u6807\u7b7edst_label\u4e2d:</p> <pre><code>label_join(v instant-vector, dst_label string, separator string, src_label_1 string, src_label_2 string, ...)\n</code></pre> <p>label_replace\u548clabel_join\u51fd\u6570\u63d0\u4f9b\u4e86\u5bf9\u65f6\u95f4\u5e8f\u5217\u6807\u7b7e\u7684\u81ea\u5b9a\u4e49\u80fd\u529b\uff0c\u4ece\u800c\u80fd\u591f\u66f4\u597d\u7684\u4e8e\u5ba2\u6237\u7aef\u6216\u8005\u53ef\u89c6\u5316\u5de5\u5177\u914d\u5408\u3002</p>"},{"location":"promql/prometheus-promql-functions/#_2","title":"\u5176\u5b83\u5185\u7f6e\u51fd\u6570","text":"<p>\u9664\u4e86\u4e0a\u6587\u4ecb\u7ecd\u7684\u8fd9\u4e9b\u5185\u7f6e\u51fd\u6570\u4ee5\u5916\uff0cPromQL\u8fd8\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u5176\u5b83\u5185\u7f6e\u51fd\u6570\u3002\u8fd9\u4e9b\u5185\u7f6e\u51fd\u6570\u5305\u62ec\u4e00\u4e9b\u5e38\u7528\u7684\u6570\u5b66\u8ba1\u7b97\u3001\u65e5\u671f\u7b49\u7b49\u3002\u8fd9\u91cc\u5c31\u4e0d\u4e00\u4e00\u7ec6\u8bb2\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfbPrometheus\u7684\u5b98\u65b9\u6587\u6863\uff0c\u4e86\u89e3\u8fd9\u4e9b\u51fd\u6570\u7684\u4f7f\u7528\u65b9\u5f0f\u3002</p>"},{"location":"promql/prometheus-promql-operators-v2/","title":"PromQL\u64cd\u4f5c\u7b26","text":"<p>\u4f7f\u7528PromQL\u9664\u4e86\u80fd\u591f\u65b9\u4fbf\u7684\u6309\u7167\u67e5\u8be2\u548c\u8fc7\u6ee4\u65f6\u95f4\u5e8f\u5217\u4ee5\u5916\uff0cPromQL\u8fd8\u652f\u6301\u4e30\u5bcc\u7684\u64cd\u4f5c\u7b26\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u5bf9\u8fdb\u4e00\u6b65\u7684\u5bf9\u4e8b\u4ef6\u5e8f\u5217\u8fdb\u884c\u4e8c\u6b21\u52a0\u5de5\u3002\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u5305\u62ec\uff1a\u6570\u5b66\u8fd0\u7b97\u7b26\uff0c\u903b\u8f91\u8fd0\u7b97\u7b26\uff0c\u5e03\u5c14\u8fd0\u7b97\u7b26\u7b49\u7b49\u3002</p>"},{"location":"promql/prometheus-promql-operators-v2/#_1","title":"\u6570\u5b66\u8fd0\u7b97","text":"<p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u6807node_memory_free_bytes_total\u83b7\u53d6\u5f53\u524d\u4e3b\u673a\u53ef\u7528\u7684\u5185\u5b58\u7a7a\u95f4\u5927\u5c0f\uff0c\u5176\u6837\u672c\u5355\u4f4d\u4e3aBytes\u3002\u8fd9\u65f6\u5982\u679c\u5ba2\u6237\u7aef\u8981\u6c42\u4f7f\u7528MB\u4f5c\u4e3a\u5355\u4f4d\u54cd\u5e94\u6570\u636e\uff0c\u90a3\u53ea\u9700\u8981\u5c06\u67e5\u8be2\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u6837\u672c\u503c\u8fdb\u884c\u5355\u4f4d\u6362\u7b97\u5373\u53ef\uff1a</p> <pre><code>node_memory_free_bytes_total / (1024 * 1024)\n</code></pre> <p>node_memory_free_bytes_total\u8868\u8fbe\u5f0f\u4f1a\u67e5\u8be2\u51fa\u6240\u6709\u6ee1\u8db3\u8868\u8fbe\u5f0f\u6761\u4ef6\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\u6211\u4eec\u79f0\u8be5\u8868\u8fbe\u5f0f\u4e3a\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\uff0c\u800c\u8fd4\u56de\u7684\u7ed3\u679c\u6210\u4e3a\u77ac\u65f6\u5411\u91cf\u3002</p> <p>\u5f53\u77ac\u65f6\u5411\u91cf\u4e0e\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\u65f6\uff0c\u6570\u5b66\u8fd0\u7b97\u7b26\u4f1a\u4f9d\u6b21\u4f5c\u7528\u4e8e\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u6bcf\u4e00\u4e2a\u6837\u672c\u503c\uff0c\u4ece\u800c\u5f97\u5230\u4e00\u7ec4\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u800c\u5982\u679c\u662f\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\u65f6\uff0c\u8fc7\u7a0b\u4f1a\u76f8\u5bf9\u590d\u6742\u4e00\u70b9\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u60f3\u6839\u636enode_disk_bytes_written\u548cnode_disk_bytes_read\u83b7\u53d6\u4e3b\u673a\u78c1\u76d8IO\u7684\u603b\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>node_disk_bytes_written + node_disk_bytes_read\n</code></pre> <p>\u90a3\u8fd9\u4e2a\u8868\u8fbe\u5f0f\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u5462\uff1f\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u8fd0\u7b97\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002\u540c\u65f6\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u5c06\u4e0d\u4f1a\u5305\u542b\u6307\u6807\u540d\u79f0\u3002 \u8be5\u8868\u8fbe\u5f0f\u8fd4\u56de\u7ed3\u679c\u7684\u793a\u4f8b\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1634967552@1518146427.807 + 864551424@1518146427.807\n{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;0@1518146427.807 + 1744384@1518146427.807\n</code></pre> <p>PromQL\u652f\u6301\u7684\u6240\u6709\u6570\u5b66\u8fd0\u7b97\u7b26\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li><code>+</code> (\u52a0\u6cd5)</li> <li><code>-</code> (\u51cf\u6cd5)</li> <li><code>*</code> (\u4e58\u6cd5)</li> <li><code>/</code> (\u9664\u6cd5)</li> <li><code>%</code> (\u6c42\u4f59)</li> <li><code>^</code> (\u5e42\u8fd0\u7b97)</li> </ul>"},{"location":"promql/prometheus-promql-operators-v2/#_2","title":"\u4f7f\u7528\u5e03\u5c14\u8fd0\u7b97\u8fc7\u6ee4\u65f6\u95f4\u5e8f\u5217","text":"<p>\u5728PromQL\u901a\u8fc7\u6807\u7b7e\u5339\u914d\u6a21\u5f0f\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\u5bf9\u5176\u8fdb\u884c\u67e5\u8be2\u3002\u800c\u5e03\u5c14\u8fd0\u7b97\u5219\u652f\u6301\u7528\u6237\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u4e2d\u6837\u672c\u7684\u503c\uff0c\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\u3002</p> <p>\u4f8b\u5982\uff0c\u901a\u8fc7\u6570\u5b66\u8fd0\u7b97\u7b26\u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u8ba1\u7b97\u51fa\uff0c\u5f53\u524d\u6240\u6709\u4e3b\u673a\u8282\u70b9\u7684\u5185\u5b58\u4f7f\u7528\u7387\uff1a</p> <pre><code>(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total\n</code></pre> <p>\u800c\u7cfb\u7edf\u7ba1\u7406\u5458\u5728\u6392\u67e5\u95ee\u9898\u7684\u65f6\u5019\u53ef\u80fd\u53ea\u60f3\u77e5\u9053\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u7387\u8d85\u8fc795%\u7684\u4e3b\u673a\u5462\uff1f\u901a\u8fc7\u4f7f\u7528\u5e03\u5c14\u8fd0\u7b97\u7b26\u53ef\u4ee5\u65b9\u4fbf\u7684\u83b7\u53d6\u5230\u8be5\u7ed3\u679c\uff1a</p> <pre><code>(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total &gt; 0.95\n</code></pre> <p>\u77ac\u65f6\u5411\u91cf\u4e0e\u6807\u91cf\u8fdb\u884c\u5e03\u5c14\u8fd0\u7b97\u65f6\uff0cPromQL\u4f9d\u6b21\u6bd4\u8f83\u5411\u91cf\u4e2d\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u6837\u672c\u7684\u503c\uff0c\u5982\u679c\u6bd4\u8f83\u7ed3\u679c\u4e3atrue\u5219\u4fdd\u7559\uff0c\u53cd\u4e4b\u4e22\u5f03\u3002</p> <p>\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u76f4\u63a5\u8fdb\u884c\u5e03\u5c14\u8fd0\u7b97\u65f6\uff0c\u540c\u6837\u9075\u5faa\u9ed8\u8ba4\u7684\u5339\u914d\u6a21\u5f0f\uff1a\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\b\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002</p> <p>\u76ee\u524d\uff0cPrometheus\u652f\u6301\u4ee5\u4e0b\u5e03\u5c14\u8fd0\u7b97\u7b26\u5982\u4e0b\uff1a</p> <ul> <li><code>==</code> (\u76f8\u7b49)</li> <li><code>!=</code> (\u4e0d\u76f8\u7b49)</li> <li><code>&gt;</code> (\u5927\u4e8e)</li> <li><code>&lt;</code> (\u5c0f\u4e8e)</li> <li><code>&gt;=</code> (\u5927\u4e8e\u7b49\u4e8e)</li> <li><code>&lt;=</code> (\u5c0f\u4e8e\u7b49\u4e8e)</li> </ul>"},{"location":"promql/prometheus-promql-operators-v2/#bool","title":"\u4f7f\u7528bool\u4fee\u9970\u7b26\u6539\u53d8\u5e03\u5c14\u8fd0\u7b97\u7b26\u7684\u884c\u4e3a","text":"<p>\u5e03\u5c14\u8fd0\u7b97\u7b26\u7684\u9ed8\u8ba4\u884c\u4e3a\u662f\u5bf9\u65f6\u5e8f\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u3002\u800c\u5728\u5176\u5b83\u7684\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u80fd\u9700\u8981\u7684\u662f\u771f\u6b63\u7684\u5e03\u5c14\u7ed3\u679c\u3002\u4f8b\u5982\uff0c\u53ea\u9700\u8981\u77e5\u9053\u5f53\u524d\u6a21\u5757\u7684HTTP\u8bf7\u6c42\u91cf\u662f\u5426&gt;=1000\uff0c\u5982\u679c\u5927\u4e8e\u7b49\u4e8e1000\u5219\u8fd4\u56de1\uff08true\uff09\u5426\u5219\u8fd4\u56de0\uff08false\uff09\u3002\u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528bool\u4fee\u9970\u7b26\u6539\u53d8\u5e03\u5c14\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a\u3002 \u4f8b\u5982\uff1a</p> <pre><code>http_requests_total &gt; bool 1000\n</code></pre> <p>\u4f7f\u7528bool\u4fee\u6539\u7b26\u540e\uff0c\u5e03\u5c14\u8fd0\u7b97\u4e0d\u4f1a\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u800c\u662f\u76f4\u63a5\u4f9d\u6b21\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u5404\u4e2a\u6837\u672c\u6570\u636e\u4e0e\u6807\u91cf\u7684\u6bd4\u8f83\u7ed3\u679c0\u6216\u80051\u3002\u4ece\u800c\u5f62\u6210\u4e00\u6761\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <pre><code>http_requests_total{code=\"200\",handler=\"query\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  1\nhttp_requests_total{code=\"200\",handler=\"query_range\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  0\n</code></pre> <p>\u540c\u65f6\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u662f\u5728\u4e24\u4e2a\u6807\u91cf\u4e4b\u95f4\u4f7f\u7528\u5e03\u5c14\u8fd0\u7b97\uff0c\u5219\u5fc5\u987b\u4f7f\u7528bool\u4fee\u9970\u7b26</p> <pre><code>2 == bool 2 # \u7ed3\u679c\u4e3a1\n</code></pre>"},{"location":"promql/prometheus-promql-operators-v2/#_3","title":"\u4f7f\u7528\u96c6\u5408\u8fd0\u7b97\u7b26","text":"<p>\u4f7f\u7528\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u80fd\u591f\u83b7\u53d6\u5230\u4e00\u4e2a\u5305\u542b\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u96c6\u5408\uff0c\u6211\u4eec\u79f0\u4e3a\u77ac\u65f6\u5411\u91cf\u3002 \u901a\u8fc7\u96c6\u5408\u8fd0\u7b97\uff0c\u53ef\u4ee5\u5728\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u76f8\u5e94\u7684\u96c6\u5408\u64cd\u4f5c\u3002\u76ee\u524d\uff0cPrometheus\u652f\u6301\u4ee5\u4e0b\u96c6\u5408\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>and</code> (\u5e76\u4e14)</li> <li><code>or</code> (\u6216\u8005)</li> <li><code>unless</code> (\u6392\u9664)</li> </ul> <p>vector1 and vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u7531vector1\u7684\u5143\u7d20\u7ec4\u6210\u7684\u65b0\u7684\u5411\u91cf\u3002\u8be5\u5411\u91cf\u5305\u542bvector1\u4e2d\u5b8c\u5168\u5339\u914dvector2\u4e2d\u7684\u5143\u7d20\u7ec4\u6210\u3002</p> <p>vector1 or vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u8be5\u5411\u91cf\u5305\u542bvector1\u4e2d\u6240\u6709\u7684\b\u6837\u672c\u6570\u636e\uff0c\u4ee5\u53cavector2\u4e2d\u6ca1\u6709\u4e0evector1\u5339\u914d\u5230\u7684\u6837\u672c\u6570\u636e\u3002</p> <p>vector1 unless vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u65b0\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u7531vector1\u4e2d\u6ca1\u6709\u4e0evector2\u5339\u914d\u7684\u5143\u7d20\u7ec4\u6210\u3002</p>"},{"location":"promql/prometheus-promql-operators-v2/#_4","title":"\u64cd\u4f5c\u7b26\u4f18\u5148\u7ea7","text":"<p>\u5bf9\u4e8e\u590d\u6742\u7c7b\u578b\u7684\u8868\u8fbe\u5f0f\uff0c\u9700\u8981\u4e86\u89e3\u8fd0\u7b97\u64cd\u4f5c\u7684\u8fd0\u884c\u4f18\u5148\u7ea7</p> <p>\u4f8b\u5982\uff0c\u67e5\u8be2\u4e3b\u673a\u7684CPU\u4f7f\u7528\u7387\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>100 * (1 - avg (irate(node_cpu{mode='idle'}[5m])) by(job) )\n</code></pre> <p>\u5176\u4e2dirate\u662fPromQL\u4e2d\u7684\u5185\u7f6e\u51fd\u6570\uff0c\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u4e2d\u65f6\u95f4\u5e8f\u5217\u6bcf\u79d2\u7684\u5373\u65f6\u589e\u957f\u7387\u3002\u5173\u4e8e\u5185\u7f6e\u51fd\u6570\u7684\u90e8\u5206\uff0c\u4f1a\u5728\u4e0b\u4e00\u8282\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u5728PromQL\u64cd\u4f5c\u7b26\u4e2d\u4f18\u5148\u7ea7\u7531\u9ad8\u5230\u4f4e\u4f9d\u6b21\u4e3a\uff1a</p> <ol> <li><code>^</code></li> <li><code>*, /, %</code></li> <li><code>+, -</code></li> <li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li> <li><code>and, unless</code></li> <li><code>or</code></li> </ol>"},{"location":"promql/prometheus-promql-operators-v2/#_5","title":"\u5339\u914d\u6a21\u5f0f\u8be6\u89e3","text":"<p>\u5411\u91cf\u4e0e\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u8fd0\u7b97\u64cd\u4f5c\u65f6\u4f1a\u57fa\u4e8e\u9ed8\u8ba4\u7684\u5339\u914d\u89c4\u5219\uff1a\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u8fd0\u7b97\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u4ecb\u7ecd\u5728PromQL\u4e2d\u6709\u4e24\u79cd\u5178\u578b\u7684\u5339\u914d\u6a21\u5f0f\uff1a\u4e00\u5bf9\u4e00\uff08one-to-one\uff09,\u591a\u5bf9\u4e00\uff08many-to-one\uff09\u6216\u4e00\u5bf9\u591a\uff08one-to-many\uff09\u3002</p>"},{"location":"promql/prometheus-promql-operators-v2/#_6","title":"\u4e00\u5bf9\u4e00\u5339\u914d","text":"<p>\u4e00\u5bf9\u4e00\b\u5339\u914d\u6a21\u5f0f\u4f1a\u4ece\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u83b7\u53d6\u7684\u77ac\u65f6\u5411\u91cf\u4f9d\u6b21\u6bd4\u8f83\u5e76\u627e\u5230\u552f\u4e00\u5339\u914d(\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4)\u7684\u6837\u672c\u503c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>vector1 &lt;operator&gt; vector2\n</code></pre> <p>\u5728\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528on(label list)\u6216\u8005ignoring(label list\uff09\u6765\u4fee\u6539\u6807\u7b7e\u7684\u5339\u914d\u884c\u4e3a\u3002\u4f7f\u7528ignoreing\u53ef\u4ee5\u5728\u5339\u914d\u65f6\u5ffd\u7565\u67d0\u4e9b\u6807\u7b7e\u3002\u800con\u5219\u7528\u4e8e\u5c06\u5339\u914d\u884c\u4e3a\u9650\u5b9a\u5728\u67d0\u4e9b\u6807\u7b7e\u4e4b\u5185\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u4f8b\u5982\u5f53\u5b58\u5728\u6837\u672c\uff1a</p> <pre><code>method_code:http_errors:rate5m{method=\"get\", code=\"500\"}  24\nmethod_code:http_errors:rate5m{method=\"get\", code=\"404\"}  30\nmethod_code:http_errors:rate5m{method=\"put\", code=\"501\"}  3\nmethod_code:http_errors:rate5m{method=\"post\", code=\"500\"} 6\nmethod_code:http_errors:rate5m{method=\"post\", code=\"404\"} 21\n\nmethod:http_requests:rate5m{method=\"get\"}  600\nmethod:http_requests:rate5m{method=\"del\"}  34\nmethod:http_requests:rate5m{method=\"post\"} 120\n</code></pre> <p>\u4f7f\u7528PromQL\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m{code=\"500\"} / ignoring(code) method:http_requests:rate5m\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fd4\u56de\u5728\u8fc7\u53bb5\u5206\u949f\u5185\uff0cHTTP\u8bf7\u6c42\u72b6\u6001\u7801\u4e3a500\u7684\u5728\u6240\u6709\u8bf7\u6c42\u4e2d\u7684\u6bd4\u4f8b\u3002\u5982\u679c\u6ca1\u6709\u4f7f\u7528ignoring(code)\uff0c\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u77ac\u65f6\u5411\u91cf\u4e2d\u5c06\u627e\u4e0d\u5230\u4efb\u4f55\u4e00\u4e2a\u6807\u7b7e\u5b8c\u5168\u76f8\u540c\u7684\u5339\u914d\u9879\u3002</p> <p>\u56e0\u6b64\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\"}  0.04            //  24 / 600\n{method=\"post\"} 0.05            //   6 / 120\n</code></pre> <p>\u540c\u65f6\u7531\u4e8emethod\u4e3aput\u548cdel\u7684\b\u6837\u672c\b\u627e\u4e0d\u5230\u5339\u914d\u9879\uff0c\u56e0\u6b64\u4e0d\u4f1a\u51fa\u73b0\u5728\u7ed3\u679c\u5f53\u4e2d\u3002</p>"},{"location":"promql/prometheus-promql-operators-v2/#_7","title":"\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a","text":"<p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u5339\u914d\u6a21\u5f0f\u6307\u7684\u662f\u201c\u4e00\u201d\u4fa7\u7684\u6bcf\u4e00\u4e2a\u5411\u91cf\u5143\u7d20\u53ef\u4ee5\u4e0e\"\u591a\"\u4fa7\u7684\u591a\u4e2a\u5143\u7d20\u5339\u914d\u7684\u60c5\u51b5\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5fc5\u987b\u4f7f\u7528group\u4fee\u9970\u7b26\uff1agroup_left\u6216\u8005group_right\u6765\u786e\u5b9a\u54ea\u4e00\u4e2a\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6570\uff08\u5145\u5f53\u201c\u591a\u201d\u7684\u89d2\u8272\uff09\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u6a21\u5f0f\u4e00\u5b9a\u662f\u51fa\u73b0\u5728\u64cd\u4f5c\u7b26\u4e24\u4fa7\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u5411\u91cf\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u56e0\u6b64\u9700\u8981\u4f7f\u7528ignoring\u548con\u4fee\u9970\u7b26\u6765\u6392\u9664\u6216\u8005\u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u5217\u8868\u3002</p> <p>\u4f8b\u5982,\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4e2d\uff0c\u5de6\u5411\u91cf<code>method_code:http_errors:rate5m</code>\u5305\u542b\u4e24\u4e2a\u6807\u7b7emethod\u548ccode\u3002\u800c\u53f3\u5411\u91cf<code>method:http_requests:rate5m</code>\u4e2d\u53ea\u5305\u542b\u4e00\u4e2a\u6807\u7b7emethod\uff0c\u56e0\u6b64\u5339\u914d\u65f6\u9700\u8981\u4f7f\u7528ignoring\u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u4e3acode\u3002 \u5728\u9650\u5b9a\u5339\u914d\u6807\u7b7e\u540e\uff0c\u53f3\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u53ef\u80fd\u5339\u914d\u5230\u591a\u4e2a\u5de6\u5411\u91cf\u4e2d\u7684\u5143\u7d20\uff0c\u56e0\u6b64\u8be5\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u6a21\u5f0f\u4e3a\u591a\u5bf9\u4e00\uff0c\u9700\u8981\u4f7f\u7528group\u4fee\u9970\u7b26group_left\u6307\u5b9a\u5de6\u5411\u91cf\u5177\u6709\u66f4\u597d\u7684\u57fa\u6570\u3002</p> <p>\u6700\u7ec8\u7684\u8fd0\u7b97\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\", code=\"500\"}  0.04            //  24 / 600\n{method=\"get\", code=\"404\"}  0.05            //  30 / 600\n{method=\"post\", code=\"500\"} 0.05            //   6 / 120\n{method=\"post\", code=\"404\"} 0.175           //  21 / 120\n</code></pre> <p>\u63d0\u9192\uff1agroup\u4fee\u9970\u7b26\u53ea\u80fd\u5728\u6bd4\u8f83\u548c\u6570\u5b66\u8fd0\u7b97\u7b26\u4e2d\u4f7f\u7528\u3002\u5728\u903b\u8f91\u8fd0\u7b97and,unless\u548cor\u624d\u6ce8\u610f\u64cd\u4f5c\u4e2d\u9ed8\u8ba4\u4e0e\u53f3\u5411\u91cf\u4e2d\u7684\u6240\u6709\u5143\u7d20\u8fdb\u884c\u5339\u914d\u3002</p>"},{"location":"promql/prometheus-promql-with-http-api/","title":"\u5728HTTP API\u4e2d\u4f7f\u7528PromQL","text":"<p>Prometheus\u5f53\u524d\u7a33\u5b9a\u7684HTTP API\u53ef\u4ee5\u901a\u8fc7/api/v1\u8bbf\u95ee\u3002</p>"},{"location":"promql/prometheus-promql-with-http-api/#api","title":"API\u54cd\u5e94\u683c\u5f0f","text":"<p>Prometheus API\u4f7f\u7528\u4e86JSON\u683c\u5f0f\u7684\u54cd\u5e94\u5185\u5bb9\u3002 \u5f53API\u8c03\u7528\u6210\u529f\u540e\u5c06\u4f1a\u8fd4\u56de2xx\u7684HTTP\u72b6\u6001\u7801\u3002</p> <p>\u53cd\u4e4b\uff0c\u5f53API\u8c03\u7528\u5931\u8d25\u65f6\u53ef\u80fd\u8fd4\u56de\u4ee5\u4e0b\u51e0\u79cd\u4e0d\u540c\u7684HTTP\u72b6\u6001\u7801\uff1a</p> <ul> <li>404 Bad Request\uff1a\u5f53\u53c2\u6570\u9519\u8bef\u6216\u8005\u7f3a\u5931\u65f6\u3002</li> <li>422 Unprocessable Entity \u5f53\u8868\u8fbe\u5f0f\u65e0\u6cd5\u6267\u884c\u65f6\u3002</li> <li>503 Service Unavailiable \u5f53\u8bf7\u6c42\u8d85\u65f6\u6216\u8005\u88ab\u4e2d\u65ad\u65f6\u3002</li> </ul> <p>\u6240\u6709\u7684API\u8bf7\u6c42\u5747\u4f7f\u7528\u4ee5\u4e0b\u7684JSON\u683c\u5f0f\uff1a</p> <pre><code>{\n  \"status\": \"success\" | \"error\",\n  \"data\": &lt;data&gt;,\n\n  // Only set if status is \"error\". The data field may still hold\n  // additional data.\n  \"errorType\": \"&lt;string&gt;\",\n  \"error\": \"&lt;string&gt;\"\n}\n</code></pre>"},{"location":"promql/prometheus-promql-with-http-api/#http-apipromql_1","title":"\u5728HTTP API\u4e2d\u4f7f\u7528PromQL","text":"<p>\u901a\u8fc7HTTP API\u6211\u4eec\u53ef\u4ee5\u5206\u522b\u901a\u8fc7/api/v1/query\u548c/api/v1/query_range\u67e5\u8be2PromQL\u8868\u8fbe\u5f0f\u5f53\u524d\u6216\u8005\u4e00\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p>"},{"location":"promql/prometheus-promql-with-http-api/#_1","title":"\u77ac\u65f6\u6570\u636e\u67e5\u8be2","text":"<p>\u901a\u8fc7\u4f7f\u7528QUERY API\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2PromQL\u5728\u7279\u5b9a\u65f6\u95f4\u70b9\u4e0b\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p> <pre><code>GET /api/v1/query\n</code></pre> <p>URL\u8bf7\u6c42\u53c2\u6570\uff1a</p> <ul> <li>query=\uff1aPromQL\u8868\u8fbe\u5f0f\u3002 <li>time=\uff1a\u7528\u4e8e\u6307\u5b9a\u7528\u4e8e\u8ba1\u7b97PromQL\u7684\u65f6\u95f4\u6233\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u3002 <li>timeout=\uff1a\u8d85\u65f6\u8bbe\u7f6e\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528-query,timeout\u7684\u5168\u5c40\u8bbe\u7f6e\u3002 <p>\u4f8b\u5982\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u67e5\u8be2\u8868\u8fbe\u5f0fup\u5728\u65f6\u95f4\u70b92015-07-01T20:10:51.781Z\u7684\u8ba1\u7b97\u7ed3\u679c\uff1a</p> <pre><code>$ curl 'http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z'\n{\n   \"status\" : \"success\",\n   \"data\" : {\n      \"resultType\" : \"vector\",\n      \"result\" : [\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"prometheus\",\n               \"instance\" : \"localhost:9090\"\n            },\n            \"value\": [ 1435781451.781, \"1\" ]\n         },\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"node\",\n               \"instance\" : \"localhost:9100\"\n            },\n            \"value\" : [ 1435781451.781, \"0\" ]\n         }\n      ]\n   }\n}\n</code></pre>"},{"location":"promql/prometheus-promql-with-http-api/#_2","title":"\u54cd\u5e94\u6570\u636e\u7c7b\u578b","text":"<p>\u5f53API\u8c03\u7528\u6210\u529f\u540e\uff0cPrometheus\u4f1a\u8fd4\u56deJSON\u683c\u5f0f\u7684\u54cd\u5e94\u5185\u5bb9\uff0c\u683c\u5f0f\u5982\u4e0a\u5c0f\u8282\u6240\u793a\u3002\u5e76\u4e14\u5728data\u8282\u70b9\u4e2d\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c\u3002data\u8282\u70b9\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"resultType\": \"matrix\" | \"vector\" | \"scalar\" | \"string\",\n  \"result\": &lt;value&gt;\n}\n</code></pre> <p>PromQL\u8868\u8fbe\u5f0f\u53ef\u80fd\u8fd4\u56de\u591a\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u5728\u54cd\u5e94\u5185\u5bb9\u4e2d\u4f7f\u7528resultType\u8868\u793a\u5f53\u524d\u8fd4\u56de\u7684\u6570\u636e\u7c7b\u578b\uff0c\u5305\u62ec\uff1a</p> <ul> <li>\u77ac\u65f6\u5411\u91cf\uff1avector</li> </ul> <p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578bresultType\u4e3avector\u65f6\uff0cresult\u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metric\": { \"&lt;label_name&gt;\": \"&lt;label_value&gt;\", ... },\n    \"value\": [ &lt;unix_time&gt;, \"&lt;sample_value&gt;\" ]\n  },\n  ...\n]\n</code></pre> <p>\u5176\u4e2dmetrics\u8868\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\uff0cvalue\u53ea\u5305\u542b\u4e00\u4e2a\u552f\u4e00\u7684\u6837\u672c\u3002</p> <ul> <li>\u533a\u95f4\u5411\u91cf\uff1amatrix</li> </ul> <p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578bresultType\u4e3amatrix\u65f6\uff0cresult\u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metric\": { \"&lt;label_name&gt;\": \"&lt;label_value&gt;\", ... },\n    \"values\": [ [ &lt;unix_time&gt;, \"&lt;sample_value&gt;\" ], ... ]\n  },\n  ...\n]\n</code></pre> <p>\u5176\u4e2dmetrics\u8868\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\uff0cvalues\u5305\u542b\u5f53\u524d\u4e8b\u4ef6\u5e8f\u5217\u7684\u4e00\u7ec4\u6837\u672c\u3002</p> <ul> <li>\u6807\u91cf\uff1ascalar</li> </ul> <p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578bresultType\u4e3ascalar\u65f6\uff0cresult\u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[ &lt;unix_time&gt;, \"&lt;scalar_value&gt;\" ]\n</code></pre> <p>\u7531\u4e8e\u6807\u91cf\u4e0d\u5b58\u5728\u65f6\u95f4\u5e8f\u5217\u4e00\u8bf4\uff0c\u56e0\u6b64result\u8868\u793a\u4e3a\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u4e00\u4e2a\u6807\u91cf\u7684\u503c\u3002</p> <ul> <li>\u5b57\u7b26\u4e32\uff1astring</li> </ul> <p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578bresultType\u4e3astring\u65f6\uff0cresult\u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[ &lt;unix_time&gt;, \"&lt;string_value&gt;\" ]\n</code></pre> <p>\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u54cd\u5e94\u5185\u5bb9\u683c\u5f0f\u548c\u6807\u91cf\u76f8\u540c\u3002</p>"},{"location":"promql/prometheus-promql-with-http-api/#_3","title":"\u533a\u95f4\u6570\u636e\u67e5\u8be2","text":"<p>\u4f7f\u7528QUERY_RANGE API\u6211\u4eec\u5219\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2PromQL\u8868\u8fbe\u5f0f\u5728\u4e00\u6bb5\u65f6\u95f4\u8fd4\u56de\u5185\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p> <pre><code>GET /api/v1/query_range\n</code></pre> <p>URL\u8bf7\u6c42\u53c2\u6570\uff1a</p> <ul> <li>query=: PromQL\u8868\u8fbe\u5f0f\u3002 <li>start=: \u8d77\u59cb\u65f6\u95f4\u3002 <li>end=: \u7ed3\u675f\u65f6\u95f4\u3002 <li>step=: \u67e5\u8be2\u6b65\u957f\u3002 <li>timeout=: \u8d85\u65f6\u8bbe\u7f6e\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528-query,timeout\u7684\u5168\u5c40\u8bbe\u7f6e\u3002 <p>\u5f53\u4f7f\u7528QUERY_RANGE API\u67e5\u8be2PromQL\u8868\u8fbe\u5f0f\u65f6\uff0c\u8fd4\u56de\u7ed3\u679c\u4e00\u5b9a\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff1a</p> <pre><code>{\n  \"resultType\": \"matrix\",\n  \"result\": &lt;value&gt;\n}\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728QUERY_RANGE API\u4e2dPromQL\u53ea\u80fd\u4f7f\u7528\u77ac\u65f6\u5411\u91cf\u9009\u62e9\u5668\u7c7b\u578b\u7684\u8868\u8fbe\u5f0f\u3002</p> <p>\u4f8b\u5982\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u67e5\u8be2\u8868\u8fbe\u5f0fup\u572830\u79d2\u8303\u56f4\u5185\u4ee515\u79d2\u4e3a\u95f4\u9694\u8ba1\u7b97PromQL\u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u3002</p> <pre><code>$ curl 'http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s'\n{\n   \"status\" : \"success\",\n   \"data\" : {\n      \"resultType\" : \"matrix\",\n      \"result\" : [\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"prometheus\",\n               \"instance\" : \"localhost:9090\"\n            },\n            \"values\" : [\n               [ 1435781430.781, \"1\" ],\n               [ 1435781445.781, \"1\" ],\n               [ 1435781460.781, \"1\" ]\n            ]\n         },\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"node\",\n               \"instance\" : \"localhost:9091\"\n            },\n            \"values\" : [\n               [ 1435781430.781, \"0\" ],\n               [ 1435781445.781, \"0\" ],\n               [ 1435781460.781, \"1\" ]\n            ]\n         }\n      ]\n   }\n}\n</code></pre>"},{"location":"promql/prometheus-query-language/","title":"\u521d\u8bc6PromQL","text":"<p>Prometheus\u901a\u8fc7\u6307\u6807\u540d\u79f0\uff08metrics name\uff09\u4ee5\u53ca\u5bf9\u5e94\u7684\u4e00\u7ec4\u6807\u7b7e\uff08labelset\uff09\u552f\u4e00\u5b9a\u4e49\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u3002\u6307\u6807\u540d\u79f0\u53cd\u6620\u4e86\u76d1\u63a7\u6837\u672c\u7684\u57fa\u672c\u6807\u8bc6\uff0c\u800clabel\u5219\u5728\u8fd9\u4e2a\u57fa\u672c\u7279\u5f81\u4e0a\u4e3a\u91c7\u96c6\u5230\u7684\u6570\u636e\u63d0\u4f9b\u4e86\u591a\u79cd\u7279\u5f81\u7ef4\u5ea6\u3002\u7528\u6237\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e9b\u7279\u5f81\u7ef4\u5ea6\u8fc7\u6ee4\uff0c\u805a\u5408\uff0c\u7edf\u8ba1\u4ece\u800c\u4ea7\u751f\u65b0\u7684\u8ba1\u7b97\u540e\u7684\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>PromQL\u662fPrometheus\u5185\u7f6e\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff0c\u5176\u63d0\u4f9b\u5bf9\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u4e30\u5bcc\u7684\u67e5\u8be2\uff0c\u805a\u5408\u4ee5\u53ca\u903b\u8f91\u8fd0\u7b97\u80fd\u529b\u7684\u652f\u6301\u3002\u5e76\u4e14\u88ab\u5e7f\u6cdb\u5e94\u7528\u5728Prometheus\u7684\u65e5\u5e38\u5e94\u7528\u5f53\u4e2d\uff0c\u5305\u62ec\u5bf9\u6570\u636e\u67e5\u8be2\u3001\u53ef\u89c6\u5316\u3001\u544a\u8b66\u5904\u7406\u5f53\u4e2d\u3002\u53ef\u4ee5\u8fd9\u4e48\u8bf4\uff0cPromQL\u662fPrometheus\u6240\u6709\u5e94\u7528\u573a\u666f\u7684\u57fa\u7840\uff0c\u7406\u89e3\u548c\u638c\u63e1PromQL\u662fPrometheus\u5165\u95e8\u7684\u7b2c\u4e00\u8bfe\u3002</p>"},{"location":"promql/prometheus-query-language/#_1","title":"\u67e5\u8be2\u65f6\u95f4\u5e8f\u5217","text":"<p>\u5f53Prometheus\u901a\u8fc7Exporter\u91c7\u96c6\u5230\u76f8\u5e94\u7684\u76d1\u63a7\u6307\u6807\u6837\u672c\u6570\u636e\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7PromQL\u5bf9\u76d1\u63a7\u6837\u672c\u6570\u636e\u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u5f53\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u76d1\u63a7\u6307\u6807\u540d\u79f0\u67e5\u8be2\u65f6\uff0c\u53ef\u4ee5\u67e5\u8be2\u8be5\u6307\u6807\u4e0b\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u3002\u5982\uff1a</p> <pre><code>http_requests_total\n</code></pre> <p>\u7b49\u540c\u4e8e\uff1a</p> <pre><code>http_requests_total{}\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fd4\u56de\u6307\u6807\u540d\u79f0\u4e3ahttp_requests_total\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total{code=\"200\",handler=\"alerts\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}=(20889@1518096812.326)\nhttp_requests_total{code=\"200\",handler=\"graph\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}=(21287@1518096812.326)\n</code></pre> <p>PromQL\u8fd8\u652f\u6301\u7528\u6237\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u5339\u914d\u6a21\u5f0f\u6765\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u76ee\u524d\u4e3b\u8981\u652f\u6301\u4e24\u79cd\u5339\u914d\u6a21\u5f0f\uff1a\u5b8c\u5168\u5339\u914d\u548c\u6b63\u5219\u5339\u914d\u3002</p> <p>PromQL\u652f\u6301\u4f7f\u7528<code>=</code>\u548c<code>!=</code>\u4e24\u79cd\u5b8c\u5168\u5339\u914d\u6a21\u5f0f\uff1a</p> <ul> <li>\u901a\u8fc7\u4f7f\u7528<code>label=value</code>\u53ef\u4ee5\u9009\u62e9\u90a3\u4e9b\u6807\u7b7e\u6ee1\u8db3\u8868\u8fbe\u5f0f\u5b9a\u4e49\u7684\u65f6\u95f4\u5e8f\u5217\uff1b</li> <li>\u53cd\u4e4b\u4f7f\u7528<code>label!=value</code>\u5219\u53ef\u4ee5\u6839\u636e\u6807\u7b7e\u5339\u914d\u6392\u9664\u65f6\u95f4\u5e8f\u5217\uff1b</li> </ul> <p>\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u53ea\u9700\u8981\u67e5\u8be2\u6240\u6709http_requests_total\u65f6\u95f4\u5e8f\u5217\u4e2d\u6ee1\u8db3\u6807\u7b7einstance\u4e3alocalhost:9090\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>http_requests_total{instance=\"localhost:9090\"}\n</code></pre> <p>\u53cd\u4e4b\u4f7f\u7528<code>instance!=\"localhost:9090\"</code>\u5219\u53ef\u4ee5\u6392\u9664\u8fd9\u4e9b\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total{instance!=\"localhost:9090\"}\n</code></pre> <p>\u9664\u4e86\u4f7f\u7528\u5b8c\u5168\u5339\u914d\u7684\u65b9\u5f0f\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\u4ee5\u5916\uff0cPromQL\u8fd8\u53ef\u4ee5\u652f\u6301\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u4f5c\u4e3a\u5339\u914d\u6761\u4ef6\uff0c\u591a\u4e2a\u8868\u8fbe\u5f0f\u4e4b\u95f4\u4f7f\u7528<code>|</code>\u8fdb\u884c\u5206\u79bb\uff1a</p> <ul> <li>\u4f7f\u7528<code>label=~regx</code>\u8868\u793a\u9009\u62e9\u90a3\u4e9b\u6807\u7b7e\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u5b9a\u4e49\u7684\u65f6\u95f4\u5e8f\u5217\uff1b</li> <li>\u53cd\u4e4b\u4f7f\u7528<code>label!~regx</code>\u8fdb\u884c\u6392\u9664\uff1b</li> </ul> <p>\u4f8b\u5982\uff0c\u5982\u679c\u60f3\u67e5\u8be2\u591a\u4e2a\u73af\u8282\u4e0b\u7684\u65f6\u95f4\u5e8f\u5217\u5e8f\u5217\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>http_requests_total{environment=~\"staging|testing|development\",method!=\"GET\"}\n</code></pre>"},{"location":"promql/prometheus-query-language/#_2","title":"\u8303\u56f4\u67e5\u8be2","text":"<p>\u76f4\u63a5\u901a\u8fc7\u7c7b\u4f3c\u4e8ePromQL\u8868\u8fbe\u5f0f<code>http_requests_total</code>\u67e5\u8be2\u65f6\u95f4\u5e8f\u5217\u65f6\uff0c\u4f1a\u9009\u62e9\u51fa\u6240\u6709\u5c5e\u4e8e\u8be5\u5ea6\u91cf\u6307\u6807\u7684\u65f6\u5e8f\u7684\u5f53\u524d\u91c7\u6837\u503c\uff0c\u8fd9\u6837\u7684\u8fd4\u56de\u7ed3\u679c\u6211\u4eec\u79f0\u4e4b\u4e3a__\u77ac\u65f6\u5411\u91cf__\u3002\u800c\u76f8\u5e94\u7684\u8fd9\u6837\u7684\u8868\u8fbe\u5f0f\u79f0\u4e4b\u4e3a__\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f__\u3002</p> <p>\u800c\u5982\u679c\u6211\u4eec\u60f3\u8fc7\u53bb\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6837\u672c\u6570\u636e\u65f6\uff0c\u6211\u4eec\u5219\u9700\u8981\u4f7f\u7528__\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f__\u3002\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u548c\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u4e4b\u95f4\u7684\u5dee\u5f02\u5728\u4e8e\u5728\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e2d\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u65f6\u95f4\u9009\u62e9\u7684\u8303\u56f4\uff0c\u65f6\u95f4\u8303\u56f4\u901a\u8fc7\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668<code>[]</code>\u8fdb\u884c\u5b9a\u4e49\u3002\u4f8b\u5982\uff0c\u901a\u8fc7\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u53ef\u4ee5\u9009\u62e9\u6700\u8fd15\u5206\u949f\u5185\u7684\u6240\u6709\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>http_requests_total{}[5m]\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u5c06\u4f1a\u8fd4\u56de\u67e5\u8be2\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u4e2d\u6700\u8fd15\u5206\u949f\u7684\u6240\u6709\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>http_requests_total{code=\"200\",handler=\"alerts\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}=[\n    1@1518096812.326\n    1@1518096817.326\n    1@1518096822.326\n    1@1518096827.326\n    1@1518096832.326\n    1@1518096837.325\n]\nhttp_requests_total{code=\"200\",handler=\"graph\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}=[\n    4 @1518096812.326\n    4@1518096817.326\n    4@1518096822.326\n    4@1518096827.326\n    4@1518096832.326\n    4@1518096837.325\n]\n</code></pre> <p>\u901a\u8fc7\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u67e5\u8be2\u5230\u7684\u7ed3\u679c\u6211\u4eec\u79f0\u4e3a__\u533a\u95f4\u5411\u91cf__\u3002</p> <p>\u9664\u4e86\u4f7f\u7528m\u8868\u793a\u5206\u949f\u4ee5\u5916\uff0cPromQL\u7684\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668\u652f\u6301\u5176\u5b83\u65f6\u95f4\u5355\u4f4d\uff1a</p> <ul> <li>s - \u79d2</li> <li>m - \u5206\u949f</li> <li>h - \u5c0f\u65f6</li> <li>d - \u5929</li> <li>w - \u5468</li> <li>y - \u5e74</li> </ul>"},{"location":"promql/prometheus-query-language/#_3","title":"\u65f6\u95f4\u4f4d\u79fb\u64cd\u4f5c","text":"<p>\u5728\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u6216\u8005\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e2d\uff0c\u90fd\u662f\u4ee5\u5f53\u524d\u65f6\u95f4\u4e3a\u57fa\u51c6\uff1a</p> <pre><code>http_request_total{} # \u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\uff0c\u9009\u62e9\u5f53\u524d\u6700\u65b0\u7684\u6570\u636e\nhttp_request_total{}[5m] # \u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\uff0c\u9009\u62e9\u4ee5\u5f53\u524d\u65f6\u95f4\u4e3a\u57fa\u51c6\uff0c5\u5206\u949f\u5185\u7684\u6570\u636e\n</code></pre> <p>\u800c\u5982\u679c\u6211\u4eec\u60f3\u67e5\u8be2\uff0c5\u5206\u949f\u524d\u7684\u77ac\u65f6\u6837\u672c\u6570\u636e\uff0c\u6216\u6628\u5929\u4e00\u5929\u7684\u533a\u95f4\u5185\u7684\u6837\u672c\u6570\u636e\u5462? \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4f4d\u79fb\u64cd\u4f5c\uff0c\u4f4d\u79fb\u64cd\u4f5c\u7684\u5173\u952e\u5b57\u4e3aoffset\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528offset\u65f6\u95f4\u4f4d\u79fb\u64cd\u4f5c\uff1a</p> <pre><code>http_request_total{} offset 5m\nhttp_request_total{}[1d] offset 1d\n</code></pre>"},{"location":"promql/prometheus-query-language/#_4","title":"\u4f7f\u7528\u805a\u5408\u64cd\u4f5c","text":"<p>\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u63cf\u8ff0\u6837\u672c\u7279\u5f81\u7684\u6807\u7b7e(label)\u5728\u5e76\u975e\u552f\u4e00\u7684\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7PromQL\u67e5\u8be2\u6570\u636e\uff0c\u4f1a\u8fd4\u56de\u591a\u6761\u6ee1\u8db3\u8fd9\u4e9b\u7279\u5f81\u7ef4\u5ea6\u7684\u65f6\u95f4\u5e8f\u5217\u3002\u800cPromQL\u63d0\u4f9b\u7684\u805a\u5408\u64cd\u4f5c\u53ef\u4ee5\u7528\u6765\u5bf9\u8fd9\u4e9b\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u5904\u7406\uff0c\u5f62\u6210\u4e00\u6761\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code># \u67e5\u8be2\u7cfb\u7edf\u6240\u6709http\u8bf7\u6c42\u7684\u603b\u91cf\nsum(http_request_total)\n\n# \u6309\u7167mode\u8ba1\u7b97\u4e3b\u673aCPU\u7684\u5e73\u5747\u4f7f\u7528\u65f6\u95f4\navg(node_cpu) by (mode)\n\n# \u6309\u7167\u4e3b\u673a\u67e5\u8be2\u5404\u4e2a\u4e3b\u673a\u7684CPU\u4f7f\u7528\u7387\nsum(sum(irate(node_cpu{mode!='idle'}[5m]))  / sum(irate(node_cpu[5m]))) by (instance)\n</code></pre>"},{"location":"promql/prometheus-query-language/#_5","title":"\u6807\u91cf\u548c\u5b57\u7b26\u4e32","text":"<p>\u9664\u4e86\u4f7f\u7528\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u548c\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4ee5\u5916\uff0cPromQL\u8fd8\u76f4\u63a5\u652f\u6301\u7528\u6237\u4f7f\u7528\u6807\u91cf(Scalar)\u548c\u5b57\u7b26\u4e32(String)\u3002</p>"},{"location":"promql/prometheus-query-language/#scalar","title":"\u6807\u91cf\uff08Scalar\uff09\uff1a\u4e00\u4e2a\u6d6e\u70b9\u578b\u7684\u6570\u5b57\u503c","text":"<p>\u6807\u91cf\u53ea\u6709\u4e00\u4e2a\u6570\u5b57\uff0c\u6ca1\u6709\u65f6\u5e8f\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>10\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53\u4f7f\u7528\u8868\u8fbe\u5f0fcount(http_requests_total)\uff0c\u8fd4\u56de\u7684\u6570\u636e\u7c7b\u578b\uff0c\u4f9d\u7136\u662f\u77ac\u65f6\u5411\u91cf\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5185\u7f6e\u51fd\u6570scalar()\u5c06\u5355\u4e2a\u77ac\u65f6\u5411\u91cf\u8f6c\u6362\u4e3a\u6807\u91cf\u3002</p>"},{"location":"promql/prometheus-query-language/#string","title":"\u5b57\u7b26\u4e32\uff08String\uff09\uff1a\u4e00\u4e2a\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u503c","text":"<p>\u76f4\u63a5\u4f7f\u7528\u5b57\u7b26\u4e32\uff0c\u4f5c\u4e3aPromQL\u8868\u8fbe\u5f0f\uff0c\u5219\u4f1a\u76f4\u63a5\u8fd4\u56de\u5b57\u7b26\u4e32\u3002</p> <pre><code>\"this is a string\"\n'these are unescaped: \\n \\\\ \\t'\n`these are not unescaped: \\n ' \" \\t`\n</code></pre>"},{"location":"promql/prometheus-query-language/#promql_1","title":"\u5408\u6cd5\u7684PromQL\u8868\u8fbe\u5f0f","text":"<p>\u6240\u6709\u7684PromQL\u8868\u8fbe\u5f0f\u90fd\u5fc5\u987b\u81f3\u5c11\u5305\u542b\u4e00\u4e2a\u6307\u6807\u540d\u79f0(\u4f8b\u5982http_request_total)\uff0c\u6216\u8005\u4e00\u4e2a\u4e0d\u4f1a\u5339\u914d\u5230\u7a7a\u5b57\u7b26\u4e32\u7684\u6807\u7b7e\u8fc7\u6ee4\u5668(\u4f8b\u5982{code=\"200\"})\u3002</p> <p>\u56e0\u6b64\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\uff0c\u5747\u4e3a\u5408\u6cd5\u7684\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>http_request_total # \u5408\u6cd5\nhttp_request_total{} # \u5408\u6cd5\n{method=\"get\"} # \u5408\u6cd5\n</code></pre> <p>\u800c\u5982\u4e0b\u8868\u8fbe\u5f0f\uff0c\u5219\u4e0d\u5408\u6cd5\uff1a</p> <pre><code>{job=~\".*\"} # \u4e0d\u5408\u6cd5\n</code></pre> <p>\u540c\u65f6\uff0c\u9664\u4e86\u4f7f\u7528<code>&lt;metric name&gt;{label=value}</code>\u7684\u5f62\u5f0f\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5185\u7f6e\u7684<code>__name__</code>\u6807\u7b7e\u6765\u6307\u5b9a\u76d1\u63a7\u6307\u6807\u540d\u79f0\uff1a</p> <pre><code>{__name__=~\"http_request_total\"} # \u5408\u6cd5\n{__name__=~\"node_disk_bytes_read|node_disk_bytes_written\"} # \u5408\u6cd5\n</code></pre>"},{"location":"promql/what-is-prometheus-metrics-and-labels/","title":"\u7406\u89e3\u65f6\u95f4\u5e8f\u5217","text":"<p>\u57281.2\u8282\u5f53\u4e2d\uff0c\u901a\u8fc7Node Exporter\u66b4\u9732\u7684HTTP\u670d\u52a1\uff0cPrometheus\u53ef\u4ee5\u91c7\u96c6\u5230\u5f53\u524d\u4e3b\u673a\u6240\u6709\u76d1\u63a7\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u3002\u4f8b\u5982\uff1a</p> <pre><code># HELP node_cpu Seconds the cpus spent in each mode.\n# TYPE node_cpu counter\nnode_cpu{cpu=\"cpu0\",mode=\"idle\"} 362812.7890625\n# HELP node_load1 1m load average.\n# TYPE node_load1 gauge\nnode_load1 3.0703125\n</code></pre> <p>\u5176\u4e2d\u975e#\u5f00\u5934\u7684\u6bcf\u4e00\u884c\u8868\u793a\u5f53\u524dNode Exporter\u91c7\u96c6\u5230\u7684\u4e00\u4e2a\u76d1\u63a7\u6837\u672c\uff1anode_cpu\u548cnode_load1\u8868\u660e\u4e86\u5f53\u524d\u6307\u6807\u7684\u540d\u79f0\u3001\u5927\u62ec\u53f7\u4e2d\u7684\u6807\u7b7e\u5219\u53cd\u6620\u4e86\u5f53\u524d\u6837\u672c\u7684\u4e00\u4e9b\u7279\u5f81\u548c\u7ef4\u5ea6\u3001\u6d6e\u70b9\u6570\u5219\u662f\u8be5\u76d1\u63a7\u6837\u672c\u7684\u5177\u4f53\u503c\u3002</p>"},{"location":"promql/what-is-prometheus-metrics-and-labels/#_2","title":"\u6837\u672c","text":"<p>Prometheus\u4f1a\u5c06\u6240\u6709\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u4ee5\u65f6\u95f4\u5e8f\u5217\uff08time-series\uff09\u7684\u65b9\u5f0f\u4fdd\u5b58\u5728\u5185\u5b58\u6570\u636e\u5e93\u4e2d\uff0c\u5e76\u4e14\u5b9a\u65f6\u4fdd\u5b58\u5230\u786c\u76d8\u4e0a\u3002time-series\u662f\u6309\u7167\u65f6\u95f4\u6233\u548c\u503c\u7684\u5e8f\u5217\u987a\u5e8f\u5b58\u653e\u7684\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u5411\u91cf(vector). \u6bcf\u6761time-series\u901a\u8fc7\u6307\u6807\u540d\u79f0(metrics name)\u548c\u4e00\u7ec4\u6807\u7b7e\u96c6(labelset)\u547d\u540d\u3002\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u5c06time-series\u7406\u89e3\u4e3a\u4e00\u4e2a\u4ee5\u65f6\u95f4\u4e3aY\u8f74\u7684\u6570\u5b57\u77e9\u9635\uff1a</p> <pre><code>  ^\n  \u2502   . . . . . . . . . . . . . . . . .   . .   node_cpu{cpu=\"cpu0\",mode=\"idle\"}\n  \u2502     . . . . . . . . . . . . . . . . . . .   node_cpu{cpu=\"cpu0\",mode=\"system\"}\n  \u2502     . . . . . . . . . .   . . . . . . . .   node_load1{}\n  \u2502     . . . . . . . . . . . . . . . .   . .  \n  v\n    &lt;------------------ \u65f6\u95f4 ----------------&gt;\n</code></pre> <p>\u5728time-series\u4e2d\u7684\u6bcf\u4e00\u4e2a\u70b9\u79f0\u4e3a\u4e00\u4e2a\u6837\u672c\uff08sample\uff09\uff0c\u6837\u672c\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u6307\u6807(metric)\uff1ametric name\u548c\u63cf\u8ff0\u5f53\u524d\u6837\u672c\u7279\u5f81\u7684labelsets;</li> <li>\u65f6\u95f4\u6233(timestamp)\uff1a\u4e00\u4e2a\u7cbe\u786e\u5230\u6beb\u79d2\u7684\u65f6\u95f4\u6233;</li> <li>\u6837\u672c\u503c(value)\uff1a \u4e00\u4e2afloat64\u7684\u6d6e\u70b9\u578b\u6570\u636e\u8868\u793a\u5f53\u524d\u6837\u672c\u7684\u503c\u3002</li> </ul> <pre><code>&lt;--------------- metric ---------------------&gt;&lt;-timestamp -&gt;&lt;-value-&gt;\nhttp_request_total{status=\"200\", method=\"GET\"}@1434417560938 =&gt; 94355\nhttp_request_total{status=\"200\", method=\"GET\"}@1434417561287 =&gt; 94334\n\nhttp_request_total{status=\"404\", method=\"GET\"}@1434417560938 =&gt; 38473\nhttp_request_total{status=\"404\", method=\"GET\"}@1434417561287 =&gt; 38544\n\nhttp_request_total{status=\"200\", method=\"POST\"}@1434417560938 =&gt; 4748\nhttp_request_total{status=\"200\", method=\"POST\"}@1434417561287 =&gt; 4785\n</code></pre>"},{"location":"promql/what-is-prometheus-metrics-and-labels/#metric","title":"\u6307\u6807(Metric)","text":"<p>\u5728\u5f62\u5f0f\u4e0a\uff0c\u6240\u6709\u7684\u6307\u6807(Metric)\u90fd\u901a\u8fc7\u5982\u4e0b\u683c\u5f0f\u6807\u793a\uff1a</p> <pre><code>&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}\n</code></pre> <p>\u6307\u6807\u7684\u540d\u79f0(metric name)\u53ef\u4ee5\u53cd\u6620\u88ab\u76d1\u63a7\u6837\u672c\u7684\u542b\u4e49\uff08\u6bd4\u5982\uff0c<code>http_request_total</code> - \u8868\u793a\u5f53\u524d\u7cfb\u7edf\u63a5\u6536\u5230\u7684HTTP\u8bf7\u6c42\u603b\u91cf\uff09\u3002\u6307\u6807\u540d\u79f0\u53ea\u80fd\u7531ASCII\u5b57\u7b26\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf\u4ee5\u53ca\u5192\u53f7\u7ec4\u6210\u5e76\u5fc5\u987b\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>\u3002</p> <p>\u6807\u7b7e(label)\u53cd\u6620\u4e86\u5f53\u524d\u6837\u672c\u7684\u7279\u5f81\u7ef4\u5ea6\uff0c\u901a\u8fc7\u8fd9\u4e9b\u7ef4\u5ea6Prometheus\u53ef\u4ee5\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\uff0c\u805a\u5408\u7b49\u3002\u6807\u7b7e\u7684\u540d\u79f0\u53ea\u80fd\u7531ASCII\u5b57\u7b26\u3001\u6570\u5b57\u4ee5\u53ca\u4e0b\u5212\u7ebf\u7ec4\u6210\u5e76\u6ee1\u8db3\u6b63\u5219\u8868\u8fbe\u5f0f<code>[a-zA-Z_][a-zA-Z0-9_]*</code>\u3002</p> <p>\u5176\u4e2d\u4ee5<code>__</code>\u4f5c\u4e3a\u524d\u7f00\u7684\u6807\u7b7e\uff0c\u662f\u7cfb\u7edf\u4fdd\u7559\u7684\u5173\u952e\u5b57\uff0c\u53ea\u80fd\u5728\u7cfb\u7edf\u5185\u90e8\u4f7f\u7528\u3002\u6807\u7b7e\u7684\u503c\u5219\u53ef\u4ee5\u5305\u542b\u4efb\u4f55Unicode\u7f16\u7801\u7684\u5b57\u7b26\u3002\u5728Prometheus\u7684\u5e95\u5c42\u5b9e\u73b0\u4e2d\u6307\u6807\u540d\u79f0\u5b9e\u9645\u4e0a\u662f\u4ee5<code>__name__=&lt;metric name&gt;</code>\u7684\u5f62\u5f0f\u4fdd\u5b58\u5728\u6570\u636e\u5e93\u4e2d\u7684\uff0c\u56e0\u6b64\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u5747\u8868\u793a\u7684\u540c\u4e00\u6761time-series\uff1a</p> <pre><code>api_http_requests_total{method=\"POST\", handler=\"/messages\"}\n</code></pre> <p>\u7b49\u540c\u4e8e\uff1a</p> <pre><code>{__name__=\"api_http_requests_total\"\uff0cmethod=\"POST\", handler=\"/messages\"}\n</code></pre> <p>\u5728Prometheus\u6e90\u7801\u4e2d\u4e5f\u53ef\u4ee5\u627e\u5230\u6307\u6807(Metric)\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>type Metric LabelSet\n\ntype LabelSet map[LabelName]LabelValue\n\ntype LabelName string\n\ntype LabelValue string\n</code></pre>"},{"location":"quickstart/","title":"\u7b2c1\u7ae0\uff1a \u5929\u964d\u5947\u5175","text":"<p>\u672c\u7ae0\u4f5c\u4e3a\u5168\u4e66\u7684\u5f00\u7bc7\uff0c\u6211\u4eec\u4f1a\u5e26\u8bfb\u8005\u4e86\u89e3Prometheus\u7684\u524d\u4e16\u4eca\u751f\uff0cPrometheus\u662f\u5982\u4f55\u4ece\u4f17\u591a\u7684\u76d1\u63a7\u5e73\u53f0\u4e2d\u8131\u9896\u800c\u51fa\u6210\u4e3a\u4e0b\u4e00\u4ee3\u76d1\u63a7\u7cfb\u7edf\u7684\u9996\u9009\u3002\u540c\u65f6\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u5e26\u9886\u8bfb\u8005\u5feb\u901f\u4e86\u89e3Prometheus\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ece\u800c\u4e86\u89e3Prometheus\u4e2d\u7684\u4e00\u4e9b\u6982\u5ff5\u4ee5\u53ca\u67b6\u6784\u6a21\u5f0f\u3002</p> <p>\u672c\u7ae0\u5185\u5bb9\uff1a</p> <ul> <li>Prometheus\u7684\u524d\u4e16\u4eca\u751f</li> <li>\u4f7f\u7528Prometheus\u76d1\u63a7\u4e3b\u673a</li> <li>Prometheus\u7684\u6838\u5fc3\u7ec4\u4ef6\u548c\u6982\u5ff5</li> </ul>"},{"location":"quickstart/SUMMARY/","title":"\u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u5728\u8fd9\u4e00\u7ae0\u4e2d\uff0c\u6211\u4eec\u521d\u6b65\u4e86\u89e3\u4e86Prometheus\u4ee5\u53ca\u76f8\u6bd4\u4e8e\u5176\u4ed6\u76f8\u4f3c\u65b9\u6848\u7684\u4f18\u7f3a\u70b9\uff0c\u53ef\u4ee5\u4e3a\u8bfb\u8005\u5728\u9009\u62e9\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u65f6\uff0c\u63d0\u4f9b\u4e00\u5b9a\u7684\u53c2\u8003\u3002\u540c\u65f6\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u7684\u751f\u6001\u4ee5\u53ca\u6838\u5fc3\u80fd\u529b\uff0c\u5728\u672c\u5730\u4f7f\u7528Prometheus\u548cNodeExporter\u642d\u5efa\u4e86\u4e00\u4e2a\u4e3b\u673a\u76d1\u63a7\u7684\u73af\u5883\uff0c\u5e76\u4e14\u5bf9\u6570\u636e\u8fdb\u884c\u4e86\u805a\u5408\u4ee5\u53ca\u53ef\u89c6\u5316\uff0c\u76f8\u4fe1\u8bfb\u8005\u901a\u8fc7\u672c\u7ae0\u80fd\u591f\u5bf9Prometheus\u6709\u4e00\u4e2a\u76f4\u89c2\u7684\u8ba4\u8bc6\u3002</p>"},{"location":"quickstart/install-prometheus-server/","title":"\u5b89\u88c5Prometheus Server","text":"<p>Prometheus\u57fa\u4e8eGolang\u7f16\u5199\uff0c\u7f16\u8bd1\u540e\u7684\u8f6f\u4ef6\u5305\uff0c\u4e0d\u4f9d\u8d56\u4e8e\u4efb\u4f55\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\u3002\u7528\u6237\u53ea\u9700\u8981\u4e0b\u8f7d\u5bf9\u5e94\u5e73\u53f0\u7684\u4e8c\u8fdb\u5236\u5305\uff0c\u89e3\u538b\u5e76\u4e14\u6dfb\u52a0\u57fa\u672c\u7684\u914d\u7f6e\u5373\u53ef\u6b63\u5e38\u542f\u52a8Prometheus Server\u3002</p>"},{"location":"quickstart/install-prometheus-server/#_1","title":"\u4ece\u4e8c\u8fdb\u5236\u5305\u5b89\u88c5","text":"<p>\u5bf9\u4e8e\u975eDocker\u7528\u6237\uff0c\u53ef\u4ee5\u4ecehttps://prometheus.io/download/\u627e\u5230\u6700\u65b0\u7248\u672c\u7684Prometheus Sevrer\u8f6f\u4ef6\u5305\uff1a</p> <pre><code>export VERSION=2.4.3\ncurl -LO  https://github.com/prometheus/prometheus/releases/download/v$VERSION/prometheus-$VERSION.darwin-amd64.tar.gz\n</code></pre> <p>\u89e3\u538b\uff0c\u5e76\u5c06Prometheus\u76f8\u5173\u7684\u547d\u4ee4\uff0c\u6dfb\u52a0\u5230\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u8def\u5f84\u5373\u53ef\uff1a</p> <pre><code>tar -xzf prometheus-${VERSION}.darwin-amd64.tar.gz\ncd prometheus-${VERSION}.darwin-amd64\n</code></pre> <p>\u89e3\u538b\u540e\u5f53\u524d\u76ee\u5f55\u4f1a\u5305\u542b\u9ed8\u8ba4\u7684Prometheus\u914d\u7f6e\u6587\u4ef6prometheus.yml:</p> <pre><code># my global config\nglobal:\n  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      # - alertmanager:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n    - targets: ['localhost:9090']\n</code></pre> <p>Prometheus\u4f5c\u4e3a\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff0c\u5176\u91c7\u96c6\u7684\u6570\u636e\u4f1a\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u5b58\u50a8\u5728\u672c\u5730\u4e2d\uff0c\u9ed8\u8ba4\u7684\u5b58\u50a8\u8def\u5f84\u4e3a<code>data/</code>\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5148\u624b\u52a8\u521b\u5efa\u8be5\u76ee\u5f55\uff1a</p> <pre><code>mkdir -p data\n</code></pre> <p>\u7528\u6237\u4e5f\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570<code>--storage.tsdb.path=\"data/\"</code>\u4fee\u6539\u672c\u5730\u6570\u636e\u5b58\u50a8\u7684\u8def\u5f84\u3002</p> <p>\u542f\u52a8prometheus\u670d\u52a1\uff0c\u5176\u4f1a\u9ed8\u8ba4\u52a0\u8f7d\u5f53\u524d\u8def\u5f84\u4e0b\u7684prometheus.yaml\u6587\u4ef6\uff1a</p> <pre><code>./prometheus\n</code></pre> <p>\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\u5185\u5bb9\uff1a</p> <pre><code>level=info ts=2018-10-23T14:55:14.499484Z caller=main.go:554 msg=\"Starting TSDB ...\"\nlevel=info ts=2018-10-23T14:55:14.499531Z caller=web.go:397 component=web msg=\"Start listening for connections\" address=0.0.0.0:9090\nlevel=info ts=2018-10-23T14:55:14.507999Z caller=main.go:564 msg=\"TSDB started\"\nlevel=info ts=2018-10-23T14:55:14.508068Z caller=main.go:624 msg=\"Loading configuration file\" filename=prometheus.yml\nlevel=info ts=2018-10-23T14:55:14.509509Z caller=main.go:650 msg=\"Completed loading of configuration file\" filename=prometheus.yml\nlevel=info ts=2018-10-23T14:55:14.509537Z caller=main.go:523 msg=\"Server is ready to receive web requests.\"\n</code></pre>"},{"location":"quickstart/install-prometheus-server/#_2","title":"\u4f7f\u7528\u5bb9\u5668\u5b89\u88c5","text":"<p>\u5bf9\u4e8eDocker\u7528\u6237\uff0c\u76f4\u63a5\u4f7f\u7528Prometheus\u7684\u955c\u50cf\u5373\u53ef\u542f\u52a8Prometheus Server\uff1a</p> <pre><code>docker run -p 9090:9090 -v /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7http://localhost:9090\u8bbf\u95eePrometheus\u7684UI\u754c\u9762\uff1a</p> <p></p>"},{"location":"quickstart/prometheus-arch/","title":"Prometheus\u7ec4\u4ef6","text":"<p>\u4e0a\u4e00\u5c0f\u8282\uff0c\u901a\u8fc7\u90e8\u7f72Node Exporter\u6211\u4eec\u6210\u529f\u7684\u83b7\u53d6\u5230\u4e86\u5f53\u524d\u4e3b\u673a\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4ecePrometheus\u7684\u67b6\u6784\u89d2\u5ea6\u8be6\u7ec6\u4ecb\u7ecdPrometheus\u751f\u6001\u4e2d\u7684\u5404\u4e2a\u7ec4\u4ef6\u3002</p> <p>\u4e0b\u56fe\u5c55\u793aPrometheus\u7684\u57fa\u672c\u67b6\u6784\uff1a</p> <p></p>"},{"location":"quickstart/prometheus-arch/#prometheus-server","title":"Prometheus Server","text":"<p>Prometheus Server\u662fPrometheus\u7ec4\u4ef6\u4e2d\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u8d1f\u8d23\u5b9e\u73b0\u5bf9\u76d1\u63a7\u6570\u636e\u7684\u83b7\u53d6\uff0c\u5b58\u50a8\u4ee5\u53ca\u67e5\u8be2\u3002 Prometheus Server\u53ef\u4ee5\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u7ba1\u7406\u76d1\u63a7\u76ee\u6807\uff0c\u4e5f\u53ef\u4ee5\u914d\u5408\u4f7f\u7528Service Discovery\u7684\u65b9\u5f0f\u52a8\u6001\u7ba1\u7406\u76d1\u63a7\u76ee\u6807\uff0c\u5e76\u4ece\u8fd9\u4e9b\u76d1\u63a7\u76ee\u6807\u4e2d\u83b7\u53d6\u6570\u636e\u3002\u5176\u6b21Prometheus Server\u9700\u8981\u5bf9\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u5b58\u50a8\uff0cPrometheus Server\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5c06\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6570\u636e\u6309\u7167\u65f6\u95f4\u5e8f\u5217\u7684\u65b9\u5f0f\u5b58\u50a8\u5728\u672c\u5730\u78c1\u76d8\u5f53\u4e2d\u3002\u6700\u540ePrometheus Server\u5bf9\u5916\u63d0\u4f9b\u4e86\u81ea\u5b9a\u4e49\u7684PromQL\u8bed\u8a00\uff0c\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u67e5\u8be2\u4ee5\u53ca\u5206\u6790\u3002</p> <p>Prometheus Server\u5185\u7f6e\u7684Express Browser UI\uff0c\u901a\u8fc7\u8fd9\u4e2aUI\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7PromQL\u5b9e\u73b0\u6570\u636e\u7684\u67e5\u8be2\u4ee5\u53ca\u53ef\u89c6\u5316\u3002</p> <p>Prometheus Server\u7684\u8054\u90a6\u96c6\u7fa4\u80fd\u529b\u53ef\u4ee5\u4f7f\u5176\u4ece\u5176\u4ed6\u7684Prometheus Server\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u56e0\u6b64\u5728\u5927\u89c4\u6a21\u76d1\u63a7\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7\u8054\u90a6\u96c6\u7fa4\u4ee5\u53ca\u529f\u80fd\u5206\u533a\u7684\u65b9\u5f0f\u5bf9Prometheus Server\u8fdb\u884c\u6269\u5c55\u3002</p>"},{"location":"quickstart/prometheus-arch/#exporters","title":"Exporters","text":"<p>Exporter\u5c06\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u7684\u7aef\u70b9\u901a\u8fc7HTTP\u670d\u52a1\u7684\u5f62\u5f0f\u66b4\u9732\u7ed9Prometheus Server\uff0cPrometheus Server\u901a\u8fc7\u8bbf\u95ee\u8be5Exporter\u63d0\u4f9b\u7684Endpoint\u7aef\u70b9\uff0c\u5373\u53ef\u83b7\u53d6\u5230\u9700\u8981\u91c7\u96c6\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u53ef\u4ee5\u5c06Exporter\u5206\u4e3a2\u7c7b\uff1a</p> <ul> <li>\u76f4\u63a5\u91c7\u96c6\uff1a\u8fd9\u4e00\u7c7bExporter\u76f4\u63a5\u5185\u7f6e\u4e86\u5bf9Prometheus\u76d1\u63a7\u7684\u652f\u6301\uff0c\u6bd4\u5982cAdvisor\uff0cKubernetes\uff0cEtcd\uff0cGokit\u7b49\uff0c\u90fd\u76f4\u63a5\u5185\u7f6e\u4e86\u7528\u4e8e\u5411Prometheus\u66b4\u9732\u76d1\u63a7\u6570\u636e\u7684\u7aef\u70b9\u3002</li> <li>\u95f4\u63a5\u91c7\u96c6\uff1a\u95f4\u63a5\u91c7\u96c6\uff0c\u539f\u6709\u76d1\u63a7\u76ee\u6807\u5e76\u4e0d\u76f4\u63a5\u652f\u6301Prometheus\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u901a\u8fc7Prometheus\u63d0\u4f9b\u7684Client Library\u7f16\u5199\u8be5\u76d1\u63a7\u76ee\u6807\u7684\u76d1\u63a7\u91c7\u96c6\u7a0b\u5e8f\u3002\u4f8b\u5982\uff1a Mysql Exporter\uff0cJMX Exporter\uff0cConsul Exporter\u7b49\u3002</li> </ul>"},{"location":"quickstart/prometheus-arch/#alertmanager","title":"AlertManager","text":"<p>\u5728Prometheus Server\u4e2d\u652f\u6301\u57fa\u4e8ePromQL\u521b\u5efa\u544a\u8b66\u89c4\u5219\uff0c\u5982\u679c\u6ee1\u8db3PromQL\u5b9a\u4e49\u7684\u89c4\u5219\uff0c\u5219\u4f1a\u4ea7\u751f\u4e00\u6761\u544a\u8b66\uff0c\u800c\u544a\u8b66\u7684\u540e\u7eed\u5904\u7406\u6d41\u7a0b\u5219\u7531AlertManager\u8fdb\u884c\u7ba1\u7406\u3002\u5728AlertManager\u4e2d\u6211\u4eec\u53ef\u4ee5\u4e0e\u90ae\u4ef6\uff0cSlack\u7b49\u7b49\u5185\u7f6e\u7684\u901a\u77e5\u65b9\u5f0f\u8fdb\u884c\u96c6\u6210\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7Webhook\u81ea\u5b9a\u4e49\u544a\u8b66\u5904\u7406\u65b9\u5f0f\u3002AlertManager\u5373Prometheus\u4f53\u7cfb\u4e2d\u7684\u544a\u8b66\u5904\u7406\u4e2d\u5fc3\u3002</p>"},{"location":"quickstart/prometheus-arch/#pushgateway","title":"PushGateway","text":"<p>\u7531\u4e8ePrometheus\u6570\u636e\u91c7\u96c6\u57fa\u4e8ePull\u6a21\u578b\u8fdb\u884c\u8bbe\u8ba1\uff0c\u56e0\u6b64\u5728\u7f51\u7edc\u73af\u5883\u7684\u914d\u7f6e\u4e0a\u5fc5\u987b\u8981\u8ba9Prometheus Server\u80fd\u591f\u76f4\u63a5\u4e0eExporter\u8fdb\u884c\u901a\u4fe1\u3002 \u5f53\u8fd9\u79cd\u7f51\u7edc\u9700\u6c42\u65e0\u6cd5\u76f4\u63a5\u6ee1\u8db3\u65f6\uff0c\u5c31\u53ef\u4ee5\u5229\u7528PushGateway\u6765\u8fdb\u884c\u4e2d\u8f6c\u3002\u53ef\u4ee5\u901a\u8fc7PushGateway\u5c06\u5185\u90e8\u7f51\u7edc\u7684\u76d1\u63a7\u6570\u636e\u4e3b\u52a8Push\u5230Gateway\u5f53\u4e2d\u3002\u800cPrometheus Server\u5219\u53ef\u4ee5\u91c7\u7528\u540c\u6837Pull\u7684\u65b9\u5f0f\u4ecePushGateway\u4e2d\u83b7\u53d6\u5230\u76d1\u63a7\u6570\u636e\u3002</p>"},{"location":"quickstart/prometheus-job-and-instance/","title":"\u4efb\u52a1\u548c\u5b9e\u4f8b","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u901a\u8fc7\u5728prometheus.yml\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\u3002\u6211\u4eec\u8ba9Prometheus\u53ef\u4ee5\u4ecenode exporter\u66b4\u9732\u7684\u670d\u52a1\u4e2d\u83b7\u53d6\u76d1\u63a7\u6307\u6807\u6570\u636e\u3002</p> <pre><code>scrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n  - job_name: 'node'\n    static_configs:\n      - targets: ['localhost:9100']\n</code></pre> <p>\u5f53\u6211\u4eec\u9700\u8981\u91c7\u96c6\u4e0d\u540c\u7684\u76d1\u63a7\u6307\u6807(\u4f8b\u5982\uff1a\u4e3b\u673a\u3001MySQL\u3001Nginx)\u65f6\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8fd0\u884c\u76f8\u5e94\u7684\u76d1\u63a7\u91c7\u96c6\u7a0b\u5e8f\uff0c\u5e76\u4e14\u8ba9Prometheus Server\u77e5\u9053\u8fd9\u4e9bExporter\u5b9e\u4f8b\u7684\u8bbf\u95ee\u5730\u5740\u3002\u5728Prometheus\u4e2d\uff0c\u6bcf\u4e00\u4e2a\u66b4\u9732\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684HTTP\u670d\u52a1\u79f0\u4e3a\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4f8b\u5982\u5728\u5f53\u524d\u4e3b\u673a\u4e0a\u8fd0\u884c\u7684node exporter\u53ef\u4ee5\u88ab\u79f0\u4e3a\u4e00\u4e2a\u5b9e\u4f8b(Instance)\u3002</p> <p>\u800c\u4e00\u7ec4\u7528\u4e8e\u76f8\u540c\u91c7\u96c6\u76ee\u7684\u7684\u5b9e\u4f8b\uff0c\u6216\u8005\u540c\u4e00\u4e2a\u91c7\u96c6\u8fdb\u7a0b\u7684\u591a\u4e2a\u526f\u672c\u5219\u901a\u8fc7\u4e00\u4e2a\u4e00\u4e2a\u4efb\u52a1(Job)\u8fdb\u884c\u7ba1\u7406\u3002</p> <pre><code>* job: node\n    * instance 2: 1.2.3.4:9100\n    * instance 4: 5.6.7.8:9100\n</code></pre> <p>\u5f53\u524d\u5728\u6bcf\u4e00\u4e2aJob\u4e2d\u4e3b\u8981\u4f7f\u7528\u4e86\u9759\u6001\u914d\u7f6e(static_configs)\u7684\u65b9\u5f0f\u5b9a\u4e49\u76d1\u63a7\u76ee\u6807\u3002\u9664\u4e86\u9759\u6001\u914d\u7f6e\u6bcf\u4e00\u4e2aJob\u7684\u91c7\u96c6Instance\u5730\u5740\u4ee5\u5916\uff0cPrometheus\u8fd8\u652f\u6301\u4e0eDNS\u3001Consul\u3001E2C\u3001Kubernetes\u7b49\u8fdb\u884c\u96c6\u6210\u5b9e\u73b0\u81ea\u52a8\u53d1\u73b0Instance\u5b9e\u4f8b\uff0c\u5e76\u4ece\u8fd9\u4e9bInstance\u4e0a\u83b7\u53d6\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u9664\u4e86\u901a\u8fc7\u4f7f\u7528\u201cup\u201d\u8868\u8fbe\u5f0f\u67e5\u8be2\u5f53\u524d\u6240\u6709Instance\u7684\u72b6\u6001\u4ee5\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7Prometheus UI\u4e2d\u7684Targets\u9875\u9762\u67e5\u770b\u5f53\u524d\u6240\u6709\u7684\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\uff0c\u4ee5\u53ca\u5404\u4e2a\u4efb\u52a1\u4e0b\u6240\u6709\u5b9e\u4f8b\u7684\u72b6\u6001:</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u8bbf\u95eehttp://192.168.33.10:9090/targets\u76f4\u63a5\u4ecePrometheus\u7684UI\u4e2d\u67e5\u770b\u5f53\u524d\u6240\u6709\u7684\u4efb\u52a1\u4ee5\u53ca\u6bcf\u4e2a\u4efb\u52a1\u5bf9\u5e94\u7684\u5b9e\u4f8b\u4fe1\u606f\u3002</p> <p></p>"},{"location":"quickstart/prometheus-quick-start/","title":"\u521d\u8bc6Prometheus","text":"<p>Prometheus\u662f\u4e00\u4e2a\u5f00\u653e\u6027\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u7528\u6237\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u5b89\u88c5\u548c\u4f7f\u7528Prometheus\u5e76\u4e14\u80fd\u591f\u975e\u5e38\u65b9\u4fbf\u7684\u5bf9\u5176\u8fdb\u884c\u6269\u5c55\u3002\u4e3a\u4e86\u80fd\u591f\u66f4\u52a0\u76f4\u89c2\u7684\u4e86\u89e3Prometheus Server\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5728\u672c\u5730\u90e8\u7f72\u5e76\u8fd0\u884c\u4e00\u4e2aPrometheus Server\u5b9e\u4f8b\uff0c\u901a\u8fc7Node Exporter\u91c7\u96c6\u5f53\u524d\u4e3b\u673a\u7684\u7cfb\u7edf\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002 \u5e76\u901a\u8fc7Grafana\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u53ef\u89c6\u5316\u4eea\u8868\u76d8\u3002</p>"},{"location":"quickstart/promql_quickstart/","title":"\u4f7f\u7528PromQL\u67e5\u8be2\u76d1\u63a7\u6570\u636e","text":"<p>Prometheus UI\u662fPrometheus\u5185\u7f6e\u7684\u4e00\u4e2a\u53ef\u89c6\u5316\u7ba1\u7406\u754c\u9762\uff0c\u901a\u8fc7Prometheus UI\u7528\u6237\u80fd\u591f\u8f7b\u677e\u7684\u4e86\u89e3Prometheus\u5f53\u524d\u7684\u914d\u7f6e\uff0c\u76d1\u63a7\u4efb\u52a1\u8fd0\u884c\u72b6\u6001\u7b49\u3002 \u901a\u8fc7<code>Graph</code>\u9762\u677f\uff0c\u7528\u6237\u8fd8\u80fd\u76f4\u63a5\u4f7f\u7528<code>PromQL</code>\u5b9e\u65f6\u67e5\u8be2\u76d1\u63a7\u6570\u636e\uff1a</p> <p></p> <p>\u5207\u6362\u5230<code>Graph</code>\u9762\u677f\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528PromQL\u8868\u8fbe\u5f0f\u67e5\u8be2\u7279\u5b9a\u76d1\u63a7\u6307\u6807\u7684\u76d1\u63a7\u6570\u636e\u3002\u5982\u4e0b\u6240\u793a\uff0c\u67e5\u8be2\u4e3b\u673a\u8d1f\u8f7d\u53d8\u5316\u60c5\u51b5\uff0c\u53ef\u4ee5\u4f7f\u7528\u5173\u952e\u5b57<code>node_load1</code>\u53ef\u4ee5\u67e5\u8be2\u51faPrometheus\u91c7\u96c6\u5230\u7684\u4e3b\u673a\u8d1f\u8f7d\u7684\u6837\u672c\u6570\u636e\uff0c\u8fd9\u4e9b\u6837\u672c\u6570\u636e\u6309\u7167\u65f6\u95f4\u5148\u540e\u987a\u5e8f\u5c55\u793a\uff0c\u5f62\u6210\u4e86\u4e3b\u673a\u8d1f\u8f7d\u968f\u65f6\u95f4\u53d8\u5316\u7684\u8d8b\u52bf\u56fe\u8868\uff1a</p> <p></p> <p>PromQL\u662fPrometheus\u81ea\u5b9a\u4e49\u7684\u4e00\u5957\u5f3a\u5927\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff0c\u9664\u4e86\u4f7f\u7528\u76d1\u63a7\u6307\u6807\u4f5c\u4e3a\u67e5\u8be2\u5173\u952e\u5b57\u4ee5\u4e3a\uff0c\u8fd8\u5185\u7f6e\u4e86\u5927\u91cf\u7684\u51fd\u6570\uff0c\u5e2e\u52a9\u7528\u6237\u8fdb\u4e00\u6b65\u5bf9\u65f6\u5e8f\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002\u4f8b\u5982\u4f7f\u7528<code>rate()</code>\u51fd\u6570\uff0c\u53ef\u4ee5\u8ba1\u7b97\u5728\u5355\u4f4d\u65f6\u95f4\u5185\u6837\u672c\u6570\u636e\u7684\u53d8\u5316\u60c5\u51b5\u5373\u589e\u957f\u7387\uff0c\u56e0\u6b64\u901a\u8fc7\u8be5\u51fd\u6570\u6211\u4eec\u53ef\u4ee5\u8fd1\u4f3c\u7684\u901a\u8fc7CPU\u4f7f\u7528\u65f6\u95f4\u8ba1\u7b97CPU\u7684\u5229\u7528\u7387\uff1a</p> <pre><code>rate(node_cpu[2m])\n</code></pre> <p></p> <p>\u8fd9\u65f6\u5982\u679c\u8981\u5ffd\u7565\u662f\u54ea\u4e00\u4e2aCPU\u7684\uff0c\u53ea\u9700\u8981\u4f7f\u7528without\u8868\u8fbe\u5f0f\uff0c\u5c06\u6807\u7b7eCPU\u53bb\u9664\u540e\u805a\u5408\u6570\u636e\u5373\u53ef\uff1a</p> <pre><code>avg without(cpu) (rate(node_cpu[2m]))\n</code></pre> <p></p> <p>\u90a3\u5982\u679c\u9700\u8981\u8ba1\u7b97\u7cfb\u7edfCPU\u7684\u603b\u4f53\u4f7f\u7528\u7387\uff0c\u901a\u8fc7\u6392\u9664\u7cfb\u7edf\u95f2\u7f6e\u7684CPU\u4f7f\u7528\u7387\u5373\u53ef\u83b7\u5f97:</p> <pre><code>1 - avg without(cpu) (rate(node_cpu{mode=\"idle\"}[2m]))\n</code></pre> <p></p> <p>\u901a\u8fc7PromQL\u6211\u4eec\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u5bf9\u6570\u636e\u8fdb\u884c\u67e5\u8be2\uff0c\u8fc7\u6ee4\uff0c\u4ee5\u53ca\u805a\u5408\uff0c\u8ba1\u7b97\u7b49\u64cd\u4f5c\u3002\u901a\u8fc7\u8fd9\u4e9b\u4e30\u5bcc\u7684\u8868\u8fbe\u4e66\u8bed\u53e5\uff0c\u76d1\u63a7\u6307\u6807\u4e0d\u518d\u662f\u4e00\u4e2a\u5355\u72ec\u5b58\u5728\u7684\u4e2a\u4f53\uff0c\u800c\u662f\u4e00\u4e2a\u4e2a\u80fd\u591f\u8868\u8fbe\u51fa\u6b63\u5f0f\u4e1a\u52a1\u542b\u4e49\u7684\u8bed\u8a00\u3002</p>"},{"location":"quickstart/use-grafana-create-dashboard/","title":"\u4f7f\u7528Grafana\u521b\u5efa\u53ef\u89c6\u5316Dashboard","text":"<p>Prometheus UI\u63d0\u4f9b\u4e86\u5feb\u901f\u9a8c\u8bc1PromQL\u4ee5\u53ca\u4e34\u65f6\u53ef\u89c6\u5316\u652f\u6301\u7684\u80fd\u529b\uff0c\u800c\u5728\u5927\u591a\u6570\u573a\u666f\u4e0b\u5f15\u5165\u76d1\u63a7\u7cfb\u7edf\u901a\u5e38\u8fd8\u9700\u8981\u6784\u5efa\u53ef\u4ee5\u957f\u671f\u4f7f\u7528\u7684\u76d1\u63a7\u6570\u636e\u53ef\u89c6\u5316\u9762\u677f\uff08Dashboard\uff09\u3002\u8fd9\u65f6\u7528\u6237\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u7b2c\u4e09\u65b9\u7684\u53ef\u89c6\u5316\u5de5\u5177\u5982Grafana\uff0cGrafana\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u53ef\u89c6\u5316\u5e73\u53f0\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u5bf9Prometheus\u7684\u5b8c\u6574\u652f\u6301\u3002</p> <pre><code>docker run -d -p 3000:3000 grafana/grafana\n</code></pre> <p>\u8bbf\u95eehttp://localhost:3000\u5c31\u53ef\u4ee5\u8fdb\u5165\u5230Grafana\u7684\u754c\u9762\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u8d26\u6237admin/admin\u8fdb\u884c\u767b\u5f55\u3002\u5728Grafana\u9996\u9875\u4e2d\u663e\u793a\u9ed8\u8ba4\u7684\u4f7f\u7528\u5411\u5bfc\uff0c\u5305\u62ec\uff1a\u5b89\u88c5\u3001\u6dfb\u52a0\u6570\u636e\u6e90\u3001\u521b\u5efaDashboard\u3001\u9080\u8bf7\u6210\u5458\u3001\u4ee5\u53ca\u5b89\u88c5\u5e94\u7528\u548c\u63d2\u4ef6\u7b49\u4e3b\u8981\u6d41\u7a0b:</p> <p></p> <p>\u8fd9\u91cc\u5c06\u6dfb\u52a0Prometheus\u4f5c\u4e3a\u9ed8\u8ba4\u7684\u6570\u636e\u6e90\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6307\u5b9a\u6570\u636e\u6e90\u7c7b\u578b\u4e3aPrometheus\u5e76\u4e14\u8bbe\u7f6ePrometheus\u7684\u8bbf\u95ee\u5730\u5740\u5373\u53ef\uff0c\u5728\u914d\u7f6e\u6b63\u786e\u7684\u60c5\u51b5\u4e0b\u70b9\u51fb\u201cAdd\u201d\u6309\u94ae\uff0c\u4f1a\u63d0\u793a\u8fde\u63a5\u6210\u529f\u7684\u4fe1\u606f\uff1a</p> <p></p> <p>\u5728\u5b8c\u6210\u6570\u636e\u6e90\u7684\u6dfb\u52a0\u4e4b\u540e\u5c31\u53ef\u4ee5\u5728Grafana\u4e2d\u521b\u5efa\u6211\u4eec\u53ef\u89c6\u5316Dashboard\u4e86\u3002Grafana\u63d0\u4f9b\u4e86\u5bf9PromQL\u7684\u5b8c\u6574\u652f\u6301\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u901a\u8fc7Grafana\u6dfb\u52a0Dashboard\u5e76\u4e14\u4e3a\u8be5Dashboard\u6dfb\u52a0\u4e00\u4e2a\u7c7b\u578b\u4e3a\u201cGraph\u201d\u7684\u9762\u677f\u3002 \u5e76\u5728\u8be5\u9762\u677f\u7684\u201cMetrics\u201d\u9009\u9879\u4e0b\u901a\u8fc7PromQL\u67e5\u8be2\u9700\u8981\u53ef\u89c6\u5316\u7684\u6570\u636e\uff1a</p> <p></p> <p>\u70b9\u51fb\u754c\u9762\u4e2d\u7684\u4fdd\u5b58\u9009\u9879\uff0c\u5c31\u521b\u5efa\u4e86\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u53ef\u89c6\u5316Dashboard\u4e86\u3002 \u5f53\u7136\u4f5c\u4e3a\u5f00\u6e90\u8f6f\u4ef6\uff0cGrafana\u793e\u533a\u9f13\u52b1\u7528\u6237\u5206\u4eabDashboard\u901a\u8fc7https://grafana.com/dashboards\u7f51\u7ad9\uff0c\u53ef\u4ee5\u627e\u5230\u5927\u91cf\u53ef\u76f4\u63a5\u4f7f\u7528\u7684Dashboard\uff1a</p> <p></p> <p>Grafana\u4e2d\u6240\u6709\u7684Dashboard\u901a\u8fc7JSON\u8fdb\u884c\u5171\u4eab\uff0c\u4e0b\u8f7d\u5e76\u4e14\u5bfc\u5165\u8fd9\u4e9bJSON\u6587\u4ef6\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u5df2\u7ecf\u5b9a\u4e49\u597d\u7684Dashboard\uff1a</p> <p></p>"},{"location":"quickstart/use-node-exporter/","title":"\u4f7f\u7528Node Exporter\u91c7\u96c6\u4e3b\u673a\u8fd0\u884c\u6570\u636e","text":""},{"location":"quickstart/use-node-exporter/#node-exporter_1","title":"\u5b89\u88c5Node Exporter","text":"<p>\u5728Prometheus\u7684\u67b6\u6784\u8bbe\u8ba1\u4e2d\uff0cPrometheus Server\u5e76\u4e0d\u76f4\u63a5\u670d\u52a1\u76d1\u63a7\u7279\u5b9a\u7684\u76ee\u6807\uff0c\u5176\u4e3b\u8981\u4efb\u52a1\u8d1f\u8d23\u6570\u636e\u7684\u6536\u96c6\uff0c\u5b58\u50a8\u5e76\u4e14\u5bf9\u5916\u63d0\u4f9b\u6570\u636e\u67e5\u8be2\u652f\u6301\u3002\u56e0\u6b64\u4e3a\u4e86\u80fd\u591f\u76d1\u63a7\u5230\u67d0\u4e9b\u4e1c\u897f\uff0c\u5982\u4e3b\u673a\u7684CPU\u4f7f\u7528\u7387\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230Exporter\u3002Prometheus\u5468\u671f\u6027\u7684\u4eceExporter\u66b4\u9732\u7684HTTP\u670d\u52a1\u5730\u5740\uff08\u901a\u5e38\u662f/metrics\uff09\u62c9\u53d6\u76d1\u63a7\u6837\u672c\u6570\u636e\u3002</p> <p>\u4ece\u4e0a\u9762\u7684\u63cf\u8ff0\u4e2d\u53ef\u4ee5\u770b\u51faExporter\u53ef\u4ee5\u662f\u4e00\u4e2a\u76f8\u5bf9\u5f00\u653e\u7684\u6982\u5ff5\uff0c\u5176\u53ef\u4ee5\u662f\u4e00\u4e2a\u72ec\u7acb\u8fd0\u884c\u7684\u7a0b\u5e8f\u72ec\u7acb\u4e8e\u76d1\u63a7\u76ee\u6807\u4ee5\u5916\uff0c\u4e5f\u53ef\u4ee5\u662f\u76f4\u63a5\u5185\u7f6e\u5728\u76d1\u63a7\u76ee\u6807\u4e2d\u3002\u53ea\u8981\u80fd\u591f\u5411Prometheus\u63d0\u4f9b\u6807\u51c6\u683c\u5f0f\u7684\u76d1\u63a7\u6837\u672c\u6570\u636e\u5373\u53ef\u3002</p> <p>\u8fd9\u91cc\u4e3a\u4e86\u80fd\u591f\u91c7\u96c6\u5230\u4e3b\u673a\u7684\u8fd0\u884c\u6307\u6807\u5982CPU, \u5185\u5b58\uff0c\u78c1\u76d8\u7b49\u4fe1\u606f\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Node Exporter\u3002</p> <p>Node Exporter\u540c\u6837\u91c7\u7528Golang\u7f16\u5199\uff0c\u5e76\u4e14\u4e0d\u5b58\u5728\u4efb\u4f55\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\uff0c\u53ea\u9700\u8981\u4e0b\u8f7d\uff0c\u89e3\u538b\u5373\u53ef\u8fd0\u884c\u3002\u53ef\u4ee5\u4ecehttps://prometheus.io/download/\u83b7\u53d6\u6700\u65b0\u7684node exporter\u7248\u672c\u7684\u4e8c\u8fdb\u5236\u5305\u3002</p> <pre><code>curl -OL https://github.com/prometheus/node_exporter/releases/download/v0.15.2/node_exporter-0.15.2.darwin-amd64.tar.gz\ntar -xzf node_exporter-0.15.2.darwin-amd64.tar.gz\n</code></pre> <p>\u8fd0\u884cnode exporter:</p> <pre><code>cd node_exporter-0.15.2.darwin-amd64\ncp node_exporter-0.15.2.darwin-amd64/node_exporter /usr/local/bin/\nnode_exporter\n</code></pre> <p>\u542f\u52a8\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>INFO[0000] Listening on :9100                            source=\"node_exporter.go:76\"\n</code></pre> <p>\u8bbf\u95eehttp://localhost:9100/\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u9875\u9762\uff1a</p> <p></p>"},{"location":"quickstart/use-node-exporter/#node-exporter_2","title":"\u521d\u59cbNode Exporter\u76d1\u63a7\u6307\u6807","text":"<p>\u8bbf\u95eehttp://localhost:9100/metrics\uff0c\u53ef\u4ee5\u770b\u5230\u5f53\u524dnode exporter\u83b7\u53d6\u5230\u7684\u5f53\u524d\u4e3b\u673a\u7684\u6240\u6709\u76d1\u63a7\u6570\u636e\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6bcf\u4e00\u4e2a\u76d1\u63a7\u6307\u6807\u4e4b\u524d\u90fd\u4f1a\u6709\u4e00\u6bb5\u7c7b\u4f3c\u4e8e\u5982\u4e0b\u5f62\u5f0f\u7684\u4fe1\u606f\uff1a</p> <pre><code># HELP node_cpu Seconds the cpus spent in each mode.\n# TYPE node_cpu counter\nnode_cpu{cpu=\"cpu0\",mode=\"idle\"} 362812.7890625\n# HELP node_load1 1m load average.\n# TYPE node_load1 gauge\nnode_load1 3.0703125\n</code></pre> <p>\u5176\u4e2dHELP\u7528\u4e8e\u89e3\u91ca\u5f53\u524d\u6307\u6807\u7684\u542b\u4e49\uff0cTYPE\u5219\u8bf4\u660e\u5f53\u524d\u6307\u6807\u7684\u6570\u636e\u7c7b\u578b\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2dnode_cpu\u7684\u6ce8\u91ca\u8868\u660e\u5f53\u524d\u6307\u6807\u662fcpu0\u4e0aidle\u8fdb\u7a0b\u5360\u7528CPU\u7684\u603b\u65f6\u95f4\uff0cCPU\u5360\u7528\u65f6\u95f4\u662f\u4e00\u4e2a\u53ea\u589e\u4e0d\u51cf\u7684\u5ea6\u91cf\u6307\u6807\uff0c\u4ece\u7c7b\u578b\u4e2d\u4e5f\u53ef\u4ee5\u770b\u51fanode_cpu\u7684\u6570\u636e\u7c7b\u578b\u662f\u8ba1\u6570\u5668(counter)\uff0c\u4e0e\u8be5\u6307\u6807\u7684\u5b9e\u9645\u542b\u4e49\u4e00\u81f4\u3002\u53c8\u4f8b\u5982node_load1\u8be5\u6307\u6807\u53cd\u6620\u4e86\u5f53\u524d\u4e3b\u673a\u5728\u6700\u8fd1\u4e00\u5206\u949f\u4ee5\u5185\u7684\u8d1f\u8f7d\u60c5\u51b5\uff0c\u7cfb\u7edf\u7684\u8d1f\u8f7d\u60c5\u51b5\u4f1a\u968f\u7cfb\u7edf\u8d44\u6e90\u7684\u4f7f\u7528\u800c\u53d8\u5316\uff0c\u56e0\u6b64node_load1\u53cd\u6620\u7684\u662f\u5f53\u524d\u72b6\u6001\uff0c\u6570\u636e\u53ef\u80fd\u589e\u52a0\u4e5f\u53ef\u80fd\u51cf\u5c11\uff0c\u4ece\u6ce8\u91ca\u4e2d\u53ef\u4ee5\u770b\u51fa\u5f53\u524d\u6307\u6807\u7c7b\u578b\u4e3a\u4eea\u8868\u76d8(gauge)\uff0c\u4e0e\u6307\u6807\u53cd\u6620\u7684\u5b9e\u9645\u542b\u4e49\u4e00\u81f4\u3002</p> <p>\u9664\u4e86\u8fd9\u4e9b\u4ee5\u5916\uff0c\u5728\u5f53\u524d\u9875\u9762\u4e2d\u6839\u636e\u7269\u7406\u4e3b\u673a\u7cfb\u7edf\u7684\u4e0d\u540c\uff0c\u4f60\u8fd8\u53ef\u80fd\u770b\u5230\u5982\u4e0b\u76d1\u63a7\u6307\u6807\uff1a</p> <ul> <li>node_boot_time\uff1a\u7cfb\u7edf\u542f\u52a8\u65f6\u95f4</li> <li>node_cpu\uff1a\u7cfb\u7edfCPU\u4f7f\u7528\u91cf</li> <li>node_disk_*\uff1a\u78c1\u76d8IO</li> <li>node_filesystem_*\uff1a\u6587\u4ef6\u7cfb\u7edf\u7528\u91cf</li> <li>node_load1\uff1a\u7cfb\u7edf\u8d1f\u8f7d</li> <li>node_memeory_*\uff1a\u5185\u5b58\u4f7f\u7528\u91cf</li> <li>node_network_*\uff1a\u7f51\u7edc\u5e26\u5bbd</li> <li>node_time\uff1a\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4</li> <li>go_*\uff1anode exporter\u4e2dgo\u76f8\u5173\u6307\u6807</li> <li>process_*\uff1anode exporter\u81ea\u8eab\u8fdb\u7a0b\u76f8\u5173\u8fd0\u884c\u6307\u6807</li> </ul>"},{"location":"quickstart/use-node-exporter/#node-exporter_3","title":"\u4eceNode Exporter\u6536\u96c6\u76d1\u63a7\u6570\u636e","text":"<p>\u4e3a\u4e86\u80fd\u591f\u8ba9Prometheus Server\u80fd\u591f\u4ece\u5f53\u524dnode exporter\u83b7\u53d6\u5230\u76d1\u63a7\u6570\u636e\uff0c\u8fd9\u91cc\u9700\u8981\u4fee\u6539Prometheus\u914d\u7f6e\u6587\u4ef6\u3002\u7f16\u8f91prometheus.yml\u5e76\u5728scrape_configs\u8282\u70b9\u4e0b\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9:</p> <pre><code>scrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n  # \u91c7\u96c6node exporter\u76d1\u63a7\u6570\u636e\n  - job_name: 'node'\n    static_configs:\n      - targets: ['localhost:9100']\n</code></pre> <p>\u91cd\u65b0\u542f\u52a8Prometheus Server</p> <p>\u8bbf\u95eehttp://localhost:9090\uff0c\u8fdb\u5165\u5230Prometheus Server\u3002\u5982\u679c\u8f93\u5165\u201cup\u201d\u5e76\u4e14\u70b9\u51fb\u6267\u884c\u6309\u94ae\u4ee5\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p> <p></p> <p>\u5982\u679cPrometheus\u80fd\u591f\u6b63\u5e38\u4ecenode exporter\u83b7\u53d6\u6570\u636e\uff0c\u5219\u4f1a\u770b\u5230\u4ee5\u4e0b\u7ed3\u679c\uff1a</p> <pre><code>up{instance=\"localhost:9090\",job=\"prometheus\"}  1\nup{instance=\"localhost:9100\",job=\"node\"}    1\n</code></pre> <p>\u5176\u4e2d\u201c1\u201d\u8868\u793a\u6b63\u5e38\uff0c\u53cd\u4e4b\u201c0\u201d\u5219\u4e3a\u5f02\u5e38\u3002</p>"},{"location":"quickstart/why-monitor/","title":"Prometheus\u7b80\u4ecb","text":"<p>Prometheus\u53d7\u542f\u53d1\u4e8eGoogle\u7684Borgmon\u76d1\u63a7\u7cfb\u7edf\uff08\u76f8\u4f3c\u7684Kubernetes\u662f\u4eceGoogle\u7684Brog\u7cfb\u7edf\u6f14\u53d8\u800c\u6765\uff09\uff0c\u4ece2012\u5e74\u5f00\u59cb\u7531\u524dGoogle\u5de5\u7a0b\u5e08\u5728Soundcloud\u4ee5\u5f00\u6e90\u8f6f\u4ef6\u7684\u5f62\u5f0f\u8fdb\u884c\u7814\u53d1\uff0c\u5e76\u4e14\u4e8e2015\u5e74\u65e9\u671f\u5bf9\u5916\u53d1\u5e03\u65e9\u671f\u7248\u672c\u30022016\u5e745\u6708\u7ee7Kubernetes\u4e4b\u540e\u6210\u4e3a\u7b2c\u4e8c\u4e2a\u6b63\u5f0f\u52a0\u5165CNCF\u57fa\u91d1\u4f1a\u7684\u9879\u76ee\uff0c\u540c\u5e746\u6708\u6b63\u5f0f\u53d1\u5e031.0\u7248\u672c\u30022017\u5e74\u5e95\u53d1\u5e03\u4e86\u57fa\u4e8e\u5168\u65b0\u5b58\u50a8\u5c42\u76842.0\u7248\u672c\uff0c\u80fd\u66f4\u597d\u5730\u4e0e\u5bb9\u5668\u5e73\u53f0\u3001\u4e91\u5e73\u53f0\u914d\u5408\u3002</p> <p></p> <p>Prometheus\u4f5c\u4e3a\u65b0\u4e00\u4ee3\u7684\u4e91\u539f\u751f\u76d1\u63a7\u7cfb\u7edf\uff0c\u76ee\u524d\u5df2\u7ecf\u6709\u8d85\u8fc7650+\u4f4d\u8d21\u732e\u8005\u53c2\u4e0e\u5230Prometheus\u7684\u7814\u53d1\u5de5\u4f5c\u4e0a\uff0c\u5e76\u4e14\u8d85\u8fc7120+\u9879\u7684\u7b2c\u4e09\u65b9\u96c6\u6210\u3002</p>"},{"location":"quickstart/why-monitor/#_1","title":"\u76d1\u63a7\u7684\u76ee\u6807","text":"<p>\u5728\u300aSRE: Google\u8fd0\u7ef4\u89e3\u5bc6\u300b\u4e00\u4e66\u4e2d\u6307\u51fa\uff0c\u76d1\u63a7\u7cfb\u7edf\u9700\u8981\u80fd\u591f\u6709\u6548\u7684\u652f\u6301\u767d\u76d2\u76d1\u63a7\u548c\u9ed1\u76d2\u76d1\u63a7\u3002\u901a\u8fc7\u767d\u76d2\u80fd\u591f\u4e86\u89e3\u5176\u5185\u90e8\u7684\u5b9e\u9645\u8fd0\u884c\u72b6\u6001\uff0c\u901a\u8fc7\u5bf9\u76d1\u63a7\u6307\u6807\u7684\u89c2\u5bdf\u80fd\u591f\u9884\u5224\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u4ece\u800c\u5bf9\u6f5c\u5728\u7684\u4e0d\u786e\u5b9a\u56e0\u7d20\u8fdb\u884c\u4f18\u5316\u3002\u800c\u9ed1\u76d2\u76d1\u63a7\uff0c\u5e38\u89c1\u7684\u5982HTTP\u63a2\u9488\uff0cTCP\u63a2\u9488\u7b49\uff0c\u53ef\u4ee5\u5728\u7cfb\u7edf\u6216\u8005\u670d\u52a1\u5728\u53d1\u751f\u6545\u969c\u65f6\u80fd\u591f\u5feb\u901f\u901a\u77e5\u76f8\u5173\u7684\u4eba\u5458\u8fdb\u884c\u5904\u7406\u3002\u901a\u8fc7\u5efa\u7acb\u5b8c\u5584\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u4ece\u800c\u8fbe\u5230\u4ee5\u4e0b\u76ee\u7684\uff1a</p> <ul> <li>\u957f\u671f\u8d8b\u52bf\u5206\u6790\uff1a\u901a\u8fc7\u5bf9\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u6301\u7eed\u6536\u96c6\u548c\u7edf\u8ba1\uff0c\u5bf9\u76d1\u63a7\u6307\u6807\u8fdb\u884c\u957f\u671f\u8d8b\u52bf\u5206\u6790\u3002\u4f8b\u5982\uff0c\u901a\u8fc7\u5bf9\u78c1\u76d8\u7a7a\u95f4\u589e\u957f\u7387\u7684\u5224\u65ad\uff0c\u6211\u4eec\u53ef\u4ee5\u63d0\u524d\u9884\u6d4b\u5728\u672a\u6765\u4ec0\u4e48\u65f6\u95f4\u8282\u70b9\u4e0a\u9700\u8981\u5bf9\u8d44\u6e90\u8fdb\u884c\u6269\u5bb9\u3002</li> <li>\u5bf9\u7167\u5206\u6790\uff1a\u4e24\u4e2a\u7248\u672c\u7684\u7cfb\u7edf\u8fd0\u884c\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u7684\u5dee\u5f02\u5982\u4f55\uff1f\u5728\u4e0d\u540c\u5bb9\u91cf\u60c5\u51b5\u4e0b\u7cfb\u7edf\u7684\u5e76\u53d1\u548c\u8d1f\u8f7d\u53d8\u5316\u5982\u4f55\uff1f\u901a\u8fc7\u76d1\u63a7\u80fd\u591f\u65b9\u4fbf\u7684\u5bf9\u7cfb\u7edf\u8fdb\u884c\u8ddf\u8e2a\u548c\u6bd4\u8f83\u3002</li> <li>\u544a\u8b66\uff1a\u5f53\u7cfb\u7edf\u51fa\u73b0\u6216\u8005\u5373\u5c06\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u76d1\u63a7\u7cfb\u7edf\u9700\u8981\u8fc5\u901f\u53cd\u5e94\u5e76\u901a\u77e5\u7ba1\u7406\u5458\uff0c\u4ece\u800c\u80fd\u591f\u5bf9\u95ee\u9898\u8fdb\u884c\u5feb\u901f\u7684\u5904\u7406\u6216\u8005\u63d0\u524d\u9884\u9632\u95ee\u9898\u7684\u53d1\u751f\uff0c\u907f\u514d\u51fa\u73b0\u5bf9\u4e1a\u52a1\u7684\u5f71\u54cd\u3002</li> <li>\u6545\u969c\u5206\u6790\u4e0e\u5b9a\u4f4d\uff1a\u5f53\u95ee\u9898\u53d1\u751f\u540e\uff0c\u9700\u8981\u5bf9\u95ee\u9898\u8fdb\u884c\u8c03\u67e5\u548c\u5904\u7406\u3002\u901a\u8fc7\u5bf9\u4e0d\u540c\u76d1\u63a7\u4ee5\u53ca\u5386\u53f2\u6570\u636e\u7684\u5206\u6790\uff0c\u80fd\u591f\u627e\u5230\u5e76\u89e3\u51b3\u6839\u6e90\u95ee\u9898\u3002</li> <li>\u6570\u636e\u53ef\u89c6\u5316\uff1a\u901a\u8fc7\u53ef\u89c6\u5316\u4eea\u8868\u76d8\u80fd\u591f\u76f4\u63a5\u83b7\u53d6\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u6001\u3001\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3001\u4ee5\u53ca\u670d\u52a1\u8fd0\u884c\u72b6\u6001\u7b49\u76f4\u89c2\u7684\u4fe1\u606f\u3002</li> </ul>"},{"location":"quickstart/why-monitor/#_2","title":"\u4e0e\u5e38\u89c1\u76d1\u63a7\u7cfb\u7edf\u6bd4\u8f83","text":"<p>\u5bf9\u4e8e\u5e38\u7528\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5982Nagios\u3001Zabbix\u7684\u7528\u6237\u800c\u8a00\uff0c\u5f80\u5f80\u5e76\u4e0d\u80fd\u5f88\u597d\u7684\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002\u8fd9\u91cc\u4ee5Nagios\u4e3a\u4f8b\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u662fNagios\u76d1\u63a7\u7cfb\u7edf\u7684\u57fa\u672c\u67b6\u6784\uff1a</p> <p></p> <p>Nagios\u7684\u4e3b\u8981\u529f\u80fd\u662f\u76d1\u63a7\u670d\u52a1\u548c\u4e3b\u673a\u3002Nagios\u8f6f\u4ef6\u9700\u8981\u5b89\u88c5\u5728\u4e00\u53f0\u72ec\u7acb\u7684\u670d\u52a1\u5668\u4e0a\u8fd0\u884c\uff0c\u8be5\u670d\u52a1\u5668\u79f0\u4e3a\u76d1\u63a7\u4e2d\u5fc3\u3002\u6bcf\u4e00\u53f0\u88ab\u76d1\u63a7\u7684\u786c\u4ef6\u4e3b\u673a\u6216\u8005\u670d\u52a1\u90fd\u9700\u8981\u8fd0\u884c\u4e00\u4e2a\u4e0e\u76d1\u63a7\u4e2d\u5fc3\u670d\u52a1\u5668\u8fdb\u884c\u901a\u4fe1\u7684Nagios\u8f6f\u4ef6\u540e\u53f0\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3aAgent\u6216\u8005\u63d2\u4ef6\u3002</p> <p></p> <p>\u9996\u5148\u5bf9\u4e8eNagios\u800c\u8a00\uff0c\u5927\u90e8\u5206\u7684\u76d1\u63a7\u80fd\u529b\u90fd\u662f\u56f4\u7ed5\u7cfb\u7edf\u7684\u4e00\u4e9b\u8fb9\u7f18\u6027\u7684\u95ee\u9898\uff0c\u4e3b\u8981\u9488\u5bf9\u7cfb\u7edf\u670d\u52a1\u548c\u8d44\u6e90\u7684\u72b6\u6001\u4ee5\u53ca\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u7528\u6027\u3002 \u4f8b\u5982\uff1aNagios\u901a\u8fc7check_disk\u63d2\u4ef6\u53ef\u4ee5\u7528\u4e8e\u68c0\u67e5\u78c1\u76d8\u7a7a\u95f4\uff0ccheck_load\u7528\u4e8e\u68c0\u67e5CPU\u8d1f\u8f7d\u7b49\u3002\u8fd9\u4e9b\u63d2\u4ef6\u4f1a\u8fd4\u56de4\u79cdNagios\u53ef\u8bc6\u522b\u7684\u72b6\u6001\uff0c0(OK)\u8868\u793a\u6b63\u5e38\uff0c1(WARNING)\u8868\u793a\u8b66\u544a\uff0c2(CRITTCAL)\u8868\u793a\u9519\u8bef\uff0c3(UNKNOWN)\u8868\u793a\u672a\u77e5\u9519\u8bef\uff0c\u5e76\u901a\u8fc7Web UI\u663e\u793a\u51fa\u6765\u3002</p> <p>\u5bf9\u4e8eNagios\u8fd9\u7c7b\u7cfb\u7edf\u800c\u8a00\uff0c\u5176\u6838\u5fc3\u662f\u91c7\u7528\u4e86\u6d4b\u8bd5\u548c\u544a\u8b66(check&amp;alert)\u7684\u76d1\u63a7\u7cfb\u7edf\u6a21\u578b\u3002 \u5bf9\u4e8e\u57fa\u4e8e\u8fd9\u7c7b\u6a21\u578b\u7684\u76d1\u63a7\u7cfb\u7edf\u800c\u8a00\u5f80\u5f80\u5b58\u5728\u4ee5\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u4e0e\u4e1a\u52a1\u8131\u79bb\u7684\u76d1\u63a7\uff1a\u76d1\u63a7\u7cfb\u7edf\u83b7\u53d6\u5230\u7684\u76d1\u63a7\u6307\u6807\u4e0e\u4e1a\u52a1\u672c\u8eab\u4e5f\u662f\u4e00\u79cd\u5206\u79bb\u7684\u5173\u7cfb\u3002\u597d\u6bd4\u5ba2\u6237\u53ef\u80fd\u5173\u6ce8\u7684\u662f\u670d\u52a1\u7684\u53ef\u7528\u6027\u3001\u670d\u52a1\u7684SLA\u7b49\u7ea7\uff0c\u800c\u76d1\u63a7\u7cfb\u7edf\u5374\u53ea\u80fd\u6839\u636e\u7cfb\u7edf\u8d1f\u8f7d\u53bb\u4ea7\u751f\u544a\u8b66\uff1b</li> <li>\u8fd0\u7ef4\u7ba1\u7406\u96be\u5ea6\u5927\uff1aNagios\u8fd9\u4e00\u7c7b\u76d1\u63a7\u7cfb\u7edf\u672c\u8eab\u8fd0\u7ef4\u7ba1\u7406\u96be\u5ea6\u5c31\u6bd4\u8f83\u5927\uff0c\u9700\u8981\u6709\u4e13\u4e1a\u7684\u4eba\u5458\u8fdb\u884c\u5b89\u88c5\uff0c\u914d\u7f6e\u548c\u7ba1\u7406\uff0c\u800c\u4e14\u8fc7\u7a0b\u5e76\u4e0d\u7b80\u5355\uff1b</li> <li>\u53ef\u6269\u5c55\u6027\u4f4e\uff1a \u76d1\u63a7\u7cfb\u7edf\u81ea\u8eab\u96be\u4ee5\u6269\u5c55\uff0c\u4ee5\u9002\u5e94\u76d1\u63a7\u89c4\u6a21\u7684\u53d8\u5316\uff1b</li> <li>\u95ee\u9898\u5b9a\u4f4d\u96be\u5ea6\u5927\uff1a\u5f53\u95ee\u9898\u4ea7\u751f\u4e4b\u540e\uff08\u6bd4\u5982\u4e3b\u673a\u8d1f\u8f7d\u5f02\u5e38\u589e\u52a0\uff09\u5bf9\u4e8e\u7528\u6237\u800c\u8a00\uff0c\u4ed6\u4eec\u770b\u5230\u7684\u4f9d\u7136\u662f\u4e00\u4e2a\u9ed1\u76d2\uff0c\u4ed6\u4eec\u65e0\u6cd5\u4e86\u89e3\u4e3b\u673a\u4e0a\u670d\u52a1\u771f\u6b63\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u56e0\u6b64\u5f53\u6545\u969c\u53d1\u751f\u540e\uff0c\u8fd9\u4e9b\u544a\u8b66\u4fe1\u606f\u5e76\u4e0d\u80fd\u6709\u6548\u7684\u652f\u6301\u7528\u6237\u5bf9\u4e8e\u6545\u969c\u6839\u6e90\u95ee\u9898\u7684\u5206\u6790\u548c\u5b9a\u4f4d\u3002</li> </ul>"},{"location":"quickstart/why-monitor/#prometheus_1","title":"Prometheus\u7684\u4f18\u52bf","text":"<p>Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5b8c\u6574\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5bf9\u4f20\u7edf\u76d1\u63a7\u7cfb\u7edf\u7684\u6d4b\u8bd5\u548c\u544a\u8b66\u6a21\u578b\u8fdb\u884c\u4e86\u5f7b\u5e95\u7684\u98a0\u8986\uff0c\u5f62\u6210\u4e86\u57fa\u4e8e\u4e2d\u592e\u5316\u7684\u89c4\u5219\u8ba1\u7b97\u3001\u7edf\u4e00\u5206\u6790\u548c\u544a\u8b66\u7684\u65b0\u6a21\u578b\u3002 \u76f8\u6bd4\u4e8e\u4f20\u7edf\u76d1\u63a7\u7cfb\u7edfPrometheus\u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a</p>"},{"location":"quickstart/why-monitor/#_3","title":"\u6613\u4e8e\u7ba1\u7406","text":"<p>Prometheus\u6838\u5fc3\u90e8\u5206\u53ea\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e0d\u5b58\u5728\u4efb\u4f55\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56(\u6570\u636e\u5e93\uff0c\u7f13\u5b58\u7b49\u7b49)\u3002\u552f\u4e00\u9700\u8981\u7684\u5c31\u662f\u672c\u5730\u78c1\u76d8\uff0c\u56e0\u6b64\u4e0d\u4f1a\u6709\u6f5c\u5728\u7ea7\u8054\u6545\u969c\u7684\u98ce\u9669\u3002</p> <p>Prometheus\u57fa\u4e8ePull\u6a21\u578b\u7684\u67b6\u6784\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\uff08\u672c\u5730\u7535\u8111\uff0c\u5f00\u53d1\u73af\u5883\uff0c\u6d4b\u8bd5\u73af\u5883\uff09\u642d\u5efa\u6211\u4eec\u7684\u76d1\u63a7\u7cfb\u7edf\u3002\u5bf9\u4e8e\u4e00\u4e9b\u590d\u6742\u7684\u60c5\u51b5\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528Prometheus\u670d\u52a1\u53d1\u73b0(Service Discovery)\u7684\u80fd\u529b\u52a8\u6001\u7ba1\u7406\u76d1\u63a7\u76ee\u6807\u3002</p>"},{"location":"quickstart/why-monitor/#_4","title":"\u76d1\u63a7\u670d\u52a1\u7684\u5185\u90e8\u8fd0\u884c\u72b6\u6001","text":"<p>Prometheus\u9f13\u52b1\u7528\u6237\u76d1\u63a7\u670d\u52a1\u7684\u5185\u90e8\u72b6\u6001\uff0c\u57fa\u4e8ePrometheus\u4e30\u5bcc\u7684Client\u5e93\uff0c\u7528\u6237\u53ef\u4ee5\u8f7b\u677e\u7684\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6dfb\u52a0\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u4ece\u800c\u8ba9\u7528\u6237\u53ef\u4ee5\u83b7\u53d6\u670d\u52a1\u548c\u5e94\u7528\u5185\u90e8\u771f\u6b63\u7684\u8fd0\u884c\u72b6\u6001\u3002</p> <p></p>"},{"location":"quickstart/why-monitor/#_5","title":"\u5f3a\u5927\u7684\u6570\u636e\u6a21\u578b","text":"<p>\u6240\u6709\u91c7\u96c6\u7684\u76d1\u63a7\u6570\u636e\u5747\u4ee5\u6307\u6807(metric)\u7684\u5f62\u5f0f\u4fdd\u5b58\u5728\u5185\u7f6e\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u5f53\u4e2d(TSDB)\u3002\u6240\u6709\u7684\u6837\u672c\u9664\u4e86\u57fa\u672c\u7684\u6307\u6807\u540d\u79f0\u4ee5\u5916\uff0c\u8fd8\u5305\u542b\u4e00\u7ec4\u7528\u4e8e\u63cf\u8ff0\u8be5\u6837\u672c\u7279\u5f81\u7684\u6807\u7b7e\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>http_request_status{code='200',content_path='/api/path', environment='produment'} =&gt; [value1@timestamp1,value2@timestamp2...]\n\nhttp_request_status{code='200',content_path='/api/path2', environment='produment'} =&gt; [value1@timestamp1,value2@timestamp2...]\n</code></pre> <p>\u6bcf\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u7531\u6307\u6807\u540d\u79f0(Metrics Name)\u4ee5\u53ca\u4e00\u7ec4\u6807\u7b7e(Labels)\u552f\u4e00\u6807\u8bc6\u3002\u6bcf\u6761\u65f6\u95f4\u5e8f\u5217\u6309\u7167\u65f6\u95f4\u7684\u5148\u540e\u987a\u5e8f\u5b58\u50a8\u4e00\u7cfb\u5217\u7684\u6837\u672c\u503c\u3002</p> <p>\u8868\u793a\u7ef4\u5ea6\u7684\u6807\u7b7e\u53ef\u80fd\u6765\u6e90\u4e8e\u4f60\u7684\u76d1\u63a7\u5bf9\u8c61\u7684\u72b6\u6001\uff0c\u6bd4\u5982code=404\u6216\u8005content_path=/api/path\u3002\u4e5f\u53ef\u80fd\u6765\u6e90\u4e8e\u7684\u4f60\u7684\u73af\u5883\u5b9a\u4e49\uff0c\u6bd4\u5982environment=produment\u3002\u57fa\u4e8e\u8fd9\u4e9bLabels\u6211\u4eec\u53ef\u4ee5\u65b9\u4fbf\u5730\u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u8fc7\u6ee4\uff0c\u88c1\u526a\u3002</p>"},{"location":"quickstart/why-monitor/#promql","title":"\u5f3a\u5927\u7684\u67e5\u8be2\u8bed\u8a00PromQL","text":"<p>Prometheus\u5185\u7f6e\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00PromQL\u3002 \u901a\u8fc7PromQL\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u76d1\u63a7\u6570\u636e\u7684\u67e5\u8be2\u3001\u805a\u5408\u3002\u540c\u65f6PromQL\u4e5f\u88ab\u5e94\u7528\u4e8e\u6570\u636e\u53ef\u89c6\u5316(\u5982Grafana)\u4ee5\u53ca\u544a\u8b66\u5f53\u4e2d\u3002</p> <p>\u901a\u8fc7PromQL\u53ef\u4ee5\u8f7b\u677e\u56de\u7b54\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u5728\u8fc7\u53bb\u4e00\u6bb5\u65f6\u95f4\u4e2d95%\u5e94\u7528\u5ef6\u8fdf\u65f6\u95f4\u7684\u5206\u5e03\u8303\u56f4\uff1f</li> <li>\u9884\u6d4b\u57284\u5c0f\u65f6\u540e\uff0c\u78c1\u76d8\u7a7a\u95f4\u5360\u7528\u5927\u81f4\u4f1a\u662f\u4ec0\u4e48\u60c5\u51b5\uff1f</li> <li>CPU\u5360\u7528\u7387\u524d5\u4f4d\u7684\u670d\u52a1\u6709\u54ea\u4e9b\uff1f(\u8fc7\u6ee4)</li> </ul>"},{"location":"quickstart/why-monitor/#_6","title":"\u9ad8\u6548","text":"<p>\u5bf9\u4e8e\u76d1\u63a7\u7cfb\u7edf\u800c\u8a00\uff0c\u5927\u91cf\u7684\u76d1\u63a7\u4efb\u52a1\u5fc5\u7136\u5bfc\u81f4\u6709\u5927\u91cf\u7684\u6570\u636e\u4ea7\u751f\u3002\u800cPrometheus\u53ef\u4ee5\u9ad8\u6548\u5730\u5904\u7406\u8fd9\u4e9b\u6570\u636e\uff0c\u5bf9\u4e8e\u5355\u4e00Prometheus Server\u5b9e\u4f8b\u800c\u8a00\u5b83\u53ef\u4ee5\u5904\u7406\uff1a</p> <ul> <li>\u6570\u4ee5\u767e\u4e07\u7684\u76d1\u63a7\u6307\u6807</li> <li>\u6bcf\u79d2\u5904\u7406\u6570\u5341\u4e07\u7684\u6570\u636e\u70b9\u3002</li> </ul>"},{"location":"quickstart/why-monitor/#_7","title":"\u53ef\u6269\u5c55","text":"<p>Prometheus\u662f\u5982\u6b64\u7b80\u5355\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u5728\u6bcf\u4e2a\u6570\u636e\u4e2d\u5fc3\u3001\u6bcf\u4e2a\u56e2\u961f\u8fd0\u884c\u72ec\u7acb\u7684Prometheus Sevrer\u3002Prometheus\u5bf9\u4e8e\u8054\u90a6\u96c6\u7fa4\u7684\u652f\u6301\uff0c\u53ef\u4ee5\u8ba9\u591a\u4e2aPrometheus\u5b9e\u4f8b\u4ea7\u751f\u4e00\u4e2a\u903b\u8f91\u96c6\u7fa4\uff0c\u5f53\u5355\u5b9e\u4f8bPrometheus Server\u5904\u7406\u7684\u4efb\u52a1\u91cf\u8fc7\u5927\u65f6\uff0c\u901a\u8fc7\u4f7f\u7528\u529f\u80fd\u5206\u533a(sharding)+\u8054\u90a6\u96c6\u7fa4(federation)\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u6269\u5c55\u3002</p>"},{"location":"quickstart/why-monitor/#_8","title":"\u6613\u4e8e\u96c6\u6210","text":"<p>\u4f7f\u7528Prometheus\u53ef\u4ee5\u5feb\u901f\u642d\u5efa\u76d1\u63a7\u670d\u52a1\uff0c\u5e76\u4e14\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8fdb\u884c\u96c6\u6210\u3002\u76ee\u524d\u652f\u6301\uff1a Java\uff0c JMX\uff0c Python\uff0c Go\uff0cRuby\uff0c .Net\uff0c Node.js\u7b49\u7b49\u8bed\u8a00\u7684\u5ba2\u6237\u7aefSDK\uff0c\u57fa\u4e8e\u8fd9\u4e9bSDK\u53ef\u4ee5\u5feb\u901f\u8ba9\u5e94\u7528\u7a0b\u5e8f\u7eb3\u5165\u5230Prometheus\u7684\u76d1\u63a7\u5f53\u4e2d\uff0c\u6216\u8005\u5f00\u53d1\u81ea\u5df1\u7684\u76d1\u63a7\u6570\u636e\u6536\u96c6\u7a0b\u5e8f\u3002\u540c\u65f6\u8fd9\u4e9b\u5ba2\u6237\u7aef\u6536\u96c6\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4e0d\u4ec5\u4ec5\u652f\u6301Prometheus\uff0c\u8fd8\u80fd\u652f\u6301Graphite\u8fd9\u4e9b\u5176\u4ed6\u7684\u76d1\u63a7\u5de5\u5177\u3002</p> <p>\u540c\u65f6Prometheus\u8fd8\u652f\u6301\u4e0e\u5176\u4ed6\u7684\u76d1\u63a7\u7cfb\u7edf\u8fdb\u884c\u96c6\u6210\uff1aGraphite\uff0c Statsd\uff0c Collected\uff0c Scollector\uff0c muini\uff0c Nagios\u7b49\u3002</p> <p>Prometheus\u793e\u533a\u8fd8\u63d0\u4f9b\u4e86\u5927\u91cf\u7b2c\u4e09\u65b9\u5b9e\u73b0\u7684\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u652f\u6301\uff1aJMX\uff0c CloudWatch\uff0c EC2\uff0c MySQL\uff0c PostgresSQL\uff0c Haskell\uff0c Bash\uff0c SNMP\uff0c Consul\uff0c Haproxy\uff0c Mesos\uff0c Bind\uff0c CouchDB\uff0c Django\uff0c Memcached\uff0c RabbitMQ\uff0c Redis\uff0c RethinkDB\uff0c Rsyslog\u7b49\u7b49\u3002</p>"},{"location":"quickstart/why-monitor/#_9","title":"\u53ef\u89c6\u5316","text":"<p>Prometheus Server\u4e2d\u81ea\u5e26\u4e86\u4e00\u4e2aPrometheus UI\uff0c\u901a\u8fc7\u8fd9\u4e2aUI\u53ef\u4ee5\u65b9\u4fbf\u5730\u76f4\u63a5\u5bf9\u6570\u636e\u8fdb\u884c\u67e5\u8be2\uff0c\u5e76\u4e14\u652f\u6301\u76f4\u63a5\u4ee5\u56fe\u5f62\u5316\u7684\u5f62\u5f0f\u5c55\u793a\u6570\u636e\u3002\u540c\u65f6Prometheus\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u72ec\u7acb\u7684\u57fa\u4e8eRuby On Rails\u7684Dashboard\u89e3\u51b3\u65b9\u6848Promdash\u3002\u6700\u65b0\u7684Grafana\u53ef\u89c6\u5316\u5de5\u5177\u4e5f\u5df2\u7ecf\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684Prometheus\u652f\u6301\uff0c\u57fa\u4e8eGrafana\u53ef\u4ee5\u521b\u5efa\u66f4\u52a0\u7cbe\u7f8e\u7684\u76d1\u63a7\u56fe\u6807\u3002\u57fa\u4e8ePrometheus\u63d0\u4f9b\u7684API\u8fd8\u53ef\u4ee5\u5b9e\u73b0\u81ea\u5df1\u7684\u76d1\u63a7\u53ef\u89c6\u5316UI\u3002</p>"},{"location":"quickstart/why-monitor/#_10","title":"\u5f00\u653e\u6027","text":"<p>\u901a\u5e38\u6765\u8bf4\u5f53\u6211\u4eec\u9700\u8981\u76d1\u63a7\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u4e00\u822c\u9700\u8981\u8be5\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u5bf9\u76f8\u5e94\u76d1\u63a7\u7cfb\u7edf\u534f\u8bae\u7684\u652f\u6301\u3002\u56e0\u6b64\u5e94\u7528\u7a0b\u5e8f\u4f1a\u4e0e\u6240\u9009\u62e9\u7684\u76d1\u63a7\u7cfb\u7edf\u8fdb\u884c\u7ed1\u5b9a\u3002\u4e3a\u4e86\u51cf\u5c11\u8fd9\u79cd\u7ed1\u5b9a\u6240\u5e26\u6765\u7684\u9650\u5236\u3002\u5bf9\u4e8e\u51b3\u7b56\u8005\u800c\u8a00\u8981\u4e48\u4f60\u5c31\u76f4\u63a5\u5728\u5e94\u7528\u4e2d\u96c6\u6210\u8be5\u76d1\u63a7\u7cfb\u7edf\u7684\u652f\u6301\uff0c\u8981\u4e48\u5c31\u5728\u5916\u90e8\u521b\u5efa\u5355\u72ec\u7684\u670d\u52a1\u6765\u9002\u914d\u4e0d\u540c\u7684\u76d1\u63a7\u7cfb\u7edf\u3002</p> <p>\u800c\u5bf9\u4e8ePrometheus\u6765\u8bf4\uff0c\u4f7f\u7528Prometheus\u7684client library\u7684\u8f93\u51fa\u683c\u5f0f\u4e0d\u6b62\u652f\u6301Prometheus\u7684\u683c\u5f0f\u5316\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u8f93\u51fa\u652f\u6301\u5176\u5b83\u76d1\u63a7\u7cfb\u7edf\u7684\u683c\u5f0f\u5316\u6570\u636e\uff0c\u6bd4\u5982Graphite\u3002</p> <p>\u56e0\u6b64\u4f60\u751a\u81f3\u53ef\u4ee5\u5728\u4e0d\u4f7f\u7528Prometheus\u7684\u60c5\u51b5\u4e0b\uff0c\u91c7\u7528Prometheus\u7684client library\u6765\u8ba9\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u652f\u6301\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u5728\u672c\u4e66\u5f53\u4e2d\uff0c\u5c06\u5e26\u9886\u8bfb\u8005\u611f\u53d7Prometheus\u662f\u5982\u4f55\u5bf9\u76d1\u63a7\u7cfb\u7edf\u7684\u91cd\u65b0\u5b9a\u4e49\u3002</p>"},{"location":"rancher/","title":"\u4f7f\u7528Prometheus\u76d1\u63a7Rancher\u96c6\u7fa4","text":""},{"location":"sd/","title":"\u7b2c7\u7ae0 Prometheus\u670d\u52a1\u53d1\u73b0","text":"<p>\u5728\u524d6\u4e2a\u7ae0\u8282\u4e2d\uff0c\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecd\u4e86Prometheus\u81ea\u8eab\u7684\u4e00\u4e9b\u7279\u6027\uff0c\u5305\u62ec\u9ad8\u6548\u7684\u6570\u636e\u80fd\u529b\u3001\u7075\u6d3b\u7684\u67e5\u8be2\u8bed\u8a00PromQL\u3001Prometheus\u7684\u544a\u8b66\u6a21\u5f0f\u3001Exporter\u7684\u4f7f\u7528\u3001\u4ee5\u53ca\u81ea\u8eab\u7684\u9ad8\u53ef\u7528\u7b49\u3002\u800c\u4f5c\u4e3a\u4e0b\u4e00\u4ee3\u76d1\u63a7\u7cfb\u7edf\u7684\u9996\u9009\u89e3\u51b3\u65b9\u6848\uff0cPrometheus\u5bf9\u4e91\u4ee5\u53ca\u5bb9\u5668\u73af\u5883\u4e0b\u7684\u76d1\u63a7\u573a\u666f\u63d0\u4f9b\u4e86\u5b8c\u5584\u7684\u652f\u6301\u3002\u672c\u7ae0\u4e2d\u5c06\u4ecb\u7ecdPrometheus\u662f\u5982\u4f55\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u673a\u5236\u5b8c\u7f8e\u89e3\u51b3\u4e91\u539f\u751f\u573a\u666f\u4e0b\u7684\u76d1\u63a7\u6311\u6218\u7684\u3002</p> <p>\u672c\u7ae0\u7684\u4e3b\u8981\u5185\u5bb9\uff1a</p> <ul> <li>\u4e91\u539f\u751f\u3001\u5bb9\u5668\u573a\u666f\u4e0b\u76d1\u63a7\u7684\u6311\u6218\uff1b</li> <li>Prometheus\u670d\u52a1\u53d1\u73b0\u7684\u5b9e\u73b0\u673a\u5236\uff1b</li> <li>Prometheus\u4e2d\u670d\u52a1\u53d1\u73b0\u7684\u51e0\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff1b</li> <li>Prometheus\u4e2d\u5f3a\u5927\u7684Relabel\u673a\u5236\u3002</li> </ul>"},{"location":"sd/SUMMARY/","title":"\u5c0f\u7ed3","text":"<p>\u76f8\u6bd4\u4e8e\u76f4\u63a5\u4f7f\u7528\u9759\u6001\u914d\u7f6e\uff0c\u5728\u4e91\u73af\u5883\u4ee5\u53ca\u5bb9\u5668\u73af\u5883\u4e0b\u6211\u4eec\u66f4\u591a\u7684\u76d1\u63a7\u5bf9\u8c61\u90fd\u662f\u52a8\u6001\u7684\u3002\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\uff0c\u4f7f\u5f97Prometheus\u76f8\u6bd4\u4e8e\u5176\u4ed6\u4f20\u7edf\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u66f4\u9002\u7528\u4e8e\u4e91\u4ee5\u53ca\u5bb9\u5668\u73af\u5883\u4e0b\u7684\u76d1\u63a7\u9700\u6c42\u3002</p>"},{"location":"sd/service-discovery-with-consul/","title":"\u57fa\u4e8eConsul\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>Consul\u662f\u7531HashiCorp\u5f00\u53d1\u7684\u4e00\u4e2a\u652f\u6301\u591a\u6570\u636e\u4e2d\u5fc3\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u53d1\u73b0\u548c\u952e\u503c\u5bf9\u5b58\u50a8\u670d\u52a1\u7684\u5f00\u6e90\u8f6f\u4ef6\uff0c\u88ab\u5927\u91cf\u5e94\u7528\u4e8e\u57fa\u4e8e\u5fae\u670d\u52a1\u7684\u8f6f\u4ef6\u67b6\u6784\u5f53\u4e2d\u3002</p>"},{"location":"sd/service-discovery-with-consul/#consul_1","title":"Consul\u521d\u4f53\u9a8c","text":"<p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7Consul\u5b98\u7f51https://www.consul.io/downloads.html\u4e0b\u8f7d\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u7684\u8f6f\u4ef6\u5305\u3002Consul\u4e0ePrometheus\u540c\u6837\u4f7f\u7528Go\u8bed\u8a00\u8fdb\u884c\u5f00\u53d1\uff0c\u56e0\u6b64\u5b89\u88c5\u548c\u90e8\u7f72\u7684\u65b9\u5f0f\u4e5f\u6781\u4e3a\u7b80\u5355\uff0c\u89e3\u538b\u5e76\u5c06\u547d\u4ee4\u884c\u5de5\u5177\u653e\u5230\u7cfb\u7edfPATH\u8def\u5f84\u4e0b\u5373\u53ef\u3002</p> <p>\u5728\u672c\u5730\u53ef\u4ee5\u4f7f\u7528\u5f00\u53d1\u8005\u6a21\u5f0f\u5728\u672c\u5730\u5feb\u901f\u542f\u52a8\u4e00\u4e2a\u5355\u8282\u70b9\u7684Consul\u73af\u5883\uff1a</p> <pre><code>$ consul agent -dev\n==&gt; Starting Consul agent...\n==&gt; Consul agent running!\n           Version: 'v1.0.7'\n           Node ID: 'd7b590ba-e2f8-3a82-e8a8-2a911bdf67d5'\n         Node name: 'localhost'\n        Datacenter: 'dc1' (Segment: '&lt;all&gt;')\n            Server: true (Bootstrap: false)\n       Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, DNS: 8600)\n      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)\n           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false\n</code></pre> <p>\u5728\u542f\u52a8\u6210\u529f\u540e\uff0c\u5728\u4e00\u4e2a\u65b0\u7684terminal\u7a97\u53e3\u4e2d\u8fd0\u884cconsul members\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\uff1a</p> <pre><code>$ consul members\nNode       Address         Status  Type    Build  Protocol  DC   Segment\nlocalhost  127.0.0.1:8301  alive   server  1.0.7  2         dc1  &lt;all&gt;\n</code></pre> <p>\u7528\u6237\u8fd8\u53ef\u4ee5\u901a\u8fc7HTTP API\u7684\u65b9\u5f0f\u67e5\u770b\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u4fe1\u606f\uff1a</p> <pre><code>$ curl localhost:8500/v1/catalog/nodes\n[\n    {\n        \"ID\": \"d7b590ba-e2f8-3a82-e8a8-2a911bdf67d5\",\n        \"Node\": \"localhost\",\n        \"Address\": \"127.0.0.1\",\n        \"Datacenter\": \"dc1\",\n        \"TaggedAddresses\": {\n            \"lan\": \"127.0.0.1\",\n            \"wan\": \"127.0.0.1\"\n        },\n        \"Meta\": {\n            \"consul-network-segment\": \"\"\n        },\n        \"CreateIndex\": 5,\n        \"ModifyIndex\": 6\n    }\n]\n</code></pre> <p>Consul\u8fd8\u63d0\u4f9b\u4e86\u5185\u7f6e\u7684DNS\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7Consul\u7684DNS\u670d\u52a1\u7684\u65b9\u5f0f\u8bbf\u95ee\u5176\u4e2d\u7684\u8282\u70b9\uff1a</p> <pre><code>$ dig @127.0.0.1 -p 8600 localhost.node.consul\n\n; &lt;&lt;&gt;&gt; DiG 9.9.7-P3 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 localhost.node.consul\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 50684\n;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n;; WARNING: recursion requested but not available\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 4096\n;; QUESTION SECTION:\n;localhost.node.consul.     IN  A\n\n;; ANSWER SECTION:\nlocalhost.node.consul.  0   IN  A   127.0.0.1\n\n;; Query time: 5 msec\n;; SERVER: 127.0.0.1#8600(127.0.0.1)\n;; WHEN: Sun Apr 15 22:10:56 CST 2018\n;; MSG SIZE  rcvd: 66\n</code></pre> <p>\u5728Consul\u5f53\u4e2d\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7\u670d\u52a1\u5b9a\u4e49\u6587\u4ef6\u6216\u8005\u662fHTTP API\u7684\u65b9\u5f0f\u8fdb\u884c\u6ce8\u518c\u3002\u8fd9\u91cc\u4f7f\u7528\u670d\u52a1\u5b9a\u4e49\u6587\u4ef6\u7684\u65b9\u5f0f\u5c06\u672c\u5730\u8fd0\u884c\u7684node_exporter\u901a\u8fc7\u670d\u52a1\u7684\u65b9\u5f0f\u6ce8\u518c\u5230Consul\u5f53\u4e2d\u3002</p> <p>\u521b\u5efa\u914d\u7f6e\u76ee\u5f55\uff1a</p> <pre><code>sudo mkdir /etc/consul.d\n</code></pre> <pre><code>echo '{\"service\": {\"name\": \"node_exporter\", \"tags\": [\"exporter\"], \"port\": 9100}}' \\\n    | sudo tee /etc/consul.d/node_exporter.json\n</code></pre> <p>\u91cd\u65b0\u542f\u52a8Consul\u670d\u52a1\uff0c\u5e76\u4e14\u58f0\u660e\u670d\u52a1\u5b9a\u4e49\u6587\u4ef6\u6240\u5728\u76ee\u5f55\uff1a</p> <pre><code>$ consul agent -dev -config-dir=/etc/consul.d\n==&gt; Starting Consul agent...\n    2018/04/15 22:23:47 [DEBUG] agent: Service \"node_exporter\" in sync\n</code></pre> <p>\u4e00\u65e6\u670d\u52a1\u6ce8\u518c\u6210\u529f\u4e4b\u540e\uff0c\u7528\u6237\u5c31\u53ef\u4ee5\u901a\u8fc7DNS\u6216HTTP API\u7684\u65b9\u5f0f\u67e5\u8be2\u670d\u52a1\u4fe1\u606f\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u7684\u670d\u52a1\u90fd\u53ef\u4ee5\u4f7f\u7528NAME.service.consul\u57df\u540d\u7684\u65b9\u5f0f\u8fdb\u884c\u8bbf\u95ee\u3002</p> <p>\u4f8b\u5982\uff0c\u53ef\u4ee5\u4f7f\u7528node_exporter.service.consul\u57df\u540d\u67e5\u8be2node_exporter\u670d\u52a1\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ dig @127.0.0.1 -p 8600 node_exporter.service.consul\n\n;; QUESTION SECTION:\n;node_exporter.service.consul.  IN  A\n\n;; ANSWER SECTION:\nnode_exporter.service.consul. 0 IN  A   127.0.0.1\n</code></pre> <p>\u5982\u4e0a\u6240\u793aDNS\u8bb0\u5f55\u4f1a\u8fd4\u56de\u5f53\u524d\u53ef\u7528\u7684node_exporter\u670d\u52a1\u5b9e\u4f8b\u7684IP\u5730\u5740\u4fe1\u606f\u3002</p> <p>\u9664\u4e86\u4f7f\u7528DNS\u7684\u65b9\u5f0f\u4ee5\u5916\uff0cConsul\u8fd8\u652f\u6301\u7528\u6237\u4f7f\u7528HTTP API\u7684\u5f62\u5f0f\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff1a</p> <pre><code>$ curl http://localhost:8500/v1/catalog/service/node_exporter\n[\n    {\n        \"ID\": \"e561b376-2c1b-653d-61a0-1d844bce06a7\",\n        \"Node\": \"localhost\",\n        \"Address\": \"127.0.0.1\",\n        \"Datacenter\": \"dc1\",\n        \"TaggedAddresses\": {\n            \"lan\": \"127.0.0.1\",\n            \"wan\": \"127.0.0.1\"\n        },\n        \"NodeMeta\": {\n            \"consul-network-segment\": \"\"\n        },\n        \"ServiceID\": \"node_exporter\",\n        \"ServiceName\": \"node_exporter\",\n        \"ServiceTags\": [\n            \"exporter\"\n        ],\n        \"ServiceAddress\": \"\",\n        \"ServiceMeta\": {},\n        \"ServicePort\": 9100,\n        \"ServiceEnableTagOverride\": false,\n        \"CreateIndex\": 6,\n        \"ModifyIndex\": 6\n    }\n]\n</code></pre> <p>Consul\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2aWeb UI\u53ef\u4ee5\u67e5\u770bConsul\u4e2d\u6240\u6709\u670d\u52a1\u4ee5\u53ca\u8282\u70b9\u7684\u72b6\u6001\uff1a</p> <p></p> <p>\u5f53\u7136Consul\u8fd8\u63d0\u4f9b\u4e86\u66f4\u591a\u7684API\u7528\u4e8e\u652f\u6301\u5bf9\u670d\u52a1\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\uff08\u6dfb\u52a0\u3001\u5220\u9664\u3001\u4fee\u6539\u7b49\uff09\u8fd9\u91cc\u5c31\u4e0d\u505a\u8fc7\u591a\u7684\u4ecb\u7ecd\uff0c\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u901a\u8fc7Consul\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</p>"},{"location":"sd/service-discovery-with-consul/#prometheus","title":"\u4e0ePrometheus\u96c6\u6210","text":"<p>Consul\u4f5c\u4e3a\u4e00\u4e2a\u901a\u7528\u7684\u670d\u52a1\u53d1\u73b0\u548c\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8bb0\u5f55\u5e76\u4e14\u7ba1\u7406\u4e86\u73af\u5883\u4e2d\u6240\u6709\u670d\u52a1\u7684\u4fe1\u606f\u3002Prometheus\u901a\u8fc7\u4e0eConsul\u7684\u4ea4\u4e92\u53ef\u4ee5\u83b7\u53d6\u5230\u76f8\u5e94Exporter\u5b9e\u4f8b\u7684\u8bbf\u95ee\u4fe1\u606f\u3002\u5728Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u5f53\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u4e0eConsul\u8fdb\u884c\u96c6\u6210\uff1a</p> <pre><code>- job_name: node_exporter\n    metrics_path: /metrics\n    scheme: http\n    consul_sd_configs:\n      - server: localhost:8500\n        services:\n          - node_exporter\n</code></pre> <p>\u5728consul_sd_configs\u5b9a\u4e49\u5f53\u4e2d\u901a\u8fc7server\u5b9a\u4e49\u4e86Consul\u670d\u52a1\u7684\u8bbf\u95ee\u5730\u5740\uff0cservices\u5219\u5b9a\u4e49\u4e86\u5f53\u524d\u9700\u8981\u53d1\u73b0\u54ea\u4e9b\u7c7b\u578b\u670d\u52a1\u5b9e\u4f8b\u7684\u4fe1\u606f\uff0c\u8fd9\u91cc\u9650\u5b9a\u4e86\u53ea\u83b7\u53d6node_exporter\u7684\u670d\u52a1\u5b9e\u4f8b\u4fe1\u606f\u3002</p>"},{"location":"sd/service-discovery-with-file/","title":"\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>\u5728Prometheus\u652f\u6301\u7684\u4f17\u591a\u670d\u52a1\u53d1\u73b0\u7684\u5b9e\u73b0\u65b9\u5f0f\u4e2d\uff0c\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u662f\u6700\u901a\u7528\u7684\u65b9\u5f0f\u3002\u8fd9\u79cd\u65b9\u5f0f\u4e0d\u9700\u8981\u4f9d\u8d56\u4e8e\u4efb\u4f55\u7684\u5e73\u53f0\u6216\u8005\u7b2c\u4e09\u65b9\u670d\u52a1\u3002\u5bf9\u4e8ePrometheus\u800c\u8a00\u4e5f\u4e0d\u53ef\u80fd\u652f\u6301\u6240\u6709\u7684\u5e73\u53f0\u6216\u8005\u73af\u5883\u3002\u901a\u8fc7\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u65b9\u5f0f\u4e0b\uff0cPrometheus\u4f1a\u5b9a\u65f6\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u6700\u65b0\u7684Target\u4fe1\u606f\uff0c\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4efb\u610f\u7684\u65b9\u5f0f\u5c06\u76d1\u63a7Target\u7684\u4fe1\u606f\u5199\u5165\u5373\u53ef\u3002</p> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7JSON\u6216\u8005YAML\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u5b9a\u4e49\u6240\u6709\u7684\u76d1\u63a7\u76ee\u6807\u3002\u4f8b\u5982\uff0c\u5728\u4e0b\u9762\u7684JSON\u6587\u4ef6\u4e2d\u5206\u522b\u5b9a\u4e49\u4e863\u4e2a\u91c7\u96c6\u4efb\u52a1\uff0c\u4ee5\u53ca\u6bcf\u4e2a\u4efb\u52a1\u5bf9\u5e94\u7684Target\u5217\u8868\uff1a</p> <pre><code>[\n  {\n    \"targets\": [ \"localhost:8080\"],\n    \"labels\": {\n      \"env\": \"localhost\",\n      \"job\": \"cadvisor\"\n    }\n  },\n  {\n    \"targets\": [ \"localhost:9104\" ],\n    \"labels\": {\n      \"env\": \"prod\",\n      \"job\": \"mysqld\"\n    }\n  },\n  {\n    \"targets\": [ \"localhost:9100\"],\n    \"labels\": {\n      \"env\": \"prod\",\n      \"job\": \"node\"\n    }\n  }\n]\n</code></pre> <p>\u540c\u65f6\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4e3a\u8fd9\u4e9b\u5b9e\u4f8b\u6dfb\u52a0\u4e00\u4e9b\u989d\u5916\u7684\u6807\u7b7e\u4fe1\u606f\uff0c\u4f8b\u5982\u4f7f\u7528env\u6807\u7b7e\u6807\u793a\u5f53\u524d\u8282\u70b9\u6240\u5728\u7684\u73af\u5883\uff0c\u8fd9\u6837\u4ece\u8fd9\u4e9b\u5b9e\u4f8b\u4e2d\u91c7\u96c6\u5230\u7684\u6837\u672c\u4fe1\u606f\u5c06\u5305\u542b\u8fd9\u4e9b\u6807\u7b7e\u4fe1\u606f\uff0c\u4ece\u800c\u53ef\u4ee5\u901a\u8fc7\u8be5\u6807\u7b7e\u6309\u7167\u73af\u5883\u5bf9\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\u3002</p> <p>\u521b\u5efaPrometheus\u914d\u7f6e\u6587\u4ef6/etc/prometheus/prometheus-file-sd.yml\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>global:\n  scrape_interval: 15s\n  scrape_timeout: 10s\n  evaluation_interval: 15s\nscrape_configs:\n- job_name: 'file_ds'\n  file_sd_configs:\n  - files:\n    - targets.json\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u57fa\u4e8efile_sd_configs\u7684\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1\uff0c\u5176\u4e2d\u6a21\u5f0f\u7684\u4efb\u52a1\u540d\u79f0\u4e3afile_ds\u3002\u5728JSON\u6587\u4ef6\u4e2d\u53ef\u4ee5\u4f7f\u7528job\u6807\u7b7e\u8986\u76d6\u9ed8\u8ba4\u7684job\u540d\u79f0\uff0c\u6b64\u65f6\u542f\u52a8Prometheus\u670d\u52a1\uff1a</p> <pre><code>prometheus --config.file=/etc/prometheus/prometheus-file-sd.yml --storage.tsdb.path=/data/prometheus\n</code></pre> <p>\u5728Prometheus UI\u7684Targets\u4e0b\u5c31\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u4ecetargets.json\u6587\u4ef6\u4e2d\u52a8\u6001\u83b7\u53d6\u5230\u7684Target\u5b9e\u4f8b\u4fe1\u606f\u4ee5\u53ca\u76d1\u63a7\u4efb\u52a1\u7684\u91c7\u96c6\u72b6\u6001\uff0c\u540c\u65f6\u5728Labels\u5217\u4e0b\u4f1a\u5305\u542b\u7528\u6237\u6dfb\u52a0\u7684\u81ea\u5b9a\u4e49\u6807\u7b7e:</p> <p></p> <p>Prometheus\u9ed8\u8ba4\u6bcf5m\u91cd\u65b0\u8bfb\u53d6\u4e00\u6b21\u6587\u4ef6\u5185\u5bb9\uff0c\u5f53\u9700\u8981\u4fee\u6539\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7refresh_interval\u8fdb\u884c\u8bbe\u7f6e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>- job_name: 'file_ds'\n  file_sd_configs:\n  - refresh_interval: 1m\n    files:\n    - targets.json\n</code></pre> <p>\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0cPrometheus\u4f1a\u81ea\u52a8\u7684\u5468\u671f\u6027\u8bfb\u53d6\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u3002\u5f53\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5185\u5bb9\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u4e0d\u9700\u8981\u5bf9Prometheus\u8fdb\u884c\u4efb\u4f55\u7684\u91cd\u542f\u64cd\u4f5c\u3002</p> <p>\u8fd9\u79cd\u901a\u7528\u7684\u65b9\u5f0f\u53ef\u4ee5\u884d\u751f\u4e86\u5f88\u591a\u4e0d\u540c\u7684\u73a9\u6cd5\uff0c\u6bd4\u5982\u4e0e\u81ea\u52a8\u5316\u914d\u7f6e\u7ba1\u7406\u5de5\u5177(Ansible)\u7ed3\u5408\u3001\u4e0eCron Job\u7ed3\u5408\u7b49\u7b49\u3002 \u5bf9\u4e8e\u4e00\u4e9bPrometheus\u8fd8\u4e0d\u652f\u6301\u7684\u4e91\u73af\u5883\uff0c\u6bd4\u5982\u56fd\u5185\u7684\u963f\u91cc\u4e91\u3001\u817e\u8baf\u4e91\u7b49\u4e5f\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u901a\u8fc7\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7a0b\u5e8f\u4e0e\u5e73\u53f0\u8fdb\u884c\u4ea4\u4e92\u81ea\u52a8\u751f\u6210\u76d1\u63a7Target\u6587\u4ef6\uff0c\u4ece\u800c\u5b9e\u73b0\u5bf9\u8fd9\u4e9b\u4e91\u73af\u5883\u4e2d\u57fa\u7840\u8bbe\u65bd\u7684\u81ea\u52a8\u5316\u76d1\u63a7\u652f\u6301\u3002</p>"},{"location":"sd/service-discovery-with-relabel/","title":"\u670d\u52a1\u53d1\u73b0\u4e0eRelabeling","text":"<p>\u5728\u672c\u7ae0\u7684\u524d\u51e0\u4e2a\u5c0f\u8282\u4e2d\u7b14\u8005\u5df2\u7ecf\u5206\u522b\u4ecb\u7ecd\u4e86Prometheus\u7684\u51e0\u79cd\u670d\u52a1\u53d1\u73b0\u673a\u5236\u3002\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5728\u4e0d\u91cd\u542fPrometheus\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u52a8\u6001\u7684\u53d1\u73b0\u9700\u8981\u76d1\u63a7\u7684Target\u5b9e\u4f8b\u4fe1\u606f\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u6211\u4eec\u53ef\u80fd\u4f1a\u5212\u5206\u4e3a:dev, stage, prod\u4e0d\u540c\u7684\u96c6\u7fa4\u3002\u6bcf\u4e00\u4e2a\u96c6\u7fa4\u8fd0\u884c\u591a\u4e2a\u4e3b\u673a\u8282\u70b9\uff0c\u6bcf\u4e2a\u670d\u52a1\u5668\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2aNode Exporter\u5b9e\u4f8b\u3002Node Exporter\u5b9e\u4f8b\u4f1a\u81ea\u52a8\u6ce8\u518c\u5230Consul\u4e2d\uff0c\u800cPrometheus\u5219\u6839\u636eConsul\u8fd4\u56de\u7684Node Exporter\u5b9e\u4f8b\u4fe1\u606f\u52a8\u6001\u7684\u7ef4\u62a4Target\u5217\u8868\uff0c\u4ece\u800c\u5411\u8fd9\u4e9bTarget\u8f6e\u8be2\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u7136\u800c\uff0c\u5982\u679c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\uff1a</p> <ul> <li>\u6309\u7167\u4e0d\u540c\u7684\u73af\u5883dev, stage, prod\u805a\u5408\u76d1\u63a7\u6570\u636e\uff1f</li> <li>\u5bf9\u4e8e\u7814\u53d1\u56e2\u961f\u800c\u8a00\uff0c\u6211\u53ef\u80fd\u53ea\u5173\u5fc3dev\u73af\u5883\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5982\u4f55\u5904\u7406\uff1f</li> <li>\u5982\u679c\u4e3a\u6bcf\u4e00\u4e2a\u56e2\u961f\u5355\u72ec\u642d\u5efa\u4e00\u4e2aPrometheus Server\u3002\u90a3\u4e48\u5982\u4f55\u8ba9\u4e0d\u540c\u56e2\u961f\u7684Prometheus Server\u91c7\u96c6\u4e0d\u540c\u7684\u73af\u5883\u76d1\u63a7\u6570\u636e\uff1f</li> </ul> <p>\u9762\u5bf9\u4ee5\u4e0a\u8fd9\u4e9b\u573a\u666f\u4e0b\u7684\u9700\u6c42\u65f6\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5e0c\u671bPrometheus Server\u80fd\u591f\u6309\u7167\u67d0\u4e9b\u89c4\u5219\uff08\u6bd4\u5982\u6807\u7b7e\uff09\u4ece\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\u8fd4\u56de\u7684Target\u5b9e\u4f8b\u4e2d\u6709\u9009\u62e9\u6027\u7684\u91c7\u96c6\u67d0\u4e9bExporter\u5b9e\u4f8b\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u901a\u8fc7Prometheus\u5f3a\u5927\u7684Relabel\u673a\u5236\u6765\u5b9e\u73b0\u4ee5\u4e0a\u8fd9\u4e9b\u5177\u4f53\u7684\u76ee\u6807\u3002</p>"},{"location":"sd/service-discovery-with-relabel/#prometheusrelabeling","title":"Prometheus\u7684Relabeling\u673a\u5236","text":"<p>\u5728Prometheus\u6240\u6709\u7684Target\u5b9e\u4f8b\u4e2d\uff0c\u90fd\u5305\u542b\u4e00\u4e9b\u9ed8\u8ba4\u7684Metadata\u6807\u7b7e\u4fe1\u606f\u3002\u53ef\u4ee5\u901a\u8fc7Prometheus UI\u7684Targets\u9875\u9762\u4e2d\u67e5\u770b\u8fd9\u4e9b\u5b9e\u4f8b\u7684Metadata\u6807\u7b7e\u7684\u5185\u5bb9\uff1a</p> <p></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5f53Prometheus\u52a0\u8f7dTarget\u5b9e\u4f8b\u5b8c\u6210\u540e\uff0c\u8fd9\u4e9bTarget\u65f6\u5019\u90fd\u4f1a\u5305\u542b\u4e00\u4e9b\u9ed8\u8ba4\u7684\u6807\u7b7e\uff1a</p> <ul> <li><code>__address__</code>\uff1a\u5f53\u524dTarget\u5b9e\u4f8b\u7684\u8bbf\u95ee\u5730\u5740<code>&lt;host&gt;:&lt;port&gt;</code></li> <li><code>__scheme__</code>\uff1a\u91c7\u96c6\u76ee\u6807\u670d\u52a1\u8bbf\u95ee\u5730\u5740\u7684HTTP Scheme\uff0cHTTP\u6216\u8005HTTPS</li> <li><code>__metrics_path__</code>\uff1a\u91c7\u96c6\u76ee\u6807\u670d\u52a1\u8bbf\u95ee\u5730\u5740\u7684\u8bbf\u95ee\u8def\u5f84</li> <li><code>__param_&lt;name&gt;</code>\uff1a\u91c7\u96c6\u4efb\u52a1\u76ee\u6807\u670d\u52a1\u7684\u4e2d\u5305\u542b\u7684\u8bf7\u6c42\u53c2\u6570</li> </ul> <p>\u4e0a\u9762\u8fd9\u4e9b\u6807\u7b7e\u5c06\u4f1a\u544a\u8bc9Prometheus\u5982\u4f55\u4ece\u8be5Target\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u76d1\u63a7\u6570\u636e\u3002\u9664\u4e86\u8fd9\u4e9b\u9ed8\u8ba4\u7684\u6807\u7b7e\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4e3aTarget\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u6807\u7b7e\uff0c\u4f8b\u5982\uff0c\u5728\u201c\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u201d\u5c0f\u8282\u4e2d\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7JSON\u914d\u7f6e\u6587\u4ef6\uff0c\u4e3aTarget\u5b9e\u4f8b\u6dfb\u52a0\u4e86\u81ea\u5b9a\u4e49\u6807\u7b7eenv\uff0c\u5982\u4e0b\u6240\u793a\u8be5\u6807\u7b7e\u6700\u7ec8\u4e5f\u4f1a\u4fdd\u5b58\u5230\u4ece\u8be5\u5b9e\u4f8b\u91c7\u96c6\u7684\u6837\u672c\u6570\u636e\u4e2d\uff1a</p> <pre><code>node_cpu{cpu=\"cpu0\",env=\"prod\",instance=\"localhost:9100\",job=\"node\",mode=\"idle\"}\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\uff0cTarget\u4ee5<code>__</code>\u4f5c\u4e3a\u524d\u7f6e\u7684\u6807\u7b7e\u662f\u5728\u7cfb\u7edf\u5185\u90e8\u4f7f\u7528\u7684\uff0c\u56e0\u6b64\u8fd9\u4e9b\u6807\u7b7e\u4e0d\u4f1a\u88ab\u5199\u5165\u5230\u6837\u672c\u6570\u636e\u4e2d\u3002\u4e0d\u8fc7\u8fd9\u91cc\u6709\u4e00\u4e9b\u4f8b\u5916\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6240\u6709\u901a\u8fc7Prometheus\u91c7\u96c6\u7684\u6837\u672c\u6570\u636e\u4e2d\u90fd\u4f1a\u5305\u542b\u4e00\u4e2a\u540d\u4e3ainstance\u7684\u6807\u7b7e\uff0c\u8be5\u6807\u7b7e\u7684\u5185\u5bb9\u5bf9\u5e94\u5230Target\u5b9e\u4f8b\u7684<code>__address__</code>\u3002 \u8fd9\u91cc\u5b9e\u9645\u4e0a\u662f\u53d1\u751f\u4e86\u4e00\u6b21\u6807\u7b7e\u7684\u91cd\u5199\u5904\u7406\u3002</p> <p>\u8fd9\u79cd\u53d1\u751f\u5728\u91c7\u96c6\u6837\u672c\u6570\u636e\u4e4b\u524d\uff0c\u5bf9Target\u5b9e\u4f8b\u7684\u6807\u7b7e\u8fdb\u884c\u91cd\u5199\u7684\u673a\u5236\u5728Prometheus\u88ab\u79f0\u4e3aRelabeling\u3002</p> <p></p> <p>Prometheus\u5141\u8bb8\u7528\u6237\u5728\u91c7\u96c6\u4efb\u52a1\u8bbe\u7f6e\u4e2d\u901a\u8fc7relabel_configs\u6765\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684Relabeling\u8fc7\u7a0b\u3002</p>"},{"location":"sd/service-discovery-with-relabel/#replacelabelmap","title":"\u4f7f\u7528replace/labelmap\u91cd\u5199\u6807\u7b7e","text":"<p>Relabeling\u6700\u57fa\u672c\u7684\u5e94\u7528\u573a\u666f\u5c31\u662f\u57fa\u4e8eTarget\u5b9e\u4f8b\u4e2d\u5305\u542b\u7684metadata\u6807\u7b7e\uff0c\u52a8\u6001\u7684\u6dfb\u52a0\u6216\u8005\u8986\u76d6\u6807\u7b7e\u3002\u4f8b\u5982\uff0c\u901a\u8fc7Consul\u52a8\u6001\u53d1\u73b0\u7684\u670d\u52a1\u5b9e\u4f8b\u8fd8\u4f1a\u5305\u542b\u4ee5\u4e0bMetadata\u6807\u7b7e\u4fe1\u606f\uff1a</p> <ul> <li>__meta_consul_address\uff1aconsul\u5730\u5740</li> <li>__meta_consul_dc\uff1aconsul\u4e2d\u670d\u52a1\u6240\u5728\u7684\u6570\u636e\u4e2d\u5fc3</li> <li>__meta_consulmetadata\uff1a\u670d\u52a1\u7684metadata</li> <li>__meta_consul_node\uff1a\u670d\u52a1\u6240\u5728consul\u8282\u70b9\u7684\u4fe1\u606f</li> <li>__meta_consul_service_address\uff1a\u670d\u52a1\u8bbf\u95ee\u5730\u5740</li> <li>__meta_consul_service_id\uff1a\u670d\u52a1ID</li> <li>__meta_consul_service_port\uff1a\u670d\u52a1\u7aef\u53e3</li> <li>__meta_consul_service\uff1a\u670d\u52a1\u540d\u79f0</li> <li>__meta_consul_tags\uff1a\u670d\u52a1\u5305\u542b\u7684\u6807\u7b7e\u4fe1\u606f</li> </ul> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4eceNode Exporter\u5b9e\u4f8b\u91c7\u96c6\u4e0a\u6765\u7684\u6837\u672c\u6570\u636e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>node_cpu{cpu=\"cpu0\",instance=\"localhost:9100\",job=\"node\",mode=\"idle\"} 93970.8203125\n</code></pre> <p>\u6211\u4eec\u5e0c\u671b\u80fd\u6709\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7edc\u53ef\u4ee5\u8868\u793a\u8be5\u6837\u672c\u6240\u5c5e\u7684\u6570\u636e\u4e2d\u5fc3\uff1a</p> <pre><code>node_cpu{cpu=\"cpu0\",instance=\"localhost:9100\",job=\"node\",mode=\"idle\", dc=\"dc1\"} 93970.8203125\n</code></pre> <p>\u5728\u6bcf\u4e00\u4e2a\u91c7\u96c6\u4efb\u52a1\u7684\u914d\u7f6e\u4e2d\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2arelabel_config\u914d\u7f6e\uff0c\u4e00\u4e2a\u6700\u7b80\u5355\u7684relabel\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>scrape_configs:\n  - job_name: node_exporter\n    consul_sd_configs:\n      - server: localhost:8500\n        services:\n          - node_exporter\n    relabel_configs:\n    - source_labels:  [\"__meta_consul_dc\"]\n      target_label: \"dc\"\n</code></pre> <p>\u8be5\u91c7\u96c6\u4efb\u52a1\u901a\u8fc7Consul\u52a8\u6001\u53d1\u73b0Node Exporter\u5b9e\u4f8b\u4fe1\u606f\u4f5c\u4e3a\u76d1\u63a7\u91c7\u96c6\u76ee\u6807\u3002\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u77e5\u9053\u901a\u8fc7Consul\u52a8\u6001\u53d1\u73b0\u7684\u76d1\u63a7Target\u90fd\u4f1a\u5305\u542b\u4e00\u4e9b\u989d\u5916\u7684Metadata\u6807\u7b7e\uff0c\u6bd4\u5982\u6807\u7b7e__meta_consul_dc\u8868\u660e\u4e86\u5f53\u524d\u5b9e\u4f8b\u6240\u5728\u7684Consul\u6570\u636e\u4e2d\u5fc3\uff0c\u56e0\u6b64\u6211\u4eec\u5e0c\u671b\u4ece\u8fd9\u4e9b\u5b9e\u4f8b\u4e2d\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6837\u672c\u4e2d\u4e5f\u53ef\u4ee5\u5305\u542b\u8fd9\u6837\u4e00\u4e2a\u6807\u7b7e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>node_cpu{cpu=\"cpu0\",dc=\"dc1\",instance=\"172.21.0.6:9100\",job=\"consul_sd\",mode=\"guest\"}\n</code></pre> <p>\u8fd9\u6837\u53ef\u4ee5\u65b9\u4fbf\u7684\u6839\u636edc\u6807\u7b7e\u7684\u503c\uff0c\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u4e2d\u5fc3\u805a\u5408\u5206\u6790\u5404\u81ea\u7684\u6570\u636e\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u901a\u8fc7\u4eceTarget\u5b9e\u4f8b\u4e2d\u83b7\u53d6__meta_consul_dc\u7684\u503c\uff0c\u5e76\u4e14\u91cd\u5199\u6240\u6709\u4ece\u8be5\u5b9e\u4f8b\u83b7\u53d6\u7684\u6837\u672c\u4e2d\u3002</p> <p>\u5b8c\u6574\u7684relabel_config\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># The source labels select values from existing labels. Their content is concatenated\n# using the configured separator and matched against the configured regular expression\n# for the replace, keep, and drop actions.\n[ source_labels: '[' &lt;labelname&gt; [, ...] ']' ]\n\n# Separator placed between concatenated source label values.\n[ separator: &lt;string&gt; | default = ; ]\n\n# Label to which the resulting value is written in a replace action.\n# It is mandatory for replace actions. Regex capture groups are available.\n[ target_label: &lt;labelname&gt; ]\n\n# Regular expression against which the extracted value is matched.\n[ regex: &lt;regex&gt; | default = (.*) ]\n\n# Modulus to take of the hash of the source label values.\n[ modulus: &lt;uint64&gt; ]\n\n# Replacement value against which a regex replace is performed if the\n# regular expression matches. Regex capture groups are available.\n[ replacement: &lt;string&gt; | default = $1 ]\n\n# Action to perform based on regex matching.\n[ action: &lt;relabel_action&gt; | default = replace ]\n</code></pre> <p>\u5176\u4e2daction\u5b9a\u4e49\u4e86\u5f53\u524drelabel_config\u5bf9Metadata\u6807\u7b7e\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u7684action\u884c\u4e3a\u4e3areplace\u3002 replace\u884c\u4e3a\u4f1a\u6839\u636eregex\u7684\u914d\u7f6e\u5339\u914dsource_labels\u6807\u7b7e\u7684\u503c\uff08\u591a\u4e2asource_label\u7684\u503c\u4f1a\u6309\u7167separator\u8fdb\u884c\u62fc\u63a5\uff09\uff0c\u5e76\u4e14\u5c06\u5339\u914d\u5230\u7684\u503c\u5199\u5165\u5230target_label\u5f53\u4e2d\uff0c\u5982\u679c\u6709\u591a\u4e2a\u5339\u914d\u7ec4\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528${1}, ${2}\u786e\u5b9a\u5199\u5165\u7684\u5185\u5bb9\u3002\u5982\u679c\u6ca1\u5339\u914d\u5230\u4efb\u4f55\u5185\u5bb9\u5219\u4e0d\u5bf9target_label\u8fdb\u884c\u91cd\u5199\u3002</p> <p>repalce\u64cd\u4f5c\u5141\u8bb8\u7528\u6237\u6839\u636eTarget\u7684Metadata\u6807\u7b7e\u91cd\u5199\u6216\u8005\u5199\u5165\u65b0\u7684\u6807\u7b7e\u952e\u503c\u5bf9\uff0c\u5728\u591a\u73af\u5883\u7684\u573a\u666f\u4e0b\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u6dfb\u52a0\u4e0e\u73af\u5883\u76f8\u5173\u7684\u7279\u5f81\u7ef4\u5ea6\uff0c\u4ece\u800c\u53ef\u4ee5\u66f4\u597d\u7684\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u3002</p> <p>\u9664\u4e86\u4f7f\u7528replace\u4ee5\u5916\uff0c\u8fd8\u53ef\u4ee5\u5b9a\u4e49action\u7684\u914d\u7f6e\u4e3alabelmap\u3002\u4e0ereplace\u4e0d\u540c\u7684\u662f\uff0clabelmap\u4f1a\u6839\u636eregex\u7684\u5b9a\u4e49\u53bb\u5339\u914dTarget\u5b9e\u4f8b\u6240\u6709\u6807\u7b7e\u7684\u540d\u79f0\uff0c\u5e76\u4e14\u4ee5\u5339\u914d\u5230\u7684\u5185\u5bb9\u4e3a\u65b0\u7684\u6807\u7b7e\u540d\u79f0\uff0c\u5176\u503c\u4f5c\u4e3a\u65b0\u6807\u7b7e\u7684\u503c\u3002</p> <p>\u4f8b\u5982\uff0c\u5728\u76d1\u63a7Kubernetes\u4e0b\u6240\u6709\u7684\u4e3b\u673a\u8282\u70b9\u65f6\uff0c\u4e3a\u5c06\u8fd9\u4e9b\u8282\u70b9\u4e0a\u5b9a\u4e49\u7684\u6807\u7b7e\u5199\u5165\u5230\u6837\u672c\u4e2d\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0brelabel_config\u914d\u7f6e\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u800c\u4f7f\u7528labelkeep\u6216\u8005labeldrop\u5219\u53ef\u4ee5\u5bf9Target\u6807\u7b7e\u8fdb\u884c\u8fc7\u6ee4\uff0c\u4ec5\u4fdd\u7559\u7b26\u5408\u8fc7\u6ee4\u6761\u4ef6\u7684\u6807\u7b7e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>relabel_configs:\n  - regex: label_should_drop_(.+)\n    action: labeldrop\n</code></pre> <p>\u8be5\u914d\u7f6e\u4f1a\u4f7f\u7528regex\u5339\u914d\u5f53\u524dTarget\u5b9e\u4f8b\u7684\u6240\u6709\u6807\u7b7e\uff0c\u5e76\u5c06\u7b26\u5408regex\u89c4\u5219\u7684\u6807\u7b7e\u4eceTarget\u5b9e\u4f8b\u4e2d\u79fb\u9664\u3002labelkeep\u6b63\u597d\u76f8\u53cd\uff0c\u4f1a\u79fb\u9664\u90a3\u4e9b\u4e0d\u5339\u914dregex\u5b9a\u4e49\u7684\u6240\u6709\u6807\u7b7e\u3002</p>"},{"location":"sd/service-discovery-with-relabel/#keepdroptarget","title":"\u4f7f\u7528keep/drop\u8fc7\u6ee4Target\u5b9e\u4f8b","text":"<p>\u5728\u4e0a\u4e00\u90e8\u5206\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86Prometheus\u7684Relabeling\u673a\u5236\uff0c\u5e76\u4e14\u4f7f\u7528\u4e86replace/labelmap/labelkeep/labeldrop\u5bf9\u6807\u7b7e\u8fdb\u884c\u7ba1\u7406\u3002\u800c\u672c\u8282\u5f00\u5934\u8fd8\u63d0\u5230\u8fc7\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff0c\u4f7f\u7528\u4e2d\u5fc3\u5316\u7684\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\u65f6\uff0c\u6240\u6709\u73af\u5883\u7684Exporter\u5b9e\u4f8b\u90fd\u4f1a\u6ce8\u518c\u5230\u8be5\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\u4e2d\u3002\u800c\u4e0d\u540c\u804c\u80fd\uff08\u5f00\u53d1\u3001\u6d4b\u8bd5\u3001\u8fd0\u7ef4\uff09\u7684\u4eba\u5458\u53ef\u80fd\u53ea\u5173\u5fc3\u5176\u4e2d\u4e00\u90e8\u5206\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4ed6\u4eec\u53ef\u80fd\u5404\u81ea\u90e8\u7f72\u7684\u81ea\u5df1\u7684Prometheus Server\u7528\u4e8e\u76d1\u63a7\u81ea\u5df1\u5173\u5fc3\u7684\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u8ba9\u8fd9\u4e9bPrometheus Server\u91c7\u96c6\u6240\u6709\u73af\u5883\u4e2d\u7684\u6240\u6709Exporter\u6570\u636e\u663e\u7136\u4f1a\u5b58\u5728\u5927\u91cf\u7684\u8d44\u6e90\u6d6a\u8d39\u3002\u5982\u4f55\u8ba9\u8fd9\u4e9b\u4e0d\u540c\u7684Prometheus Server\u91c7\u96c6\u5404\u81ea\u5173\u5fc3\u7684\u5185\u5bb9\uff1f\u7b54\u6848\u8fd8\u662fRelabeling\uff0crelabel_config\u7684action\u9664\u4e86\u9ed8\u8ba4\u7684replace\u4ee5\u5916\uff0c\u8fd8\u652f\u6301keep/drop\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u53ea\u5e0c\u671b\u91c7\u96c6\u6570\u636e\u4e2d\u5fc3dc1\u4e2d\u7684Node Exporter\u5b9e\u4f8b\u7684\u6837\u672c\u6570\u636e\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>scrape_configs:\n  - job_name: node_exporter\n    consul_sd_configs:\n      - server: localhost:8500\n        services:\n          - node_exporter\n    relabel_configs:\n    - source_labels:  [\"__meta_consul_dc\"]\n      regex: \"dc1\"\n      action: keep\n</code></pre> <p>\u5f53action\u8bbe\u7f6e\u4e3akeep\u65f6\uff0cPrometheus\u4f1a\u4e22\u5f03source_labels\u7684\u503c\u4e2d\u6ca1\u6709\u5339\u914d\u5230regex\u6b63\u5219\u8868\u8fbe\u5f0f\u5185\u5bb9\u7684Target\u5b9e\u4f8b\uff0c\u800c\u5f53action\u8bbe\u7f6e\u4e3adrop\u65f6\uff0c\u5219\u4f1a\u4e22\u5f03\u90a3\u4e9bsource_labels\u7684\u503c\u5339\u914d\u5230regex\u6b63\u5219\u8868\u8fbe\u5f0f\u5185\u5bb9\u7684Target\u5b9e\u4f8b\u3002\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3akeep\u7528\u4e8e\u9009\u62e9\uff0c\u800cdrop\u7528\u4e8e\u6392\u9664\u3002</p>"},{"location":"sd/service-discovery-with-relabel/#hashmodsource_labelshash","title":"\u4f7f\u7528hashmod\u8ba1\u7b97source_labels\u7684Hash\u503c","text":"<p>\u5f53relabel_config\u8bbe\u7f6e\u4e3ahashmod\u65f6\uff0cPrometheus\u4f1a\u6839\u636emodulus\u7684\u503c\u4f5c\u4e3a\u7cfb\u6570\uff0c\u8ba1\u7b97source_labels\u503c\u7684hash\u503c\u3002\u4f8b\u5982\uff1a</p> <pre><code>scrape_configs\n- job_name: 'file_ds'\n  relabel_configs:\n    - source_labels: [__address__]\n      modulus:       4\n      target_label:  tmp_hash\n      action:        hashmod\n  file_sd_configs:\n  - files:\n    - targets.json\n</code></pre> <p>\u6839\u636e\u5f53\u524dTarget\u5b9e\u4f8b<code>__address__</code>\u7684\u503c\u4ee54\u4f5c\u4e3a\u7cfb\u6570\uff0c\u8fd9\u6837\u6bcf\u4e2aTarget\u5b9e\u4f8b\u90fd\u4f1a\u5305\u542b\u4e00\u4e2a\u65b0\u7684\u6807\u7b7etmp_hash\uff0c\u5e76\u4e14\u8be5\u503c\u7684\u8303\u56f4\u57281~4\u4e4b\u95f4\uff0c\u67e5\u770bTarget\u5b9e\u4f8b\u7684\u6807\u7b7e\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7684\u7ed3\u679c\uff0c\u6bcf\u4e00\u4e2aTarget\u5b9e\u4f8b\u90fd\u5305\u542b\u4e86\u4e00\u4e2a\u65b0\u7684tmp_hash\u503c\uff1a</p> <p></p> <p>\u5728\u7b2c6\u7ae0\u7684\u201cPrometheus\u9ad8\u53ef\u7528\u201d\u5c0f\u8282\u4e2d\uff0c\u6b63\u662f\u5229\u7528\u4e86Hashmod\u7684\u80fd\u529b\u5728Target\u5b9e\u4f8b\u7ea7\u522b\u5b9e\u73b0\u5bf9\u91c7\u96c6\u4efb\u52a1\u7684\u529f\u80fd\u5206\u533a\u7684:</p> <pre><code>scrape_configs:\n  - job_name: some_job\n    relabel_configs:\n    - source_labels: [__address__]\n      modulus:       4\n      target_label:  __tmp_hash\n      action:        hashmod\n    - source_labels: [__tmp_hash]\n      regex:         ^1$\n      action:        keep\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679crelabel\u7684\u64cd\u4f5c\u53ea\u662f\u4e3a\u4e86\u4ea7\u751f\u4e00\u4e2a\u4e34\u65f6\u53d8\u91cf\uff0c\u4ee5\u4f5c\u4e3a\u4e0b\u4e00\u4e2arelabel\u64cd\u4f5c\u7684\u8f93\u5165\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>__tmp</code>\u4f5c\u4e3a\u6807\u7b7e\u540d\u7684\u524d\u7f00\uff0c\u901a\u8fc7\u8be5\u524d\u7f00\u5b9a\u4e49\u7684\u6807\u7b7e\u5c31\u4e0d\u4f1a\u5199\u5165\u5230Target\u6216\u8005\u91c7\u96c6\u5230\u7684\u6837\u672c\u7684\u6807\u7b7e\u4e2d\u3002</p>"},{"location":"sd/why-need-service-discovery/","title":"Prometheus\u4e0e\u670d\u52a1\u53d1\u73b0","text":"<p>\u5728\u57fa\u4e8e\u4e91(IaaS\u6216\u8005CaaS)\u7684\u57fa\u7840\u8bbe\u65bd\u73af\u5883\u4e2d\u7528\u6237\u53ef\u4ee5\u50cf\u4f7f\u7528\u6c34\u3001\u7535\u4e00\u6837\u6309\u9700\u4f7f\u7528\u5404\u79cd\u8d44\u6e90\uff08\u8ba1\u7b97\u3001\u7f51\u7edc\u3001\u5b58\u50a8\uff09\u3002\u6309\u9700\u4f7f\u7528\u5c31\u610f\u5473\u7740\u8d44\u6e90\u7684\u52a8\u6001\u6027\uff0c\u8fd9\u4e9b\u8d44\u6e90\u53ef\u4ee5\u968f\u7740\u9700\u6c42\u89c4\u6a21\u7684\u53d8\u5316\u800c\u53d8\u5316\u3002\u4f8b\u5982\u5728AWS\u4e2d\u5c31\u63d0\u4f9b\u4e86\u4e13\u95e8\u7684AutoScall\u670d\u52a1\uff0c\u53ef\u4ee5\u6839\u636e\u7528\u6237\u5b9a\u4e49\u7684\u89c4\u5219\u52a8\u6001\u5730\u521b\u5efa\u6216\u8005\u9500\u6bc1EC2\u5b9e\u4f8b\uff0c\u4ece\u800c\u4f7f\u7528\u6237\u90e8\u7f72\u5728AWS\u4e0a\u7684\u5e94\u7528\u53ef\u4ee5\u81ea\u52a8\u7684\u9002\u5e94\u8bbf\u95ee\u89c4\u6a21\u7684\u53d8\u5316\u3002</p> <p>\u8fd9\u79cd\u6309\u9700\u7684\u8d44\u6e90\u4f7f\u7528\u65b9\u5f0f\u5bf9\u4e8e\u76d1\u63a7\u7cfb\u7edf\u800c\u8a00\u5c31\u610f\u5473\u7740\u6ca1\u6709\u4e86\u4e00\u4e2a\u56fa\u5b9a\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u6240\u6709\u7684\u76d1\u63a7\u5bf9\u8c61(\u57fa\u7840\u8bbe\u65bd\u3001\u5e94\u7528\u3001\u670d\u52a1)\u90fd\u5728\u52a8\u6001\u7684\u53d8\u5316\u3002\u5bf9\u4e8eNagios\u8fd9\u7c7b\u57fa\u4e8ePush\u6a21\u5f0f\u4f20\u7edf\u76d1\u63a7\u8f6f\u4ef6\u5c31\u610f\u5473\u7740\u5fc5\u987b\u5728\u6bcf\u4e00\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5\u76f8\u5e94\u7684Agent\u7a0b\u5e8f\uff0c\u5e76\u4e14\u901a\u8fc7\u914d\u7f6e\u6307\u5411\u4e2d\u5fc3\u7684Nagios\u670d\u52a1\uff0c\u53d7\u76d1\u63a7\u7684\u8d44\u6e90\u4e0e\u4e2d\u5fc3\u76d1\u63a7\u670d\u52a1\u5668\u4e4b\u95f4\u662f\u4e00\u4e2a\u5f3a\u8026\u5408\u7684\u5173\u7cfb\uff0c\u8981\u4e48\u76f4\u63a5\u5c06Agent\u6784\u5efa\u5230\u57fa\u7840\u8bbe\u65bd\u955c\u50cf\u5f53\u4e2d\uff0c\u8981\u4e48\u4f7f\u7528\u4e00\u4e9b\u81ea\u52a8\u5316\u914d\u7f6e\u7ba1\u7406\u5de5\u5177(\u5982Ansible\u3001Chef)\u52a8\u6001\u7684\u914d\u7f6e\u8fd9\u4e9b\u8282\u70b9\u3002\u5f53\u7136\u5b9e\u9645\u573a\u666f\u4e0b\u9664\u4e86\u57fa\u7840\u8bbe\u65bd\u7684\u76d1\u63a7\u9700\u6c42\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u76d1\u63a7\u5728\u4e91\u4e0a\u90e8\u7f72\u7684\u5e94\u7528\uff0c\u4e2d\u95f4\u4ef6\u7b49\u7b49\u5404\u79cd\u5404\u6837\u7684\u670d\u52a1\u3002\u8981\u642d\u5efa\u8d77\u8fd9\u6837\u4e00\u5957\u4e2d\u5fc3\u5316\u7684\u76d1\u63a7\u7cfb\u7edf\u5b9e\u65bd\u6210\u672c\u548c\u96be\u5ea6\u662f\u663e\u800c\u6613\u89c1\u7684\u3002</p> <p>\u800c\u5bf9\u4e8ePrometheus\u8fd9\u4e00\u7c7b\u57fa\u4e8ePull\u6a21\u5f0f\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u663e\u7136\u4e5f\u65e0\u6cd5\u7ee7\u7eed\u4f7f\u7528\u7684static_configs\u7684\u65b9\u5f0f\u9759\u6001\u7684\u5b9a\u4e49\u76d1\u63a7\u76ee\u6807\u3002\u800c\u5bf9\u4e8ePrometheus\u800c\u8a00\u5176\u89e3\u51b3\u65b9\u6848\u5c31\u662f\u5f15\u5165\u4e00\u4e2a\u4e2d\u95f4\u7684\u4ee3\u7406\u4eba\uff08\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff09\uff0c\u8fd9\u4e2a\u4ee3\u7406\u4eba\u638c\u63e1\u7740\u5f53\u524d\u6240\u6709\u76d1\u63a7\u76ee\u6807\u7684\u8bbf\u95ee\u4fe1\u606f\uff0cPrometheus\u53ea\u9700\u8981\u5411\u8fd9\u4e2a\u4ee3\u7406\u4eba\u8be2\u95ee\u6709\u54ea\u4e9b\u76d1\u63a7\u76ee\u6807\u5373\u53ef\uff0c \u8fd9\u79cd\u6a21\u5f0f\u88ab\u79f0\u4e3a\u670d\u52a1\u53d1\u73b0\u3002</p> <p></p> <p>\u5728\u4e0d\u540c\u7684\u573a\u666f\u4e0b\uff0c\u4f1a\u6709\u4e0d\u540c\u7684\u4e1c\u897f\u626e\u6f14\u4ee3\u7406\u4eba\uff08\u670d\u52a1\u53d1\u73b0\u4e0e\u6ce8\u518c\u4e2d\u5fc3\uff09\u8fd9\u4e00\u89d2\u8272\u3002\u6bd4\u5982\u5728AWS\u516c\u6709\u4e91\u5e73\u53f0\u6216\u8005OpenStack\u7684\u79c1\u6709\u4e91\u5e73\u53f0\u4e2d\uff0c\u7531\u4e8e\u8fd9\u4e9b\u5e73\u53f0\u81ea\u8eab\u638c\u63e1\u7740\u6240\u6709\u8d44\u6e90\u7684\u4fe1\u606f\uff0c\u6b64\u65f6\u8fd9\u4e9b\u4e91\u5e73\u53f0\u81ea\u8eab\u5c31\u626e\u6f14\u4e86\u4ee3\u7406\u4eba\u7684\u89d2\u8272\u3002Prometheus\u901a\u8fc7\u4f7f\u7528\u5e73\u53f0\u63d0\u4f9b\u7684API\u5c31\u53ef\u4ee5\u627e\u5230\u6240\u6709\u9700\u8981\u76d1\u63a7\u7684\u4e91\u4e3b\u673a\u3002\u5728Kubernetes\u8fd9\u7c7b\u5bb9\u5668\u7ba1\u7406\u5e73\u53f0\u4e2d\uff0cKubernetes\u638c\u63e1\u5e76\u7ba1\u7406\u7740\u6240\u6709\u7684\u5bb9\u5668\u4ee5\u53ca\u670d\u52a1\u4fe1\u606f\uff0c\u90a3\u6b64\u65f6Prometheus\u53ea\u9700\u8981\u4e0eKubernetes\u6253\u4ea4\u9053\u5c31\u53ef\u4ee5\u627e\u5230\u6240\u6709\u9700\u8981\u76d1\u63a7\u7684\u5bb9\u5668\u4ee5\u53ca\u670d\u52a1\u5bf9\u8c61\u3002Prometheus\u8fd8\u53ef\u4ee5\u76f4\u63a5\u4e0e\u4e00\u4e9b\u5f00\u6e90\u7684\u670d\u52a1\u53d1\u73b0\u5de5\u5177\u8fdb\u884c\u96c6\u6210\uff0c\u4f8b\u5982\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u4f7f\u7528\u5230\u4f8b\u5982Consul\u8fd9\u6837\u7684\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u8f6f\u4ef6\uff0cPromethues\u4e5f\u53ef\u4ee5\u4e0e\u5176\u96c6\u6210\u4ece\u800c\u52a8\u6001\u7684\u53d1\u73b0\u9700\u8981\u76d1\u63a7\u7684\u5e94\u7528\u670d\u52a1\u5b9e\u4f8b\u3002\u9664\u4e86\u4e0e\u8fd9\u4e9b\u5e73\u53f0\u7ea7\u7684\u516c\u6709\u4e91\u3001\u79c1\u6709\u4e91\u3001\u5bb9\u5668\u4e91\u4ee5\u53ca\u4e13\u95e8\u7684\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\u96c6\u6210\u4ee5\u5916\uff0cPrometheus\u8fd8\u652f\u6301\u57fa\u4e8eDNS\u4ee5\u53ca\u6587\u4ef6\u7684\u65b9\u5f0f\u52a8\u6001\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\uff0c\u4ece\u800c\u5927\u5927\u7684\u51cf\u5c11\u4e86\u5728\u4e91\u539f\u751f\uff0c\u5fae\u670d\u52a1\u4ee5\u53ca\u4e91\u6a21\u5f0f\u4e0b\u76d1\u63a7\u5b9e\u65bd\u96be\u5ea6\u3002</p> <p></p> <p>\u5982\u4e0a\u6240\u793a\uff0c\u5c55\u793a\u4e86Push\u7cfb\u7edf\u548cPull\u7cfb\u7edf\u7684\u6838\u5fc3\u5dee\u5f02\u3002\u76f8\u8f83\u4e8ePush\u6a21\u5f0f\uff0cPull\u6a21\u5f0f\u7684\u4f18\u70b9\u53ef\u4ee5\u7b80\u5355\u603b\u7ed3\u4e3a\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u53ea\u8981Exporter\u5728\u8fd0\u884c\uff0c\u4f60\u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\uff08\u6bd4\u5982\u5728\u672c\u5730\uff09\uff0c\u642d\u5efa\u4f60\u7684\u76d1\u63a7\u7cfb\u7edf\uff1b</li> <li>\u4f60\u53ef\u4ee5\u66f4\u5bb9\u6613\u7684\u67e5\u770b\u76d1\u63a7\u76ee\u6807\u5b9e\u4f8b\u7684\u5065\u5eb7\u72b6\u6001\uff0c\u5e76\u4e14\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u6545\u969c\uff1b</li> <li>\u66f4\u5229\u4e8e\u6784\u5efaDevOps\u6587\u5316\u7684\u56e2\u961f\uff1b</li> <li>\u677e\u8026\u5408\u7684\u67b6\u6784\u6a21\u5f0f\u66f4\u9002\u5408\u4e8e\u4e91\u539f\u751f\u7684\u90e8\u7f72\u73af\u5883\u3002</li> </ul>"},{"location":"sources/blackbox-dns-probe/","title":"DNS\u63a2\u9488","text":"<pre><code># The preferred IP protocol of the DNS probe (ip4, ip6).\n[ preferred_ip_protocol: &lt;string&gt; | default = \"ip6\" ]\n\n# The source IP address.\n[ source_ip_address: &lt;string&gt; ]\n\n[ transport_protocol: &lt;string&gt; | default = \"udp\" ] # udp, tcp\n\nquery_name: &lt;string&gt;\n\n[ query_type: &lt;string&gt; | default = \"ANY\" ]\n\n# List of valid response codes.\nvalid_rcodes:\n  [ - &lt;string&gt; ... | default = \"NOERROR\" ]\n\nvalidate_answer_rrs:\n\n  fail_if_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n\n  fail_if_not_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n\nvalidate_authority_rrs:\n\n  fail_if_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n\n  fail_if_not_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n\nvalidate_additional_rrs:\n\n  fail_if_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n\n  fail_if_not_matches_regexp:\n    [ - &lt;regex&gt;, ... ]\n</code></pre>"},{"location":"sources/blackbox-http-probe/","title":"Blackbox http probe","text":""},{"location":"sources/blackbox-http-probe/#http","title":"HTTP\u63a2\u9488","text":"<p>HTTP\u63a2\u9488\u662f\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7\u65f6\u6700\u5e38\u7528\u7684\u63a2\u9488\u4e4b\u4e00\uff0c\u901a\u8fc7HTTP\u63a2\u9488\u80fd\u591f\u7f51\u7ad9\u6216\u8005HTTP\u670d\u52a1\u5efa\u7acb\u6709\u6548\u7684\u76d1\u63a7\uff0c\u5305\u62ec\u5176\u672c\u8eab\u7684\u53ef\u7528\u6027\uff0c\u4ee5\u53ca\u7528\u6237\u4f53\u9a8c\u76f8\u5173\u7684\u5982\u54cd\u5e94\u65f6\u95f4\u7b49\u7b49\u3002\u9664\u4e86\u80fd\u591f\u5728\u670d\u52a1\u51fa\u73b0\u5f02\u5e38\u7684\u65f6\u5019\u53ca\u65f6\u62a5\u8b66\uff0c\u8fd8\u80fd\u5e2e\u52a9\u7cfb\u7edf\u7ba1\u7406\u5458\u5206\u6790\u548c\u4f18\u5316\u7f51\u7ad9\u4f53\u9a8c\u3002</p> <p>\u5728\u4e0a\u4e00\u5c0f\u8282\u8bb2\u8fc7\uff0cBlockbox Exporter\u4e2d\u6240\u6709\u7684\u63a2\u9488\u5747\u662f\u4ee5Module\u7684\u4fe1\u606f\u8fdb\u884c\u914d\u7f6e\u3002\u5982\u4e0b\u6240\u793a\uff0c\u914d\u7f6e\u4e86\u4e00\u4e2a\u6700\u7b80\u5355\u7684HTTP\u63a2\u9488\uff1a</p> <pre><code>modules:\n  http_2xx_example:\n    prober: http\n    http:\n</code></pre> <p>\u901a\u8fc7prober\u914d\u7f6e\u9879\u6307\u5b9a\u63a2\u9488\u7c7b\u578b\u3002\u914d\u7f6e\u9879http\u7528\u4e8e\u81ea\u5b9a\u4e49\u63a2\u9488\u7684\u63a2\u6d4b\u65b9\u5f0f\uff0c\u8fd9\u91cc\u6709\u6ca1\u5bf9http\u914d\u7f6e\u9879\u6dfb\u52a0\u4efb\u4f55\u914d\u7f6e\uff0c\u8868\u793a\u5b8c\u5168\u4f7f\u7528HTTP\u63a2\u9488\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u63a2\u9488\u5c06\u4f7f\u7528HTTP GET\u7684\u65b9\u5f0f\u5bf9\u76ee\u6807\u670d\u52a1\u8fdb\u884c\u63a2\u6d4b\uff0c\u5e76\u4e14\u9a8c\u8bc1\u8fd4\u56de\u72b6\u6001\u7801\u662f\u5426\u4e3a2XX\uff0c\u662f\u5219\u8868\u793a\u9a8c\u8bc1\u6210\u529f\uff0c\u5426\u5219\u5931\u8d25\u3002</p>"},{"location":"sources/blackbox-http-probe/#http_1","title":"\u81ea\u5b9a\u4e49HTTP\u8bf7\u6c42","text":"<p>HTTP\u670d\u52a1\u901a\u5e38\u4f1a\u4ee5\u4e0d\u540c\u7684\u5f62\u5f0f\u5bf9\u5916\u5c55\u73b0\uff0c\u6709\u4e9b\u53ef\u80fd\u5c31\u662f\u4e00\u4e9b\u7b80\u5355\u7684\u7f51\u9875\uff0c\u800c\u6709\u4e9b\u5219\u53ef\u80fd\u662f\u4e00\u4e9b\u57fa\u4e8eREST\u7684API\u670d\u52a1\u3002 \u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684HTTP\u7684\u63a2\u6d4b\u9700\u8981\u7ba1\u7406\u5458\u80fd\u591f\u5bf9HTTP\u63a2\u9488\u7684\u884c\u4e3a\u8fdb\u884c\u66f4\u591a\u7684\u81ea\u5b9a\u4e49\u8bbe\u7f6e\uff0c\u5305\u62ec\uff1aHTTP\u8bf7\u6c42\u65b9\u6cd5\u3001HTTP\u5934\u4fe1\u606f\u3001\u8bf7\u6c42\u53c2\u6570\u7b49\u3002\u5bf9\u4e8e\u67d0\u4e9b\u542f\u7528\u4e86\u5b89\u5168\u8ba4\u8bc1\u7684\u670d\u52a1\u8fd8\u9700\u8981\u80fd\u591f\u5bf9HTTP\u63a2\u6d4b\u8bbe\u7f6e\u76f8\u5e94\u7684Auth\u652f\u6301\u3002\u5bf9\u4e8eHTTPS\u7c7b\u578b\u7684\u670d\u52a1\u8fd8\u9700\u8981\u80fd\u591f\u5bf9\u8bc1\u4e66\u8fdb\u884c\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u8fd9\u91cc\u901a\u8fc7method\u5b9a\u4e49\u4e86\u63a2\u6d4b\u65f6\u4f7f\u7528\u7684\u8bf7\u6c42\u65b9\u6cd5\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u9700\u8981\u8bf7\u6c42\u53c2\u6570\u7684\u670d\u52a1\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7headers\u5b9a\u4e49\u76f8\u5173\u7684\u8bf7\u6c42\u5934\u4fe1\u606f\uff0c\u4f7f\u7528body\u5b9a\u4e49\u8bf7\u6c42\u5185\u5bb9\uff1a</p> <pre><code>http_post_2xx:\n    prober: http\n    timeout: 5s\n    http:\n      method: POST\n      headers:\n        Content-Type: application/json\n      body: '{}'\n</code></pre> <p>\u5982\u679cHTTP\u670d\u52a1\u542f\u7528\u4e86\u5b89\u5168\u8ba4\u8bc1\uff0cBlockbox Exporter\u5185\u7f6e\u4e86\u5bf9basic_auth\u7684\u652f\u6301\uff0c\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u76f8\u5173\u7684\u8ba4\u8bc1\u4fe1\u606f\u5373\u53ef\uff1a</p> <pre><code>http_basic_auth_example:\n    prober: http\n    timeout: 5s\n    http:\n      method: POST\n      headers:\n        Host: \"login.example.com\"\n      basic_auth:\n        username: \"username\"\n        password: \"mysecret\"\n</code></pre> <p>\u5bf9\u4e8e\u4f7f\u7528\u4e86Bear Token\u7684\u670d\u52a1\u4e5f\u53ef\u4ee5\u901a\u8fc7bearer_token\u914d\u7f6e\u9879\u76f4\u63a5\u6307\u5b9a\u4ee4\u724c\u5b57\u7b26\u4e32\uff0c\u6216\u8005\u901a\u8fc7bearer_token_file\u6307\u5b9a\u4ee4\u724c\u6587\u4ef6\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e9b\u542f\u7528\u4e86HTTPS\u7684\u670d\u52a1\uff0c\u4f46\u662f\u9700\u8981\u81ea\u5b9a\u4e49\u8bc1\u4e66\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7tls_config\u6307\u5b9a\u76f8\u5173\u7684\u8bc1\u4e66\u4fe1\u606f\uff1a</p> <pre><code> http_custom_ca_example:\n    prober: http\n    http:\n      method: GET\n      tls_config:\n        ca_file: \"/certs/my_cert.crt\"\n</code></pre>"},{"location":"sources/blackbox-http-probe/#_1","title":"\u81ea\u5b9a\u4e49\u63a2\u9488\u884c\u4e3a","text":"<p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0bHTTP\u63a2\u9488\u53ea\u4f1a\u5bf9HTTP\u8fd4\u56de\u72b6\u6001\u7801\u8fdb\u884c\u6821\u9a8c\uff0c\u5982\u679c\u72b6\u6001\u7801\u4e3a2XX\uff08200 &lt;= StatusCode &lt; 300\uff09\u5219\u8868\u793a\u63a2\u6d4b\u6210\u529f\uff0c\u5e76\u4e14\u63a2\u9488\u8fd4\u56de\u7684\u6307\u6807probe_success\u503c\u4e3a1\u3002</p> <p>\u5982\u679c\u7528\u6237\u9700\u8981\u6307\u5b9aHTTP\u8fd4\u56de\u72b6\u6001\u7801\uff0c\u6216\u8005\u5bf9HTTP\u7248\u672c\u6709\u7279\u6b8a\u8981\u6c42\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u4f7f\u7528valid_http_versions\u548cvalid_status_codes\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]\n      valid_status_codes: []\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cBlockbox\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u4e5f\u4f1a\u5305\u542b\u6307\u6807probe_http_ssl\uff0c\u7528\u4e8e\u8868\u660e\u5f53\u524d\u63a2\u9488\u662f\u5426\u4f7f\u7528\u4e86SSL\uff1a</p> <pre><code># HELP probe_http_ssl Indicates if SSL was used for the final redirect\n# TYPE probe_http_ssl gauge\nprobe_http_ssl 0\n</code></pre> <p>\u800c\u5982\u679c\u7528\u6237\u5bf9\u4e8eHTTP\u670d\u52a1\u662f\u5426\u542f\u7528SSL\u6709\u5f3a\u5236\u7684\u6807\u51c6\u3002\u5219\u53ef\u4ee5\u4f7f\u7528fail_if_ssl\u548cfail_if_not_ssl\u8fdb\u884c\u914d\u7f6e\u3002fail_if_ssl\u4e3atrue\u65f6\uff0c\u8868\u793a\u5982\u679c\u7ad9\u70b9\u542f\u7528\u4e86SSL\u5219\u63a2\u9488\u5931\u8d25\uff0c\u53cd\u4e4b\u6210\u529f\u3002fail_if_not_ssl\u521a\u597d\u76f8\u53cd\u3002</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      valid_status_codes: []\n      method: GET\n      no_follow_redirects: false\n      fail_if_ssl: false\n      fail_if_not_ssl: false\n</code></pre> <p>\u9664\u4e86\u57fa\u4e8eHTTP\u72b6\u6001\u7801\uff0cHTTP\u534f\u8bae\u7248\u672c\u4ee5\u53ca\u662f\u5426\u542f\u7528SSL\u4f5c\u4e3a\u63a7\u5236\u63a2\u9488\u63a2\u6d4b\u884c\u4e3a\u6210\u529f\u4e0e\u5426\u7684\u6807\u51c6\u4ee5\u5916\uff0c\u8fd8\u53ef\u4ee5\u5339\u914dHTTP\u670d\u52a1\u7684\u54cd\u5e94\u5185\u5bb9\u3002\u4f7f\u7528fail_if_matches_regexp\u548cfail_if_not_matches_regexp\u7528\u6237\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7ec4\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u7528\u4e8e\u9a8c\u8bc1HTTP\u8fd4\u56de\u5185\u5bb9\u662f\u5426\u7b26\u5408\u6216\u8005\u4e0d\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5185\u5bb9\u3002</p> <pre><code>  http_2xx_example:\n    prober: http\n    timeout: 5s\n    http:\n      method: GET\n      fail_if_matches_regexp:\n        - \"Could not connect to database\"\n      fail_if_not_matches_regexp:\n        - \"Download the latest version here\"\n</code></pre> <p>\u6700\u540e\u9700\u8981\u63d0\u9192\u7684\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bHTTP\u63a2\u9488\u4f1a\u8d70IPV6\u7684\u534f\u8bae\u3002 \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528preferred_ip_protocol=ip4\u5f3a\u5236\u901a\u8fc7IPV4\u7684\u65b9\u5f0f\u8fdb\u884c\u63a2\u6d4b\u3002\u5728Bloackbox\u54cd\u5e94\u7684\u76d1\u63a7\u6837\u672c\u4e2d\uff0c\u4e5f\u4f1a\u901a\u8fc7\u6307\u6807probe_ip_protocol\uff0c\u8868\u660e\u5f53\u524d\u7684\u534f\u8bae\u4f7f\u7528\u60c5\u51b5\uff1a</p> <pre><code># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6\n# TYPE probe_ip_protocol gauge\nprobe_ip_protocol 6\n</code></pre>"},{"location":"sources/blackbox-icmp-probe/","title":"ICMP\u63a2\u9488","text":"<pre><code># The preferred IP protocol of the ICMP probe (ip4, ip6).\n[ preferred_ip_protocol: &lt;string&gt; | default = \"ip6\" ]\n\n# The source IP address.\n[ source_ip_address: &lt;string&gt; ]\n\n# Set the DF-bit in the IP-header. Only works with ip4 and on *nix systems.\n[ dont_fragment: &lt;boolean&gt; | default = false ]\n\n# The size of the payload.\n[ payload_size: &lt;int&gt; ]\n</code></pre>"},{"location":"sources/blackbox-ipvx-probe/","title":"IPv4\u548cIPv6\u63a2\u9488","text":""},{"location":"sources/blackbox-tcp-probe/","title":"TCP\u63a2\u9488","text":"<pre><code># The preferred IP protocol of the TCP probe (ip4, ip6).\n[ preferred_ip_protocol: &lt;string&gt; | default = \"ip6\" ]\n\n# The source IP address.\n[ source_ip_address: &lt;string&gt; ]\n\n# The query sent in the TCP probe and the expected associated response.\n# starttls upgrades TCP connection to TLS.\nquery_response:\n  [ - [ [ expect: &lt;string&gt; ],\n        [ send: &lt;string&gt; ],\n        [ starttls: &lt;boolean | default = false&gt; ]\n      ], ...\n  ]\n\n# Whether or not TLS is used when the connection is initiated.\n[ tls: &lt;boolean | default = false&gt; ]\n\n# Configuration for TLS protocol of TCP probe.\ntls_config:\n  [ &lt;tls_config&gt; ]\n</code></pre>"},{"location":"sources/comparison_with_other/","title":"\u767e\u91cc\u6311\u4e00","text":"<p>TODO</p>"},{"location":"sources/comparison_with_other/#prometheus-vs-graphite","title":"Prometheus Vs Graphite","text":""},{"location":"sources/comparison_with_other/#_2","title":"\u8303\u56f4","text":"<p>Graphite\u4e13\u6ce8\u4e8e\u65f6\u5e8f\u6570\u636e\u5e93\u672c\u8eab\uff0c\u5bf9\u5916\u63d0\u4f9b\u67e5\u8be2\u548c\u56fe\u5f62\u53ef\u89c6\u5316\u7684\u529f\u80fd\u3002 \u800c\u5176\u4ed6\u76d1\u63a7\u76f8\u5173\u7684\u95ee\u9898\u90fd\u9700\u8981\u7531\u5916\u90e8\u7ec4\u4ef6\u6765\u89e3\u51b3\u3002</p> <p>Prometheus\u5219\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5305\u62ec\u5185\u7f6e\u7684\u6570\u636e\u91c7\u96c6\uff0c\u5b58\u50a8\uff0c\u67e5\u8be2\uff0c\u56fe\u5f62\u53ef\u89c6\u5316\u4ee5\u53ca\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u7684\u544a\u8b66\u80fd\u529b\u3002</p>"},{"location":"sources/comparison_with_other/#_3","title":"\u6570\u636e\u6a21\u578b","text":"<p>Graphite\u548cPrometheus\u4e00\u6837\uff0c\u5bf9\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e\u8fdb\u884c\u5b58\u50a8\u3002</p> <p>Graphite\u4e2d\u7684\u76d1\u63a7\u6307\u6807\u901a\u8fc7\u4e00\u7ec4\u57fa\u4e8e\u201c.\u201d\u7684\u5173\u952e\u5b57\u7ef4\u5ea6\u7ec4\u6210\uff1a</p> <pre><code>stats.api-server.tracks.post.500 -&gt; 93\n</code></pre> <p>\u800cPrometheus\u4e2d\uff0c\u6bcf\u4e00\u4e2a\u76d1\u63a7\u6307\u6807\u62e5\u6709\u5bf9\u4e2a\u57fa\u4e8ekey-value\u5f62\u5f0f\u7684\u6807\u7b7e\u7ec4\u6210\u3002 \u901a\u8fc7\u8fd9\u4e9b\u6807\u7b7e\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u5bb9\u6613\u7684\u5bf9\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5206\u7ec4\uff0c\u4ee5\u53ca\u67e5\u8be2\u3002</p> <pre><code>api_server_http_requests_total{method=\"POST\",handler=\"/tracks\",status=\"500\",instance=\"&lt;sample1&gt;\"} -&gt; 34\napi_server_http_requests_total{method=\"POST\",handler=\"/tracks\",status=\"500\",instance=\"&lt;sample2&gt;\"} -&gt; 28\napi_server_http_requests_total{method=\"POST\",handler=\"/tracks\",status=\"500\",instance=\"&lt;sample3&gt;\"} -&gt; 31\n</code></pre>"},{"location":"sources/comparison_with_other/#_4","title":"\u5b58\u50a8","text":"<p>Graphite\u4f7f\u7528Whisper\u7684\u683c\u5f0f\u5c06\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5b58\u50a8\u5728\u672c\u5730\u78c1\u76d8\u4e2d\uff0c\u8fd9\u662f\u4e00\u79cdRRD\u98ce\u683c\u7684\u6570\u636e\u5e93\uff0c\u671f\u671b\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u80fd\u5b9a\u671f\u5230\u8fbe\u3002\u6bcf\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u5b58\u50a8\u5728\u5355\u72ec\u7684\u6587\u4ef6\u5f53\u4e2d\uff0c\u5e76\u4e14\u65b0\u7684\u6837\u672c\u6570\u636e\u4f1a\u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u8986\u76d6\u65e7\u7684\u6837\u672c\u6570\u636e\u3002</p> <p>Prometheus\u540c\u6837\u5c06\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5206\u522b\u5b58\u50a8\u5728\u72ec\u7acb\u7684\u672c\u5730\u78c1\u76d8\u4e2d\uff0c\u4f46\u662f\u8fd0\u884c\u6837\u672c\u5df2\u4e0d\u540c\u7684\u5468\u671f\u8fdb\u884c\u91c7\u96c6\u3002\u56e0\u4e3a\u65b0\u7684\u6837\u672c\u6570\u636e\u53ea\u662f\u7b80\u5355\u7684\u8ffd\u52a0\u5230\u65f6\u95f4\u5e8f\u5217\u4e0a\uff0c\u56e0\u6b64\u8001\u7684\u6570\u636e\u53ef\u80fd\u4f1a\u4fdd\u7559\u8f83\u957f\u7684\u65f6\u95f4\u3002Prometheus\u4e5f\u9002\u7528\u4e8e\u90a3\u4e9b\u751f\u547d\u5468\u671f\u8f83\u77ed\uff0c\u53d8\u5316\u9891\u7e41\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p>"},{"location":"sources/comparison_with_other/#_5","title":"\u603b\u7ed3","text":"<p>Prometehus\u63d0\u4f9b\u4e86\u66f4\u7075\u6d3b\u7684\u6570\u636e\u6a21\u578b\u4ee5\u53ca\u67e5\u8be2\u8bed\u8a00\uff0c\u540c\u65f6\u66f4\u5bb9\u6613\u8fd0\u884c\u4ee5\u53ca\u96c6\u6210\u5230\u73b0\u6709\u7684\u73af\u5883\u4e2d\u3002\u4f46\u662f\u5982\u679c\u4f60\u60f3\u8981\u4e00\u4e2a\u53ef\u4ee5\u957f\u671f\u4fdd\u5b58\u5386\u53f2\u6570\u636e\u7684\u96c6\u7fa4\u89e3\u51b3\u65b9\u6848\uff0c\u90a3\u4e48Graphite\u53ef\u80fd\u662f\u4e00\u4e2a\u66f4\u597d\u7684\u9009\u62e9\u3002</p>"},{"location":"sources/comparison_with_other/#prometheus-vs-influxdb","title":"Prometheus Vs InfluxDB","text":"<p>InfluxDB\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff0c\u540c\u65f6\u5177\u6709\u652f\u6301\u6269\u5c55\u4ee5\u53ca\u96c6\u7fa4\u7684\u5546\u4e1a\u7248\u672c\u3002Prometheus\u548cInfluxDB\u4e4b\u95f4\u5b58\u5728\u7740\u4e00\u4e9b\u663e\u8457\u7684\u5dee\u5f02\uff0c\u5e76\u4e14\u7531\u5404\u81ea\u9002\u7528\u7684\u4f7f\u7528\u573a\u666f\u3002</p> <p>\u4f46\u662f\u5f53\u5c06Kapacitor\u548cInfluxDB\u4e00\u8d77\u8003\u8651\u65f6\uff0c\u5b83\u4eec\u7684\u7ec4\u5408\u4e0ePrometheus\u4e0eAlertManager\u89e3\u51b3\u4e86\u76f8\u540c\u7684\u95ee\u9898\u3002</p>"},{"location":"sources/comparison_with_other/#_6","title":"\u8303\u56f4","text":""},{"location":"sources/comparison_with_other/#_7","title":"\u6570\u636e\u6a21\u578b/\u5b58\u50a8","text":""},{"location":"sources/comparison_with_other/#_8","title":"\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"sources/comparison_with_other/#_9","title":"\u603b\u7ed3","text":""},{"location":"sources/comparison_with_other/#prometheus-vs-opentsdb","title":"Prometheus Vs OpenTSDB","text":""},{"location":"sources/comparison_with_other/#_10","title":"\u8303\u56f4","text":""},{"location":"sources/comparison_with_other/#_11","title":"\u6570\u636e\u6a21\u578b","text":""},{"location":"sources/comparison_with_other/#_12","title":"\u5b58\u50a8","text":""},{"location":"sources/comparison_with_other/#_13","title":"\u603b\u7ed3","text":""},{"location":"sources/comparison_with_other/#prometheus-vs-nagios","title":"Prometheus Vs Nagios","text":""},{"location":"sources/comparison_with_other/#_14","title":"\u8303\u56f4","text":""},{"location":"sources/comparison_with_other/#_15","title":"\u67b6\u6784","text":""},{"location":"sources/comparison_with_other/#_16","title":"\u603b\u7ed3","text":""},{"location":"sources/comparison_with_other/#prometheus-vs-sensu","title":"Prometheus vs. Sensu","text":""},{"location":"sources/comparison_with_other/#_17","title":"\u8303\u56f4","text":""},{"location":"sources/comparison_with_other/#_18","title":"\u6570\u636e\u6a21\u578b","text":""},{"location":"sources/comparison_with_other/#_19","title":"\u67b6\u6784","text":""},{"location":"sources/comparison_with_other/#_20","title":"\u603b\u7ed3","text":""},{"location":"sources/custom_metrics_with_client_library/","title":"\u81ea\u5b9a\u4e49Exporter\u5b9e\u6218","text":"<p>\u9664\u4e86\u4f7f\u7528Prometheus\u5df2\u7ecf\u63d0\u4f9b\u7684\u5927\u91cfExporter\u4ee5\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7Prometheus\u793e\u533a\u63d0\u4f9b\u7684Client Library\u7528\u6237\u53ef\u4ee5\u5b8c\u5168\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u5b9e\u73b0\u81ea\u5b9a\u4e49Exporter\u3002\u76ee\u524d\u793e\u533a\u5b98\u65b9\u63d0\u4f9b\u652f\u6301\u7684\u5305\u62ec\uff1aGo\u3001Java\u3001Python\u3001Ruby\u3002 \u9664\u6b64\u4e4b\u5916\u8fd8\u5305\u62ec\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684Client library\u5982\uff1aBash\u3001C++\u3001Node.js\u3001PHP\u7b49\u7b49\u3002\u5373\u4f7f\u627e\u4e0d\u5230\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u7684client library\uff0c\u7528\u6237\u53ea\u9700\u8981\u6309\u7167Prometheus\u7684\u683c\u5f0f\u8f93\u51fa\u6307\u6807\u6570\u636e\u5373\u53ef\u3002\u8fd9\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u5e26\u6765\u8bfb\u8005\u4f7f\u7528Prometheus\u7684\u8fd9\u4e9bclient library\u521b\u5efa\u81ea\u5b9a\u4e49Exporter\u3002</p>"},{"location":"sources/custom_metrics_with_java_sdk/","title":"client_java","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u96c6\u6210\uff0cPrometheus\u63d0\u4f9b\u4e86\u591a\u79cdClient Library\u3002\u901a\u8fc7\u8fd9\u4e9bClient Library\u7528\u6237\u53ef\u4ee5\u521b\u5efa\u81ea\u5b9a\u4e49\u7684Exporter\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728\u4e1a\u52a1\u7cfb\u7edf\u4e2d\u96c6\u6210\u5bf9Prometheus\u7684\u652f\u6301\u3002 \u8fd9\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528Prometheus\u5b98\u65b9\u63d0\u4f9b\u7684client_java\u521b\u5efaExporter\u7a0b\u5e8f\u3002</p> <p>\u8fd9\u90e8\u5206\u6211\u4eec\u5c06\u5e26\u9886\u8bfb\u8005\u5b66\u4e60Prometheus\u793e\u533a\u63d0\u4f9b\u7684client_java\uff08Github\u5730\u5740\uff09\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u5e76\u57fa\u4e8e\u5b83\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684Exporter\u7a0b\u5e8f\u3002</p>"},{"location":"sources/custom_metrics_with_java_sdk/#client_java_1","title":"\u521d\u8bc6client_java","text":"<p>\u4f60\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u559c\u597d\u4f7f\u7528Maven\u6216\u8005Gradle\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\uff0c\u5728\u672c\u4e66\u4e2d\u5c06\u4ee5Gradle\u4e3a\u4f8b\u3002</p> <p>\u6dfb\u52a0Prometheus client_java\u4f9d\u8d56\u5305\uff0c\u5728build.gradle\u4e2d\u6dfb\u52a0\u4f9d\u8d56\uff0c\u5982\u4e0b\uff1a</p> <pre><code># \u7701\u7565\u5176\u5b83gradle\u914d\u7f6e\ndependencies {\n    compile \"io.prometheus:simpleclient:0.3.0\"\n    compile \"io.prometheus:simpleclient_hotspot:0.3.0\"\n    compile \"io.prometheus:simpleclient_httpserver:0.3.0\"\n    compile \"io.prometheus:simpleclient_pushgateway:0.3.0\"\n}\n</code></pre> <p>\u5176\u4e2dsimpleclient\u662f\u5bf9Prometheus\u96c6\u6210\u7684\u6838\u5fc3\u4f9d\u8d56\uff0csimpleclient_hotspot\u662f\u5bf9Hotspot JVM\u76f8\u5173\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u7684\u5b9e\u73b0\u3002simpleclient_httpserver\u4e2d\u63d0\u4f9b\u7684\u4e00\u4e2a\u7b80\u5355\u7684\u80fd\u591f\u5904\u7406Prometheus\u76d1\u63a7\u8bf7\u6c42\u7684HTTP\u670d\u52a1\u5668\u5b9e\u73b0\u3002simpleclient_pushgateway\u5219\u63d0\u4f9b\u4e86\u4e0ePushGateway\u7684\u5bf9\u63a5\u652f\u6301\u3002</p> <p>\u4f7f\u7528simpleclient_http\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684HTTPServer\u3002</p> <pre><code>package com.github.prometheus.samples;\n\nimport io.prometheus.client.exporter.HTTPServer;\nimport io.prometheus.client.hotspot.DefaultExports;\n\nimport java.io.IOException;\n\npublic class Server {\n\n    public static void main(String[] args) throws IOException {\n        DefaultExports.initialize();\n        new HTTPServer(1234);\n    }\n\n}\n</code></pre> <p>\u8fd0\u884cmain\u51fd\u6570\uff0c\u5e76\u4e14\u8bbf\u95eehttp://localhost:1234/metrics\uff0c\u53ef\u4ee5\u5728\u7f51\u9875\u4e2d\u770b\u5230\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <pre><code># HELP jvm_info JVM version info\n# TYPE jvm_info gauge\njvm_info{version=\"1.8.0_51-b16\",vendor=\"Oracle Corporation\",runtime=\"Java(TM) SE Runtime Environment\",} 1.0\n# HELP jvm_gc_collection_seconds Time spent in a given JVM garbage collector in seconds.\n# TYPE jvm_gc_collection_seconds summary\njvm_gc_collection_seconds_count{gc=\"PS Scavenge\",} 0.0\njvm_gc_collection_seconds_sum{gc=\"PS Scavenge\",} 0.0\njvm_gc_collection_seconds_count{gc=\"PS MarkSweep\",} 0.0\njvm_gc_collection_seconds_sum{gc=\"PS MarkSweep\",} 0.0\n# HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.\n# TYPE jvm_buffer_pool_used_bytes gauge\njvm_buffer_pool_used_bytes{pool=\"direct\",} 8192.0\njvm_buffer_pool_used_bytes{pool=\"mapped\",} 0.0\n</code></pre> <p>\u606d\u559c\u4f60\uff0c\u5df2\u7ecf\u6210\u529f\u5b8c\u6210\u4e86\u4f60\u7684\u7b2c\u4e00\u4e2aExporter\u7a0b\u5e8f\u3002\u8fd9\u91cc\u8fd4\u56de\u7684\u662f\u5f53\u524d\u5e94\u7528\u4e2dJVM\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5305\u62ecJVM\u4e2dGC\uff0cMemory Pool\uff0cJMX, Classloading\uff0c\u4ee5\u53ca\u7ebf\u7a0b\u6570\u7b49\u76d1\u63a7\u7edf\u8ba1\u4fe1\u606f\u3002</p>"},{"location":"sources/custom_metrics_with_java_sdk/#client_java_2","title":"client_java\u7684\u5b9e\u73b0\u8fc7\u7a0b","text":"<p>\u67e5\u770bDefaultExports.initialize()\u4e2d\u7684\u5b9e\u73b0\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4e8e\u5982\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>public class DefaultExports {\n  private static boolean initialized = false;\n\n  public static synchronized void initialize() {\n    if (!initialized) {\n      new StandardExports().register();\n      new MemoryPoolsExports().register();\n      new BufferPoolsExports().register();\n      new GarbageCollectorExports().register();\n      new ThreadExports().register();\n      new ClassLoadingExports().register();\n      new VersionInfoExports().register();\n      initialized = true;\n    }\n  }\n\n}\n</code></pre> <p>\u8fd9\u91cc\u6240\u6709\u7684Exporters\u90fd\u7ee7\u627f\u81eaCollector\uff0c\u5e76\u4e14\u5b9e\u73b0collect()\u65b9\u6cd5\uff0c\u7528\u4e8e\u8fd4\u56de\u8be5Collector\u4e2d\u83b7\u53d6\u5230\u7684\u6240\u6709\u76d1\u63a7\u6307\u6807\u548c\u6837\u672c\u6570\u636e\u3002\u800cregister()\u65b9\u6cd5\uff0c\u4f1a\u5c06\u8be5Collector\u81ea\u5df1\u6ce8\u518c\u5230CollectorRegistry.defaultRegistry\u4e2d\u3002</p> <p>HTTPServer\u4e2d\u5219\u521b\u5efa\u4e86\u4e00\u4e2aHTTPMetricHandler\u7528\u4e8e\u6765\u5904\u7406Prometheus\u6293\u53d6\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u8bf7\u6c42\uff1a</p> <pre><code> server = HttpServer.create();\n        server.bind(addr, 3);\n        HttpHandler mHandler = new HTTPMetricHandler(registry);\n        server.createContext(\"/\", mHandler);\n        server.createContext(\"/metrics\", mHandler);\n        executorService = Executors.newFixedThreadPool(5, DaemonThreadFactory.defaultThreadFactory(daemon));\n        server.setExecutor(executorService);\n        start(daemon);\n</code></pre> <p>HTTPMetricHandler\u4e3b\u8981\u8d1f\u8d23\u54cd\u5e94Prometheus Server\u5411\u8be5Exporter\u53d1\u8d77\u7684\u8bf7\u6c42\u3002\u901a\u8fc7\u4eceCollectorRegistry.defaultRegistry\u4e2d\u6240\u6709\u7684Collector\u5b9e\u4f8b\u7684collect()\u65b9\u6cd5\u4e2d\u83b7\u53d6\u6837\u672c\u6570\u636e\uff0c\u5e76\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u683c\u5f0f\u5316\uff0c\u4ece\u800c\u5c06\u76d1\u63a7\u6837\u672c\u8fd4\u56de\u7ed9Prometheus Server:</p> <pre><code> public void handle(HttpExchange t) throws IOException {\n            String query = t.getRequestURI().getRawQuery();\n\n            ByteArrayOutputStream response = this.response.get();\n            response.reset();\n            OutputStreamWriter osw = new OutputStreamWriter(response);\n            TextFormat.write004(osw,\n                    registry.filteredMetricFamilySamples(parseQuery(query)));\n            osw.flush();\n            osw.close();\n            response.flush();\n            response.close();\n\n            t.getResponseHeaders().set(\"Content-Type\",\n                    TextFormat.CONTENT_TYPE_004);\n            t.getResponseHeaders().set(\"Content-Length\",\n                    String.valueOf(response.size()));\n            if (shouldUseCompression(t)) {\n                t.getResponseHeaders().set(\"Content-Encoding\", \"gzip\");\n                t.sendResponseHeaders(HttpURLConnection.HTTP_OK, 0);\n                final GZIPOutputStream os = new GZIPOutputStream(t.getResponseBody());\n                response.writeTo(os);\n                os.finish();\n            } else {\n                t.sendResponseHeaders(HttpURLConnection.HTTP_OK, response.size());\n                response.writeTo(t.getResponseBody());\n            }\n            t.close();\n        }\n</code></pre> <p>\u8fd9\u91cc\u4ee5GarbageCollectorExports\u4e3a\u4f8b\uff0ccollect()\u65b9\u6cd5\u4f1a\u4ecejava.lang.management\u4e2d\u83b7\u53d6\u5230GC\u56de\u6536\u76f8\u5173\u7684\u8fd0\u884c\u6570\u636e\uff0c\u5e76\u4e14\u8f6c\u6362\u4e3aSummaryMetricFamily\uff1a</p> <pre><code>package io.prometheus.client.hotspot;\n\nimport io.prometheus.client.Collector;\nimport io.prometheus.client.SummaryMetricFamily;\n\nimport java.lang.management.GarbageCollectorMXBean;\nimport java.lang.management.ManagementFactory;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.List;\n\npublic class GarbageCollectorExports extends Collector {\n  private final List&lt;GarbageCollectorMXBean&gt; garbageCollectors;\n\n  public GarbageCollectorExports() {\n    this(ManagementFactory.getGarbageCollectorMXBeans());\n  }\n\n  GarbageCollectorExports(List&lt;GarbageCollectorMXBean&gt; garbageCollectors) {\n    this.garbageCollectors = garbageCollectors;\n  }\n\n  public List&lt;MetricFamilySamples&gt; collect() {\n    SummaryMetricFamily gcCollection = new SummaryMetricFamily(\n        \"jvm_gc_collection_seconds\",\n        \"Time spent in a given JVM garbage collector in seconds.\",\n        Collections.singletonList(\"gc\"));\n    for (final GarbageCollectorMXBean gc : garbageCollectors) {\n        gcCollection.addMetric(\n            Collections.singletonList(gc.getName()),\n            gc.getCollectionCount(),\n            gc.getCollectionTime() / MILLISECONDS_PER_SECOND);\n    }\n    List&lt;MetricFamilySamples&gt; mfs = new ArrayList&lt;MetricFamilySamples&gt;();\n    mfs.add(gcCollection);\n    return mfs;\n  }\n}\n</code></pre> <p>\u4e0b\u56fe\u63cf\u8ff0\u4e86\u4e00\u4e0b\u901a\u8fc7Prometheus Java Client\u4e2dHTTP Server\u5bf9\u83b7\u53d6\u76d1\u63a7\u6837\u672c\u8bf7\u6c42\u7684\u5904\u7406\u8fc7\u7a0b\u3002</p> <p></p> <p>\u9664\u4e86\u4f7f\u7528Prometheus\u63d0\u4f9b\u7684HttpServer\u4ee5\u5916\uff0cPrometheus\u63d0\u4f9b\u4e86\u9488\u5bf9Servlet\uff0cSpring Boot, Spring Web\u4ee5\u53caDropwizard\u7b49\u7684\u5b9e\u73b0\u3002\u53ef\u4ee5\u8ba9\u7528\u6237\u5feb\u901f\u5b9e\u73b0\u5df2\u6709\u5e94\u7528\u7a0b\u5e8f\u4e0ePrometheus\u7684\u96c6\u6210\u3002</p>"},{"location":"sources/custom_metrics_with_java_sdk/#collector","title":"\u81ea\u5b9a\u4e49Collector","text":"<p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5df2\u7ecf\u4e86\u89e3\u8fc7simpleclient_hotspot\u662f\u5982\u679c\u5b9e\u73b0\u5bf9JVM\u76f8\u5173\u8fd0\u884c\u6307\u6807\u7684\u76d1\u63a7\u7684\u3002\u901a\u8fc7\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684Collector\uff0c\u7528\u6237\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0\u5bf9\u5916\u90e8\u7cfb\u7edf\uff08\u6216\u8005\u670d\u52a1\uff09\u7684\u76d1\u63a7\u6570\u636e\u6536\u96c6\u3002</p> <p></p> <p>\u4ee5\u4e0b\u4ee3\u7801\uff0c\u6f14\u793a\u4e86\u5982\u4f55\u5728Exporter\u4e2d\u521b\u5efa\u81ea\u5b9a\u4e49Collector:</p> <pre><code>class YourCustomCollector extends Collector {\n  List&lt;MetricFamilySamples&gt; collect() {\n    List&lt;MetricFamilySamples&gt; mfs = new ArrayList&lt;MetricFamilySamples&gt;();\n    // With no labels.\n    mfs.add(new GaugeMetricFamily(\"my_gauge\", \"help\", 42));\n    // With labels\n    GaugeMetricFamily labeledGauge = new GaugeMetricFamily(\"my_other_gauge\", \"help\", Arrays.asList(\"labelname\"));\n    labeledGauge.addMetric(Arrays.asList(\"foo\"), 4);\n    labeledGauge.addMetric(Arrays.asList(\"bar\"), 5);\n    mfs.add(labeledGauge);\n    return mfs;\n  }\n}\n</code></pre> <p>\u5b9e\u73b0Collector\u540e\u901a\u8fc7register()\u65b9\u6cd5\uff0c\u5c06\u5176\u6ce8\u518c\u5230CollectorRegistry\u4e2d\uff1a</p> <pre><code>// Registration\nstatic final YourCustomCollector requests = new YourCustomCollector().register()\n</code></pre> <p>\u9664\u4e86GaugeMetricFamily\u4ee5\u5916\uff0cclient_java\u4e2d\u8be5\u63d0\u4f9b\u4e86\u5bf9CounterMetricFamily\u4ee5\u53caSummaryMetricFamily\u7b49\u9488\u5bf9\u5176\u5b83\u76d1\u63a7\u6307\u6807\u7c7b\u578b\u7684\u652f\u6301\u3002</p>"},{"location":"sources/custom_metrics_with_java_sdk/#_1","title":"\u76f4\u63a5\u5728\u4ee3\u7801\u4e2d\u96c6\u6210","text":"<p>\u9664\u4e86\u901a\u8fc7\u5b9e\u73b0Collector\u63a5\u53e3\u4ee5\u5916\uff0cPrometheus\u7684Java Client\u8fd8\u5185\u7f6e\u4e86\u591a\u79cd\u7c7b\u578b\u6784\u9020\u5668\uff0c\u5982Counter\u3001Gauge\u3001Histogram\u3001Summary\u7b49\u3002 \u901a\u8fc7\u8fd9\u4e9b\u6784\u9020\u5668\uff0c\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u5b9e\u73b0\u76d1\u63a7\u6837\u672c\u6536\u96c6\uff0c\u4ece\u800c\u53ef\u4ee5\u76d1\u63a7\u7a0b\u5e8f\u7684\u5185\u90e8\u8fd0\u884c\u60c5\u51b5\u3002</p> <p>Counter\u662f\u5bf9client_java\u4e2d\u5bf9Collector\u7684\u4e00\u4e2a\u9488\u5bf9\u8ba1\u6570\u5668\u7c7b\u578b\u6307\u6807\u7684\u5c01\u88c5\u3002\u5bf9\u4e8eCounter\u800c\u8a00\u53ea\u6709\u4e00\u4e2a.inc()\u65b9\u6cd5\u7528\u4e8e\u8ba1\u6570+1\u3002 \u4f8b\u5982\uff0c\u5f53\u9700\u8981\u7edf\u8ba1\u5bf9\u67d0\u4e9b\u7279\u5b9a\u65b9\u6cd5\u8c03\u7528\u6b21\u6570\u7684\u7edf\u8ba1\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5b9e\u73b0\uff1a</p> <pre><code>import io.prometheus.client.Counter;\nclass YourClass {\n  static final Counter requests = Counter.build()\n     .name(\"requests_total\").help(\"Total requests.\").register();\n\n  void processRequest() {\n    requests.inc();\n    // Your code here.\n  }\n}\n</code></pre> <p>Gauge\u662f\u4e00\u4e2a\u53ef\u589e\u53ef\u51cf\u7684\u4eea\u8868\u76d8\uff0c\u53ef\u4ee5\u901a\u8fc7.inc()\u548c.dec()\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c+1\u6216\u8005-1\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u901a\u8fc7Gauge\u7edf\u8ba1\u51fd\u6570\u4e2d\u67d0\u4e2a\u65b9\u6cd5\u6b63\u5728\u5904\u7406\u4e2d\u7684\u8c03\u7528\u6b21\u6570\uff1a</p> <pre><code>class YourClass {\n  static final Gauge inprogressRequests = Gauge.build()\n     .name(\"inprogress_requests\").help(\"Inprogress requests.\").register();\n\n  void processRequest() {\n    inprogressRequest.inc();\n    // Your code here.\n    inprogressRequest.dec();\n  }\n}\n</code></pre> <p>Histogram\u662f\u4e00\u4e2a\u81ea\u5e26buckets\u533a\u95f4\u7684\u7528\u4e8e\u7edf\u8ba1\u5206\u5e03\u7684\u5bf9\u8c61\uff0c\u4e3b\u8981\u7528\u4e8e\u5728\u6307\u5b9a\u5206\u5e03\u8303\u56f4\u5185(Buckets)\u8bb0\u5f55\u5927\u5c0f\u6216\u8005\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\u3002\u901a\u8fc7\u6784\u9020Histogram\u53ef\u4ee5\u8bb0\u5f55\u67d0\u4e2a\u65b9\u6cd5\u7684\u5904\u7406\u65f6\u95f4\u5728Buckets\u4e0a\u7684\u5206\u5e03\u60c5\u51b5\u3002\u9ed8\u8ba4\u7684Buckets\u8303\u56f4\u4e3a{.005, .01, .025, .05, .075, .1, .25, .5, .75, 1, 2.5, 5, 7.5, 10}\u3002\u5982\u679c\u9700\u8981\u8986\u76d6\u9ed8\u8ba4\u7684buckets\uff0c\u53ef\u4ee5\u4f7f\u7528.buckets(double\u2026 buckets)\u8986\u76d6\u3002\u4ee5\u4e0b\u4ee3\u7801\u4f1a\u81ea\u52a8\u7edf\u8ba1\u8bf7\u6c42\u7684\u54cd\u5e94\u65f6\u95f4\u4ee5\u53ca\u8bf7\u6c42\u7684\u6570\u636e\u91cf\u5728Buckets\u4e0b\u7684\u5206\u5e03\u60c5\u51b5\u3002</p> <pre><code>class YourClass {\n\n static final Histogram receivedBytes = Histogram.build()\n     .name(\"requests_size_bytes\").help(\"Request size in bytes.\").register();\n\n  static final Histogram requestLatency = Histogram.build()\n     .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\").register();\n\n  void processRequest(Request req) {\n    Histogram.Timer requestTimer = requestLatency.startTimer();\n    try {\n      // Your code here.\n    } finally {\n      requestTimer.observeDuration();\n      receivedBytes.observe(req.size())\n    }\n  }\n}\n</code></pre> <p>Summary\u4e0eHistogram\u975e\u5e38\u7c7b\u4f3c\uff0c\u90fd\u53ef\u4ee5\u5b8c\u6210\u5bf9\u4e8b\u4ef6\u53d1\u751f\u6b21\u6570\u6216\u8005\u5927\u5c0f\u5206\u5e03\u60c5\u51b5\u7684\u7edf\u8ba1\u3002\u533a\u522b\u5728\u4e8eSummary\u76f4\u63a5\u5728\u5ba2\u6237\u7aef\u5b8c\u6210\u4e86\u5206\u4f4d\u6570\u7684\u7edf\u8ba1\u548c\u8ba1\u7b97,\u901a\u8fc7quantile()\u65b9\u6cd5\u53ef\u4ee5\u6307\u5b9a\u9700\u8981\u8ba1\u7b97\u7684\u5206\u4f4d\u6570\u3002\u4ee5\u4e0b\u4ee3\u7801\u4f1a\u81ea\u52a8\u8ba1\u7b97\u5f53\u524d\u8bf7\u6c42\u5ef6\u8fdf\u548c\u8bf7\u6c42\u91cf\u5927\u5c0f\u7684\u4e2d\u4f4d\u6570\u4ee5\u53ca9\u5206\u4f4d\u6570\u3002</p> <pre><code>class YourClass {\n  static final Summary receivedBytes = Summary.build()\n     .quantile(0.5, 0.05)\n     .quantile(0.9, 0.01)\n     .name(\"requests_size_bytes\").help(\"Request size in bytes.\").register();\n  static final Summary requestLatency = Summary.build()\n     .quantile(0.5, 0.05)\n     .quantile(0.9, 0.01)\n     .name(\"requests_latency_seconds\").help(\"Request latency in seconds.\").register();\n\n  void processRequest(Request req) {\n    Summary.Timer requestTimer = requestLatency.startTimer();\n    try {\n      // Your code here.\n    } finally {\n      receivedBytes.observe(req.size());\n      requestTimer.observeDuration();\n    }\n  }\n}\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u7b80\u5355\u4e86\u89e3\u4e86\u901a\u8fc7\u5b9e\u73b0Collector\u6216\u8005\u4f7f\u7528Counter\u3001Guage\u8fd9\u6837\u7684\u6784\u9020\u5668\u5747\u53ef\u5b9e\u73b0\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\uff0c\u5e76\u4e14\u5c06\u76f8\u5e94\u7684\u6307\u6807\u6837\u672c\u8fd4\u56de\u7ed9Prometheus\u3002 \u63a5\u4e0b\u6765\uff0c\u5c06\u4ee5\u4e00\u4e2a\u5177\u4f53\u7684\u4f8b\u5b50\u8be6\u7ec6\u8bb2\u89e3\u5982\u4f55\u5728\u5e94\u7528\u4e2d\u5b9e\u73b0\u5bf9Prometheus\u7684\u96c6\u6210\u3002</p>"},{"location":"sources/expose-cluster-level-metrics-with-kube-state-metrics/","title":"\u91c7\u96c6\u96c6\u7fa4\u72b6\u6001","text":""},{"location":"sources/prometheus-promql-operators/","title":"PromQL\u64cd\u4f5c\u7b26","text":"<p>PromQL\u9664\u4e86\u80fd\u591f\u5bf9\u6570\u636e\u8fdb\u884c\u57fa\u672c\u7684\u67e5\u8be2\u7edf\u8ba1\u4ee5\u5916\uff0c\u8fd8\u652f\u6301\u65f6\u95f4\u5e8f\u5217\u4e4b\u95f4\u8fdb\u884c\u903b\u8f91\u548c\u6570\u5b66\u8fd0\u7b97\u3002\u8fd9\u4e00\u5c0f\u8282\u4e2d\u5c06\u91cd\u70b9\u4ecb\u7ecd\u5982\u4f55\u5229\u7528PromQL\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u5404\u79cd\u903b\u8f91\u548c\u6570\u5b66\u8fd0\u7b97\u7684\u3002</p>"},{"location":"sources/prometheus-promql-operators/#_1","title":"\u6570\u5b66\u8fd0\u7b97\u7b26","text":"<p>\u7b97\u672f\u8fd0\u7b97\u652f\u6301\u7528\u4e8e\uff1a\u6807\u91cf\u548c\u6807\u91cf\u3001\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u3001\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u4e4b\u95f4\u7684\u8fd0\u7b97\u3002</p> <p>\u5728PromQL\u4e2d\u652f\u6301\u4f7f\u7528\u5e38\u7528\u7684\u7b97\u672f\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>+</code> (\u52a0\u6cd5)</li> <li><code>-</code> (\u51cf\u6cd5)</li> <li><code>*</code> (\u4e58\u6cd5)</li> <li><code>/</code> (\u9664\u6cd5)</li> <li><code>%</code> (\u6c42\u4f59)</li> <li><code>^</code> (\u5e42\u8fd0\u7b97)</li> </ul>"},{"location":"sources/prometheus-promql-operators/#_2","title":"\u6807\u91cf\u4e0e\u6807\u91cf","text":"<p>\u6807\u91cf\u548c\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\uff0c\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u6807\u91cf\u3002</p> <pre><code>2 * 2 # \u4ea7\u751f\u6807\u91cf4\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_3","title":"\u6807\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf","text":"<p>\u6807\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\uff0c\u6570\u5b66\u8fd0\u7b97\u7b26\u5c06\u88ab\u4f5c\u7528\u4e8e\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u6bcf\u4e00\u4e2a\u6837\u672c\u503c\u3002\u5e76\u4e14\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u77ac\u65f6\u5411\u91cf\u3002</p> <pre><code>http_requests_total{}\n</code></pre> <pre><code>http_requests_total{code=\"200\",handler=\"alerts\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"} =&gt; 1@1518145642.308\nhttp_requests_total{code=\"200\",handler=\"federate\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"} =&gt; 1@1518145642.308\n</code></pre> <p>\u4f8b\u5982\uff0c\u5982\u679c\u8868\u8fbe\u5f0fhttp_requests_total{}\u67e5\u8be2\u51fa\u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\u7684\u77ac\u65f6\u6837\u672c\u6570\u636e\uff0c\u90a3<code>*5</code>\u64cd\u4f5c\u4f1a\u5c06\u6bcf\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u4e2d\u7684\u77ac\u65f6\u6837\u672c\u6570\u636e<code>*5</code>\uff0c \u5e76\u4e14\u4ea7\u751f\u4e00\u7ec4\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <pre><code>http_requests_total{} * 5\n</code></pre> <p>\u8fd4\u56de\u7ed3\u679c\uff1a</p> <pre><code>http_requests_total{code=\"200\",handler=\"alerts\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"} =&gt; 5@1518145642.308\nhttp_requests_total{code=\"200\",handler=\"federate\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"} =&gt; 5@1518145642.308\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_4","title":"\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf","text":"<p>\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\uff0c\u6570\u5b66\u8fd0\u7b97\u5c06\u5c06\u4f1a\u4f5c\u7528\u4e8e\u5de6\u8fb9\u6570\u636e\u4e2d\u7684\u6bcf\u4e00\u4e2a\u6837\u672c\u6570\u636e\uff0c\u4e0e\u8be5\u6837\u672c\u5728\u53f3\u8fb9\u6570\u636e\u4e2d\u5339\u914d\u5230\u7684\u6837\u672c\u6570\u636e\u4e4b\u95f4\u3002</p> <p>\u4f8b\u5982,</p> <pre><code>node_disk_bytes_written + node_disk_bytes_written\n</code></pre> <p>\u8868\u8fbe\u5f0fnode_disk_bytes_written\u8fd4\u56de\u5f53\u524d\u4e3b\u673a\u4e2d\u5404\u4e2a\u78c1\u76d8\u7684\u5199\u5165\u6570\u636e\u603b\u91cf\u7684\u77ac\u65f6\u5411\u91cf\u3002</p> <pre><code>node_disk_bytes_written{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1634967552@1518146427.807\nnode_disk_bytes_written{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;0@1518146427.807\n</code></pre> <p>\u8868\u8fbe\u5f0fnode_disk_bytes_read{}\u4f1a\u8fd4\u56de\uff0c\u5f53\u524d\u4e3b\u673a\u4e2d\u5404\u4e2a\u78c1\u76d8\u7684\u8bfb\u53d6\u6570\u636e\u603b\u91cf\u7684\u77ac\u65f6\u5411\u91cf\u3002</p> <pre><code>node_disk_bytes_read{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;864551424@1518146427.807\nnode_disk_bytes_read{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1744384@1518146427.807\n</code></pre> <p>\u5339\u914d\u89c4\u5219\u4f1a\u6bd4\u8f83\u4e24\u4e2a\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u6240\u6709\u6807\u7b7e\u3002\u6807\u7b7e\u7684\u952e\u503c\u5bf9\u5b8c\u5168\u76f8\u7b49\u5219\u8868\u793a\u5339\u914d\u6210\u529f\uff0c\u5e76\u5c06\u8fd0\u7b97\u7b26\u4f5c\u7528\u57df\u4e24\u4e2a\u5339\u914d\u7684\u6837\u672c\u6570\u636e\u4e2d\u3002\u8fd4\u56de\u4e00\u7ec4\u65b0\u7684\u77ac\u65f6\u5411\u91cf\uff0c\u540c\u65f6\u7ed3\u679c\u4e2d\u4f1a\u4e22\u5f03\u6307\u6807\u540d\u79f0\u3002\u5bf9\u4e8e\u6ca1\u6709\u5339\u914d\u7684\u6837\u672c\u6570\u636e\uff0c\u5219\u4e0d\u4f1a\u51fa\u73b0\u5728\u8fd0\u7b97\u7ed3\u679c\u4e2d\u3002</p> <pre><code>{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1634967552@1518146427.807 + 864551424@1518146427.807\n{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;0@1518146427.807 + 1744384@1518146427.807\n</code></pre> <p>\u5373\u7ed3\u679c\u4e3a</p> <pre><code>{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;2499568128@1518146427.807\n{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1744384@1518146427.807\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_5","title":"\u6bd4\u8f83\u8fd0\u7b97\u7b26","text":"<p>\u6bd4\u8f83\u8fd0\u7b97\u7b26\u8fd0\u7b97\u652f\u6301\uff1a\u6807\u91cf\u548c\u6807\u91cf\u3001\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u3001\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u7684\u8fd0\u7b97\u3002</p> <p>\u76ee\u524d\uff0cPrometheus\u652f\u6301\u4ee5\u4e0b\uff0c\u6bd4\u8f83\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>==</code> (\u76f8\u7b49)</li> <li><code>!=</code> (\u4e0d\u76f8\u7b49)</li> <li><code>&gt;</code> (\u5927\u4e8e)</li> <li><code>&lt;</code> (\u5c0f\u4e8e)</li> <li><code>&gt;=</code> (\u5927\u4e8e\u7b49\u4e8e)</li> <li><code>&lt;=</code> (\u5c0f\u4e8e\u7b49\u4e8e)</li> </ul>"},{"location":"sources/prometheus-promql-operators/#_6","title":"\u77ac\u65f6\u5411\u91cf\u4e0e\u6807\u91cf","text":"<p>\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6bd4\u8f83\u8fd0\u7b97\u65f6\uff0cPromQL\u7684\u9ed8\u8ba4\u884c\u4e3a\u4f1a\u4f9d\u6b21\u5c06\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u6240\u6709\u6837\u672c\u4e0e\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6bd4\u8f83\u8fd0\u7b97\u3002\u5982\u679c\u6bd4\u8f83\u7ed3\u679c\u4e3atrue\u5219\u4fdd\u7559\u6837\u672c\uff0c\u5982\u679c\u6bd4\u8f83\u7ed3\u679c\u4e3afalse\u5219\u4e22\u5f03\u8be5\u6837\u672c\uff0c\u4ece\u800c\u4ea7\u751f\u4e00\u6761\u65b0\u7684\u77ac\u65f6\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u627e\u5230\u5f53\u524d\u7cfb\u7edf\u8bf7\u6c42\u91cf\u5927\u4e8e100\u6b21\u7684\u5904\u7406\u6a21\u5757\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>http_requests_total &gt; 100\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fc7\u6ee4\u76d1\u63a7\u6307\u6807http_requests_total\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\uff0c\u8fd4\u56de\u77ac\u65f6\u6837\u672c\u503c\u6ee1\u8db3\u6761\u4ef6\u6bd4\u8f83\u6761\u4ef6(&gt; 1000)\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u3002</p> <pre><code>http_requests_total{code=\"200\",handler=\"prometheus\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  36733\nhttp_requests_total{code=\"200\",handler=\"prometheus\",instance=\"localhost:9100\",job=\"node_exporter\",method=\"get\"}  37131\nhttp_requests_total{code=\"200\",handler=\"query\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  126\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#bool","title":"\u4f7f\u7528bool\u6539\u53d8\u6bd4\u8f83\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6bd4\u8f83\u8fd0\u7b97\u7b26\u7684\u9ed8\u8ba4\u884c\u4e3a\u662f\u5bf9\u65f6\u5e8f\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u3002\u800c\u5728\u5176\u5b83\u7684\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u80fd\u9700\u8981\u7684\u662f\u771f\u6b63\u7684\u5e03\u5c14\u7ed3\u679c\u3002\u4f8b\u5982\uff0c\u53ea\u9700\u8981\u77e5\u9053\u5f53\u524d\u6a21\u5757\u7684HTTP\u8bf7\u6c42\u91cf\u662f\u5426&gt;=1000\uff0c\u5982\u679c\u5927\u4e8e\u7b49\u4e8e1000\u5219\u8fd4\u56de1\uff08true\uff09\u5426\u5219\u8fd4\u56de0\uff08false\uff09\u3002\u8fd9\u65f6\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528bool\u6539\u53d8\u6bd4\u8f83\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>http_requests_total &gt; bool 100\n</code></pre> <p>\u4f7f\u7528bool\u4fee\u6539\u6bd4\u8f83\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a\u4e4b\u540e\uff0c\u6bd4\u8f83\u8fd0\u7b97\u4e0d\u4f1a\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u800c\u662f\u76f4\u63a5\u4f9d\u6b21\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u5404\u4e2a\u6837\u672c\u6570\u636e\u4e0e\u6807\u91cf\u7684\u6bd4\u8f83\u7ed3\u679c0\u6216\u80051\u3002\u4ece\u800c\u5f62\u6210\u4e00\u6761\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <pre><code>http_requests_total{code=\"200\",handler=\"query\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  1\nhttp_requests_total{code=\"200\",handler=\"query_range\",instance=\"localhost:9090\",job=\"prometheus\",method=\"get\"}  0\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_7","title":"\u6807\u91cf\u548c\u6807\u91cf","text":"<p>\u6807\u91cf\u548c\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6bd4\u8f83\u8fd0\u7b97\uff0c\u6839\u636e\u6bd4\u8f83\u7684\u7ed3\u679c\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u6807\u91cf0\uff08false\uff09\u6216\u80051\uff08true\uff09\u7528\u4e8e\u8fd4\u56de\u6bd4\u8f83\u7684\u7ed3\u679c\u3002\u9700\u8981\u6ce8\u610f\u7684\u65f6\uff0c\u6807\u91cf\u548c\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6bd4\u8f83\u65f6\uff0c\u5fc5\u987b\u4f7f\u7528bool\u8fdb\u884c\u4fee\u9970\uff0c\u4f8b\u5982\uff1a</p> <pre><code>2 == bool 2 # \u7ed3\u679c\u4e3a1\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_8","title":"\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf","text":"<p>\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\uff0c\u8fdb\u884c\u6bd4\u8f83\u8fd0\u7b97\u65f6\uff0c\u6839\u636e\u9ed8\u8ba4\u7684\u5339\u914d\u89c4\u5219\uff0c\u4f9d\u6b21\u6bd4\u8f83\u5339\u914d\u5230\u7684\u6837\u672c\u6570\u636e\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u5339\u914d\u5230\u7684\u6570\u636e\u6bd4\u8f83\u7ed3\u679c\u4e3atrue\u5219\u4fdd\u7559\uff0c\u53cd\u4e4b\u5219\u4e22\u5f03\u3002\u4ece\u800c\u5f62\u6210\u4e00\u6761\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002 \u540c\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7bool\u4fee\u9970\u7b26\u6765\u6539\u53d8\u6bd4\u8f83\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a\u3002</p> <p>\u4f8b\u5982\uff0c\u4f7f\u7528\u8868\u8fbe\u5f0f\u83b7\u53d6\u5f53\u524d\u6b63\u5e38\u7684\u4efb\u52a1\u72b6\u6001\uff1a</p> <pre><code>up == 1\n</code></pre> <p>\u6216\u8005\u6211\u4eec\u53ea\u60f3\u77e5\u9053\u5f53\u524d\u4efb\u52a1\u7684\u72b6\u6001\u662f\u5426\u4e3a\u6b63\u5e38\uff1a</p> <pre><code>up == bool 1\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_9","title":"\u903b\u8f91/\u96c6\u5408\u8fd0\u7b97\u7b26","text":"<p>\u903b\u8f91\u8fd0\u7b97\u7b26\u53ea\u652f\u6301\u5728\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u4f7f\u7528\u3002</p> <p>\u76ee\u524d\uff0cPrometheus\u652f\u6301\u4ee5\u4e0b\uff0c\u6bd4\u8f83\u903b\u8f91\u8fd0\u7b97\u7b26\u6709\uff1a</p> <ul> <li><code>and</code> (\u5e76\u4e14)</li> <li><code>or</code> (\u6216\u8005)</li> <li><code>unless</code> (\u6392\u9664)</li> </ul> <p>vector1 and vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u7531vector1\u7684\u5143\u7d20\u7ec4\u6210\u7684\u65b0\u7684\u5411\u91cf\u3002\u8be5\u5411\u91cf\u5305\u542bvector1\u4e2d\u5b8c\u5168\u5339\u914dvector2\u4e2d\u7684\u5143\u7d20\u7ec4\u6210\u3002</p> <p>vector1 or vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u8be5\u5411\u91cf\u5305\u542bvector1\u4e2d\u6240\u6709\u7684\b\u6837\u672c\u6570\u636e\uff0c\u4ee5\u53cavector2\u4e2d\u6ca1\u6709\u4e0evector1\u5339\u914d\u5230\u7684\u6837\u672c\u6570\u636e\u3002</p> <p>vector1 unless vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u65b0\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u7531vector1\u4e2d\u6ca1\u6709\u4e0evector2\u5339\u914d\u7684\u5143\u7d20\u7ec4\u6210\u3002</p>"},{"location":"sources/prometheus-promql-operators/#_10","title":"\u5411\u91cf\u5339\u914d\u6a21\u5f0f","text":"<p>\u5411\u91cf\u4e0e\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u8fd0\u7b97\u64cd\u4f5c\u65f6\u4f1a\u57fa\u4e8e\u9ed8\u8ba4\u7684\u5339\u914d\u89c4\u5219\uff1a\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\b\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u8fd0\u7b97\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u4ecb\u7ecd\u5728PromQL\u4e2d\u6709\u4e24\u79cd\u5178\u578b\u7684\u5339\u914d\u6a21\u5f0f\uff1a\u4e00\u5bf9\u4e00\uff08one-to-one\uff09,\u591a\u5bf9\u4e00\uff08many-to-one\uff09\u6216\u4e00\u5bf9\u591a\uff08one-to-many\uff09\u3002</p>"},{"location":"sources/prometheus-promql-operators/#_11","title":"\u4e00\u5bf9\u4e00\u5339\u914d","text":"<p>\u4e00\u5bf9\u4e00\b\u5339\u914d\u6a21\u5f0f\u4f1a\u4ece\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u83b7\u53d6\u7684\u77ac\u65f6\u5411\u91cf\u4f9d\u6b21\u6bd4\u8f83\u5e76\u627e\u5230\u552f\u4e00\u5339\u914d(\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4)\u7684\u6837\u672c\u503c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>vector1 &lt;operator&gt; vector2\n</code></pre> <p>\u5728\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528on(label list)\u6216\u8005ignoring(label list\uff09\u6765\u4fee\u6539\u4fbf\u7b7e\u7684\u5339\u914d\u884c\u4e3a\u3002\u4f7f\u7528ignoreing\u53ef\u4ee5\u5728\u5339\u914d\u65f6\u5ffd\u7565\u67d0\u4e9b\u4fbf\u7b7e\u3002\u800con\u5219\u7528\u4e8e\u5c06\u5339\u914d\u884c\u4e3a\u9650\u5b9a\u5728\u67d0\u4e9b\u4fbf\u7b7e\u4e4b\u5185\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u4f8b\u5982\u5f53\u5b58\u5728\u6837\u672c\uff1a</p> <pre><code>method_code:http_errors:rate5m{method=\"get\", code=\"500\"}  24\nmethod_code:http_errors:rate5m{method=\"get\", code=\"404\"}  30\nmethod_code:http_errors:rate5m{method=\"put\", code=\"501\"}  3\nmethod_code:http_errors:rate5m{method=\"post\", code=\"500\"} 6\nmethod_code:http_errors:rate5m{method=\"post\", code=\"404\"} 21\n\nmethod:http_requests:rate5m{method=\"get\"}  600\nmethod:http_requests:rate5m{method=\"del\"}  34\nmethod:http_requests:rate5m{method=\"post\"} 120\n</code></pre> <p>\u4f7f\u7528PromQL\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m{code=\"500\"} / ignoring(code) method:http_requests:rate5m\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fd4\u56de\u5728\u8fc7\u53bb5\u5206\u949f\u5185\uff0cHTTP\u8bf7\u6c42\u72b6\u6001\u7801\u4e3a500\u7684\u5728\u6240\u6709\u8bf7\u6c42\u4e2d\u7684\u6bd4\u4f8b\u3002\u5982\u679c\u6ca1\u6709\u4f7f\u7528ignoring(code)\uff0c\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u77ac\u65f6\u5411\u91cf\u4e2d\u5c06\u627e\u4e0d\u5230\u4efb\u4f55\u4e00\u4e2a\u6807\u7b7e\u5b8c\u5168\u76f8\u540c\u7684\u5339\u914d\u9879\u3002</p> <p>\u56e0\u6b64\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\"}  0.04            //  24 / 600\n{method=\"post\"} 0.05            //   6 / 120\n</code></pre> <p>\u540c\u65f6\u7531\u4e8emethod\u4e3aput\u548cdel\u7684\b\u6837\u672c\b\u627e\u4e0d\u5230\u5339\u914d\u9879\uff0c\u56e0\u6b64\u4e0d\u4f1a\u51fa\u73b0\u5728\u7ed3\u679c\u5f53\u4e2d\u3002</p>"},{"location":"sources/prometheus-promql-operators/#_12","title":"\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a","text":"<p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u5339\u914d\u6a21\u5f0f\u6307\u7684\u662f\u201c\u4e00\u201d\u4fa7\u7684\u6bcf\u4e00\u4e2a\u5411\u91cf\u5143\u7d20\u53ef\u4ee5\u4e0e\"\u591a\"\u4fa7\u7684\u591a\u4e2a\u5143\u7d20\u5339\u914d\u7684\u60c5\u51b5\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5fc5\u987b\u4f7f\u7528group\u4fee\u9970\u7b26\uff1agroup_left\u6216\u8005group_right\u6765\u786e\u5b9a\u54ea\u4e00\u4e2a\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6570\uff08\u5145\u5f53\u201c\u591a\u201d\u7684\u89d2\u8272\uff09\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u6a21\u5f0f\u4e00\u5b9a\u662f\u51fa\u73b0\u5728\u64cd\u4f5c\u7b26\u4e24\u4fa7\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u5411\u91cf\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u56e0\u6b64\u9700\u8981\u4f7f\u7528ignoring\u548con\u4fee\u9970\u7b26\u6765\u6392\u9664\u6216\u8005\u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u5217\u8868\u3002</p> <p>\u4f8b\u5982,\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4e2d\uff0c\u5de6\u5411\u91cf<code>method_code:http_errors:rate5m</code>\u5305\u542b\u4e24\u4e2a\u6807\u7b7emethod\u548ccode\u3002\u800c\u53f3\u5411\u91cf<code>method:http_requests:rate5m</code>\u4e2d\u53ea\u5305\u542b\u4e00\u4e2a\u6807\u7b7emethod\uff0c\u56e0\u6b64\u5339\u914d\u65f6\u9700\u8981\u4f7f\u7528ignoring\u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u4e3acode\u3002 \u5728\u9650\u5b9a\u5339\u914d\u6807\u7b7e\u540e\uff0c\u53f3\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u53ef\u80fd\u5339\u914d\u5230\u591a\u4e2a\u5de6\u5411\u91cf\u4e2d\u7684\u5143\u7d20 \u56e0\u6b64\u8be5\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u6a21\u5f0f\u4e3a\u591a\u5bf9\u4e00\uff0c\u9700\u8981\u4f7f\u7528group\u4fee\u9970\u7b26group_left\u6307\u5b9a\u5de6\u5411\u91cf\u5177\u6709\u66f4\u597d\u7684\u57fa\u6570\u3002</p> <p>\u6700\u7ec8\u7684\u8fd0\u7b97\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\", code=\"500\"}  0.04            //  24 / 600\n{method=\"get\", code=\"404\"}  0.05            //  30 / 600\n{method=\"post\", code=\"500\"} 0.05            //   6 / 120\n{method=\"post\", code=\"404\"} 0.175           //  21 / 120\n</code></pre> <p>\u63d0\u9192\uff1agroup\u4fee\u9970\u7b26\u53ea\u80fd\u5728\u6bd4\u8f83\u548c\u6570\u5b66\u8fd0\u7b97\u7b26\u4e2d\u4f7f\u7528\u3002\u5728\u903b\u8f91\u8fd0\u7b97and,unless\u548cor\u624d\u6ce8\u610f\u64cd\u4f5c\u4e2d\u9ed8\u8ba4\u4e0e\u53f3\u5411\u91cf\u4e2d\u7684\u6240\u6709\u5143\u7d20\u8fdb\u884c\u5339\u914d\u3002</p>"},{"location":"sources/prometheus-promql-operators/#_13","title":"\u805a\u5408\u64cd\u4f5c","text":"<p>Prometheus\u8fd8\u63d0\u4f9b\u4e86\u4e0b\u5217\u5185\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u7b26\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u4f5c\u7528\u57df\u77ac\u65f6\u5411\u91cf\u3002\u53ef\u4ee5\u5c06\u77ac\u65f6\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u5f62\u6210\u4e00\u4e2a\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <ul> <li><code>sum</code> (\u6c42\u548c)</li> <li><code>min</code> (\u6700\u5c0f\u503c)</li> <li><code>max</code> (\u6700\u5927\u503c)</li> <li><code>avg</code> (\u5e73\u5747\u503c)</li> <li><code>stddev</code> (\u6807\u51c6\u5dee)</li> <li><code>stdvar</code> (\u6807\u51c6\u5dee\u5f02)</li> <li><code>count</code> (\u8ba1\u6570)</li> <li><code>count_values</code> (\u5bf9value\u8fdb\u884c\u8ba1\u6570)</li> <li><code>bottomk</code> (\u540en\u6761\u65f6\u5e8f)</li> <li><code>topk</code> (\u524dn\u6761\u65f6\u5e8f)</li> <li><code>quantile</code> (\u5206\u5e03\u7edf\u8ba1)</li> </ul> <p>\u4f7f\u7528\u805a\u5408\u64cd\u4f5c\u7684\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]\n</code></pre> <p>\u5176\u4e2d\u53ea\u6709<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>\u652f\u6301\u53c2\u6570(parameter)\u3002</p> <p>without\u7528\u4e8e\u4ece\u8ba1\u7b97\u7ed3\u679c\u4e2d\u79fb\u9664\u5217\u4e3e\u7684\u6807\u7b7e\uff0c\u800c\u4fdd\u7559\u5176\u5b83\u6807\u7b7e\u3002by\u5219\u6b63\u597d\u76f8\u53cd\uff0c\u7ed3\u679c\u5411\u91cf\u4e2d\u53ea\u4fdd\u7559\u5217\u51fa\u7684\u6807\u7b7e\uff0c\u5176\u4f59\u6807\u7b7e\u5219\u79fb\u9664\u3002\u901a\u8fc7without\u548cby\u53ef\u4ee5\u6309\u7167\u6837\u672c\u7684\u95ee\u9898\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sum(http_requests_total) without (instance)\n</code></pre> <p>\u7b49\u4ef7\u4e8e</p> <pre><code>sum(http_requests_total) by (code,handler,job,method)\n</code></pre> <p>\u5982\u679c\u53ea\u9700\u8981\u8ba1\u7b97\u6574\u4e2a\u5e94\u7528\u7684HTTP\u8bf7\u6c42\u603b\u91cf\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(http_requests_total)\n</code></pre> <p>count_values\u7528\u4e8e\u65f6\u95f4\u5e8f\u5217\u4e2d\u6bcf\u4e00\u4e2a\u6837\u672c\u503c\u51fa\u73b0\u7684\u6b21\u6570\u3002count_values\u4f1a\u4e3a\u6bcf\u4e00\u4e2a\u552f\u4e00\u7684\u6837\u672c\u503c\u8f93\u51fa\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u5e76\u4e14\u6bcf\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7e\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>count_values(\"count\", http_requests_total)\n</code></pre> <p>topk\u548cbottomk\u5219\u7528\u4e8e\u5bf9\u6837\u672c\u503c\u8fdb\u884c\u6392\u5e8f\uff0c\u8fd4\u56de\u5f53\u524d\u6837\u672c\u503c\u524dn\u4f4d\uff0c\u6216\u8005\u540en\u4f4d\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u83b7\u53d6HTTP\u8bf7\u6c42\u6570\u524d5\u4f4d\u7684\u65f6\u5e8f\u6837\u672c\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>topk(5, http_requests_total)\n</code></pre> <p>quantile\u7528\u4e8e\u8ba1\u7b97\u5f53\u524d\u6837\u672c\u6570\u636e\u503c\u7684\u5206\u5e03\u60c5\u51b5quantile(\u03c6, express)\u5176\u4e2d0 \u2264 \u03c6 \u2264 1\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u03c6\u4e3a0.5\u65f6\uff0c\u5373\u8868\u793a\u627e\u5230\u5f53\u524d\u6837\u672c\u6570\u636e\u4e2d\u7684\u4e2d\u4f4d\u6570\uff1a</p> <pre><code>quantile(0.5, http_requests_total)\n</code></pre>"},{"location":"sources/prometheus-promql-operators/#_14","title":"\u64cd\u4f5c\u7b26\u4f18\u5148\u7ea7","text":"<p>\u6700\u540e\u5bf9\u4e8e\u590d\u6742\u7c7b\u578b\u7684\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u8fd0\u7b97\u64cd\u4f5c\u7684\u4f18\u5148\u7ea7\u3002</p> <p>\u4f8b\u5982\uff0c\u67e5\u8be2\u4e3b\u673a\u7684CPU\u4f7f\u7528\u7387\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>100 * (1 - avg (irate(node_cpu{mode='idle'}[5m])) by(job) )\n</code></pre> <p>\u5176\u4e2dirate\u662fPromQL\u4e2d\u7684\u5185\u7f6e\u51fd\u6570\uff0c\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u4e2d\u65f6\u95f4\u5e8f\u5217\u6bcf\u79d2\u7684\u5373\u65f6\u589e\u957f\u7387\u3002\u5173\u4e8e\u5185\u7f6e\u51fd\u6570\u7684\u90e8\u5206\uff0c\u4f1a\u5728\u4e0b\u4e00\u8282\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u5728PromQL\u64cd\u4f5c\u7b26\u4e2d\u4f18\u5148\u7ea7\u7531\u9ad8\u5230\u4f4e\u4f9d\u6b21\u4e3a\uff1a</p> <ol> <li><code>^</code></li> <li><code>*, /, %</code></li> <li><code>+, -</code></li> <li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li> <li><code>and, unless</code></li> <li><code>or</code></li> </ol>"},{"location":"sources/prometheus-quick-start-node-exporter/","title":"\u4f7f\u7528NodeExporter\u76d1\u63a7\u4e3b\u673a","text":"<p>\u5728\u4e0a\u4e00\u5c0f\u8282\u4e2d\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u90e8\u7f72Prometheus Server\uff0c\u5e76\u4e14\u91c7\u96c6\u4e86Prometheus\u81ea\u8eab\u7684\u4e00\u4e9b\u8fd0\u884c\u6307\u6807\u6570\u636e\u3002\u901a\u8fc7Prometheus\u5185\u7f6e\u7684UI\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u67e5\u8be2\uff0c\u8fc7\u6ee4\u4ee5\u53ca\u805a\u5408\uff0c\u540c\u65f6Prometheus\u5185\u7f6e\u7684UI\u8fd8\u652f\u6301\u7b80\u5355\u7684\u56fe\u5f62\u5316\u663e\u793a\u9700\u6c42\u3002</p> <p>\u5728Prometheus Server\u4e2d\u5c06\u7528\u4e8e\u83b7\u53d6\u76d1\u63a7\u6837\u672c\u6570\u636e\u7684\u670d\u52a1\u79f0\u4e3a\u4e00\u4e2atarget\u5b9e\u4f8b(\u4f8b\u5982Prometheus\u81ea\u8eab)\u3002\u5bf9\u4e8e\u67d0\u4e9b\u5e94\u7528\u548c\u670d\u52a1\u800c\u8a00\u5b83\u4eec\u53ef\u80fd\u5185\u7f6e\u4e86\u5bf9Prometheus\u7684\u652f\u6301\uff0c\u800c\u5bf9\u4e8e\u6ca1\u6709\u5185\u7f6ePrometheus\u652f\u6301\u7684\u76d1\u63a7\u9700\u6c42\uff0c\u9700\u8981\u8fd0\u884c\u5355\u72ec\u7684\u91c7\u96c6\u7a0b\u5e8f\uff0c\u8fd9\u4e9b\u7a0b\u5e8f\u88ab\u79f0\u4e3aExporter\uff0c\u901a\u8fc7\u8fd9\u4e9bExporter\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u4f7fPrometheus\u53ef\u4ee5\u4ece\u8fd9\u4e9bExporter\u95f4\u63a5\u7684\u83b7\u53d6\u5230\u76f8\u5e94\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u4e3a\u4e86\u80fd\u591f\u91c7\u96c6\u5230\u4e3b\u673a\u7684\u76d1\u63a7\u6307\u6807\uff08CPU\uff0c\u5185\u5b58\uff0c\u78c1\u76d8\uff09\uff0c\u6211\u4eec\u9700\u8981\u5728\u4e3b\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2aNode Exporter\u7a0b\u5e8f\uff0c\u5b9e\u73b0\u5bf9\u4e3b\u673a\u76d1\u63a7\u7684\u652f\u6301\u3002</p>"},{"location":"sources/prometheus-quick-start-node-exporter/#node-exporter","title":"\u5b89\u88c5Node Exporter","text":""},{"location":"sources/prometheus-quick-start-node-exporter/#_1","title":"\u521b\u5efa\u7528\u6237","text":"<pre><code>sudo useradd --no-create-home node_exporter\n</code></pre>"},{"location":"sources/prometheus-quick-start-node-exporter/#_2","title":"\u83b7\u53d6\u5e76\u5b89\u88c5\u8f6f\u4ef6\u5305","text":"<pre><code>cd ~\ncurl -LO https://github.com/prometheus/node_exporter/releases/download/v0.15.1/node_exporter-0.15.1.linux-amd64.tar.gz\n\ntar xvf node_exporter-0.15.1.linux-amd64.tar.gz\n\nsudo cp node_exporter-0.15.1.linux-amd64/node_exporter /usr/local/bin\nsudo chown node_exporter:node_exporter /usr/local/bin/node_exporter\nrm -rf node_exporter-0.15.1.linux-amd64.tar.gz node_exporter-0.15.1.linux-amd64\n</code></pre>"},{"location":"sources/prometheus-quick-start-node-exporter/#node-exporterservice-unit","title":"\u521b\u5efaNode Exporter\u7684Service Unit\u6587\u4ef6","text":"<pre><code>sudo vim /etc/systemd/system/node_exporter.service\n</code></pre> <pre><code>[Unit]\nDescription=Node Exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=node_exporter\nGroup=node_exporter\nType=simple\nExecStart=/usr/local/bin/node_exporter\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"sources/prometheus-quick-start-node-exporter/#node-exporter_1","title":"\u542f\u52a8Node Exporter","text":"<pre><code>service node_exporter start\n</code></pre> <p>NodeExporter\u542f\u52a8\u540e\uff0c\u8bbf\u95eehttp://192.168.33.10:9100/metrics\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524dNodeExporter\u6240\u5728\u4e3b\u673a\u7684\u5f53\u524d\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p></p>"},{"location":"sources/prometheus-quick-start-node-exporter/#_3","title":"\u914d\u7f6e\u4e3b\u673a\u76d1\u63a7\u91c7\u96c6\u4efb\u52a1","text":""},{"location":"sources/prometheus-quick-start-node-exporter/#prometheus","title":"\u914d\u7f6ePrometheus\u91c7\u96c6\u4e3b\u673a\u4fe1\u606f","text":"<p>\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6/etc/prometheus/prometheus.yml\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>    - job_name: 'node_exporter'\n        scrape_interval: 5s\n        static_configs:\n        - targets: ['localhost:9100']\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684Job\u540d\u5b57\u4e3anode_exporter\u3002\u5e76\u4e14\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b9e\u4f8b\u4e3alocalhost:9100\u3002</p> <p>\u5b8c\u6574\u7684Prometheus\u914d\u7f6e\u6587\u4ef6/etc/prometheus/prometheus.yml\u5982\u4e0b\uff1a</p> <pre><code>global:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9090']\n  - job_name: 'node_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9100']\n</code></pre> <p>\u91cd\u65b0\u542f\u52a8Prometheus Server</p> <pre><code>sudo service prometheus restart\n</code></pre>"},{"location":"sources/prometheus-quick-start-node-exporter/#_4","title":"\u9a8c\u8bc1\u7ed3\u679c","text":"<p>\u8bbf\u95eehttp://192.168.33.10:9090/targets\u67e5\u770b\u6240\u6709\u7684\u91c7\u96c6\u76ee\u6807\u5b9e\u4f8b\uff0c\u8fd9\u65f6\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u65b0\u7684\u91c7\u96c6\u4efb\u52a1\uff1anode_exporter\u4ee5\u53ca\u76f8\u5e94\u7684\u5b9e\u4f8b\u3002</p> <p></p> <p>\u8fd9\u65f6\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7PromQL\u8bed\u8a00\u5728\uff0cPrometheus UI\u4e0a\u76f4\u63a5\u67e5\u8be2\u4e3b\u673a\u76f8\u5173\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\u3002</p> <p>\u4f8b\u5982:</p> <p>\u6309CPU\u6a21\u5f0f\u67e5\u8be2\u4e3b\u673a\u7684CPU\u4f7f\u7528\u7387\uff1a</p> <pre><code>avg without (cpu)(irate(node_cpu{mode!=\"idle\"}[5m]))\n</code></pre> <p></p> <p>\u67e5\u8be2\u4e3b\u673aCPU\u603b\u4f53\u4f7f\u7528\u7387\uff1a</p> <pre><code>sum(avg without (cpu)(irate(node_cpu{mode!='idle'}[5m]))) by (instance)\n</code></pre> <p></p> <p>\u6309\u4e3b\u673a\u67e5\u8be2\u4e3b\u673a\u5185\u5b58\u4f7f\u7528\u91cf\uff1a</p> <pre><code>sum(node_memory_MemTotal - node_memory_MemFree - node_memory_Buffers - node_memory_Cached) by (instance)\n</code></pre> <p></p> <p>\u6309\u4e3b\u673a\u67e5\u8be2\u5404\u4e2a\u78c1\u76d8\u7684IO\u72b6\u6001\uff1a</p> <pre><code>sum(irate(node_disk_io_time_ms{device!~'^(md\\\\\\\\d+$|dm-)'}[5m]) / 1000) by (instance, device)\n</code></pre> <p></p>"},{"location":"sources/prometheus-storage-v2/","title":"\u65b0\u7684\u5b58\u50a8\u5c42","text":""},{"location":"sources/prometheus-time-series-selectors/","title":"Prometheus time series selectors","text":""},{"location":"sources/prometheus-time-series-selectors/#_1","title":"\u65f6\u95f4\u5e8f\u5217\u9009\u62e9\u5668","text":""},{"location":"sources/prometheus-time-series-selectors/#_2","title":"\u77ac\u65f6\u5411\u91cf\u9009\u62e9\u5668","text":""},{"location":"sources/prometheus-time-series-selectors/#_3","title":"\u533a\u95f4\u5411\u91cf\u9009\u62e9\u5668","text":""},{"location":"sources/prometheus-time-series-selectors/#_4","title":"\u4f4d\u79fb\u9009\u62e9\u5668","text":""},{"location":"sources/the-advantage-of-prometheus/","title":"Prometheus\u7684\u4f18\u52bf","text":""},{"location":"sources/use-prometheus-monitor-nginx/","title":"\u4f7f\u7528Prometheus\u76d1\u63a7Nginx\u72b6\u6001","text":""},{"location":"sources/use-prometheus-monitor-nginx/#nginx-stats","title":"\u4eceNginx Stats\u83b7\u53d6\u76d1\u63a7\u6837\u672c","text":""},{"location":"sources/use-prometheus-monitor-nginx/#_1","title":"\u4ece\u65e5\u5fd7\u6587\u4ef6\u4e2d\u83b7\u53d6\u76d1\u63a7\u6837\u672c","text":""},{"location":"sources/use-prometheus-monitor-nginx/#prometheus","title":"\u4e0ePrometheus\u96c6\u6210","text":""},{"location":"sources/use-prometheus-monitor-rabbitmq/","title":"\u4f7f\u7528Prometheus\u76d1\u63a7RabbitMQ","text":""}]}